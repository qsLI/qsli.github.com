<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>Java的反射慢吗？ | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java的反射慢吗？</h1><a id="logo" href="/.">KL's blog</a><p class="description">世事洞明皆学问，人情练达即文章</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java的反射慢吗？</h1><div class="post-meta">Aug 7, 2022<script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2022/08/07/reflection/" href="/2022/08/07/reflection/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#反射很慢？"><span class="toc-number">1.</span> <span class="toc-text">反射很慢？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简单使用"><span class="toc-number">1.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单测试下时间"><span class="toc-number">1.2.</span> <span class="toc-text">简单测试下时间</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#两种实现方式"><span class="toc-number">2.</span> <span class="toc-text">两种实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Native实现"><span class="toc-number">2.1.</span> <span class="toc-text">Native实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynamic-bytecode-generation"><span class="toc-number">2.2.</span> <span class="toc-text">dynamic bytecode generation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DelegatingClassLoader"><span class="toc-number">2.2.1.</span> <span class="toc-text">DelegatingClassLoader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#反射使用过多可能造成的问题"><span class="toc-number">3.</span> <span class="toc-text">反射使用过多可能造成的问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><h1 id="反射很慢？"><a href="#反射很慢？" class="headerlink" title="反射很慢？"></a>反射很慢？</h1><p>有些人说反射很慢，但是也没有人真正地测试过。spring的代码里有好多使用反射的地方，所以性能应该也没有那么差。</p>
<p>本文就来挖一挖反射的实现原理以及可能导致的问题。</p>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><p>简单地用反射的方式获取一个field的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(JUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ReflectTest</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 为了查看调用栈</span></span><br><span class="line">      <span class="keyword">new</span> RuntimeException().printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCount</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.count = count;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="meta">@SneakyThrows</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReflection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clazz = Class.forName(<span class="string">"com.air.lang.reflect.ReflectTest"</span>);</span><br><span class="line">    Method getCountMethod = clazz.getDeclaredMethod(<span class="string">"getCount"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> Object instance = clazz.newInstance();</span><br><span class="line">    <span class="keyword">final</span> Object o = getCountMethod.invoke(instance);</span><br><span class="line">    System.out.println(<span class="string">"o = "</span> + o);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行起来（-XX:+TraceClassLoading ），输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Loaded sun.reflect.NativeMethodAccessorImpl from /Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">[Loaded sun.reflect.DelegatingMethodAccessorImpl from /Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/jre/lib/rt.jar]</span><br><span class="line">java.lang.RuntimeException</span><br><span class="line">	at com.air.lang.reflect.ReflectTest.getCount(ReflectTest.java:21)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at com.air.lang.reflect.ReflectTest.testReflection(ReflectTest.java:82)</span><br><span class="line">	// 下面是junit用反射调用这个方法的栈</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at org.junit.internal.runners.TestMethod.invoke(TestMethod.java:68)</span><br><span class="line">o = 10</span><br></pre></td></tr></table></figure>
<p>从调用栈可以看到，Method的invoke的调用路径：</p>
<p>DelegatingMethodAccessorImpl -&gt; NativeMethodAccessorImpl</p>
<p>翻下invoke的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.lang.reflect.Method#invoke</span></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object... args)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IllegalAccessException, IllegalArgumentException,</span></span><br><span class="line"><span class="function">InvocationTargetException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!override) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;</span><br><span class="line">      Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">      checkAccess(caller, clazz, obj, modifiers);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  MethodAccessor ma = methodAccessor;             <span class="comment">// read volatile</span></span><br><span class="line">  <span class="keyword">if</span> (ma == <span class="keyword">null</span>) &#123;</span><br><span class="line">    ma = acquireMethodAccessor();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ma.invoke(obj, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用是委托给了MethodAccessor，这是java中的一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sun.reflect.MethodAccessor</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** This interface provides the declaration for</span></span><br><span class="line"><span class="comment">    java.lang.reflect.Method.invoke(). Each Method object is</span></span><br><span class="line"><span class="comment">    configured with a (possibly dynamically-generated) class which</span></span><br><span class="line"><span class="comment">    implements this interface.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodAccessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Matches specification in &#123;<span class="doctag">@link</span> java.lang.reflect.Method&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException, InvocationTargetException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2022/08/07/reflection/image-20220710014957451.png">
<p>实现类有三个，DelegatingMethodAccessorImpl是代理模式，主要是为了切换底层的实现。因此主要的实现就两种，一个是MethodAccessorImpl，一个是NativeMethodAccessorImpl。</p>
<blockquote>
<p>Delegates its invocation to another MethodAccessorImpl and can change its delegate at run time.</p>
</blockquote>
<h2 id="简单测试下时间"><a href="#简单测试下时间" class="headerlink" title="简单测试下时间"></a>简单测试下时间</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReflection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; clazz = Class.forName(<span class="string">"com.air.lang.reflect.ReflectTest"</span>);</span><br><span class="line">  Method getCountMethod = clazz.getDeclaredMethod(<span class="string">"getCount"</span>, <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">final</span> Object instance = clazz.newInstance();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 注意，这里是nano time</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">    <span class="keyword">final</span> Object o = getCountMethod.invoke(instance);</span><br><span class="line">    System.out.println(i + <span class="number">1</span> + <span class="string">": cost "</span> + (System.nanoTime() - start));</span><br><span class="line">  &#125;</span><br><span class="line">  System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1: cost 19792</span><br><span class="line">2: cost 3625</span><br><span class="line">3: cost 2583</span><br><span class="line">4: cost 2333</span><br><span class="line">5: cost 3250</span><br><span class="line">6: cost 4166</span><br><span class="line">7: cost 2459</span><br><span class="line">8: cost 27041</span><br><span class="line">9: cost 7875</span><br><span class="line">10: cost 7500</span><br><span class="line">11: cost 8167</span><br><span class="line">12: cost 7500</span><br><span class="line">13: cost 7250</span><br><span class="line">14: cost 7459</span><br><span class="line">15: cost 7750</span><br><span class="line">16: cost 1085417</span><br><span class="line">17: cost 7208</span><br><span class="line">18: cost 2500</span><br><span class="line">19: cost 1917</span><br><span class="line">20: cost 2292</span><br></pre></td></tr></table></figure>
<p>注意看，第1次调用和第16次调用，时间都比较长。inflation的默认阈值是15，超过15之后就会转为动态字节码生成的方式，中间要生成字节码，所以耗时较高，之后耗时就降下来了。</p>
<h1 id="两种实现方式"><a href="#两种实现方式" class="headerlink" title="两种实现方式"></a>两种实现方式</h1><blockquote>
<p>Before Java 1.4 <code>Method.invoke</code> worked through a JNI call to VM runtime. </p>
<p>Since Java 1.4 <code>Method.invoke</code> uses dynamic bytecode generation if a method is called more than 15 times (configurable via <code>sun.reflect.inflationThreshold</code> system property).</p>
</blockquote>
<p>Java 1.4之前都是使用Native的方式调用，1.4之后，会根据调用的阈值做优化，超过一定的阈值<code>-Dsun.reflect.inflationThreshold</code>,会转换成dynamic bytecode generation的方式。dynamic bytecode generation的性能会更好。</p>
<h2 id="Native实现"><a href="#Native实现" class="headerlink" title="Native实现"></a>Native实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sun.reflect.NativeMethodAccessorImpl#invoke</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException, InvocationTargetException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// We can't inflate methods belonging to vm-anonymous classes because</span></span><br><span class="line">  <span class="comment">// that kind of class can't be referred to by name, hence can't be</span></span><br><span class="line">  <span class="comment">// found from the generated bytecode.</span></span><br><span class="line">  <span class="keyword">if</span> (++numInvocations &gt; ReflectionFactory.inflationThreshold()</span><br><span class="line">      &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123;</span><br><span class="line">    MethodAccessorImpl acc = (MethodAccessorImpl)</span><br><span class="line">      <span class="comment">// 超过阈值之后，会切换成动态字节码的方式</span></span><br><span class="line">      <span class="comment">// 注意，这里没有加锁</span></span><br><span class="line">      <span class="keyword">new</span> MethodAccessorGenerator().</span><br><span class="line">      generateMethod(method.getDeclaringClass(),</span><br><span class="line">                     method.getName(),</span><br><span class="line">                     method.getParameterTypes(),</span><br><span class="line">                     method.getReturnType(),</span><br><span class="line">                     method.getExceptionTypes(),</span><br><span class="line">                     method.getModifiers());</span><br><span class="line">    <span class="comment">// parent就是刚才说的代理DelegatingMethodAccessorImpl</span></span><br><span class="line">    <span class="comment">// 生成结束之后，这里切换成新的调用方式</span></span><br><span class="line">    parent.setDelegate(acc);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里是native方法</span></span><br><span class="line">  <span class="keyword">return</span> invoke0(method, obj, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setParent</span><span class="params">(DelegatingMethodAccessorImpl parent)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.parent = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title">invoke0</span><span class="params">(Method m, Object obj, Object[] args)</span></span>;</span><br></pre></td></tr></table></figure>
<p>去jdk的代码里看看这个nativev方法的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NativeAccessors.c</span></span><br><span class="line">JNIEXPORT jobject JNICALL Java_jdk_internal_reflect_NativeMethodAccessorImpl_invoke0</span><br><span class="line">(JNIEnv *env, jclass unused, jobject m, jobject obj, jobjectArray args)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> JVM_InvokeMethod(env, m, obj, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jvm.cpp</span></span><br><span class="line">JVM_ENTRY(jobject, JVM_InvokeMethod(JNIEnv *env, jobject method, jobject obj, jobjectArray args0))</span><br><span class="line">  Handle method_handle;</span><br><span class="line">  <span class="keyword">if</span> (thread-&gt;stack_overflow_state()-&gt;stack_available((address) &amp;method_handle) &gt;= JVMInvokeMethodSlack) &#123;</span><br><span class="line">    method_handle = Handle(THREAD, JNIHandles::resolve(method));</span><br><span class="line">    <span class="function">Handle <span class="title">receiver</span><span class="params">(THREAD, JNIHandles::resolve(obj))</span></span>;</span><br><span class="line">    <span class="function">objArrayHandle <span class="title">args</span><span class="params">(THREAD, objArrayOop(JNIHandles::resolve(args0)))</span></span>;</span><br><span class="line">    oop result = Reflection::invoke_method(method_handle(), receiver, args, CHECK_NULL);</span><br><span class="line">    jobject res = JNIHandles::make_local(THREAD, result);</span><br><span class="line">    <span class="keyword">if</span> (JvmtiExport::should_post_vm_object_alloc()) &#123;</span><br><span class="line">      oop ret_type = java_lang_reflect_Method::return_type(method_handle());</span><br><span class="line">      assert(ret_type != <span class="literal">NULL</span>, <span class="string">"sanity check: ret_type oop must not be NULL!"</span>);</span><br><span class="line">      <span class="keyword">if</span> (java_lang_Class::is_primitive(ret_type)) &#123;</span><br><span class="line">        <span class="comment">// Only for primitive type vm allocates memory for java object.</span></span><br><span class="line">        <span class="comment">// See box() method.</span></span><br><span class="line">        JvmtiExport::post_vm_object_alloc(thread, result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    THROW_0(vmSymbols::java_lang_StackOverflowError());</span><br><span class="line">  &#125;</span><br><span class="line">JVM_END</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// reflection.cpp</span></span><br><span class="line">  <span class="comment">// This would be nicer if, say, java.lang.reflect.Method was a subclass</span></span><br><span class="line"><span class="comment">// of java.lang.reflect.Constructor</span></span><br><span class="line"></span><br><span class="line"><span class="function">oop <span class="title">Reflection::invoke_method</span><span class="params">(oop method_mirror, Handle receiver, objArrayHandle args, TRAPS)</span> </span>&#123;</span><br><span class="line">  oop mirror             = java_lang_reflect_Method::clazz(method_mirror);</span><br><span class="line">  <span class="keyword">int</span> slot               = java_lang_reflect_Method::slot(method_mirror);</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">override</span>          = java_lang_reflect_Method::<span class="keyword">override</span>(method_mirror) != <span class="number">0</span>;</span><br><span class="line">  <span class="function">objArrayHandle <span class="title">ptypes</span><span class="params">(THREAD, objArrayOop(java_lang_reflect_Method::parameter_types(method_mirror)))</span></span>;</span><br><span class="line"></span><br><span class="line">  oop return_type_mirror = java_lang_reflect_Method::return_type(method_mirror);</span><br><span class="line">  BasicType rtype;</span><br><span class="line">  <span class="keyword">if</span> (java_lang_Class::is_primitive(return_type_mirror)) &#123;</span><br><span class="line">    rtype = basic_type_mirror_to_basic_type(return_type_mirror);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rtype = T_OBJECT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  InstanceKlass* klass = InstanceKlass::cast(java_lang_Class::as_Klass(mirror));</span><br><span class="line">  Method* m = klass-&gt;method_with_idnum(slot);</span><br><span class="line">  <span class="keyword">if</span> (m == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    THROW_MSG_0(vmSymbols::java_lang_InternalError(), <span class="string">"invoke"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">methodHandle <span class="title">method</span><span class="params">(THREAD, m)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> invoke(klass, method, receiver, <span class="keyword">override</span>, ptypes, rtype, args, <span class="literal">true</span>, THREAD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>invoke方法就比较复杂了，这里就不跟进了，可以看到native的实现就是使用JNI调用，然后利用jvm内部的数据结构完成方法的调用。</p>
<h2 id="dynamic-bytecode-generation"><a href="#dynamic-bytecode-generation" class="headerlink" title="dynamic bytecode generation"></a>dynamic bytecode generation</h2><blockquote>
<p>The approach with dynamic bytecode generation is much faster since it</p>
</blockquote>
<ul>
<li>does not suffer from <strong>JNI overhead</strong>;</li>
<li>does not need to parse method signature each time, because each method invoked via Reflection has its own <strong>unique MethodAccessor</strong>;</li>
<li>can be further optimized, e.g. these MethodAccessors can benefit from all regular <strong>JIT optimizations</strong> like inlining, constant propagation, autoboxing elimination etc.</li>
<li>Note, that this optimization is implemented mostly in Java code without JVM assistance. The only thing HotSpot VM does to make this optimization possible - is skipping bytecode verification for such generated MethodAccessors. Otherwise the verifier would not allow, for example, to call private methods.</li>
</ul>
<p>稍微改造下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReflection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; clazz = Class.forName(<span class="string">"com.air.lang.reflect.ReflectTest"</span>);</span><br><span class="line">  Method getCountMethod = clazz.getDeclaredMethod(<span class="string">"getCount"</span>, <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">final</span> Object instance = clazz.newInstance();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> Object o = getCountMethod.invoke(instance);</span><br><span class="line">    System.out.println(<span class="string">"o = "</span> + o);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 阻塞退出，等待输入</span></span><br><span class="line">  System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序跑起来之后，反复调用了20次，超过了默认的阈值，会自动生成字节码。</p>
<p>第一次输出的调用栈：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException</span><br><span class="line">	at com.air.lang.reflect.ReflectTest.getCount(ReflectTest.java:21)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at com.air.lang.reflect.ReflectTest.testReflection(ReflectTest.java:83)</span><br></pre></td></tr></table></figure>
<p>最后一次输出的调用栈：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException</span><br><span class="line">	at com.air.lang.reflect.ReflectTest.getCount(ReflectTest.java:21)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor1.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at com.air.lang.reflect.ReflectTest.testReflection(ReflectTest.java:83)</span><br></pre></td></tr></table></figure>
<p>调用栈发生了变化，<strong>从NativeMethodAccessorImpl变为了GeneratedMethodAccessor1</strong></p>
<p>我们用arthas找下生成的字节码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[arthas@45767]$ sc -d *GeneratedMethodAccessor1</span><br><span class="line"> class-info        sun.reflect.GeneratedMethodAccessor1</span><br><span class="line"> code-source</span><br><span class="line"> name              sun.reflect.GeneratedMethodAccessor1</span><br><span class="line"> isInterface       <span class="literal">false</span></span><br><span class="line"> isAnnotation      <span class="literal">false</span></span><br><span class="line"> isEnum            <span class="literal">false</span></span><br><span class="line"> isAnonymousClass  <span class="literal">false</span></span><br><span class="line"> isArray           <span class="literal">false</span></span><br><span class="line"> isLocalClass      <span class="literal">false</span></span><br><span class="line"> isMemberClass     <span class="literal">false</span></span><br><span class="line"> isPrimitive       <span class="literal">false</span></span><br><span class="line"> isSynthetic       <span class="literal">false</span></span><br><span class="line"> simple-name       GeneratedMethodAccessor1</span><br><span class="line"> modifier          public</span><br><span class="line"> annotation</span><br><span class="line"> interfaces</span><br><span class="line"> super-class       +-sun.reflect.MethodAccessorImpl</span><br><span class="line">                     +-sun.reflect.MagicAccessorImpl</span><br><span class="line">                       +-java.lang.Object</span><br><span class="line"> class-loader      +-sun.reflect.DelegatingClassLoader@57fa26b7</span><br><span class="line">                     +-sun.misc.Launcher<span class="variable">$AppClassLoader</span>@18b4aac2</span><br><span class="line">                       +-sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@6d3a7064</span><br><span class="line"> classLoaderHash   57fa26b7</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 29 ms.</span><br></pre></td></tr></table></figure>
<p>反编译下看看生成的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[arthas@<span class="number">45767</span>]$ jad sun.reflect.GeneratedMethodAccessor1</span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-sun.reflect.DelegatingClassLoader@<span class="number">57f</span>a26b7</span><br><span class="line">  +-sun.misc.Launcher$AppClassLoader@<span class="number">18</span>b4aac2</span><br><span class="line">    +-sun.misc.Launcher$ExtClassLoader@<span class="number">6</span>d3a7064</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Decompiled with CFR.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Could not load the following classes:</span></span><br><span class="line"><span class="comment"> *  com.air.lang.reflect.ReflectTest</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> sun.reflect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.air.lang.reflect.ReflectTest;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.MethodAccessorImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedMethodAccessor1</span></span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> <span class="title">MethodAccessorImpl</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Loose catch block</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Object[] objectArray)</span> <span class="keyword">throws</span> InvocationTargetException </span>&#123;</span><br><span class="line">        ReflectTest reflectTest;</span><br><span class="line">        block5: &#123;</span><br><span class="line">            <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// 这里直接强转了，把Object类型转成了目标类型ReflectTest</span></span><br><span class="line">            reflectTest = (ReflectTest)object;</span><br><span class="line">            <span class="keyword">if</span> (objectArray == <span class="keyword">null</span> || objectArray.length == <span class="number">0</span>) <span class="keyword">break</span> block5;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	<span class="comment">// 调用对应的方法</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Integer(reflectTest.getCount());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvocationTargetException(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassCastException | NullPointerException runtimeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="keyword">super</span>.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:<span class="number">1</span>) cost in <span class="number">537</span> ms.</span><br></pre></td></tr></table></figure>
<p>可以看到，动态生成的字节码，跟直接方法调用差别并不是很大。值得注意的是，这个类的classloader是<code>sun.reflect.DelegatingClassLoader</code>.</p>
<h3 id="DelegatingClassLoader"><a href="#DelegatingClassLoader" class="headerlink" title="DelegatingClassLoader"></a>DelegatingClassLoader</h3><p>DelegatingClassLoader有何特殊之处？看代码也没有特殊的实现，应该只是为了做classloader隔离。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sun.reflect.DelegatingClassLoader</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> this class's name and presence are known to the virtual</span></span><br><span class="line"><span class="comment">// machine as of the fix for 4474172.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelegatingClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    DelegatingClassLoader(ClassLoader parent) &#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>之所以搞一个新的类加载器，是为了<strong>性能考虑</strong>，在某些情况下可以<strong>卸载这些生成的类</strong>，因为类的卸载是只有在类加载器可以被回收的情况下才会被回收的，如果用了原来的类加载器，那可能导致这些新创建的类一直无法被卸载，从其设计来看本身就不希望他们一直存在内存里的，在需要的时候有就行了，在内存紧俏的时候可以释放掉内存</p>
<p>——你假笨 <a href="https://mp.weixin.qq.com/s/5H6UHcP6kvR2X5hTj_SBjA" rel="external nofollow noopener noreferrer" target="_blank">假笨说-从一起GC血案谈到反射原理</a></p>
</blockquote>
<blockquote>
<ul>
<li><p>first, it avoids any possible security risk of having these bytecodes in the same loader.</p>
</li>
<li><p>Second, it allows the generated bytecodes to be unloaded earlier </p>
<p>than would otherwise be possible, decreasing run-time footprint.</p>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jdk.internal.reflect.ClassDefiner</span></span><br><span class="line"><span class="comment">/** Utility class which assists in calling defineClass() by</span></span><br><span class="line"><span class="comment">    creating a new class loader which delegates to the one needed in</span></span><br><span class="line"><span class="comment">    order for proper resolution of the given bytecodes to occur. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassDefiner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> JavaLangAccess JLA = SharedSecrets.getJavaLangAccess();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &lt;P&gt; We define generated code into a new class loader which</span></span><br><span class="line"><span class="comment">      delegates to the defining loader of the target class. It is</span></span><br><span class="line"><span class="comment">      necessary for the VM to be able to resolve references to the</span></span><br><span class="line"><span class="comment">      target class from the generated bytecodes, which could not occur</span></span><br><span class="line"><span class="comment">      if the generated code was loaded into the bootstrap class</span></span><br><span class="line"><span class="comment">      loader. &lt;/P&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;P&gt; There are two primary reasons for creating a new loader</span></span><br><span class="line"><span class="comment">      instead of defining these bytecodes directly into the defining</span></span><br><span class="line"><span class="comment">      loader of the target class: first, it avoids any possible</span></span><br><span class="line"><span class="comment">      security risk of having these bytecodes in the same loader.</span></span><br><span class="line"><span class="comment">      Second, it allows the generated bytecodes to be unloaded earlier</span></span><br><span class="line"><span class="comment">      than would otherwise be possible, decreasing run-time</span></span><br><span class="line"><span class="comment">      footprint. &lt;/P&gt;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> Class&lt;?&gt; defineClass(String name, <span class="keyword">byte</span>[] bytes, <span class="keyword">int</span> off, <span class="keyword">int</span> len,</span><br><span class="line">                                <span class="keyword">final</span> ClassLoader parentClassLoader)</span><br><span class="line">    &#123;</span><br><span class="line">        ClassLoader newLoader = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;ClassLoader&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> DelegatingClassLoader(parentClassLoader);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">return</span> JLA.defineClass(newLoader, name, bytes, <span class="keyword">null</span>, <span class="string">"__ClassDefiner__"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="反射使用过多可能造成的问题"><a href="#反射使用过多可能造成的问题" class="headerlink" title="反射使用过多可能造成的问题"></a>反射使用过多可能造成的问题</h1><p>前面说到达到阈值，切换为动态字节码生成时<strong>没有加锁</strong>。而每次生成动态字节码，都会生成自己的类加载器。如果并发很高，会导致classloader和class过多，占用相应的内存。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://rednaxelafx.iteye.com/blog/548536" rel="external nofollow noopener noreferrer" target="_blank">关于反射调用方法的一个log - Script Ahead, Code Behind - ITeye博客</a></li>
<li><a href="https://stackoverflow.com/questions/28793118/what-is-a-de-reflection-optimization-in-hotspot-jit-and-how-does-it-implemented" rel="external nofollow noopener noreferrer" target="_blank">java - What is a de-reflection optimization in HotSpot JIT and how does it implemented? - Stack Overflow</a></li>
<li><a href="https://www.zhihu.com/question/19826278/answer/44331421" rel="external nofollow noopener noreferrer" target="_blank">Java 反射到底慢在哪里？ - 知乎</a></li>
<li><a href="http://www.fanyilun.me/2015/10/29/Java%E5%8F%8D%E5%B0%84%E5%8E%9F%E7%90%86/" rel="external nofollow noopener noreferrer" target="_blank">Java反射原理简析 | Yilun Fan’s Blog</a></li>
<li><a href="https://time.geekbang.org/column/article/12192" rel="external nofollow noopener noreferrer" target="_blank">07 | JVM是如何实现反射的？</a></li>
<li><a href="https://mp.weixin.qq.com/s/5H6UHcP6kvR2X5hTj_SBjA" rel="external nofollow noopener noreferrer" target="_blank">假笨说-从一起GC血案谈到反射原理</a></li>
<li><a href="https://www.jianshu.com/p/20b7ab284c0a" rel="external nofollow noopener noreferrer" target="_blank">反射代理类加载器的潜在内存使用问题 - 简书</a></li>
</ul>
</div><footer class="post-footer"><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者: </strong>代故</li><li class="post-copyright-link"><strong>本文链接: </strong>    <a href="/2022/08/07/reflection/" target="_blank">http://qsli.github.io/2022/08/07/reflection/index.html</a></li>  <li class="post-copyright-license"><strong>版权声明: </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 3.0 CN</a></li></ul></div></footer><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2022/08/07/reflection/" data-id="cl6j81zuy00g5ow7116vk1brc" class="article-share-link">分享到</a><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? 整杯冰阔乐!<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://qsli.github.io/about/praise.jpg" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="tags"><a href="/tags/jvm/">jvm</a></div><div class="post-nav"><a href="/2022/08/07/tomcat-stringcache/" class="pre">tomcat-stringcache</a><a href="/2022/07/08/open-tracing/" class="next">open-tracing</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2022/08/07/reflection/';
var disqus_title = 'Java的反射慢吗？';
var disqus_url = 'http://qsli.github.io/2022/08/07/reflection/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/druid/">druid</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/feign/">feign</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mediawiki/">mediawiki</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservice/">microservice</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/cglib/" style="font-size: 15px;">cglib</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/pitfall-mysql-connector-java-8-x/" style="font-size: 15px;">pitfall mysql-connector-java 8.x</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/spring-cloud/" style="font-size: 15px;">spring-cloud</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/git-commit-id/" style="font-size: 15px;">git-commit-id</a> <a href="/tags/go学习资料/" style="font-size: 15px;">go学习资料</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/grafana/" style="font-size: 15px;">grafana</a> <a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/tranfer-encoding/" style="font-size: 15px;">tranfer-encoding</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/java-connector/" style="font-size: 15px;">java-connector</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/jinfo/" style="font-size: 15px;">jinfo</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/自增主键/" style="font-size: 15px;">自增主键</a> <a href="/tags/plantuml/" style="font-size: 15px;">plantuml</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/logback/" style="font-size: 15px;">logback</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/sqlserver-killer/" style="font-size: 15px;">sqlserver-killer</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/sudo-log/" style="font-size: 15px;">sudo-log</a> <a href="/tags/swap/" style="font-size: 15px;">swap</a> <a href="/tags/busy-thread/" style="font-size: 15px;">busy-thread</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/feign/" style="font-size: 15px;">feign</a> <a href="/tags/generic/" style="font-size: 15px;">generic</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/executor/" style="font-size: 15px;">executor</a> <a href="/tags/format/" style="font-size: 15px;">format</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/HttpURLConnection/" style="font-size: 15px;">HttpURLConnection</a> <a href="/tags/executeBatch/" style="font-size: 15px;">executeBatch</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/tracing/" style="font-size: 15px;">tracing</a> <a href="/tags/reference/" style="font-size: 15px;">reference</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/sudo/" style="font-size: 15px;">sudo</a> <a href="/tags/top/" style="font-size: 15px;">top</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/google-perf/" style="font-size: 15px;">google-perf</a> <a href="/tags/jdwp/" style="font-size: 15px;">jdwp</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/spring-bean/" style="font-size: 15px;">spring-bean</a> <a href="/tags/tomcat-startup/" style="font-size: 15px;">tomcat-startup</a> <a href="/tags/cache-prep-stmts/" style="font-size: 15px;">cache-prep-stmts</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/transaction/" style="font-size: 15px;">transaction</a> <a href="/tags/spring-validator/" style="font-size: 15px;">spring-validator</a> <a href="/tags/spring-aop/" style="font-size: 15px;">spring-aop</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/08/07/tomcat-stringcache/">tomcat-stringcache</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/08/07/reflection/">Java的反射慢吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/08/open-tracing/">open-tracing</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/05/tomcat-startup-2/">tomcat-startup-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/27/tomcat-component-lifecycle/">tomcat-component-lifecycle</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/20/tomcat-startup/">tomcat-startup</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/16/web-xml/">web.xml</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/16/hexo-ubuntu/">hexo迁移到ubuntu</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/08/git-commit-id/">git-commit-id执行耗时过长</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/29/keepalive/">keepalive</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://iip.whu.edu.cn/" title="武汉大学智能信息处理实验室" target="_blank" rel="external nofollow noopener noreferrer">武汉大学智能信息处理实验室</a><ul></ul><a href="http://calvin1978.blogcn.com/" title="江南白衣" target="_blank" rel="external nofollow noopener noreferrer">江南白衣</a><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2022.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>