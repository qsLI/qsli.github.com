<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>tomcat应用部署过程 | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">tomcat应用部署过程</h1><a id="logo" href="/.">KL's blog</a><p class="description">世事洞明皆学问，人情练达即文章</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">tomcat应用部署过程</h1><div class="post-meta">Oct 23, 2022<span> | </span><span class="category"><a href="/categories/tomcat/">tomcat</a></span><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2022/10/23/tomcat-app-deploy/" href="/2022/10/23/tomcat-app-deploy/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#源码"><span class="toc-number">1.</span> <span class="toc-text">源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HostConfig"><span class="toc-number">1.1.</span> <span class="toc-text">HostConfig</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#从哪里来？"><span class="toc-number">1.1.1.</span> <span class="toc-text">从哪里来？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#干了什么？"><span class="toc-number">1.1.2.</span> <span class="toc-text">干了什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PERIODIC-EVENT"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">PERIODIC_EVENT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#事件来源"><span class="toc-number">1.1.2.1.1.</span> <span class="toc-text">事件来源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#对应操作"><span class="toc-number">1.1.2.1.2.</span> <span class="toc-text">对应操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BEFORE-START-EVENT"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">BEFORE_START_EVENT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#START-EVENT"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">START_EVENT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STOP-EVENT"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">STOP_EVENT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ContextConfig"><span class="toc-number">1.2.</span> <span class="toc-text">ContextConfig</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#从哪里来？-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">从哪里来？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#干了什么？-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">干了什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CONFIGURE-START-EVENT"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">CONFIGURE_START_EVENT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#事件来源-1"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text">事件来源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#对应操作-1"><span class="toc-number">1.2.2.1.2.</span> <span class="toc-text">对应操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BEFORE-START-EVENT-1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">BEFORE_START_EVENT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AFTER-START-EVENT"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">AFTER_START_EVENT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CONFIGURE-STOP-EVENT"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">CONFIGURE_STOP_EVENT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AFTER-INIT-EVENT"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">AFTER_INIT_EVENT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AFTER-DESTROY-EVENT"><span class="toc-number">1.2.2.6.</span> <span class="toc-text">AFTER_DESTROY_EVENT</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">2.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="post-content"><p>从前两篇文章中，我们熟悉了tomcat核心组件的启动过程。但是应用是如何部署的，何时部署的，这些过程仍然没有解释清楚。这篇文章，我们主要分析下应用部署的过程。要厘清楚调用关系，最快的莫过于火焰图。</p>
<img src="/2022/10/23/tomcat-app-deploy/image-20211205203743479.png">
<p>从火焰图中，可以清晰地看到，spring应用的启动是在HostConfig#deployDirectory中进行的。那么这个HostConfig到底是何方神圣，启动过程中，怎么没有见到他的身影呢？</p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><h2 id="HostConfig"><a href="#HostConfig" class="headerlink" title="HostConfig"></a>HostConfig</h2><h3 id="从哪里来？"><a href="#从哪里来？" class="headerlink" title="从哪里来？"></a>从哪里来？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostConfig</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HostConfig是LifecycleListener的实现，通过前面的分析，我们知道所有的Listener都在LifecyBase中注册。开启debug模式，在addListener的时候，添加断点，就不难找到调用链路了。</p>
<img src="/2022/10/23/tomcat-app-deploy/image-20211205204201902.png">
<p>Digester解析StandardHost过程中创建的HostConfig，默认的我们的server.xml中是没有声明HostConfig的，顺藤摸瓜，可以在代码中找到调用点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.Catalina#createStartDigester</span></span><br><span class="line">digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.catalina.startup.HostRuleSet#addRuleInstances</span></span><br><span class="line">digester.addRule(prefix + <span class="string">"Host"</span>,</span><br><span class="line">                 <span class="keyword">new</span> LifecycleListenerRule</span><br><span class="line">                 (<span class="string">"org.apache.catalina.startup.HostConfig"</span>,</span><br><span class="line">                  <span class="string">"hostConfigClass"</span>));</span><br></pre></td></tr></table></figure>
<h3 id="干了什么？"><a href="#干了什么？" class="headerlink" title="干了什么？"></a>干了什么？</h3><p>很简单，看他在监听的方法里做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.HostConfig#lifecycleEvent</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process the START event for an associated Host.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event The lifecycle event that has occurred</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Identify the host we are associated with</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            host = (Host) event.getLifecycle();</span><br><span class="line">          	<span class="comment">// 从StandardHost复制一些配置过来</span></span><br><span class="line">            <span class="keyword">if</span> (host <span class="keyword">instanceof</span> StandardHost) &#123;</span><br><span class="line">                setCopyXML(((StandardHost) host).isCopyXML());</span><br><span class="line">                setDeployXML(((StandardHost) host).isDeployXML());</span><br><span class="line">                setUnpackWARs(((StandardHost) host).isUnpackWARs());</span><br><span class="line">                setContextClass(((StandardHost) host).getContextClass());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.cce"</span>, event.getLifecycle()), e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 这里是listener提供的功能</span></span><br><span class="line">        <span class="comment">// Process the event that has occurred</span></span><br><span class="line">        <span class="keyword">if</span> (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">            check();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123;</span><br><span class="line">            beforeStart();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.START_EVENT)) &#123;</span><br><span class="line">            start();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.STOP_EVENT)) &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>LifeCycleEvent中，除了PERIODIC_EVENT不是状态转移触发的，其他的基本都是状态转移触发的，可以查看前面的相关文章。</p>
<h4 id="PERIODIC-EVENT"><a href="#PERIODIC-EVENT" class="headerlink" title="PERIODIC_EVENT"></a>PERIODIC_EVENT</h4><h5 id="事件来源"><a href="#事件来源" class="headerlink" title="事件来源"></a>事件来源</h5><p>首先看<code>Lifecycle.PERIODIC_EVENT</code>，这个事件是ContainerBase中发出的， <strong>是在单独的线程中处理的</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.core.ContainerBase#backgroundProcess</span></span><br><span class="line">fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>ContainerBase在startInternal的最后，如果<strong>backgroundProcessorDelay &gt; 0（默认值-1）</strong>，则会<strong>启动一个线程</strong>来<strong>周期性</strong>地调用自身和child容器的backgroundProcess。<strong>只有StandardEngine修改了默认值</strong>，改为了10，所以会持有这个backgroundProcessor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.core.StandardEngine#StandardEngine</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new StandardEngine component with the default basic Valve.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">super</span>();</span><br><span class="line">  pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());</span><br><span class="line">  <span class="comment">/* Set the jmvRoute using the system property jvmRoute */</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    setJvmRoute(System.getProperty(<span class="string">"jvmRoute"</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">    log.warn(sm.getString(<span class="string">"standardEngine.jvmRouteFail"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// By default, the engine will hold the reloading thread</span></span><br><span class="line">  <span class="comment">// 这里修改了默认值</span></span><br><span class="line">  backgroundProcessorDelay = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用jstack可以验证下，发现只有一条这个线程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"ContainerBackgroundProcessor[StandardEngine[Catalina]]" #57 daemon prio=5 os_prio=31 tid=0x0000000118f72000 nid=0x7203 waiting on condition [0x000000017a0ba000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">        at java.lang.Thread.sleep(Native Method)</span><br><span class="line">        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:<span class="number">1357</span>)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>
<p>线程启动的代码位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.core.ContainerBase#startInternal</span></span><br><span class="line"><span class="comment">// Start our thread</span></span><br><span class="line">threadStart();</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.catalina.core.ContainerBase#threadStart</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start the background thread that will periodically check for</span></span><br><span class="line"><span class="comment">     * session timeouts.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">threadStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">      	<span class="comment">// 注意虽然Host/Context/Wrapper也继承了ContainerBase，但是这个值都是默认的-1，不会创建线程</span></span><br><span class="line">      	<span class="comment">// StandardEngine修改了默认值，所以会有这个线程，线程内会调用子容器的backgroundProcess（）方法</span></span><br><span class="line">        <span class="keyword">if</span> (backgroundProcessorDelay &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        threadDone = <span class="keyword">false</span>;</span><br><span class="line">        String threadName = <span class="string">"ContainerBackgroundProcessor["</span> + toString() + <span class="string">"]"</span>;</span><br><span class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ContainerBackgroundProcessor(), threadName);</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.catalina.core.ContainerBase.ContainerBackgroundProcessor</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">ContainerBackgroundProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     Throwable t = <span class="keyword">null</span>;</span><br><span class="line">     String unexpectedDeathMessage = sm.getString(</span><br><span class="line">       <span class="string">"containerBase.backgroundProcess.unexpectedThreadDeath"</span>,</span><br><span class="line">       Thread.currentThread().getName());</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">while</span> (!threadDone) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 这里有sleep</span></span><br><span class="line">           Thread.sleep(backgroundProcessorDelay * <span class="number">1000L</span>);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           <span class="comment">// Ignore</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (!threadDone) &#123;</span><br><span class="line">           processChildren(ContainerBase.<span class="keyword">this</span>);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (RuntimeException|Error e) &#123;</span><br><span class="line">       t = e;</span><br><span class="line">       <span class="keyword">throw</span> e;</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!threadDone) &#123;</span><br><span class="line">         log.error(unexpectedDeathMessage, t);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.catalina.core.ContainerBase.ContainerBackgroundProcessor#processChildren</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processChildren</span><span class="params">(Container container)</span> </span>&#123;</span><br><span class="line">   ClassLoader originalClassLoader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">       Loader loader = ((Context) container).getLoader();</span><br><span class="line">       <span class="comment">// Loader will be null for FailedContext instances</span></span><br><span class="line">       <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Ensure background processing for Contexts and Wrappers</span></span><br><span class="line">       <span class="comment">// is performed under the web app's class loader</span></span><br><span class="line">       originalClassLoader = ((Context) container).bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 调用自身的，</span></span><br><span class="line">     container.backgroundProcess();</span><br><span class="line">     Container[] children = container.findChildren();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">       <span class="keyword">if</span> (children[i].getBackgroundProcessorDelay() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// 递归处理子容器</span></span><br><span class="line">         processChildren(children[i]);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">     ExceptionUtils.handleThrowable(t);</span><br><span class="line">     log.error(<span class="string">"Exception invoking periodic operation: "</span>, t);</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">       ((Context) container).unbind(<span class="keyword">false</span>, originalClassLoader);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h5 id="对应操作"><a href="#对应操作" class="headerlink" title="对应操作"></a>对应操作</h5><p>StandardEngine会递归的调用子容器的backgroundProcess方法，该方法中会发出PERIODIC_EVENT。</p>
<p>StandardHost发出PERIODIC_EVENT，HostConfig作为其listener接收到PERIODIC_EVENT，会执行check的逻辑，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.HostConfig#check()</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check status of all webapps.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				</span><br><span class="line">      	<span class="comment">// 是否开启自动部署</span></span><br><span class="line">        <span class="keyword">if</span> (host.getAutoDeploy()) &#123;</span><br><span class="line">            <span class="comment">// Check for resources modification to trigger redeployment</span></span><br><span class="line">            DeployedApplication[] apps =</span><br><span class="line">                deployed.values().toArray(<span class="keyword">new</span> DeployedApplication[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; apps.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isServiced(apps[i].name))</span><br><span class="line">                    checkResources(apps[i], <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for old versions of applications that can now be undeployed</span></span><br><span class="line">            <span class="keyword">if</span> (host.getUndeployOldVersions()) &#123;</span><br><span class="line">                checkUndeploy();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hotdeploy applications</span></span><br><span class="line">            deployApps();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.catalina.startup.HostConfig#deployApps()</span></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Deploy applications for any directories or WAR files that are found</span></span><br><span class="line"><span class="comment">     * in our "application root" directory.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployApps</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        File appBase = host.getAppBaseFile();</span><br><span class="line">        File configBase = host.getConfigBaseFile();</span><br><span class="line">        String[] filteredAppPaths = filterAppPaths(appBase.list());</span><br><span class="line">        <span class="comment">// Deploy XML descriptors from configBase</span></span><br><span class="line">        deployDescriptors(configBase, configBase.list());</span><br><span class="line">      	<span class="comment">// 部署war包</span></span><br><span class="line">        <span class="comment">// Deploy WARs</span></span><br><span class="line">        deployWARs(appBase, filteredAppPaths);</span><br><span class="line">      	<span class="comment">//部署 war_exploded</span></span><br><span class="line">        <span class="comment">// Deploy expanded folders</span></span><br><span class="line">        deployDirectories(appBase, filteredAppPaths);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这三种形式的deploy最终都会以<strong>任务</strong>的形式提交到host的<strong>startStopExecutor</strong>中（不阻塞其他的Listener），</p>
<ul>
<li>deployDescriptors -&gt; DeployDescriptor</li>
<li>deployWARs -&gt; DeployWar</li>
<li>deployDirectories -&gt; DeployDirectory</li>
</ul>
<p>最终也会调用HostConfig的方法进行部署，以DeployDirectory为例，最终调用org.apache.catalina.startup.HostConfig#deployDirectory。</p>
<p>这个过程跟火焰图中的调用栈就对得上了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.HostConfig#deployDirectory</span></span><br><span class="line"> Class&lt;?&gt; clazz = Class.forName(host.getConfigClass());</span><br><span class="line">LifecycleListener listener =</span><br><span class="line">  (LifecycleListener) clazz.newInstance();</span><br><span class="line">context.addLifecycleListener(listener);</span><br><span class="line"></span><br><span class="line">context.setName(cn.getName());</span><br><span class="line">context.setPath(cn.getPath());</span><br><span class="line">context.setWebappVersion(cn.getVersion());</span><br><span class="line">context.setDocBase(cn.getBaseName());</span><br><span class="line">host.addChild(context);</span><br></pre></td></tr></table></figure>
<p>核心的代码就是创建Contex，添加为host的子容器。Context可以通过META-INF/context.xml里定制，如果没有的话，会走默认的。这样应用就添加到了tomcat里。子容器在添加之后，host会调用其start方法，触发它的初始化流程。</p>
<h4 id="BEFORE-START-EVENT"><a href="#BEFORE-START-EVENT" class="headerlink" title="BEFORE_START_EVENT"></a>BEFORE_START_EVENT</h4><p>创建server.xml中声明的appBase和configBase目录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.HostConfig#beforeStart</span></span><br><span class="line"> 				<span class="keyword">if</span> (host.getCreateDirs()) &#123;</span><br><span class="line">            File[] dirs = <span class="keyword">new</span> File[] &#123;host.getAppBaseFile(),host.getConfigBaseFile()&#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;dirs.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!dirs[i].mkdirs() &amp;&amp; !dirs[i].isDirectory()) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">"hostConfig.createDirs"</span>,dirs[i]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="START-EVENT"><a href="#START-EVENT" class="headerlink" title="START_EVENT"></a>START_EVENT</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  org.apache.catalina.startup.HostConfig#start</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process a "start" event for this Host.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(sm.getString(<span class="string">"hostConfig.start"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectName hostON = host.getObjectName();</span><br><span class="line">            oname = <span class="keyword">new</span> ObjectName</span><br><span class="line">                (hostON.getDomain() + <span class="string">":type=Deployer,host="</span> + host.getName());</span><br><span class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent</span><br><span class="line">                (<span class="keyword">this</span>, oname, <span class="keyword">this</span>.getClass().getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.jmx.register"</span>, oname), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!host.getAppBaseFile().isDirectory()) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.appBase"</span>, host.getName(),</span><br><span class="line">                    host.getAppBaseFile().getPath()));</span><br><span class="line">            host.setDeployOnStartup(<span class="keyword">false</span>);</span><br><span class="line">            host.setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (host.getDeployOnStartup())</span><br><span class="line">            deployApps();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里只是注册HostConfig到Mbean的Registry中，如果开启了deployOnStartup，这里也会尝试部署一次应用。</p>
<h4 id="STOP-EVENT"><a href="#STOP-EVENT" class="headerlink" title="STOP_EVENT"></a>STOP_EVENT</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.HostConfig#stop</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process a "stop" event for this Host.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(sm.getString(<span class="string">"hostConfig.stop"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).unregisterComponent(oname);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">"hostConfig.jmx.unregister"</span>, oname), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        oname = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>同理，stop中，只是将自身从Registry中移除。</p>
<h2 id="ContextConfig"><a href="#ContextConfig" class="headerlink" title="ContextConfig"></a>ContextConfig</h2><h3 id="从哪里来？-1"><a href="#从哪里来？-1" class="headerlink" title="从哪里来？"></a>从哪里来？</h3><p>和HostConfig类似，Context会有一个对应的LifecycleListener，叫做ContextConfig。他也是在创建的时候默认指定的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.ContextRuleSet</span></span><br><span class="line">digester.addRule(prefix + <span class="string">"Context"</span>,</span><br><span class="line">                 <span class="keyword">new</span> LifecycleListenerRule</span><br><span class="line">                 (<span class="string">"org.apache.catalina.startup.ContextConfig"</span>,</span><br><span class="line">                  <span class="string">"configClass"</span>));</span><br></pre></td></tr></table></figure>
<h3 id="干了什么？-1"><a href="#干了什么？-1" class="headerlink" title="干了什么？"></a>干了什么？</h3><p>看下他在监听部分做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.catalina.startup.ContextConfig#lifecycleEvent</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Identify the context we are associated with</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            context = (Context) event.getLifecycle();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"contextConfig.cce"</span>, event.getLifecycle()), e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process the event that has occurred</span></span><br><span class="line">        <span class="keyword">if</span> (event.getType().equals(Lifecycle.CONFIGURE_START_EVENT)) &#123;</span><br><span class="line">            configureStart();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123;</span><br><span class="line">            beforeStart();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.AFTER_START_EVENT)) &#123;</span><br><span class="line">            <span class="comment">// Restore docBase for management tools</span></span><br><span class="line">            <span class="keyword">if</span> (originalDocBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">                context.setDocBase(originalDocBase);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.CONFIGURE_STOP_EVENT)) &#123;</span><br><span class="line">            configureStop();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.AFTER_INIT_EVENT)) &#123;</span><br><span class="line">            init();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.AFTER_DESTROY_EVENT)) &#123;</span><br><span class="line">            destroy();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="CONFIGURE-START-EVENT"><a href="#CONFIGURE-START-EVENT" class="headerlink" title="CONFIGURE_START_EVENT"></a>CONFIGURE_START_EVENT</h4><h5 id="事件来源-1"><a href="#事件来源-1" class="headerlink" title="事件来源"></a>事件来源</h5><p>StandardContext在启动的时候会发出这个事件，Listener在收到这个event之后，会做一些初始化的准备工作。listener逻辑执行完成之后，会继续执行Context启动的后续逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.core.StandardContext#startInternal</span></span><br><span class="line"><span class="comment">// Notify our interested LifecycleListeners</span></span><br><span class="line">fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Start our child containers, if not already started</span></span><br><span class="line"><span class="comment">// 子容器启动（ServletWrapper）</span></span><br><span class="line"><span class="keyword">for</span> (Container child : findChildren()) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!child.getState().isAvailable()) &#123;</span><br><span class="line">    child.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start the Valves in our pipeline (including the basic),</span></span><br><span class="line"><span class="comment">// if any</span></span><br><span class="line"><span class="comment">// pipeline的初始化，会拉起valve的初始化</span></span><br><span class="line"><span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">  ((Lifecycle) pipeline).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call ServletContainerInitializers</span></span><br><span class="line"><span class="comment">// SCI初始化，spring boot默认依赖这个机制启动，org.springframework.web.SpringServletContainerInitializer</span></span><br><span class="line"><span class="comment">// Jasper JSP Engine也是通过SCI初始化： org.apache.jasper.servlet.JasperInitializer</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;ServletContainerInitializer, Set&lt;Class&lt;?&gt;&gt;&gt; entry :</span><br><span class="line">     initializers.entrySet()) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    entry.getKey().onStartup(entry.getValue(),</span><br><span class="line">                             getServletContext());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">    log.error(sm.getString(<span class="string">"standardContext.sciFail"</span>), e);</span><br><span class="line">    ok = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure and call application event listeners</span></span><br><span class="line"><span class="comment">// ServletContextListener的初始化，使用spring父子容器的话，这里会拉起父容器</span></span><br><span class="line"><span class="comment">// spring的listener： org.springframework.web.context.ContextLoaderListener</span></span><br><span class="line"><span class="keyword">if</span> (ok) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!listenerStart()) &#123;</span><br><span class="line">    log.error(sm.getString(<span class="string">"standardContext.listenerFail"</span>));</span><br><span class="line">    ok = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Configure and call application filters</span></span><br><span class="line"><span class="comment">// filter启动</span></span><br><span class="line"><span class="keyword">if</span> (ok) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!filterStart()) &#123;</span><br><span class="line">    log.error(sm.getString(<span class="string">"standardContext.filterFail"</span>));</span><br><span class="line">    ok = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load and initialize all "load on startup" servlets</span></span><br><span class="line"><span class="comment">// servlet启动，如果servlet设置了load-on-startup</span></span><br><span class="line"><span class="comment">// 如果只是使用了spring mvc，一般就是个servlet，则是在这一步拉起来的</span></span><br><span class="line"><span class="keyword">if</span> (ok) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!loadOnStartup(findChildren()))&#123;</span><br><span class="line">    log.error(sm.getString(<span class="string">"standardContext.servletFail"</span>));</span><br><span class="line">    ok = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadOnStartup如果是true，则启动的时候就拉起Servlet，否则的话是第一个请求过来时触发加载，<strong>lazy式</strong>的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.core.StandardContext#loadOnStartup</span></span><br><span class="line"><span class="comment">// Load the collected "load on startup" servlets</span></span><br><span class="line"><span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;</span><br><span class="line">  <span class="keyword">for</span> (Wrapper wrapper : list) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 触发servlet加载，走入servlet的声明周期，调用servlet的init方法</span></span><br><span class="line">      wrapper.load();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">      getLogger().error(sm.getString(<span class="string">"standardContext.loadOnStartup.loadException"</span>,</span><br><span class="line">                                     getName(), wrapper.getName()), StandardWrapper.getRootCause(e));</span><br><span class="line">      <span class="comment">// <span class="doctag">NOTE:</span> load errors (including a servlet that throws</span></span><br><span class="line">      <span class="comment">// UnavailableException from the init() method) are NOT</span></span><br><span class="line">      <span class="comment">// fatal to application startup</span></span><br><span class="line">      <span class="comment">// unless failCtxIfServletStartFails="true" is specified</span></span><br><span class="line">      <span class="keyword">if</span>(getComputedFailCtxIfServletStartFails()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="对应操作-1"><a href="#对应操作-1" class="headerlink" title="对应操作"></a>对应操作</h5><p>在这个事件的处理函数configureStart中，会扫描web.xml以及相关的文件，配置context。最主要的方法是webConfig()。</p>
<blockquote>
<p>Scan the web.xml files that apply to the web application and merge them<br>using the rules defined in the spec. For the global web.xml files,<br>where there is duplicate configuration, the most specific level wins. ie<br>an application’s web.xml takes precedence over the host level or global<br>web.xml file.</p>
</blockquote>
<p>值得一提的是，这里的listener处理是<strong>同步的</strong>，处理完才会返回到主流程中。webConfig中包含了Servlet注解、filter等的<strong>扫描</strong>，也包含了SCI的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.ContextConfig#configureStart</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process a "contextConfig" event for this Context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">configureStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Called from StandardContext.start()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 核心，web.xml, web-fragment.xml, SCI处理</span></span><br><span class="line">  <span class="comment">// ASM读取class上servlet3.0相关的注解(WEB-INF/classes和)</span></span><br><span class="line">  <span class="comment">// 多个fragment合并成一个web.xml，可以log effective web.xml，</span></span><br><span class="line">  <span class="comment">// 处理WEB-INF/classes/META-INF/resources</span></span><br><span class="line">  <span class="comment">// 扫描过程中找到的servlet定义，也会添加为Context的子容器（Wrapper）</span></span><br><span class="line">  webConfig();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理Listener/Filter/Servlet上的@Resource注解 JSR250</span></span><br><span class="line">  <span class="keyword">if</span> (!context.getIgnoreAnnotations()) &#123;</span><br><span class="line">    applicationAnnotationsConfig();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">    validateSecurityRoles();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Configure an authenticator if we need one</span></span><br><span class="line">  <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">    authenticatorConfig();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make our application available if no problems were encountered</span></span><br><span class="line">  <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">    context.setConfigured(<span class="keyword">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.error(sm.getString(<span class="string">"contextConfig.unavailable"</span>));</span><br><span class="line">    context.setConfigured(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<table>
<thead>
<tr>
<th><code>logEffectiveWebXml</code></th>
<th>Set to <code>true</code> if you want the effective web.xml used for a web application to be logged (at INFO level) when the application starts. The effective web.xml is the result of combining the application’s web.xml with any defaults configured by Tomcat and any web-fragment.xml files and annotations discovered. If not specified, the default value of <code>false</code> is used.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h4 id="BEFORE-START-EVENT-1"><a href="#BEFORE-START-EVENT-1" class="headerlink" title="BEFORE_START_EVENT"></a>BEFORE_START_EVENT</h4><p>调用start之前的钩子，主要是计算docBase</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.ContextConfig#beforeStart</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process a "before start" event for this Context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">beforeStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fixDocBase();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    log.error(sm.getString(</span><br><span class="line">      <span class="string">"contextConfig.fixDocBase"</span>, context.getName()), e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  antiLocking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AFTER-START-EVENT"><a href="#AFTER-START-EVENT" class="headerlink" title="AFTER_START_EVENT"></a>AFTER_START_EVENT</h4><blockquote>
<p>Restore docBase for management tools</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Restore docBase for management tools</span></span><br><span class="line"><span class="keyword">if</span> (originalDocBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">  context.setDocBase(originalDocBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CONFIGURE-STOP-EVENT"><a href="#CONFIGURE-STOP-EVENT" class="headerlink" title="CONFIGURE_STOP_EVENT"></a>CONFIGURE_STOP_EVENT</h4><p>和configure start event对应，容器销毁时执行：</p>
<ul>
<li>Removing children</li>
<li>Removing application parameters</li>
<li>Removing security constraints</li>
<li>Removing Ejbs</li>
<li>Removing environments</li>
<li>Removing errors pages</li>
<li>Removing filter defs</li>
<li>Removing filter maps</li>
<li>Removing local ejbs</li>
<li>Removing Mime mappings</li>
<li>Removing parameters</li>
<li>Removing resource env refs</li>
<li>Removing resource links</li>
<li>Removing resources</li>
<li>Removing security role</li>
<li>Removing servlet mappings</li>
<li>Removing welcome files</li>
<li>Removing wrapper lifecycles</li>
<li>Removing wrapper listeners</li>
<li>Remove (partially) folders and files created by antiLocking</li>
<li>Reset ServletContextInitializer scanning</li>
</ul>
<h4 id="AFTER-INIT-EVENT"><a href="#AFTER-INIT-EVENT" class="headerlink" title="AFTER_INIT_EVENT"></a>AFTER_INIT_EVENT</h4><p>如果存在<code>conf/context.xml</code>，则处理下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.ContextConfig#init</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process a "init" event for this Context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Called from StandardContext.init()</span></span><br><span class="line"></span><br><span class="line">  Digester contextDigester = createContextDigester();</span><br><span class="line">  contextDigester.getParser();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">    log.debug(sm.getString(<span class="string">"contextConfig.init"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  context.setConfigured(<span class="keyword">false</span>);</span><br><span class="line">  ok = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  contextConfig(contextDigester);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AFTER-DESTROY-EVENT"><a href="#AFTER-DESTROY-EVENT" class="headerlink" title="AFTER_DESTROY_EVENT"></a>AFTER_DESTROY_EVENT</h4><p>删除对应的work dir</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.ContextConfig#destroy</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process a "destroy" event for this Context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Called from StandardContext.destroy()</span></span><br><span class="line">  <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">    log.debug(sm.getString(<span class="string">"contextConfig.destroy"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Skip clearing the work directory if Tomcat is being shutdown</span></span><br><span class="line">  Server s = getServer();</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="keyword">null</span> &amp;&amp; !s.getState().isAvailable()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Changed to getWorkPath per Bugzilla 35819.</span></span><br><span class="line">  <span class="keyword">if</span> (context <span class="keyword">instanceof</span> StandardContext) &#123;</span><br><span class="line">    String workDir = ((StandardContext) context).getWorkPath();</span><br><span class="line">    <span class="keyword">if</span> (workDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">      ExpandWar.delete(<span class="keyword">new</span> File(workDir));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>应用的部署和初始化是依赖于HostConfig的，HostConfig是Host容器的<strong>LifecycleListener</strong>，如果没有在xml中显式声明的话，会有默认的</li>
<li>Engine在启动结束时，会起一个ContainerBackgroundProcessor的线程，每10s会调用子容器的<code>backgroundProcess</code>方法，Host容器会发出PERIODIC_EVENT</li>
<li>HostConfig监听到PERIODIC_EVENT，会判断是否开启了autoDeploy，如果开启了，则会检查是否有变更。有变更的话会触发部署，向startStopExecutor线程池提交一个任务（localhost-startStop）</li>
<li>任务的主要内容就是创建Context容器，并添加为Host容器的子容器，并触发Context容器的初始化</li>
<li>Context容器也有一个<strong>LifeCycleListener</strong>——ContextConfig，会接收Context容器相关的事件</li>
<li>Context容器在start时，会发出CONFIGURE_START_EVENT，ContextConfig接收到之后，会扫描web.xml、扫描jar包等，做一些准备的工作</li>
<li>Context容器在调用Listener之后，会初始化他的子容器（ServletWrapper）和pipeline（触发valve的初始化），调用SCI的onstartup方法，<strong>按顺序</strong>触发ContextListener、Filter、Servlet。</li>
<li>Servlet如果声明了load-on-startup，则会在Context的start方法中被初始化（调用servlet的init方法）</li>
<li>除了这种通过HostConfig触发的应用部署，还有关闭autoDeploy的情况下的部署，我们在下篇文章中再介绍。</li>
</ul>
</div><footer class="post-footer"><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者: </strong>代故</li><li class="post-copyright-link"><strong>本文链接: </strong>    <a href="/2022/10/23/tomcat-app-deploy/" target="_blank">http://qsli.github.io/2022/10/23/tomcat-app-deploy/index.html</a></li>  <li class="post-copyright-license"><strong>版权声明: </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 3.0 CN</a></li></ul></div></footer><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2022/10/23/tomcat-app-deploy/" data-id="cl9l4tswc00glea71njr83xc5" class="article-share-link">分享到</a><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? 整杯冰阔乐!<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://qsli.github.io/about/praise.jpg" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="tags"><a href="/tags/tomcat/">tomcat</a></div><div class="post-nav"><a href="/2022/10/19/tomcat-startup-3/" class="next">tomcat bind/listen/acceptor过程</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2022/10/23/tomcat-app-deploy/';
var disqus_title = 'tomcat应用部署过程';
var disqus_url = 'http://qsli.github.io/2022/10/23/tomcat-app-deploy/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/druid/">druid</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/feign/">feign</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mediawiki/">mediawiki</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservice/">microservice</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/logback/" style="font-size: 15px;">logback</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/threadpool/" style="font-size: 15px;">threadpool</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/cglib/" style="font-size: 15px;">cglib</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/pitfall-mysql-connector-java-8-x/" style="font-size: 15px;">pitfall mysql-connector-java 8.x</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/spring-cloud/" style="font-size: 15px;">spring-cloud</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/git-commit-id/" style="font-size: 15px;">git-commit-id</a> <a href="/tags/go学习资料/" style="font-size: 15px;">go学习资料</a> <a href="/tags/grafana/" style="font-size: 15px;">grafana</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/tranfer-encoding/" style="font-size: 15px;">tranfer-encoding</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/java-connector/" style="font-size: 15px;">java-connector</a> <a href="/tags/jinfo/" style="font-size: 15px;">jinfo</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/plantuml/" style="font-size: 15px;">plantuml</a> <a href="/tags/自增主键/" style="font-size: 15px;">自增主键</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/sqlserver-killer/" style="font-size: 15px;">sqlserver-killer</a> <a href="/tags/sudo-log/" style="font-size: 15px;">sudo-log</a> <a href="/tags/swap/" style="font-size: 15px;">swap</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/busy-thread/" style="font-size: 15px;">busy-thread</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/feign/" style="font-size: 15px;">feign</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/format/" style="font-size: 15px;">format</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/generic/" style="font-size: 15px;">generic</a> <a href="/tags/executor/" style="font-size: 15px;">executor</a> <a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/executeBatch/" style="font-size: 15px;">executeBatch</a> <a href="/tags/HttpURLConnection/" style="font-size: 15px;">HttpURLConnection</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/tracing/" style="font-size: 15px;">tracing</a> <a href="/tags/reference/" style="font-size: 15px;">reference</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/sudo/" style="font-size: 15px;">sudo</a> <a href="/tags/top/" style="font-size: 15px;">top</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/google-perf/" style="font-size: 15px;">google-perf</a> <a href="/tags/jdwp/" style="font-size: 15px;">jdwp</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/spring-bean/" style="font-size: 15px;">spring-bean</a> <a href="/tags/tomcat-startup/" style="font-size: 15px;">tomcat-startup</a> <a href="/tags/cache-prep-stmts/" style="font-size: 15px;">cache-prep-stmts</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/transaction/" style="font-size: 15px;">transaction</a> <a href="/tags/spring-validator/" style="font-size: 15px;">spring-validator</a> <a href="/tags/spring-aop/" style="font-size: 15px;">spring-aop</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/10/23/tomcat-app-deploy/">tomcat应用部署过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/19/tomcat-startup-3/">tomcat bind/listen/acceptor过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/18/tomcat-connectionTimeout/">tomcat配置connectionTimeout</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/06/tomcat-threadpool-timeout/">tomcat的线程池为什么不回落？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/05/tomcat-when-queue-is-full/">tomcat队列满了之后会发生什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/08/07/tomcat-stringcache/">tomcat-stringcache</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/08/07/reflection/">Java的反射慢吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/08/open-tracing/">open-tracing</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/05/tomcat-startup-2/">tomcat-startup-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/27/tomcat-component-lifecycle/">tomcat-component-lifecycle</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://iip.whu.edu.cn/" title="武汉大学智能信息处理实验室" target="_blank" rel="external nofollow noopener noreferrer">武汉大学智能信息处理实验室</a><ul></ul><a href="http://calvin1978.blogcn.com/" title="江南白衣" target="_blank" rel="external nofollow noopener noreferrer">江南白衣</a><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2022.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>