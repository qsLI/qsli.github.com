{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/.well-known/acme-challenge","path":".well-known/acme-challenge","modified":1,"renderable":0},{"_id":"source/about/me.jpg","path":"about/me.jpg","modified":1,"renderable":0},{"_id":"themes/maupassant/source/fancybox/fancybox_loading.gif","path":"fancybox/fancybox_loading.gif","modified":1,"renderable":1},{"_id":"themes/maupassant/source/fancybox/blank.gif","path":"fancybox/blank.gif","modified":1,"renderable":1},{"_id":"themes/maupassant/source/fancybox/fancybox_overlay.png","path":"fancybox/fancybox_overlay.png","modified":1,"renderable":1},{"_id":"themes/maupassant/source/fancybox/fancybox_sprite.png","path":"fancybox/fancybox_sprite.png","modified":1,"renderable":1},{"_id":"themes/maupassant/source/fancybox/fancybox_loading@2x.gif","path":"fancybox/fancybox_loading@2x.gif","modified":1,"renderable":1},{"_id":"themes/maupassant/source/fancybox/fancybox_sprite@2x.png","path":"fancybox/fancybox_sprite@2x.png","modified":1,"renderable":1},{"_id":"themes/maupassant/source/css/donate.css","path":"css/donate.css","modified":1,"renderable":1},{"_id":"themes/maupassant/source/css/jquery.fancybox.css","path":"css/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/busuanzi.pure.mini.js","path":"js/busuanzi.pure.mini.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/codeblock-resizer.js","path":"js/codeblock-resizer.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/fancybox.js","path":"js/fancybox.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/css/style.scss","path":"css/style.scss","modified":1,"renderable":1},{"_id":"themes/maupassant/source/image/bg.jpg","path":"image/bg.jpg","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/mindmap.js","path":"js/mindmap.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/share.js","path":"js/share.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/smartresize.js","path":"js/smartresize.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/totop.js","path":"js/totop.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/json-diff.js","path":"js/json-diff.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/search.js","path":"js/search.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/particles.js","path":"js/particles.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/particles.min.js","path":"js/particles.min.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/kity.min.js","path":"js/kity.min.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/js/kityminder.core.js","path":"js/kityminder.core.js","modified":1,"renderable":1},{"_id":"themes/maupassant/source/image/bg2.jpg","path":"image/bg2.jpg","modified":1,"renderable":1}],"Cache":[{"_id":"themes/maupassant/.travis.yml","hash":"0339959f29deddc365e8fe8bd85da524410b9a23","modified":1492343969543},{"_id":"themes/maupassant/LICENSE","hash":"019dc6a9aba02ae3aaabca45f39aecd6e8e7f1d8","modified":1492343969543},{"_id":"themes/maupassant/_config.yml","hash":"f38858826c8d99635109bd970197e9c811af6736","modified":1505027927000},{"_id":"themes/maupassant/README.md","hash":"75d8c42569809961953d1934de445418c00ab94c","modified":1492343969543},{"_id":"themes/maupassant/package.json","hash":"81fb4e2ac051ecfb9a93f37b28910291b939771a","modified":1492343969543},{"_id":"source/.well-known/acme-challenge","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1521074876901},{"_id":"source/about/me.jpg","hash":"231a9ce95dd1e61033737bd5ed5631f1607590bb","modified":1492343969543},{"_id":"source/about/index.md","hash":"dac95bcc65e1b390dd45bcb3da76f00b13a8264e","modified":1516151628427},{"_id":"source/_drafts/HandlerAdapter.md","hash":"4d7438bc63d572c5a3d134a092043b5a698a7bab","modified":1492344203353},{"_id":"source/_drafts/HandlerMapping.md","hash":"a8732ab7bafc5751c8df338b6baf06f82e441728","modified":1492344203353},{"_id":"source/_drafts/P98.md","hash":"822985ec09b5ae710a09385d6907020ff6a170f5","modified":1492344203353},{"_id":"source/_drafts/HandlerMethodArgumentResolver.md","hash":"4f4fbdcc22281e2a02f064be4cd4c1139eaed2c3","modified":1492344203353},{"_id":"source/_drafts/ServletInvocableHandlerMethod.md","hash":"a5b068a980492f1310453b06f92d371d0cd9a497","modified":1492344203353},{"_id":"source/_drafts/WeakHashMap.md","hash":"4858e11fd0543fe71502ad12a4e6fa3dab0d635e","modified":1492344203357},{"_id":"source/_drafts/ab.md","hash":"2a15dd214d84493d661b8a158aa7f8ce615f1117","modified":1516510492526},{"_id":"source/_drafts/burpsuite-https.md","hash":"7e48137b349dc9aac52c49ccdd960316387f0c23","modified":1492344203357},{"_id":"source/_drafts/cap.md","hash":"314c422a159c8d331b58fc7b2e1e07d827492027","modified":1516093413198},{"_id":"source/_drafts/classloader.md","hash":"b96262d67327ecdb5cb5553383bcd64b5f99b40e","modified":1492344203357},{"_id":"source/_drafts/curl.md","hash":"a6ac275c19036129986541387a230eef64e8f19f","modified":1510469469453},{"_id":"source/_drafts/custom-editor.md","hash":"942ae7ba25a2c258222c709c46a5a5516affccdb","modified":1525265765349},{"_id":"source/_drafts/diffy.md","hash":"3a51b8816e51e29792b0c9f40533fafa313b7aec","modified":1492344203357},{"_id":"source/_drafts/digester.md","hash":"b96dfe4f48d7e08264c305c2cecbc27325ec43e3","modified":1492344203361},{"_id":"source/_drafts/dozer.md","hash":"09956a30e622b44f7afc441e0dcc204177ac48f4","modified":1502633833142},{"_id":"source/_drafts/dubbo-filter.md","hash":"5897dec0c7561d6430b4c3100f36e199d10ec9d5","modified":1502633833138},{"_id":"source/_drafts/dubbo-telnet.md","hash":"1dd09cab3c84d318163a10012b1443d29e08ae07","modified":1496250270918},{"_id":"source/_drafts/dubbo.md","hash":"b77c9c9569075032048ce2043b053a89b5ccf505","modified":1496249916000},{"_id":"source/_drafts/gc-basic.md","hash":"ea3e5771a6c390a99fa9c2c110abacd2b7818d34","modified":1513529302000},{"_id":"source/_drafts/gc-g1.md","hash":"cdf0bb65503f2c857aa02d85f5aaddfb32db91e6","modified":1492344203365},{"_id":"source/_drafts/gc-cms.md","hash":"e44e9169ed000f47973fb01e017f975c6525f1e7","modified":1492344203361},{"_id":"source/_drafts/gc-serial.md","hash":"e30e805f2732f940ca8cf261456b5840412f5c84","modified":1492344203365},{"_id":"source/_drafts/getting-started-with-system.md","hash":"84682c5f5da7d5168d7d2d60168192e799001735","modified":1492344203369},{"_id":"source/_drafts/http.md","hash":"1af87802e92623bc94de6e15fbaff8cac3c6c5e9","modified":1519201140826},{"_id":"source/_drafts/idea-plugins.md","hash":"7e84e4bc0775516d9404cd1643d66887b7b2a80c","modified":1492344203373},{"_id":"source/_drafts/impress-js.md","hash":"95d2502696e20056e90835a4985551237992fdab","modified":1492344203369},{"_id":"source/_drafts/inode.md","hash":"8da8ad7c8a11030d0262c5d54f615f49a2b6dcd2","modified":1492344203373},{"_id":"source/_drafts/jackson-custom.md","hash":"5a540d1dae10ed725c814e76322b81ee9e5a9d3a","modified":1509798840000},{"_id":"source/_drafts/java-URL.md","hash":"c4a370571d77b00e1ead8d8131658594d745bc35","modified":1492344203373},{"_id":"source/_drafts/java-gc.md","hash":"2799442c406ae939716915071f393dec1e3e1cf7","modified":1492344203373},{"_id":"source/_drafts/java-introspector.md","hash":"a67a930b77c4ea32739d60fc062fd7ec204b5fcb","modified":1492344203373},{"_id":"source/_drafts/java-object-diff.md","hash":"7c5a27e9ce3fe0e770f6d64d1c84d5345441d584","modified":1492344203373},{"_id":"source/_drafts/java-proxy.md","hash":"63cee9ae7056747e16e369b792a6c0b819c6e791","modified":1492344203373},{"_id":"source/_drafts/jsonpath.md","hash":"221a016f3634f983df69aff908e93e3f384ed1bf","modified":1505058230000},{"_id":"source/_drafts/jstack.md","hash":"1a9f30fed4002b4f0e4495fcdee0dee08ec6d14e","modified":1512208729589},{"_id":"source/_drafts/jvm-shutdown-hook.md","hash":"be6b026352a7fb6a31fad1a3cb378267d5b54cbb","modified":1512812047000},{"_id":"source/_drafts/less.md","hash":"4988286876822daf4d9e2de8ce4db3732914995d","modified":1510469450092},{"_id":"source/_drafts/kibana.md","hash":"15229d4ebc21696bb1c8c832fe02938e16868558","modified":1492344203377},{"_id":"source/_drafts/logback-source.md","hash":"b7870bca926fb412fdc25f36471f6b4565d7b9f0","modified":1492344203377},{"_id":"source/_drafts/logback.md","hash":"7c58cd1aa1c76f6f5d360d538e0516977998acca","modified":1512808186000},{"_id":"source/_drafts/map.md","hash":"1269372b062319c8cf5f2e3039c88974370e2e5c","modified":1510024552000},{"_id":"source/_drafts/maven-repo-mirror.md","hash":"cb738be339a16e6275219d2a677cc22c0f6af402","modified":1492531300507},{"_id":"source/_drafts/more-executors.md","hash":"938968b00bcfc9653c7118f59f8c5f6c11b9bdaf","modified":1511000267493},{"_id":"source/_drafts/murmur.md","hash":"3bdf5f1d963abbe8752205840a305e059c46355f","modified":1505148045037},{"_id":"source/_drafts/netty.md","hash":"824f044caace75a39fa168e6059d75fae16c14d6","modified":1492344203377},{"_id":"source/_drafts/python-json.md","hash":"f1dfdee2a3505ad0b954f8d88ebdde015b2b26a2","modified":1492344203377},{"_id":"source/_drafts/protobuf.md","hash":"ec9dcfb4656cad21b14e2c6327ca84bde98453e4","modified":1492344203377},{"_id":"source/_drafts/ratelimiter.md","hash":"f818dbf78b58b1299f58d61130c34776b9a651dc","modified":1516121735920},{"_id":"source/_drafts/rpc.md","hash":"45ec01b0e2069955e20cf0b4e8ab98a984e83a95","modified":1492344270002},{"_id":"source/_drafts/spring-view-resolver.md","hash":"c08abaea680e8c04b027f3736fcfb542163e5004","modified":1492344203377},{"_id":"source/_drafts/ssh.md","hash":"d7605c1d297d848fc2144e55a40fe79313267fc0","modified":1492344203377},{"_id":"source/_drafts/task.md","hash":"141bfc83c838a61d6dd77458145ed3ceccdef65a","modified":1492344203377},{"_id":"source/_drafts/thread-interrupted.md","hash":"0a5d6402e3d2851e8967ece633d0d6847092c8b2","modified":1510999741386},{"_id":"source/_drafts/threadlocal-threadpool.md","hash":"463a9ab044dbc7a80007bdb3e881f1e308710145","modified":1512235859000},{"_id":"source/_drafts/tomcat-arch.md","hash":"f4b43771a41f24446a8ed34162594d16682d721a","modified":1492344203381},{"_id":"source/_drafts/tomcat-optimize.md","hash":"513e5277a7ae8b03bd1ee872dfe3025a95791ed4","modified":1492344203381},{"_id":"source/_drafts/tomcat-sci-spring-boot.md","hash":"2955767233416d6dc22dc911eacc791ccc2469d7","modified":1523106527914},{"_id":"source/_drafts/union-find.md","hash":"6a45ec63ed4d09160aac7b01eaa3dad90142ab4c","modified":1523760948026},{"_id":"source/_drafts/vim.md","hash":"5139504a8ce8d4cc7690691b13ce13a89a24e56b","modified":1492344203381},{"_id":"source/_drafts/zookeeper.md","hash":"7f6f56e178f410e2bed961d4e1b35412b052a10a","modified":1492344203381},{"_id":"source/_posts/CLIP.md","hash":"3bc1cb0366efce1115cbb0bd8c13ca345ed9d4fd","modified":1492344203381},{"_id":"source/_posts/HttpMessageConverter.md","hash":"e737ad34d5c3230467d2355aa60eae7f0f96ef3f","modified":1492343969539},{"_id":"source/_posts/MAT-Ubuntu.md","hash":"7a8430d4deecf2c6446deedeac8883b2aa738eb1","modified":1510484224412},{"_id":"source/_posts/Spring-mvc-exception.md","hash":"19dab538e59f0c6fde55c17d9ba89bf545fddebb","modified":1492344203385},{"_id":"source/_posts/ThreadFactoryBuilder.md","hash":"7ff6b3ae8f940f79831b49f64adece16aacb3c4a","modified":1510996534206},{"_id":"source/_posts/atnode.md","hash":"d94ea01e80b18e0c8d23f455b80a3477b4bb362e","modified":1492344203385},{"_id":"source/_posts/base64.md","hash":"928563edecc212c07e51a7dee8cdc0246250c0dc","modified":1492344203385},{"_id":"source/_posts/cache-system-time.md","hash":"ad8209c78e0de6772c94403998fae8ae44f3398e","modified":1512224191044},{"_id":"source/_posts/character-encoding.md","hash":"ffceaf832807cb409c0fa0e4a9d9fc8a2c760a04","modified":1492344270006},{"_id":"source/_posts/custom-tag.md","hash":"e0ea4aeba584390722d06b6f4d8912b057c16e9a","modified":1492344203389},{"_id":"source/_posts/cygwin-360.md","hash":"758eea2dcb2a72c6c26cfce34b947ae0739979ba","modified":1492344203389},{"_id":"source/_posts/electron.md","hash":"92fa8823cf82f08795fac605ba306766f8c6e278","modified":1505032076000},{"_id":"source/_posts/dubbo-generic-invoke.md","hash":"5e7fed40f0099cda1c2f6347b87187be7aaf650a","modified":1525265615000},{"_id":"source/_posts/executor.md","hash":"a43e1d08d87bf227345018ba6ac5ea6686c10d65","modified":1511035282412},{"_id":"source/_posts/fabric.md","hash":"0c9be9af36169d903e3021700d983d094be55456","modified":1492344203389},{"_id":"source/_posts/git-branch-log.md","hash":"f75c6ff543c4e61a08b7cac368b9705a31fd7440","modified":1505147140548},{"_id":"source/_posts/factorybean.md","hash":"0df96a4929856724b483c98d325ecc09346ba7d2","modified":1492344203389},{"_id":"source/_posts/git-checkout.md","hash":"f6dd1e3b195a7acb5f99e2232b6fb895f672e81e","modified":1505147892137},{"_id":"source/_posts/go-figure.md","hash":"201488e9262e1ebf9864cdb81d7000b7dac46f70","modified":1516455787419},{"_id":"source/_posts/grep.md","hash":"dda6c6630bd8b572183a8380c574115610cc2fec","modified":1510024534000},{"_id":"source/_posts/google-perf-tools.md","hash":"770e34ff532fb25afef66cda08c5e30cc52bc43e","modified":1512213878257},{"_id":"source/_posts/greys-start.md","hash":"945b9189e04c4a1da5889ec6d6ed7b2d37ec44ba","modified":1525490459841},{"_id":"source/_posts/hexo-ubuntu.md","hash":"670e5ddf22166c73a0f181ce4826488f61c86e05","modified":1492531695398},{"_id":"source/_posts/greys.md","hash":"2d3ad4a7e57ed5bc4188578137e79a4dc4a2d981","modified":1522594100265},{"_id":"source/_posts/guava-eventbus.md","hash":"0ed5dea1090918edf13176e24df0e79484a1ebd4","modified":1492344270006},{"_id":"source/_posts/hello-world.md","hash":"d763e05c6211d707c833bb011d8ae5c2fcdefcb8","modified":1525490445429},{"_id":"source/_posts/idea-scratches.md","hash":"52ab3a46a72b52470f0bd309188062fe00c03c21","modified":1492344203393},{"_id":"source/_posts/how-to-delete-file-correctly.md","hash":"b01273df5679c972d2d9afbfbc2af44b790babb0","modified":1505017209254},{"_id":"source/_posts/idea-template.md","hash":"d279ebaaa9e94b78f3b65af7c054fab4724854d4","modified":1492344203393},{"_id":"source/_posts/jackson-guava.md","hash":"a3327ede26c7e32dfa2c9d1ce537e23d5b33d0b5","modified":1492344203393},{"_id":"source/_posts/jar.md","hash":"bb5c5c463abf81a4597b82ea25cae84e264d01e6","modified":1492344270010},{"_id":"source/_posts/java-exception.md","hash":"8670b95389431da90997c7e47f96106f61b64d00","modified":1492343969543},{"_id":"source/_posts/java-permission-control.md","hash":"bf5fe8f52fd8d0c7720bb95a1a787a2007772049","modified":1492344203393},{"_id":"source/_posts/javadoc.md","hash":"ac9d87802cd66d7c496e1583386d65237cc8ca48","modified":1492344270010},{"_id":"source/_posts/java8-file-stream.md","hash":"fbbcc2f2fba7a072663084eddc79d7d1bf7bde1d","modified":1510999395451},{"_id":"source/_posts/jinfo.md","hash":"7badd101a49fdce888c0075dfaa5114b01532693","modified":1511709661000},{"_id":"source/_posts/jsonp.md","hash":"539fc1736a2fcbcbb3d67fedddcc19c276a5790e","modified":1492344203393},{"_id":"source/_posts/jvm-flag.md","hash":"e246e17ab9a38afd8942227ad275459428063e40","modified":1502633833142},{"_id":"source/_posts/jvm-omit-fast-throw.md","hash":"e23908ec42ee2bcac05d888c325b2b8a8a29931f","modified":1512234149402},{"_id":"source/_posts/markdown-here.md","hash":"5721ec209fad2760156b0f04321b944f88111770","modified":1492344203393},{"_id":"source/_posts/machine_learning.md","hash":"9530dd82b9a83ee4ed62ff2ad760d75f3193ac43","modified":1492344203393},{"_id":"source/_posts/mysql-time.md","hash":"a47cdf3e19ec4e4f555e4f84a1fd8c95ed6e270e","modified":1492344203393},{"_id":"source/_posts/markdown-mindmap.md","hash":"a721226628cbe8fc936c526eee9f18ea97922cbd","modified":1492344203393},{"_id":"source/_posts/maven-scope.md","hash":"f7f388cf5847447e3b9f669ff4ce1092c326bce7","modified":1496248974077},{"_id":"source/_posts/nc.md","hash":"a8194db2c4175bc3b7e9a865f41cb10fb6313cee","modified":1492344203393},{"_id":"source/_posts/pagination.md","hash":"30dbd7a13571e171886fc72b4b204a6b62077e2f","modified":1492344203397},{"_id":"source/_posts/pip.md","hash":"52159c2fddb3589d6f7967a2662541a41ca1a326","modified":1492344203397},{"_id":"source/_drafts/problem-tuning.md","hash":"a8171a61911165f12d010b615c3dd30725774111","modified":1510469921513},{"_id":"source/_posts/postgre.md","hash":"54955729570c565181db65a607ba4285c8719277","modified":1492344203401},{"_id":"source/_posts/re.md","hash":"eafb2e8e5bcc8b7baba5382d589b9360e5df1843","modified":1492344203405},{"_id":"source/_posts/python-util.md","hash":"11b9ca1a36576ee297b73e21b2d442d6d01b7b02","modified":1492344203397},{"_id":"source/_posts/property-placeholder.md","hash":"8a302df4cbf44212a2b4072a66dab8ebfe679e04","modified":1492344203405},{"_id":"source/_posts/servlet-async.md","hash":"99866eb1812808b10067031fcb1ff5d200c3b194","modified":1492344270014},{"_id":"source/_posts/shadowsocks.md","hash":"83cdc25492eeaaa640350a92a40c01bc52d039e4","modified":1492344203405},{"_id":"source/_posts/shell-input-limit.md","hash":"3227f4d52816d57c470428fbce942a735d1cfa48","modified":1492344270014},{"_id":"source/_posts/spi.md","hash":"283049def392891a0059f20b3fdbc5f621417cb0","modified":1492344203405},{"_id":"source/_posts/slf4j-bridge.md","hash":"0704fdebb21642063fe162ade183a938a527ca70","modified":1525508099812},{"_id":"source/_posts/spring-mvc-2.md","hash":"646c4339e41a7468de5c6eb8a6c433f4f4101b1a","modified":1525598208729},{"_id":"source/_posts/spring-mockMvc.md","hash":"fcad67f416b4793bd22b92a82341cde75b9f9fcd","modified":1492344203405},{"_id":"source/_posts/ssh-passwd-free.md","hash":"6b5bbf254d5b8e12cd80a962bb1f23757e2fec6d","modified":1492344203409},{"_id":"source/_posts/spring-mvc.md","hash":"ce60ba35814b94e6a0eae01b135e101a2c3c9b33","modified":1525490528108},{"_id":"source/_posts/spring-resource.md","hash":"20d3a1d9eb696fc42705cfc0ba936157444eadb0","modified":1492344203409},{"_id":"source/_posts/tomcat-AbstractMethodError.md","hash":"ffe8cc00cdea9f63dffc6c68331cca4af11cd499","modified":1492344270014},{"_id":"source/_posts/tomcat-access-log.md","hash":"5392986f1eab02e2f09ca48d351a505027d09ced","modified":1492344203409},{"_id":"source/_posts/tomcat-connection.md","hash":"2e747167af13a3014803342865564a823aa4d93e","modified":1492344203409},{"_id":"source/_posts/tomcat-encoding.md","hash":"76254480a215511cb435c4976922edd5ee877432","modified":1492344203409},{"_id":"source/_posts/tomcat-stringmanager.md","hash":"792179d740a50759e25bfcd0c5f3426c24f73a5b","modified":1492344270014},{"_id":"source/_posts/web-xml.md","hash":"9307e9ffb429f6ec007ce8ebd5e07621810705f4","modified":1492344299114},{"_id":"source/_posts/top.md","hash":"2def41d640ca6c2b7416f178fb362526435b67ca","modified":1505017327000},{"_id":"source/_posts/xstream.md","hash":"e7c97f3a0b66b5a41ea66e17ee4d326daa3d806d","modified":1492344203409},{"_id":"source/recommendation/index.md","hash":"0a890b8c6631dba99ed405d5e0bb812db3672780","modified":1496249910000},{"_id":"source/tags/index.md","hash":"279e590647b1cce4055de9e16aca93fcb3d7662b","modified":1492343969543},{"_id":"themes/maupassant/layout/archive.jade","hash":"0050c883b4f202add71c8664d65e6072179e7190","modified":1492343969543},{"_id":"themes/maupassant/layout/base-without-sidebar.jade","hash":"690fee04231b2e6721580516849f7b80cf42be94","modified":1492343969543},{"_id":"source/_posts/plantuml.md","hash":"02cbb3c1c1b2bb209095d28421ab5cbe0af1e6bb","modified":1492344270010},{"_id":"themes/maupassant/layout/base.jade","hash":"38623bd05e2062c55e61d3c9be7ed8a327dd1077","modified":1504956732000},{"_id":"themes/maupassant/layout/index.jade","hash":"f0854001233c383e01febdfef25f5891d0185e87","modified":1504950709926},{"_id":"themes/maupassant/layout/page.jade","hash":"8d70fd3b93f2c9087a9ea7ec538dcc1d413bea01","modified":1492343969543},{"_id":"themes/maupassant/layout/post.jade","hash":"6443511a176f320fe46edae0b4a985cf8778a3bc","modified":1492343969543},{"_id":"themes/maupassant/layout/timeline.jade","hash":"f03d8df63a188543cfe4e85e76194abe081411a1","modified":1492343969543},{"_id":"themes/maupassant/layout/single-column.jade","hash":"c35fff4d9b331a41af5bc10f4278ec3d9da503db","modified":1492343969543},{"_id":"themes/maupassant/languages/de-DE.yml","hash":"5d3556a885e355a8c2da65ef3e7b3ee36a628bfa","modified":1492343969543},{"_id":"themes/maupassant/languages/es-ES.yml","hash":"58e1d04bcd1834fa9d2960e18e027abbbccbedc9","modified":1492343969543},{"_id":"themes/maupassant/languages/en.yml","hash":"1f3d723b25e60218e1a61dc445bf0fa38275ba7e","modified":1492343969543},{"_id":"themes/maupassant/languages/fr-FR.yml","hash":"b47906ec0abf867fb3e3360bc046b7afb68aee25","modified":1492343969543},{"_id":"themes/maupassant/languages/ko.yml","hash":"909a33e0befa6978e8e72157c6b415b48551ee31","modified":1492343969543},{"_id":"themes/maupassant/languages/zh-CN.yml","hash":"abe10bac7d46b45da3305d9b405b05b32b733b86","modified":1492343969543},{"_id":"themes/maupassant/languages/zh-TW.yml","hash":"56b65995c60e99dcebbf00168447fd225d28e5b2","modified":1492343969543},{"_id":"source/_drafts/gc-basic/gc.jpg","hash":"a3ab3f2011985157de2799d9be00505a1a78eab2","modified":1513518402354},{"_id":"source/_drafts/http/10-21-http-request.png","hash":"7139d7e857c470ffbd789f0de3a166825685c988","modified":1492343969539},{"_id":"source/_drafts/http/http_request_message.png","hash":"c7714d5d9acedc28c3ca56d804a2fa243ad67388","modified":1492343969539},{"_id":"source/_drafts/inode/example.jpg","hash":"5cbdbd1a32b06ff13b28d8b264fc64a0f6a86a12","modified":1492343969539},{"_id":"source/_drafts/inode/high-level.jpg","hash":"c6ed5d78bfc32e4de83aeff88833e241b7f6f786","modified":1492343969539},{"_id":"source/_drafts/inode/low-level.jpg","hash":"2f7ddfedba4645e421d17450ecce9ef6490e1ab8","modified":1492343969539},{"_id":"source/_drafts/inode/unix-file-structure.jpg","hash":"e279b6af2942dad6e58480c067d3897aa070e7eb","modified":1492343969539},{"_id":"source/_drafts/jackson-custom/BeanSerializer.jpg","hash":"5c4b653b4ace19b99745b08471fd0d56f5054482","modified":1506235723194},{"_id":"source/_drafts/jackson-custom/BeanSerializerBase.jpg","hash":"e845271511283bdc73ddc2eebc780a3c1a63305a","modified":1506186941354},{"_id":"source/_drafts/jackson-custom/DefaultSerializerProvider.jpg","hash":"82dc143e290623f30df04382bbe04b8bb0858bc9","modified":1506187025336},{"_id":"source/_posts/HttpMessageConverter/inherit.jpg","hash":"1776d8f3e17b516ecc36fb3c55a398e6348760d7","modified":1492343969539},{"_id":"source/_posts/base64/encoding.jpg","hash":"5ed8de255bfe78f23b7cc920171655a4487a509b","modified":1492343969539},{"_id":"source/_posts/base64/encoding2.jpg","hash":"da197012f219ae5c3cacf049e0d15e9c9693c981","modified":1492343969539},{"_id":"source/_posts/character-encoding/Unicode_logo.jpg","hash":"8ca31a7bd95ffb6a1aa6456c1b0970e1a5458fd7","modified":1492343969543},{"_id":"source/_posts/character-encoding/unicode-layout.jpg","hash":"59c7ccbffd30aeb97f811b67a9f94a0f5c1bb5e0","modified":1492343969543},{"_id":"source/_posts/character-encoding/emoji.jpg","hash":"e4e05e46031c997ddd9b3d53a385c6d653963cd6","modified":1492343969543},{"_id":"source/_posts/electron/electron.jpg","hash":"584149413cf7bbf4ab275b832afa9d7465d5a4c6","modified":1505031975336},{"_id":"source/_posts/electron/item.png","hash":"ce783cc3a9a290e4b2dca32fd48e9b27b9157dcf","modified":1505031457046},{"_id":"source/_posts/electron/select.png","hash":"0af4298edad6cdc8c5861824820cf07f47833ec9","modified":1505031252934},{"_id":"source/_posts/git-branch-log/glgga.png","hash":"2c4f3c3001222af1eba177a955bd4198519e1379","modified":1505147140556},{"_id":"source/_posts/google-perf-tools/result.pdf","hash":"c3b07f7cca94cedf4f39349095dfa2f204bf380b","modified":1512213878265},{"_id":"source/_posts/google-perf-tools/memory-mapping.jpg","hash":"fa598d02a2d0456a5511bce64b9956aa643b4755","modified":1512213878265},{"_id":"source/_posts/grep/color.jpg","hash":"9b1ae87a35402005befa583795e231ccc49dca29","modified":1492343969543},{"_id":"source/_posts/grep/egrep.jpg","hash":"d13cb7333887eb76541f6ffb9a294c1d9404942e","modified":1492343969543},{"_id":"source/_posts/greys-start/attach.jpg","hash":"6a17fef50ef8ad023941bdbce82dedd79b03910e","modified":1522603913848},{"_id":"source/_posts/how-to-delete-file-correctly/after.png","hash":"ec4db540892ef32fdf6e1151a5680887513d2b51","modified":1505017209258},{"_id":"source/_posts/how-to-delete-file-correctly/before.png","hash":"ec4db540892ef32fdf6e1151a5680887513d2b51","modified":1505017209258},{"_id":"source/_posts/how-to-delete-file-correctly/inode.png","hash":"b0f83b85f364e13eff052a5b10b9b75c3b388a40","modified":1505017209258},{"_id":"source/_posts/how-to-delete-file-correctly/links.png","hash":"1cda70c9b4821d3ecf1804b785898e11262e5a80","modified":1505017209258},{"_id":"source/_posts/idea-scratches/keymap.jpg","hash":"9ba0b9485e48a65e209e16661a13b9b6bc93e152","modified":1492343969543},{"_id":"source/_posts/idea-scratches/menu.jpg","hash":"73ac891ae3864cb7e174d1e51a31bb422c8320d9","modified":1492343969543},{"_id":"source/_posts/idea-scratches/new.jpg","hash":"124a569f2c1b11bf8816f31b516aa81a0f99e086","modified":1492343969543},{"_id":"source/_posts/idea-scratches/scratches.jpg","hash":"553a08b63e4f56b9d5208541fbb39f0b82205c37","modified":1492343969543},{"_id":"source/_posts/idea-template/profiles.jpg","hash":"cc82791405ece2982b41af9f5eebd9ebf2009708","modified":1492343969543},{"_id":"source/_posts/idea-scratches/search.jpg","hash":"43b627ea26b9a4fe7be2b963e921c708e8762fec","modified":1492343969543},{"_id":"source/_posts/jsonp/cors.png","hash":"03174e532d5fab79c1d9fd0a00139d4978443df0","modified":1492343969543},{"_id":"source/_posts/jsonp/sample.png","hash":"5c66eed23ecf164fca1d7f1f71eb2bd33d85c770","modified":1492343969543},{"_id":"source/_posts/markdown-here/additional.jpg","hash":"9a7c6f51d83ac4815c661411786d5a4307923e62","modified":1492343969543},{"_id":"source/_posts/markdown-here/mail.jpg","hash":"a89f7167ca6b1fe12b2e949f7290f26e273edebf","modified":1492343969543},{"_id":"source/_posts/markdown-mindmap/sample.jpg","hash":"ebbde815a587d2a0a38ecada7ba9d54723905484","modified":1492343969543},{"_id":"source/_posts/postgre/history.jpg","hash":"b40a177bc06fe594dbbf51ead88b1949d11ae5da","modified":1492343969543},{"_id":"source/_posts/property-placeholder/hierarchy.jpg","hash":"df248929441da0b2bdbe7afbf56d4729ae8f524d","modified":1492343969543},{"_id":"source/_posts/property-placeholder/location.jpg","hash":"cf8a3be6950b18df2310584921d7058f45b4ffcf","modified":1492343969543},{"_id":"source/_posts/spring-mvc/Servlet_LifeCycle.jpg","hash":"ec5a5ed7867fd6fd38c21edd4bd4336a39446614","modified":1492343969543},{"_id":"source/_posts/spring-mvc-2/spring-mvc.png","hash":"04f940f8a17cbc10011891e63f5b3db2343fb26a","modified":1525598208737},{"_id":"source/_posts/spring-mvc/hierachy.jpg","hash":"d2791a173d265df7a59e2a1a83f86bbb93a949b4","modified":1492343969543},{"_id":"source/_posts/spring-mvc/servlet-interface.jpg","hash":"362e1f8d17678f77285a987de921dc70a2647454","modified":1492343969543},{"_id":"source/_posts/spring-resource/resource.jpg","hash":"f45bcaa3dd495300355ff09830a1500c36c71870","modified":1492343969543},{"_id":"source/_posts/tomcat-connection/tomcat-interaction.jpg","hash":"753988a71e259935859a9f7e717c12fc61dfbc19","modified":1492343969543},{"_id":"themes/maupassant/source/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1492343969543},{"_id":"themes/maupassant/source/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1492343969543},{"_id":"themes/maupassant/source/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1492343969543},{"_id":"themes/maupassant/source/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1492343969543},{"_id":"themes/maupassant/source/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1492343969543},{"_id":"themes/maupassant/source/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1492343969543},{"_id":"themes/maupassant/source/css/donate.css","hash":"f6c2b20167f3ae5ff5d3e55c2edd72a134456436","modified":1492343969543},{"_id":"themes/maupassant/source/css/jquery.fancybox.css","hash":"f42f761157f26244673eb2f4a9215c70956f80dc","modified":1492343969543},{"_id":"themes/maupassant/source/js/busuanzi.pure.mini.js","hash":"45980c51f537ce7adf9eb793a55758d071d58412","modified":1492343969543},{"_id":"themes/maupassant/source/js/codeblock-resizer.js","hash":"5d0b786d60bf225d9eabcc9cece2719ff4d9b6cd","modified":1492343969543},{"_id":"themes/maupassant/source/js/fancybox.js","hash":"13c4781570339f4fba76a3d7f202e442817dd605","modified":1492343969543},{"_id":"themes/maupassant/source/css/style.scss","hash":"2309b5c1f9f0de7cfa5e584e60613b27422c903e","modified":1505058257793},{"_id":"themes/maupassant/source/image/bg.jpg","hash":"fda749c7beb5c456da00b095018bf0074a074e3a","modified":1503827566373},{"_id":"themes/maupassant/source/js/mindmap.js","hash":"de4ea6504cc925ba18f98bbcd96fc81b4c90e2f9","modified":1492343969543},{"_id":"themes/maupassant/source/js/share.js","hash":"f49776e0baa2b913ddc7a20db24b3edd469c8343","modified":1492343969543},{"_id":"themes/maupassant/source/js/smartresize.js","hash":"3ef157fd877167e3290f42c67a624ea375a46c24","modified":1492343969543},{"_id":"themes/maupassant/source/js/totop.js","hash":"7dbf8fcf582a4fb6eb9b2c60d6de9f9c2091ec4c","modified":1492343969543},{"_id":"themes/maupassant/source/js/json-diff.js","hash":"1ecc45fd2dd6d2f27bb62185920eb23f4cd56f4d","modified":1484747536000},{"_id":"themes/maupassant/source/js/search.js","hash":"0c0630e2ef213701d393b041f10572e951a27985","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/comments.jade","hash":"c72dbf893ce826665bbac40bc32caf1b0a9305a9","modified":1492343969543},{"_id":"themes/maupassant/source/js/particles.js","hash":"a416f570f80cb303691bd33b7070b7976d6bd807","modified":1504959632194},{"_id":"themes/maupassant/layout/_partial/after_footer.jade","hash":"8e02272353c897d0f698e0dea26461de1744e934","modified":1504960373000},{"_id":"themes/maupassant/layout/_partial/donate.jade","hash":"3ad68807f5da92a968fd75f68bc98a3aece77a73","modified":1492343969543},{"_id":"themes/maupassant/source/js/particles.min.js","hash":"8017f8b1869077db728573f1ca4684a00af69462","modified":1504954819731},{"_id":"themes/maupassant/layout/_partial/helpers.jade","hash":"acdf9e2d52ee86c831fa15ce1570930c5779bc78","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/mathjax2.jade","hash":"d6ac5dc4e9c7a1b866f1f92d88988cfb35aded4c","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/footer.jade","hash":"9ecae84d8534eb2006b3da0e0e63a5091e4a47f5","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/mathjax.jade","hash":"b54b56faff9e47ab3ca3cdd55056c73e60776f3c","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/tag.jade","hash":"0f0e6770e9d5dd8040e330d71bbbfadd2df36a28","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/paginator.jade","hash":"53f9cb77448e84a98da5eb688e2e12b173c555bb","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/post_nav.jade","hash":"a2d698c84bb6da08195fe870dbd7215f65388d3f","modified":1492343969543},{"_id":"themes/maupassant/layout/_widget/category.jade","hash":"7c6aed762934ca51aa2669b886254da24b77bc14","modified":1492343969543},{"_id":"themes/maupassant/layout/_partial/totop.jade","hash":"1d3be547f3e7f7c154f4cc35c87b4ae0a49a9132","modified":1503824839000},{"_id":"themes/maupassant/layout/_widget/github-card.jade","hash":"3cefc441c22fe476ca817adc9700b9aaa346d943","modified":1492343969543},{"_id":"themes/maupassant/layout/_widget/links.jade","hash":"f57a0c76d243882b2b77330132bdb43bc648948b","modified":1492343969543},{"_id":"themes/maupassant/layout/_widget/recent_comments.jade","hash":"e119c5afa85abc60d139e2da99b0bfcd7a6530f8","modified":1492343969543},{"_id":"themes/maupassant/layout/_widget/recent_posts.jade","hash":"19431336d724d2118e46da43683bce9063176541","modified":1492343969543},{"_id":"themes/maupassant/layout/_widget/search.jade","hash":"193546282908e499813534f86d27ef6e0a1357b3","modified":1492343969543},{"_id":"themes/maupassant/layout/_widget/tag.jade","hash":"132f049ce677d0e38f50073174c4ee4b825d4a06","modified":1492343969543},{"_id":"source/_drafts/gc-basic/g1.jpg","hash":"751479804ac2ac64cb9674e74938e9d8a726c318","modified":1513521777871},{"_id":"source/_posts/HttpMessageConverter/DispatcherServlet-properties.jpg","hash":"2dd94eb25a05e8dd5a8bc0f8fc2eb05ebd73f89c","modified":1492343969539},{"_id":"source/_posts/HttpMessageConverter/arch.jpg","hash":"57bcfe2eac52149a1964cc576ba50409d4861c2c","modified":1492343969539},{"_id":"source/_posts/HttpMessageConverter/http-message-converter.jpg","hash":"fb06cf8a039b6d402ddb4cba11abb408caaa58fd","modified":1492343969539},{"_id":"source/_posts/git-branch-log/glgg.png","hash":"a4eec11f852e7ad1246ab7141c519929186b407e","modified":1505147140556},{"_id":"source/_posts/google-perf-tools/2017年 09月 05日 星期二 01:34:24 CST.png","hash":"5a3efb1e3e32ebc79c5508d280205cc8cc4d6952","modified":1512213878265},{"_id":"source/_posts/jinfo/jinfo.png","hash":"99dbf8d6abc2d344f9a4adc70ec02e515040104c","modified":1511708534390},{"_id":"source/_posts/postgre/arch.jpg","hash":"53839b9675327b7b18c652c1bf568b903017145e","modified":1492343969543},{"_id":"source/_posts/property-placeholder/post-processors.jpg","hash":"db5b21a4d6ace84afb24d14b158833558a5ad809","modified":1492343969543},{"_id":"source/_posts/spi/usage.jpg","hash":"ccda980477add78ccf794d40482fbf65cd880de1","modified":1492343969543},{"_id":"source/_posts/spring-mvc/arch.jpg","hash":"57bcfe2eac52149a1964cc576ba50409d4861c2c","modified":1492343969543},{"_id":"themes/maupassant/source/js/kity.min.js","hash":"14fbc0cea315e4af3e8a2c320049797f1b5559bf","modified":1447324463000},{"_id":"themes/maupassant/layout/_widget/uv.jade","hash":"8bd4b71792e4d7f662156074d374064d43df93d3","modified":1492343969543},{"_id":"source/_posts/dubbo-generic-invoke/generic.png","hash":"b553e8919f420ba2abbea311210fb8baf74c606b","modified":1525265444196},{"_id":"source/_posts/go-figure/go-tour.png","hash":"6593714185586bb1c2d4758a705964bff988babe","modified":1516455753247},{"_id":"source/_posts/how-to-delete-file-correctly/deleted.png","hash":"5d1e3fcbb74a3f937a24e6619ca5ec32a64808e8","modified":1505017209262},{"_id":"source/_posts/jackson-guava/jar.png","hash":"0067332eb536099b9f5efc79e466e3302867d714","modified":1492343969543},{"_id":"source/_posts/top/highlight.png","hash":"274ba49e46d1d5ee0a953ef63b1eb7ceebe48bed","modified":1504949478962},{"_id":"source/_posts/cache-system-time/time-cache.jpg","hash":"cd1f28e4533046bfac692883482ed541b539bf6d","modified":1512224191052},{"_id":"source/_posts/git-branch-log/idea.png","hash":"f96a5f5e98b383af80381996ada0b6465d7e5b4a","modified":1505147140556},{"_id":"source/_posts/top/fields.png","hash":"604b40c3362118bdc0a2437e716fbb53c47efa39","modified":1504949478962},{"_id":"source/_posts/top/highlight-sort.png","hash":"39be3abb0e5970179bf902bbbc55bf5853ef0289","modified":1504949478962},{"_id":"source/_posts/top/top-thread","hash":"64437f1ce3f0edaf281def420933c31da883527f","modified":1504949478962},{"_id":"source/_drafts/gc-cms/cms.jpg","hash":"53197087e4f1fed4efbe9abfa8b56d4b252edb35","modified":1492343969539},{"_id":"source/_posts/git-branch-log/idea-sorted.png","hash":"6471bd3d7b867ce4fd5664773f9c3c90043a826c","modified":1505147140556},{"_id":"source/_posts/markdown-mindmap/relations.png","hash":"7379ebbf18fca6e27dce47ea16721912d561046b","modified":1492343969543},{"_id":"source/_posts/pagination/PPC2009_mysql_pagination.pdf","hash":"606f57614083e01b5dc97653b2b699a91e92ee31","modified":1492343969543},{"_id":"source/_posts/top/cpu.png","hash":"a1f9bb18acbf4c217f756fbf107a05407597a826","modified":1504949478962},{"_id":"source/_posts/top/top-a.png","hash":"96dea599a6c6bcd4395a27f326ac4bbbf564c579","modified":1504949478962},{"_id":"themes/maupassant/source/js/kityminder.core.js","hash":"51bb5a5ff5c974d32ace877c1c3488bb6fd44f8c","modified":1503823211645},{"_id":"source/_posts/spring-mvc-2/springmvc.log","hash":"f3c8f8c0b59eaa639b30491186d88b3c2b7b9151","modified":1525598208737},{"_id":"themes/maupassant/source/image/bg2.jpg","hash":"e0770c4d68b777201bb383cbb88d593b2fa0826c","modified":1504950930623},{"_id":"source/_posts/electron/mojibar.gif","hash":"fa820683a7edca375eae47d41edda465d535dc64","modified":1505031353128},{"_id":"public/baidusitemap.xml","hash":"1b3617dbb4c4e87754a428510ca94f4cb102d67e","modified":1525598221498},{"_id":"public/atom.xml","hash":"f3ba8faf8ccc591e4f826810d7f97b61c66c8377","modified":1525598221499},{"_id":"public/search.xml","hash":"6004a106b6891299b76202ad44e5ce889bf61de1","modified":1525598221548},{"_id":"public/sitemap.xml","hash":"82765e6ca587aa9e903911373ffa9ec621dd5444","modified":1525598221548},{"_id":"public/robots.txt","hash":"9cff661887cd0b45c9cb599aae136a168cdf2430","modified":1525598224799},{"_id":"public/about/index.html","hash":"8c236bd2c7c50b939723dd26ac32d74e2705c388","modified":1525598224799},{"_id":"public/recommendation/index.html","hash":"4adeb0a843f27e680416cc442578d822dffbb82c","modified":1525598224837},{"_id":"public/tags/index.html","hash":"76d2dcaec90bc9b591ebed2b1572e32657ee34ba","modified":1525598224837},{"_id":"public/2018/03/15/hexo-ubuntu/index.html","hash":"782d5774af067147eaec469bf1ae11f801902488","modified":1525598224837},{"_id":"public/2017/09/12/git-checkout/index.html","hash":"58e8a037d3fe7e4b613ce6a9ee38b04b4c8285e5","modified":1525598224837},{"_id":"public/2017/06/03/jvm-flag/index.html","hash":"beee6354013a372c3e99b8e64a87bc8ffbd95b34","modified":1525598224837},{"_id":"public/2016/09/25/spring-mockMvc/index.html","hash":"bc8f08b7df44ae84913587389b9353c77b948904","modified":1525598224837},{"_id":"public/2018/05/02/dubbo-generic-invoke/index.html","hash":"bf6ff2b19a6381bbde9671fe292c86fa40ebd142","modified":1525598224837},{"_id":"public/2018/04/02/greys-start/index.html","hash":"0e37c6fd2a6f7ae76d0c3337cc32a52bdd5a6234","modified":1525598224837},{"_id":"public/2018/01/20/go-figure/index.html","hash":"78291efc59ba49b0d382104f3c15ca2f01ee7804","modified":1525598224837},{"_id":"public/2017/12/02/cache-system-time/index.html","hash":"3e932b28dfab7f063abad66a3fca55de19e9241e","modified":1525598224837},{"_id":"public/2017/12/02/google-perf-tools/index.html","hash":"ab3680a4f927390c4bb092e82efaee62e9cc10d8","modified":1525598224837},{"_id":"public/2017/11/26/jinfo/index.html","hash":"a11a3ec1e9cc2b756e13a62e88f81fe9a79c8580","modified":1525598224837},{"_id":"public/2018/03/15/web-xml/index.html","hash":"5e4d1ab1aa414ecf71121cec930ee1f9534c49fe","modified":1525598224838},{"_id":"public/2018/05/05/slf4j-bridge/index.html","hash":"26fd2a571a0d9026973d1b69159423587d55055d","modified":1525598224838},{"_id":"public/2017/12/03/jvm-omit-fast-throw/index.html","hash":"d656e182ec8aed46f503ba6a2a31cb79fcd8e7b6","modified":1525598224838},{"_id":"public/2017/11/19/executor/index.html","hash":"a3cdbc151b8a187e08e1447fc378d226011532cb","modified":1525598224838},{"_id":"public/2017/11/18/ThreadFactoryBuilder/index.html","hash":"f919bf9cc0e111fd4d316d6adc036272dbc9d5af","modified":1525598224838},{"_id":"public/2017/11/12/MAT-Ubuntu/index.html","hash":"477896bc7ca8c74d12ec700ccae2cf188b7b218a","modified":1525598224838},{"_id":"public/2017/09/12/git-branch-log/index.html","hash":"7b1415e19a145eaec2738b2f44735bece6b7c2ba","modified":1525598224838},{"_id":"public/2017/09/10/electron/index.html","hash":"3ad1a0a325c37162fa237140c43a1ce6671a6915","modified":1525598224838},{"_id":"public/2017/11/12/greys/index.html","hash":"86c303cdb15ee192c70f938f38111179898ab8a8","modified":1525598224838},{"_id":"public/2017/09/10/how-to-delete-file-correctly/index.html","hash":"052797851389394e51ae8f8317721cf49c1a662e","modified":1525598224838},{"_id":"public/2017/09/09/top/index.html","hash":"83a585f5c1a0ef418bcaf4970b0b7d07f25ea7b7","modified":1525598224838},{"_id":"public/2017/04/05/tomcat-connection/index.html","hash":"d1feefc3fec35b8f7528639bf16d5115b3e4c1b0","modified":1525598224838},{"_id":"public/2017/11/04/java8-file-stream/index.html","hash":"948a88318ed2232cf0616a95c69a9aac41175b67","modified":1525598224838},{"_id":"public/2017/02/28/servlet-async/index.html","hash":"104f12b8a45decd0524aecbe4544584396fb91e4","modified":1525598224838},{"_id":"public/2017/02/15/idea-scratches/index.html","hash":"8bc12eb54d27e56560a11396bfe3d1d12eb3506e","modified":1525598224839},{"_id":"public/2017/06/01/maven-scope/index.html","hash":"69a1077dd7dd67dace77871b953dd94d3a7ec8ff","modified":1525598224839},{"_id":"public/2017/02/20/cygwin-360/index.html","hash":"706d736a0ecb72a6b8647e13cc97eec554b9999b","modified":1525598224839},{"_id":"public/2017/02/14/factorybean/index.html","hash":"906041ca0e4f49e006dc1150505d21faafe997d7","modified":1525598224839},{"_id":"public/2017/02/06/shell-input-limit/index.html","hash":"92d6e27e831cb126747cbbb8486c8bbb42f6ce05","modified":1525598224839},{"_id":"public/2017/02/06/tomcat-stringmanager/index.html","hash":"3a16744a135c04389b4dafeb4ac1d8fe5a70c035","modified":1525598224839},{"_id":"public/2017/01/27/tomcat-AbstractMethodError/index.html","hash":"0325e71d62a296e85913f080e3891ebdec47c065","modified":1525598224839},{"_id":"public/2017/01/27/jar/index.html","hash":"4801dd65d7bdb0147788a24ff82fa0f888608ee2","modified":1525598224839},{"_id":"public/2017/01/09/Spring-mvc-exception/index.html","hash":"f8b2bbddf809739c95f8ba9e3ded0e1ec7d503aa","modified":1525598224839},{"_id":"public/2017/01/02/markdown-here/index.html","hash":"3ebb7517ab4ffed16cf5bb61f099697a268b416a","modified":1525598224839},{"_id":"public/2017/01/01/markdown-mindmap/index.html","hash":"6c609c5604674dddc186b44cd0861e740f1c1dd9","modified":1525598224839},{"_id":"public/2017/01/08/pip/index.html","hash":"2ee314df8a36a4634c86ed9eeaae08e0cb32ef76","modified":1525598224839},{"_id":"public/2016/12/23/idea-template/index.html","hash":"9884576584731f2e58202fb83afd2bbbb409d451","modified":1525598224839},{"_id":"public/2017/01/17/guava-eventbus/index.html","hash":"765c3ff84d343c1f44bb4a9333e966a79b4db1da","modified":1525598224839},{"_id":"public/2017/01/07/CLIP/index.html","hash":"dd8fb0fe801e8322028370f20f132192612322f5","modified":1525598224839},{"_id":"public/2016/12/23/tomcat-encoding/index.html","hash":"bd7a1ee154d67f34196b4fba8dd8d11fcc4af7c9","modified":1525598224839},{"_id":"public/2016/12/27/xstream/index.html","hash":"db528fb21e03cc0581f0d5b1436547ea2c83fab2","modified":1525598224840},{"_id":"public/2016/12/17/spi/index.html","hash":"93eb6395bec83f869e95dceb53c239ca12f1e339","modified":1525598224840},{"_id":"public/2016/12/23/tomcat-access-log/index.html","hash":"09233d81a1d32e8c55acc5281f9729f87a1a01ac","modified":1525598224840},{"_id":"public/2016/12/14/re/index.html","hash":"a22a89d03c8a6ca5c02c542eb5552e8d7ac1de43","modified":1525598224840},{"_id":"public/2016/12/07/grep/index.html","hash":"13c32f33328c7837bad89afa6231b82ffacc86c9","modified":1525598224840},{"_id":"public/2016/11/29/HttpMessageConverter/index.html","hash":"1ccc286ecefb49d0c26515d55d6da74c03f659f3","modified":1525598224840},{"_id":"public/2016/11/20/spring-resource/index.html","hash":"263c4589169278444f56c5a00bf5c839055b92c2","modified":1525598224840},{"_id":"public/2016/11/16/jackson-guava/index.html","hash":"b881d68a915ae847806ac35961cf1c1ff079948f","modified":1525598224840},{"_id":"public/2016/10/31/property-placeholder/index.html","hash":"4f5575833bbbade31da9664046dc38c8090a29c1","modified":1525598224840},{"_id":"public/2016/12/18/nc/index.html","hash":"3715dc4d899124621f8a2bf4a495e9940bc35b39","modified":1525598224840},{"_id":"public/2016/12/18/python-util/index.html","hash":"025a56ae6265f2eb1925dfbd6a7a3d95c4ea8532","modified":1525598224840},{"_id":"public/2016/12/13/atnode/index.html","hash":"6a070f6782b97beccef1b1ba881403b8898226b7","modified":1525598224840},{"_id":"public/2016/10/02/spring-mvc/index.html","hash":"7ff70b3b268a93b28b7a46553d0da945ddec383f","modified":1525598224840},{"_id":"public/2016/10/02/jsonp/index.html","hash":"ecf7fa68d2291ca2c4576b921f4089e905e4a846","modified":1525598224840},{"_id":"public/2016/09/30/pagination/index.html","hash":"708a1360bab73c46529c6a5c31ab9bde272c791e","modified":1525598224840},{"_id":"public/2016/09/27/postgre/index.html","hash":"88f0e4b029dab9269e9585d5cfa5bd6cad271d53","modified":1525598224841},{"_id":"public/2016/09/26/character-encoding/index.html","hash":"98c68870995b61028320bf6bd57d090803a4282c","modified":1525598224841},{"_id":"public/2016/09/26/base64/index.html","hash":"435eb52fb4b481565cb337d18d70ff4bf2aef202","modified":1525598224841},{"_id":"public/2016/10/23/custom-tag/index.html","hash":"0c68ae16b262525767269398766c26213675e25b","modified":1525598224841},{"_id":"public/2016/10/16/plantuml/index.html","hash":"e36234e68bff5a28e1e45c622c0a4386dffad759","modified":1525598224841},{"_id":"public/2016/10/05/javadoc/index.html","hash":"0840aafdfbfa6db5c47dbb3c21047ce274b076dd","modified":1525598224841},{"_id":"public/2016/09/25/java-exception/index.html","hash":"3ee2ae34d54ec51852f15d227ee8fa5fe89754fe","modified":1525598224841},{"_id":"public/2016/09/25/mysql-time/index.html","hash":"76a8842af04087c89efbc5a869502425a275c4c7","modified":1525598224841},{"_id":"public/2015/11/03/fabric/index.html","hash":"6c8ab53b6b3195f1b8681a6324d0d0cf2b26c578","modified":1525598224841},{"_id":"public/2015/11/03/machine_learning/index.html","hash":"7668f83cbf3f8fa0c4154898d9f007395c1e4213","modified":1525598224841},{"_id":"public/2015/10/09/shadowsocks/index.html","hash":"bbdc183cfcb4f4cc3e58fe39d2b420536d6ff24a","modified":1525598224841},{"_id":"public/2015/10/20/java-permission-control/index.html","hash":"b6a1c14775361c30bfd5a77925c3314339818248","modified":1525598224841},{"_id":"public/archives/index.html","hash":"13188f70ea9a8a5afdc5bcb878c376e89fa86be4","modified":1525598224863},{"_id":"public/archives/page/2/index.html","hash":"54ea7b9be15d7b3190a51e6f0742f97f9a77ae01","modified":1525598224863},{"_id":"public/archives/page/3/index.html","hash":"97cf3f4bf5518c6260436bacb16b91e9f364a1be","modified":1525598224863},{"_id":"public/archives/page/4/index.html","hash":"d02de5987195086b3c0085db821cb99cc71681ed","modified":1525598224863},{"_id":"public/archives/page/5/index.html","hash":"54456e17a1587795447312418a9824ace85f7f5e","modified":1525598224863},{"_id":"public/archives/page/6/index.html","hash":"a1bae9f43e5ecefbf830d070e54391f7446f1100","modified":1525598224863},{"_id":"public/archives/page/7/index.html","hash":"122d41c733662adbbf443d2948d08adc626df258","modified":1525598224863},{"_id":"public/archives/page/8/index.html","hash":"e49d9129c6680cafcecae0302964b2f6b2d5c95c","modified":1525598224863},{"_id":"public/archives/page/9/index.html","hash":"2060b9cd44effe73ae938ab6b6e590a1b7cd50b9","modified":1525598224864},{"_id":"public/archives/page/10/index.html","hash":"db786ec052835b4e466b7fe220737ef6b61b6976","modified":1525598224864},{"_id":"public/archives/2015/index.html","hash":"04a6b127ea8770918f35d05dbdfea1ba736fbc40","modified":1525598224864},{"_id":"public/archives/2016/index.html","hash":"4500d93af66f62a0950c14d91cf5201d4f4c7223","modified":1525598224864},{"_id":"public/archives/2015/10/index.html","hash":"8217e72b5a1b9df07bf5911d329dd2f4ad0cf685","modified":1525598224864},{"_id":"public/archives/2015/11/index.html","hash":"1cda48943a6729987ec808e022fb1fe8d4a94580","modified":1525598224864},{"_id":"public/archives/2016/09/index.html","hash":"cba90909720eebc6c5185f6629cdfbda2e85948f","modified":1525598224864},{"_id":"public/archives/2016/page/2/index.html","hash":"7f5c135bcfd0ff49f154cf793538ddf37fc4ab6a","modified":1525598224864},{"_id":"public/archives/2016/page/3/index.html","hash":"b7fbdc5408644f3e18c58acb035fce840935df58","modified":1525598224864},{"_id":"public/archives/2016/page/4/index.html","hash":"5c973f2cdd719a5ef695ef68066f800a770d6682","modified":1525598224864},{"_id":"public/archives/2016/10/index.html","hash":"83cdf1bfb78a1c923b51768e4aded347fbfc9954","modified":1525598224864},{"_id":"public/archives/2016/11/index.html","hash":"13638493cbdeb6eae1c2f63ce2a1e69932cb4552","modified":1525598224864},{"_id":"public/archives/2016/12/index.html","hash":"6848b8983e126b03cba25493ee2751ec861ff946","modified":1525598224864},{"_id":"public/archives/2017/index.html","hash":"d9ea02e2e67be31029e3f0d6b5eea269db103850","modified":1525598224864},{"_id":"public/archives/2016/12/page/2/index.html","hash":"85a9a6ec399c3ce2a420929b7c26192498255d6e","modified":1525598224864},{"_id":"public/archives/2017/page/4/index.html","hash":"4f67f0617e5f99b9d55a23680cb6fcf2be2183ed","modified":1525598224864},{"_id":"public/archives/2017/page/2/index.html","hash":"a65f802d8e731dee25775c18e92339ec2049da1f","modified":1525598224864},{"_id":"public/archives/2017/page/3/index.html","hash":"a5c2501e360e7194bbcec49d7c48c41b0ad8e610","modified":1525598224864},{"_id":"public/archives/2017/page/5/index.html","hash":"56b26ae5a5122e1aec2868d527c9e4ad5f8fcbd4","modified":1525598224864},{"_id":"public/archives/2017/01/index.html","hash":"d03bc0deae6084d1381ccd778f74816dc76d1df7","modified":1525598224865},{"_id":"public/archives/2017/02/index.html","hash":"12a316f2cfe94c5cd79b9fb8f5bc4f888f585925","modified":1525598224865},{"_id":"public/archives/2017/04/index.html","hash":"3b92c70080ddbb146042b1a73b0b29390fc52bbf","modified":1525598224865},{"_id":"public/archives/2017/06/index.html","hash":"e300161f2c42aafce041f988a7745105b47ba30c","modified":1525598224865},{"_id":"public/archives/2017/09/index.html","hash":"474cd1fcef033be8a3a2a2d40443fc83d8ae6d65","modified":1525598224865},{"_id":"public/archives/2017/11/index.html","hash":"4f112c4682982d0a48d5d84923ad917c5e7a1639","modified":1525598224865},{"_id":"public/archives/2017/01/page/2/index.html","hash":"e5e4432a812fc05fd83cb0b081e7abbe20404322","modified":1525598224865},{"_id":"public/archives/2017/12/index.html","hash":"6dcda98eaa4000ff4d2a803d7a455e7ae1a4c96e","modified":1525598224865},{"_id":"public/archives/2018/index.html","hash":"1528530e08c761c8250b51404a3e74b2bf7c8140","modified":1525598224865},{"_id":"public/archives/2018/01/index.html","hash":"11e75f6fcfddc398ed12e690bd4768bf6af935c7","modified":1525598224865},{"_id":"public/archives/2018/05/index.html","hash":"0b4f9c07d8cbc3fd8f8c2784b46f1f506c453172","modified":1525598224865},{"_id":"public/archives/2018/04/index.html","hash":"93d6e2c7d7882dfc7c1f1ecc5242c1f081001545","modified":1525598224865},{"_id":"public/categories/linux/index.html","hash":"128f0e66f2bc20d6d100765119ccb4db252cebdf","modified":1525598224865},{"_id":"public/categories/java/index.html","hash":"5b365a504b1cd42444580a25f6310d5fea0a3ca6","modified":1525598224865},{"_id":"public/archives/2018/03/index.html","hash":"7339b56dddba63b5d8c7ad5d7a02d0eb335ca40b","modified":1525598224865},{"_id":"public/categories/spring/index.html","hash":"357ca8ba616982b81dd75a45ad461f9b0146830d","modified":1525598224865},{"_id":"public/categories/shell/index.html","hash":"7cb686c0ebd78efa51faf52f22c51b1aeb0e53a7","modified":1525598224865},{"_id":"public/categories/dubbo/index.html","hash":"66377af1ab78bd51bf2863c945f98207c4756dbc","modified":1525598224865},{"_id":"public/categories/java/page/2/index.html","hash":"b65d38dfe5be7de18900eae1d73aee104615e74d","modified":1525598224865},{"_id":"public/categories/fe/index.html","hash":"f2a328b9282ede35acd62fb1a74af074c10803da","modified":1525598224866},{"_id":"public/categories/guava/index.html","hash":"9486655865e3251bd87f0670fc0351fb41994b8c","modified":1525598224866},{"_id":"public/categories/spring/page/2/index.html","hash":"05914fe15b161232f1f8adec485bb72c85e7a8ac","modified":1525598224866},{"_id":"public/categories/tomcat/index.html","hash":"fcc77b1ff48139c065355b95ec40db9f29674f20","modified":1525598224866},{"_id":"public/categories/base/index.html","hash":"8faccf648fe5ca75237004afa5aa626d4a2ad192","modified":1525598224866},{"_id":"public/categories/python/index.html","hash":"979c52f0ae34002d9d9497194363afeb886d06e4","modified":1525598224866},{"_id":"public/categories/git/index.html","hash":"2f6c4372df2c72a5f8cb14406bb1b56618668cb6","modified":1525598224866},{"_id":"public/categories/go/index.html","hash":"db534b320ea8a65255859589b93be34f41d85d10","modified":1525598224866},{"_id":"public/categories/perf/index.html","hash":"1bdadb0f15d0cd171c604489f91f21b07867d261","modified":1525598224866},{"_id":"public/categories/hexo/index.html","hash":"25c3d7aa65993f18f4beb5913b13c5bfad2fdd54","modified":1525598224866},{"_id":"public/categories/idea/index.html","hash":"da522b139081a95bcf982e7f57318712611e9921","modified":1525598224866},{"_id":"public/categories/markdown/index.html","hash":"871e6227b4116ca7d6f56fc365c079e97301ca99","modified":1525598224866},{"_id":"public/categories/机器学习/index.html","hash":"be5e1a120505c8ada11beb5da7fc9e030bfc6476","modified":1525598224866},{"_id":"public/tags/xml/index.html","hash":"28cb9f5227f8b60b52cd12618e4e093d96df6b50","modified":1525598224866},{"_id":"public/tags/jackson/index.html","hash":"96b8df68f80bf10662143b941bc63986644965d8","modified":1525598224866},{"_id":"public/tags/logback/index.html","hash":"2e8a7be3a532c56668267eeaad3dc138636186d3","modified":1525598224866},{"_id":"public/tags/maven/index.html","hash":"41a5117f3cb354d05707b0da4720587efe33d266","modified":1525598224866},{"_id":"public/tags/ssh/index.html","hash":"eddca4da9851e80fa7fd64a0d29bfb2ec1cab038","modified":1525598224866},{"_id":"public/tags/剪贴板/index.html","hash":"e08ee586e196661f079e348e85e7aa8f4c84e25b","modified":1525598224866},{"_id":"public/tags/mat/index.html","hash":"c7527d5c1da4ad83f1fa0ec963829ca0a96ec312","modified":1525598224866},{"_id":"public/tags/messageConverter/index.html","hash":"1c12ba19d6870bed19b9a6be41d0f6a810e14745","modified":1525598224867},{"_id":"public/tags/concurrent/index.html","hash":"8f169e1a2a2519111632dc3370f39ee1743d2638","modified":1525598224867},{"_id":"public/tags/exception/index.html","hash":"d6a3c3a6d11e3f5a4e20918b4332ab8ebf9606db","modified":1525598224867},{"_id":"public/tags/编码/index.html","hash":"1ed021b6f659fb842a4729145450f48e4175db1c","modified":1525598224867},{"_id":"public/tags/cache/index.html","hash":"f656abe167540bf97610c2d222c4837129c027a3","modified":1525598224867},{"_id":"public/tags/自定义标签/index.html","hash":"ca817211fd79b0ed557352c3f027c5b0667853a4","modified":1525598224867},{"_id":"public/tags/cygwin/index.html","hash":"7acaa150985bc381b68cc0e5d18162d948b7f2bd","modified":1525598224867},{"_id":"public/tags/electron/index.html","hash":"fc2f5cb9482d1c27c037b372e2c9bc94606e8169","modified":1525598224867},{"_id":"public/tags/fabric/index.html","hash":"11abee5c8331cdcc17eec1d415a5d6259fef8776","modified":1525598224867},{"_id":"public/tags/executor/index.html","hash":"72df4201a752acb55785aaf5f396ea709da51740","modified":1525598224867},{"_id":"public/tags/git/index.html","hash":"2f6c4372df2c72a5f8cb14406bb1b56618668cb6","modified":1525598224867},{"_id":"public/tags/idea/index.html","hash":"00d3a1c52707f27e4ebf497363309a979a090df7","modified":1525598224867},{"_id":"public/tags/generic/index.html","hash":"9e1570b4e0cfd93b9feeceac082fa2002115492b","modified":1525598224867},{"_id":"public/tags/go学习资料/index.html","hash":"a8068a0f40b6582e6c71b65aef8af428ed3df579","modified":1525598224867},{"_id":"public/tags/beanfactory/index.html","hash":"b86191290e55513b509bbcefb483c60de7b13390","modified":1525598224867},{"_id":"public/tags/google-perf/index.html","hash":"65f8f7d24ddc280c35404d0fc47b90c4d7444070","modified":1525598224867},{"_id":"public/tags/greys/index.html","hash":"a45da3f6642b61961f054ea67b553760cc0ce6a0","modified":1525598224867},{"_id":"public/tags/hexo/index.html","hash":"97bbf4d7154b475487f4c9842513678b41f3389a","modified":1525598224867},{"_id":"public/tags/event-bus/index.html","hash":"0de9594da15667faa839a353b2a48ec9462d8399","modified":1525598224868},{"_id":"public/tags/lsof/index.html","hash":"1bc68d17019628a5e7fbf8451fdfcda5c5b44e0e","modified":1525598224868},{"_id":"public/tags/hexo-install/index.html","hash":"e4a43c26eb12f0e49e6fbcdf260509229fab8f53","modified":1525598224868},{"_id":"public/tags/template/index.html","hash":"d4c4736723b3803f1947d0633508d4c4a6f2070c","modified":1525598224868},{"_id":"public/tags/jar/index.html","hash":"88669b863ba2d18cbe38ee1d3da3391422605b00","modified":1525598224868},{"_id":"public/tags/访问权限/index.html","hash":"df6aa9645c3d2867a0f1d0fbce92e565398fd8ee","modified":1525598224868},{"_id":"public/tags/Javadoc/index.html","hash":"1feeac5f7b6753876e1454d193f06a254963a906","modified":1525598224868},{"_id":"public/tags/java/index.html","hash":"5dbc0d174d7c9ab485c9a7a253d96510a72f6278","modified":1525598224868},{"_id":"public/tags/jinfo/index.html","hash":"ac9ffceb44c5524ffd691c2320abb61b0c0f970f","modified":1525598224868},{"_id":"public/tags/ajax/index.html","hash":"12b5ec02b6f3318b4a73e0e6cd49f390e8481e18","modified":1525598224868},{"_id":"public/tags/tomcat/index.html","hash":"2f4e0590df05612a0811d35f81eb62a5983e1fc9","modified":1525598224868},{"_id":"public/tags/markdown-here/index.html","hash":"d4c5ff807ea26071cf7163378a87cf22c9790749","modified":1525598224868},{"_id":"public/tags/mysql/index.html","hash":"323d84767f4acb7964221cc8dcbf56d6d0dc79fa","modified":1525598224868},{"_id":"public/tags/机器学习/index.html","hash":"be5e1a120505c8ada11beb5da7fc9e030bfc6476","modified":1525598224868},{"_id":"public/tags/mindmap/index.html","hash":"44bfcf85e28bf78f49ede3d4dfad666ade071e74","modified":1525598224868},{"_id":"public/tags/netcat/index.html","hash":"5fa1157fd141fe7fe168dce53291937e71c7b263","modified":1525598224868},{"_id":"public/tags/pip/index.html","hash":"1b9e847f3b61210e3b8d13256dfb99dd580615ca","modified":1525598224868},{"_id":"public/tags/python-util/index.html","hash":"5fafa4e7922c8edc8de14dc5885a95d8c1c674b1","modified":1525598224868},{"_id":"public/tags/postgresql/index.html","hash":"0986133500d3fa1c10c612ca1c86fb92acef022d","modified":1525598224868},{"_id":"public/tags/re/index.html","hash":"fe0ab92e57f2dfd3701040f0df648ba4ec2c1bf1","modified":1525598224869},{"_id":"public/tags/servlet/index.html","hash":"f041692dff72a4a15cd690937bf99e2af5749421","modified":1525598224869},{"_id":"public/tags/shadowsocks/index.html","hash":"7fef446f533da7a81aa23a4fc41de7e85af69b4c","modified":1525598224869},{"_id":"public/tags/limit/index.html","hash":"c5cbd5a6566df0918bb38046ebff4669b8b88973","modified":1525598224869},{"_id":"public/tags/placeholder/index.html","hash":"d16ddb04ba1f6b46e14896ad2637d83ae3d10ec8","modified":1525598224869},{"_id":"public/tags/spi/index.html","hash":"17d7b62372e74aeb1c730aabd7ba80f74154cb26","modified":1525598224869},{"_id":"public/tags/spring-mvc/index.html","hash":"4c6ae590582b44a3f78b22098b1f137d281cf9c6","modified":1525598224869},{"_id":"public/tags/resource/index.html","hash":"4d1e5679cd994d7bf772fe80315bd262a91508cb","modified":1525598224869},{"_id":"public/tags/access-log/index.html","hash":"8dab6638a8c616b938de3de20fabaabc0a59bfc8","modified":1525598224869},{"_id":"public/tags/encoding/index.html","hash":"a657d2fe1f90dc99757d66008d39409d101590c0","modified":1525598224869},{"_id":"public/tags/connections/index.html","hash":"4226ea50fcb45aead97c711cb8b7aab9f2b23d60","modified":1525598224869},{"_id":"public/tags/string-manager/index.html","hash":"e9ead54030d5e964b9ee49935ecf14fd3f7a9898","modified":1525598224869},{"_id":"public/tags/top/index.html","hash":"2b5ce90e4a082e247c496b7e169e9ef21e3b985a","modified":1525598224869},{"_id":"public/tags/uml/index.html","hash":"efd37a0f9f7181f8fdfe581e5838c100fd6d0834","modified":1525598224869},{"_id":"public/2018/05/06/spring-mvc-2/index.html","hash":"0d1ca560696c57c5081c57fd6314c85f5c1b1c88","modified":1525598224869},{"_id":"public/2015/10/08/ssh-passwd-free/index.html","hash":"be6dcfdc84c9c19bc31523fa7fb1e626617b3e61","modified":1525598224869},{"_id":"public/2015/10/08/hello-world/index.html","hash":"7779741c6af1a4efbb683f64f6536d0d0a83621a","modified":1525598224869},{"_id":"public/index.html","hash":"8b4a69f33fe140de622578dd37bace111dd06b0a","modified":1525598224869},{"_id":"public/page/2/index.html","hash":"7334edd3f499b426e847a1b5b415aab424c6ed55","modified":1525598224869},{"_id":"public/page/3/index.html","hash":"e0b08fbf5f44d01843b0c08557feb551adc3db45","modified":1525598224870},{"_id":"public/page/5/index.html","hash":"7737103bf6201a2cb6fae2354cbaef6c389afe6c","modified":1525598224870},{"_id":"public/page/4/index.html","hash":"66ea62398d251bb587a9ef53e4fbcfde39efa80d","modified":1525598224870},{"_id":"public/page/6/index.html","hash":"a0d64982ab3061b4ae0bfe7c0c618c204d622da6","modified":1525598224870},{"_id":"public/page/7/index.html","hash":"d2c59cf48f43f362fc0dffb63dbfed6a00f4e783","modified":1525598224870},{"_id":"public/page/8/index.html","hash":"90cfaceafd684b88d386525bbc0b894273ebc442","modified":1525598224870},{"_id":"public/page/9/index.html","hash":"f919ce4515c35043efc74338e104d1f4abf8b1aa","modified":1525598224870},{"_id":"public/page/10/index.html","hash":"e45b8f2fe55c25eecdac2d0daddf1a5a27c353a1","modified":1525598224870},{"_id":"public/.well-known/acme-challenge","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1525598224870},{"_id":"public/about/me.jpg","hash":"231a9ce95dd1e61033737bd5ed5631f1607590bb","modified":1525598224936},{"_id":"public/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1525598224937},{"_id":"public/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1525598224937},{"_id":"public/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1525598224937},{"_id":"public/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1525598224937},{"_id":"public/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1525598224937},{"_id":"public/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1525598224937},{"_id":"public/image/bg.jpg","hash":"fda749c7beb5c456da00b095018bf0074a074e3a","modified":1525598224937},{"_id":"public/2016/12/23/idea-template/profiles.jpg","hash":"cc82791405ece2982b41af9f5eebd9ebf2009708","modified":1525598224937},{"_id":"public/2018/04/02/greys-start/attach.jpg","hash":"6a17fef50ef8ad023941bdbce82dedd79b03910e","modified":1525598224937},{"_id":"public/2016/11/20/spring-resource/resource.jpg","hash":"f45bcaa3dd495300355ff09830a1500c36c71870","modified":1525598224937},{"_id":"public/2018/03/15/gc-basic/gc.jpg","hash":"a3ab3f2011985157de2799d9be00505a1a78eab2","modified":1525598224937},{"_id":"public/2018/03/15/http/10-21-http-request.png","hash":"7139d7e857c470ffbd789f0de3a166825685c988","modified":1525598224937},{"_id":"public/2018/03/15/http/http_request_message.png","hash":"c7714d5d9acedc28c3ca56d804a2fa243ad67388","modified":1525598224937},{"_id":"public/2017/04/05/tomcat-connection/tomcat-interaction.jpg","hash":"753988a71e259935859a9f7e717c12fc61dfbc19","modified":1525598224938},{"_id":"public/2016/09/26/base64/encoding.jpg","hash":"5ed8de255bfe78f23b7cc920171655a4487a509b","modified":1525598224938},{"_id":"public/2016/09/26/base64/encoding2.jpg","hash":"da197012f219ae5c3cacf049e0d15e9c9693c981","modified":1525598224938},{"_id":"public/2016/12/07/grep/color.jpg","hash":"9b1ae87a35402005befa583795e231ccc49dca29","modified":1525598224938},{"_id":"public/2016/12/07/grep/egrep.jpg","hash":"d13cb7333887eb76541f6ffb9a294c1d9404942e","modified":1525598224938},{"_id":"public/2017/01/02/markdown-here/mail.jpg","hash":"a89f7167ca6b1fe12b2e949f7290f26e273edebf","modified":1525598224938},{"_id":"public/2017/01/01/markdown-mindmap/sample.jpg","hash":"ebbde815a587d2a0a38ecada7ba9d54723905484","modified":1525598224938},{"_id":"public/2017/01/02/markdown-here/additional.jpg","hash":"9a7c6f51d83ac4815c661411786d5a4307923e62","modified":1525598224938},{"_id":"public/2016/10/02/jsonp/cors.png","hash":"03174e532d5fab79c1d9fd0a00139d4978443df0","modified":1525598224938},{"_id":"public/2016/10/02/jsonp/sample.png","hash":"5c66eed23ecf164fca1d7f1f71eb2bd33d85c770","modified":1525598224938},{"_id":"public/2018/03/15/jackson-custom/BeanSerializerBase.jpg","hash":"e845271511283bdc73ddc2eebc780a3c1a63305a","modified":1525598224938},{"_id":"public/2018/03/15/jackson-custom/BeanSerializer.jpg","hash":"5c4b653b4ace19b99745b08471fd0d56f5054482","modified":1525598224938},{"_id":"public/2016/09/27/postgre/history.jpg","hash":"b40a177bc06fe594dbbf51ead88b1949d11ae5da","modified":1525598224938},{"_id":"public/2016/09/26/character-encoding/Unicode_logo.jpg","hash":"8ca31a7bd95ffb6a1aa6456c1b0970e1a5458fd7","modified":1525598224938},{"_id":"public/2016/09/26/character-encoding/unicode-layout.jpg","hash":"59c7ccbffd30aeb97f811b67a9f94a0f5c1bb5e0","modified":1525598224939},{"_id":"public/2016/09/26/character-encoding/emoji.jpg","hash":"e4e05e46031c997ddd9b3d53a385c6d653963cd6","modified":1525598224939},{"_id":"public/2018/03/15/jackson-custom/DefaultSerializerProvider.jpg","hash":"82dc143e290623f30df04382bbe04b8bb0858bc9","modified":1525598224939},{"_id":"public/2017/12/02/google-perf-tools/memory-mapping.jpg","hash":"fa598d02a2d0456a5511bce64b9956aa643b4755","modified":1525598224939},{"_id":"public/2017/12/02/google-perf-tools/result.pdf","hash":"c3b07f7cca94cedf4f39349095dfa2f204bf380b","modified":1525598224939},{"_id":"public/2018/03/15/inode/high-level.jpg","hash":"c6ed5d78bfc32e4de83aeff88833e241b7f6f786","modified":1525598224939},{"_id":"public/2018/03/15/inode/example.jpg","hash":"5cbdbd1a32b06ff13b28d8b264fc64a0f6a86a12","modified":1525598224939},{"_id":"public/2018/03/15/inode/low-level.jpg","hash":"2f7ddfedba4645e421d17450ecce9ef6490e1ab8","modified":1525598224939},{"_id":"public/2018/03/15/inode/unix-file-structure.jpg","hash":"e279b6af2942dad6e58480c067d3897aa070e7eb","modified":1525598224939},{"_id":"public/2016/10/31/property-placeholder/hierarchy.jpg","hash":"df248929441da0b2bdbe7afbf56d4729ae8f524d","modified":1525598224939},{"_id":"public/2016/10/31/property-placeholder/location.jpg","hash":"cf8a3be6950b18df2310584921d7058f45b4ffcf","modified":1525598224939},{"_id":"public/2016/11/29/HttpMessageConverter/inherit.jpg","hash":"1776d8f3e17b516ecc36fb3c55a398e6348760d7","modified":1525598224939},{"_id":"public/2017/09/10/electron/electron.jpg","hash":"584149413cf7bbf4ab275b832afa9d7465d5a4c6","modified":1525598224939},{"_id":"public/2017/09/10/electron/item.png","hash":"ce783cc3a9a290e4b2dca32fd48e9b27b9157dcf","modified":1525598224940},{"_id":"public/2017/09/12/git-branch-log/glgga.png","hash":"2c4f3c3001222af1eba177a955bd4198519e1379","modified":1525598224940},{"_id":"public/2017/09/10/electron/select.png","hash":"0af4298edad6cdc8c5861824820cf07f47833ec9","modified":1525598224940},{"_id":"public/2016/10/02/spring-mvc/Servlet_LifeCycle.jpg","hash":"ec5a5ed7867fd6fd38c21edd4bd4336a39446614","modified":1525598224940},{"_id":"public/2016/10/02/spring-mvc/hierachy.jpg","hash":"d2791a173d265df7a59e2a1a83f86bbb93a949b4","modified":1525598224940},{"_id":"public/2016/10/02/spring-mvc/servlet-interface.jpg","hash":"362e1f8d17678f77285a987de921dc70a2647454","modified":1525598224940},{"_id":"public/2017/02/15/idea-scratches/keymap.jpg","hash":"9ba0b9485e48a65e209e16661a13b9b6bc93e152","modified":1525598224940},{"_id":"public/2017/02/15/idea-scratches/menu.jpg","hash":"73ac891ae3864cb7e174d1e51a31bb422c8320d9","modified":1525598224940},{"_id":"public/2017/02/15/idea-scratches/search.jpg","hash":"43b627ea26b9a4fe7be2b963e921c708e8762fec","modified":1525598224940},{"_id":"public/2017/02/15/idea-scratches/new.jpg","hash":"124a569f2c1b11bf8816f31b516aa81a0f99e086","modified":1525598224940},{"_id":"public/2017/02/15/idea-scratches/scratches.jpg","hash":"553a08b63e4f56b9d5208541fbb39f0b82205c37","modified":1525598224940},{"_id":"public/2017/09/10/how-to-delete-file-correctly/before.png","hash":"ec4db540892ef32fdf6e1151a5680887513d2b51","modified":1525598224940},{"_id":"public/2017/09/10/how-to-delete-file-correctly/after.png","hash":"ec4db540892ef32fdf6e1151a5680887513d2b51","modified":1525598224940},{"_id":"public/2017/09/10/how-to-delete-file-correctly/links.png","hash":"1cda70c9b4821d3ecf1804b785898e11262e5a80","modified":1525598224941},{"_id":"public/2017/09/10/how-to-delete-file-correctly/inode.png","hash":"b0f83b85f364e13eff052a5b10b9b75c3b388a40","modified":1525598224941},{"_id":"public/2018/05/06/spring-mvc-2/spring-mvc.png","hash":"04f940f8a17cbc10011891e63f5b3db2343fb26a","modified":1525598224941},{"_id":"public/2017/11/26/jinfo/jinfo.png","hash":"99dbf8d6abc2d344f9a4adc70ec02e515040104c","modified":1525598224992},{"_id":"public/2016/12/17/spi/usage.jpg","hash":"ccda980477add78ccf794d40482fbf65cd880de1","modified":1525598224995},{"_id":"public/2018/03/15/gc-basic/g1.jpg","hash":"751479804ac2ac64cb9674e74938e9d8a726c318","modified":1525598224995},{"_id":"public/2016/09/27/postgre/arch.jpg","hash":"53839b9675327b7b18c652c1bf568b903017145e","modified":1525598224995},{"_id":"public/2017/12/02/google-perf-tools/2017年 09月 05日 星期二 01:34:24 CST.png","hash":"5a3efb1e3e32ebc79c5508d280205cc8cc4d6952","modified":1525598224995},{"_id":"public/2016/10/31/property-placeholder/post-processors.jpg","hash":"db5b21a4d6ace84afb24d14b158833558a5ad809","modified":1525598224995},{"_id":"public/2016/11/29/HttpMessageConverter/DispatcherServlet-properties.jpg","hash":"2dd94eb25a05e8dd5a8bc0f8fc2eb05ebd73f89c","modified":1525598224996},{"_id":"public/2016/11/29/HttpMessageConverter/arch.jpg","hash":"57bcfe2eac52149a1964cc576ba50409d4861c2c","modified":1525598224996},{"_id":"public/2016/11/29/HttpMessageConverter/http-message-converter.jpg","hash":"fb06cf8a039b6d402ddb4cba11abb408caaa58fd","modified":1525598224996},{"_id":"public/2017/09/12/git-branch-log/glgg.png","hash":"a4eec11f852e7ad1246ab7141c519929186b407e","modified":1525598224996},{"_id":"public/2016/10/02/spring-mvc/arch.jpg","hash":"57bcfe2eac52149a1964cc576ba50409d4861c2c","modified":1525598224996},{"_id":"public/css/donate.css","hash":"77c95047afb26db47eb4038e636be291191d5f83","modified":1525598225006},{"_id":"public/css/jquery.fancybox.css","hash":"f42f761157f26244673eb2f4a9215c70956f80dc","modified":1525598225006},{"_id":"public/js/busuanzi.pure.mini.js","hash":"979315f03b6b3f215ba7505a716ed9d34d09cc14","modified":1525598225006},{"_id":"public/js/codeblock-resizer.js","hash":"5d0b786d60bf225d9eabcc9cece2719ff4d9b6cd","modified":1525598225006},{"_id":"public/js/mindmap.js","hash":"3e4ec78a29a912c822dcb6ee135831e632435620","modified":1525598225006},{"_id":"public/js/share.js","hash":"f49776e0baa2b913ddc7a20db24b3edd469c8343","modified":1525598225006},{"_id":"public/js/totop.js","hash":"7dbf8fcf582a4fb6eb9b2c60d6de9f9c2091ec4c","modified":1525598225006},{"_id":"public/js/json-diff.js","hash":"1ecc45fd2dd6d2f27bb62185920eb23f4cd56f4d","modified":1525598225006},{"_id":"public/js/smartresize.js","hash":"3ef157fd877167e3290f42c67a624ea375a46c24","modified":1525598225006},{"_id":"public/js/particles.js","hash":"a416f570f80cb303691bd33b7070b7976d6bd807","modified":1525598225006},{"_id":"public/js/search.js","hash":"0c0630e2ef213701d393b041f10572e951a27985","modified":1525598225007},{"_id":"public/js/fancybox.js","hash":"13c4781570339f4fba76a3d7f202e442817dd605","modified":1525598225007},{"_id":"public/css/style.css","hash":"05b3353caf9536c33b7fb4423f863a202e6d1f4d","modified":1525598225007},{"_id":"public/js/particles.min.js","hash":"8017f8b1869077db728573f1ca4684a00af69462","modified":1525598225007},{"_id":"public/js/kity.min.js","hash":"14fbc0cea315e4af3e8a2c320049797f1b5559bf","modified":1525598225007},{"_id":"public/js/kityminder.core.js","hash":"51bb5a5ff5c974d32ace877c1c3488bb6fd44f8c","modified":1525598225007},{"_id":"public/2018/05/02/dubbo-generic-invoke/generic.png","hash":"b553e8919f420ba2abbea311210fb8baf74c606b","modified":1525598225007},{"_id":"public/2018/01/20/go-figure/go-tour.png","hash":"6593714185586bb1c2d4758a705964bff988babe","modified":1525598225007},{"_id":"public/2016/11/16/jackson-guava/jar.png","hash":"0067332eb536099b9f5efc79e466e3302867d714","modified":1525598225008},{"_id":"public/2017/09/09/top/highlight.png","hash":"274ba49e46d1d5ee0a953ef63b1eb7ceebe48bed","modified":1525598225008},{"_id":"public/2017/09/10/how-to-delete-file-correctly/deleted.png","hash":"5d1e3fcbb74a3f937a24e6619ca5ec32a64808e8","modified":1525598225008},{"_id":"public/2017/09/12/git-branch-log/idea.png","hash":"f96a5f5e98b383af80381996ada0b6465d7e5b4a","modified":1525598225019},{"_id":"public/2017/12/02/cache-system-time/time-cache.jpg","hash":"cd1f28e4533046bfac692883482ed541b539bf6d","modified":1525598225019},{"_id":"public/2017/09/09/top/fields.png","hash":"604b40c3362118bdc0a2437e716fbb53c47efa39","modified":1525598225019},{"_id":"public/2017/09/09/top/highlight-sort.png","hash":"39be3abb0e5970179bf902bbbc55bf5853ef0289","modified":1525598225019},{"_id":"public/2017/09/09/top/top-thread","hash":"64437f1ce3f0edaf281def420933c31da883527f","modified":1525598225020},{"_id":"public/2017/09/12/git-branch-log/idea-sorted.png","hash":"6471bd3d7b867ce4fd5664773f9c3c90043a826c","modified":1525598225027},{"_id":"public/2017/09/09/top/cpu.png","hash":"a1f9bb18acbf4c217f756fbf107a05407597a826","modified":1525598225027},{"_id":"public/2017/09/09/top/top-a.png","hash":"96dea599a6c6bcd4395a27f326ac4bbbf564c579","modified":1525598225027},{"_id":"public/2016/09/30/pagination/PPC2009_mysql_pagination.pdf","hash":"606f57614083e01b5dc97653b2b699a91e92ee31","modified":1525598225028},{"_id":"public/2017/01/01/markdown-mindmap/relations.png","hash":"7379ebbf18fca6e27dce47ea16721912d561046b","modified":1525598225028},{"_id":"public/2018/03/15/gc-cms/cms.jpg","hash":"53197087e4f1fed4efbe9abfa8b56d4b252edb35","modified":1525598225028},{"_id":"public/2018/05/06/spring-mvc-2/springmvc.log","hash":"f3c8f8c0b59eaa639b30491186d88b3c2b7b9151","modified":1525598225035},{"_id":"public/image/bg2.jpg","hash":"e0770c4d68b777201bb383cbb88d593b2fa0826c","modified":1525598225044},{"_id":"public/2017/09/10/electron/mojibar.gif","hash":"fa820683a7edca375eae47d41edda465d535dc64","modified":1525598225046}],"Category":[{"name":"linux","_id":"cjgulsd69000ajh4kgdblw6mq"},{"name":"java","_id":"cjgulsd6k000fjh4kbpgqgwfg"},{"name":"spring","_id":"cjgulsd6n000mjh4k5ayc8ywq"},{"name":"shell","_id":"cjgulsd6q000sjh4kls6njims"},{"name":"工具","_id":"cjgulsd6s000zjh4k1srp0gvp"},{"name":"dubbo","_id":"cjgulsd6u0015jh4kncwym8mv"},{"name":"gc","_id":"cjgulsd6x001cjh4k1ivoxd6n"},{"name":"thinking","_id":"cjgulsd77001tjh4ky1kt2fzs"},{"name":"web","_id":"cjgulsd7c0025jh4kbjp067yx"},{"name":"jackson","_id":"cjgulsd7f002cjh4kwwbfta02"},{"name":"fe","_id":"cjgulsd7i002ljh4k5bwq52ro"},{"name":"jvm","_id":"cjgulsd7k002rjh4kw0e79599"},{"name":"maven","_id":"cjgulsd7n002xjh4kx4qxv4p4"},{"name":"guava","_id":"cjgulsd82003fjh4kzg9dlm39"},{"name":"threadpool","_id":"cjgulsd8b003sjh4kmuimxmsp"},{"name":"tomcat","_id":"cjgulsd8e003zjh4kdnbpgjkp"},{"name":"algorithm","_id":"cjgulsd8l004fjh4kfz58rn7w"},{"name":"base","_id":"cjgulsd8r004xjh4k1go01zw6"},{"name":"python","_id":"cjgulsd90005fjh4k49h3se18"},{"name":"git","_id":"cjgulsd93005njh4kpsxispk2"},{"name":"go","_id":"cjgulsd95005ujh4kbua7w75g"},{"name":"perf","_id":"cjgulsd990065jh4ky2y0qvyg"},{"name":"hexo","_id":"cjgulsd9f006kjh4kxuv86ku3"},{"name":"idea","_id":"cjgulsd9m006xjh4k5456bhnv"},{"name":"markdown","_id":"cjgulsd9z007vjh4kixagd4w3"},{"name":"机器学习","_id":"cjgulsda20083jh4kmetx6o8m"}],"Data":[],"Page":[{"title":"","date":"2017-01-01T16:03:57.000Z","_content":"\n<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n## 关于我\n\n![](me.jpg)\n\n图像处理出身, 略懂java, 熟读<<性能之巅>>\n\n> 大圣，此去欲何?\n\n> 踏南天，碎凌霄。<BR> \n> 若一去不回……<BR> \n> 便一去不回 !\n\n## 技术栈\n\n- Java\n- Mybatis\n- Spring\n- Dubbo\n- Python\n\n## 联系方式\n\n- 邮箱：liqisheng <span class=\"fa fa-at\"></span> whu.edu.cn\n\n","source":"about/index.md","raw":"title: \ndate: 2017-01-02 00:03:57\n---\n\n<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n## 关于我\n\n![](me.jpg)\n\n图像处理出身, 略懂java, 熟读<<性能之巅>>\n\n> 大圣，此去欲何?\n\n> 踏南天，碎凌霄。<BR> \n> 若一去不回……<BR> \n> 便一去不回 !\n\n## 技术栈\n\n- Java\n- Mybatis\n- Spring\n- Dubbo\n- Python\n\n## 联系方式\n\n- 邮箱：liqisheng <span class=\"fa fa-at\"></span> whu.edu.cn\n\n","updated":"2018-01-17T01:13:48.427Z","path":"about/index.html","comments":1,"layout":"page","_id":"cjgulsd4m0000jh4kktrcv3nm","content":"<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n<h2 id=\"关于我\"><a href=\"#关于我\" class=\"headerlink\" title=\"关于我\"></a>关于我</h2><p><img src=\"me.jpg\" alt=\"\"></p>\n<p>图像处理出身, 略懂java, 熟读&lt;&lt;性能之巅&gt;&gt;</p>\n<blockquote>\n<p>大圣，此去欲何?</p>\n<p>踏南天，碎凌霄。<br><br>若一去不回……<br><br>便一去不回 !</p>\n</blockquote>\n<h2 id=\"技术栈\"><a href=\"#技术栈\" class=\"headerlink\" title=\"技术栈\"></a>技术栈</h2><ul>\n<li>Java</li>\n<li>Mybatis</li>\n<li>Spring</li>\n<li>Dubbo</li>\n<li>Python</li>\n</ul>\n<h2 id=\"联系方式\"><a href=\"#联系方式\" class=\"headerlink\" title=\"联系方式\"></a>联系方式</h2><ul>\n<li>邮箱：liqisheng <span class=\"fa fa-at\"></span> whu.edu.cn</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n<h2 id=\"关于我\"><a href=\"#关于我\" class=\"headerlink\" title=\"关于我\"></a>关于我</h2><p><img src=\"me.jpg\" alt=\"\"></p>\n<p>图像处理出身, 略懂java, 熟读&lt;&lt;性能之巅&gt;&gt;</p>\n<blockquote>\n<p>大圣，此去欲何?</p>\n<p>踏南天，碎凌霄。<br><br>若一去不回……<br><br>便一去不回 !</p>\n</blockquote>\n<h2 id=\"技术栈\"><a href=\"#技术栈\" class=\"headerlink\" title=\"技术栈\"></a>技术栈</h2><ul>\n<li>Java</li>\n<li>Mybatis</li>\n<li>Spring</li>\n<li>Dubbo</li>\n<li>Python</li>\n</ul>\n<h2 id=\"联系方式\"><a href=\"#联系方式\" class=\"headerlink\" title=\"联系方式\"></a>联系方式</h2><ul>\n<li>邮箱：liqisheng <span class=\"fa fa-at\"></span> whu.edu.cn</li>\n</ul>\n"},{"title":"推荐-分享","date":"2017-01-01T16:49:53.000Z","toc":true,"_content":"\n<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n# 前言\n\n> If you have an apple and I have an apple and we exchange these apples then you and I will still each have one apple. But if you have an idea and I have an idea and we exchange these ideas, then each of us will have two ideas.\n\n## python\n\n- [Jupyter](http://jupyter.org/)\n\n- [Anaconda](https://www.continuum.io/downloads)\n\n## maven \n\n- aliyun maven\n\n{% gist 47a98f1cbde1179f1fc6227734e4e2e8 %}\n\n## shell\n\n- [oh-my-zsh](https://github.com/robbyrussell/oh-my-zsh)\n- [zsh-syntax-highlighting](https://github.com/zsh-users/zsh-syntax-highlighting)\n- [zsh-git-prompt](https://github.com/olivierverdier/zsh-git-prompt)\n\n![](https://github.com/olivierverdier/zsh-git-prompt/raw/master/screenshot.png)\n\n## editor\n\n- [visual source code](https://code.visualstudio.com/)\n\n","source":"recommendation/index.md","raw":"title: 推荐-分享\ndate: 2017-01-02 00:49:53\ntoc: true\n---\n\n<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n# 前言\n\n> If you have an apple and I have an apple and we exchange these apples then you and I will still each have one apple. But if you have an idea and I have an idea and we exchange these ideas, then each of us will have two ideas.\n\n## python\n\n- [Jupyter](http://jupyter.org/)\n\n- [Anaconda](https://www.continuum.io/downloads)\n\n## maven \n\n- aliyun maven\n\n{% gist 47a98f1cbde1179f1fc6227734e4e2e8 %}\n\n## shell\n\n- [oh-my-zsh](https://github.com/robbyrussell/oh-my-zsh)\n- [zsh-syntax-highlighting](https://github.com/zsh-users/zsh-syntax-highlighting)\n- [zsh-git-prompt](https://github.com/olivierverdier/zsh-git-prompt)\n\n![](https://github.com/olivierverdier/zsh-git-prompt/raw/master/screenshot.png)\n\n## editor\n\n- [visual source code](https://code.visualstudio.com/)\n\n","updated":"2017-05-31T16:58:30.000Z","path":"recommendation/index.html","comments":1,"layout":"page","_id":"cjgulsd620006jh4knobvrqvj","content":"<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><blockquote>\n<p>If you have an apple and I have an apple and we exchange these apples then you and I will still each have one apple. But if you have an idea and I have an idea and we exchange these ideas, then each of us will have two ideas.</p>\n</blockquote>\n<h2 id=\"python\"><a href=\"#python\" class=\"headerlink\" title=\"python\"></a>python</h2><ul>\n<li><p><a href=\"http://jupyter.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jupyter</a></p>\n</li>\n<li><p><a href=\"https://www.continuum.io/downloads\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Anaconda</a></p>\n</li>\n</ul>\n<h2 id=\"maven\"><a href=\"#maven\" class=\"headerlink\" title=\"maven\"></a>maven</h2><ul>\n<li>aliyun maven</li>\n</ul>\n<script src=\"//gist.github.com/47a98f1cbde1179f1fc6227734e4e2e8.js\"></script>\n<h2 id=\"shell\"><a href=\"#shell\" class=\"headerlink\" title=\"shell\"></a>shell</h2><ul>\n<li><a href=\"https://github.com/robbyrussell/oh-my-zsh\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">oh-my-zsh</a></li>\n<li><a href=\"https://github.com/zsh-users/zsh-syntax-highlighting\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">zsh-syntax-highlighting</a></li>\n<li><a href=\"https://github.com/olivierverdier/zsh-git-prompt\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">zsh-git-prompt</a></li>\n</ul>\n<p><img src=\"https://github.com/olivierverdier/zsh-git-prompt/raw/master/screenshot.png\" alt=\"\"></p>\n<h2 id=\"editor\"><a href=\"#editor\" class=\"headerlink\" title=\"editor\"></a>editor</h2><ul>\n<li><a href=\"https://code.visualstudio.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">visual source code</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<style type=\"text/css\">\n    .post-title{\n        border-top: none !important;\n        background-color: #ffffff !important;\n        text-align: center !important;\n    }\n</style>\n\n<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><blockquote>\n<p>If you have an apple and I have an apple and we exchange these apples then you and I will still each have one apple. But if you have an idea and I have an idea and we exchange these ideas, then each of us will have two ideas.</p>\n</blockquote>\n<h2 id=\"python\"><a href=\"#python\" class=\"headerlink\" title=\"python\"></a>python</h2><ul>\n<li><p><a href=\"http://jupyter.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jupyter</a></p>\n</li>\n<li><p><a href=\"https://www.continuum.io/downloads\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Anaconda</a></p>\n</li>\n</ul>\n<h2 id=\"maven\"><a href=\"#maven\" class=\"headerlink\" title=\"maven\"></a>maven</h2><ul>\n<li>aliyun maven</li>\n</ul>\n<script src=\"//gist.github.com/47a98f1cbde1179f1fc6227734e4e2e8.js\"></script>\n<h2 id=\"shell\"><a href=\"#shell\" class=\"headerlink\" title=\"shell\"></a>shell</h2><ul>\n<li><a href=\"https://github.com/robbyrussell/oh-my-zsh\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">oh-my-zsh</a></li>\n<li><a href=\"https://github.com/zsh-users/zsh-syntax-highlighting\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">zsh-syntax-highlighting</a></li>\n<li><a href=\"https://github.com/olivierverdier/zsh-git-prompt\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">zsh-git-prompt</a></li>\n</ul>\n<p><img src=\"https://github.com/olivierverdier/zsh-git-prompt/raw/master/screenshot.png\" alt=\"\"></p>\n<h2 id=\"editor\"><a href=\"#editor\" class=\"headerlink\" title=\"editor\"></a>editor</h2><ul>\n<li><a href=\"https://code.visualstudio.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">visual source code</a></li>\n</ul>\n"},{"title":"tags","date":"2016-09-23T16:07:17.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"title: tags\ndate: 2016-09-24 00:07:17\ntype: \"tags\"\n---\n","updated":"2017-04-16T11:59:29.543Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cjgulsdw600c7jh4kb13hqhmq","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"HandlerAdapter","toc":true,"abbrlink":26254,"category":null,"_content":"","source":"_drafts/HandlerAdapter.md","raw":"---\ntitle: HandlerAdapter\ntoc: true\nabbrlink: 26254\ntags:\ncategory:\n---\n","slug":"HandlerAdapter","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.353Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd4n0001jh4k7tfvpt3y","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"HandlerMapping","toc":true,"abbrlink":51688,"category":null,"_content":"","source":"_drafts/HandlerMapping.md","raw":"---\ntitle: HandlerMapping\ntoc: true\nabbrlink: 51688\ntags:\ncategory:\n---\n","slug":"HandlerMapping","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.353Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd4s0002jh4k940g9fu5","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"P98","toc":true,"abbrlink":37651,"category":null,"_content":"","source":"_drafts/P98.md","raw":"---\ntitle: P98\ntoc: true\nabbrlink: 37651\ntags:\ncategory:\n---\n","slug":"P98","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.353Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd4u0003jh4kh9kfeaab","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"HandlerMethodArgumentResolver","toc":true,"abbrlink":582,"category":null,"_content":"\n","source":"_drafts/HandlerMethodArgumentResolver.md","raw":"---\ntitle: HandlerMethodArgumentResolver\ntoc: true\nabbrlink: 582\ntags:\ncategory:\n---\n\n","slug":"HandlerMethodArgumentResolver","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.353Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd4v0004jh4k84fzr44w","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"ServletInvocableHandlerMethod","toc":true,"abbrlink":39341,"category":null,"_content":"","source":"_drafts/ServletInvocableHandlerMethod.md","raw":"---\ntitle: ServletInvocableHandlerMethod\ntoc: true\nabbrlink: 39341\ntags:\ncategory:\n---\n","slug":"ServletInvocableHandlerMethod","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.353Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd610005jh4k9s58i5ya","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"WeakHashMap","toc":true,"abbrlink":28555,"category":null,"_content":"","source":"_drafts/WeakHashMap.md","raw":"---\ntitle: WeakHashMap\ntoc: true\nabbrlink: 28555\ntags:\ncategory:\n---\n","slug":"WeakHashMap","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.357Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd630007jh4kg807q62m","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"用ab进行压力测试","toc":true,"_content":"\n## 安装\n\n\n\n## 简单使用\n\n```\n$ ab -n 10000 -c 200 http://localhost:8080/async\n```\n\n上述命令是说, 按照并发200的方式,总共请求1w次.\n\n### 指定keep-alive模式\n\n压力测试要尽量满足和线上环境一样, 线上大部分都开启了keep-alive, 因此需要保持一致.\n\n```\n-k              Use HTTP KeepAlive feature\n```\n\n## 参考\n","source":"_drafts/ab.md","raw":"title: 用ab进行压力测试\ntoc: true\ntags: ab\ncategory: linux\n---\n\n## 安装\n\n\n\n## 简单使用\n\n```\n$ ab -n 10000 -c 200 http://localhost:8080/async\n```\n\n上述命令是说, 按照并发200的方式,总共请求1w次.\n\n### 指定keep-alive模式\n\n压力测试要尽量满足和线上环境一样, 线上大部分都开启了keep-alive, 因此需要保持一致.\n\n```\n-k              Use HTTP KeepAlive feature\n```\n\n## 参考\n","slug":"ab","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2018-01-21T04:54:52.526Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd640008jh4k0we8kl2a","content":"<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h2 id=\"简单使用\"><a href=\"#简单使用\" class=\"headerlink\" title=\"简单使用\"></a>简单使用</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ab -n 10000 -c 200 http://localhost:8080/async</span><br></pre></td></tr></table></figure>\n<p>上述命令是说, 按照并发200的方式,总共请求1w次.</p>\n<h3 id=\"指定keep-alive模式\"><a href=\"#指定keep-alive模式\" class=\"headerlink\" title=\"指定keep-alive模式\"></a>指定keep-alive模式</h3><p>压力测试要尽量满足和线上环境一样, 线上大部分都开启了keep-alive, 因此需要保持一致.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-k              Use HTTP KeepAlive feature</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h2 id=\"简单使用\"><a href=\"#简单使用\" class=\"headerlink\" title=\"简单使用\"></a>简单使用</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ab -n 10000 -c 200 http://localhost:8080/async</span><br></pre></td></tr></table></figure>\n<p>上述命令是说, 按照并发200的方式,总共请求1w次.</p>\n<h3 id=\"指定keep-alive模式\"><a href=\"#指定keep-alive模式\" class=\"headerlink\" title=\"指定keep-alive模式\"></a>指定keep-alive模式</h3><p>压力测试要尽量满足和线上环境一样, 线上大部分都开启了keep-alive, 因此需要保持一致.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-k              Use HTTP KeepAlive feature</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2>"},{"title":"burpsuite-https","toc":true,"abbrlink":55153,"category":null,"_content":"","source":"_drafts/burpsuite-https.md","raw":"---\ntitle: burpsuite-https\ntoc: true\nabbrlink: 55153\ntags:\ncategory:\n---\n","slug":"burpsuite-https","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.357Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd660009jh4k4qu85huq","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"cap","toc":true,"category":null,"_content":"\n## 基础信息\n### 查看网卡\n\n```\n➜  ~  ifconfig \neno1      Link encap:Ethernet  HWaddr ec:f4:bb:48:fb:d0  \n          UP BROADCAST MULTICAST  MTU:1500  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000 \n          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)\n          Interrupt:20 Memory:f7c00000-f7c20000 \n\nlo        Link encap:Local Loopback  \n          inet addr:127.0.0.1  Mask:255.0.0.0\n          inet6 addr: ::1/128 Scope:Host\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:20706 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:20706 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1 \n          RX bytes:8737590 (8.7 MB)  TX bytes:8737590 (8.7 MB)\n\nwlp2s0    Link encap:Ethernet  HWaddr 18:cf:5e:1f:c1:1b  \n          inet addr:192.168.10.164  Bcast:192.168.10.255  Mask:255.255.255.0\n          inet6 addr: fe80::cae2:9f28:a8ee:8308/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:61081 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:45149 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000 \n          RX bytes:64271852 (64.2 MB)  TX bytes:7404597 (7.4 MB)\n```\n\n### 抓包\n\n```\nsudo tcpdump -i wlp2s0 -w test.cap\nsudo tcpdump -i any   dst port 30000\n```\n\n## wireshark 分析\n\n### wireshark 过滤\n\n\n#### ip过滤\n```\nip.src eq 10.175.168.182\nip.src == 182.254.78.160\n```\n\n#### 端口过滤\n\n```\ntcp.port == 80   // 不管端口是来源的还是目标的都显示\ntcp.dstport == 80 // 只显tcp协议的目标端口80\ntcp.srcport == 80 // 只显tcp协议的来源端口80\n过滤端口范围\ntcp.port >= 1 and tcp.port <= 80\n```\n\n#### 过滤协议\n\n```\n!arp\nnot arp\nless than 小于 < lt \n```\n\n\n#### http模式过滤\n例子:\nhttp.request.method == “GET”\nhttp.request.method == “POST”\nhttp.request.uri == “/img/logo-edu.gif”\nhttp contains “GET”\nhttp contains “HTTP/1.”\n// GET包\nhttp.request.method == “GET” && http contains “Host: “\nhttp.request.method == “GET” && http contains “User-Agent: “\n// POST包\nhttp.request.method == “POST” && http contains “Host: “\nhttp.request.method == “POST” && http contains “User-Agent: “\n// 响应包\nhttp contains “HTTP/1.1 200 OK” && http contains “Content-Type: “\nhttp contains “HTTP/1.0 200 OK” && http contains “Content-Type: “\n一定包含如下\nContent-Type:\n\n\n### tshark\n\nwireshark的命令行版本\n\ndump成格式化的文件\n```\nsudo tshark -T pdml\n\n<packet>\n  <proto name=\"geninfo\" pos=\"0\" showname=\"General information\" size=\"62\">\n    <field name=\"num\" pos=\"0\" show=\"809\" showname=\"Number\" value=\"329\" size=\"62\"/>\n    <field name=\"len\" pos=\"0\" show=\"62\" showname=\"Frame Length\" value=\"3e\" size=\"62\"/>\n    <field name=\"caplen\" pos=\"0\" show=\"62\" showname=\"Captured Length\" value=\"3e\" size=\"62\"/>\n    <field name=\"timestamp\" pos=\"0\" show=\"Jan 16, 2018 17:00:58.821155665 CST\" showname=\"Captured Time\" value=\"1516093258.821155665\" size=\"62\"/>\n  </proto>\n  <proto name=\"frame\" showname=\"Frame 809: 62 bytes on wire (496 bits), 62 bytes captured (496 bits) on interface 0\" size=\"62\" pos=\"0\">\n    <field name=\"frame.interface_id\" showname=\"Interface id: 0 (eno1)\" size=\"0\" pos=\"0\" show=\"0\"/>\n    <field name=\"frame.encap_type\" showname=\"Encapsulation type: Ethernet (1)\" size=\"0\" pos=\"0\" show=\"1\"/>\n    <field name=\"frame.time\" showname=\"Arrival Time: Jan 16, 2018 17:00:58.821155665 CST\" size=\"0\" pos=\"0\" show=\"Jan 16, 2018 17:00:58.821155665 CST\"/>\n    <field name=\"frame.offset_shift\" showname=\"Time shift for this packet: 0.000000000 seconds\" size=\"0\" pos=\"0\" show=\"0.000000000\"/>\n    <field name=\"frame.time_epoch\" showname=\"Epoch Time: 1516093258.821155665 seconds\" size=\"0\" pos=\"0\" show=\"1516093258.821155665\"/>\n    <field name=\"frame.time_delta\" showname=\"Time delta from previous captured frame: 0.141310248 seconds\" size=\"0\" pos=\"0\" show=\"0.141310248\"/>\n    <field name=\"frame.time_delta_displayed\" showname=\"Time delta from previous displayed frame: 0.141310248 seconds\" size=\"0\" pos=\"0\" show=\"0.141310248\"/>\n    <field name=\"frame.time_relative\" showname=\"Time since reference or first frame: 65.066083767 seconds\" size=\"0\" pos=\"0\" show=\"65.066083767\"/>\n    <field name=\"frame.number\" showname=\"Frame Number: 809\" size=\"0\" pos=\"0\" show=\"809\"/>\n    <field name=\"frame.len\" showname=\"Frame Length: 62 bytes (496 bits)\" size=\"0\" pos=\"0\" show=\"62\"/>\n    <field name=\"frame.cap_len\" showname=\"Capture Length: 62 bytes (496 bits)\" size=\"0\" pos=\"0\" show=\"62\"/>\n    <field name=\"frame.marked\" showname=\"Frame is marked: False\" size=\"0\" pos=\"0\" show=\"0\"/>\n    <field name=\"frame.ignored\" showname=\"Frame is ignored: False\" size=\"0\" pos=\"0\" show=\"0\"/>\n    <field name=\"frame.protocols\" showname=\"Protocols in frame: eth:ethertype:ip:udp:hsrp\" size=\"0\" pos=\"0\" show=\"eth:ethertype:ip:udp:hsrp\"/>\n  </proto>\n  <proto name=\"eth\" showname=\"Ethernet II, Src: All-HSRP-routers_0f (00:00:0c:07:ac:0f), Dst: IPv4mcast_02 (01:00:5e:00:00:02)\" size=\"14\" pos=\"0\">\n    <field name=\"eth.dst\" showname=\"Destination: IPv4mcast_02 (01:00:5e:00:00:02)\" size=\"6\" pos=\"0\" show=\"01:00:5e:00:00:02\" value=\"01005e000002\">\n      <field name=\"eth.dst_resolved\" showname=\"Destination (resolved): IPv4mcast_02\" hide=\"yes\" size=\"6\" pos=\"0\" show=\"IPv4mcast_02\" value=\"01005e000002\"/>\n      <field name=\"eth.addr\" showname=\"Address: IPv4mcast_02 (01:00:5e:00:00:02)\" size=\"6\" pos=\"0\" show=\"01:00:5e:00:00:02\" value=\"01005e000002\"/>\n      <field name=\"eth.addr_resolved\" showname=\"Address (resolved): IPv4mcast_02\" hide=\"yes\" size=\"6\" pos=\"0\" show=\"IPv4mcast_02\" value=\"01005e000002\"/>\n      <field name=\"eth.lg\" showname=\".... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)\" size=\"3\" pos=\"0\" show=\"0\" value=\"0\" unmaskedvalue=\"01005e\"/>\n      <field name=\"eth.ig\" showname=\".... ...1 .... .... .... .... = IG bit: Group address (multicast/broadcast)\" size=\"3\" pos=\"0\" show=\"1\" value=\"1\" unmaskedvalue=\"01005e\"/>\n    </field>\n    <field name=\"eth.src\" showname=\"Source: All-HSRP-routers_0f (00:00:0c:07:ac:0f)\" size=\"6\" pos=\"6\" show=\"00:00:0c:07:ac:0f\" value=\"00000c07ac0f\">\n      <field name=\"eth.src_resolved\" showname=\"Source (resolved): All-HSRP-routers_0f\" hide=\"yes\" size=\"6\" pos=\"6\" show=\"All-HSRP-routers_0f\" value=\"00000c07ac0f\"/>\n      <field name=\"eth.addr\" showname=\"Address: All-HSRP-routers_0f (00:00:0c:07:ac:0f)\" size=\"6\" pos=\"6\" show=\"00:00:0c:07:ac:0f\" value=\"00000c07ac0f\"/>\n      <field name=\"eth.addr_resolved\" showname=\"Address (resolved): All-HSRP-routers_0f\" hide=\"yes\" size=\"6\" pos=\"6\" show=\"All-HSRP-routers_0f\" value=\"00000c07ac0f\"/>\n      <field name=\"eth.lg\" showname=\".... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)\" size=\"3\" pos=\"6\" show=\"0\" value=\"0\" unmaskedvalue=\"00000c\"/>\n      <field name=\"eth.ig\" showname=\".... ...0 .... .... .... .... = IG bit: Individual address (unicast)\" size=\"3\" pos=\"6\" show=\"0\" value=\"0\" unmaskedvalue=\"00000c\"/>\n    </field>\n    <field name=\"eth.type\" showname=\"Type: IPv4 (0x0800)\" size=\"2\" pos=\"12\" show=\"0x00000800\" value=\"0800\"/>\n  </proto>\n  <proto name=\"ip\" showname=\"Internet Protocol Version 4, Src: 100.80.192.3, Dst: 224.0.0.2\" size=\"20\" pos=\"14\">\n    <field name=\"ip.version\" showname=\"0100 .... = Version: 4\" size=\"1\" pos=\"14\" show=\"4\" value=\"4\" unmaskedvalue=\"45\"/>\n    <field name=\"ip.hdr_len\" showname=\".... 0101 = Header Length: 20 bytes (5)\" size=\"1\" pos=\"14\" show=\"20\" value=\"45\"/>\n    <field name=\"ip.dsfield\" showname=\"Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)\" size=\"1\" pos=\"15\" show=\"0x00000000\" value=\"00\">\n      <field name=\"ip.dsfield.dscp\" showname=\"0000 00.. = Differentiated Services Codepoint: Default (0)\" size=\"1\" pos=\"15\" show=\"0\" value=\"0\" unmaskedvalue=\"00\"/>\n      <field name=\"ip.dsfield.ecn\" showname=\".... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)\" size=\"1\" pos=\"15\" show=\"0\" value=\"0\" unmaskedvalue=\"00\"/>\n    </field>\n    <field name=\"ip.len\" showname=\"Total Length: 48\" size=\"2\" pos=\"16\" show=\"48\" value=\"0030\"/>\n    <field name=\"ip.id\" showname=\"Identification: 0x0000 (0)\" size=\"2\" pos=\"18\" show=\"0x00000000\" value=\"0000\"/>\n    <field name=\"ip.flags\" showname=\"Flags: 0x00\" size=\"1\" pos=\"20\" show=\"0x00000000\" value=\"00\">\n      <field name=\"ip.flags.rb\" showname=\"0... .... = Reserved bit: Not set\" size=\"1\" pos=\"20\" show=\"0\" value=\"00\"/>\n      <field name=\"ip.flags.df\" showname=\".0.. .... = Don&#x27;t fragment: Not set\" size=\"1\" pos=\"20\" show=\"0\" value=\"00\"/>\n      <field name=\"ip.flags.mf\" showname=\"..0. .... = More fragments: Not set\" size=\"1\" pos=\"20\" show=\"0\" value=\"00\"/>\n    </field>\n    <field name=\"ip.frag_offset\" showname=\"Fragment offset: 0\" size=\"2\" pos=\"20\" show=\"0\" value=\"0000\"/>\n    <field name=\"ip.ttl\" showname=\"Time to live: 1\" size=\"1\" pos=\"22\" show=\"1\" value=\"01\"/>\n    <field name=\"ip.proto\" showname=\"Protocol: UDP (17)\" size=\"1\" pos=\"23\" show=\"17\" value=\"11\"/>\n    <field name=\"ip.checksum\" showname=\"Header checksum: 0xb567 [validation disabled]\" size=\"2\" pos=\"24\" show=\"0x0000b567\" value=\"b567\"/>\n    <field name=\"ip.checksum.status\" showname=\"Header checksum status: Unverified\" size=\"0\" pos=\"24\" show=\"2\"/>\n    <field name=\"ip.src\" showname=\"Source: 100.80.192.3\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.addr\" showname=\"Source or Destination Address: 100.80.192.3\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.src_host\" showname=\"Source Host: 100.80.192.3\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.host\" showname=\"Source or Destination Host: 100.80.192.3\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.dst\" showname=\"Destination: 224.0.0.2\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"ip.addr\" showname=\"Source or Destination Address: 224.0.0.2\" hide=\"yes\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"ip.dst_host\" showname=\"Destination Host: 224.0.0.2\" hide=\"yes\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"ip.host\" showname=\"Source or Destination Host: 224.0.0.2\" hide=\"yes\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"\" show=\"Source GeoIP: AS18403 The Corporation for Financing &amp; Promoting Technology\" size=\"4\" pos=\"26\" value=\"6450c003\">\n      <field name=\"ip.geoip.src_asnum\" showname=\"Source GeoIP AS Number: AS18403 The Corporation for Financing &amp; Promoting Technology\" size=\"4\" pos=\"26\" show=\"AS18403 The Corporation for Financing &amp; Promoting Technology\" value=\"6450c003\"/>\n      <field name=\"ip.geoip.asnum\" showname=\"Source or Destination GeoIP AS Number: AS18403 The Corporation for Financing &amp; Promoting Technology\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"AS18403 The Corporation for Financing &amp; Promoting Technology\" value=\"6450c003\"/>\n    </field>\n    <field name=\"\" show=\"Destination GeoIP: Unknown\" size=\"4\" pos=\"30\" value=\"e0000002\"/>\n  </proto>\n  <proto name=\"udp\" showname=\"User Datagram Protocol, Src Port: 1985, Dst Port: 1985\" size=\"8\" pos=\"34\">\n    <field name=\"udp.srcport\" showname=\"Source Port: 1985\" size=\"2\" pos=\"34\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.dstport\" showname=\"Destination Port: 1985\" size=\"2\" pos=\"36\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.port\" showname=\"Source or Destination Port: 1985\" hide=\"yes\" size=\"2\" pos=\"34\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.port\" showname=\"Source or Destination Port: 1985\" hide=\"yes\" size=\"2\" pos=\"36\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.length\" showname=\"Length: 28\" size=\"2\" pos=\"38\" show=\"28\" value=\"001c\"/>\n    <field name=\"udp.checksum\" showname=\"Checksum: 0x5825 [unverified]\" size=\"2\" pos=\"40\" show=\"0x00005825\" value=\"5825\"/>\n    <field name=\"udp.checksum.status\" showname=\"Checksum Status: Unverified\" size=\"0\" pos=\"40\" show=\"2\"/>\n    <field name=\"udp.stream\" showname=\"Stream index: 2\" size=\"0\" pos=\"42\" show=\"2\"/>\n  </proto>\n  <proto name=\"hsrp\" showname=\"Cisco Hot Standby Router Protocol\" size=\"20\" pos=\"42\">\n    <field name=\"hsrp.version\" showname=\"Version: 0\" size=\"1\" pos=\"42\" show=\"0\" value=\"00\"/>\n    <field name=\"hsrp.opcode\" showname=\"Op Code: Hello (0)\" size=\"1\" pos=\"43\" show=\"0\" value=\"00\"/>\n    <field name=\"hsrp.state\" showname=\"State: Active (16)\" size=\"1\" pos=\"44\" show=\"16\" value=\"10\"/>\n    <field name=\"hsrp.hellotime\" showname=\"Hellotime: Default (3)\" size=\"1\" pos=\"45\" show=\"3\" value=\"03\"/>\n    <field name=\"hsrp.holdtime\" showname=\"Holdtime: Default (10)\" size=\"1\" pos=\"46\" show=\"10\" value=\"0a\"/>\n    <field name=\"hsrp.priority\" showname=\"Priority: 150\" size=\"1\" pos=\"47\" show=\"150\" value=\"96\"/>\n    <field name=\"hsrp.group\" showname=\"Group: 15\" size=\"1\" pos=\"48\" show=\"15\" value=\"0f\"/>\n    <field name=\"hsrp.reserved\" showname=\"Reserved: 0\" size=\"1\" pos=\"49\" show=\"0\" value=\"00\"/>\n    <field name=\"hsrp.auth_data\" showname=\"Authentication Data: Default (cisco)\" size=\"8\" pos=\"50\" show=\"cisco\" value=\"636973636f000000\"/>\n    <field name=\"hsrp.virt_ip\" showname=\"Virtual IP Address: 100.80.192.1\" size=\"4\" pos=\"58\" show=\"100.80.192.1\" value=\"6450c001\"/>\n  </proto>\n</packet>\n\n```\n\n输出指定的field\n\n```\ntshark -r cap-2018-01-16.cap   -T fields -E separator=,  -e frame.number -e ip.src -e ip.dst -e data.data\n```\n\n","source":"_drafts/cap.md","raw":"title: cap\ntoc: true\ntags:\ncategory:\n---\n\n## 基础信息\n### 查看网卡\n\n```\n➜  ~  ifconfig \neno1      Link encap:Ethernet  HWaddr ec:f4:bb:48:fb:d0  \n          UP BROADCAST MULTICAST  MTU:1500  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000 \n          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)\n          Interrupt:20 Memory:f7c00000-f7c20000 \n\nlo        Link encap:Local Loopback  \n          inet addr:127.0.0.1  Mask:255.0.0.0\n          inet6 addr: ::1/128 Scope:Host\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:20706 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:20706 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1 \n          RX bytes:8737590 (8.7 MB)  TX bytes:8737590 (8.7 MB)\n\nwlp2s0    Link encap:Ethernet  HWaddr 18:cf:5e:1f:c1:1b  \n          inet addr:192.168.10.164  Bcast:192.168.10.255  Mask:255.255.255.0\n          inet6 addr: fe80::cae2:9f28:a8ee:8308/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:61081 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:45149 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000 \n          RX bytes:64271852 (64.2 MB)  TX bytes:7404597 (7.4 MB)\n```\n\n### 抓包\n\n```\nsudo tcpdump -i wlp2s0 -w test.cap\nsudo tcpdump -i any   dst port 30000\n```\n\n## wireshark 分析\n\n### wireshark 过滤\n\n\n#### ip过滤\n```\nip.src eq 10.175.168.182\nip.src == 182.254.78.160\n```\n\n#### 端口过滤\n\n```\ntcp.port == 80   // 不管端口是来源的还是目标的都显示\ntcp.dstport == 80 // 只显tcp协议的目标端口80\ntcp.srcport == 80 // 只显tcp协议的来源端口80\n过滤端口范围\ntcp.port >= 1 and tcp.port <= 80\n```\n\n#### 过滤协议\n\n```\n!arp\nnot arp\nless than 小于 < lt \n```\n\n\n#### http模式过滤\n例子:\nhttp.request.method == “GET”\nhttp.request.method == “POST”\nhttp.request.uri == “/img/logo-edu.gif”\nhttp contains “GET”\nhttp contains “HTTP/1.”\n// GET包\nhttp.request.method == “GET” && http contains “Host: “\nhttp.request.method == “GET” && http contains “User-Agent: “\n// POST包\nhttp.request.method == “POST” && http contains “Host: “\nhttp.request.method == “POST” && http contains “User-Agent: “\n// 响应包\nhttp contains “HTTP/1.1 200 OK” && http contains “Content-Type: “\nhttp contains “HTTP/1.0 200 OK” && http contains “Content-Type: “\n一定包含如下\nContent-Type:\n\n\n### tshark\n\nwireshark的命令行版本\n\ndump成格式化的文件\n```\nsudo tshark -T pdml\n\n<packet>\n  <proto name=\"geninfo\" pos=\"0\" showname=\"General information\" size=\"62\">\n    <field name=\"num\" pos=\"0\" show=\"809\" showname=\"Number\" value=\"329\" size=\"62\"/>\n    <field name=\"len\" pos=\"0\" show=\"62\" showname=\"Frame Length\" value=\"3e\" size=\"62\"/>\n    <field name=\"caplen\" pos=\"0\" show=\"62\" showname=\"Captured Length\" value=\"3e\" size=\"62\"/>\n    <field name=\"timestamp\" pos=\"0\" show=\"Jan 16, 2018 17:00:58.821155665 CST\" showname=\"Captured Time\" value=\"1516093258.821155665\" size=\"62\"/>\n  </proto>\n  <proto name=\"frame\" showname=\"Frame 809: 62 bytes on wire (496 bits), 62 bytes captured (496 bits) on interface 0\" size=\"62\" pos=\"0\">\n    <field name=\"frame.interface_id\" showname=\"Interface id: 0 (eno1)\" size=\"0\" pos=\"0\" show=\"0\"/>\n    <field name=\"frame.encap_type\" showname=\"Encapsulation type: Ethernet (1)\" size=\"0\" pos=\"0\" show=\"1\"/>\n    <field name=\"frame.time\" showname=\"Arrival Time: Jan 16, 2018 17:00:58.821155665 CST\" size=\"0\" pos=\"0\" show=\"Jan 16, 2018 17:00:58.821155665 CST\"/>\n    <field name=\"frame.offset_shift\" showname=\"Time shift for this packet: 0.000000000 seconds\" size=\"0\" pos=\"0\" show=\"0.000000000\"/>\n    <field name=\"frame.time_epoch\" showname=\"Epoch Time: 1516093258.821155665 seconds\" size=\"0\" pos=\"0\" show=\"1516093258.821155665\"/>\n    <field name=\"frame.time_delta\" showname=\"Time delta from previous captured frame: 0.141310248 seconds\" size=\"0\" pos=\"0\" show=\"0.141310248\"/>\n    <field name=\"frame.time_delta_displayed\" showname=\"Time delta from previous displayed frame: 0.141310248 seconds\" size=\"0\" pos=\"0\" show=\"0.141310248\"/>\n    <field name=\"frame.time_relative\" showname=\"Time since reference or first frame: 65.066083767 seconds\" size=\"0\" pos=\"0\" show=\"65.066083767\"/>\n    <field name=\"frame.number\" showname=\"Frame Number: 809\" size=\"0\" pos=\"0\" show=\"809\"/>\n    <field name=\"frame.len\" showname=\"Frame Length: 62 bytes (496 bits)\" size=\"0\" pos=\"0\" show=\"62\"/>\n    <field name=\"frame.cap_len\" showname=\"Capture Length: 62 bytes (496 bits)\" size=\"0\" pos=\"0\" show=\"62\"/>\n    <field name=\"frame.marked\" showname=\"Frame is marked: False\" size=\"0\" pos=\"0\" show=\"0\"/>\n    <field name=\"frame.ignored\" showname=\"Frame is ignored: False\" size=\"0\" pos=\"0\" show=\"0\"/>\n    <field name=\"frame.protocols\" showname=\"Protocols in frame: eth:ethertype:ip:udp:hsrp\" size=\"0\" pos=\"0\" show=\"eth:ethertype:ip:udp:hsrp\"/>\n  </proto>\n  <proto name=\"eth\" showname=\"Ethernet II, Src: All-HSRP-routers_0f (00:00:0c:07:ac:0f), Dst: IPv4mcast_02 (01:00:5e:00:00:02)\" size=\"14\" pos=\"0\">\n    <field name=\"eth.dst\" showname=\"Destination: IPv4mcast_02 (01:00:5e:00:00:02)\" size=\"6\" pos=\"0\" show=\"01:00:5e:00:00:02\" value=\"01005e000002\">\n      <field name=\"eth.dst_resolved\" showname=\"Destination (resolved): IPv4mcast_02\" hide=\"yes\" size=\"6\" pos=\"0\" show=\"IPv4mcast_02\" value=\"01005e000002\"/>\n      <field name=\"eth.addr\" showname=\"Address: IPv4mcast_02 (01:00:5e:00:00:02)\" size=\"6\" pos=\"0\" show=\"01:00:5e:00:00:02\" value=\"01005e000002\"/>\n      <field name=\"eth.addr_resolved\" showname=\"Address (resolved): IPv4mcast_02\" hide=\"yes\" size=\"6\" pos=\"0\" show=\"IPv4mcast_02\" value=\"01005e000002\"/>\n      <field name=\"eth.lg\" showname=\".... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)\" size=\"3\" pos=\"0\" show=\"0\" value=\"0\" unmaskedvalue=\"01005e\"/>\n      <field name=\"eth.ig\" showname=\".... ...1 .... .... .... .... = IG bit: Group address (multicast/broadcast)\" size=\"3\" pos=\"0\" show=\"1\" value=\"1\" unmaskedvalue=\"01005e\"/>\n    </field>\n    <field name=\"eth.src\" showname=\"Source: All-HSRP-routers_0f (00:00:0c:07:ac:0f)\" size=\"6\" pos=\"6\" show=\"00:00:0c:07:ac:0f\" value=\"00000c07ac0f\">\n      <field name=\"eth.src_resolved\" showname=\"Source (resolved): All-HSRP-routers_0f\" hide=\"yes\" size=\"6\" pos=\"6\" show=\"All-HSRP-routers_0f\" value=\"00000c07ac0f\"/>\n      <field name=\"eth.addr\" showname=\"Address: All-HSRP-routers_0f (00:00:0c:07:ac:0f)\" size=\"6\" pos=\"6\" show=\"00:00:0c:07:ac:0f\" value=\"00000c07ac0f\"/>\n      <field name=\"eth.addr_resolved\" showname=\"Address (resolved): All-HSRP-routers_0f\" hide=\"yes\" size=\"6\" pos=\"6\" show=\"All-HSRP-routers_0f\" value=\"00000c07ac0f\"/>\n      <field name=\"eth.lg\" showname=\".... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)\" size=\"3\" pos=\"6\" show=\"0\" value=\"0\" unmaskedvalue=\"00000c\"/>\n      <field name=\"eth.ig\" showname=\".... ...0 .... .... .... .... = IG bit: Individual address (unicast)\" size=\"3\" pos=\"6\" show=\"0\" value=\"0\" unmaskedvalue=\"00000c\"/>\n    </field>\n    <field name=\"eth.type\" showname=\"Type: IPv4 (0x0800)\" size=\"2\" pos=\"12\" show=\"0x00000800\" value=\"0800\"/>\n  </proto>\n  <proto name=\"ip\" showname=\"Internet Protocol Version 4, Src: 100.80.192.3, Dst: 224.0.0.2\" size=\"20\" pos=\"14\">\n    <field name=\"ip.version\" showname=\"0100 .... = Version: 4\" size=\"1\" pos=\"14\" show=\"4\" value=\"4\" unmaskedvalue=\"45\"/>\n    <field name=\"ip.hdr_len\" showname=\".... 0101 = Header Length: 20 bytes (5)\" size=\"1\" pos=\"14\" show=\"20\" value=\"45\"/>\n    <field name=\"ip.dsfield\" showname=\"Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)\" size=\"1\" pos=\"15\" show=\"0x00000000\" value=\"00\">\n      <field name=\"ip.dsfield.dscp\" showname=\"0000 00.. = Differentiated Services Codepoint: Default (0)\" size=\"1\" pos=\"15\" show=\"0\" value=\"0\" unmaskedvalue=\"00\"/>\n      <field name=\"ip.dsfield.ecn\" showname=\".... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)\" size=\"1\" pos=\"15\" show=\"0\" value=\"0\" unmaskedvalue=\"00\"/>\n    </field>\n    <field name=\"ip.len\" showname=\"Total Length: 48\" size=\"2\" pos=\"16\" show=\"48\" value=\"0030\"/>\n    <field name=\"ip.id\" showname=\"Identification: 0x0000 (0)\" size=\"2\" pos=\"18\" show=\"0x00000000\" value=\"0000\"/>\n    <field name=\"ip.flags\" showname=\"Flags: 0x00\" size=\"1\" pos=\"20\" show=\"0x00000000\" value=\"00\">\n      <field name=\"ip.flags.rb\" showname=\"0... .... = Reserved bit: Not set\" size=\"1\" pos=\"20\" show=\"0\" value=\"00\"/>\n      <field name=\"ip.flags.df\" showname=\".0.. .... = Don&#x27;t fragment: Not set\" size=\"1\" pos=\"20\" show=\"0\" value=\"00\"/>\n      <field name=\"ip.flags.mf\" showname=\"..0. .... = More fragments: Not set\" size=\"1\" pos=\"20\" show=\"0\" value=\"00\"/>\n    </field>\n    <field name=\"ip.frag_offset\" showname=\"Fragment offset: 0\" size=\"2\" pos=\"20\" show=\"0\" value=\"0000\"/>\n    <field name=\"ip.ttl\" showname=\"Time to live: 1\" size=\"1\" pos=\"22\" show=\"1\" value=\"01\"/>\n    <field name=\"ip.proto\" showname=\"Protocol: UDP (17)\" size=\"1\" pos=\"23\" show=\"17\" value=\"11\"/>\n    <field name=\"ip.checksum\" showname=\"Header checksum: 0xb567 [validation disabled]\" size=\"2\" pos=\"24\" show=\"0x0000b567\" value=\"b567\"/>\n    <field name=\"ip.checksum.status\" showname=\"Header checksum status: Unverified\" size=\"0\" pos=\"24\" show=\"2\"/>\n    <field name=\"ip.src\" showname=\"Source: 100.80.192.3\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.addr\" showname=\"Source or Destination Address: 100.80.192.3\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.src_host\" showname=\"Source Host: 100.80.192.3\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.host\" showname=\"Source or Destination Host: 100.80.192.3\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"100.80.192.3\" value=\"6450c003\"/>\n    <field name=\"ip.dst\" showname=\"Destination: 224.0.0.2\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"ip.addr\" showname=\"Source or Destination Address: 224.0.0.2\" hide=\"yes\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"ip.dst_host\" showname=\"Destination Host: 224.0.0.2\" hide=\"yes\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"ip.host\" showname=\"Source or Destination Host: 224.0.0.2\" hide=\"yes\" size=\"4\" pos=\"30\" show=\"224.0.0.2\" value=\"e0000002\"/>\n    <field name=\"\" show=\"Source GeoIP: AS18403 The Corporation for Financing &amp; Promoting Technology\" size=\"4\" pos=\"26\" value=\"6450c003\">\n      <field name=\"ip.geoip.src_asnum\" showname=\"Source GeoIP AS Number: AS18403 The Corporation for Financing &amp; Promoting Technology\" size=\"4\" pos=\"26\" show=\"AS18403 The Corporation for Financing &amp; Promoting Technology\" value=\"6450c003\"/>\n      <field name=\"ip.geoip.asnum\" showname=\"Source or Destination GeoIP AS Number: AS18403 The Corporation for Financing &amp; Promoting Technology\" hide=\"yes\" size=\"4\" pos=\"26\" show=\"AS18403 The Corporation for Financing &amp; Promoting Technology\" value=\"6450c003\"/>\n    </field>\n    <field name=\"\" show=\"Destination GeoIP: Unknown\" size=\"4\" pos=\"30\" value=\"e0000002\"/>\n  </proto>\n  <proto name=\"udp\" showname=\"User Datagram Protocol, Src Port: 1985, Dst Port: 1985\" size=\"8\" pos=\"34\">\n    <field name=\"udp.srcport\" showname=\"Source Port: 1985\" size=\"2\" pos=\"34\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.dstport\" showname=\"Destination Port: 1985\" size=\"2\" pos=\"36\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.port\" showname=\"Source or Destination Port: 1985\" hide=\"yes\" size=\"2\" pos=\"34\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.port\" showname=\"Source or Destination Port: 1985\" hide=\"yes\" size=\"2\" pos=\"36\" show=\"1985\" value=\"07c1\"/>\n    <field name=\"udp.length\" showname=\"Length: 28\" size=\"2\" pos=\"38\" show=\"28\" value=\"001c\"/>\n    <field name=\"udp.checksum\" showname=\"Checksum: 0x5825 [unverified]\" size=\"2\" pos=\"40\" show=\"0x00005825\" value=\"5825\"/>\n    <field name=\"udp.checksum.status\" showname=\"Checksum Status: Unverified\" size=\"0\" pos=\"40\" show=\"2\"/>\n    <field name=\"udp.stream\" showname=\"Stream index: 2\" size=\"0\" pos=\"42\" show=\"2\"/>\n  </proto>\n  <proto name=\"hsrp\" showname=\"Cisco Hot Standby Router Protocol\" size=\"20\" pos=\"42\">\n    <field name=\"hsrp.version\" showname=\"Version: 0\" size=\"1\" pos=\"42\" show=\"0\" value=\"00\"/>\n    <field name=\"hsrp.opcode\" showname=\"Op Code: Hello (0)\" size=\"1\" pos=\"43\" show=\"0\" value=\"00\"/>\n    <field name=\"hsrp.state\" showname=\"State: Active (16)\" size=\"1\" pos=\"44\" show=\"16\" value=\"10\"/>\n    <field name=\"hsrp.hellotime\" showname=\"Hellotime: Default (3)\" size=\"1\" pos=\"45\" show=\"3\" value=\"03\"/>\n    <field name=\"hsrp.holdtime\" showname=\"Holdtime: Default (10)\" size=\"1\" pos=\"46\" show=\"10\" value=\"0a\"/>\n    <field name=\"hsrp.priority\" showname=\"Priority: 150\" size=\"1\" pos=\"47\" show=\"150\" value=\"96\"/>\n    <field name=\"hsrp.group\" showname=\"Group: 15\" size=\"1\" pos=\"48\" show=\"15\" value=\"0f\"/>\n    <field name=\"hsrp.reserved\" showname=\"Reserved: 0\" size=\"1\" pos=\"49\" show=\"0\" value=\"00\"/>\n    <field name=\"hsrp.auth_data\" showname=\"Authentication Data: Default (cisco)\" size=\"8\" pos=\"50\" show=\"cisco\" value=\"636973636f000000\"/>\n    <field name=\"hsrp.virt_ip\" showname=\"Virtual IP Address: 100.80.192.1\" size=\"4\" pos=\"58\" show=\"100.80.192.1\" value=\"6450c001\"/>\n  </proto>\n</packet>\n\n```\n\n输出指定的field\n\n```\ntshark -r cap-2018-01-16.cap   -T fields -E separator=,  -e frame.number -e ip.src -e ip.dst -e data.data\n```\n\n","slug":"cap","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2018-01-16T09:03:33.198Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6a000cjh4kr8t3vx0w","content":"<h2 id=\"基础信息\"><a href=\"#基础信息\" class=\"headerlink\" title=\"基础信息\"></a>基础信息</h2><h3 id=\"查看网卡\"><a href=\"#查看网卡\" class=\"headerlink\" title=\"查看网卡\"></a>查看网卡</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  ifconfig </span><br><span class=\"line\">eno1      Link encap:Ethernet  HWaddr ec:f4:bb:48:fb:d0  </span><br><span class=\"line\">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class=\"line\">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class=\"line\">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class=\"line\">          collisions:0 txqueuelen:1000 </span><br><span class=\"line\">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class=\"line\">          Interrupt:20 Memory:f7c00000-f7c20000 </span><br><span class=\"line\"></span><br><span class=\"line\">lo        Link encap:Local Loopback  </span><br><span class=\"line\">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class=\"line\">          inet6 addr: ::1/128 Scope:Host</span><br><span class=\"line\">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class=\"line\">          RX packets:20706 errors:0 dropped:0 overruns:0 frame:0</span><br><span class=\"line\">          TX packets:20706 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class=\"line\">          collisions:0 txqueuelen:1 </span><br><span class=\"line\">          RX bytes:8737590 (8.7 MB)  TX bytes:8737590 (8.7 MB)</span><br><span class=\"line\"></span><br><span class=\"line\">wlp2s0    Link encap:Ethernet  HWaddr 18:cf:5e:1f:c1:1b  </span><br><span class=\"line\">          inet addr:192.168.10.164  Bcast:192.168.10.255  Mask:255.255.255.0</span><br><span class=\"line\">          inet6 addr: fe80::cae2:9f28:a8ee:8308/64 Scope:Link</span><br><span class=\"line\">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class=\"line\">          RX packets:61081 errors:0 dropped:0 overruns:0 frame:0</span><br><span class=\"line\">          TX packets:45149 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class=\"line\">          collisions:0 txqueuelen:1000 </span><br><span class=\"line\">          RX bytes:64271852 (64.2 MB)  TX bytes:7404597 (7.4 MB)</span><br></pre></td></tr></table></figure>\n<h3 id=\"抓包\"><a href=\"#抓包\" class=\"headerlink\" title=\"抓包\"></a>抓包</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tcpdump -i wlp2s0 -w test.cap</span><br><span class=\"line\">sudo tcpdump -i any   dst port 30000</span><br></pre></td></tr></table></figure>\n<h2 id=\"wireshark-分析\"><a href=\"#wireshark-分析\" class=\"headerlink\" title=\"wireshark 分析\"></a>wireshark 分析</h2><h3 id=\"wireshark-过滤\"><a href=\"#wireshark-过滤\" class=\"headerlink\" title=\"wireshark 过滤\"></a>wireshark 过滤</h3><h4 id=\"ip过滤\"><a href=\"#ip过滤\" class=\"headerlink\" title=\"ip过滤\"></a>ip过滤</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip.src eq 10.175.168.182</span><br><span class=\"line\">ip.src == 182.254.78.160</span><br></pre></td></tr></table></figure>\n<h4 id=\"端口过滤\"><a href=\"#端口过滤\" class=\"headerlink\" title=\"端口过滤\"></a>端口过滤</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcp.port == 80   // 不管端口是来源的还是目标的都显示</span><br><span class=\"line\">tcp.dstport == 80 // 只显tcp协议的目标端口80</span><br><span class=\"line\">tcp.srcport == 80 // 只显tcp协议的来源端口80</span><br><span class=\"line\">过滤端口范围</span><br><span class=\"line\">tcp.port &gt;= 1 and tcp.port &lt;= 80</span><br></pre></td></tr></table></figure>\n<h4 id=\"过滤协议\"><a href=\"#过滤协议\" class=\"headerlink\" title=\"过滤协议\"></a>过滤协议</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!arp</span><br><span class=\"line\">not arp</span><br><span class=\"line\">less than 小于 &lt; lt</span><br></pre></td></tr></table></figure>\n<h4 id=\"http模式过滤\"><a href=\"#http模式过滤\" class=\"headerlink\" title=\"http模式过滤\"></a>http模式过滤</h4><p>例子:<br>http.request.method == “GET”<br>http.request.method == “POST”<br>http.request.uri == “/img/logo-edu.gif”<br>http contains “GET”<br>http contains “HTTP/1.”<br>// GET包<br>http.request.method == “GET” &amp;&amp; http contains “Host: “<br>http.request.method == “GET” &amp;&amp; http contains “User-Agent: “<br>// POST包<br>http.request.method == “POST” &amp;&amp; http contains “Host: “<br>http.request.method == “POST” &amp;&amp; http contains “User-Agent: “<br>// 响应包<br>http contains “HTTP/1.1 200 OK” &amp;&amp; http contains “Content-Type: “<br>http contains “HTTP/1.0 200 OK” &amp;&amp; http contains “Content-Type: “<br>一定包含如下<br>Content-Type:</p>\n<h3 id=\"tshark\"><a href=\"#tshark\" class=\"headerlink\" title=\"tshark\"></a>tshark</h3><p>wireshark的命令行版本</p>\n<p>dump成格式化的文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tshark -T pdml</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;packet&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;geninfo&quot; pos=&quot;0&quot; showname=&quot;General information&quot; size=&quot;62&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;num&quot; pos=&quot;0&quot; show=&quot;809&quot; showname=&quot;Number&quot; value=&quot;329&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;len&quot; pos=&quot;0&quot; show=&quot;62&quot; showname=&quot;Frame Length&quot; value=&quot;3e&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;caplen&quot; pos=&quot;0&quot; show=&quot;62&quot; showname=&quot;Captured Length&quot; value=&quot;3e&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;timestamp&quot; pos=&quot;0&quot; show=&quot;Jan 16, 2018 17:00:58.821155665 CST&quot; showname=&quot;Captured Time&quot; value=&quot;1516093258.821155665&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;frame&quot; showname=&quot;Frame 809: 62 bytes on wire (496 bits), 62 bytes captured (496 bits) on interface 0&quot; size=&quot;62&quot; pos=&quot;0&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.interface_id&quot; showname=&quot;Interface id: 0 (eno1)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.encap_type&quot; showname=&quot;Encapsulation type: Ethernet (1)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time&quot; showname=&quot;Arrival Time: Jan 16, 2018 17:00:58.821155665 CST&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;Jan 16, 2018 17:00:58.821155665 CST&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.offset_shift&quot; showname=&quot;Time shift for this packet: 0.000000000 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0.000000000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_epoch&quot; showname=&quot;Epoch Time: 1516093258.821155665 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;1516093258.821155665&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_delta&quot; showname=&quot;Time delta from previous captured frame: 0.141310248 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0.141310248&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_delta_displayed&quot; showname=&quot;Time delta from previous displayed frame: 0.141310248 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0.141310248&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_relative&quot; showname=&quot;Time since reference or first frame: 65.066083767 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;65.066083767&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.number&quot; showname=&quot;Frame Number: 809&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;809&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.len&quot; showname=&quot;Frame Length: 62 bytes (496 bits)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.cap_len&quot; showname=&quot;Capture Length: 62 bytes (496 bits)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.marked&quot; showname=&quot;Frame is marked: False&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.ignored&quot; showname=&quot;Frame is ignored: False&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.protocols&quot; showname=&quot;Protocols in frame: eth:ethertype:ip:udp:hsrp&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;eth:ethertype:ip:udp:hsrp&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;eth&quot; showname=&quot;Ethernet II, Src: All-HSRP-routers_0f (00:00:0c:07:ac:0f), Dst: IPv4mcast_02 (01:00:5e:00:00:02)&quot; size=&quot;14&quot; pos=&quot;0&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;eth.dst&quot; showname=&quot;Destination: IPv4mcast_02 (01:00:5e:00:00:02)&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;01:00:5e:00:00:02&quot; value=&quot;01005e000002&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.dst_resolved&quot; showname=&quot;Destination (resolved): IPv4mcast_02&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;IPv4mcast_02&quot; value=&quot;01005e000002&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr&quot; showname=&quot;Address: IPv4mcast_02 (01:00:5e:00:00:02)&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;01:00:5e:00:00:02&quot; value=&quot;01005e000002&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr_resolved&quot; showname=&quot;Address (resolved): IPv4mcast_02&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;IPv4mcast_02&quot; value=&quot;01005e000002&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.lg&quot; showname=&quot;.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)&quot; size=&quot;3&quot; pos=&quot;0&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;01005e&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.ig&quot; showname=&quot;.... ...1 .... .... .... .... = IG bit: Group address (multicast/broadcast)&quot; size=&quot;3&quot; pos=&quot;0&quot; show=&quot;1&quot; value=&quot;1&quot; unmaskedvalue=&quot;01005e&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;eth.src&quot; showname=&quot;Source: All-HSRP-routers_0f (00:00:0c:07:ac:0f)&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;00:00:0c:07:ac:0f&quot; value=&quot;00000c07ac0f&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.src_resolved&quot; showname=&quot;Source (resolved): All-HSRP-routers_0f&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;All-HSRP-routers_0f&quot; value=&quot;00000c07ac0f&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr&quot; showname=&quot;Address: All-HSRP-routers_0f (00:00:0c:07:ac:0f)&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;00:00:0c:07:ac:0f&quot; value=&quot;00000c07ac0f&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr_resolved&quot; showname=&quot;Address (resolved): All-HSRP-routers_0f&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;All-HSRP-routers_0f&quot; value=&quot;00000c07ac0f&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.lg&quot; showname=&quot;.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)&quot; size=&quot;3&quot; pos=&quot;6&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00000c&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.ig&quot; showname=&quot;.... ...0 .... .... .... .... = IG bit: Individual address (unicast)&quot; size=&quot;3&quot; pos=&quot;6&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00000c&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;eth.type&quot; showname=&quot;Type: IPv4 (0x0800)&quot; size=&quot;2&quot; pos=&quot;12&quot; show=&quot;0x00000800&quot; value=&quot;0800&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;ip&quot; showname=&quot;Internet Protocol Version 4, Src: 100.80.192.3, Dst: 224.0.0.2&quot; size=&quot;20&quot; pos=&quot;14&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.version&quot; showname=&quot;0100 .... = Version: 4&quot; size=&quot;1&quot; pos=&quot;14&quot; show=&quot;4&quot; value=&quot;4&quot; unmaskedvalue=&quot;45&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.hdr_len&quot; showname=&quot;.... 0101 = Header Length: 20 bytes (5)&quot; size=&quot;1&quot; pos=&quot;14&quot; show=&quot;20&quot; value=&quot;45&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.dsfield&quot; showname=&quot;Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)&quot; size=&quot;1&quot; pos=&quot;15&quot; show=&quot;0x00000000&quot; value=&quot;00&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.dsfield.dscp&quot; showname=&quot;0000 00.. = Differentiated Services Codepoint: Default (0)&quot; size=&quot;1&quot; pos=&quot;15&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.dsfield.ecn&quot; showname=&quot;.... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)&quot; size=&quot;1&quot; pos=&quot;15&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.len&quot; showname=&quot;Total Length: 48&quot; size=&quot;2&quot; pos=&quot;16&quot; show=&quot;48&quot; value=&quot;0030&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.id&quot; showname=&quot;Identification: 0x0000 (0)&quot; size=&quot;2&quot; pos=&quot;18&quot; show=&quot;0x00000000&quot; value=&quot;0000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.flags&quot; showname=&quot;Flags: 0x00&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0x00000000&quot; value=&quot;00&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.flags.rb&quot; showname=&quot;0... .... = Reserved bit: Not set&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.flags.df&quot; showname=&quot;.0.. .... = Don&amp;#x27;t fragment: Not set&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.flags.mf&quot; showname=&quot;..0. .... = More fragments: Not set&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.frag_offset&quot; showname=&quot;Fragment offset: 0&quot; size=&quot;2&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;0000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.ttl&quot; showname=&quot;Time to live: 1&quot; size=&quot;1&quot; pos=&quot;22&quot; show=&quot;1&quot; value=&quot;01&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.proto&quot; showname=&quot;Protocol: UDP (17)&quot; size=&quot;1&quot; pos=&quot;23&quot; show=&quot;17&quot; value=&quot;11&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.checksum&quot; showname=&quot;Header checksum: 0xb567 [validation disabled]&quot; size=&quot;2&quot; pos=&quot;24&quot; show=&quot;0x0000b567&quot; value=&quot;b567&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.checksum.status&quot; showname=&quot;Header checksum status: Unverified&quot; size=&quot;0&quot; pos=&quot;24&quot; show=&quot;2&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.src&quot; showname=&quot;Source: 100.80.192.3&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.addr&quot; showname=&quot;Source or Destination Address: 100.80.192.3&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.src_host&quot; showname=&quot;Source Host: 100.80.192.3&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.host&quot; showname=&quot;Source or Destination Host: 100.80.192.3&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.dst&quot; showname=&quot;Destination: 224.0.0.2&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.addr&quot; showname=&quot;Source or Destination Address: 224.0.0.2&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.dst_host&quot; showname=&quot;Destination Host: 224.0.0.2&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.host&quot; showname=&quot;Source or Destination Host: 224.0.0.2&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;&quot; show=&quot;Source GeoIP: AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; size=&quot;4&quot; pos=&quot;26&quot; value=&quot;6450c003&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.geoip.src_asnum&quot; showname=&quot;Source GeoIP AS Number: AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.geoip.asnum&quot; showname=&quot;Source or Destination GeoIP AS Number: AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;&quot; show=&quot;Destination GeoIP: Unknown&quot; size=&quot;4&quot; pos=&quot;30&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;udp&quot; showname=&quot;User Datagram Protocol, Src Port: 1985, Dst Port: 1985&quot; size=&quot;8&quot; pos=&quot;34&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.srcport&quot; showname=&quot;Source Port: 1985&quot; size=&quot;2&quot; pos=&quot;34&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.dstport&quot; showname=&quot;Destination Port: 1985&quot; size=&quot;2&quot; pos=&quot;36&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.port&quot; showname=&quot;Source or Destination Port: 1985&quot; hide=&quot;yes&quot; size=&quot;2&quot; pos=&quot;34&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.port&quot; showname=&quot;Source or Destination Port: 1985&quot; hide=&quot;yes&quot; size=&quot;2&quot; pos=&quot;36&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.length&quot; showname=&quot;Length: 28&quot; size=&quot;2&quot; pos=&quot;38&quot; show=&quot;28&quot; value=&quot;001c&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.checksum&quot; showname=&quot;Checksum: 0x5825 [unverified]&quot; size=&quot;2&quot; pos=&quot;40&quot; show=&quot;0x00005825&quot; value=&quot;5825&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.checksum.status&quot; showname=&quot;Checksum Status: Unverified&quot; size=&quot;0&quot; pos=&quot;40&quot; show=&quot;2&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.stream&quot; showname=&quot;Stream index: 2&quot; size=&quot;0&quot; pos=&quot;42&quot; show=&quot;2&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;hsrp&quot; showname=&quot;Cisco Hot Standby Router Protocol&quot; size=&quot;20&quot; pos=&quot;42&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.version&quot; showname=&quot;Version: 0&quot; size=&quot;1&quot; pos=&quot;42&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.opcode&quot; showname=&quot;Op Code: Hello (0)&quot; size=&quot;1&quot; pos=&quot;43&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.state&quot; showname=&quot;State: Active (16)&quot; size=&quot;1&quot; pos=&quot;44&quot; show=&quot;16&quot; value=&quot;10&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.hellotime&quot; showname=&quot;Hellotime: Default (3)&quot; size=&quot;1&quot; pos=&quot;45&quot; show=&quot;3&quot; value=&quot;03&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.holdtime&quot; showname=&quot;Holdtime: Default (10)&quot; size=&quot;1&quot; pos=&quot;46&quot; show=&quot;10&quot; value=&quot;0a&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.priority&quot; showname=&quot;Priority: 150&quot; size=&quot;1&quot; pos=&quot;47&quot; show=&quot;150&quot; value=&quot;96&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.group&quot; showname=&quot;Group: 15&quot; size=&quot;1&quot; pos=&quot;48&quot; show=&quot;15&quot; value=&quot;0f&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.reserved&quot; showname=&quot;Reserved: 0&quot; size=&quot;1&quot; pos=&quot;49&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.auth_data&quot; showname=&quot;Authentication Data: Default (cisco)&quot; size=&quot;8&quot; pos=&quot;50&quot; show=&quot;cisco&quot; value=&quot;636973636f000000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.virt_ip&quot; showname=&quot;Virtual IP Address: 100.80.192.1&quot; size=&quot;4&quot; pos=&quot;58&quot; show=&quot;100.80.192.1&quot; value=&quot;6450c001&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">&lt;/packet&gt;</span><br></pre></td></tr></table></figure></p>\n<p>输出指定的field</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tshark -r cap-2018-01-16.cap   -T fields -E separator=,  -e frame.number -e ip.src -e ip.dst -e data.data</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"基础信息\"><a href=\"#基础信息\" class=\"headerlink\" title=\"基础信息\"></a>基础信息</h2><h3 id=\"查看网卡\"><a href=\"#查看网卡\" class=\"headerlink\" title=\"查看网卡\"></a>查看网卡</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  ifconfig </span><br><span class=\"line\">eno1      Link encap:Ethernet  HWaddr ec:f4:bb:48:fb:d0  </span><br><span class=\"line\">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class=\"line\">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class=\"line\">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class=\"line\">          collisions:0 txqueuelen:1000 </span><br><span class=\"line\">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class=\"line\">          Interrupt:20 Memory:f7c00000-f7c20000 </span><br><span class=\"line\"></span><br><span class=\"line\">lo        Link encap:Local Loopback  </span><br><span class=\"line\">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class=\"line\">          inet6 addr: ::1/128 Scope:Host</span><br><span class=\"line\">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class=\"line\">          RX packets:20706 errors:0 dropped:0 overruns:0 frame:0</span><br><span class=\"line\">          TX packets:20706 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class=\"line\">          collisions:0 txqueuelen:1 </span><br><span class=\"line\">          RX bytes:8737590 (8.7 MB)  TX bytes:8737590 (8.7 MB)</span><br><span class=\"line\"></span><br><span class=\"line\">wlp2s0    Link encap:Ethernet  HWaddr 18:cf:5e:1f:c1:1b  </span><br><span class=\"line\">          inet addr:192.168.10.164  Bcast:192.168.10.255  Mask:255.255.255.0</span><br><span class=\"line\">          inet6 addr: fe80::cae2:9f28:a8ee:8308/64 Scope:Link</span><br><span class=\"line\">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class=\"line\">          RX packets:61081 errors:0 dropped:0 overruns:0 frame:0</span><br><span class=\"line\">          TX packets:45149 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class=\"line\">          collisions:0 txqueuelen:1000 </span><br><span class=\"line\">          RX bytes:64271852 (64.2 MB)  TX bytes:7404597 (7.4 MB)</span><br></pre></td></tr></table></figure>\n<h3 id=\"抓包\"><a href=\"#抓包\" class=\"headerlink\" title=\"抓包\"></a>抓包</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tcpdump -i wlp2s0 -w test.cap</span><br><span class=\"line\">sudo tcpdump -i any   dst port 30000</span><br></pre></td></tr></table></figure>\n<h2 id=\"wireshark-分析\"><a href=\"#wireshark-分析\" class=\"headerlink\" title=\"wireshark 分析\"></a>wireshark 分析</h2><h3 id=\"wireshark-过滤\"><a href=\"#wireshark-过滤\" class=\"headerlink\" title=\"wireshark 过滤\"></a>wireshark 过滤</h3><h4 id=\"ip过滤\"><a href=\"#ip过滤\" class=\"headerlink\" title=\"ip过滤\"></a>ip过滤</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip.src eq 10.175.168.182</span><br><span class=\"line\">ip.src == 182.254.78.160</span><br></pre></td></tr></table></figure>\n<h4 id=\"端口过滤\"><a href=\"#端口过滤\" class=\"headerlink\" title=\"端口过滤\"></a>端口过滤</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcp.port == 80   // 不管端口是来源的还是目标的都显示</span><br><span class=\"line\">tcp.dstport == 80 // 只显tcp协议的目标端口80</span><br><span class=\"line\">tcp.srcport == 80 // 只显tcp协议的来源端口80</span><br><span class=\"line\">过滤端口范围</span><br><span class=\"line\">tcp.port &gt;= 1 and tcp.port &lt;= 80</span><br></pre></td></tr></table></figure>\n<h4 id=\"过滤协议\"><a href=\"#过滤协议\" class=\"headerlink\" title=\"过滤协议\"></a>过滤协议</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!arp</span><br><span class=\"line\">not arp</span><br><span class=\"line\">less than 小于 &lt; lt</span><br></pre></td></tr></table></figure>\n<h4 id=\"http模式过滤\"><a href=\"#http模式过滤\" class=\"headerlink\" title=\"http模式过滤\"></a>http模式过滤</h4><p>例子:<br>http.request.method == “GET”<br>http.request.method == “POST”<br>http.request.uri == “/img/logo-edu.gif”<br>http contains “GET”<br>http contains “HTTP/1.”<br>// GET包<br>http.request.method == “GET” &amp;&amp; http contains “Host: “<br>http.request.method == “GET” &amp;&amp; http contains “User-Agent: “<br>// POST包<br>http.request.method == “POST” &amp;&amp; http contains “Host: “<br>http.request.method == “POST” &amp;&amp; http contains “User-Agent: “<br>// 响应包<br>http contains “HTTP/1.1 200 OK” &amp;&amp; http contains “Content-Type: “<br>http contains “HTTP/1.0 200 OK” &amp;&amp; http contains “Content-Type: “<br>一定包含如下<br>Content-Type:</p>\n<h3 id=\"tshark\"><a href=\"#tshark\" class=\"headerlink\" title=\"tshark\"></a>tshark</h3><p>wireshark的命令行版本</p>\n<p>dump成格式化的文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tshark -T pdml</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;packet&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;geninfo&quot; pos=&quot;0&quot; showname=&quot;General information&quot; size=&quot;62&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;num&quot; pos=&quot;0&quot; show=&quot;809&quot; showname=&quot;Number&quot; value=&quot;329&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;len&quot; pos=&quot;0&quot; show=&quot;62&quot; showname=&quot;Frame Length&quot; value=&quot;3e&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;caplen&quot; pos=&quot;0&quot; show=&quot;62&quot; showname=&quot;Captured Length&quot; value=&quot;3e&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;timestamp&quot; pos=&quot;0&quot; show=&quot;Jan 16, 2018 17:00:58.821155665 CST&quot; showname=&quot;Captured Time&quot; value=&quot;1516093258.821155665&quot; size=&quot;62&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;frame&quot; showname=&quot;Frame 809: 62 bytes on wire (496 bits), 62 bytes captured (496 bits) on interface 0&quot; size=&quot;62&quot; pos=&quot;0&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.interface_id&quot; showname=&quot;Interface id: 0 (eno1)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.encap_type&quot; showname=&quot;Encapsulation type: Ethernet (1)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time&quot; showname=&quot;Arrival Time: Jan 16, 2018 17:00:58.821155665 CST&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;Jan 16, 2018 17:00:58.821155665 CST&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.offset_shift&quot; showname=&quot;Time shift for this packet: 0.000000000 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0.000000000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_epoch&quot; showname=&quot;Epoch Time: 1516093258.821155665 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;1516093258.821155665&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_delta&quot; showname=&quot;Time delta from previous captured frame: 0.141310248 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0.141310248&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_delta_displayed&quot; showname=&quot;Time delta from previous displayed frame: 0.141310248 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0.141310248&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.time_relative&quot; showname=&quot;Time since reference or first frame: 65.066083767 seconds&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;65.066083767&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.number&quot; showname=&quot;Frame Number: 809&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;809&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.len&quot; showname=&quot;Frame Length: 62 bytes (496 bits)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.cap_len&quot; showname=&quot;Capture Length: 62 bytes (496 bits)&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;62&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.marked&quot; showname=&quot;Frame is marked: False&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.ignored&quot; showname=&quot;Frame is ignored: False&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;0&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;frame.protocols&quot; showname=&quot;Protocols in frame: eth:ethertype:ip:udp:hsrp&quot; size=&quot;0&quot; pos=&quot;0&quot; show=&quot;eth:ethertype:ip:udp:hsrp&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;eth&quot; showname=&quot;Ethernet II, Src: All-HSRP-routers_0f (00:00:0c:07:ac:0f), Dst: IPv4mcast_02 (01:00:5e:00:00:02)&quot; size=&quot;14&quot; pos=&quot;0&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;eth.dst&quot; showname=&quot;Destination: IPv4mcast_02 (01:00:5e:00:00:02)&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;01:00:5e:00:00:02&quot; value=&quot;01005e000002&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.dst_resolved&quot; showname=&quot;Destination (resolved): IPv4mcast_02&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;IPv4mcast_02&quot; value=&quot;01005e000002&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr&quot; showname=&quot;Address: IPv4mcast_02 (01:00:5e:00:00:02)&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;01:00:5e:00:00:02&quot; value=&quot;01005e000002&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr_resolved&quot; showname=&quot;Address (resolved): IPv4mcast_02&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;0&quot; show=&quot;IPv4mcast_02&quot; value=&quot;01005e000002&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.lg&quot; showname=&quot;.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)&quot; size=&quot;3&quot; pos=&quot;0&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;01005e&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.ig&quot; showname=&quot;.... ...1 .... .... .... .... = IG bit: Group address (multicast/broadcast)&quot; size=&quot;3&quot; pos=&quot;0&quot; show=&quot;1&quot; value=&quot;1&quot; unmaskedvalue=&quot;01005e&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;eth.src&quot; showname=&quot;Source: All-HSRP-routers_0f (00:00:0c:07:ac:0f)&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;00:00:0c:07:ac:0f&quot; value=&quot;00000c07ac0f&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.src_resolved&quot; showname=&quot;Source (resolved): All-HSRP-routers_0f&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;All-HSRP-routers_0f&quot; value=&quot;00000c07ac0f&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr&quot; showname=&quot;Address: All-HSRP-routers_0f (00:00:0c:07:ac:0f)&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;00:00:0c:07:ac:0f&quot; value=&quot;00000c07ac0f&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.addr_resolved&quot; showname=&quot;Address (resolved): All-HSRP-routers_0f&quot; hide=&quot;yes&quot; size=&quot;6&quot; pos=&quot;6&quot; show=&quot;All-HSRP-routers_0f&quot; value=&quot;00000c07ac0f&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.lg&quot; showname=&quot;.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)&quot; size=&quot;3&quot; pos=&quot;6&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00000c&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;eth.ig&quot; showname=&quot;.... ...0 .... .... .... .... = IG bit: Individual address (unicast)&quot; size=&quot;3&quot; pos=&quot;6&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00000c&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;eth.type&quot; showname=&quot;Type: IPv4 (0x0800)&quot; size=&quot;2&quot; pos=&quot;12&quot; show=&quot;0x00000800&quot; value=&quot;0800&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;ip&quot; showname=&quot;Internet Protocol Version 4, Src: 100.80.192.3, Dst: 224.0.0.2&quot; size=&quot;20&quot; pos=&quot;14&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.version&quot; showname=&quot;0100 .... = Version: 4&quot; size=&quot;1&quot; pos=&quot;14&quot; show=&quot;4&quot; value=&quot;4&quot; unmaskedvalue=&quot;45&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.hdr_len&quot; showname=&quot;.... 0101 = Header Length: 20 bytes (5)&quot; size=&quot;1&quot; pos=&quot;14&quot; show=&quot;20&quot; value=&quot;45&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.dsfield&quot; showname=&quot;Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)&quot; size=&quot;1&quot; pos=&quot;15&quot; show=&quot;0x00000000&quot; value=&quot;00&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.dsfield.dscp&quot; showname=&quot;0000 00.. = Differentiated Services Codepoint: Default (0)&quot; size=&quot;1&quot; pos=&quot;15&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.dsfield.ecn&quot; showname=&quot;.... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)&quot; size=&quot;1&quot; pos=&quot;15&quot; show=&quot;0&quot; value=&quot;0&quot; unmaskedvalue=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.len&quot; showname=&quot;Total Length: 48&quot; size=&quot;2&quot; pos=&quot;16&quot; show=&quot;48&quot; value=&quot;0030&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.id&quot; showname=&quot;Identification: 0x0000 (0)&quot; size=&quot;2&quot; pos=&quot;18&quot; show=&quot;0x00000000&quot; value=&quot;0000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.flags&quot; showname=&quot;Flags: 0x00&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0x00000000&quot; value=&quot;00&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.flags.rb&quot; showname=&quot;0... .... = Reserved bit: Not set&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.flags.df&quot; showname=&quot;.0.. .... = Don&amp;#x27;t fragment: Not set&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.flags.mf&quot; showname=&quot;..0. .... = More fragments: Not set&quot; size=&quot;1&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.frag_offset&quot; showname=&quot;Fragment offset: 0&quot; size=&quot;2&quot; pos=&quot;20&quot; show=&quot;0&quot; value=&quot;0000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.ttl&quot; showname=&quot;Time to live: 1&quot; size=&quot;1&quot; pos=&quot;22&quot; show=&quot;1&quot; value=&quot;01&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.proto&quot; showname=&quot;Protocol: UDP (17)&quot; size=&quot;1&quot; pos=&quot;23&quot; show=&quot;17&quot; value=&quot;11&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.checksum&quot; showname=&quot;Header checksum: 0xb567 [validation disabled]&quot; size=&quot;2&quot; pos=&quot;24&quot; show=&quot;0x0000b567&quot; value=&quot;b567&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.checksum.status&quot; showname=&quot;Header checksum status: Unverified&quot; size=&quot;0&quot; pos=&quot;24&quot; show=&quot;2&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.src&quot; showname=&quot;Source: 100.80.192.3&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.addr&quot; showname=&quot;Source or Destination Address: 100.80.192.3&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.src_host&quot; showname=&quot;Source Host: 100.80.192.3&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.host&quot; showname=&quot;Source or Destination Host: 100.80.192.3&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;100.80.192.3&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.dst&quot; showname=&quot;Destination: 224.0.0.2&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.addr&quot; showname=&quot;Source or Destination Address: 224.0.0.2&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.dst_host&quot; showname=&quot;Destination Host: 224.0.0.2&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;ip.host&quot; showname=&quot;Source or Destination Host: 224.0.0.2&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;30&quot; show=&quot;224.0.0.2&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;&quot; show=&quot;Source GeoIP: AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; size=&quot;4&quot; pos=&quot;26&quot; value=&quot;6450c003&quot;&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.geoip.src_asnum&quot; showname=&quot;Source GeoIP AS Number: AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">      &lt;field name=&quot;ip.geoip.asnum&quot; showname=&quot;Source or Destination GeoIP AS Number: AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; hide=&quot;yes&quot; size=&quot;4&quot; pos=&quot;26&quot; show=&quot;AS18403 The Corporation for Financing &amp;amp; Promoting Technology&quot; value=&quot;6450c003&quot;/&gt;</span><br><span class=\"line\">    &lt;/field&gt;</span><br><span class=\"line\">    &lt;field name=&quot;&quot; show=&quot;Destination GeoIP: Unknown&quot; size=&quot;4&quot; pos=&quot;30&quot; value=&quot;e0000002&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;udp&quot; showname=&quot;User Datagram Protocol, Src Port: 1985, Dst Port: 1985&quot; size=&quot;8&quot; pos=&quot;34&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.srcport&quot; showname=&quot;Source Port: 1985&quot; size=&quot;2&quot; pos=&quot;34&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.dstport&quot; showname=&quot;Destination Port: 1985&quot; size=&quot;2&quot; pos=&quot;36&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.port&quot; showname=&quot;Source or Destination Port: 1985&quot; hide=&quot;yes&quot; size=&quot;2&quot; pos=&quot;34&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.port&quot; showname=&quot;Source or Destination Port: 1985&quot; hide=&quot;yes&quot; size=&quot;2&quot; pos=&quot;36&quot; show=&quot;1985&quot; value=&quot;07c1&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.length&quot; showname=&quot;Length: 28&quot; size=&quot;2&quot; pos=&quot;38&quot; show=&quot;28&quot; value=&quot;001c&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.checksum&quot; showname=&quot;Checksum: 0x5825 [unverified]&quot; size=&quot;2&quot; pos=&quot;40&quot; show=&quot;0x00005825&quot; value=&quot;5825&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.checksum.status&quot; showname=&quot;Checksum Status: Unverified&quot; size=&quot;0&quot; pos=&quot;40&quot; show=&quot;2&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;udp.stream&quot; showname=&quot;Stream index: 2&quot; size=&quot;0&quot; pos=&quot;42&quot; show=&quot;2&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">  &lt;proto name=&quot;hsrp&quot; showname=&quot;Cisco Hot Standby Router Protocol&quot; size=&quot;20&quot; pos=&quot;42&quot;&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.version&quot; showname=&quot;Version: 0&quot; size=&quot;1&quot; pos=&quot;42&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.opcode&quot; showname=&quot;Op Code: Hello (0)&quot; size=&quot;1&quot; pos=&quot;43&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.state&quot; showname=&quot;State: Active (16)&quot; size=&quot;1&quot; pos=&quot;44&quot; show=&quot;16&quot; value=&quot;10&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.hellotime&quot; showname=&quot;Hellotime: Default (3)&quot; size=&quot;1&quot; pos=&quot;45&quot; show=&quot;3&quot; value=&quot;03&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.holdtime&quot; showname=&quot;Holdtime: Default (10)&quot; size=&quot;1&quot; pos=&quot;46&quot; show=&quot;10&quot; value=&quot;0a&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.priority&quot; showname=&quot;Priority: 150&quot; size=&quot;1&quot; pos=&quot;47&quot; show=&quot;150&quot; value=&quot;96&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.group&quot; showname=&quot;Group: 15&quot; size=&quot;1&quot; pos=&quot;48&quot; show=&quot;15&quot; value=&quot;0f&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.reserved&quot; showname=&quot;Reserved: 0&quot; size=&quot;1&quot; pos=&quot;49&quot; show=&quot;0&quot; value=&quot;00&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.auth_data&quot; showname=&quot;Authentication Data: Default (cisco)&quot; size=&quot;8&quot; pos=&quot;50&quot; show=&quot;cisco&quot; value=&quot;636973636f000000&quot;/&gt;</span><br><span class=\"line\">    &lt;field name=&quot;hsrp.virt_ip&quot; showname=&quot;Virtual IP Address: 100.80.192.1&quot; size=&quot;4&quot; pos=&quot;58&quot; show=&quot;100.80.192.1&quot; value=&quot;6450c001&quot;/&gt;</span><br><span class=\"line\">  &lt;/proto&gt;</span><br><span class=\"line\">&lt;/packet&gt;</span><br></pre></td></tr></table></figure></p>\n<p>输出指定的field</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tshark -r cap-2018-01-16.cap   -T fields -E separator=,  -e frame.number -e ip.src -e ip.dst -e data.data</span><br></pre></td></tr></table></figure>\n"},{"title":"classloader","toc":true,"abbrlink":37818,"_content":"\n### URLClassLoader\n\n>This class loader is used to load classes and resources from a search\n path of URLs referring to both JAR files and directories. Any URL that\n ends with a '/' is assumed to refer to a directory. Otherwise, the URL\n is assumed to refer to a JAR file which will be opened as needed.\n <p>\n The AccessControlContext of the thread that created the instance of\n URLClassLoader will be used when subsequently loading classes and\n resources.\n <p>\n The classes that are loaded are by default granted permission only to\n access the URLs specified when the URLClassLoader was created. \n @author  David Connelly\n @since   1.2\n\n","source":"_drafts/classloader.md","raw":"---\ntitle: classloader\ntags: classloader\ncategory: java\ntoc: true\nabbrlink: 37818\n---\n\n### URLClassLoader\n\n>This class loader is used to load classes and resources from a search\n path of URLs referring to both JAR files and directories. Any URL that\n ends with a '/' is assumed to refer to a directory. Otherwise, the URL\n is assumed to refer to a JAR file which will be opened as needed.\n <p>\n The AccessControlContext of the thread that created the instance of\n URLClassLoader will be used when subsequently loading classes and\n resources.\n <p>\n The classes that are loaded are by default granted permission only to\n access the URLs specified when the URLClassLoader was created. \n @author  David Connelly\n @since   1.2\n\n","slug":"classloader","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.357Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6d000djh4kkvxrnmqe","content":"<h3 id=\"URLClassLoader\"><a href=\"#URLClassLoader\" class=\"headerlink\" title=\"URLClassLoader\"></a>URLClassLoader</h3><blockquote>\n<p>This class loader is used to load classes and resources from a search<br> path of URLs referring to both JAR files and directories. Any URL that<br> ends with a ‘/‘ is assumed to refer to a directory. Otherwise, the URL<br> is assumed to refer to a JAR file which will be opened as needed.<br> </p><p><br> The AccessControlContext of the thread that created the instance of<br> URLClassLoader will be used when subsequently loading classes and<br> resources.<br> </p><p><br> The classes that are loaded are by default granted permission only to<br> access the URLs specified when the URLClassLoader was created.<br> @author  David Connelly<br> @since   1.2</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"URLClassLoader\"><a href=\"#URLClassLoader\" class=\"headerlink\" title=\"URLClassLoader\"></a>URLClassLoader</h3><blockquote>\n<p>This class loader is used to load classes and resources from a search<br> path of URLs referring to both JAR files and directories. Any URL that<br> ends with a ‘/‘ is assumed to refer to a directory. Otherwise, the URL<br> is assumed to refer to a JAR file which will be opened as needed.<br> </p><p><br> The AccessControlContext of the thread that created the instance of<br> URLClassLoader will be used when subsequently loading classes and<br> resources.<br> </p><p><br> The classes that are loaded are by default granted permission only to<br> access the URLs specified when the URLClassLoader was created.<br> @author  David Connelly<br> @since   1.2</p>\n</blockquote>\n"},{"title":"Spring中的bean属性编辑器——BeanWrapper","toc":true,"_content":"\n## 源起\n\n最近在翻阅Spring MVC的源码的时候看到了这么一段\n\n```java\ntry {\n        PropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);\n        BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);\n        ResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());\n        bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));\n        initBeanWrapper(bw);\n        bw.setPropertyValues(pvs, true);\n    }\n    catch (xx){\n        ...\n    }\n```\n这段代码是在`DispatcherServlet`的父类`HttpServletBean`初始化的时候使用的。\n`bw.setPropertyValues(pvs, true);` 这一句直接操作了`Bean`的属性，将Servlet启动文件中\n指定的初始化信息加载过来。\n\n## JavaBeans规范\n\n1. 所有的属性都是private的\n\n2. 有一个公有的无参构造函数\n\n3. 可序列化（实现`Serializable`接口）\n\n\n## Apache Commons\n\nUnsafe 类\n\n## 参考\n\n1. [What is a JavaBean exactly?](http://stackoverflow.com/questions/3295496/what-is-a-javabean-exactly)","source":"_drafts/custom-editor.md","raw":"title: Spring中的bean属性编辑器——BeanWrapper\ntags: PropertyEditor\ncategory: spring\ntoc: true\n---\n\n## 源起\n\n最近在翻阅Spring MVC的源码的时候看到了这么一段\n\n```java\ntry {\n        PropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);\n        BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);\n        ResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());\n        bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));\n        initBeanWrapper(bw);\n        bw.setPropertyValues(pvs, true);\n    }\n    catch (xx){\n        ...\n    }\n```\n这段代码是在`DispatcherServlet`的父类`HttpServletBean`初始化的时候使用的。\n`bw.setPropertyValues(pvs, true);` 这一句直接操作了`Bean`的属性，将Servlet启动文件中\n指定的初始化信息加载过来。\n\n## JavaBeans规范\n\n1. 所有的属性都是private的\n\n2. 有一个公有的无参构造函数\n\n3. 可序列化（实现`Serializable`接口）\n\n\n## Apache Commons\n\nUnsafe 类\n\n## 参考\n\n1. [What is a JavaBean exactly?](http://stackoverflow.com/questions/3295496/what-is-a-javabean-exactly)","slug":"custom-editor","published":0,"date":"2018-05-02T12:56:05.349Z","updated":"2018-05-02T12:56:05.349Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6g000ejh4knycpt1b3","content":"<h2 id=\"源起\"><a href=\"#源起\" class=\"headerlink\" title=\"源起\"></a>源起</h2><p>最近在翻阅Spring MVC的源码的时候看到了这么一段</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        PropertyValues pvs = <span class=\"keyword\">new</span> ServletConfigPropertyValues(getServletConfig(), <span class=\"keyword\">this</span>.requiredProperties);</span><br><span class=\"line\">        BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        ResourceLoader resourceLoader = <span class=\"keyword\">new</span> ServletContextResourceLoader(getServletContext());</span><br><span class=\"line\">        bw.registerCustomEditor(Resource.class, <span class=\"keyword\">new</span> ResourceEditor(resourceLoader, getEnvironment()));</span><br><span class=\"line\">        initBeanWrapper(bw);</span><br><span class=\"line\">        bw.setPropertyValues(pvs, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (xx)&#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这段代码是在<code>DispatcherServlet</code>的父类<code>HttpServletBean</code>初始化的时候使用的。<br><code>bw.setPropertyValues(pvs, true);</code> 这一句直接操作了<code>Bean</code>的属性，将Servlet启动文件中<br>指定的初始化信息加载过来。</p>\n<h2 id=\"JavaBeans规范\"><a href=\"#JavaBeans规范\" class=\"headerlink\" title=\"JavaBeans规范\"></a>JavaBeans规范</h2><ol>\n<li><p>所有的属性都是private的</p>\n</li>\n<li><p>有一个公有的无参构造函数</p>\n</li>\n<li><p>可序列化（实现<code>Serializable</code>接口）</p>\n</li>\n</ol>\n<h2 id=\"Apache-Commons\"><a href=\"#Apache-Commons\" class=\"headerlink\" title=\"Apache Commons\"></a>Apache Commons</h2><p>Unsafe 类</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://stackoverflow.com/questions/3295496/what-is-a-javabean-exactly\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">What is a JavaBean exactly?</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"源起\"><a href=\"#源起\" class=\"headerlink\" title=\"源起\"></a>源起</h2><p>最近在翻阅Spring MVC的源码的时候看到了这么一段</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        PropertyValues pvs = <span class=\"keyword\">new</span> ServletConfigPropertyValues(getServletConfig(), <span class=\"keyword\">this</span>.requiredProperties);</span><br><span class=\"line\">        BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        ResourceLoader resourceLoader = <span class=\"keyword\">new</span> ServletContextResourceLoader(getServletContext());</span><br><span class=\"line\">        bw.registerCustomEditor(Resource.class, <span class=\"keyword\">new</span> ResourceEditor(resourceLoader, getEnvironment()));</span><br><span class=\"line\">        initBeanWrapper(bw);</span><br><span class=\"line\">        bw.setPropertyValues(pvs, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (xx)&#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这段代码是在<code>DispatcherServlet</code>的父类<code>HttpServletBean</code>初始化的时候使用的。<br><code>bw.setPropertyValues(pvs, true);</code> 这一句直接操作了<code>Bean</code>的属性，将Servlet启动文件中<br>指定的初始化信息加载过来。</p>\n<h2 id=\"JavaBeans规范\"><a href=\"#JavaBeans规范\" class=\"headerlink\" title=\"JavaBeans规范\"></a>JavaBeans规范</h2><ol>\n<li><p>所有的属性都是private的</p>\n</li>\n<li><p>有一个公有的无参构造函数</p>\n</li>\n<li><p>可序列化（实现<code>Serializable</code>接口）</p>\n</li>\n</ol>\n<h2 id=\"Apache-Commons\"><a href=\"#Apache-Commons\" class=\"headerlink\" title=\"Apache Commons\"></a>Apache Commons</h2><p>Unsafe 类</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://stackoverflow.com/questions/3295496/what-is-a-javabean-exactly\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">What is a JavaBean exactly?</a></li>\n</ol>\n"},{"title":"curl用法","toc":true,"_content":"\n\n## \n\nhead 请求\n\npost 请求\n\n调试 verbose模式\n\n超时\n\n编码\n\ncookie\n\n\n## 参考\n\n1. [curl/curl: A command line tool and library for transferring data with URL syntax, supporting FTP, FTPS, HTTP, HTTPS, GOPHER, TFTP, SCP, SFTP, TELNET, DICT, LDAP, LDAPS, FILE, IMAP, SMTP, POP3, RTSP and RTMP. libcurl offers a myriad of powerful features](https://github.com/curl/curl)\n\n2. [CURL常用命令 - 张贺 - 博客园](http://www.cnblogs.com/gbyukg/p/3326825.html)","source":"_drafts/curl.md","raw":"---\ntitle: curl用法\ntoc: true\ncategory: shell\ntags: curl\n---\n\n\n## \n\nhead 请求\n\npost 请求\n\n调试 verbose模式\n\n超时\n\n编码\n\ncookie\n\n\n## 参考\n\n1. [curl/curl: A command line tool and library for transferring data with URL syntax, supporting FTP, FTPS, HTTP, HTTPS, GOPHER, TFTP, SCP, SFTP, TELNET, DICT, LDAP, LDAPS, FILE, IMAP, SMTP, POP3, RTSP and RTMP. libcurl offers a myriad of powerful features](https://github.com/curl/curl)\n\n2. [CURL常用命令 - 张贺 - 博客园](http://www.cnblogs.com/gbyukg/p/3326825.html)","slug":"curl","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-12T06:51:09.453Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6k000ijh4kbidoc2aq","content":"<p>## </p>\n<p>head 请求</p>\n<p>post 请求</p>\n<p>调试 verbose模式</p>\n<p>超时</p>\n<p>编码</p>\n<p>cookie</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://github.com/curl/curl\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">curl/curl: A command line tool and library for transferring data with URL syntax, supporting FTP, FTPS, HTTP, HTTPS, GOPHER, TFTP, SCP, SFTP, TELNET, DICT, LDAP, LDAPS, FILE, IMAP, SMTP, POP3, RTSP and RTMP. libcurl offers a myriad of powerful features</a></p>\n</li>\n<li><p><a href=\"http://www.cnblogs.com/gbyukg/p/3326825.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">CURL常用命令 - 张贺 - 博客园</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>## </p>\n<p>head 请求</p>\n<p>post 请求</p>\n<p>调试 verbose模式</p>\n<p>超时</p>\n<p>编码</p>\n<p>cookie</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://github.com/curl/curl\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">curl/curl: A command line tool and library for transferring data with URL syntax, supporting FTP, FTPS, HTTP, HTTPS, GOPHER, TFTP, SCP, SFTP, TELNET, DICT, LDAP, LDAPS, FILE, IMAP, SMTP, POP3, RTSP and RTMP. libcurl offers a myriad of powerful features</a></p>\n</li>\n<li><p><a href=\"http://www.cnblogs.com/gbyukg/p/3326825.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">CURL常用命令 - 张贺 - 博客园</a></p>\n</li>\n</ol>\n"},{"title":"diffy","toc":true,"abbrlink":2406,"_content":"\n\n\n## 参考\n\n1. [Diffy：Twitter的开源自动化测试工具](http://www.infoq.com/cn/articles/diffy-twitter-open-source-automation-testing-tool)","source":"_drafts/diffy.md","raw":"---\ntitle: diffy\ntoc: true\ntags: test\ncategory: 工具\nabbrlink: 2406\n---\n\n\n\n## 参考\n\n1. [Diffy：Twitter的开源自动化测试工具](http://www.infoq.com/cn/articles/diffy-twitter-open-source-automation-testing-tool)","slug":"diffy","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.357Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6m000jjh4kdukv1alg","content":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://www.infoq.com/cn/articles/diffy-twitter-open-source-automation-testing-tool\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Diffy：Twitter的开源自动化测试工具</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://www.infoq.com/cn/articles/diffy-twitter-open-source-automation-testing-tool\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Diffy：Twitter的开源自动化测试工具</a></li>\n</ol>\n"},{"title":"digester","toc":true,"abbrlink":10571,"_content":"\nXML 文件中如何使用它来把节点转换为 Java 对象","source":"_drafts/digester.md","raw":"---\ntitle: digester\ntoc: true\ntags: xml\ncategory: java\nabbrlink: 10571\n---\n\nXML 文件中如何使用它来把节点转换为 Java 对象","slug":"digester","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.361Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6n000ljh4kubtjqkt7","content":"<p>XML 文件中如何使用它来把节点转换为 Java 对象</p>\n","site":{"data":{}},"excerpt":"","more":"<p>XML 文件中如何使用它来把节点转换为 Java 对象</p>\n"},{"title":"dozer","toc":true,"abbrlink":28902,"category":null,"_content":"","source":"_drafts/dozer.md","raw":"---\ntitle: dozer\ntoc: true\nabbrlink: 28902\ntags:\ncategory:\n---\n","slug":"dozer","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-08-13T14:17:13.142Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6o000pjh4kw7alehs5","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"dubbo-telnet","toc":true,"abbrlink":30835,"category":null,"_content":"","source":"_drafts/dubbo-telnet.md","raw":"---\ntitle: dubbo-telnet\ntoc: true\nabbrlink: 30835\ntags:\ncategory:\n---\n","slug":"dubbo-telnet","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-05-31T17:04:30.918Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6p000qjh4k2vpbydb0","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"dubbo-filter","toc":true,"abbrlink":52929,"category":null,"_content":"","source":"_drafts/dubbo-filter.md","raw":"---\ntitle: dubbo-filter\ntoc: true\nabbrlink: 52929\ntags:\ncategory:\n---\n","slug":"dubbo-filter","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-08-13T14:17:13.138Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6q000ujh4kqxpyfwmj","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"dubbo","toc":true,"abbrlink":22179,"_content":"\n## 测试\n\n\n\ntelnet 操作\n\nnc 操作\n\n### invoke\n\ninvokewithouttoken\ninvoke\n\n语法  \n\ninvoke object.methodname(argsInJson)\n\n编码问题\n\n过长参数问题\n\n{% post_link shell-input-limit shell输入长度限制 %}\n\n### 查看服务地址\n\n```bash\n#!/bin/sh\n\narg=`cat $1`\necho $arg\n(\necho open localhost 20085\nsleep 2\necho -ne  '\\n'\necho \"ls\"\nsleep 2\necho \"invokewithouttoken $arg\"\nsleep 60\necho \"exit\"\n) | telnet\n```","source":"_drafts/dubbo.md","raw":"---\ntitle: dubbo\ntoc: true\ncategory: dubbo\nabbrlink: 22179\ntags:\n---\n\n## 测试\n\n\n\ntelnet 操作\n\nnc 操作\n\n### invoke\n\ninvokewithouttoken\ninvoke\n\n语法  \n\ninvoke object.methodname(argsInJson)\n\n编码问题\n\n过长参数问题\n\n{% post_link shell-input-limit shell输入长度限制 %}\n\n### 查看服务地址\n\n```bash\n#!/bin/sh\n\narg=`cat $1`\necho $arg\n(\necho open localhost 20085\nsleep 2\necho -ne  '\\n'\necho \"ls\"\nsleep 2\necho \"invokewithouttoken $arg\"\nsleep 60\necho \"exit\"\n) | telnet\n```","slug":"dubbo","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-05-31T16:58:36.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6r000xjh4kq3pyje3m","content":"<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>telnet 操作</p>\n<p>nc 操作</p>\n<h3 id=\"invoke\"><a href=\"#invoke\" class=\"headerlink\" title=\"invoke\"></a>invoke</h3><p>invokewithouttoken<br>invoke</p>\n<p>语法  </p>\n<p>invoke object.methodname(argsInJson)</p>\n<p>编码问题</p>\n<p>过长参数问题</p>\n<a href=\"/2017/02/06/shell-input-limit/\" title=\"shell输入长度限制\">shell输入长度限制</a>\n<h3 id=\"查看服务地址\"><a href=\"#查看服务地址\" class=\"headerlink\" title=\"查看服务地址\"></a>查看服务地址</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">arg=`cat <span class=\"variable\">$1</span>`</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">$arg</span></span><br><span class=\"line\">(</span><br><span class=\"line\"><span class=\"built_in\">echo</span> open localhost 20085</span><br><span class=\"line\">sleep 2</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -ne  <span class=\"string\">'\\n'</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"ls\"</span></span><br><span class=\"line\">sleep 2</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"invokewithouttoken <span class=\"variable\">$arg</span>\"</span></span><br><span class=\"line\">sleep 60</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"exit\"</span></span><br><span class=\"line\">) | telnet</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>telnet 操作</p>\n<p>nc 操作</p>\n<h3 id=\"invoke\"><a href=\"#invoke\" class=\"headerlink\" title=\"invoke\"></a>invoke</h3><p>invokewithouttoken<br>invoke</p>\n<p>语法  </p>\n<p>invoke object.methodname(argsInJson)</p>\n<p>编码问题</p>\n<p>过长参数问题</p>\n<a href=\"/2017/02/06/shell-input-limit/\" title=\"shell输入长度限制\">shell输入长度限制</a>\n<h3 id=\"查看服务地址\"><a href=\"#查看服务地址\" class=\"headerlink\" title=\"查看服务地址\"></a>查看服务地址</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">arg=`cat <span class=\"variable\">$1</span>`</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">$arg</span></span><br><span class=\"line\">(</span><br><span class=\"line\"><span class=\"built_in\">echo</span> open localhost 20085</span><br><span class=\"line\">sleep 2</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -ne  <span class=\"string\">'\\n'</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"ls\"</span></span><br><span class=\"line\">sleep 2</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"invokewithouttoken <span class=\"variable\">$arg</span>\"</span></span><br><span class=\"line\">sleep 60</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"exit\"</span></span><br><span class=\"line\">) | telnet</span><br></pre></td></tr></table></figure>"},{"title":"java GC基础知识","toc":true,"abbrlink":38885,"_content":"\n## GC的三个要素\n\n{%  asset_img   gc.jpg  gc三要素 %}\n\njava eden s1， s2 old\n\n\n## GC调优准则\n\n>1. Try to maximize objects reclaimed in young gen.\n>2. Set -Xms和-Xmx to 3x or 4x LDS(live data size)\n>3. Young gen should be around 1x to 1.5x LDS\n>4. Old gen should be around 2x to 3x LDS\n\n\nThreshold 调优， 如何调优， 停留在young区还是old区\n\n手工触发gc\n\n```\njmap -histo:live `pgrep -f 'tomcat'`\n```\n\nJConsole或者VisualVM, Perform GC\n\n\n设置young区大小， `-Xmn`或者\n\n```\n-XX:NewSize= -XX:MaxNewSize=\n```\n\n-client -server\n\n### 引用类型\n\n####　强引用(Strong Reference)\n\n#### 软引用(Soft Reference)\n\nUsed for cache\n\n-XX:SoftRefLRUPolicyMSPerMB=0\n\n#### 弱引用(Weak Reference)\n\nUsed for cache\n\n#### 虚引用（Phantom Reference)\n\nused for housekeeping\n\n\n\n### Throughput\n\nleast overall GC overhead\n\n#### Parallel Scavenge Collector\n\n```\n-XX:+UseParallelGC\n-XX:ParallelGCThreads=7\n```\n\n### latency\n\nmore overall gc overhead \n\n#### CMS\n\n```\n-XX:+UseConcMarkSweepGC\n-XX:+UseParNewGC\n-XX:ParallelGCThreads=7\n```\n\n堆碎片化\n\nGC参数， 标准参数和其他参数 -XX和\n\n\n\n### Parallel\n\n### Concurrent\n\n\n## G1收集器\n\n\n{%  asset_img   g1.jpg  G1收集器 %}\n\n8GB or larger heaps\n\n## 日志输出\n\n```\n-XX:+PrintGC\n-XX:+PrintGCDetails\n-XX:+PrintGCTimeStamps\n```\n\n暂停时间\n\n```\n\n```\n\n安全区暂停\n\n\n\njmap -> jcmd\n\njmap -permstat [pid]\n\n## 堆外内存\n\n### nio\n\n```\n-XX:+MaxDirect\n```\n\n### 永久代和元空间\n\n\n如果不限制大小，上限就是系统可用内存大小\n```\n\n```\n\ngc信息： \n\n```\nsudo -u tomcat jstat -gc `pgrep -f 'tomcat'` 1000\nsudo -u tomcat jstat -gcutil `pgrep -f 'tomcat'` 1000\njstat -class [pid]\n```\n\nwell known xxx\n\n\n### JMX  性能影响\n\nsudo -u tomcat jmap -dump:format=b,file=/home/q/dump/heap.hprof `pgrep -f 'tomcat'`\n\nsudo -u tomcat jmap -clstats `pgrep -f 'tomcat'`\n\njmap -histo:live `pgrep -f 'tomcat'`\n\njmap -histo `pgrep -f 'tomcat'`","source":"_drafts/gc-basic.md","raw":"---\ntitle: java GC基础知识\ntoc: true\ncategory: gc\nabbrlink: 38885\ntags:\n---\n\n## GC的三个要素\n\n{%  asset_img   gc.jpg  gc三要素 %}\n\njava eden s1， s2 old\n\n\n## GC调优准则\n\n>1. Try to maximize objects reclaimed in young gen.\n>2. Set -Xms和-Xmx to 3x or 4x LDS(live data size)\n>3. Young gen should be around 1x to 1.5x LDS\n>4. Old gen should be around 2x to 3x LDS\n\n\nThreshold 调优， 如何调优， 停留在young区还是old区\n\n手工触发gc\n\n```\njmap -histo:live `pgrep -f 'tomcat'`\n```\n\nJConsole或者VisualVM, Perform GC\n\n\n设置young区大小， `-Xmn`或者\n\n```\n-XX:NewSize= -XX:MaxNewSize=\n```\n\n-client -server\n\n### 引用类型\n\n####　强引用(Strong Reference)\n\n#### 软引用(Soft Reference)\n\nUsed for cache\n\n-XX:SoftRefLRUPolicyMSPerMB=0\n\n#### 弱引用(Weak Reference)\n\nUsed for cache\n\n#### 虚引用（Phantom Reference)\n\nused for housekeeping\n\n\n\n### Throughput\n\nleast overall GC overhead\n\n#### Parallel Scavenge Collector\n\n```\n-XX:+UseParallelGC\n-XX:ParallelGCThreads=7\n```\n\n### latency\n\nmore overall gc overhead \n\n#### CMS\n\n```\n-XX:+UseConcMarkSweepGC\n-XX:+UseParNewGC\n-XX:ParallelGCThreads=7\n```\n\n堆碎片化\n\nGC参数， 标准参数和其他参数 -XX和\n\n\n\n### Parallel\n\n### Concurrent\n\n\n## G1收集器\n\n\n{%  asset_img   g1.jpg  G1收集器 %}\n\n8GB or larger heaps\n\n## 日志输出\n\n```\n-XX:+PrintGC\n-XX:+PrintGCDetails\n-XX:+PrintGCTimeStamps\n```\n\n暂停时间\n\n```\n\n```\n\n安全区暂停\n\n\n\njmap -> jcmd\n\njmap -permstat [pid]\n\n## 堆外内存\n\n### nio\n\n```\n-XX:+MaxDirect\n```\n\n### 永久代和元空间\n\n\n如果不限制大小，上限就是系统可用内存大小\n```\n\n```\n\ngc信息： \n\n```\nsudo -u tomcat jstat -gc `pgrep -f 'tomcat'` 1000\nsudo -u tomcat jstat -gcutil `pgrep -f 'tomcat'` 1000\njstat -class [pid]\n```\n\nwell known xxx\n\n\n### JMX  性能影响\n\nsudo -u tomcat jmap -dump:format=b,file=/home/q/dump/heap.hprof `pgrep -f 'tomcat'`\n\nsudo -u tomcat jmap -clstats `pgrep -f 'tomcat'`\n\njmap -histo:live `pgrep -f 'tomcat'`\n\njmap -histo `pgrep -f 'tomcat'`","slug":"gc-basic","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-12-17T16:48:22.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6s0011jh4kctlxjynw","content":"<h2 id=\"GC的三个要素\"><a href=\"#GC的三个要素\" class=\"headerlink\" title=\"GC的三个要素\"></a>GC的三个要素</h2><img src=\"/2018/03/15/gc-basic/gc.jpg\" title=\"gc三要素\">\n<p>java eden s1， s2 old</p>\n<h2 id=\"GC调优准则\"><a href=\"#GC调优准则\" class=\"headerlink\" title=\"GC调优准则\"></a>GC调优准则</h2><blockquote>\n<ol>\n<li>Try to maximize objects reclaimed in young gen.</li>\n<li>Set -Xms和-Xmx to 3x or 4x LDS(live data size)</li>\n<li>Young gen should be around 1x to 1.5x LDS</li>\n<li>Old gen should be around 2x to 3x LDS</li>\n</ol>\n</blockquote>\n<p>Threshold 调优， 如何调优， 停留在young区还是old区</p>\n<p>手工触发gc</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jmap -histo:live `pgrep -f &apos;tomcat&apos;`</span><br></pre></td></tr></table></figure>\n<p>JConsole或者VisualVM, Perform GC</p>\n<p>设置young区大小， <code>-Xmn</code>或者</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:NewSize= -XX:MaxNewSize=</span><br></pre></td></tr></table></figure>\n<p>-client -server</p>\n<h3 id=\"引用类型\"><a href=\"#引用类型\" class=\"headerlink\" title=\"引用类型\"></a>引用类型</h3><p>####　强引用(Strong Reference)</p>\n<h4 id=\"软引用-Soft-Reference\"><a href=\"#软引用-Soft-Reference\" class=\"headerlink\" title=\"软引用(Soft Reference)\"></a>软引用(Soft Reference)</h4><p>Used for cache</p>\n<p>-XX:SoftRefLRUPolicyMSPerMB=0</p>\n<h4 id=\"弱引用-Weak-Reference\"><a href=\"#弱引用-Weak-Reference\" class=\"headerlink\" title=\"弱引用(Weak Reference)\"></a>弱引用(Weak Reference)</h4><p>Used for cache</p>\n<h4 id=\"虚引用（Phantom-Reference\"><a href=\"#虚引用（Phantom-Reference\" class=\"headerlink\" title=\"虚引用（Phantom Reference)\"></a>虚引用（Phantom Reference)</h4><p>used for housekeeping</p>\n<h3 id=\"Throughput\"><a href=\"#Throughput\" class=\"headerlink\" title=\"Throughput\"></a>Throughput</h3><p>least overall GC overhead</p>\n<h4 id=\"Parallel-Scavenge-Collector\"><a href=\"#Parallel-Scavenge-Collector\" class=\"headerlink\" title=\"Parallel Scavenge Collector\"></a>Parallel Scavenge Collector</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+UseParallelGC</span><br><span class=\"line\">-XX:ParallelGCThreads=7</span><br></pre></td></tr></table></figure>\n<h3 id=\"latency\"><a href=\"#latency\" class=\"headerlink\" title=\"latency\"></a>latency</h3><p>more overall gc overhead </p>\n<h4 id=\"CMS\"><a href=\"#CMS\" class=\"headerlink\" title=\"CMS\"></a>CMS</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+UseConcMarkSweepGC</span><br><span class=\"line\">-XX:+UseParNewGC</span><br><span class=\"line\">-XX:ParallelGCThreads=7</span><br></pre></td></tr></table></figure>\n<p>堆碎片化</p>\n<p>GC参数， 标准参数和其他参数 -XX和</p>\n<h3 id=\"Parallel\"><a href=\"#Parallel\" class=\"headerlink\" title=\"Parallel\"></a>Parallel</h3><h3 id=\"Concurrent\"><a href=\"#Concurrent\" class=\"headerlink\" title=\"Concurrent\"></a>Concurrent</h3><h2 id=\"G1收集器\"><a href=\"#G1收集器\" class=\"headerlink\" title=\"G1收集器\"></a>G1收集器</h2><img src=\"/2018/03/15/gc-basic/g1.jpg\" title=\"G1收集器\">\n<p>8GB or larger heaps</p>\n<h2 id=\"日志输出\"><a href=\"#日志输出\" class=\"headerlink\" title=\"日志输出\"></a>日志输出</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+PrintGC</span><br><span class=\"line\">-XX:+PrintGCDetails</span><br><span class=\"line\">-XX:+PrintGCTimeStamps</span><br></pre></td></tr></table></figure>\n<p>暂停时间</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>安全区暂停</p>\n<p>jmap -&gt; jcmd</p>\n<p>jmap -permstat [pid]</p>\n<h2 id=\"堆外内存\"><a href=\"#堆外内存\" class=\"headerlink\" title=\"堆外内存\"></a>堆外内存</h2><h3 id=\"nio\"><a href=\"#nio\" class=\"headerlink\" title=\"nio\"></a>nio</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+MaxDirect</span><br></pre></td></tr></table></figure>\n<h3 id=\"永久代和元空间\"><a href=\"#永久代和元空间\" class=\"headerlink\" title=\"永久代和元空间\"></a>永久代和元空间</h3><p>如果不限制大小，上限就是系统可用内存大小<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>gc信息： </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat jstat -gc `pgrep -f &apos;tomcat&apos;` 1000</span><br><span class=\"line\">sudo -u tomcat jstat -gcutil `pgrep -f &apos;tomcat&apos;` 1000</span><br><span class=\"line\">jstat -class [pid]</span><br></pre></td></tr></table></figure>\n<p>well known xxx</p>\n<h3 id=\"JMX-性能影响\"><a href=\"#JMX-性能影响\" class=\"headerlink\" title=\"JMX  性能影响\"></a>JMX  性能影响</h3><p>sudo -u tomcat jmap -dump:format=b,file=/home/q/dump/heap.hprof <code>pgrep -f &#39;tomcat&#39;</code></p>\n<p>sudo -u tomcat jmap -clstats <code>pgrep -f &#39;tomcat&#39;</code></p>\n<p>jmap -histo:live <code>pgrep -f &#39;tomcat&#39;</code></p>\n<p>jmap -histo <code>pgrep -f &#39;tomcat&#39;</code></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"GC的三个要素\"><a href=\"#GC的三个要素\" class=\"headerlink\" title=\"GC的三个要素\"></a>GC的三个要素</h2><img src=\"/2018/03/15/gc-basic/gc.jpg\" title=\"gc三要素\">\n<p>java eden s1， s2 old</p>\n<h2 id=\"GC调优准则\"><a href=\"#GC调优准则\" class=\"headerlink\" title=\"GC调优准则\"></a>GC调优准则</h2><blockquote>\n<ol>\n<li>Try to maximize objects reclaimed in young gen.</li>\n<li>Set -Xms和-Xmx to 3x or 4x LDS(live data size)</li>\n<li>Young gen should be around 1x to 1.5x LDS</li>\n<li>Old gen should be around 2x to 3x LDS</li>\n</ol>\n</blockquote>\n<p>Threshold 调优， 如何调优， 停留在young区还是old区</p>\n<p>手工触发gc</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jmap -histo:live `pgrep -f &apos;tomcat&apos;`</span><br></pre></td></tr></table></figure>\n<p>JConsole或者VisualVM, Perform GC</p>\n<p>设置young区大小， <code>-Xmn</code>或者</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:NewSize= -XX:MaxNewSize=</span><br></pre></td></tr></table></figure>\n<p>-client -server</p>\n<h3 id=\"引用类型\"><a href=\"#引用类型\" class=\"headerlink\" title=\"引用类型\"></a>引用类型</h3><p>####　强引用(Strong Reference)</p>\n<h4 id=\"软引用-Soft-Reference\"><a href=\"#软引用-Soft-Reference\" class=\"headerlink\" title=\"软引用(Soft Reference)\"></a>软引用(Soft Reference)</h4><p>Used for cache</p>\n<p>-XX:SoftRefLRUPolicyMSPerMB=0</p>\n<h4 id=\"弱引用-Weak-Reference\"><a href=\"#弱引用-Weak-Reference\" class=\"headerlink\" title=\"弱引用(Weak Reference)\"></a>弱引用(Weak Reference)</h4><p>Used for cache</p>\n<h4 id=\"虚引用（Phantom-Reference\"><a href=\"#虚引用（Phantom-Reference\" class=\"headerlink\" title=\"虚引用（Phantom Reference)\"></a>虚引用（Phantom Reference)</h4><p>used for housekeeping</p>\n<h3 id=\"Throughput\"><a href=\"#Throughput\" class=\"headerlink\" title=\"Throughput\"></a>Throughput</h3><p>least overall GC overhead</p>\n<h4 id=\"Parallel-Scavenge-Collector\"><a href=\"#Parallel-Scavenge-Collector\" class=\"headerlink\" title=\"Parallel Scavenge Collector\"></a>Parallel Scavenge Collector</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+UseParallelGC</span><br><span class=\"line\">-XX:ParallelGCThreads=7</span><br></pre></td></tr></table></figure>\n<h3 id=\"latency\"><a href=\"#latency\" class=\"headerlink\" title=\"latency\"></a>latency</h3><p>more overall gc overhead </p>\n<h4 id=\"CMS\"><a href=\"#CMS\" class=\"headerlink\" title=\"CMS\"></a>CMS</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+UseConcMarkSweepGC</span><br><span class=\"line\">-XX:+UseParNewGC</span><br><span class=\"line\">-XX:ParallelGCThreads=7</span><br></pre></td></tr></table></figure>\n<p>堆碎片化</p>\n<p>GC参数， 标准参数和其他参数 -XX和</p>\n<h3 id=\"Parallel\"><a href=\"#Parallel\" class=\"headerlink\" title=\"Parallel\"></a>Parallel</h3><h3 id=\"Concurrent\"><a href=\"#Concurrent\" class=\"headerlink\" title=\"Concurrent\"></a>Concurrent</h3><h2 id=\"G1收集器\"><a href=\"#G1收集器\" class=\"headerlink\" title=\"G1收集器\"></a>G1收集器</h2><img src=\"/2018/03/15/gc-basic/g1.jpg\" title=\"G1收集器\">\n<p>8GB or larger heaps</p>\n<h2 id=\"日志输出\"><a href=\"#日志输出\" class=\"headerlink\" title=\"日志输出\"></a>日志输出</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+PrintGC</span><br><span class=\"line\">-XX:+PrintGCDetails</span><br><span class=\"line\">-XX:+PrintGCTimeStamps</span><br></pre></td></tr></table></figure>\n<p>暂停时间</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>安全区暂停</p>\n<p>jmap -&gt; jcmd</p>\n<p>jmap -permstat [pid]</p>\n<h2 id=\"堆外内存\"><a href=\"#堆外内存\" class=\"headerlink\" title=\"堆外内存\"></a>堆外内存</h2><h3 id=\"nio\"><a href=\"#nio\" class=\"headerlink\" title=\"nio\"></a>nio</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+MaxDirect</span><br></pre></td></tr></table></figure>\n<h3 id=\"永久代和元空间\"><a href=\"#永久代和元空间\" class=\"headerlink\" title=\"永久代和元空间\"></a>永久代和元空间</h3><p>如果不限制大小，上限就是系统可用内存大小<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>gc信息： </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat jstat -gc `pgrep -f &apos;tomcat&apos;` 1000</span><br><span class=\"line\">sudo -u tomcat jstat -gcutil `pgrep -f &apos;tomcat&apos;` 1000</span><br><span class=\"line\">jstat -class [pid]</span><br></pre></td></tr></table></figure>\n<p>well known xxx</p>\n<h3 id=\"JMX-性能影响\"><a href=\"#JMX-性能影响\" class=\"headerlink\" title=\"JMX  性能影响\"></a>JMX  性能影响</h3><p>sudo -u tomcat jmap -dump:format=b,file=/home/q/dump/heap.hprof <code>pgrep -f &#39;tomcat&#39;</code></p>\n<p>sudo -u tomcat jmap -clstats <code>pgrep -f &#39;tomcat&#39;</code></p>\n<p>jmap -histo:live <code>pgrep -f &#39;tomcat&#39;</code></p>\n<p>jmap -histo <code>pgrep -f &#39;tomcat&#39;</code></p>\n"},{"title":"g1（ Garbage-First ）垃圾收集器","toc":true,"abbrlink":20071,"_content":"\n\n\n## 参考\n\n1. [Garbage-First Garbage Collector](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/g1_gc.html)","source":"_drafts/gc-g1.md","raw":"---\ntitle: g1（ Garbage-First ）垃圾收集器\ntoc: true\ncategory: gc\nabbrlink: 20071\ntags:\n---\n\n\n\n## 参考\n\n1. [Garbage-First Garbage Collector](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/g1_gc.html)","slug":"gc-g1","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.365Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6t0013jh4keayul0vo","content":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/g1_gc.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Garbage-First Garbage Collector</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/g1_gc.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Garbage-First Garbage Collector</a></li>\n</ol>\n"},{"title":"gc-serial","toc":true,"abbrlink":57232,"_content":"","source":"_drafts/gc-serial.md","raw":"---\ntitle: gc-serial\ntoc: true\ncategory: gc\nabbrlink: 57232\ntags:\n---\n","slug":"gc-serial","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.365Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6u0017jh4kivoze819","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"快速了解一个系统","toc":true,"abbrlink":6924,"_content":"\n\n>例如，你可能把一棵树看作一个单独、离散的对象，立在地面。但事实上，一棵树至少是两个主要系统的连接点：树叶和空气的处理循环与根和泥土的处理循环。树不是静止的，也不是孤立的。更有趣的是，几乎没有人只是系统的一个观察者，不论你是否意识到，很可能你就是这个系统的一部分\n\n从系统的交互入手，输入/输出\n\n- 依赖的外部系统\n\n- 对外提供的服务\n\n从测试入手\n\n自顶向下得阅读代码，抽象层级越来越低\n\n先看接口","source":"_drafts/getting-started-with-system.md","raw":"---\ntitle: 快速了解一个系统\ntoc: true\ntags: beginner\ncategory: thinking\nabbrlink: 6924\n---\n\n\n>例如，你可能把一棵树看作一个单独、离散的对象，立在地面。但事实上，一棵树至少是两个主要系统的连接点：树叶和空气的处理循环与根和泥土的处理循环。树不是静止的，也不是孤立的。更有趣的是，几乎没有人只是系统的一个观察者，不论你是否意识到，很可能你就是这个系统的一部分\n\n从系统的交互入手，输入/输出\n\n- 依赖的外部系统\n\n- 对外提供的服务\n\n从测试入手\n\n自顶向下得阅读代码，抽象层级越来越低\n\n先看接口","slug":"getting-started-with-system","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.369Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6v0019jh4k3b7v9ieg","content":"<blockquote>\n<p>例如，你可能把一棵树看作一个单独、离散的对象，立在地面。但事实上，一棵树至少是两个主要系统的连接点：树叶和空气的处理循环与根和泥土的处理循环。树不是静止的，也不是孤立的。更有趣的是，几乎没有人只是系统的一个观察者，不论你是否意识到，很可能你就是这个系统的一部分</p>\n</blockquote>\n<p>从系统的交互入手，输入/输出</p>\n<ul>\n<li><p>依赖的外部系统</p>\n</li>\n<li><p>对外提供的服务</p>\n</li>\n</ul>\n<p>从测试入手</p>\n<p>自顶向下得阅读代码，抽象层级越来越低</p>\n<p>先看接口</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>例如，你可能把一棵树看作一个单独、离散的对象，立在地面。但事实上，一棵树至少是两个主要系统的连接点：树叶和空气的处理循环与根和泥土的处理循环。树不是静止的，也不是孤立的。更有趣的是，几乎没有人只是系统的一个观察者，不论你是否意识到，很可能你就是这个系统的一部分</p>\n</blockquote>\n<p>从系统的交互入手，输入/输出</p>\n<ul>\n<li><p>依赖的外部系统</p>\n</li>\n<li><p>对外提供的服务</p>\n</li>\n</ul>\n<p>从测试入手</p>\n<p>自顶向下得阅读代码，抽象层级越来越低</p>\n<p>先看接口</p>\n"},{"title":"CMS （ Concurrent Mark Sweep）垃圾收集器","toc":true,"abbrlink":11417,"_content":"\nhotspot g1 收集器\n\n主要是针对老年代\n\n{%  asset_img   cms.jpg  cms示意图 %}\n\n\nthe following collectors operate on the young generation:\n-XX:+UseSerialGC\n-XX:+UseParallelGC\n-XX:+UseParNewGC\n \nthe following collectors operate on the old generation:\n-XX:+UseParallelOldGC\n-XX:+UseConcMarkSweepGC\n\n\n### 参考\n\n1. [blog/2012-12-07-understanding-cms-log.md at master · ivanzhangwb/blog](https://github.com/ivanzhangwb/blog/blob/master/posts/2012-12-07-understanding-cms-log.md)\n\n2. [Understanding CMS GC Logs (Poonam Bajaj Parhar)](https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs)\n\n3. [Concurrent Mark Sweep (CMS) Collector](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html)\n\n4. [Garbage Collection: Serial vs. Parallel vs. Concurrent-Mark-Sweep](http://www.tikalk.com/java/garbage-collection-serial-vs-parallel-vs-concurrent-mark-sweep/)\n\n","source":"_drafts/gc-cms.md","raw":"---\ntitle: CMS （ Concurrent Mark Sweep）垃圾收集器\ntoc: true\ncategory: gc\nabbrlink: 11417\ntags:\n---\n\nhotspot g1 收集器\n\n主要是针对老年代\n\n{%  asset_img   cms.jpg  cms示意图 %}\n\n\nthe following collectors operate on the young generation:\n-XX:+UseSerialGC\n-XX:+UseParallelGC\n-XX:+UseParNewGC\n \nthe following collectors operate on the old generation:\n-XX:+UseParallelOldGC\n-XX:+UseConcMarkSweepGC\n\n\n### 参考\n\n1. [blog/2012-12-07-understanding-cms-log.md at master · ivanzhangwb/blog](https://github.com/ivanzhangwb/blog/blob/master/posts/2012-12-07-understanding-cms-log.md)\n\n2. [Understanding CMS GC Logs (Poonam Bajaj Parhar)](https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs)\n\n3. [Concurrent Mark Sweep (CMS) Collector](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html)\n\n4. [Garbage Collection: Serial vs. Parallel vs. Concurrent-Mark-Sweep](http://www.tikalk.com/java/garbage-collection-serial-vs-parallel-vs-concurrent-mark-sweep/)\n\n","slug":"gc-cms","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.361Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6w001bjh4ki85d9tlm","content":"<p>hotspot g1 收集器</p>\n<p>主要是针对老年代</p>\n<img src=\"/2018/03/15/gc-cms/cms.jpg\" title=\"cms示意图\">\n<p>the following collectors operate on the young generation:<br>-XX:+UseSerialGC<br>-XX:+UseParallelGC<br>-XX:+UseParNewGC</p>\n<p>the following collectors operate on the old generation:<br>-XX:+UseParallelOldGC<br>-XX:+UseConcMarkSweepGC</p>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><ol>\n<li><p><a href=\"https://github.com/ivanzhangwb/blog/blob/master/posts/2012-12-07-understanding-cms-log.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">blog/2012-12-07-understanding-cms-log.md at master · ivanzhangwb/blog</a></p>\n</li>\n<li><p><a href=\"https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Understanding CMS GC Logs (Poonam Bajaj Parhar)</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Concurrent Mark Sweep (CMS) Collector</a></p>\n</li>\n<li><p><a href=\"http://www.tikalk.com/java/garbage-collection-serial-vs-parallel-vs-concurrent-mark-sweep/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Garbage Collection: Serial vs. Parallel vs. Concurrent-Mark-Sweep</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>hotspot g1 收集器</p>\n<p>主要是针对老年代</p>\n<img src=\"/2018/03/15/gc-cms/cms.jpg\" title=\"cms示意图\">\n<p>the following collectors operate on the young generation:<br>-XX:+UseSerialGC<br>-XX:+UseParallelGC<br>-XX:+UseParNewGC</p>\n<p>the following collectors operate on the old generation:<br>-XX:+UseParallelOldGC<br>-XX:+UseConcMarkSweepGC</p>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><ol>\n<li><p><a href=\"https://github.com/ivanzhangwb/blog/blob/master/posts/2012-12-07-understanding-cms-log.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">blog/2012-12-07-understanding-cms-log.md at master · ivanzhangwb/blog</a></p>\n</li>\n<li><p><a href=\"https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Understanding CMS GC Logs (Poonam Bajaj Parhar)</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Concurrent Mark Sweep (CMS) Collector</a></p>\n</li>\n<li><p><a href=\"http://www.tikalk.com/java/garbage-collection-serial-vs-parallel-vs-concurrent-mark-sweep/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Garbage Collection: Serial vs. Parallel vs. Concurrent-Mark-Sweep</a></p>\n</li>\n</ol>\n"},{"title":"http协议详解","toc":true,"abbrlink":13962,"_content":"\n\n## HTTP Request组成\n\n{% asset_img  http_request_message.png %}\n\nCRLF分隔\n\n```\nHTTP-message   = Request | Response     ; HTTP/1.1 messages\n\n\n generic-message = start-line\n                          *(message-header CRLF)\n                          CRLF\n                          [ message-body ]\n        start-line      = Request-Line | Status-Line\n\n    message-header = field-name \":\" [ field-value ]\n       field-name     = token\n       field-value    = *( field-content | LWS )\n       field-content  = <the OCTETs making up the field-value\n                        and consisting of either *TEXT or combinations\n                        of token, separators, and quoted-string>\n\n       message-body = entity-body\n                    | <entity-body encoded as per Transfer-Encoding>\n```\n\n### Request LINE\n\n### Request HEADER\n\n### PAYLOAD\n\n## HTTP Response组成\n\n### URI 协议 \n\n### Response HEADER\n\n### Response Body\n\n\n### CGI示例\n\ncache \n\nkeep-alive\n\nwebsocket\n\n## 缺点\n\n文本协议，需要转换\n\n\n# HTTP 2.0\n\n> SPDY（发音如英语：speedy），一种开放的网络传输协议，由Google开发，用来发送网页内容。基于传输控制协议（TCP）的应用层协议。SPDY也就是HTTP/2的前身。Google最早是在Chromium中提出的SPDY协议[1]。被用于Google Chrome浏览器中来访问Google的SSL加密服务。SPDY并不是首字母缩略字，而仅仅是\"speedy\"的缩写。SPDY现为Google的商标[2]。HTTP/2的关键功能主要来自SPDY技术，换言之，SPDY的成果被采纳而最终演变为HTTP/2。\n\n## 参考\n\n[In Introduction to HTTP Basics](https://www.ntu.edu.sg/home/ehchua/programming/webprogramming/HTTP_Basics.html)\n\n[HTTP2.0的奇妙日常 | Web前端 腾讯AlloyTeam Blog | 愿景: 成为地球卓越的Web团队！](http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/)\n\n[Ed Burns谈HTTP/2和Java EE Servlet 4规范](http://www.infoq.com/cn/news/2015/04/burns-servlet-http2)\n\n[HTTP/1.1: HTTP Message](https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html)","source":"_drafts/http.md","raw":"---\ntitle: http协议详解\ntoc: true\ntags: http\ncategory: web\nabbrlink: 13962\n---\n\n\n## HTTP Request组成\n\n{% asset_img  http_request_message.png %}\n\nCRLF分隔\n\n```\nHTTP-message   = Request | Response     ; HTTP/1.1 messages\n\n\n generic-message = start-line\n                          *(message-header CRLF)\n                          CRLF\n                          [ message-body ]\n        start-line      = Request-Line | Status-Line\n\n    message-header = field-name \":\" [ field-value ]\n       field-name     = token\n       field-value    = *( field-content | LWS )\n       field-content  = <the OCTETs making up the field-value\n                        and consisting of either *TEXT or combinations\n                        of token, separators, and quoted-string>\n\n       message-body = entity-body\n                    | <entity-body encoded as per Transfer-Encoding>\n```\n\n### Request LINE\n\n### Request HEADER\n\n### PAYLOAD\n\n## HTTP Response组成\n\n### URI 协议 \n\n### Response HEADER\n\n### Response Body\n\n\n### CGI示例\n\ncache \n\nkeep-alive\n\nwebsocket\n\n## 缺点\n\n文本协议，需要转换\n\n\n# HTTP 2.0\n\n> SPDY（发音如英语：speedy），一种开放的网络传输协议，由Google开发，用来发送网页内容。基于传输控制协议（TCP）的应用层协议。SPDY也就是HTTP/2的前身。Google最早是在Chromium中提出的SPDY协议[1]。被用于Google Chrome浏览器中来访问Google的SSL加密服务。SPDY并不是首字母缩略字，而仅仅是\"speedy\"的缩写。SPDY现为Google的商标[2]。HTTP/2的关键功能主要来自SPDY技术，换言之，SPDY的成果被采纳而最终演变为HTTP/2。\n\n## 参考\n\n[In Introduction to HTTP Basics](https://www.ntu.edu.sg/home/ehchua/programming/webprogramming/HTTP_Basics.html)\n\n[HTTP2.0的奇妙日常 | Web前端 腾讯AlloyTeam Blog | 愿景: 成为地球卓越的Web团队！](http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/)\n\n[Ed Burns谈HTTP/2和Java EE Servlet 4规范](http://www.infoq.com/cn/news/2015/04/burns-servlet-http2)\n\n[HTTP/1.1: HTTP Message](https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html)","slug":"http","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2018-02-21T08:19:00.826Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6x001fjh4k026vn6wj","content":"<h2 id=\"HTTP-Request组成\"><a href=\"#HTTP-Request组成\" class=\"headerlink\" title=\"HTTP Request组成\"></a>HTTP Request组成</h2><img src=\"/2018/03/15/http/http_request_message.png\">\n<p>CRLF分隔</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP-message   = Request | Response     ; HTTP/1.1 messages</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> generic-message = start-line</span><br><span class=\"line\">                          *(message-header CRLF)</span><br><span class=\"line\">                          CRLF</span><br><span class=\"line\">                          [ message-body ]</span><br><span class=\"line\">        start-line      = Request-Line | Status-Line</span><br><span class=\"line\"></span><br><span class=\"line\">    message-header = field-name &quot;:&quot; [ field-value ]</span><br><span class=\"line\">       field-name     = token</span><br><span class=\"line\">       field-value    = *( field-content | LWS )</span><br><span class=\"line\">       field-content  = &lt;the OCTETs making up the field-value</span><br><span class=\"line\">                        and consisting of either *TEXT or combinations</span><br><span class=\"line\">                        of token, separators, and quoted-string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">       message-body = entity-body</span><br><span class=\"line\">                    | &lt;entity-body encoded as per Transfer-Encoding&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Request-LINE\"><a href=\"#Request-LINE\" class=\"headerlink\" title=\"Request LINE\"></a>Request LINE</h3><h3 id=\"Request-HEADER\"><a href=\"#Request-HEADER\" class=\"headerlink\" title=\"Request HEADER\"></a>Request HEADER</h3><h3 id=\"PAYLOAD\"><a href=\"#PAYLOAD\" class=\"headerlink\" title=\"PAYLOAD\"></a>PAYLOAD</h3><h2 id=\"HTTP-Response组成\"><a href=\"#HTTP-Response组成\" class=\"headerlink\" title=\"HTTP Response组成\"></a>HTTP Response组成</h2><h3 id=\"URI-协议\"><a href=\"#URI-协议\" class=\"headerlink\" title=\"URI 协议\"></a>URI 协议</h3><h3 id=\"Response-HEADER\"><a href=\"#Response-HEADER\" class=\"headerlink\" title=\"Response HEADER\"></a>Response HEADER</h3><h3 id=\"Response-Body\"><a href=\"#Response-Body\" class=\"headerlink\" title=\"Response Body\"></a>Response Body</h3><h3 id=\"CGI示例\"><a href=\"#CGI示例\" class=\"headerlink\" title=\"CGI示例\"></a>CGI示例</h3><p>cache </p>\n<p>keep-alive</p>\n<p>websocket</p>\n<h2 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h2><p>文本协议，需要转换</p>\n<h1 id=\"HTTP-2-0\"><a href=\"#HTTP-2-0\" class=\"headerlink\" title=\"HTTP 2.0\"></a>HTTP 2.0</h1><blockquote>\n<p>SPDY（发音如英语：speedy），一种开放的网络传输协议，由Google开发，用来发送网页内容。基于传输控制协议（TCP）的应用层协议。SPDY也就是HTTP/2的前身。Google最早是在Chromium中提出的SPDY协议[1]。被用于Google Chrome浏览器中来访问Google的SSL加密服务。SPDY并不是首字母缩略字，而仅仅是”speedy”的缩写。SPDY现为Google的商标[2]。HTTP/2的关键功能主要来自SPDY技术，换言之，SPDY的成果被采纳而最终演变为HTTP/2。</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://www.ntu.edu.sg/home/ehchua/programming/webprogramming/HTTP_Basics.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">In Introduction to HTTP Basics</a></p>\n<p><a href=\"http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">HTTP2.0的奇妙日常 | Web前端 腾讯AlloyTeam Blog | 愿景: 成为地球卓越的Web团队！</a></p>\n<p><a href=\"http://www.infoq.com/cn/news/2015/04/burns-servlet-http2\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Ed Burns谈HTTP/2和Java EE Servlet 4规范</a></p>\n<p><a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">HTTP/1.1: HTTP Message</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"HTTP-Request组成\"><a href=\"#HTTP-Request组成\" class=\"headerlink\" title=\"HTTP Request组成\"></a>HTTP Request组成</h2><img src=\"/2018/03/15/http/http_request_message.png\">\n<p>CRLF分隔</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP-message   = Request | Response     ; HTTP/1.1 messages</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> generic-message = start-line</span><br><span class=\"line\">                          *(message-header CRLF)</span><br><span class=\"line\">                          CRLF</span><br><span class=\"line\">                          [ message-body ]</span><br><span class=\"line\">        start-line      = Request-Line | Status-Line</span><br><span class=\"line\"></span><br><span class=\"line\">    message-header = field-name &quot;:&quot; [ field-value ]</span><br><span class=\"line\">       field-name     = token</span><br><span class=\"line\">       field-value    = *( field-content | LWS )</span><br><span class=\"line\">       field-content  = &lt;the OCTETs making up the field-value</span><br><span class=\"line\">                        and consisting of either *TEXT or combinations</span><br><span class=\"line\">                        of token, separators, and quoted-string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">       message-body = entity-body</span><br><span class=\"line\">                    | &lt;entity-body encoded as per Transfer-Encoding&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Request-LINE\"><a href=\"#Request-LINE\" class=\"headerlink\" title=\"Request LINE\"></a>Request LINE</h3><h3 id=\"Request-HEADER\"><a href=\"#Request-HEADER\" class=\"headerlink\" title=\"Request HEADER\"></a>Request HEADER</h3><h3 id=\"PAYLOAD\"><a href=\"#PAYLOAD\" class=\"headerlink\" title=\"PAYLOAD\"></a>PAYLOAD</h3><h2 id=\"HTTP-Response组成\"><a href=\"#HTTP-Response组成\" class=\"headerlink\" title=\"HTTP Response组成\"></a>HTTP Response组成</h2><h3 id=\"URI-协议\"><a href=\"#URI-协议\" class=\"headerlink\" title=\"URI 协议\"></a>URI 协议</h3><h3 id=\"Response-HEADER\"><a href=\"#Response-HEADER\" class=\"headerlink\" title=\"Response HEADER\"></a>Response HEADER</h3><h3 id=\"Response-Body\"><a href=\"#Response-Body\" class=\"headerlink\" title=\"Response Body\"></a>Response Body</h3><h3 id=\"CGI示例\"><a href=\"#CGI示例\" class=\"headerlink\" title=\"CGI示例\"></a>CGI示例</h3><p>cache </p>\n<p>keep-alive</p>\n<p>websocket</p>\n<h2 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h2><p>文本协议，需要转换</p>\n<h1 id=\"HTTP-2-0\"><a href=\"#HTTP-2-0\" class=\"headerlink\" title=\"HTTP 2.0\"></a>HTTP 2.0</h1><blockquote>\n<p>SPDY（发音如英语：speedy），一种开放的网络传输协议，由Google开发，用来发送网页内容。基于传输控制协议（TCP）的应用层协议。SPDY也就是HTTP/2的前身。Google最早是在Chromium中提出的SPDY协议[1]。被用于Google Chrome浏览器中来访问Google的SSL加密服务。SPDY并不是首字母缩略字，而仅仅是”speedy”的缩写。SPDY现为Google的商标[2]。HTTP/2的关键功能主要来自SPDY技术，换言之，SPDY的成果被采纳而最终演变为HTTP/2。</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://www.ntu.edu.sg/home/ehchua/programming/webprogramming/HTTP_Basics.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">In Introduction to HTTP Basics</a></p>\n<p><a href=\"http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">HTTP2.0的奇妙日常 | Web前端 腾讯AlloyTeam Blog | 愿景: 成为地球卓越的Web团队！</a></p>\n<p><a href=\"http://www.infoq.com/cn/news/2015/04/burns-servlet-http2\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Ed Burns谈HTTP/2和Java EE Servlet 4规范</a></p>\n<p><a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">HTTP/1.1: HTTP Message</a></p>\n"},{"title":"idea-plugins","toc":true,"abbrlink":40277,"category":null,"_content":"","source":"_drafts/idea-plugins.md","raw":"---\ntitle: idea-plugins\ntoc: true\nabbrlink: 40277\ntags:\ncategory:\n---\n","slug":"idea-plugins","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd6y001gjh4ks6w0u066","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"impress.js","toc":true,"abbrlink":54895,"category":null,"_content":"","source":"_drafts/impress-js.md","raw":"---\ntitle: impress.js\ntoc: true\nabbrlink: 54895\ntags:\ncategory:\n---\n","slug":"impress-js","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.369Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd71001jjh4kqj8mx8we","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"inode","toc":true,"abbrlink":6042,"_content":"\n\n## TODO\n\n- 进程何时释放File Descriptor？可共享？\n- Dentry是如何构建的？\n- linux VFS\n\n[Linux VFS分析(二) - 北落不吉 - 博客园](http://www.cnblogs.com/hzl6255/archive/2012/12/31/2840854.html)\n\n\n\ncat /dev/null > catalina.out\n\n\n这是一般记日志的框架不会考虑的，但是确实会遇到。例如文件被误删，或者因为长时间没写日志，文件被清理脚本删掉了（Linux 可以删，但是进程还持有文件 fd，文件 inode 在进程 close 的时候才释放，还可以“正常”读写；对于 Windows，一般锁住删不掉，但是如果用 Unlocker 一类软件是可以解锁句柄的）。出现了这种情况，除非把应用重启，否则只能干瞪眼了。因此，EagleEye 在后台线程还会监视日志文件是否被删除，如果删除了就滚动日志，重建文件。\n\n\n空间局部性(spatial locality)\n\n如果一个存储器的位置被引用，那么将来他附近的位置也会被引用。\n\n## Unix 文件系统\n\n{% asset_image unix-file-structure.jpg %}\n\n- *Active Inode Table* (one, belongs to OS)\n\n    Lists all active inodes (*file descriptors*)\n\n- *Open File Table* (one, belongs to OS)\n\n    Each entry contains:\n        1. Pointer to entry in active inode table\n        2. Current position (offset) in file\n\n- *Per-process file table* (many)\n    \n     Each entry contains:\n        1. Pointer to entry in open file table\n\n\n### 文件描述符(File Descriptor)\n\nA file descriptor (inode) represents a file\n\nAll inodes are stored on the disk in a\nfixed-size array called the ilist\n     The size of the ilist array is determined\n            when the disk is initialized\n    The index of a file descriptor in the array is\n            called its inode number, or inumber\n    Inodes for active files are also cached in\n            memory in the active inode table\n\n### Dentry\n\n文件夹是一种特殊的文件，存储inumber和文件名的映射关系\n\n>To facilitate this, the VFS employs the concept of a directory entry (dentry). A dentry is a specific component in a path. Using the previous example, /, bin, and vi are all dentry objects. The first two are directories and the last is a regular file. This is an important point: dentry objects are all components in a path, including files. Resolving a path and walking its components is a nontrivial exercise, time-consuming and rife with string comparisons. The dentry object makes the whole process easier\n\n>Dentry 是将 Inode 和 文件联系在一起的”粘合剂”，它将 Inode number 和文件名联系起来。Dentry 也在目录缓存中扮演了一定的角色，它缓存最常使用的文件以便于更快速的访问。Dentry 还保存了目录及其子对象的关系，用于文件系统的遍历。\n\nDentry objects are represented by struct dentry and defined in <linux/dcache.h>. Here is the structure, with comments describing each member:\n\n```c\nstruct dentry {\n        atomic_t                 d_count;      /* usage count */\n        unsigned long            d_vfs_flags;  /* dentry cache flags */\n        spinlock_t               d_lock;       /* per-dentry lock */\n        struct inode             *d_inode;     /* associated inode */\n        struct list_head         d_lru;        /* unused list */\n        struct list_head         d_child;      /* list of dentries within */\n        struct list_head         d_subdirs;    /* subdirectories */\n        struct list_head         d_alias;      /* list of alias inodes */\n        unsigned long            d_time;       /* revalidate time */\n        struct dentry_operations *d_op;        /* dentry operations table */\n        struct super_block       *d_sb;        /* superblock of file */\n        unsigned int             d_flags;      /* dentry flags */\n        int                      d_mounted;    /* is this a mount point? */\n        void                     *d_fsdata;    /* filesystem-specific data */\n        struct rcu_head          d_rcu;        /* RCU locking */\n        struct dcookie_struct    *d_cookie;    /* cookie */\n        struct dentry            *d_parent;    /* dentry object of parent */\n        struct qstr              d_name;       /* dentry name */\n        struct hlist_node        d_hash;       /* list of hash table entries */\n        struct hlist_head        *d_bucket;    /* hash bucket */\n        unsigned char            d_iname[DNAME_INLINE_LEN_MIN]; /* short name */\n};\n```\n\n### 磁盘存储的内容的\n\n{% asset_image high-level.jpg %}\n\n{% asset_image low-level.jpg %}\n\nBlocks for storing directories and files\n\nBlocks for storing the ilist\n\n    Inodes corresponding to files\n    Some special inodes\n        – Boot block — code for booting the system\n        – Super block — size of disk, number of free\n        blocks, list of free blocks, size of ilist,\n        number of free inodes in ilist, etc.\n\n### 文件查找示例\n\n{% asset_image example.jpg %}\n\n## 参考\n\n1. [File System Implementation.ppt](http://www.cs.kent.edu/~walker/classes/os.f07/lectures/Walker-11.pdf)\n\n2. [理解inode - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2011/12/inode.html)\n\n3. [局部性原理浅析——良好代码的基本素质 - Geek_Ling - 博客园](http://www.cnblogs.com/yanlingyin/archive/2012/02/11/2347116.html)\n\n4. [Linux文件系统十问，你知道吗？-腾讯大讲堂](http://djt.qq.com/article/view/620)\n\n5. [Linux文件系统基础之inode和dentry](http://codefine.co/2593.html)\n\n6. [关于 Linux 文件系统的 Superblock, Inode, Dentry 和 File – ElmerZhang's Blog](http://www.elmerzhang.com/2012/12/25/suerblock-inode-dentry-file-of-filesystem/)\n\n7. [The Dentry Object](http://www.makelinux.net/books/lkd2/ch12lev1sec7)\n\n","source":"_drafts/inode.md","raw":"---\ntitle: inode\ntoc: true\ntags: inode\ncategory: linux\nabbrlink: 6042\n---\n\n\n## TODO\n\n- 进程何时释放File Descriptor？可共享？\n- Dentry是如何构建的？\n- linux VFS\n\n[Linux VFS分析(二) - 北落不吉 - 博客园](http://www.cnblogs.com/hzl6255/archive/2012/12/31/2840854.html)\n\n\n\ncat /dev/null > catalina.out\n\n\n这是一般记日志的框架不会考虑的，但是确实会遇到。例如文件被误删，或者因为长时间没写日志，文件被清理脚本删掉了（Linux 可以删，但是进程还持有文件 fd，文件 inode 在进程 close 的时候才释放，还可以“正常”读写；对于 Windows，一般锁住删不掉，但是如果用 Unlocker 一类软件是可以解锁句柄的）。出现了这种情况，除非把应用重启，否则只能干瞪眼了。因此，EagleEye 在后台线程还会监视日志文件是否被删除，如果删除了就滚动日志，重建文件。\n\n\n空间局部性(spatial locality)\n\n如果一个存储器的位置被引用，那么将来他附近的位置也会被引用。\n\n## Unix 文件系统\n\n{% asset_image unix-file-structure.jpg %}\n\n- *Active Inode Table* (one, belongs to OS)\n\n    Lists all active inodes (*file descriptors*)\n\n- *Open File Table* (one, belongs to OS)\n\n    Each entry contains:\n        1. Pointer to entry in active inode table\n        2. Current position (offset) in file\n\n- *Per-process file table* (many)\n    \n     Each entry contains:\n        1. Pointer to entry in open file table\n\n\n### 文件描述符(File Descriptor)\n\nA file descriptor (inode) represents a file\n\nAll inodes are stored on the disk in a\nfixed-size array called the ilist\n     The size of the ilist array is determined\n            when the disk is initialized\n    The index of a file descriptor in the array is\n            called its inode number, or inumber\n    Inodes for active files are also cached in\n            memory in the active inode table\n\n### Dentry\n\n文件夹是一种特殊的文件，存储inumber和文件名的映射关系\n\n>To facilitate this, the VFS employs the concept of a directory entry (dentry). A dentry is a specific component in a path. Using the previous example, /, bin, and vi are all dentry objects. The first two are directories and the last is a regular file. This is an important point: dentry objects are all components in a path, including files. Resolving a path and walking its components is a nontrivial exercise, time-consuming and rife with string comparisons. The dentry object makes the whole process easier\n\n>Dentry 是将 Inode 和 文件联系在一起的”粘合剂”，它将 Inode number 和文件名联系起来。Dentry 也在目录缓存中扮演了一定的角色，它缓存最常使用的文件以便于更快速的访问。Dentry 还保存了目录及其子对象的关系，用于文件系统的遍历。\n\nDentry objects are represented by struct dentry and defined in <linux/dcache.h>. Here is the structure, with comments describing each member:\n\n```c\nstruct dentry {\n        atomic_t                 d_count;      /* usage count */\n        unsigned long            d_vfs_flags;  /* dentry cache flags */\n        spinlock_t               d_lock;       /* per-dentry lock */\n        struct inode             *d_inode;     /* associated inode */\n        struct list_head         d_lru;        /* unused list */\n        struct list_head         d_child;      /* list of dentries within */\n        struct list_head         d_subdirs;    /* subdirectories */\n        struct list_head         d_alias;      /* list of alias inodes */\n        unsigned long            d_time;       /* revalidate time */\n        struct dentry_operations *d_op;        /* dentry operations table */\n        struct super_block       *d_sb;        /* superblock of file */\n        unsigned int             d_flags;      /* dentry flags */\n        int                      d_mounted;    /* is this a mount point? */\n        void                     *d_fsdata;    /* filesystem-specific data */\n        struct rcu_head          d_rcu;        /* RCU locking */\n        struct dcookie_struct    *d_cookie;    /* cookie */\n        struct dentry            *d_parent;    /* dentry object of parent */\n        struct qstr              d_name;       /* dentry name */\n        struct hlist_node        d_hash;       /* list of hash table entries */\n        struct hlist_head        *d_bucket;    /* hash bucket */\n        unsigned char            d_iname[DNAME_INLINE_LEN_MIN]; /* short name */\n};\n```\n\n### 磁盘存储的内容的\n\n{% asset_image high-level.jpg %}\n\n{% asset_image low-level.jpg %}\n\nBlocks for storing directories and files\n\nBlocks for storing the ilist\n\n    Inodes corresponding to files\n    Some special inodes\n        – Boot block — code for booting the system\n        – Super block — size of disk, number of free\n        blocks, list of free blocks, size of ilist,\n        number of free inodes in ilist, etc.\n\n### 文件查找示例\n\n{% asset_image example.jpg %}\n\n## 参考\n\n1. [File System Implementation.ppt](http://www.cs.kent.edu/~walker/classes/os.f07/lectures/Walker-11.pdf)\n\n2. [理解inode - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2011/12/inode.html)\n\n3. [局部性原理浅析——良好代码的基本素质 - Geek_Ling - 博客园](http://www.cnblogs.com/yanlingyin/archive/2012/02/11/2347116.html)\n\n4. [Linux文件系统十问，你知道吗？-腾讯大讲堂](http://djt.qq.com/article/view/620)\n\n5. [Linux文件系统基础之inode和dentry](http://codefine.co/2593.html)\n\n6. [关于 Linux 文件系统的 Superblock, Inode, Dentry 和 File – ElmerZhang's Blog](http://www.elmerzhang.com/2012/12/25/suerblock-inode-dentry-file-of-filesystem/)\n\n7. [The Dentry Object](http://www.makelinux.net/books/lkd2/ch12lev1sec7)\n\n","slug":"inode","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd73001mjh4kdqagk4c5","content":"<h2 id=\"TODO\"><a href=\"#TODO\" class=\"headerlink\" title=\"TODO\"></a>TODO</h2><ul>\n<li>进程何时释放File Descriptor？可共享？</li>\n<li>Dentry是如何构建的？</li>\n<li>linux VFS</li>\n</ul>\n<p><a href=\"http://www.cnblogs.com/hzl6255/archive/2012/12/31/2840854.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux VFS分析(二) - 北落不吉 - 博客园</a></p>\n<p>cat /dev/null &gt; catalina.out</p>\n<p>这是一般记日志的框架不会考虑的，但是确实会遇到。例如文件被误删，或者因为长时间没写日志，文件被清理脚本删掉了（Linux 可以删，但是进程还持有文件 fd，文件 inode 在进程 close 的时候才释放，还可以“正常”读写；对于 Windows，一般锁住删不掉，但是如果用 Unlocker 一类软件是可以解锁句柄的）。出现了这种情况，除非把应用重启，否则只能干瞪眼了。因此，EagleEye 在后台线程还会监视日志文件是否被删除，如果删除了就滚动日志，重建文件。</p>\n<p>空间局部性(spatial locality)</p>\n<p>如果一个存储器的位置被引用，那么将来他附近的位置也会被引用。</p>\n<h2 id=\"Unix-文件系统\"><a href=\"#Unix-文件系统\" class=\"headerlink\" title=\"Unix 文件系统\"></a>Unix 文件系统</h2><img src=\"/2018/03/15/inode/unix-file-structure.jpg\">\n<ul>\n<li><p><em>Active Inode Table</em> (one, belongs to OS)</p>\n<p>  Lists all active inodes (<em>file descriptors</em>)</p>\n</li>\n<li><p><em>Open File Table</em> (one, belongs to OS)</p>\n<p>  Each entry contains:</p>\n<pre><code>1. Pointer to entry in active inode table\n2. Current position (offset) in file\n</code></pre></li>\n<li><p><em>Per-process file table</em> (many)</p>\n<p>   Each entry contains:</p>\n<pre><code>1. Pointer to entry in open file table\n</code></pre></li>\n</ul>\n<h3 id=\"文件描述符-File-Descriptor\"><a href=\"#文件描述符-File-Descriptor\" class=\"headerlink\" title=\"文件描述符(File Descriptor)\"></a>文件描述符(File Descriptor)</h3><p>A file descriptor (inode) represents a file</p>\n<p>All inodes are stored on the disk in a<br>fixed-size array called the ilist<br>     The size of the ilist array is determined<br>            when the disk is initialized<br>    The index of a file descriptor in the array is<br>            called its inode number, or inumber<br>    Inodes for active files are also cached in<br>            memory in the active inode table</p>\n<h3 id=\"Dentry\"><a href=\"#Dentry\" class=\"headerlink\" title=\"Dentry\"></a>Dentry</h3><p>文件夹是一种特殊的文件，存储inumber和文件名的映射关系</p>\n<blockquote>\n<p>To facilitate this, the VFS employs the concept of a directory entry (dentry). A dentry is a specific component in a path. Using the previous example, /, bin, and vi are all dentry objects. The first two are directories and the last is a regular file. This is an important point: dentry objects are all components in a path, including files. Resolving a path and walking its components is a nontrivial exercise, time-consuming and rife with string comparisons. The dentry object makes the whole process easier</p>\n<p>Dentry 是将 Inode 和 文件联系在一起的”粘合剂”，它将 Inode number 和文件名联系起来。Dentry 也在目录缓存中扮演了一定的角色，它缓存最常使用的文件以便于更快速的访问。Dentry 还保存了目录及其子对象的关系，用于文件系统的遍历。</p>\n</blockquote>\n<p>Dentry objects are represented by struct dentry and defined in <linux dcache.h=\"\">. Here is the structure, with comments describing each member:</linux></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dentry</span> &#123;</span></span><br><span class=\"line\">        <span class=\"keyword\">atomic_t</span>                 d_count;      <span class=\"comment\">/* usage count */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>            d_vfs_flags;  <span class=\"comment\">/* dentry cache flags */</span></span><br><span class=\"line\">        <span class=\"keyword\">spinlock_t</span>               d_lock;       <span class=\"comment\">/* per-dentry lock */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span>             *<span class=\"title\">d_inode</span>;</span>     <span class=\"comment\">/* associated inode */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_lru</span>;</span>        <span class=\"comment\">/* unused list */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_child</span>;</span>      <span class=\"comment\">/* list of dentries within */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_subdirs</span>;</span>    <span class=\"comment\">/* subdirectories */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_alias</span>;</span>      <span class=\"comment\">/* list of alias inodes */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>            d_time;       <span class=\"comment\">/* revalidate time */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dentry_operations</span> *<span class=\"title\">d_op</span>;</span>        <span class=\"comment\">/* dentry operations table */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">super_block</span>       *<span class=\"title\">d_sb</span>;</span>        <span class=\"comment\">/* superblock of file */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>             d_flags;      <span class=\"comment\">/* dentry flags */</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span>                      d_mounted;    <span class=\"comment\">/* is this a mount point? */</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span>                     *d_fsdata;    <span class=\"comment\">/* filesystem-specific data */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">rcu_head</span>          <span class=\"title\">d_rcu</span>;</span>        <span class=\"comment\">/* RCU locking */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dcookie_struct</span>    *<span class=\"title\">d_cookie</span>;</span>    <span class=\"comment\">/* cookie */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dentry</span>            *<span class=\"title\">d_parent</span>;</span>    <span class=\"comment\">/* dentry object of parent */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">qstr</span>              <span class=\"title\">d_name</span>;</span>       <span class=\"comment\">/* dentry name */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">hlist_node</span>        <span class=\"title\">d_hash</span>;</span>       <span class=\"comment\">/* list of hash table entries */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">hlist_head</span>        *<span class=\"title\">d_bucket</span>;</span>    <span class=\"comment\">/* hash bucket */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span>            d_iname[DNAME_INLINE_LEN_MIN]; <span class=\"comment\">/* short name */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"磁盘存储的内容的\"><a href=\"#磁盘存储的内容的\" class=\"headerlink\" title=\"磁盘存储的内容的\"></a>磁盘存储的内容的</h3><img src=\"/2018/03/15/inode/high-level.jpg\">\n<img src=\"/2018/03/15/inode/low-level.jpg\">\n<p>Blocks for storing directories and files</p>\n<p>Blocks for storing the ilist</p>\n<pre><code>Inodes corresponding to files\nSome special inodes\n    – Boot block — code for booting the system\n    – Super block — size of disk, number of free\n    blocks, list of free blocks, size of ilist,\n    number of free inodes in ilist, etc.\n</code></pre><h3 id=\"文件查找示例\"><a href=\"#文件查找示例\" class=\"headerlink\" title=\"文件查找示例\"></a>文件查找示例</h3><img src=\"/2018/03/15/inode/example.jpg\">\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.cs.kent.edu/~walker/classes/os.f07/lectures/Walker-11.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">File System Implementation.ppt</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2011/12/inode.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">理解inode - 阮一峰的网络日志</a></p>\n</li>\n<li><p><a href=\"http://www.cnblogs.com/yanlingyin/archive/2012/02/11/2347116.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">局部性原理浅析——良好代码的基本素质 - Geek_Ling - 博客园</a></p>\n</li>\n<li><p><a href=\"http://djt.qq.com/article/view/620\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux文件系统十问，你知道吗？-腾讯大讲堂</a></p>\n</li>\n<li><p><a href=\"http://codefine.co/2593.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux文件系统基础之inode和dentry</a></p>\n</li>\n<li><p><a href=\"http://www.elmerzhang.com/2012/12/25/suerblock-inode-dentry-file-of-filesystem/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">关于 Linux 文件系统的 Superblock, Inode, Dentry 和 File – ElmerZhang’s Blog</a></p>\n</li>\n<li><p><a href=\"http://www.makelinux.net/books/lkd2/ch12lev1sec7\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The Dentry Object</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"TODO\"><a href=\"#TODO\" class=\"headerlink\" title=\"TODO\"></a>TODO</h2><ul>\n<li>进程何时释放File Descriptor？可共享？</li>\n<li>Dentry是如何构建的？</li>\n<li>linux VFS</li>\n</ul>\n<p><a href=\"http://www.cnblogs.com/hzl6255/archive/2012/12/31/2840854.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux VFS分析(二) - 北落不吉 - 博客园</a></p>\n<p>cat /dev/null &gt; catalina.out</p>\n<p>这是一般记日志的框架不会考虑的，但是确实会遇到。例如文件被误删，或者因为长时间没写日志，文件被清理脚本删掉了（Linux 可以删，但是进程还持有文件 fd，文件 inode 在进程 close 的时候才释放，还可以“正常”读写；对于 Windows，一般锁住删不掉，但是如果用 Unlocker 一类软件是可以解锁句柄的）。出现了这种情况，除非把应用重启，否则只能干瞪眼了。因此，EagleEye 在后台线程还会监视日志文件是否被删除，如果删除了就滚动日志，重建文件。</p>\n<p>空间局部性(spatial locality)</p>\n<p>如果一个存储器的位置被引用，那么将来他附近的位置也会被引用。</p>\n<h2 id=\"Unix-文件系统\"><a href=\"#Unix-文件系统\" class=\"headerlink\" title=\"Unix 文件系统\"></a>Unix 文件系统</h2><img src=\"/2018/03/15/inode/unix-file-structure.jpg\">\n<ul>\n<li><p><em>Active Inode Table</em> (one, belongs to OS)</p>\n<p>  Lists all active inodes (<em>file descriptors</em>)</p>\n</li>\n<li><p><em>Open File Table</em> (one, belongs to OS)</p>\n<p>  Each entry contains:</p>\n<pre><code>1. Pointer to entry in active inode table\n2. Current position (offset) in file\n</code></pre></li>\n<li><p><em>Per-process file table</em> (many)</p>\n<p>   Each entry contains:</p>\n<pre><code>1. Pointer to entry in open file table\n</code></pre></li>\n</ul>\n<h3 id=\"文件描述符-File-Descriptor\"><a href=\"#文件描述符-File-Descriptor\" class=\"headerlink\" title=\"文件描述符(File Descriptor)\"></a>文件描述符(File Descriptor)</h3><p>A file descriptor (inode) represents a file</p>\n<p>All inodes are stored on the disk in a<br>fixed-size array called the ilist<br>     The size of the ilist array is determined<br>            when the disk is initialized<br>    The index of a file descriptor in the array is<br>            called its inode number, or inumber<br>    Inodes for active files are also cached in<br>            memory in the active inode table</p>\n<h3 id=\"Dentry\"><a href=\"#Dentry\" class=\"headerlink\" title=\"Dentry\"></a>Dentry</h3><p>文件夹是一种特殊的文件，存储inumber和文件名的映射关系</p>\n<blockquote>\n<p>To facilitate this, the VFS employs the concept of a directory entry (dentry). A dentry is a specific component in a path. Using the previous example, /, bin, and vi are all dentry objects. The first two are directories and the last is a regular file. This is an important point: dentry objects are all components in a path, including files. Resolving a path and walking its components is a nontrivial exercise, time-consuming and rife with string comparisons. The dentry object makes the whole process easier</p>\n<p>Dentry 是将 Inode 和 文件联系在一起的”粘合剂”，它将 Inode number 和文件名联系起来。Dentry 也在目录缓存中扮演了一定的角色，它缓存最常使用的文件以便于更快速的访问。Dentry 还保存了目录及其子对象的关系，用于文件系统的遍历。</p>\n</blockquote>\n<p>Dentry objects are represented by struct dentry and defined in <linux dcache.h=\"\">. Here is the structure, with comments describing each member:</linux></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dentry</span> &#123;</span></span><br><span class=\"line\">        <span class=\"keyword\">atomic_t</span>                 d_count;      <span class=\"comment\">/* usage count */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>            d_vfs_flags;  <span class=\"comment\">/* dentry cache flags */</span></span><br><span class=\"line\">        <span class=\"keyword\">spinlock_t</span>               d_lock;       <span class=\"comment\">/* per-dentry lock */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span>             *<span class=\"title\">d_inode</span>;</span>     <span class=\"comment\">/* associated inode */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_lru</span>;</span>        <span class=\"comment\">/* unused list */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_child</span>;</span>      <span class=\"comment\">/* list of dentries within */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_subdirs</span>;</span>    <span class=\"comment\">/* subdirectories */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list_head</span>         <span class=\"title\">d_alias</span>;</span>      <span class=\"comment\">/* list of alias inodes */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>            d_time;       <span class=\"comment\">/* revalidate time */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dentry_operations</span> *<span class=\"title\">d_op</span>;</span>        <span class=\"comment\">/* dentry operations table */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">super_block</span>       *<span class=\"title\">d_sb</span>;</span>        <span class=\"comment\">/* superblock of file */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>             d_flags;      <span class=\"comment\">/* dentry flags */</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span>                      d_mounted;    <span class=\"comment\">/* is this a mount point? */</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span>                     *d_fsdata;    <span class=\"comment\">/* filesystem-specific data */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">rcu_head</span>          <span class=\"title\">d_rcu</span>;</span>        <span class=\"comment\">/* RCU locking */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dcookie_struct</span>    *<span class=\"title\">d_cookie</span>;</span>    <span class=\"comment\">/* cookie */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dentry</span>            *<span class=\"title\">d_parent</span>;</span>    <span class=\"comment\">/* dentry object of parent */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">qstr</span>              <span class=\"title\">d_name</span>;</span>       <span class=\"comment\">/* dentry name */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">hlist_node</span>        <span class=\"title\">d_hash</span>;</span>       <span class=\"comment\">/* list of hash table entries */</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">hlist_head</span>        *<span class=\"title\">d_bucket</span>;</span>    <span class=\"comment\">/* hash bucket */</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span>            d_iname[DNAME_INLINE_LEN_MIN]; <span class=\"comment\">/* short name */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"磁盘存储的内容的\"><a href=\"#磁盘存储的内容的\" class=\"headerlink\" title=\"磁盘存储的内容的\"></a>磁盘存储的内容的</h3><img src=\"/2018/03/15/inode/high-level.jpg\">\n<img src=\"/2018/03/15/inode/low-level.jpg\">\n<p>Blocks for storing directories and files</p>\n<p>Blocks for storing the ilist</p>\n<pre><code>Inodes corresponding to files\nSome special inodes\n    – Boot block — code for booting the system\n    – Super block — size of disk, number of free\n    blocks, list of free blocks, size of ilist,\n    number of free inodes in ilist, etc.\n</code></pre><h3 id=\"文件查找示例\"><a href=\"#文件查找示例\" class=\"headerlink\" title=\"文件查找示例\"></a>文件查找示例</h3><img src=\"/2018/03/15/inode/example.jpg\">\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.cs.kent.edu/~walker/classes/os.f07/lectures/Walker-11.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">File System Implementation.ppt</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2011/12/inode.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">理解inode - 阮一峰的网络日志</a></p>\n</li>\n<li><p><a href=\"http://www.cnblogs.com/yanlingyin/archive/2012/02/11/2347116.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">局部性原理浅析——良好代码的基本素质 - Geek_Ling - 博客园</a></p>\n</li>\n<li><p><a href=\"http://djt.qq.com/article/view/620\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux文件系统十问，你知道吗？-腾讯大讲堂</a></p>\n</li>\n<li><p><a href=\"http://codefine.co/2593.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux文件系统基础之inode和dentry</a></p>\n</li>\n<li><p><a href=\"http://www.elmerzhang.com/2012/12/25/suerblock-inode-dentry-file-of-filesystem/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">关于 Linux 文件系统的 Superblock, Inode, Dentry 和 File – ElmerZhang’s Blog</a></p>\n</li>\n<li><p><a href=\"http://www.makelinux.net/books/lkd2/ch12lev1sec7\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The Dentry Object</a></p>\n</li>\n</ol>\n"},{"title":"java-URL","toc":true,"abbrlink":58981,"category":null,"_content":"","source":"_drafts/java-URL.md","raw":"---\ntitle: java-URL\ntoc: true\nabbrlink: 58981\ntags:\ncategory:\n---\n","slug":"java-URL","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd74001pjh4kyw86g9zr","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"java垃圾回收（GC）总结","toc":true,"abbrlink":18158,"_content":"\n\n\n```bash\n#!/bin/sh\n\nexport TOMCAT_USER=\"tomcat\"\nexport JAVA_OPTS=\"-Xms24g -Xmx24g -Xmn8g -XX:PermSize=512m -XX:MaxPermSize=512M -XX:SurvivorRatio=5 -server -XX:+TieredCompilation -XX:CICompilerCount=12 -XX:+DisableExplicitGC -Dlogs=$CATALINA_BASE/logs -Dcache=$CATALINA_BASE/cache -verbose:gc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGC -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=1 -Xloggc:$CATALINA_BASE/logs/gc.log\"\nchown -R tomcat:tomcat $CATALINA_BASE/logs\nchown -R tomcat:tomcat $CATALINA_BASE/cache\nchown -R tomcat:tomcat $CATALINA_BASE/conf\nchown -R tomcat:tomcat $CATALINA_BASE/work\nchown -R tomcat:tomcat $CATALINA_BASE/temp\n```\n\n综合使用，防止同时gc？\n\n### GC 日志\n\n#### \"Allocation Failure\" 是什么鬼？\n\n\"Allocation Failure\" is a cause of GC cycle to kick.\n\n\"Allocation Failure\" means that no more space left in Eden to allocate object. So, it is normal cause of young GC.\n\nOlder JVM were not printing GC cause for minor GC cycles.\n\n\"Allocation Failure\" is almost only possible cause for minor GC. Another reason for minor GC to kick could be CMS remark phase (if +XX:+ScavengeBeforeRemark is enabled).\n\n\n## 参考\n\n1. [JVM日志和参数的理解 | Sina App Engine Blog](http://blog.sae.sina.com.cn/archives/4141)\n\n2. [garbage collection - Java GC (Allocation Failure) - Stack Overflow](http://stackoverflow.com/questions/28342736/java-gc-allocation-failure)\n\n3. [JVM 垃圾回收器工作原理及使用实例介绍](https://www.ibm.com/developerworks/cn/java/j-lo-JVMGarbageCollection/)\n\n\n\n","source":"_drafts/java-gc.md","raw":"---\ntitle: java垃圾回收（GC）总结\ntoc: true\ncategory: gc\nabbrlink: 18158\ntags:\n---\n\n\n\n```bash\n#!/bin/sh\n\nexport TOMCAT_USER=\"tomcat\"\nexport JAVA_OPTS=\"-Xms24g -Xmx24g -Xmn8g -XX:PermSize=512m -XX:MaxPermSize=512M -XX:SurvivorRatio=5 -server -XX:+TieredCompilation -XX:CICompilerCount=12 -XX:+DisableExplicitGC -Dlogs=$CATALINA_BASE/logs -Dcache=$CATALINA_BASE/cache -verbose:gc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGC -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=1 -Xloggc:$CATALINA_BASE/logs/gc.log\"\nchown -R tomcat:tomcat $CATALINA_BASE/logs\nchown -R tomcat:tomcat $CATALINA_BASE/cache\nchown -R tomcat:tomcat $CATALINA_BASE/conf\nchown -R tomcat:tomcat $CATALINA_BASE/work\nchown -R tomcat:tomcat $CATALINA_BASE/temp\n```\n\n综合使用，防止同时gc？\n\n### GC 日志\n\n#### \"Allocation Failure\" 是什么鬼？\n\n\"Allocation Failure\" is a cause of GC cycle to kick.\n\n\"Allocation Failure\" means that no more space left in Eden to allocate object. So, it is normal cause of young GC.\n\nOlder JVM were not printing GC cause for minor GC cycles.\n\n\"Allocation Failure\" is almost only possible cause for minor GC. Another reason for minor GC to kick could be CMS remark phase (if +XX:+ScavengeBeforeRemark is enabled).\n\n\n## 参考\n\n1. [JVM日志和参数的理解 | Sina App Engine Blog](http://blog.sae.sina.com.cn/archives/4141)\n\n2. [garbage collection - Java GC (Allocation Failure) - Stack Overflow](http://stackoverflow.com/questions/28342736/java-gc-allocation-failure)\n\n3. [JVM 垃圾回收器工作原理及使用实例介绍](https://www.ibm.com/developerworks/cn/java/j-lo-JVMGarbageCollection/)\n\n\n\n","slug":"java-gc","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd76001rjh4k62pfxrl0","content":"<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">export</span> TOMCAT_USER=<span class=\"string\">\"tomcat\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS=<span class=\"string\">\"-Xms24g -Xmx24g -Xmn8g -XX:PermSize=512m -XX:MaxPermSize=512M -XX:SurvivorRatio=5 -server -XX:+TieredCompilation -XX:CICompilerCount=12 -XX:+DisableExplicitGC -Dlogs=<span class=\"variable\">$CATALINA_BASE</span>/logs -Dcache=<span class=\"variable\">$CATALINA_BASE</span>/cache -verbose:gc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGC -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=1 -Xloggc:<span class=\"variable\">$CATALINA_BASE</span>/logs/gc.log\"</span></span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/logs</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/cache</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/conf</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/work</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/temp</span><br></pre></td></tr></table></figure>\n<p>综合使用，防止同时gc？</p>\n<h3 id=\"GC-日志\"><a href=\"#GC-日志\" class=\"headerlink\" title=\"GC 日志\"></a>GC 日志</h3><h4 id=\"“Allocation-Failure”-是什么鬼？\"><a href=\"#“Allocation-Failure”-是什么鬼？\" class=\"headerlink\" title=\"“Allocation Failure” 是什么鬼？\"></a>“Allocation Failure” 是什么鬼？</h4><p>“Allocation Failure” is a cause of GC cycle to kick.</p>\n<p>“Allocation Failure” means that no more space left in Eden to allocate object. So, it is normal cause of young GC.</p>\n<p>Older JVM were not printing GC cause for minor GC cycles.</p>\n<p>“Allocation Failure” is almost only possible cause for minor GC. Another reason for minor GC to kick could be CMS remark phase (if +XX:+ScavengeBeforeRemark is enabled).</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://blog.sae.sina.com.cn/archives/4141\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM日志和参数的理解 | Sina App Engine Blog</a></p>\n</li>\n<li><p><a href=\"http://stackoverflow.com/questions/28342736/java-gc-allocation-failure\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">garbage collection - Java GC (Allocation Failure) - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-JVMGarbageCollection/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM 垃圾回收器工作原理及使用实例介绍</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">export</span> TOMCAT_USER=<span class=\"string\">\"tomcat\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS=<span class=\"string\">\"-Xms24g -Xmx24g -Xmn8g -XX:PermSize=512m -XX:MaxPermSize=512M -XX:SurvivorRatio=5 -server -XX:+TieredCompilation -XX:CICompilerCount=12 -XX:+DisableExplicitGC -Dlogs=<span class=\"variable\">$CATALINA_BASE</span>/logs -Dcache=<span class=\"variable\">$CATALINA_BASE</span>/cache -verbose:gc -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGC -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=1 -Xloggc:<span class=\"variable\">$CATALINA_BASE</span>/logs/gc.log\"</span></span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/logs</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/cache</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/conf</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/work</span><br><span class=\"line\">chown -R tomcat:tomcat <span class=\"variable\">$CATALINA_BASE</span>/temp</span><br></pre></td></tr></table></figure>\n<p>综合使用，防止同时gc？</p>\n<h3 id=\"GC-日志\"><a href=\"#GC-日志\" class=\"headerlink\" title=\"GC 日志\"></a>GC 日志</h3><h4 id=\"“Allocation-Failure”-是什么鬼？\"><a href=\"#“Allocation-Failure”-是什么鬼？\" class=\"headerlink\" title=\"“Allocation Failure” 是什么鬼？\"></a>“Allocation Failure” 是什么鬼？</h4><p>“Allocation Failure” is a cause of GC cycle to kick.</p>\n<p>“Allocation Failure” means that no more space left in Eden to allocate object. So, it is normal cause of young GC.</p>\n<p>Older JVM were not printing GC cause for minor GC cycles.</p>\n<p>“Allocation Failure” is almost only possible cause for minor GC. Another reason for minor GC to kick could be CMS remark phase (if +XX:+ScavengeBeforeRemark is enabled).</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://blog.sae.sina.com.cn/archives/4141\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM日志和参数的理解 | Sina App Engine Blog</a></p>\n</li>\n<li><p><a href=\"http://stackoverflow.com/questions/28342736/java-gc-allocation-failure\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">garbage collection - Java GC (Allocation Failure) - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-JVMGarbageCollection/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM 垃圾回收器工作原理及使用实例介绍</a></p>\n</li>\n</ol>\n"},{"title":"jackson_custom","toc":true,"abbrlink":18103,"_content":"\n## 模块\n\njackson主要有三个模块： `jackson-core`, `jackson-databind`, `jackson-annotation`.\n\n- `jackson-core`\n\n- `jackson-databind`\n\n- `jackson-annotation`\n\nModule\n\n## 使用\n\n### maven 依赖\n\njackson有两个包名，一个是1.x之前使用的，一个是2.x之后使用的\n\n> org.codehaus.jackson is an older version of Jackson.\n\n> com.fasterxml.jackson represents the new project and package.\n\n> The reason is, Jackson has moved from Codehaus to Github when releasing Jackson 2.\n\nmaven依赖：\n\n```xml\n<properties>\n  ...\n  <!-- Use the latest version whenever possible. -->\n  <jackson.version>2.9.0</jackson.version>\n  ...\n</properties>\n\n<dependencies>\n  ...\n  <dependency>\n    <groupId>com.fasterxml.jackson.core</groupId>\n    <artifactId>jackson-databind</artifactId>\n    <version>${jackson.version}</version>\n  </dependency>\n  ...\n</dependencies>\n```\n默认解析公有的字段，和带有getter和setter的字段\n`@JsonAutoDetect`\n\nChanging property auto-detection\n\nThe default Jackson property detection rules will find:\n\nAll ''public'' fields\nAll ''public'' getters ('getXxx()' methods)\nAll setters ('setXxx(value)' methods), ''regardless of visibility'')\n\n```java\n@JsonAutoDetect(fieldVisibility=JsonAutoDetect.Visibility.NONE)\npublic class POJOWithNoFields {\n  // will NOT be included, unless there is access 'getValue()'\n  public int value;\n}\n```\n\n### 忽略属性\n\n@JsonIgnore\n忽略一些属性\n@JsonIgnoreProperties({\"ignored1\", \"ignored2\"})\nignoreUnknown=true\n\n\n@JsonProperty\n指定输出的key\n\n@JsonFilter\n\n@JsonGetter\n\n定制\n\n@JsonDeserialize\n@JsonSerialize\n\n默认使用无参的构造函数来构造，但是可以使用@JsonCreator去指定构造函数\n\n使用@JsonProperty去指定参数\n\n```java\npublic class CtorPOJO {\n   private final int _x, _y;\n\n   @JsonCreator\n   public CtorPOJO(@JsonProperty(\"x\") int x, @JsonProperty(\"y\") int y) {\n      _x = x;\n      _y = y;\n   }\n}\n```\n\njackson-annotations  定义一些注解\n\n\n\n\n定义解析\n\n多态支持\n\n@JsonTypeInfo\n\n```java\n// Include Java class name (\"com.myempl.ImplClass\") as JSON property \"class\"\n@JsonTypeInfo(use=Id.CLASS, include=As.PROPERTY, property=\"class\")\npublic abstract class BaseClass {\n}\n\npublic class Impl1 extends BaseClass {\n  public int x;\n}\npublic class Impl2 extends BaseClass {\n  public String name;\n}\n\npublic class PojoWithTypedObjects {\n  public List<BaseClass> items;\n}\n```\n\n空字段\n\n各种配置\n\nMap的Key Deserializer 构造函数\n\n@JsonDeserialize(keyUsing = ShortDateKeyDeserializer.class)\n\ncom.fasterxml.jackson.databind.JsonMappingException: Can not find a (Map) Key deserializer for type [simple type, class com.qunar.hotel.price.root.beans.time.ShortDate]\n\n## 参考\n\n1. [FasterXML/jackson-annotations: Core annotations (annotations that only depend on jackson-core) for Jackson data processor](https://github.com/FasterXML/jackson-annotations)\n\n2. [Jackson fasterxml和codehaus的区别 （fasterxml vs. codehaus） - Clement-Xu的专栏 - CSDN博客](http://blog.csdn.net/clementad/article/details/46416647)\n\n3. [java - org.codehaus.jackson versus com.fasterxml.jackson.core - Stack Overflow](https://stackoverflow.com/questions/30782706/org-codehaus-jackson-versus-com-fasterxml-jackson-core)\n\n4. [Jackson data binding - 知乎专栏](https://zhuanlan.zhihu.com/p/23392268)\n\n\n注入的message-converters优先级高于默认注入的json转换器","source":"_drafts/jackson-custom.md","raw":"---\ntitle: jackson_custom\ntags: jackson\ncategory: jackson\ntoc: true\nabbrlink: 18103\n---\n\n## 模块\n\njackson主要有三个模块： `jackson-core`, `jackson-databind`, `jackson-annotation`.\n\n- `jackson-core`\n\n- `jackson-databind`\n\n- `jackson-annotation`\n\nModule\n\n## 使用\n\n### maven 依赖\n\njackson有两个包名，一个是1.x之前使用的，一个是2.x之后使用的\n\n> org.codehaus.jackson is an older version of Jackson.\n\n> com.fasterxml.jackson represents the new project and package.\n\n> The reason is, Jackson has moved from Codehaus to Github when releasing Jackson 2.\n\nmaven依赖：\n\n```xml\n<properties>\n  ...\n  <!-- Use the latest version whenever possible. -->\n  <jackson.version>2.9.0</jackson.version>\n  ...\n</properties>\n\n<dependencies>\n  ...\n  <dependency>\n    <groupId>com.fasterxml.jackson.core</groupId>\n    <artifactId>jackson-databind</artifactId>\n    <version>${jackson.version}</version>\n  </dependency>\n  ...\n</dependencies>\n```\n默认解析公有的字段，和带有getter和setter的字段\n`@JsonAutoDetect`\n\nChanging property auto-detection\n\nThe default Jackson property detection rules will find:\n\nAll ''public'' fields\nAll ''public'' getters ('getXxx()' methods)\nAll setters ('setXxx(value)' methods), ''regardless of visibility'')\n\n```java\n@JsonAutoDetect(fieldVisibility=JsonAutoDetect.Visibility.NONE)\npublic class POJOWithNoFields {\n  // will NOT be included, unless there is access 'getValue()'\n  public int value;\n}\n```\n\n### 忽略属性\n\n@JsonIgnore\n忽略一些属性\n@JsonIgnoreProperties({\"ignored1\", \"ignored2\"})\nignoreUnknown=true\n\n\n@JsonProperty\n指定输出的key\n\n@JsonFilter\n\n@JsonGetter\n\n定制\n\n@JsonDeserialize\n@JsonSerialize\n\n默认使用无参的构造函数来构造，但是可以使用@JsonCreator去指定构造函数\n\n使用@JsonProperty去指定参数\n\n```java\npublic class CtorPOJO {\n   private final int _x, _y;\n\n   @JsonCreator\n   public CtorPOJO(@JsonProperty(\"x\") int x, @JsonProperty(\"y\") int y) {\n      _x = x;\n      _y = y;\n   }\n}\n```\n\njackson-annotations  定义一些注解\n\n\n\n\n定义解析\n\n多态支持\n\n@JsonTypeInfo\n\n```java\n// Include Java class name (\"com.myempl.ImplClass\") as JSON property \"class\"\n@JsonTypeInfo(use=Id.CLASS, include=As.PROPERTY, property=\"class\")\npublic abstract class BaseClass {\n}\n\npublic class Impl1 extends BaseClass {\n  public int x;\n}\npublic class Impl2 extends BaseClass {\n  public String name;\n}\n\npublic class PojoWithTypedObjects {\n  public List<BaseClass> items;\n}\n```\n\n空字段\n\n各种配置\n\nMap的Key Deserializer 构造函数\n\n@JsonDeserialize(keyUsing = ShortDateKeyDeserializer.class)\n\ncom.fasterxml.jackson.databind.JsonMappingException: Can not find a (Map) Key deserializer for type [simple type, class com.qunar.hotel.price.root.beans.time.ShortDate]\n\n## 参考\n\n1. [FasterXML/jackson-annotations: Core annotations (annotations that only depend on jackson-core) for Jackson data processor](https://github.com/FasterXML/jackson-annotations)\n\n2. [Jackson fasterxml和codehaus的区别 （fasterxml vs. codehaus） - Clement-Xu的专栏 - CSDN博客](http://blog.csdn.net/clementad/article/details/46416647)\n\n3. [java - org.codehaus.jackson versus com.fasterxml.jackson.core - Stack Overflow](https://stackoverflow.com/questions/30782706/org-codehaus-jackson-versus-com-fasterxml-jackson-core)\n\n4. [Jackson data binding - 知乎专栏](https://zhuanlan.zhihu.com/p/23392268)\n\n\n注入的message-converters优先级高于默认注入的json转换器","slug":"jackson-custom","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-04T12:34:00.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd77001vjh4kngxpnq8l","content":"<h2 id=\"模块\"><a href=\"#模块\" class=\"headerlink\" title=\"模块\"></a>模块</h2><p>jackson主要有三个模块： <code>jackson-core</code>, <code>jackson-databind</code>, <code>jackson-annotation</code>.</p>\n<ul>\n<li><p><code>jackson-core</code></p>\n</li>\n<li><p><code>jackson-databind</code></p>\n</li>\n<li><p><code>jackson-annotation</code></p>\n</li>\n</ul>\n<p>Module</p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><h3 id=\"maven-依赖\"><a href=\"#maven-依赖\" class=\"headerlink\" title=\"maven 依赖\"></a>maven 依赖</h3><p>jackson有两个包名，一个是1.x之前使用的，一个是2.x之后使用的</p>\n<blockquote>\n<p>org.codehaus.jackson is an older version of Jackson.</p>\n<p>com.fasterxml.jackson represents the new project and package.</p>\n<p>The reason is, Jackson has moved from Codehaus to Github when releasing Jackson 2.</p>\n</blockquote>\n<p>maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Use the latest version whenever possible. --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">jackson.version</span>&gt;</span>2.9.0<span class=\"tag\">&lt;/<span class=\"name\">jackson.version</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-databind<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;jackson.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>默认解析公有的字段，和带有getter和setter的字段<br><code>@JsonAutoDetect</code></p>\n<p>Changing property auto-detection</p>\n<p>The default Jackson property detection rules will find:</p>\n<p>All ‘’public’’ fields<br>All ‘’public’’ getters (‘getXxx()’ methods)<br>All setters (‘setXxx(value)’ methods), ‘’regardless of visibility’’)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@JsonAutoDetect</span>(fieldVisibility=JsonAutoDetect.Visibility.NONE)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">POJOWithNoFields</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// will NOT be included, unless there is access 'getValue()'</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"忽略属性\"><a href=\"#忽略属性\" class=\"headerlink\" title=\"忽略属性\"></a>忽略属性</h3><p>@JsonIgnore<br>忽略一些属性<br>@JsonIgnoreProperties({“ignored1”, “ignored2”})<br>ignoreUnknown=true</p>\n<p>@JsonProperty<br>指定输出的key</p>\n<p>@JsonFilter</p>\n<p>@JsonGetter</p>\n<p>定制</p>\n<p>@JsonDeserialize<br>@JsonSerialize</p>\n<p>默认使用无参的构造函数来构造，但是可以使用@JsonCreator去指定构造函数</p>\n<p>使用@JsonProperty去指定参数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CtorPOJO</span> </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> _x, _y;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"meta\">@JsonCreator</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CtorPOJO</span><span class=\"params\">(@JsonProperty(<span class=\"string\">\"x\"</span>)</span> <span class=\"keyword\">int</span> x, @<span class=\"title\">JsonProperty</span><span class=\"params\">(<span class=\"string\">\"y\"</span>)</span> <span class=\"keyword\">int</span> y) </span>&#123;</span><br><span class=\"line\">      _x = x;</span><br><span class=\"line\">      _y = y;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>jackson-annotations  定义一些注解</p>\n<p>定义解析</p>\n<p>多态支持</p>\n<p>@JsonTypeInfo</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Include Java class name (\"com.myempl.ImplClass\") as JSON property \"class\"</span></span><br><span class=\"line\"><span class=\"meta\">@JsonTypeInfo</span>(use=Id.CLASS, include=As.PROPERTY, property=<span class=\"string\">\"class\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BaseClass</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Impl1</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseClass</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Impl2</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseClass</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> String name;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PojoWithTypedObjects</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> List&lt;BaseClass&gt; items;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>空字段</p>\n<p>各种配置</p>\n<p>Map的Key Deserializer 构造函数</p>\n<p>@JsonDeserialize(keyUsing = ShortDateKeyDeserializer.class)</p>\n<p>com.fasterxml.jackson.databind.JsonMappingException: Can not find a (Map) Key deserializer for type [simple type, class com.qunar.hotel.price.root.beans.time.ShortDate]</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://github.com/FasterXML/jackson-annotations\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">FasterXML/jackson-annotations: Core annotations (annotations that only depend on jackson-core) for Jackson data processor</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/clementad/article/details/46416647\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jackson fasterxml和codehaus的区别 （fasterxml vs. codehaus） - Clement-Xu的专栏 - CSDN博客</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/30782706/org-codehaus-jackson-versus-com-fasterxml-jackson-core\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - org.codehaus.jackson versus com.fasterxml.jackson.core - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"https://zhuanlan.zhihu.com/p/23392268\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jackson data binding - 知乎专栏</a></p>\n</li>\n</ol>\n<p>注入的message-converters优先级高于默认注入的json转换器</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"模块\"><a href=\"#模块\" class=\"headerlink\" title=\"模块\"></a>模块</h2><p>jackson主要有三个模块： <code>jackson-core</code>, <code>jackson-databind</code>, <code>jackson-annotation</code>.</p>\n<ul>\n<li><p><code>jackson-core</code></p>\n</li>\n<li><p><code>jackson-databind</code></p>\n</li>\n<li><p><code>jackson-annotation</code></p>\n</li>\n</ul>\n<p>Module</p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><h3 id=\"maven-依赖\"><a href=\"#maven-依赖\" class=\"headerlink\" title=\"maven 依赖\"></a>maven 依赖</h3><p>jackson有两个包名，一个是1.x之前使用的，一个是2.x之后使用的</p>\n<blockquote>\n<p>org.codehaus.jackson is an older version of Jackson.</p>\n<p>com.fasterxml.jackson represents the new project and package.</p>\n<p>The reason is, Jackson has moved from Codehaus to Github when releasing Jackson 2.</p>\n</blockquote>\n<p>maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Use the latest version whenever possible. --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">jackson.version</span>&gt;</span>2.9.0<span class=\"tag\">&lt;/<span class=\"name\">jackson.version</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-databind<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;jackson.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>默认解析公有的字段，和带有getter和setter的字段<br><code>@JsonAutoDetect</code></p>\n<p>Changing property auto-detection</p>\n<p>The default Jackson property detection rules will find:</p>\n<p>All ‘’public’’ fields<br>All ‘’public’’ getters (‘getXxx()’ methods)<br>All setters (‘setXxx(value)’ methods), ‘’regardless of visibility’’)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@JsonAutoDetect</span>(fieldVisibility=JsonAutoDetect.Visibility.NONE)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">POJOWithNoFields</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// will NOT be included, unless there is access 'getValue()'</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"忽略属性\"><a href=\"#忽略属性\" class=\"headerlink\" title=\"忽略属性\"></a>忽略属性</h3><p>@JsonIgnore<br>忽略一些属性<br>@JsonIgnoreProperties({“ignored1”, “ignored2”})<br>ignoreUnknown=true</p>\n<p>@JsonProperty<br>指定输出的key</p>\n<p>@JsonFilter</p>\n<p>@JsonGetter</p>\n<p>定制</p>\n<p>@JsonDeserialize<br>@JsonSerialize</p>\n<p>默认使用无参的构造函数来构造，但是可以使用@JsonCreator去指定构造函数</p>\n<p>使用@JsonProperty去指定参数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CtorPOJO</span> </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> _x, _y;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"meta\">@JsonCreator</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CtorPOJO</span><span class=\"params\">(@JsonProperty(<span class=\"string\">\"x\"</span>)</span> <span class=\"keyword\">int</span> x, @<span class=\"title\">JsonProperty</span><span class=\"params\">(<span class=\"string\">\"y\"</span>)</span> <span class=\"keyword\">int</span> y) </span>&#123;</span><br><span class=\"line\">      _x = x;</span><br><span class=\"line\">      _y = y;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>jackson-annotations  定义一些注解</p>\n<p>定义解析</p>\n<p>多态支持</p>\n<p>@JsonTypeInfo</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Include Java class name (\"com.myempl.ImplClass\") as JSON property \"class\"</span></span><br><span class=\"line\"><span class=\"meta\">@JsonTypeInfo</span>(use=Id.CLASS, include=As.PROPERTY, property=<span class=\"string\">\"class\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BaseClass</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Impl1</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseClass</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Impl2</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseClass</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> String name;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PojoWithTypedObjects</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> List&lt;BaseClass&gt; items;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>空字段</p>\n<p>各种配置</p>\n<p>Map的Key Deserializer 构造函数</p>\n<p>@JsonDeserialize(keyUsing = ShortDateKeyDeserializer.class)</p>\n<p>com.fasterxml.jackson.databind.JsonMappingException: Can not find a (Map) Key deserializer for type [simple type, class com.qunar.hotel.price.root.beans.time.ShortDate]</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://github.com/FasterXML/jackson-annotations\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">FasterXML/jackson-annotations: Core annotations (annotations that only depend on jackson-core) for Jackson data processor</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/clementad/article/details/46416647\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jackson fasterxml和codehaus的区别 （fasterxml vs. codehaus） - Clement-Xu的专栏 - CSDN博客</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/30782706/org-codehaus-jackson-versus-com-fasterxml-jackson-core\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - org.codehaus.jackson versus com.fasterxml.jackson.core - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"https://zhuanlan.zhihu.com/p/23392268\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jackson data binding - 知乎专栏</a></p>\n</li>\n</ol>\n<p>注入的message-converters优先级高于默认注入的json转换器</p>\n"},{"title":"java-introspector","toc":true,"abbrlink":39876,"category":null,"_content":"\nhttp://www.slideshare.net/kim.mens/basics-of-reflection-in-java\n\nhttp://jjhou.boolan.com/javatwo-2004-reflection.pdf\n\n/**\n * The Introspector class provides a standard way for tools to learn about\n * the properties, events, and methods supported by a target Java Bean.\n * <p>\n * For more information about introspection and design patterns, please\n * consult the\n *  <a href=\"http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html\">JavaBeans&trade; specification</a>.\n */\n\npublic class Introspector {\n\nBeanInfo  \n\n\ninstanceof  C++\n\npython 中的内省\n\nmethod\n\n","source":"_drafts/java-introspector.md","raw":"---\ntitle: java-introspector\ntoc: true\nabbrlink: 39876\ntags:\ncategory:\n---\n\nhttp://www.slideshare.net/kim.mens/basics-of-reflection-in-java\n\nhttp://jjhou.boolan.com/javatwo-2004-reflection.pdf\n\n/**\n * The Introspector class provides a standard way for tools to learn about\n * the properties, events, and methods supported by a target Java Bean.\n * <p>\n * For more information about introspection and design patterns, please\n * consult the\n *  <a href=\"http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html\">JavaBeans&trade; specification</a>.\n */\n\npublic class Introspector {\n\nBeanInfo  \n\n\ninstanceof  C++\n\npython 中的内省\n\nmethod\n\n","slug":"java-introspector","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd79001xjh4kd4fo2ksz","content":"<p><a href=\"http://www.slideshare.net/kim.mens/basics-of-reflection-in-java\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.slideshare.net/kim.mens/basics-of-reflection-in-java</a></p>\n<p><a href=\"http://jjhou.boolan.com/javatwo-2004-reflection.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://jjhou.boolan.com/javatwo-2004-reflection.pdf</a></p>\n<p>/**</p>\n<ul>\n<li>The Introspector class provides a standard way for tools to learn about</li>\n<li>the properties, events, and methods supported by a target Java Bean.</li>\n<li><p></p></li>\n<li>For more information about introspection and design patterns, please</li>\n<li>consult the</li>\n<li><a href=\"http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JavaBeans&trade; specification</a>.<br>*/</li>\n</ul>\n<p>public class Introspector {</p>\n<p>BeanInfo  </p>\n<p>instanceof  C++</p>\n<p>python 中的内省</p>\n<p>method</p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"http://www.slideshare.net/kim.mens/basics-of-reflection-in-java\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.slideshare.net/kim.mens/basics-of-reflection-in-java</a></p>\n<p><a href=\"http://jjhou.boolan.com/javatwo-2004-reflection.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://jjhou.boolan.com/javatwo-2004-reflection.pdf</a></p>\n<p>/**</p>\n<ul>\n<li>The Introspector class provides a standard way for tools to learn about</li>\n<li>the properties, events, and methods supported by a target Java Bean.</li>\n<li><p></p></li>\n<li>For more information about introspection and design patterns, please</li>\n<li>consult the</li>\n<li><a href=\"http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JavaBeans&trade; specification</a>.<br>*/</li>\n</ul>\n<p>public class Introspector {</p>\n<p>BeanInfo  </p>\n<p>instanceof  C++</p>\n<p>python 中的内省</p>\n<p>method</p>\n"},{"title":"java代理总结","toc":true,"abbrlink":44221,"_content":"\n## 静态代理\n\n## 动态代理\n\n## cglib\n\n\n","source":"_drafts/java-proxy.md","raw":"---\ntitle: java代理总结\ntoc: true\ntags: proxy\ncategory: java\nabbrlink: 44221\n---\n\n## 静态代理\n\n## 动态代理\n\n## cglib\n\n\n","slug":"java-proxy","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7a0022jh4k9rwvri96","content":"<h2 id=\"静态代理\"><a href=\"#静态代理\" class=\"headerlink\" title=\"静态代理\"></a>静态代理</h2><h2 id=\"动态代理\"><a href=\"#动态代理\" class=\"headerlink\" title=\"动态代理\"></a>动态代理</h2><h2 id=\"cglib\"><a href=\"#cglib\" class=\"headerlink\" title=\"cglib\"></a>cglib</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"静态代理\"><a href=\"#静态代理\" class=\"headerlink\" title=\"静态代理\"></a>静态代理</h2><h2 id=\"动态代理\"><a href=\"#动态代理\" class=\"headerlink\" title=\"动态代理\"></a>动态代理</h2><h2 id=\"cglib\"><a href=\"#cglib\" class=\"headerlink\" title=\"cglib\"></a>cglib</h2>"},{"title":"jsonpath -- json的OQL语言","toc":true,"_content":"\n## 缘起\n\n## jsonpath\n\n## 实现\n\n## 参考\n\n1. [Jayway JsonPath evaluator](http://jsonpath.herokuapp.com/)","source":"_drafts/jsonpath.md","raw":"title: jsonpath -- json的OQL语言\ntoc: true\ntags: json\ncategory: fe\n---\n\n## 缘起\n\n## jsonpath\n\n## 实现\n\n## 参考\n\n1. [Jayway JsonPath evaluator](http://jsonpath.herokuapp.com/)","slug":"jsonpath","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-09-10T15:43:50.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7b0024jh4kz5g26gyp","content":"<h2 id=\"缘起\"><a href=\"#缘起\" class=\"headerlink\" title=\"缘起\"></a>缘起</h2><h2 id=\"jsonpath\"><a href=\"#jsonpath\" class=\"headerlink\" title=\"jsonpath\"></a>jsonpath</h2><h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://jsonpath.herokuapp.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jayway JsonPath evaluator</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"缘起\"><a href=\"#缘起\" class=\"headerlink\" title=\"缘起\"></a>缘起</h2><h2 id=\"jsonpath\"><a href=\"#jsonpath\" class=\"headerlink\" title=\"jsonpath\"></a>jsonpath</h2><h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://jsonpath.herokuapp.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Jayway JsonPath evaluator</a></li>\n</ol>\n"},{"title":"java线程栈的打印","toc":true,"abbrlink":61487,"_content":"\n## 原理\n\nkill -3 直接打印在catalina.out\n\njstack -l lock信息（开销比较大） \n\njcmd\n\nsudo -u tomcat jcmd  25423 Thread.print\n\nPerfCounter.print\n\n### native 线程栈\n\npstack\n\npidstat\n\n### 线程栈 + CPU占用\nslow stack\n\ngreys\n\n网上的脚本\n\n### 文件存储位置\n\n/tmp/hsperfdata_$USER/$PID\n\n###\n\n\n## 参考\n\n1. [java - jstack - well-known file is not secure - Stack Overflow](https://stackoverflow.com/questions/9100149/jstack-well-known-file-is-not-secure)\n\n2. [jcmd命令使用 - CSDN博客](http://blog.csdn.net/winwill2012/article/details/46364849)\n","source":"_drafts/jstack.md","raw":"---\ntitle: java线程栈的打印\ntoc: true\ntags: jstack\ncategory: java\nabbrlink: 61487\n---\n\n## 原理\n\nkill -3 直接打印在catalina.out\n\njstack -l lock信息（开销比较大） \n\njcmd\n\nsudo -u tomcat jcmd  25423 Thread.print\n\nPerfCounter.print\n\n### native 线程栈\n\npstack\n\npidstat\n\n### 线程栈 + CPU占用\nslow stack\n\ngreys\n\n网上的脚本\n\n### 文件存储位置\n\n/tmp/hsperfdata_$USER/$PID\n\n###\n\n\n## 参考\n\n1. [java - jstack - well-known file is not secure - Stack Overflow](https://stackoverflow.com/questions/9100149/jstack-well-known-file-is-not-secure)\n\n2. [jcmd命令使用 - CSDN博客](http://blog.csdn.net/winwill2012/article/details/46364849)\n","slug":"jstack","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-12-02T09:58:49.589Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7c0027jh4k8w7pa6sk","content":"<h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><p>kill -3 直接打印在catalina.out</p>\n<p>jstack -l lock信息（开销比较大） </p>\n<p>jcmd</p>\n<p>sudo -u tomcat jcmd  25423 Thread.print</p>\n<p>PerfCounter.print</p>\n<h3 id=\"native-线程栈\"><a href=\"#native-线程栈\" class=\"headerlink\" title=\"native 线程栈\"></a>native 线程栈</h3><p>pstack</p>\n<p>pidstat</p>\n<h3 id=\"线程栈-CPU占用\"><a href=\"#线程栈-CPU占用\" class=\"headerlink\" title=\"线程栈 + CPU占用\"></a>线程栈 + CPU占用</h3><p>slow stack</p>\n<p>greys</p>\n<p>网上的脚本</p>\n<h3 id=\"文件存储位置\"><a href=\"#文件存储位置\" class=\"headerlink\" title=\"文件存储位置\"></a>文件存储位置</h3><p>/tmp/hsperfdata_$USER/$PID</p>\n<p>###</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://stackoverflow.com/questions/9100149/jstack-well-known-file-is-not-secure\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - jstack - well-known file is not secure - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/winwill2012/article/details/46364849\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">jcmd命令使用 - CSDN博客</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><p>kill -3 直接打印在catalina.out</p>\n<p>jstack -l lock信息（开销比较大） </p>\n<p>jcmd</p>\n<p>sudo -u tomcat jcmd  25423 Thread.print</p>\n<p>PerfCounter.print</p>\n<h3 id=\"native-线程栈\"><a href=\"#native-线程栈\" class=\"headerlink\" title=\"native 线程栈\"></a>native 线程栈</h3><p>pstack</p>\n<p>pidstat</p>\n<h3 id=\"线程栈-CPU占用\"><a href=\"#线程栈-CPU占用\" class=\"headerlink\" title=\"线程栈 + CPU占用\"></a>线程栈 + CPU占用</h3><p>slow stack</p>\n<p>greys</p>\n<p>网上的脚本</p>\n<h3 id=\"文件存储位置\"><a href=\"#文件存储位置\" class=\"headerlink\" title=\"文件存储位置\"></a>文件存储位置</h3><p>/tmp/hsperfdata_$USER/$PID</p>\n<p>###</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://stackoverflow.com/questions/9100149/jstack-well-known-file-is-not-secure\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - jstack - well-known file is not secure - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/winwill2012/article/details/46364849\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">jcmd命令使用 - CSDN博客</a></p>\n</li>\n</ol>\n"},{"title":"java-object-diff","toc":true,"abbrlink":39546,"category":null,"_content":"\n\n存在的问题：\n\n1. 为什么不使用json diff？\n\njson的数据结构比较简单，Java中的Set、List、Array到json中都变成了Json Array\n\n这样，List就没有办法做diff了（涉及到顺序和重复插入）\n\n2. Java Object Diff\n\n- 要解决 List的重复插入，顺序问题\n\n- \n\n\nDiffNode：代表了对象的一部分。可以是对象本身，也可以是对象的一个属性，集合的一个元素或者是Map的一个entry。一个DiffNode可以拥有任意数量的子node，但最多只有一个父node。\nDiffNode.State:ADDED,CHANGED,REMOVED,UNTOUCHED,CIRCULAR,IGNORED,INACCESSIBLE.\nDiffNode.Visitor:一个用于遍历diff树的接口。\nInstances：这个类有几个属性：sourceAccessor，working，base，以及fresh。其中fresh是用反射从working类型创建的一个对象。\nAccessor：一个通用的访问接口，实现类有：CollectionItemAccessor，MapEntryAccessor，PropertyAccessor，PropertyAwareAccessor，RootAccessor，TypeAwareAccessor。\nDiffer:接口，根据数据类型，有几个实现类：BeanDiffer，CollectionDiffer，MapDiffer以及PrimitiveDiffer。\nComparisonStrategy接口：比较的策略定义。实现类有ComparableComparisonStrategy和EqualsOnlyComparisonStrategy，从命名就可以知道前者是通过Comparable接口比较，而后者是通过equals方法比较。\n\n对list的支持不是很好\n\nhttps://github.com/SQiShER/java-object-diff/issues/143\n\nNo item is expected to be present more than once and if it is, it’s not handled specially.\nOrder doesn’t matter and is expected to be handled by the underlying collection.\n\n\n[Diff Examples — JaVers Documentation](http://javers.org/documentation/diff-examples/)\n\n[SQiShER/java-object-diff: Library to diff and merge Java objects with ease](https://github.com/SQiShER/java-object-diff)\n\n[java-object-diff Documentation](http://java-object-diff.readthedocs.io/en/latest/)","source":"_drafts/java-object-diff.md","raw":"---\ntitle: java-object-diff\ntoc: true\nabbrlink: 39546\ntags:\ncategory:\n---\n\n\n存在的问题：\n\n1. 为什么不使用json diff？\n\njson的数据结构比较简单，Java中的Set、List、Array到json中都变成了Json Array\n\n这样，List就没有办法做diff了（涉及到顺序和重复插入）\n\n2. Java Object Diff\n\n- 要解决 List的重复插入，顺序问题\n\n- \n\n\nDiffNode：代表了对象的一部分。可以是对象本身，也可以是对象的一个属性，集合的一个元素或者是Map的一个entry。一个DiffNode可以拥有任意数量的子node，但最多只有一个父node。\nDiffNode.State:ADDED,CHANGED,REMOVED,UNTOUCHED,CIRCULAR,IGNORED,INACCESSIBLE.\nDiffNode.Visitor:一个用于遍历diff树的接口。\nInstances：这个类有几个属性：sourceAccessor，working，base，以及fresh。其中fresh是用反射从working类型创建的一个对象。\nAccessor：一个通用的访问接口，实现类有：CollectionItemAccessor，MapEntryAccessor，PropertyAccessor，PropertyAwareAccessor，RootAccessor，TypeAwareAccessor。\nDiffer:接口，根据数据类型，有几个实现类：BeanDiffer，CollectionDiffer，MapDiffer以及PrimitiveDiffer。\nComparisonStrategy接口：比较的策略定义。实现类有ComparableComparisonStrategy和EqualsOnlyComparisonStrategy，从命名就可以知道前者是通过Comparable接口比较，而后者是通过equals方法比较。\n\n对list的支持不是很好\n\nhttps://github.com/SQiShER/java-object-diff/issues/143\n\nNo item is expected to be present more than once and if it is, it’s not handled specially.\nOrder doesn’t matter and is expected to be handled by the underlying collection.\n\n\n[Diff Examples — JaVers Documentation](http://javers.org/documentation/diff-examples/)\n\n[SQiShER/java-object-diff: Library to diff and merge Java objects with ease](https://github.com/SQiShER/java-object-diff)\n\n[java-object-diff Documentation](http://java-object-diff.readthedocs.io/en/latest/)","slug":"java-object-diff","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7e002ajh4kde7nbv0s","content":"<p>存在的问题：</p>\n<ol>\n<li>为什么不使用json diff？</li>\n</ol>\n<p>json的数据结构比较简单，Java中的Set、List、Array到json中都变成了Json Array</p>\n<p>这样，List就没有办法做diff了（涉及到顺序和重复插入）</p>\n<ol>\n<li>Java Object Diff</li>\n</ol>\n<ul>\n<li><p>要解决 List的重复插入，顺序问题</p>\n</li>\n<li></li>\n</ul>\n<p>DiffNode：代表了对象的一部分。可以是对象本身，也可以是对象的一个属性，集合的一个元素或者是Map的一个entry。一个DiffNode可以拥有任意数量的子node，但最多只有一个父node。<br>DiffNode.State:ADDED,CHANGED,REMOVED,UNTOUCHED,CIRCULAR,IGNORED,INACCESSIBLE.<br>DiffNode.Visitor:一个用于遍历diff树的接口。<br>Instances：这个类有几个属性：sourceAccessor，working，base，以及fresh。其中fresh是用反射从working类型创建的一个对象。<br>Accessor：一个通用的访问接口，实现类有：CollectionItemAccessor，MapEntryAccessor，PropertyAccessor，PropertyAwareAccessor，RootAccessor，TypeAwareAccessor。<br>Differ:接口，根据数据类型，有几个实现类：BeanDiffer，CollectionDiffer，MapDiffer以及PrimitiveDiffer。<br>ComparisonStrategy接口：比较的策略定义。实现类有ComparableComparisonStrategy和EqualsOnlyComparisonStrategy，从命名就可以知道前者是通过Comparable接口比较，而后者是通过equals方法比较。</p>\n<p>对list的支持不是很好</p>\n<p><a href=\"https://github.com/SQiShER/java-object-diff/issues/143\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/SQiShER/java-object-diff/issues/143</a></p>\n<p>No item is expected to be present more than once and if it is, it’s not handled specially.<br>Order doesn’t matter and is expected to be handled by the underlying collection.</p>\n<p><a href=\"http://javers.org/documentation/diff-examples/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Diff Examples — JaVers Documentation</a></p>\n<p><a href=\"https://github.com/SQiShER/java-object-diff\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SQiShER/java-object-diff: Library to diff and merge Java objects with ease</a></p>\n<p><a href=\"http://java-object-diff.readthedocs.io/en/latest/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java-object-diff Documentation</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>存在的问题：</p>\n<ol>\n<li>为什么不使用json diff？</li>\n</ol>\n<p>json的数据结构比较简单，Java中的Set、List、Array到json中都变成了Json Array</p>\n<p>这样，List就没有办法做diff了（涉及到顺序和重复插入）</p>\n<ol>\n<li>Java Object Diff</li>\n</ol>\n<ul>\n<li><p>要解决 List的重复插入，顺序问题</p>\n</li>\n<li></li>\n</ul>\n<p>DiffNode：代表了对象的一部分。可以是对象本身，也可以是对象的一个属性，集合的一个元素或者是Map的一个entry。一个DiffNode可以拥有任意数量的子node，但最多只有一个父node。<br>DiffNode.State:ADDED,CHANGED,REMOVED,UNTOUCHED,CIRCULAR,IGNORED,INACCESSIBLE.<br>DiffNode.Visitor:一个用于遍历diff树的接口。<br>Instances：这个类有几个属性：sourceAccessor，working，base，以及fresh。其中fresh是用反射从working类型创建的一个对象。<br>Accessor：一个通用的访问接口，实现类有：CollectionItemAccessor，MapEntryAccessor，PropertyAccessor，PropertyAwareAccessor，RootAccessor，TypeAwareAccessor。<br>Differ:接口，根据数据类型，有几个实现类：BeanDiffer，CollectionDiffer，MapDiffer以及PrimitiveDiffer。<br>ComparisonStrategy接口：比较的策略定义。实现类有ComparableComparisonStrategy和EqualsOnlyComparisonStrategy，从命名就可以知道前者是通过Comparable接口比较，而后者是通过equals方法比较。</p>\n<p>对list的支持不是很好</p>\n<p><a href=\"https://github.com/SQiShER/java-object-diff/issues/143\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/SQiShER/java-object-diff/issues/143</a></p>\n<p>No item is expected to be present more than once and if it is, it’s not handled specially.<br>Order doesn’t matter and is expected to be handled by the underlying collection.</p>\n<p><a href=\"http://javers.org/documentation/diff-examples/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Diff Examples — JaVers Documentation</a></p>\n<p><a href=\"https://github.com/SQiShER/java-object-diff\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SQiShER/java-object-diff: Library to diff and merge Java objects with ease</a></p>\n<p><a href=\"http://java-object-diff.readthedocs.io/en/latest/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java-object-diff Documentation</a></p>\n"},{"title":"jvm-shutdown-hook","toc":true,"_content":"\n\n```java\nstatic {\n    Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {\n        public void run() {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Run shutdown hook now.\");\n            }\n            ProtocolConfig.destroyAll();\n        }\n    }, \"DubboShutdownHook\"));\n}\n```\n\n\n```java\n\n    final void addDelayedShutdownHook(\n        final ExecutorService service, final long terminationTimeout, final TimeUnit timeUnit) {\n      checkNotNull(service);\n      checkNotNull(timeUnit);\n      addShutdownHook(MoreExecutors.newThread(\"DelayedShutdownHook-for-\" + service, new Runnable() {\n        @Override\n        public void run() {\n          try {\n            // We'd like to log progress and failures that may arise in the\n            // following code, but unfortunately the behavior of logging\n            // is undefined in shutdown hooks.\n            // This is because the logging code installs a shutdown hook of its\n            // own. See Cleaner class inside {@link LogManager}.\n            service.shutdown();\n            service.awaitTermination(terminationTimeout, timeUnit);\n          } catch (InterruptedException ignored) {\n            // We're shutting down anyway, so just ignore.\n          }\n        }\n      }));\n    }\n```\n\n\n\nJVM退出时调用Hook线程\n\n```java\n /* Iterates over all application hooks creating a new thread for each\n     * to run in. Hooks are run concurrently and this method waits for\n     * them to finish.\n     */\n    static void runHooks() {\n        Collection<Thread> threads;\n        synchronized(ApplicationShutdownHooks.class) {\n            threads = hooks.keySet();\n            hooks = null;\n        }\n\n        for (Thread hook : threads) {\n            hook.start();\n        }\n        for (Thread hook : threads) {\n            try {\n                hook.join();\n            } catch (InterruptedException x) { }\n        }\n    }\n```","source":"_drafts/jvm-shutdown-hook.md","raw":"title: jvm-shutdown-hook\ntoc: true\ntags: shutdown-hook\ncategory: jvm\n---\n\n\n```java\nstatic {\n    Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {\n        public void run() {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Run shutdown hook now.\");\n            }\n            ProtocolConfig.destroyAll();\n        }\n    }, \"DubboShutdownHook\"));\n}\n```\n\n\n```java\n\n    final void addDelayedShutdownHook(\n        final ExecutorService service, final long terminationTimeout, final TimeUnit timeUnit) {\n      checkNotNull(service);\n      checkNotNull(timeUnit);\n      addShutdownHook(MoreExecutors.newThread(\"DelayedShutdownHook-for-\" + service, new Runnable() {\n        @Override\n        public void run() {\n          try {\n            // We'd like to log progress and failures that may arise in the\n            // following code, but unfortunately the behavior of logging\n            // is undefined in shutdown hooks.\n            // This is because the logging code installs a shutdown hook of its\n            // own. See Cleaner class inside {@link LogManager}.\n            service.shutdown();\n            service.awaitTermination(terminationTimeout, timeUnit);\n          } catch (InterruptedException ignored) {\n            // We're shutting down anyway, so just ignore.\n          }\n        }\n      }));\n    }\n```\n\n\n\nJVM退出时调用Hook线程\n\n```java\n /* Iterates over all application hooks creating a new thread for each\n     * to run in. Hooks are run concurrently and this method waits for\n     * them to finish.\n     */\n    static void runHooks() {\n        Collection<Thread> threads;\n        synchronized(ApplicationShutdownHooks.class) {\n            threads = hooks.keySet();\n            hooks = null;\n        }\n\n        for (Thread hook : threads) {\n            hook.start();\n        }\n        for (Thread hook : threads) {\n            try {\n                hook.join();\n            } catch (InterruptedException x) { }\n        }\n    }\n```","slug":"jvm-shutdown-hook","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-12-09T09:34:07.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7f002djh4kdeekpsaq","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    Runtime.getRuntime().addShutdownHook(<span class=\"keyword\">new</span> Thread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class=\"line\">                logger.info(<span class=\"string\">\"Run shutdown hook now.\"</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            ProtocolConfig.destroyAll();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;, <span class=\"string\">\"DubboShutdownHook\"</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">addDelayedShutdownHook</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    <span class=\"keyword\">final</span> ExecutorService service, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> terminationTimeout, <span class=\"keyword\">final</span> TimeUnit timeUnit)</span> </span>&#123;</span><br><span class=\"line\">  checkNotNull(service);</span><br><span class=\"line\">  checkNotNull(timeUnit);</span><br><span class=\"line\">  addShutdownHook(MoreExecutors.newThread(<span class=\"string\">\"DelayedShutdownHook-for-\"</span> + service, <span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We'd like to log progress and failures that may arise in the</span></span><br><span class=\"line\">        <span class=\"comment\">// following code, but unfortunately the behavior of logging</span></span><br><span class=\"line\">        <span class=\"comment\">// is undefined in shutdown hooks.</span></span><br><span class=\"line\">        <span class=\"comment\">// This is because the logging code installs a shutdown hook of its</span></span><br><span class=\"line\">        <span class=\"comment\">// own. See Cleaner class inside &#123;@link LogManager&#125;.</span></span><br><span class=\"line\">        service.shutdown();</span><br><span class=\"line\">        service.awaitTermination(terminationTimeout, timeUnit);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (InterruptedException ignored) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We're shutting down anyway, so just ignore.</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JVM退出时调用Hook线程</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Iterates over all application hooks creating a new thread for each</span></span><br><span class=\"line\"><span class=\"comment\">    * to run in. Hooks are run concurrently and this method waits for</span></span><br><span class=\"line\"><span class=\"comment\">    * them to finish.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">runHooks</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       Collection&lt;Thread&gt; threads;</span><br><span class=\"line\">       <span class=\"keyword\">synchronized</span>(ApplicationShutdownHooks.class) &#123;</span><br><span class=\"line\">           threads = hooks.keySet();</span><br><span class=\"line\">           hooks = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">for</span> (Thread hook : threads) &#123;</span><br><span class=\"line\">           hook.start();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">for</span> (Thread hook : threads) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">               hook.join();</span><br><span class=\"line\">           &#125; <span class=\"keyword\">catch</span> (InterruptedException x) &#123; &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    Runtime.getRuntime().addShutdownHook(<span class=\"keyword\">new</span> Thread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class=\"line\">                logger.info(<span class=\"string\">\"Run shutdown hook now.\"</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            ProtocolConfig.destroyAll();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;, <span class=\"string\">\"DubboShutdownHook\"</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">addDelayedShutdownHook</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    <span class=\"keyword\">final</span> ExecutorService service, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> terminationTimeout, <span class=\"keyword\">final</span> TimeUnit timeUnit)</span> </span>&#123;</span><br><span class=\"line\">  checkNotNull(service);</span><br><span class=\"line\">  checkNotNull(timeUnit);</span><br><span class=\"line\">  addShutdownHook(MoreExecutors.newThread(<span class=\"string\">\"DelayedShutdownHook-for-\"</span> + service, <span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We'd like to log progress and failures that may arise in the</span></span><br><span class=\"line\">        <span class=\"comment\">// following code, but unfortunately the behavior of logging</span></span><br><span class=\"line\">        <span class=\"comment\">// is undefined in shutdown hooks.</span></span><br><span class=\"line\">        <span class=\"comment\">// This is because the logging code installs a shutdown hook of its</span></span><br><span class=\"line\">        <span class=\"comment\">// own. See Cleaner class inside &#123;@link LogManager&#125;.</span></span><br><span class=\"line\">        service.shutdown();</span><br><span class=\"line\">        service.awaitTermination(terminationTimeout, timeUnit);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (InterruptedException ignored) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We're shutting down anyway, so just ignore.</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JVM退出时调用Hook线程</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Iterates over all application hooks creating a new thread for each</span></span><br><span class=\"line\"><span class=\"comment\">    * to run in. Hooks are run concurrently and this method waits for</span></span><br><span class=\"line\"><span class=\"comment\">    * them to finish.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">runHooks</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       Collection&lt;Thread&gt; threads;</span><br><span class=\"line\">       <span class=\"keyword\">synchronized</span>(ApplicationShutdownHooks.class) &#123;</span><br><span class=\"line\">           threads = hooks.keySet();</span><br><span class=\"line\">           hooks = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">for</span> (Thread hook : threads) &#123;</span><br><span class=\"line\">           hook.start();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">for</span> (Thread hook : threads) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">               hook.join();</span><br><span class=\"line\">           &#125; <span class=\"keyword\">catch</span> (InterruptedException x) &#123; &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>"},{"title":"kibana","toc":true,"abbrlink":15607,"category":null,"_content":"\n\n\n## 参考\n\n1. [ELK：kibana使用的lucene查询语法](https://segmentfault.com/a/1190000002972420)\n\n2. [Kibana3指南](http://www.code123.cc/docs/kibana-logstash/v3/index.html)\n\n3. []\n","source":"_drafts/kibana.md","raw":"---\ntitle: kibana\ntoc: true\nabbrlink: 15607\ntags:\ncategory:\n---\n\n\n\n## 参考\n\n1. [ELK：kibana使用的lucene查询语法](https://segmentfault.com/a/1190000002972420)\n\n2. [Kibana3指南](http://www.code123.cc/docs/kibana-logstash/v3/index.html)\n\n3. []\n","slug":"kibana","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7g002gjh4kod5egt05","content":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://segmentfault.com/a/1190000002972420\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">ELK：kibana使用的lucene查询语法</a></p>\n</li>\n<li><p><a href=\"http://www.code123.cc/docs/kibana-logstash/v3/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Kibana3指南</a></p>\n</li>\n<li><p>[]</p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://segmentfault.com/a/1190000002972420\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">ELK：kibana使用的lucene查询语法</a></p>\n</li>\n<li><p><a href=\"http://www.code123.cc/docs/kibana-logstash/v3/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Kibana3指南</a></p>\n</li>\n<li><p>[]</p>\n</li>\n</ol>\n"},{"title":"less","toc":true,"abbrlink":39531,"category":null,"_content":"\n\n显示进度\n显示行号\n高亮关键字\n查找 向上 向下 忽略大小写\n保存到文件\n翻页\nansi高亮支持\ntail的功能\n打开bin文件\n","source":"_drafts/less.md","raw":"---\ntitle: less\ntoc: true\nabbrlink: 39531\ntags:\ncategory:\n---\n\n\n显示进度\n显示行号\n高亮关键字\n查找 向上 向下 忽略大小写\n保存到文件\n翻页\nansi高亮支持\ntail的功能\n打开bin文件\n","slug":"less","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-12T06:50:50.092Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7h002jjh4k7ajxfdsw","content":"<p>显示进度<br>显示行号<br>高亮关键字<br>查找 向上 向下 忽略大小写<br>保存到文件<br>翻页<br>ansi高亮支持<br>tail的功能<br>打开bin文件</p>\n","site":{"data":{}},"excerpt":"","more":"<p>显示进度<br>显示行号<br>高亮关键字<br>查找 向上 向下 忽略大小写<br>保存到文件<br>翻页<br>ansi高亮支持<br>tail的功能<br>打开bin文件</p>\n"},{"title":"logback 使用","toc":true,"abbrlink":33648,"_content":"\n# Logback总结\n\n配置示例：\n\n{% gist 06f32243a766ea3d5da8746e9de25729 %}\n\n### Colored Log in Console\n\nhighlight 关键字\n\n```xml\n<appender name=\"STDOUT\" class=\"ch.qos.logback.core.ConsoleAppender\">\n    <encoder>\n        <pattern>\n            %d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%-40.40logger{10}] - %msg%n\n        </pattern>\n    </encoder>\n</appender>\n```\n效果:\n\n{%  asset_img   colored.jpg  %}\n\n## 日志级别\n\nlogback定义了以下日志级别：\n\n```java\n  /**\n   * The <code>OFF</code> is used to turn off logging.\n   */\n  public static final Level OFF = new Level(OFF_INT, \"OFF\");\n\n  /**\n   * The <code>ERROR</code> level designates error events which may or not\n   * be fatal to the application.\n   */\n  public static final Level ERROR = new Level(ERROR_INT, \"ERROR\");\n\n  /**\n   * The <code>WARN</code> level designates potentially harmful situations.\n   */\n  public static final Level WARN = new Level(WARN_INT, \"WARN\");\n\n  /**\n   * The <code>INFO</code> level designates informational messages\n   * highlighting overall progress of the application.\n   */\n  public static final Level INFO = new Level(INFO_INT, \"INFO\");\n\n  /**\n   * The <code>DEBUG</code> level designates informational events of lower\n   * importance.\n   */\n  public static final Level DEBUG = new Level(DEBUG_INT, \"DEBUG\");\n\n  /**\n   * The <code>TRACE</code> level designates informational events of very low\n   * importance.\n   */\n  public static final Level TRACE = new Level(TRACE_INT, \"TRACE\");\n\n  /**\n   * The <code>ALL</code> is used to turn on all logging.\n   */\n  public static final Level ALL = new Level(ALL_INT, \"ALL\");\n\n```\n\n### 按照包名设置日志级别\n\n```xml\n    <logger name=\"com.air.nio\" level=\"error\">\n        <appender-ref ref=\"STDOUT\" />\n    </logger>\n```\n\n通过上面的配置，`com.air.nio`包下打印的日志级别必须在`error`才能打印出来。\n\n## 打了好几遍日志？？？ —— additivity\n\n>The output of a log statement of logger L will go to all the appenders in L and its ancestors. This is the meaning of the term \"appender additivity\"\n\n\n\n|| Logger  Name\t|| Attached  Appenders\t|| Additivity Flag ||\tOutput Targets || Comment ||\n|root |\tA1 |\tnot applicable |\tA1\t| Since the root logger stands at the top of the logger hierarchy, the additivity flag does not apply to it.|\n|x |\tA-x1, A-x2\t| true |\tA1, A-x1, A-x2\t| Appenders of \"x\" and of root.|\n|x.y\tnone\ttrue\tA1, A-x1, A-x2\tAppenders of \"x\" and of root.\n|x.y.z\tA-xyz1\ttrue\tA1, A-x1, A-x2, A-xyz1\tAppenders of \"x.y.z\", \"x\" and of root.\n|security\tA-sec\tfalse\tA-sec\tNo appender accumulation since the additivity flag is set to false. Only appender A-sec will be used.\n|security.access\tnone\ttrue\tA-sec\tOnly appenders of \"security\" because the additivity flag in \"security\" is set to false.\n\n\n\n## logger 的层级关系\n\n>A logger is said to be an ancestor of another logger if its name followed by a dot is a prefix of the descendant logger name. A logger is said to be a parent of a child logger if there are no ancestors between itself and the descendant logger.\n\n```java\nLogger x = LoggerFactory.getLogger(\"wombat\"); \nLogger y = LoggerFactory.getLogger(\"wombat\");\n```\n\nx and y refer to exactly the same logger object.\n\n\n## Filter\n\n\n\n\n\n# 参考\n1. [COLORED LOGS IN A CONSOLE (ANSI STYLING)](http://blog.codeleak.pl/2014/02/colored-logs-in-console-ansi-styling.html)\n\n2. [Chapter 7: Filters](https://logback.qos.ch/manual/filters.html)\n\n3. [Chapter 2: Architecture](https://logback.qos.ch/manual/architecture.html)\n\n","source":"_drafts/logback.md","raw":"---\ntitle: logback 使用\ntags: logback\ncategory: java\ntoc: true\nabbrlink: 33648\n---\n\n# Logback总结\n\n配置示例：\n\n{% gist 06f32243a766ea3d5da8746e9de25729 %}\n\n### Colored Log in Console\n\nhighlight 关键字\n\n```xml\n<appender name=\"STDOUT\" class=\"ch.qos.logback.core.ConsoleAppender\">\n    <encoder>\n        <pattern>\n            %d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%-40.40logger{10}] - %msg%n\n        </pattern>\n    </encoder>\n</appender>\n```\n效果:\n\n{%  asset_img   colored.jpg  %}\n\n## 日志级别\n\nlogback定义了以下日志级别：\n\n```java\n  /**\n   * The <code>OFF</code> is used to turn off logging.\n   */\n  public static final Level OFF = new Level(OFF_INT, \"OFF\");\n\n  /**\n   * The <code>ERROR</code> level designates error events which may or not\n   * be fatal to the application.\n   */\n  public static final Level ERROR = new Level(ERROR_INT, \"ERROR\");\n\n  /**\n   * The <code>WARN</code> level designates potentially harmful situations.\n   */\n  public static final Level WARN = new Level(WARN_INT, \"WARN\");\n\n  /**\n   * The <code>INFO</code> level designates informational messages\n   * highlighting overall progress of the application.\n   */\n  public static final Level INFO = new Level(INFO_INT, \"INFO\");\n\n  /**\n   * The <code>DEBUG</code> level designates informational events of lower\n   * importance.\n   */\n  public static final Level DEBUG = new Level(DEBUG_INT, \"DEBUG\");\n\n  /**\n   * The <code>TRACE</code> level designates informational events of very low\n   * importance.\n   */\n  public static final Level TRACE = new Level(TRACE_INT, \"TRACE\");\n\n  /**\n   * The <code>ALL</code> is used to turn on all logging.\n   */\n  public static final Level ALL = new Level(ALL_INT, \"ALL\");\n\n```\n\n### 按照包名设置日志级别\n\n```xml\n    <logger name=\"com.air.nio\" level=\"error\">\n        <appender-ref ref=\"STDOUT\" />\n    </logger>\n```\n\n通过上面的配置，`com.air.nio`包下打印的日志级别必须在`error`才能打印出来。\n\n## 打了好几遍日志？？？ —— additivity\n\n>The output of a log statement of logger L will go to all the appenders in L and its ancestors. This is the meaning of the term \"appender additivity\"\n\n\n\n|| Logger  Name\t|| Attached  Appenders\t|| Additivity Flag ||\tOutput Targets || Comment ||\n|root |\tA1 |\tnot applicable |\tA1\t| Since the root logger stands at the top of the logger hierarchy, the additivity flag does not apply to it.|\n|x |\tA-x1, A-x2\t| true |\tA1, A-x1, A-x2\t| Appenders of \"x\" and of root.|\n|x.y\tnone\ttrue\tA1, A-x1, A-x2\tAppenders of \"x\" and of root.\n|x.y.z\tA-xyz1\ttrue\tA1, A-x1, A-x2, A-xyz1\tAppenders of \"x.y.z\", \"x\" and of root.\n|security\tA-sec\tfalse\tA-sec\tNo appender accumulation since the additivity flag is set to false. Only appender A-sec will be used.\n|security.access\tnone\ttrue\tA-sec\tOnly appenders of \"security\" because the additivity flag in \"security\" is set to false.\n\n\n\n## logger 的层级关系\n\n>A logger is said to be an ancestor of another logger if its name followed by a dot is a prefix of the descendant logger name. A logger is said to be a parent of a child logger if there are no ancestors between itself and the descendant logger.\n\n```java\nLogger x = LoggerFactory.getLogger(\"wombat\"); \nLogger y = LoggerFactory.getLogger(\"wombat\");\n```\n\nx and y refer to exactly the same logger object.\n\n\n## Filter\n\n\n\n\n\n# 参考\n1. [COLORED LOGS IN A CONSOLE (ANSI STYLING)](http://blog.codeleak.pl/2014/02/colored-logs-in-console-ansi-styling.html)\n\n2. [Chapter 7: Filters](https://logback.qos.ch/manual/filters.html)\n\n3. [Chapter 2: Architecture](https://logback.qos.ch/manual/architecture.html)\n\n","slug":"logback","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-12-09T08:29:46.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7i002njh4krwtxaa25","content":"<h1 id=\"Logback总结\"><a href=\"#Logback总结\" class=\"headerlink\" title=\"Logback总结\"></a>Logback总结</h1><p>配置示例：</p>\n<script src=\"//gist.github.com/06f32243a766ea3d5da8746e9de25729.js\"></script>\n<h3 id=\"Colored-Log-in-Console\"><a href=\"#Colored-Log-in-Console\" class=\"headerlink\" title=\"Colored Log in Console\"></a>Colored Log in Console</h3><p>highlight 关键字</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">appender</span> <span class=\"attr\">name</span>=<span class=\"string\">\"STDOUT\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ch.qos.logback.core.ConsoleAppender\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">pattern</span>&gt;</span></span><br><span class=\"line\">            %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %highlight(%-5level) [%-40.40logger&#123;10&#125;] - %msg%n</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">pattern</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>效果:</p>\n\n<h2 id=\"日志级别\"><a href=\"#日志级别\" class=\"headerlink\" title=\"日志级别\"></a>日志级别</h2><p>logback定义了以下日志级别：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;OFF&lt;/code&gt; is used to turn off logging.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level OFF = <span class=\"keyword\">new</span> Level(OFF_INT, <span class=\"string\">\"OFF\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;ERROR&lt;/code&gt; level designates error events which may or not</span></span><br><span class=\"line\"><span class=\"comment\"> * be fatal to the application.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level ERROR = <span class=\"keyword\">new</span> Level(ERROR_INT, <span class=\"string\">\"ERROR\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;WARN&lt;/code&gt; level designates potentially harmful situations.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level WARN = <span class=\"keyword\">new</span> Level(WARN_INT, <span class=\"string\">\"WARN\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;INFO&lt;/code&gt; level designates informational messages</span></span><br><span class=\"line\"><span class=\"comment\"> * highlighting overall progress of the application.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level INFO = <span class=\"keyword\">new</span> Level(INFO_INT, <span class=\"string\">\"INFO\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;DEBUG&lt;/code&gt; level designates informational events of lower</span></span><br><span class=\"line\"><span class=\"comment\"> * importance.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level DEBUG = <span class=\"keyword\">new</span> Level(DEBUG_INT, <span class=\"string\">\"DEBUG\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;TRACE&lt;/code&gt; level designates informational events of very low</span></span><br><span class=\"line\"><span class=\"comment\"> * importance.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level TRACE = <span class=\"keyword\">new</span> Level(TRACE_INT, <span class=\"string\">\"TRACE\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;ALL&lt;/code&gt; is used to turn on all logging.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level ALL = <span class=\"keyword\">new</span> Level(ALL_INT, <span class=\"string\">\"ALL\"</span>);</span><br></pre></td></tr></table></figure>\n<h3 id=\"按照包名设置日志级别\"><a href=\"#按照包名设置日志级别\" class=\"headerlink\" title=\"按照包名设置日志级别\"></a>按照包名设置日志级别</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">logger</span> <span class=\"attr\">name</span>=<span class=\"string\">\"com.air.nio\"</span> <span class=\"attr\">level</span>=<span class=\"string\">\"error\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"STDOUT\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过上面的配置，<code>com.air.nio</code>包下打印的日志级别必须在<code>error</code>才能打印出来。</p>\n<h2 id=\"打了好几遍日志？？？-——-additivity\"><a href=\"#打了好几遍日志？？？-——-additivity\" class=\"headerlink\" title=\"打了好几遍日志？？？ —— additivity\"></a>打了好几遍日志？？？ —— additivity</h2><blockquote>\n<p>The output of a log statement of logger L will go to all the appenders in L and its ancestors. This is the meaning of the term “appender additivity”</p>\n</blockquote>\n<p>|| Logger  Name    || Attached  Appenders    || Additivity Flag ||    Output Targets || Comment ||<br>|root |    A1 |    not applicable |    A1    | Since the root logger stands at the top of the logger hierarchy, the additivity flag does not apply to it.|<br>|x |    A-x1, A-x2    | true |    A1, A-x1, A-x2    | Appenders of “x” and of root.|<br>|x.y    none    true    A1, A-x1, A-x2    Appenders of “x” and of root.<br>|x.y.z    A-xyz1    true    A1, A-x1, A-x2, A-xyz1    Appenders of “x.y.z”, “x” and of root.<br>|security    A-sec    false    A-sec    No appender accumulation since the additivity flag is set to false. Only appender A-sec will be used.<br>|security.access    none    true    A-sec    Only appenders of “security” because the additivity flag in “security” is set to false.</p>\n<h2 id=\"logger-的层级关系\"><a href=\"#logger-的层级关系\" class=\"headerlink\" title=\"logger 的层级关系\"></a>logger 的层级关系</h2><blockquote>\n<p>A logger is said to be an ancestor of another logger if its name followed by a dot is a prefix of the descendant logger name. A logger is said to be a parent of a child logger if there are no ancestors between itself and the descendant logger.</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Logger x = LoggerFactory.getLogger(<span class=\"string\">\"wombat\"</span>); </span><br><span class=\"line\">Logger y = LoggerFactory.getLogger(<span class=\"string\">\"wombat\"</span>);</span><br></pre></td></tr></table></figure>\n<p>x and y refer to exactly the same logger object.</p>\n<h2 id=\"Filter\"><a href=\"#Filter\" class=\"headerlink\" title=\"Filter\"></a>Filter</h2><h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"http://blog.codeleak.pl/2014/02/colored-logs-in-console-ansi-styling.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">COLORED LOGS IN A CONSOLE (ANSI STYLING)</a></p>\n</li>\n<li><p><a href=\"https://logback.qos.ch/manual/filters.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Chapter 7: Filters</a></p>\n</li>\n<li><p><a href=\"https://logback.qos.ch/manual/architecture.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Chapter 2: Architecture</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Logback总结\"><a href=\"#Logback总结\" class=\"headerlink\" title=\"Logback总结\"></a>Logback总结</h1><p>配置示例：</p>\n<script src=\"//gist.github.com/06f32243a766ea3d5da8746e9de25729.js\"></script>\n<h3 id=\"Colored-Log-in-Console\"><a href=\"#Colored-Log-in-Console\" class=\"headerlink\" title=\"Colored Log in Console\"></a>Colored Log in Console</h3><p>highlight 关键字</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">appender</span> <span class=\"attr\">name</span>=<span class=\"string\">\"STDOUT\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ch.qos.logback.core.ConsoleAppender\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">pattern</span>&gt;</span></span><br><span class=\"line\">            %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %highlight(%-5level) [%-40.40logger&#123;10&#125;] - %msg%n</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">pattern</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">encoder</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>效果:</p>\n\n<h2 id=\"日志级别\"><a href=\"#日志级别\" class=\"headerlink\" title=\"日志级别\"></a>日志级别</h2><p>logback定义了以下日志级别：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;OFF&lt;/code&gt; is used to turn off logging.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level OFF = <span class=\"keyword\">new</span> Level(OFF_INT, <span class=\"string\">\"OFF\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;ERROR&lt;/code&gt; level designates error events which may or not</span></span><br><span class=\"line\"><span class=\"comment\"> * be fatal to the application.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level ERROR = <span class=\"keyword\">new</span> Level(ERROR_INT, <span class=\"string\">\"ERROR\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;WARN&lt;/code&gt; level designates potentially harmful situations.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level WARN = <span class=\"keyword\">new</span> Level(WARN_INT, <span class=\"string\">\"WARN\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;INFO&lt;/code&gt; level designates informational messages</span></span><br><span class=\"line\"><span class=\"comment\"> * highlighting overall progress of the application.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level INFO = <span class=\"keyword\">new</span> Level(INFO_INT, <span class=\"string\">\"INFO\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;DEBUG&lt;/code&gt; level designates informational events of lower</span></span><br><span class=\"line\"><span class=\"comment\"> * importance.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level DEBUG = <span class=\"keyword\">new</span> Level(DEBUG_INT, <span class=\"string\">\"DEBUG\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;TRACE&lt;/code&gt; level designates informational events of very low</span></span><br><span class=\"line\"><span class=\"comment\"> * importance.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level TRACE = <span class=\"keyword\">new</span> Level(TRACE_INT, <span class=\"string\">\"TRACE\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The &lt;code&gt;ALL&lt;/code&gt; is used to turn on all logging.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Level ALL = <span class=\"keyword\">new</span> Level(ALL_INT, <span class=\"string\">\"ALL\"</span>);</span><br></pre></td></tr></table></figure>\n<h3 id=\"按照包名设置日志级别\"><a href=\"#按照包名设置日志级别\" class=\"headerlink\" title=\"按照包名设置日志级别\"></a>按照包名设置日志级别</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">logger</span> <span class=\"attr\">name</span>=<span class=\"string\">\"com.air.nio\"</span> <span class=\"attr\">level</span>=<span class=\"string\">\"error\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"STDOUT\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过上面的配置，<code>com.air.nio</code>包下打印的日志级别必须在<code>error</code>才能打印出来。</p>\n<h2 id=\"打了好几遍日志？？？-——-additivity\"><a href=\"#打了好几遍日志？？？-——-additivity\" class=\"headerlink\" title=\"打了好几遍日志？？？ —— additivity\"></a>打了好几遍日志？？？ —— additivity</h2><blockquote>\n<p>The output of a log statement of logger L will go to all the appenders in L and its ancestors. This is the meaning of the term “appender additivity”</p>\n</blockquote>\n<p>|| Logger  Name    || Attached  Appenders    || Additivity Flag ||    Output Targets || Comment ||<br>|root |    A1 |    not applicable |    A1    | Since the root logger stands at the top of the logger hierarchy, the additivity flag does not apply to it.|<br>|x |    A-x1, A-x2    | true |    A1, A-x1, A-x2    | Appenders of “x” and of root.|<br>|x.y    none    true    A1, A-x1, A-x2    Appenders of “x” and of root.<br>|x.y.z    A-xyz1    true    A1, A-x1, A-x2, A-xyz1    Appenders of “x.y.z”, “x” and of root.<br>|security    A-sec    false    A-sec    No appender accumulation since the additivity flag is set to false. Only appender A-sec will be used.<br>|security.access    none    true    A-sec    Only appenders of “security” because the additivity flag in “security” is set to false.</p>\n<h2 id=\"logger-的层级关系\"><a href=\"#logger-的层级关系\" class=\"headerlink\" title=\"logger 的层级关系\"></a>logger 的层级关系</h2><blockquote>\n<p>A logger is said to be an ancestor of another logger if its name followed by a dot is a prefix of the descendant logger name. A logger is said to be a parent of a child logger if there are no ancestors between itself and the descendant logger.</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Logger x = LoggerFactory.getLogger(<span class=\"string\">\"wombat\"</span>); </span><br><span class=\"line\">Logger y = LoggerFactory.getLogger(<span class=\"string\">\"wombat\"</span>);</span><br></pre></td></tr></table></figure>\n<p>x and y refer to exactly the same logger object.</p>\n<h2 id=\"Filter\"><a href=\"#Filter\" class=\"headerlink\" title=\"Filter\"></a>Filter</h2><h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"http://blog.codeleak.pl/2014/02/colored-logs-in-console-ansi-styling.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">COLORED LOGS IN A CONSOLE (ANSI STYLING)</a></p>\n</li>\n<li><p><a href=\"https://logback.qos.ch/manual/filters.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Chapter 7: Filters</a></p>\n</li>\n<li><p><a href=\"https://logback.qos.ch/manual/architecture.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Chapter 2: Architecture</a></p>\n</li>\n</ol>\n"},{"title":"logback源码分析","toc":true,"abbrlink":55827,"_content":"\n\n\n\n```java\nprivate static Logger logger = LoggerFactory.getLogger(LogBackTest.class);\n```\n\n","source":"_drafts/logback-source.md","raw":"---\ntitle: logback源码分析\ntoc: true\ntags: logback\ncategory: java\nabbrlink: 55827\n---\n\n\n\n\n```java\nprivate static Logger logger = LoggerFactory.getLogger(LogBackTest.class);\n```\n\n","slug":"logback-source","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7j002pjh4kq5hl5gxi","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Logger logger = LoggerFactory.getLogger(LogBackTest.class);</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Logger logger = LoggerFactory.getLogger(LogBackTest.class);</span><br></pre></td></tr></table></figure>\n"},{"title":"maven配置中的repo和mirror","toc":true,"abbrlink":58607,"_content":"\n一份maven的配置文件示例：\n\n```xml\n<?xml version=\"1.0\"?>\n<settings xmlns=\"http://maven.apache.org/POM/4.0.0\"\n          xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n          xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0\n                            http://maven.apache.org/xsd/settings-1.0.0.xsd\">\n    <servers>\n        <server>\n            <id>snapshots</id>\n            <username>snapshots</username>\n            <password>g2Dki6XCfhi48Bnj</password>\n            <filePermissions>664</filePermissions>\n            <directoryPermissions>775</directoryPermissions>\n        </server>\n        <server>\n            <id>releases</id>\n            <username>{username}</username>\n            <password>{yourpwd}</password>\n            <filePermissions>664</filePermissions>\n            <directoryPermissions>775</directoryPermissions>\n        </server>\n    </servers>\n\n    <profiles>\n        <profile>\n            <id>Nexus</id>\n            <repositories>\n                <repository>\n                    <id>Nexus</id>\n                    <url>http://xxx.com:8081/nexus/content/groups/public</url>\n                    <releases>\n                        <enabled>true</enabled>\n                        <!-- always , daily (default), interval:X (where X is an integer in minutes) or never.-->\n                        <updatePolicy>daily</updatePolicy>\n                        <checksumPolicy>warn</checksumPolicy>\n                    </releases>\n                    <snapshots>\n                        <updatePolicy>always</updatePolicy>\n                    </snapshots>\n                </repository>\n            </repositories>\n            <pluginRepositories>\n                <pluginRepository>\n                    <id>Nexus</id>\n                    <url>http://xxx.com:8081/nexus/content/groups/public</url>\n                    <releases>\n                        <enabled>true</enabled>\n                        <checksumPolicy>warn</checksumPolicy>\n                    </releases>\n                    <snapshots>\n                        <updatePolicy>always</updatePolicy>\n                    </snapshots>\n                </pluginRepository>\n            </pluginRepositories>\n        </profile>\n    </profiles>\n\n    <activeProfiles>\n        <activeProfile>Nexus</activeProfile>\n    </activeProfiles>\n\t\n\t<mirrors>\n\t<mirror>\n\t      <id>z-alimaven</id>\n\t      <name>aliyun maven</name>\n\t      <url>http://maven.aliyun.com/nexus/content/groups/public/</url>\n\t      <mirrorOf>central</mirrorOf>        \n\t    </mirror>\n\t\t\n \t   <mirror>\n\t      <id>other-maven</id>\n\t      <name>other maven</name>\n\t      <url>http://xxx.com:8081/nexus/content/groups/public/</url>\n\t      <mirrorOf>*</mirrorOf>        \n\t    </mirror>\n\t  </mirrors>\n\n</settings>\n\n```\n\n配置中配置了一个gg\n\n>这里配置为*（星号）后，会导致所有的仓库都会通过osc的这个源去访问jar，由于osc现在的maven仓库和中央仓库一样，但是不包含第三方的仓库，因而第三方仓库都会出错，都会从osc的主仓库去查找，肯定找不到，因而maven会构建失败或者各种问题。\nmirrorOf配置*（星号）的时候，一般都是针对自己私有库的时候（私有库和其他仓库配置）。而且如果存在多个mirror，一定要把*（星号）的放到最下面。\n\n## 参考\n\n1. [Maven – Guide to Mirror Settings](http://maven.apache.org/guides/mini/guide-mirror-settings.html)\n\n2. [Maven：mirror和repository 区别 - 格物致知的个人页面](https://my.oschina.net/sunchp/blog/100634)\n\n3. [通过测试和代码告诉你Maven是如何使用mirror和repository的 - 偶尔记一下 - 博客频道 - CSDN.NET](http://blog.csdn.net/isea533/article/details/22437511)\n\n4. [深入比较几种maven仓库的优先级 | 大染志](http://toozhao.com/2012/07/13/compare-priority-of-maven-repository/)","source":"_drafts/maven-repo-mirror.md","raw":"---\ntitle: maven配置中的repo和mirror\ntoc: true\ntags: maven\ncategory: maven\nabbrlink: 58607\n---\n\n一份maven的配置文件示例：\n\n```xml\n<?xml version=\"1.0\"?>\n<settings xmlns=\"http://maven.apache.org/POM/4.0.0\"\n          xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n          xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0\n                            http://maven.apache.org/xsd/settings-1.0.0.xsd\">\n    <servers>\n        <server>\n            <id>snapshots</id>\n            <username>snapshots</username>\n            <password>g2Dki6XCfhi48Bnj</password>\n            <filePermissions>664</filePermissions>\n            <directoryPermissions>775</directoryPermissions>\n        </server>\n        <server>\n            <id>releases</id>\n            <username>{username}</username>\n            <password>{yourpwd}</password>\n            <filePermissions>664</filePermissions>\n            <directoryPermissions>775</directoryPermissions>\n        </server>\n    </servers>\n\n    <profiles>\n        <profile>\n            <id>Nexus</id>\n            <repositories>\n                <repository>\n                    <id>Nexus</id>\n                    <url>http://xxx.com:8081/nexus/content/groups/public</url>\n                    <releases>\n                        <enabled>true</enabled>\n                        <!-- always , daily (default), interval:X (where X is an integer in minutes) or never.-->\n                        <updatePolicy>daily</updatePolicy>\n                        <checksumPolicy>warn</checksumPolicy>\n                    </releases>\n                    <snapshots>\n                        <updatePolicy>always</updatePolicy>\n                    </snapshots>\n                </repository>\n            </repositories>\n            <pluginRepositories>\n                <pluginRepository>\n                    <id>Nexus</id>\n                    <url>http://xxx.com:8081/nexus/content/groups/public</url>\n                    <releases>\n                        <enabled>true</enabled>\n                        <checksumPolicy>warn</checksumPolicy>\n                    </releases>\n                    <snapshots>\n                        <updatePolicy>always</updatePolicy>\n                    </snapshots>\n                </pluginRepository>\n            </pluginRepositories>\n        </profile>\n    </profiles>\n\n    <activeProfiles>\n        <activeProfile>Nexus</activeProfile>\n    </activeProfiles>\n\t\n\t<mirrors>\n\t<mirror>\n\t      <id>z-alimaven</id>\n\t      <name>aliyun maven</name>\n\t      <url>http://maven.aliyun.com/nexus/content/groups/public/</url>\n\t      <mirrorOf>central</mirrorOf>        \n\t    </mirror>\n\t\t\n \t   <mirror>\n\t      <id>other-maven</id>\n\t      <name>other maven</name>\n\t      <url>http://xxx.com:8081/nexus/content/groups/public/</url>\n\t      <mirrorOf>*</mirrorOf>        \n\t    </mirror>\n\t  </mirrors>\n\n</settings>\n\n```\n\n配置中配置了一个gg\n\n>这里配置为*（星号）后，会导致所有的仓库都会通过osc的这个源去访问jar，由于osc现在的maven仓库和中央仓库一样，但是不包含第三方的仓库，因而第三方仓库都会出错，都会从osc的主仓库去查找，肯定找不到，因而maven会构建失败或者各种问题。\nmirrorOf配置*（星号）的时候，一般都是针对自己私有库的时候（私有库和其他仓库配置）。而且如果存在多个mirror，一定要把*（星号）的放到最下面。\n\n## 参考\n\n1. [Maven – Guide to Mirror Settings](http://maven.apache.org/guides/mini/guide-mirror-settings.html)\n\n2. [Maven：mirror和repository 区别 - 格物致知的个人页面](https://my.oschina.net/sunchp/blog/100634)\n\n3. [通过测试和代码告诉你Maven是如何使用mirror和repository的 - 偶尔记一下 - 博客频道 - CSDN.NET](http://blog.csdn.net/isea533/article/details/22437511)\n\n4. [深入比较几种maven仓库的优先级 | 大染志](http://toozhao.com/2012/07/13/compare-priority-of-maven-repository/)","slug":"maven-repo-mirror","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-18T16:01:40.507Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7k002tjh4k15ilvmla","content":"<p>一份maven的配置文件示例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\"?&gt;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0\"</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">                            http://maven.apache.org/xsd/settings-1.0.0.xsd\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>snapshots<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>snapshots<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>g2Dki6XCfhi48Bnj<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">filePermissions</span>&gt;</span>664<span class=\"tag\">&lt;/<span class=\"name\">filePermissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">directoryPermissions</span>&gt;</span>775<span class=\"tag\">&lt;/<span class=\"name\">directoryPermissions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>releases<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>&#123;username&#125;<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>&#123;yourpwd&#125;<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">filePermissions</span>&gt;</span>664<span class=\"tag\">&lt;/<span class=\"name\">filePermissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">directoryPermissions</span>&gt;</span>775<span class=\"tag\">&lt;/<span class=\"name\">directoryPermissions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">profiles</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">profile</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">repositories</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://xxx.com:8081/nexus/content/groups/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"comment\">&lt;!-- always , daily (default), interval:X (where X is an integer in minutes) or never.--&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">updatePolicy</span>&gt;</span>daily<span class=\"tag\">&lt;/<span class=\"name\">updatePolicy</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">checksumPolicy</span>&gt;</span>warn<span class=\"tag\">&lt;/<span class=\"name\">checksumPolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">updatePolicy</span>&gt;</span>always<span class=\"tag\">&lt;/<span class=\"name\">updatePolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">repositories</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">pluginRepositories</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://xxx.com:8081/nexus/content/groups/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">checksumPolicy</span>&gt;</span>warn<span class=\"tag\">&lt;/<span class=\"name\">checksumPolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">updatePolicy</span>&gt;</span>always<span class=\"tag\">&lt;/<span class=\"name\">updatePolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">pluginRepositories</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">profile</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">profiles</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">activeProfiles</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">activeProfile</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">activeProfile</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">activeProfiles</span>&gt;</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">mirrors</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>z-alimaven<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>aliyun maven<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>central<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span>        </span><br><span class=\"line\">\t    <span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\"> \t   <span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>other-maven<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>other maven<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://xxx.com:8081/nexus/content/groups/public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>*<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span>        </span><br><span class=\"line\">\t    <span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t  <span class=\"tag\">&lt;/<span class=\"name\">mirrors</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>配置中配置了一个gg</p>\n<blockquote>\n<p>这里配置为<em>（星号）后，会导致所有的仓库都会通过osc的这个源去访问jar，由于osc现在的maven仓库和中央仓库一样，但是不包含第三方的仓库，因而第三方仓库都会出错，都会从osc的主仓库去查找，肯定找不到，因而maven会构建失败或者各种问题。<br>mirrorOf配置</em>（星号）的时候，一般都是针对自己私有库的时候（私有库和其他仓库配置）。而且如果存在多个mirror，一定要把*（星号）的放到最下面。</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://maven.apache.org/guides/mini/guide-mirror-settings.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maven – Guide to Mirror Settings</a></p>\n</li>\n<li><p><a href=\"https://my.oschina.net/sunchp/blog/100634\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maven：mirror和repository 区别 - 格物致知的个人页面</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/isea533/article/details/22437511\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">通过测试和代码告诉你Maven是如何使用mirror和repository的 - 偶尔记一下 - 博客频道 - CSDN.NET</a></p>\n</li>\n<li><p><a href=\"http://toozhao.com/2012/07/13/compare-priority-of-maven-repository/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">深入比较几种maven仓库的优先级 | 大染志</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>一份maven的配置文件示例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\"?&gt;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0\"</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">                            http://maven.apache.org/xsd/settings-1.0.0.xsd\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>snapshots<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>snapshots<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>g2Dki6XCfhi48Bnj<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">filePermissions</span>&gt;</span>664<span class=\"tag\">&lt;/<span class=\"name\">filePermissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">directoryPermissions</span>&gt;</span>775<span class=\"tag\">&lt;/<span class=\"name\">directoryPermissions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>releases<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>&#123;username&#125;<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>&#123;yourpwd&#125;<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">filePermissions</span>&gt;</span>664<span class=\"tag\">&lt;/<span class=\"name\">filePermissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">directoryPermissions</span>&gt;</span>775<span class=\"tag\">&lt;/<span class=\"name\">directoryPermissions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servers</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">profiles</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">profile</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">repositories</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://xxx.com:8081/nexus/content/groups/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"comment\">&lt;!-- always , daily (default), interval:X (where X is an integer in minutes) or never.--&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">updatePolicy</span>&gt;</span>daily<span class=\"tag\">&lt;/<span class=\"name\">updatePolicy</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">checksumPolicy</span>&gt;</span>warn<span class=\"tag\">&lt;/<span class=\"name\">checksumPolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">updatePolicy</span>&gt;</span>always<span class=\"tag\">&lt;/<span class=\"name\">updatePolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">repository</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">repositories</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">pluginRepositories</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://xxx.com:8081/nexus/content/groups/public<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">checksumPolicy</span>&gt;</span>warn<span class=\"tag\">&lt;/<span class=\"name\">checksumPolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">releases</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">updatePolicy</span>&gt;</span>always<span class=\"tag\">&lt;/<span class=\"name\">updatePolicy</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">snapshots</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">pluginRepository</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">pluginRepositories</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">profile</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">profiles</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">activeProfiles</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">activeProfile</span>&gt;</span>Nexus<span class=\"tag\">&lt;/<span class=\"name\">activeProfile</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">activeProfiles</span>&gt;</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">mirrors</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>z-alimaven<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>aliyun maven<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>central<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span>        </span><br><span class=\"line\">\t    <span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\"> \t   <span class=\"tag\">&lt;<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">id</span>&gt;</span>other-maven<span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>other maven<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">url</span>&gt;</span>http://xxx.com:8081/nexus/content/groups/public/<span class=\"tag\">&lt;/<span class=\"name\">url</span>&gt;</span></span><br><span class=\"line\">\t      <span class=\"tag\">&lt;<span class=\"name\">mirrorOf</span>&gt;</span>*<span class=\"tag\">&lt;/<span class=\"name\">mirrorOf</span>&gt;</span>        </span><br><span class=\"line\">\t    <span class=\"tag\">&lt;/<span class=\"name\">mirror</span>&gt;</span></span><br><span class=\"line\">\t  <span class=\"tag\">&lt;/<span class=\"name\">mirrors</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>配置中配置了一个gg</p>\n<blockquote>\n<p>这里配置为<em>（星号）后，会导致所有的仓库都会通过osc的这个源去访问jar，由于osc现在的maven仓库和中央仓库一样，但是不包含第三方的仓库，因而第三方仓库都会出错，都会从osc的主仓库去查找，肯定找不到，因而maven会构建失败或者各种问题。<br>mirrorOf配置</em>（星号）的时候，一般都是针对自己私有库的时候（私有库和其他仓库配置）。而且如果存在多个mirror，一定要把*（星号）的放到最下面。</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://maven.apache.org/guides/mini/guide-mirror-settings.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maven – Guide to Mirror Settings</a></p>\n</li>\n<li><p><a href=\"https://my.oschina.net/sunchp/blog/100634\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maven：mirror和repository 区别 - 格物致知的个人页面</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/isea533/article/details/22437511\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">通过测试和代码告诉你Maven是如何使用mirror和repository的 - 偶尔记一下 - 博客频道 - CSDN.NET</a></p>\n</li>\n<li><p><a href=\"http://toozhao.com/2012/07/13/compare-priority-of-maven-repository/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">深入比较几种maven仓库的优先级 | 大染志</a></p>\n</li>\n</ol>\n"},{"title":"map","toc":true,"category":null,"_content":"\n\n>加载因子存在的原因，还是因为减缓哈希冲突，如果初始桶为16，等到满16个元素才扩容，某些桶里可能就有不止一个元素了。\n>所以加载因子默认为0.75，也就是说大小为16的HashMap，到了第13个元素，就会扩容成32。\n\n\n```java\n /**\n   * Creates a {@code HashMap} instance, with a high enough \"initial capacity\"\n   * that it <i>should</i> hold {@code expectedSize} elements without growth.\n   * This behavior cannot be broadly guaranteed, but it is observed to be true\n   * for OpenJDK 1.7. It also can't be guaranteed that the method isn't\n   * inadvertently <i>oversizing</i> the returned map.\n   *\n   * @param expectedSize the number of entries you expect to add to the\n   *        returned map\n   * @return a new, empty {@code HashMap} with enough capacity to hold {@code\n   *         expectedSize} entries without resizing\n   * @throws IllegalArgumentException if {@code expectedSize} is negative\n   */\n  public static <K, V> HashMap<K, V> newHashMapWithExpectedSize(int expectedSize) {\n    return new HashMap<K, V>(capacity(expectedSize));\n  }\n\n  /**\n   * Returns a capacity that is sufficient to keep the map from being resized as\n   * long as it grows no larger than expectedSize and the load factor is >= its\n   * default (0.75).\n   */\n  static int capacity(int expectedSize) {\n    if (expectedSize < 3) {\n      checkNonnegative(expectedSize, \"expectedSize\");\n      return expectedSize + 1;\n    }\n    if (expectedSize < Ints.MAX_POWER_OF_TWO) {\n      // This is the calculation used in JDK8 to resize when a putAll\n      // happens; it seems to be the most conservative calculation we\n      // can make.  0.75 is the default load factor.\n      return (int) ((float) expectedSize / 0.75F + 1.0F);\n    }\n    return Integer.MAX_VALUE; // any large value\n  }\n```\n\n## 参考\n\n1. [高性能场景下，Map家族的优化使用建议 | 江南白衣](http://calvin1978.blogcn.com/articles/hashmap.html)","source":"_drafts/map.md","raw":"title: map\ntoc: true\ntags:\ncategory:\n---\n\n\n>加载因子存在的原因，还是因为减缓哈希冲突，如果初始桶为16，等到满16个元素才扩容，某些桶里可能就有不止一个元素了。\n>所以加载因子默认为0.75，也就是说大小为16的HashMap，到了第13个元素，就会扩容成32。\n\n\n```java\n /**\n   * Creates a {@code HashMap} instance, with a high enough \"initial capacity\"\n   * that it <i>should</i> hold {@code expectedSize} elements without growth.\n   * This behavior cannot be broadly guaranteed, but it is observed to be true\n   * for OpenJDK 1.7. It also can't be guaranteed that the method isn't\n   * inadvertently <i>oversizing</i> the returned map.\n   *\n   * @param expectedSize the number of entries you expect to add to the\n   *        returned map\n   * @return a new, empty {@code HashMap} with enough capacity to hold {@code\n   *         expectedSize} entries without resizing\n   * @throws IllegalArgumentException if {@code expectedSize} is negative\n   */\n  public static <K, V> HashMap<K, V> newHashMapWithExpectedSize(int expectedSize) {\n    return new HashMap<K, V>(capacity(expectedSize));\n  }\n\n  /**\n   * Returns a capacity that is sufficient to keep the map from being resized as\n   * long as it grows no larger than expectedSize and the load factor is >= its\n   * default (0.75).\n   */\n  static int capacity(int expectedSize) {\n    if (expectedSize < 3) {\n      checkNonnegative(expectedSize, \"expectedSize\");\n      return expectedSize + 1;\n    }\n    if (expectedSize < Ints.MAX_POWER_OF_TWO) {\n      // This is the calculation used in JDK8 to resize when a putAll\n      // happens; it seems to be the most conservative calculation we\n      // can make.  0.75 is the default load factor.\n      return (int) ((float) expectedSize / 0.75F + 1.0F);\n    }\n    return Integer.MAX_VALUE; // any large value\n  }\n```\n\n## 参考\n\n1. [高性能场景下，Map家族的优化使用建议 | 江南白衣](http://calvin1978.blogcn.com/articles/hashmap.html)","slug":"map","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-07T03:15:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7m002vjh4kv5343mtc","content":"<blockquote>\n<p>加载因子存在的原因，还是因为减缓哈希冲突，如果初始桶为16，等到满16个元素才扩容，某些桶里可能就有不止一个元素了。<br>所以加载因子默认为0.75，也就是说大小为16的HashMap，到了第13个元素，就会扩容成32。</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Creates a &#123;<span class=\"doctag\">@code</span> HashMap&#125; instance, with a high enough \"initial capacity\"</span></span><br><span class=\"line\"><span class=\"comment\">  * that it &lt;i&gt;should&lt;/i&gt; hold &#123;<span class=\"doctag\">@code</span> expectedSize&#125; elements without growth.</span></span><br><span class=\"line\"><span class=\"comment\">  * This behavior cannot be broadly guaranteed, but it is observed to be true</span></span><br><span class=\"line\"><span class=\"comment\">  * for OpenJDK 1.7. It also can't be guaranteed that the method isn't</span></span><br><span class=\"line\"><span class=\"comment\">  * inadvertently &lt;i&gt;oversizing&lt;/i&gt; the returned map.</span></span><br><span class=\"line\"><span class=\"comment\">  *</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> expectedSize the number of entries you expect to add to the</span></span><br><span class=\"line\"><span class=\"comment\">  *        returned map</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@return</span> a new, empty &#123;<span class=\"doctag\">@code</span> HashMap&#125; with enough capacity to hold &#123;<span class=\"doctag\">@code</span></span></span><br><span class=\"line\"><span class=\"comment\">  *         expectedSize&#125; entries without resizing</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@throws</span> IllegalArgumentException if &#123;<span class=\"doctag\">@code</span> expectedSize&#125; is negative</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\"> <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;K, V&gt; <span class=\"function\">HashMap&lt;K, V&gt; <span class=\"title\">newHashMapWithExpectedSize</span><span class=\"params\">(<span class=\"keyword\">int</span> expectedSize)</span> </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> HashMap&lt;K, V&gt;(capacity(expectedSize));</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Returns a capacity that is sufficient to keep the map from being resized as</span></span><br><span class=\"line\"><span class=\"comment\">  * long as it grows no larger than expectedSize and the load factor is &gt;= its</span></span><br><span class=\"line\"><span class=\"comment\">  * default (0.75).</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">capacity</span><span class=\"params\">(<span class=\"keyword\">int</span> expectedSize)</span> </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (expectedSize &lt; <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">     checkNonnegative(expectedSize, <span class=\"string\">\"expectedSize\"</span>);</span><br><span class=\"line\">     <span class=\"keyword\">return</span> expectedSize + <span class=\"number\">1</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (expectedSize &lt; Ints.MAX_POWER_OF_TWO) &#123;</span><br><span class=\"line\">     <span class=\"comment\">// This is the calculation used in JDK8 to resize when a putAll</span></span><br><span class=\"line\">     <span class=\"comment\">// happens; it seems to be the most conservative calculation we</span></span><br><span class=\"line\">     <span class=\"comment\">// can make.  0.75 is the default load factor.</span></span><br><span class=\"line\">     <span class=\"keyword\">return</span> (<span class=\"keyword\">int</span>) ((<span class=\"keyword\">float</span>) expectedSize / <span class=\"number\">0.75F</span> + <span class=\"number\">1.0F</span>);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> Integer.MAX_VALUE; <span class=\"comment\">// any large value</span></span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://calvin1978.blogcn.com/articles/hashmap.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">高性能场景下，Map家族的优化使用建议 | 江南白衣</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>加载因子存在的原因，还是因为减缓哈希冲突，如果初始桶为16，等到满16个元素才扩容，某些桶里可能就有不止一个元素了。<br>所以加载因子默认为0.75，也就是说大小为16的HashMap，到了第13个元素，就会扩容成32。</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Creates a &#123;<span class=\"doctag\">@code</span> HashMap&#125; instance, with a high enough \"initial capacity\"</span></span><br><span class=\"line\"><span class=\"comment\">  * that it &lt;i&gt;should&lt;/i&gt; hold &#123;<span class=\"doctag\">@code</span> expectedSize&#125; elements without growth.</span></span><br><span class=\"line\"><span class=\"comment\">  * This behavior cannot be broadly guaranteed, but it is observed to be true</span></span><br><span class=\"line\"><span class=\"comment\">  * for OpenJDK 1.7. It also can't be guaranteed that the method isn't</span></span><br><span class=\"line\"><span class=\"comment\">  * inadvertently &lt;i&gt;oversizing&lt;/i&gt; the returned map.</span></span><br><span class=\"line\"><span class=\"comment\">  *</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> expectedSize the number of entries you expect to add to the</span></span><br><span class=\"line\"><span class=\"comment\">  *        returned map</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@return</span> a new, empty &#123;<span class=\"doctag\">@code</span> HashMap&#125; with enough capacity to hold &#123;<span class=\"doctag\">@code</span></span></span><br><span class=\"line\"><span class=\"comment\">  *         expectedSize&#125; entries without resizing</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@throws</span> IllegalArgumentException if &#123;<span class=\"doctag\">@code</span> expectedSize&#125; is negative</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\"> <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;K, V&gt; <span class=\"function\">HashMap&lt;K, V&gt; <span class=\"title\">newHashMapWithExpectedSize</span><span class=\"params\">(<span class=\"keyword\">int</span> expectedSize)</span> </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> HashMap&lt;K, V&gt;(capacity(expectedSize));</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Returns a capacity that is sufficient to keep the map from being resized as</span></span><br><span class=\"line\"><span class=\"comment\">  * long as it grows no larger than expectedSize and the load factor is &gt;= its</span></span><br><span class=\"line\"><span class=\"comment\">  * default (0.75).</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">capacity</span><span class=\"params\">(<span class=\"keyword\">int</span> expectedSize)</span> </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (expectedSize &lt; <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">     checkNonnegative(expectedSize, <span class=\"string\">\"expectedSize\"</span>);</span><br><span class=\"line\">     <span class=\"keyword\">return</span> expectedSize + <span class=\"number\">1</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (expectedSize &lt; Ints.MAX_POWER_OF_TWO) &#123;</span><br><span class=\"line\">     <span class=\"comment\">// This is the calculation used in JDK8 to resize when a putAll</span></span><br><span class=\"line\">     <span class=\"comment\">// happens; it seems to be the most conservative calculation we</span></span><br><span class=\"line\">     <span class=\"comment\">// can make.  0.75 is the default load factor.</span></span><br><span class=\"line\">     <span class=\"keyword\">return</span> (<span class=\"keyword\">int</span>) ((<span class=\"keyword\">float</span>) expectedSize / <span class=\"number\">0.75F</span> + <span class=\"number\">1.0F</span>);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> Integer.MAX_VALUE; <span class=\"comment\">// any large value</span></span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://calvin1978.blogcn.com/articles/hashmap.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">高性能场景下，Map家族的优化使用建议 | 江南白衣</a></li>\n</ol>\n"},{"title":"more-executors","toc":true,"category":null,"_content":"\n\n```java\n\n    final void addDelayedShutdownHook(\n        final ExecutorService service, final long terminationTimeout, final TimeUnit timeUnit) {\n      checkNotNull(service);\n      checkNotNull(timeUnit);\n      addShutdownHook(MoreExecutors.newThread(\"DelayedShutdownHook-for-\" + service, new Runnable() {\n        @Override\n        public void run() {\n          try {\n            // We'd like to log progress and failures that may arise in the\n            // following code, but unfortunately the behavior of logging\n            // is undefined in shutdown hooks.\n            // This is because the logging code installs a shutdown hook of its\n            // own. See Cleaner class inside {@link LogManager}.\n            service.shutdown();\n            service.awaitTermination(terminationTimeout, timeUnit);\n          } catch (InterruptedException ignored) {\n            // We're shutting down anyway, so just ignore.\n          }\n        }\n      }));\n    }\n```\n","source":"_drafts/more-executors.md","raw":"title: more-executors\ntoc: true\ntags:\ncategory:\n---\n\n\n```java\n\n    final void addDelayedShutdownHook(\n        final ExecutorService service, final long terminationTimeout, final TimeUnit timeUnit) {\n      checkNotNull(service);\n      checkNotNull(timeUnit);\n      addShutdownHook(MoreExecutors.newThread(\"DelayedShutdownHook-for-\" + service, new Runnable() {\n        @Override\n        public void run() {\n          try {\n            // We'd like to log progress and failures that may arise in the\n            // following code, but unfortunately the behavior of logging\n            // is undefined in shutdown hooks.\n            // This is because the logging code installs a shutdown hook of its\n            // own. See Cleaner class inside {@link LogManager}.\n            service.shutdown();\n            service.awaitTermination(terminationTimeout, timeUnit);\n          } catch (InterruptedException ignored) {\n            // We're shutting down anyway, so just ignore.\n          }\n        }\n      }));\n    }\n```\n","slug":"more-executors","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-18T10:17:47.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7n002yjh4kpwj4vw8u","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">addDelayedShutdownHook</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    <span class=\"keyword\">final</span> ExecutorService service, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> terminationTimeout, <span class=\"keyword\">final</span> TimeUnit timeUnit)</span> </span>&#123;</span><br><span class=\"line\">  checkNotNull(service);</span><br><span class=\"line\">  checkNotNull(timeUnit);</span><br><span class=\"line\">  addShutdownHook(MoreExecutors.newThread(<span class=\"string\">\"DelayedShutdownHook-for-\"</span> + service, <span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We'd like to log progress and failures that may arise in the</span></span><br><span class=\"line\">        <span class=\"comment\">// following code, but unfortunately the behavior of logging</span></span><br><span class=\"line\">        <span class=\"comment\">// is undefined in shutdown hooks.</span></span><br><span class=\"line\">        <span class=\"comment\">// This is because the logging code installs a shutdown hook of its</span></span><br><span class=\"line\">        <span class=\"comment\">// own. See Cleaner class inside &#123;@link LogManager&#125;.</span></span><br><span class=\"line\">        service.shutdown();</span><br><span class=\"line\">        service.awaitTermination(terminationTimeout, timeUnit);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (InterruptedException ignored) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We're shutting down anyway, so just ignore.</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">addDelayedShutdownHook</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    <span class=\"keyword\">final</span> ExecutorService service, <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> terminationTimeout, <span class=\"keyword\">final</span> TimeUnit timeUnit)</span> </span>&#123;</span><br><span class=\"line\">  checkNotNull(service);</span><br><span class=\"line\">  checkNotNull(timeUnit);</span><br><span class=\"line\">  addShutdownHook(MoreExecutors.newThread(<span class=\"string\">\"DelayedShutdownHook-for-\"</span> + service, <span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We'd like to log progress and failures that may arise in the</span></span><br><span class=\"line\">        <span class=\"comment\">// following code, but unfortunately the behavior of logging</span></span><br><span class=\"line\">        <span class=\"comment\">// is undefined in shutdown hooks.</span></span><br><span class=\"line\">        <span class=\"comment\">// This is because the logging code installs a shutdown hook of its</span></span><br><span class=\"line\">        <span class=\"comment\">// own. See Cleaner class inside &#123;@link LogManager&#125;.</span></span><br><span class=\"line\">        service.shutdown();</span><br><span class=\"line\">        service.awaitTermination(terminationTimeout, timeUnit);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (InterruptedException ignored) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We're shutting down anyway, so just ignore.</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n"},{"_content":"---\ntitle: murmur哈希算法\ntoc: true\ntags: hash\ncategory: algorithm\n--- \n\nGeoHash\n\n一致性hash\n\n## 参考\n\n1. [Murmur哈希 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/Murmur%E5%93%88%E5%B8%8C)\n\n","source":"_drafts/murmur.md","raw":"---\ntitle: murmur哈希算法\ntoc: true\ntags: hash\ncategory: algorithm\n--- \n\nGeoHash\n\n一致性hash\n\n## 参考\n\n1. [Murmur哈希 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/Murmur%E5%93%88%E5%B8%8C)\n\n","slug":"murmur","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-09-11T16:40:45.037Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7s0032jh4k0vabrg39","content":"<hr>\n<p>title: murmur哈希算法<br>toc: true<br>tags: hash</p>\n<h2 id=\"category-algorithm\"><a href=\"#category-algorithm\" class=\"headerlink\" title=\"category: algorithm\"></a>category: algorithm</h2><p>GeoHash</p>\n<p>一致性hash</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://zh.wikipedia.org/wiki/Murmur%E5%93%88%E5%B8%8C\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Murmur哈希 - 维基百科，自由的百科全书</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<hr>\n<p>title: murmur哈希算法<br>toc: true<br>tags: hash</p>\n<h2 id=\"category-algorithm\"><a href=\"#category-algorithm\" class=\"headerlink\" title=\"category: algorithm\"></a>category: algorithm</h2><p>GeoHash</p>\n<p>一致性hash</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://zh.wikipedia.org/wiki/Murmur%E5%93%88%E5%B8%8C\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Murmur哈希 - 维基百科，自由的百科全书</a></li>\n</ol>\n"},{"title":"netty","toc":true,"abbrlink":64849,"category":null,"_content":"\n\nnetty nio \n\nsocket 层的封装\n\n## 参考\n\n[Netty和Jetty的Java NIO 网络框架模型分析](http://codefine.co/652.html)\n\n[Netty: Home](http://netty.io/)","source":"_drafts/netty.md","raw":"---\ntitle: netty\ntoc: true\nabbrlink: 64849\ntags:\ncategory:\n---\n\n\nnetty nio \n\nsocket 层的封装\n\n## 参考\n\n[Netty和Jetty的Java NIO 网络框架模型分析](http://codefine.co/652.html)\n\n[Netty: Home](http://netty.io/)","slug":"netty","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7u0034jh4kio4k022f","content":"<p>netty nio </p>\n<p>socket 层的封装</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://codefine.co/652.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Netty和Jetty的Java NIO 网络框架模型分析</a></p>\n<p><a href=\"http://netty.io/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Netty: Home</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>netty nio </p>\n<p>socket 层的封装</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://codefine.co/652.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Netty和Jetty的Java NIO 网络框架模型分析</a></p>\n<p><a href=\"http://netty.io/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Netty: Home</a></p>\n"},{"title":"python-json","toc":true,"abbrlink":55379,"category":null,"_content":"\nhttps://blog.nicky-zs.com/blog/17/\n\nFormat JSON with python\n\nhttps://pypi.python.org/pypi/jsondiff/0.1.0","source":"_drafts/python-json.md","raw":"---\ntitle: python-json\ntoc: true\nabbrlink: 55379\ntags:\ncategory:\n---\n\nhttps://blog.nicky-zs.com/blog/17/\n\nFormat JSON with python\n\nhttps://pypi.python.org/pypi/jsondiff/0.1.0","slug":"python-json","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7w0037jh4ktg19ykmo","content":"<p><a href=\"https://blog.nicky-zs.com/blog/17/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://blog.nicky-zs.com/blog/17/</a></p>\n<p>Format JSON with python</p>\n<p><a href=\"https://pypi.python.org/pypi/jsondiff/0.1.0\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://pypi.python.org/pypi/jsondiff/0.1.0</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://blog.nicky-zs.com/blog/17/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://blog.nicky-zs.com/blog/17/</a></p>\n<p>Format JSON with python</p>\n<p><a href=\"https://pypi.python.org/pypi/jsondiff/0.1.0\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://pypi.python.org/pypi/jsondiff/0.1.0</a></p>\n"},{"title":"protobuf","toc":true,"abbrlink":2038,"category":null,"_content":"\n\n原理\n\n兼容性\n\nkryo 比较\n\n深入一点！","source":"_drafts/protobuf.md","raw":"---\ntitle: protobuf\ntoc: true\nabbrlink: 2038\ntags:\ncategory:\n---\n\n\n原理\n\n兼容性\n\nkryo 比较\n\n深入一点！","slug":"protobuf","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd7z0039jh4kd3qna8zf","content":"<p>原理</p>\n<p>兼容性</p>\n<p>kryo 比较</p>\n<p>深入一点！</p>\n","site":{"data":{}},"excerpt":"","more":"<p>原理</p>\n<p>兼容性</p>\n<p>kryo 比较</p>\n<p>深入一点！</p>\n"},{"title":"Guava之ratelimiter,限流利器","toc":true,"_content":"\n## 限流\n\n### Semaphore\n\n限制并发（concurrency）\n\n### RateLimiter\n\n限制rate\n\n> Rate limiters are often used to restrict the rate at which some physical or logical resource\n> is accessed. This is in contrast to {@link java.util.concurrent.Semaphore} which restricts the\n> number of concurrent accesses instead of the rate (note though that concurrency and rate are\n> closely related, e.g. see <a href=\"http://en.wikipedia.org/wiki/Little%27s_law\">Little's\n> Law</a>).\n\n## 参考\n\n1. [Little's law - Wikipedia](https://en.wikipedia.org/wiki/Little%27s_law)\n","source":"_drafts/ratelimiter.md","raw":"---\ntitle: 'Guava之ratelimiter,限流利器'\ntoc: true\ntags: rate-limiter\ncategory: guava\n---\n\n## 限流\n\n### Semaphore\n\n限制并发（concurrency）\n\n### RateLimiter\n\n限制rate\n\n> Rate limiters are often used to restrict the rate at which some physical or logical resource\n> is accessed. This is in contrast to {@link java.util.concurrent.Semaphore} which restricts the\n> number of concurrent accesses instead of the rate (note though that concurrency and rate are\n> closely related, e.g. see <a href=\"http://en.wikipedia.org/wiki/Little%27s_law\">Little's\n> Law</a>).\n\n## 参考\n\n1. [Little's law - Wikipedia](https://en.wikipedia.org/wiki/Little%27s_law)\n","slug":"ratelimiter","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2018-01-16T16:55:35.920Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd80003cjh4kj8mmpoms","content":"<h2 id=\"限流\"><a href=\"#限流\" class=\"headerlink\" title=\"限流\"></a>限流</h2><h3 id=\"Semaphore\"><a href=\"#Semaphore\" class=\"headerlink\" title=\"Semaphore\"></a>Semaphore</h3><p>限制并发（concurrency）</p>\n<h3 id=\"RateLimiter\"><a href=\"#RateLimiter\" class=\"headerlink\" title=\"RateLimiter\"></a>RateLimiter</h3><p>限制rate</p>\n<blockquote>\n<p>Rate limiters are often used to restrict the rate at which some physical or logical resource<br>is accessed. This is in contrast to {@link java.util.concurrent.Semaphore} which restricts the<br>number of concurrent accesses instead of the rate (note though that concurrency and rate are<br>closely related, e.g. see <a href=\"http://en.wikipedia.org/wiki/Little%27s_law\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Little’s<br>Law</a>).</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://en.wikipedia.org/wiki/Little%27s_law\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Little’s law - Wikipedia</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"限流\"><a href=\"#限流\" class=\"headerlink\" title=\"限流\"></a>限流</h2><h3 id=\"Semaphore\"><a href=\"#Semaphore\" class=\"headerlink\" title=\"Semaphore\"></a>Semaphore</h3><p>限制并发（concurrency）</p>\n<h3 id=\"RateLimiter\"><a href=\"#RateLimiter\" class=\"headerlink\" title=\"RateLimiter\"></a>RateLimiter</h3><p>限制rate</p>\n<blockquote>\n<p>Rate limiters are often used to restrict the rate at which some physical or logical resource<br>is accessed. This is in contrast to {@link java.util.concurrent.Semaphore} which restricts the<br>number of concurrent accesses instead of the rate (note though that concurrency and rate are<br>closely related, e.g. see <a href=\"http://en.wikipedia.org/wiki/Little%27s_law\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Little’s<br>Law</a>).</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://en.wikipedia.org/wiki/Little%27s_law\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Little’s law - Wikipedia</a></li>\n</ol>\n"},{"title":"rpc","toc":true,"abbrlink":62149,"category":null,"_content":"\n架构图，自己用plantuml 画出来\n\n\n```\n start rmiregistry 2001\n```\n\n","source":"_drafts/rpc.md","raw":"---\ntitle: rpc\ntoc: true\nabbrlink: 62149\ntags:\ncategory:\n---\n\n架构图，自己用plantuml 画出来\n\n\n```\n start rmiregistry 2001\n```\n\n","slug":"rpc","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:04:30.002Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd81003ejh4k3tskocwa","content":"<p>架构图，自己用plantuml 画出来</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start rmiregistry 2001</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p>架构图，自己用plantuml 画出来</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start rmiregistry 2001</span><br></pre></td></tr></table></figure>\n"},{"title":"Spring视图的那些事儿","toc":true,"abbrlink":60542,"_content":"\n## Internal\n\n/* 会拦截返回的jsp视图\n\n> 在多数项目中，InternalResourceViewResolver 是最常用的，该解析器可以返回指定目录下指定后缀的文件，它支持 JSP 及 JSTL 等视图技术，但是用该视图解析器时，需要注意设置好正确的优先级，因为该视图解析器即使没有找到正确的文件，也会返回一个视图，而不是返回 null，这样优先级比该视图解析器低的解析器，将不会被执行。\n\n## Thymeleaf\n\nweb.xml 中配置 \n\n```xml\n    <servlet-mapping>\n        <servlet-name>dispatcherServlet</servlet-name>\n        <url-pattern>/*</url-pattern>\n    </servlet-mapping>\n```\n\n不会影响返回视图\n\n## 参考\n\n1. [spring MVC 拦截了jsp视图导致404 - 求索路](http://www.qiusuolu.com/archives/314)\n\n2. [Spring中拦截/和拦截/*的区别 - 不能访问到返回的JSP - 访问静态资源(jpg,js等) - Josh_Persistence - ITeye技术网站](http://josh-persistence.iteye.com/blog/1922311)\n\n3. [开发 Spring 自定义视图和视图解析器](http://www.ibm.com/developerworks/cn/java/j-lo-springview/)\n\n","source":"_drafts/spring-view-resolver.md","raw":"---\ntitle: Spring视图的那些事儿\ntoc: true\ntags: view-resolver\ncategory: spring\nabbrlink: 60542\n---\n\n## Internal\n\n/* 会拦截返回的jsp视图\n\n> 在多数项目中，InternalResourceViewResolver 是最常用的，该解析器可以返回指定目录下指定后缀的文件，它支持 JSP 及 JSTL 等视图技术，但是用该视图解析器时，需要注意设置好正确的优先级，因为该视图解析器即使没有找到正确的文件，也会返回一个视图，而不是返回 null，这样优先级比该视图解析器低的解析器，将不会被执行。\n\n## Thymeleaf\n\nweb.xml 中配置 \n\n```xml\n    <servlet-mapping>\n        <servlet-name>dispatcherServlet</servlet-name>\n        <url-pattern>/*</url-pattern>\n    </servlet-mapping>\n```\n\n不会影响返回视图\n\n## 参考\n\n1. [spring MVC 拦截了jsp视图导致404 - 求索路](http://www.qiusuolu.com/archives/314)\n\n2. [Spring中拦截/和拦截/*的区别 - 不能访问到返回的JSP - 访问静态资源(jpg,js等) - Josh_Persistence - ITeye技术网站](http://josh-persistence.iteye.com/blog/1922311)\n\n3. [开发 Spring 自定义视图和视图解析器](http://www.ibm.com/developerworks/cn/java/j-lo-springview/)\n\n","slug":"spring-view-resolver","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd83003hjh4k9ykv3ije","content":"<h2 id=\"Internal\"><a href=\"#Internal\" class=\"headerlink\" title=\"Internal\"></a>Internal</h2><p>/* 会拦截返回的jsp视图</p>\n<blockquote>\n<p>在多数项目中，InternalResourceViewResolver 是最常用的，该解析器可以返回指定目录下指定后缀的文件，它支持 JSP 及 JSTL 等视图技术，但是用该视图解析器时，需要注意设置好正确的优先级，因为该视图解析器即使没有找到正确的文件，也会返回一个视图，而不是返回 null，这样优先级比该视图解析器低的解析器，将不会被执行。</p>\n</blockquote>\n<h2 id=\"Thymeleaf\"><a href=\"#Thymeleaf\" class=\"headerlink\" title=\"Thymeleaf\"></a>Thymeleaf</h2><p>web.xml 中配置 </p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>dispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>不会影响返回视图</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.qiusuolu.com/archives/314\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring MVC 拦截了jsp视图导致404 - 求索路</a></p>\n</li>\n<li><p><a href=\"http://josh-persistence.iteye.com/blog/1922311\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Spring中拦截/和拦截/*的区别 - 不能访问到返回的JSP - 访问静态资源(jpg,js等) - Josh_Persistence - ITeye技术网站</a></p>\n</li>\n<li><p><a href=\"http://www.ibm.com/developerworks/cn/java/j-lo-springview/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">开发 Spring 自定义视图和视图解析器</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Internal\"><a href=\"#Internal\" class=\"headerlink\" title=\"Internal\"></a>Internal</h2><p>/* 会拦截返回的jsp视图</p>\n<blockquote>\n<p>在多数项目中，InternalResourceViewResolver 是最常用的，该解析器可以返回指定目录下指定后缀的文件，它支持 JSP 及 JSTL 等视图技术，但是用该视图解析器时，需要注意设置好正确的优先级，因为该视图解析器即使没有找到正确的文件，也会返回一个视图，而不是返回 null，这样优先级比该视图解析器低的解析器，将不会被执行。</p>\n</blockquote>\n<h2 id=\"Thymeleaf\"><a href=\"#Thymeleaf\" class=\"headerlink\" title=\"Thymeleaf\"></a>Thymeleaf</h2><p>web.xml 中配置 </p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>dispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>不会影响返回视图</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.qiusuolu.com/archives/314\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring MVC 拦截了jsp视图导致404 - 求索路</a></p>\n</li>\n<li><p><a href=\"http://josh-persistence.iteye.com/blog/1922311\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Spring中拦截/和拦截/*的区别 - 不能访问到返回的JSP - 访问静态资源(jpg,js等) - Josh_Persistence - ITeye技术网站</a></p>\n</li>\n<li><p><a href=\"http://www.ibm.com/developerworks/cn/java/j-lo-springview/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">开发 Spring 自定义视图和视图解析器</a></p>\n</li>\n</ol>\n"},{"title":"ssh","toc":true,"abbrlink":1493,"_content":"","source":"_drafts/ssh.md","raw":"---\ntitle: ssh\ntags: ssh\ncategory: linux\ntoc: true\nabbrlink: 1493\n---\n","slug":"ssh","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd84003jjh4kbpux5znp","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"task","toc":true,"abbrlink":61742,"category":null,"_content":"\n\nFuture\n\nCallable\n\njava8 中的改进","source":"_drafts/task.md","raw":"---\ntitle: task\ntoc: true\nabbrlink: 61742\ntags:\ncategory:\n---\n\n\nFuture\n\nCallable\n\njava8 中的改进","slug":"task","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd85003kjh4k4nn3512f","content":"<p>Future</p>\n<p>Callable</p>\n<p>java8 中的改进</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Future</p>\n<p>Callable</p>\n<p>java8 中的改进</p>\n"},{"title":"当ThreadLocal遇上ThreadPool","toc":true,"_content":"\nMDC\n\ntrace\n\n### 隐形的线程池\n\nForkJoinPool commonPool\n\njava8 stream\n\n解决方案\n\n\n## 参考\n\n1. [java - How to use MDC with thread pools? - Stack Overflow](https://stackoverflow.com/questions/6073019/how-to-use-mdc-with-thread-pools/)\n","source":"_drafts/threadlocal-threadpool.md","raw":"title: 当ThreadLocal遇上ThreadPool\ntoc: true\ntags: threadpool\ncategory: threadpool\n---\n\nMDC\n\ntrace\n\n### 隐形的线程池\n\nForkJoinPool commonPool\n\njava8 stream\n\n解决方案\n\n\n## 参考\n\n1. [java - How to use MDC with thread pools? - Stack Overflow](https://stackoverflow.com/questions/6073019/how-to-use-mdc-with-thread-pools/)\n","slug":"threadlocal-threadpool","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-12-02T17:30:59.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd87003njh4kea21mwyp","content":"<p>MDC</p>\n<p>trace</p>\n<h3 id=\"隐形的线程池\"><a href=\"#隐形的线程池\" class=\"headerlink\" title=\"隐形的线程池\"></a>隐形的线程池</h3><p>ForkJoinPool commonPool</p>\n<p>java8 stream</p>\n<p>解决方案</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://stackoverflow.com/questions/6073019/how-to-use-mdc-with-thread-pools/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - How to use MDC with thread pools? - Stack Overflow</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>MDC</p>\n<p>trace</p>\n<h3 id=\"隐形的线程池\"><a href=\"#隐形的线程池\" class=\"headerlink\" title=\"隐形的线程池\"></a>隐形的线程池</h3><p>ForkJoinPool commonPool</p>\n<p>java8 stream</p>\n<p>解决方案</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://stackoverflow.com/questions/6073019/how-to-use-mdc-with-thread-pools/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - How to use MDC with thread pools? - Stack Overflow</a></li>\n</ol>\n"},{"title":"thread-interrupted","toc":true,"category":null,"_content":"\n\n\n```java\n private void put(E eventObject) {\n        if (neverBlock) {\n            blockingQueue.offer(eventObject);\n        } else {\n            try {\n                blockingQueue.put(eventObject);\n            } catch (InterruptedException e) {\n                // Interruption of current thread when in doAppend method should not be consumed\n                // by AsyncAppender\n                Thread.currentThread().interrupt();\n            }\n        }\n    }\n```","source":"_drafts/thread-interrupted.md","raw":"title: thread-interrupted\ntoc: true\ntags:\ncategory:\n---\n\n\n\n```java\n private void put(E eventObject) {\n        if (neverBlock) {\n            blockingQueue.offer(eventObject);\n        } else {\n            try {\n                blockingQueue.put(eventObject);\n            } catch (InterruptedException e) {\n                // Interruption of current thread when in doAppend method should not be consumed\n                // by AsyncAppender\n                Thread.currentThread().interrupt();\n            }\n        }\n    }\n```","slug":"thread-interrupted","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-18T10:09:01.386Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd89003pjh4kglgkwoi7","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(E eventObject)</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (neverBlock) &#123;</span><br><span class=\"line\">           blockingQueue.offer(eventObject);</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">               blockingQueue.put(eventObject);</span><br><span class=\"line\">           &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">               <span class=\"comment\">// Interruption of current thread when in doAppend method should not be consumed</span></span><br><span class=\"line\">               <span class=\"comment\">// by AsyncAppender</span></span><br><span class=\"line\">               Thread.currentThread().interrupt();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(E eventObject)</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (neverBlock) &#123;</span><br><span class=\"line\">           blockingQueue.offer(eventObject);</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">               blockingQueue.put(eventObject);</span><br><span class=\"line\">           &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">               <span class=\"comment\">// Interruption of current thread when in doAppend method should not be consumed</span></span><br><span class=\"line\">               <span class=\"comment\">// by AsyncAppender</span></span><br><span class=\"line\">               Thread.currentThread().interrupt();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>"},{"title":"Tomcat工作流程","toc":true,"abbrlink":2774,"date":"2017-01-20T16:59:55.000Z","_content":"\nStringManager\n\n\n禁用DNS轮询，DNS的优化点？?\n\n\nWindows 7下安装了Cygwin，发现没有telnet这个命令。在cygwin的搜索中也找不到telnet。\n但是经常使用telnet这个小工具。Google了一下发现包含telnet的包是 inetutils。直接安装inetutils即可。\n\n\ntelnet localhost 8097 shutdown\n\n➜  dev which telnet\n/usr/bin/telnet\n➜  dev telnet localhost 8005\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nSHUTDOWN\nConnection closed by foreign host.\n\n\n## Connector\n\n##  \n\n## 线程池策略\n\n场景1：接受一个请求，此时tomcat启动的线程数还没有达到corePoolSize(tomcat里头叫minSpareThreads)，tomcat会启动一个线程来处理该请求；\n场景2：接受一个请求，此时tomcat启动的线程数已经达到了corePoolSize，tomcat把该请求放入队列(offer)，如果放入队列成功，则返回，放入队列不成功，则尝试增加工作线程，在当前线程个数<maxThreads的时候，可以继续增加线程来处理，超过maxThreads的时候，则继续往等待队列里头放，等待队列放不进去，则抛出RejectedExecutionException；\n\n## JDK线程池策略\n\n每次提交任务时，如果线程数还没达到coreSize就创建新线程并绑定该任务。所以第coreSize次提交任务后线程总数必达到coreSize，不会重用之前的空闲线程。\n线程数达到coreSize后，新增的任务就放到工作队列里，而线程池里的线程则努力的使用take()从工作队列里拉活来干。\n如果队列是个有界队列，又如果线程池里的线程不能及时将任务取走，工作队列可能会满掉，插入任务就会失败，此时线程池就会紧急的再创建新的临时线程来补救。\n临时线程使用poll(keepAliveTime，timeUnit)来从工作队列拉活，如果时候到了仍然两手空空没拉到活，表明它太闲了，就会被解雇掉。\n如果core线程数＋临时线程数 >maxSize，则不能再创建新的临时线程了，转头执行RejectExecutionHanlder。默认的AbortPolicy抛RejectedExecutionException异常，其他选择包括静默放弃当前任务(Discard)，放弃工作队列里最老的任务(DisacardOldest)，或由主线程来直接执行(CallerRuns).\n\n\nCachedPool则把coreSize设成0，然后选用了一种特殊的Queue -- SynchronousQueue，只要当前没有空闲线程，Queue就会立刻报插入失败，让线程池增加新的临时线程，默认的KeepAliveTime是1分钟，而且maxSize是整型的最大值，也就是说只要有干不完的活，都会无限增增加线程数，直到高峰过去线程数才会回落。\n\n## console 被tomcat 重定向到 catalina.out中\n\n\n## 参考\n\nrequestProcess.pdf\n\n1. [Java-Latte: Architecture of Apache Tomcat](http://java-latte.blogspot.kr/2014/10/introduction-to-architecture-of-apache-tomcat-with-server.xml.html)\n\n2. [Tomcat 系统架构与设计模式，第 1 部分: 工作原理](https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/)\n\n3. [Guidewire, SAP, Oracle, UNIX, Genesys Technology Blog: Tomcat shutdown port 8005 - Remote Shutdown](http://singcheong.blogspot.kr/2012/10/tomcat-shutdown-port-8005-remote.html)\n\n4. [tomcat线程池策略 - xixicat - SegmentFault](https://segmentfault.com/a/1190000008052008)\n\n5. [Java ThreadPool的正确打开方式 | 江南白衣](http://calvin1978.blogcn.com/articles/java-threadpool.html)\n\n6. [Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣](http://calvin1978.blogcn.com/articles/tomcat-threadpool.html)\n\n7. [Tomcat 架构探索 | 一派胡言](http://threezj.com/2016/06/25/Tomcat%20%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/index.html)\n\n\n","source":"_drafts/tomcat-arch.md","raw":"---\ntitle: Tomcat工作流程\ntoc: true\ncategory: tomcat\nabbrlink: 2774\ndate: 2017-01-21 00:59:55\ntags:\n---\n\nStringManager\n\n\n禁用DNS轮询，DNS的优化点？?\n\n\nWindows 7下安装了Cygwin，发现没有telnet这个命令。在cygwin的搜索中也找不到telnet。\n但是经常使用telnet这个小工具。Google了一下发现包含telnet的包是 inetutils。直接安装inetutils即可。\n\n\ntelnet localhost 8097 shutdown\n\n➜  dev which telnet\n/usr/bin/telnet\n➜  dev telnet localhost 8005\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nSHUTDOWN\nConnection closed by foreign host.\n\n\n## Connector\n\n##  \n\n## 线程池策略\n\n场景1：接受一个请求，此时tomcat启动的线程数还没有达到corePoolSize(tomcat里头叫minSpareThreads)，tomcat会启动一个线程来处理该请求；\n场景2：接受一个请求，此时tomcat启动的线程数已经达到了corePoolSize，tomcat把该请求放入队列(offer)，如果放入队列成功，则返回，放入队列不成功，则尝试增加工作线程，在当前线程个数<maxThreads的时候，可以继续增加线程来处理，超过maxThreads的时候，则继续往等待队列里头放，等待队列放不进去，则抛出RejectedExecutionException；\n\n## JDK线程池策略\n\n每次提交任务时，如果线程数还没达到coreSize就创建新线程并绑定该任务。所以第coreSize次提交任务后线程总数必达到coreSize，不会重用之前的空闲线程。\n线程数达到coreSize后，新增的任务就放到工作队列里，而线程池里的线程则努力的使用take()从工作队列里拉活来干。\n如果队列是个有界队列，又如果线程池里的线程不能及时将任务取走，工作队列可能会满掉，插入任务就会失败，此时线程池就会紧急的再创建新的临时线程来补救。\n临时线程使用poll(keepAliveTime，timeUnit)来从工作队列拉活，如果时候到了仍然两手空空没拉到活，表明它太闲了，就会被解雇掉。\n如果core线程数＋临时线程数 >maxSize，则不能再创建新的临时线程了，转头执行RejectExecutionHanlder。默认的AbortPolicy抛RejectedExecutionException异常，其他选择包括静默放弃当前任务(Discard)，放弃工作队列里最老的任务(DisacardOldest)，或由主线程来直接执行(CallerRuns).\n\n\nCachedPool则把coreSize设成0，然后选用了一种特殊的Queue -- SynchronousQueue，只要当前没有空闲线程，Queue就会立刻报插入失败，让线程池增加新的临时线程，默认的KeepAliveTime是1分钟，而且maxSize是整型的最大值，也就是说只要有干不完的活，都会无限增增加线程数，直到高峰过去线程数才会回落。\n\n## console 被tomcat 重定向到 catalina.out中\n\n\n## 参考\n\nrequestProcess.pdf\n\n1. [Java-Latte: Architecture of Apache Tomcat](http://java-latte.blogspot.kr/2014/10/introduction-to-architecture-of-apache-tomcat-with-server.xml.html)\n\n2. [Tomcat 系统架构与设计模式，第 1 部分: 工作原理](https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/)\n\n3. [Guidewire, SAP, Oracle, UNIX, Genesys Technology Blog: Tomcat shutdown port 8005 - Remote Shutdown](http://singcheong.blogspot.kr/2012/10/tomcat-shutdown-port-8005-remote.html)\n\n4. [tomcat线程池策略 - xixicat - SegmentFault](https://segmentfault.com/a/1190000008052008)\n\n5. [Java ThreadPool的正确打开方式 | 江南白衣](http://calvin1978.blogcn.com/articles/java-threadpool.html)\n\n6. [Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣](http://calvin1978.blogcn.com/articles/tomcat-threadpool.html)\n\n7. [Tomcat 架构探索 | 一派胡言](http://threezj.com/2016/06/25/Tomcat%20%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/index.html)\n\n\n","slug":"tomcat-arch","published":0,"updated":"2017-04-16T12:03:23.381Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8b003tjh4khwc642mx","content":"<p>StringManager</p>\n<p>禁用DNS轮询，DNS的优化点？?</p>\n<p>Windows 7下安装了Cygwin，发现没有telnet这个命令。在cygwin的搜索中也找不到telnet。<br>但是经常使用telnet这个小工具。Google了一下发现包含telnet的包是 inetutils。直接安装inetutils即可。</p>\n<p>telnet localhost 8097 shutdown</p>\n<p>➜  dev which telnet<br>/usr/bin/telnet<br>➜  dev telnet localhost 8005<br>Trying 127.0.0.1…<br>Connected to localhost.<br>Escape character is ‘^]’.<br>SHUTDOWN<br>Connection closed by foreign host.</p>\n<h2 id=\"Connector\"><a href=\"#Connector\" class=\"headerlink\" title=\"Connector\"></a>Connector</h2><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\" \"></a> </h2><h2 id=\"线程池策略\"><a href=\"#线程池策略\" class=\"headerlink\" title=\"线程池策略\"></a>线程池策略</h2><p>场景1：接受一个请求，此时tomcat启动的线程数还没有达到corePoolSize(tomcat里头叫minSpareThreads)，tomcat会启动一个线程来处理该请求；<br>场景2：接受一个请求，此时tomcat启动的线程数已经达到了corePoolSize，tomcat把该请求放入队列(offer)，如果放入队列成功，则返回，放入队列不成功，则尝试增加工作线程，在当前线程个数&lt;maxThreads的时候，可以继续增加线程来处理，超过maxThreads的时候，则继续往等待队列里头放，等待队列放不进去，则抛出RejectedExecutionException；</p>\n<h2 id=\"JDK线程池策略\"><a href=\"#JDK线程池策略\" class=\"headerlink\" title=\"JDK线程池策略\"></a>JDK线程池策略</h2><p>每次提交任务时，如果线程数还没达到coreSize就创建新线程并绑定该任务。所以第coreSize次提交任务后线程总数必达到coreSize，不会重用之前的空闲线程。<br>线程数达到coreSize后，新增的任务就放到工作队列里，而线程池里的线程则努力的使用take()从工作队列里拉活来干。<br>如果队列是个有界队列，又如果线程池里的线程不能及时将任务取走，工作队列可能会满掉，插入任务就会失败，此时线程池就会紧急的再创建新的临时线程来补救。<br>临时线程使用poll(keepAliveTime，timeUnit)来从工作队列拉活，如果时候到了仍然两手空空没拉到活，表明它太闲了，就会被解雇掉。<br>如果core线程数＋临时线程数 &gt;maxSize，则不能再创建新的临时线程了，转头执行RejectExecutionHanlder。默认的AbortPolicy抛RejectedExecutionException异常，其他选择包括静默放弃当前任务(Discard)，放弃工作队列里最老的任务(DisacardOldest)，或由主线程来直接执行(CallerRuns).</p>\n<p>CachedPool则把coreSize设成0，然后选用了一种特殊的Queue – SynchronousQueue，只要当前没有空闲线程，Queue就会立刻报插入失败，让线程池增加新的临时线程，默认的KeepAliveTime是1分钟，而且maxSize是整型的最大值，也就是说只要有干不完的活，都会无限增增加线程数，直到高峰过去线程数才会回落。</p>\n<h2 id=\"console-被tomcat-重定向到-catalina-out中\"><a href=\"#console-被tomcat-重定向到-catalina-out中\" class=\"headerlink\" title=\"console 被tomcat 重定向到 catalina.out中\"></a>console 被tomcat 重定向到 catalina.out中</h2><h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p>requestProcess.pdf</p>\n<ol>\n<li><p><a href=\"http://java-latte.blogspot.kr/2014/10/introduction-to-architecture-of-apache-tomcat-with-server.xml.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java-Latte: Architecture of Apache Tomcat</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat 系统架构与设计模式，第 1 部分: 工作原理</a></p>\n</li>\n<li><p><a href=\"http://singcheong.blogspot.kr/2012/10/tomcat-shutdown-port-8005-remote.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Guidewire, SAP, Oracle, UNIX, Genesys Technology Blog: Tomcat shutdown port 8005 - Remote Shutdown</a></p>\n</li>\n<li><p><a href=\"https://segmentfault.com/a/1190000008052008\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">tomcat线程池策略 - xixicat - SegmentFault</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/java-threadpool.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java ThreadPool的正确打开方式 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/tomcat-threadpool.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://threezj.com/2016/06/25/Tomcat%20%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat 架构探索 | 一派胡言</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>StringManager</p>\n<p>禁用DNS轮询，DNS的优化点？?</p>\n<p>Windows 7下安装了Cygwin，发现没有telnet这个命令。在cygwin的搜索中也找不到telnet。<br>但是经常使用telnet这个小工具。Google了一下发现包含telnet的包是 inetutils。直接安装inetutils即可。</p>\n<p>telnet localhost 8097 shutdown</p>\n<p>➜  dev which telnet<br>/usr/bin/telnet<br>➜  dev telnet localhost 8005<br>Trying 127.0.0.1…<br>Connected to localhost.<br>Escape character is ‘^]’.<br>SHUTDOWN<br>Connection closed by foreign host.</p>\n<h2 id=\"Connector\"><a href=\"#Connector\" class=\"headerlink\" title=\"Connector\"></a>Connector</h2><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\" \"></a> </h2><h2 id=\"线程池策略\"><a href=\"#线程池策略\" class=\"headerlink\" title=\"线程池策略\"></a>线程池策略</h2><p>场景1：接受一个请求，此时tomcat启动的线程数还没有达到corePoolSize(tomcat里头叫minSpareThreads)，tomcat会启动一个线程来处理该请求；<br>场景2：接受一个请求，此时tomcat启动的线程数已经达到了corePoolSize，tomcat把该请求放入队列(offer)，如果放入队列成功，则返回，放入队列不成功，则尝试增加工作线程，在当前线程个数&lt;maxThreads的时候，可以继续增加线程来处理，超过maxThreads的时候，则继续往等待队列里头放，等待队列放不进去，则抛出RejectedExecutionException；</p>\n<h2 id=\"JDK线程池策略\"><a href=\"#JDK线程池策略\" class=\"headerlink\" title=\"JDK线程池策略\"></a>JDK线程池策略</h2><p>每次提交任务时，如果线程数还没达到coreSize就创建新线程并绑定该任务。所以第coreSize次提交任务后线程总数必达到coreSize，不会重用之前的空闲线程。<br>线程数达到coreSize后，新增的任务就放到工作队列里，而线程池里的线程则努力的使用take()从工作队列里拉活来干。<br>如果队列是个有界队列，又如果线程池里的线程不能及时将任务取走，工作队列可能会满掉，插入任务就会失败，此时线程池就会紧急的再创建新的临时线程来补救。<br>临时线程使用poll(keepAliveTime，timeUnit)来从工作队列拉活，如果时候到了仍然两手空空没拉到活，表明它太闲了，就会被解雇掉。<br>如果core线程数＋临时线程数 &gt;maxSize，则不能再创建新的临时线程了，转头执行RejectExecutionHanlder。默认的AbortPolicy抛RejectedExecutionException异常，其他选择包括静默放弃当前任务(Discard)，放弃工作队列里最老的任务(DisacardOldest)，或由主线程来直接执行(CallerRuns).</p>\n<p>CachedPool则把coreSize设成0，然后选用了一种特殊的Queue – SynchronousQueue，只要当前没有空闲线程，Queue就会立刻报插入失败，让线程池增加新的临时线程，默认的KeepAliveTime是1分钟，而且maxSize是整型的最大值，也就是说只要有干不完的活，都会无限增增加线程数，直到高峰过去线程数才会回落。</p>\n<h2 id=\"console-被tomcat-重定向到-catalina-out中\"><a href=\"#console-被tomcat-重定向到-catalina-out中\" class=\"headerlink\" title=\"console 被tomcat 重定向到 catalina.out中\"></a>console 被tomcat 重定向到 catalina.out中</h2><h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p>requestProcess.pdf</p>\n<ol>\n<li><p><a href=\"http://java-latte.blogspot.kr/2014/10/introduction-to-architecture-of-apache-tomcat-with-server.xml.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java-Latte: Architecture of Apache Tomcat</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat 系统架构与设计模式，第 1 部分: 工作原理</a></p>\n</li>\n<li><p><a href=\"http://singcheong.blogspot.kr/2012/10/tomcat-shutdown-port-8005-remote.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Guidewire, SAP, Oracle, UNIX, Genesys Technology Blog: Tomcat shutdown port 8005 - Remote Shutdown</a></p>\n</li>\n<li><p><a href=\"https://segmentfault.com/a/1190000008052008\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">tomcat线程池策略 - xixicat - SegmentFault</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/java-threadpool.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java ThreadPool的正确打开方式 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/tomcat-threadpool.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://threezj.com/2016/06/25/Tomcat%20%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat 架构探索 | 一派胡言</a></p>\n</li>\n</ol>\n"},{"title":"tomcat性能调优","toc":true,"abbrlink":47881,"_content":"\n\n\n### Connector 模式\n\n### 线程池\n\n\n### \n\n## 参考\n\n1. [修改Tomcat Connector运行模式，优化Tomcat运行性能 - CodePlayer](http://www.365mini.com/page/tomcat-connector-mode.htm)\n\n2. [Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣](http://calvin1978.blogcn.com/articles/tomcat-threadpool.html)\n\n3. [配置nginx(tengine)使用ajp协议与后端tomcat通讯 - KLLSo.COM](https://www.kllso.com/article/8)\n\n4. [识别Tomcat堆栈中常见线程](http://mp.weixin.qq.com/s/yGL4YO27W51gIuIRNfCCsA)","source":"_drafts/tomcat-optimize.md","raw":"---\ntitle: tomcat性能调优\ntoc: true\ncategory: tomcat\nabbrlink: 47881\ntags:\n---\n\n\n\n### Connector 模式\n\n### 线程池\n\n\n### \n\n## 参考\n\n1. [修改Tomcat Connector运行模式，优化Tomcat运行性能 - CodePlayer](http://www.365mini.com/page/tomcat-connector-mode.htm)\n\n2. [Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣](http://calvin1978.blogcn.com/articles/tomcat-threadpool.html)\n\n3. [配置nginx(tengine)使用ajp协议与后端tomcat通讯 - KLLSo.COM](https://www.kllso.com/article/8)\n\n4. [识别Tomcat堆栈中常见线程](http://mp.weixin.qq.com/s/yGL4YO27W51gIuIRNfCCsA)","slug":"tomcat-optimize","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.381Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8c003wjh4kg48xv1xl","content":"<h3 id=\"Connector-模式\"><a href=\"#Connector-模式\" class=\"headerlink\" title=\"Connector 模式\"></a>Connector 模式</h3><h3 id=\"线程池\"><a href=\"#线程池\" class=\"headerlink\" title=\"线程池\"></a>线程池</h3><p>### </p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.365mini.com/page/tomcat-connector-mode.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">修改Tomcat Connector运行模式，优化Tomcat运行性能 - CodePlayer</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/tomcat-threadpool.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"https://www.kllso.com/article/8\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">配置nginx(tengine)使用ajp协议与后端tomcat通讯 - KLLSo.COM</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s/yGL4YO27W51gIuIRNfCCsA\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">识别Tomcat堆栈中常见线程</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"Connector-模式\"><a href=\"#Connector-模式\" class=\"headerlink\" title=\"Connector 模式\"></a>Connector 模式</h3><h3 id=\"线程池\"><a href=\"#线程池\" class=\"headerlink\" title=\"线程池\"></a>线程池</h3><p>### </p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.365mini.com/page/tomcat-connector-mode.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">修改Tomcat Connector运行模式，优化Tomcat运行性能 - CodePlayer</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/tomcat-threadpool.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"https://www.kllso.com/article/8\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">配置nginx(tengine)使用ajp协议与后端tomcat通讯 - KLLSo.COM</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s/yGL4YO27W51gIuIRNfCCsA\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">识别Tomcat堆栈中常见线程</a></p>\n</li>\n</ol>\n"},{"title":"tomcat-sci与spring boot的启动","toc":true,"_content":"\n","source":"_drafts/tomcat-sci-spring-boot.md","raw":"title: tomcat-sci与spring boot的启动\ntoc: true\ntags: sci\ncategory: tomcat\n---\n\n","slug":"tomcat-sci-spring-boot","published":0,"date":"2018-04-07T13:08:47.914Z","updated":"2018-04-07T13:08:47.914Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8d003yjh4k5kbtz1ne","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"并查集总结","toc":true,"_content":"\n# 什么是并查集\n\n用来表示不相交集合的数据结构\n\n代表:\n\n## 可以解决的问题\n\n### 无向图的连通分量\n\n\n\n## 支持的操作\n\n### 创建\n\nMAKE-SET(x) : 建立一个新的集合，它的唯一成员是x\n\n### 查找\n\nFIND-SET(x) : 返回包含x的唯一集合的代表\n\n### 合并\n\nUNION(x, y) : 合并两个集合成一个新的集合\n\n## 存储用的数据结构\n\n### 链表\n\n### 有根树\n\n树中每个结点包含一个成员， 每颗树代表一个集合， 最终构成一个不相交集合森里（disjoint-set forest)。\n每个成员仅指向它的的父结点。\n\n\n# 并查集优化\n\n加权合并启发式策略（weighted-union heuristic）\n\n\n\n## 按秩合并（union by rank）\n\nx.rank : x高度的上界（从x到某一后代叶结点的最长简单路径上边的数目）\n\n策略： 让较大秩的根成为较小秩的根的父结点\n\n## 路径压缩（path compression）\n\n\n# 练习\n\n\n# 参考\n\n","source":"_drafts/union-find.md","raw":"title: 并查集总结\ntoc: true\ntags: union-find\ncategory: algorithm\n---\n\n# 什么是并查集\n\n用来表示不相交集合的数据结构\n\n代表:\n\n## 可以解决的问题\n\n### 无向图的连通分量\n\n\n\n## 支持的操作\n\n### 创建\n\nMAKE-SET(x) : 建立一个新的集合，它的唯一成员是x\n\n### 查找\n\nFIND-SET(x) : 返回包含x的唯一集合的代表\n\n### 合并\n\nUNION(x, y) : 合并两个集合成一个新的集合\n\n## 存储用的数据结构\n\n### 链表\n\n### 有根树\n\n树中每个结点包含一个成员， 每颗树代表一个集合， 最终构成一个不相交集合森里（disjoint-set forest)。\n每个成员仅指向它的的父结点。\n\n\n# 并查集优化\n\n加权合并启发式策略（weighted-union heuristic）\n\n\n\n## 按秩合并（union by rank）\n\nx.rank : x高度的上界（从x到某一后代叶结点的最长简单路径上边的数目）\n\n策略： 让较大秩的根成为较小秩的根的父结点\n\n## 路径压缩（path compression）\n\n\n# 练习\n\n\n# 参考\n\n","slug":"union-find","published":0,"date":"2018-04-15T02:55:48.026Z","updated":"2018-04-15T02:55:48.026Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8e0041jh4ktpcr1r3m","content":"<h1 id=\"什么是并查集\"><a href=\"#什么是并查集\" class=\"headerlink\" title=\"什么是并查集\"></a>什么是并查集</h1><p>用来表示不相交集合的数据结构</p>\n<p>代表:</p>\n<h2 id=\"可以解决的问题\"><a href=\"#可以解决的问题\" class=\"headerlink\" title=\"可以解决的问题\"></a>可以解决的问题</h2><h3 id=\"无向图的连通分量\"><a href=\"#无向图的连通分量\" class=\"headerlink\" title=\"无向图的连通分量\"></a>无向图的连通分量</h3><h2 id=\"支持的操作\"><a href=\"#支持的操作\" class=\"headerlink\" title=\"支持的操作\"></a>支持的操作</h2><h3 id=\"创建\"><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h3><p>MAKE-SET(x) : 建立一个新的集合，它的唯一成员是x</p>\n<h3 id=\"查找\"><a href=\"#查找\" class=\"headerlink\" title=\"查找\"></a>查找</h3><p>FIND-SET(x) : 返回包含x的唯一集合的代表</p>\n<h3 id=\"合并\"><a href=\"#合并\" class=\"headerlink\" title=\"合并\"></a>合并</h3><p>UNION(x, y) : 合并两个集合成一个新的集合</p>\n<h2 id=\"存储用的数据结构\"><a href=\"#存储用的数据结构\" class=\"headerlink\" title=\"存储用的数据结构\"></a>存储用的数据结构</h2><h3 id=\"链表\"><a href=\"#链表\" class=\"headerlink\" title=\"链表\"></a>链表</h3><h3 id=\"有根树\"><a href=\"#有根树\" class=\"headerlink\" title=\"有根树\"></a>有根树</h3><p>树中每个结点包含一个成员， 每颗树代表一个集合， 最终构成一个不相交集合森里（disjoint-set forest)。<br>每个成员仅指向它的的父结点。</p>\n<h1 id=\"并查集优化\"><a href=\"#并查集优化\" class=\"headerlink\" title=\"并查集优化\"></a>并查集优化</h1><p>加权合并启发式策略（weighted-union heuristic）</p>\n<h2 id=\"按秩合并（union-by-rank）\"><a href=\"#按秩合并（union-by-rank）\" class=\"headerlink\" title=\"按秩合并（union by rank）\"></a>按秩合并（union by rank）</h2><p>x.rank : x高度的上界（从x到某一后代叶结点的最长简单路径上边的数目）</p>\n<p>策略： 让较大秩的根成为较小秩的根的父结点</p>\n<h2 id=\"路径压缩（path-compression）\"><a href=\"#路径压缩（path-compression）\" class=\"headerlink\" title=\"路径压缩（path compression）\"></a>路径压缩（path compression）</h2><h1 id=\"练习\"><a href=\"#练习\" class=\"headerlink\" title=\"练习\"></a>练习</h1><h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1>","site":{"data":{}},"excerpt":"","more":"<h1 id=\"什么是并查集\"><a href=\"#什么是并查集\" class=\"headerlink\" title=\"什么是并查集\"></a>什么是并查集</h1><p>用来表示不相交集合的数据结构</p>\n<p>代表:</p>\n<h2 id=\"可以解决的问题\"><a href=\"#可以解决的问题\" class=\"headerlink\" title=\"可以解决的问题\"></a>可以解决的问题</h2><h3 id=\"无向图的连通分量\"><a href=\"#无向图的连通分量\" class=\"headerlink\" title=\"无向图的连通分量\"></a>无向图的连通分量</h3><h2 id=\"支持的操作\"><a href=\"#支持的操作\" class=\"headerlink\" title=\"支持的操作\"></a>支持的操作</h2><h3 id=\"创建\"><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h3><p>MAKE-SET(x) : 建立一个新的集合，它的唯一成员是x</p>\n<h3 id=\"查找\"><a href=\"#查找\" class=\"headerlink\" title=\"查找\"></a>查找</h3><p>FIND-SET(x) : 返回包含x的唯一集合的代表</p>\n<h3 id=\"合并\"><a href=\"#合并\" class=\"headerlink\" title=\"合并\"></a>合并</h3><p>UNION(x, y) : 合并两个集合成一个新的集合</p>\n<h2 id=\"存储用的数据结构\"><a href=\"#存储用的数据结构\" class=\"headerlink\" title=\"存储用的数据结构\"></a>存储用的数据结构</h2><h3 id=\"链表\"><a href=\"#链表\" class=\"headerlink\" title=\"链表\"></a>链表</h3><h3 id=\"有根树\"><a href=\"#有根树\" class=\"headerlink\" title=\"有根树\"></a>有根树</h3><p>树中每个结点包含一个成员， 每颗树代表一个集合， 最终构成一个不相交集合森里（disjoint-set forest)。<br>每个成员仅指向它的的父结点。</p>\n<h1 id=\"并查集优化\"><a href=\"#并查集优化\" class=\"headerlink\" title=\"并查集优化\"></a>并查集优化</h1><p>加权合并启发式策略（weighted-union heuristic）</p>\n<h2 id=\"按秩合并（union-by-rank）\"><a href=\"#按秩合并（union-by-rank）\" class=\"headerlink\" title=\"按秩合并（union by rank）\"></a>按秩合并（union by rank）</h2><p>x.rank : x高度的上界（从x到某一后代叶结点的最长简单路径上边的数目）</p>\n<p>策略： 让较大秩的根成为较小秩的根的父结点</p>\n<h2 id=\"路径压缩（path-compression）\"><a href=\"#路径压缩（path-compression）\" class=\"headerlink\" title=\"路径压缩（path compression）\"></a>路径压缩（path compression）</h2><h1 id=\"练习\"><a href=\"#练习\" class=\"headerlink\" title=\"练习\"></a>练习</h1><h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1>"},{"title":"vim","toc":true,"abbrlink":26382,"category":null,"_content":"\n\n\n","source":"_drafts/vim.md","raw":"---\ntitle: vim\ntoc: true\nabbrlink: 26382\ntags:\ncategory:\n---\n\n\n\n","slug":"vim","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.381Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8f0043jh4kq6sonjld","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"zookeeper","toc":true,"abbrlink":48434,"category":null,"_content":"\n\nhttp://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper-code/","source":"_drafts/zookeeper.md","raw":"---\ntitle: zookeeper\ntoc: true\nabbrlink: 48434\ntags:\ncategory:\n---\n\n\nhttp://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper-code/","slug":"zookeeper","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:03:23.381Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8g0047jh4k5ixwnei0","content":"<p><a href=\"http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper-code/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper-code/</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper-code/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper-code/</a></p>\n"},{"title":"windows命令操作剪贴板——CLIP","toc":true,"abbrlink":32267,"date":"2017-01-07T12:00:09.000Z","_content":"\n## 使用说明\n\n> CLIP\n\n> Description:\n    Redirects output of command line tools to the Windows clipboard.\n    This text output can then be pasted into other programs.\n\n> Parameter List:\n    /?                  Displays this help message.\n\n> Examples:\n    DIR | CLIP          Places a copy of the current directory\n                        listing into the Windows clipboard.\n\n>    CLIP < README.TXT   Places a copy of the text from readme.txt\n                        on to the Windows clipboard.\n\n## 简单应用\n\n### 将ip地址拷贝到剪贴板\n\n```bash\nipconfig | find \"IPv4\" | find /V \"自动\"  | find /V \"Auto\" | awk \"{ print $(NF);}\" | CLIP\n```\n\n也可以添加一个alias，这样就不用每次敲`ipconfig`, 然后复制ip了\n\n## 参考\n\n1. [Fastest method to determine my PC's IP address (Windows) - Super User](http://superuser.com/questions/382265/fastest-method-to-determine-my-pcs-ip-address-windows)","source":"_posts/CLIP.md","raw":"---\ntitle: windows命令操作剪贴板——CLIP\ntoc: true\ntags: 剪贴板\ncategory: shell\nabbrlink: 32267\ndate: 2017-01-07 20:00:09\n---\n\n## 使用说明\n\n> CLIP\n\n> Description:\n    Redirects output of command line tools to the Windows clipboard.\n    This text output can then be pasted into other programs.\n\n> Parameter List:\n    /?                  Displays this help message.\n\n> Examples:\n    DIR | CLIP          Places a copy of the current directory\n                        listing into the Windows clipboard.\n\n>    CLIP < README.TXT   Places a copy of the text from readme.txt\n                        on to the Windows clipboard.\n\n## 简单应用\n\n### 将ip地址拷贝到剪贴板\n\n```bash\nipconfig | find \"IPv4\" | find /V \"自动\"  | find /V \"Auto\" | awk \"{ print $(NF);}\" | CLIP\n```\n\n也可以添加一个alias，这样就不用每次敲`ipconfig`, 然后复制ip了\n\n## 参考\n\n1. [Fastest method to determine my PC's IP address (Windows) - Super User](http://superuser.com/questions/382265/fastest-method-to-determine-my-pcs-ip-address-windows)","slug":"CLIP","published":1,"updated":"2017-04-16T12:03:23.381Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8h0048jh4k1o2dp6os","content":"<h2 id=\"使用说明\"><a href=\"#使用说明\" class=\"headerlink\" title=\"使用说明\"></a>使用说明</h2><blockquote>\n<p>CLIP</p>\n<p>Description:<br>    Redirects output of command line tools to the Windows clipboard.<br>    This text output can then be pasted into other programs.</p>\n<p>Parameter List:<br>    /?                  Displays this help message.</p>\n<p>Examples:<br>    DIR | CLIP          Places a copy of the current directory<br>                        listing into the Windows clipboard.</p>\n<p>   CLIP &lt; README.TXT   Places a copy of the text from readme.txt<br>                        on to the Windows clipboard.</p>\n</blockquote>\n<h2 id=\"简单应用\"><a href=\"#简单应用\" class=\"headerlink\" title=\"简单应用\"></a>简单应用</h2><h3 id=\"将ip地址拷贝到剪贴板\"><a href=\"#将ip地址拷贝到剪贴板\" class=\"headerlink\" title=\"将ip地址拷贝到剪贴板\"></a>将ip地址拷贝到剪贴板</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipconfig | find <span class=\"string\">\"IPv4\"</span> | find /V <span class=\"string\">\"自动\"</span>  | find /V <span class=\"string\">\"Auto\"</span> | awk <span class=\"string\">\"&#123; print <span class=\"variable\">$(NF)</span>;&#125;\"</span> | CLIP</span><br></pre></td></tr></table></figure>\n<p>也可以添加一个alias，这样就不用每次敲<code>ipconfig</code>, 然后复制ip了</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://superuser.com/questions/382265/fastest-method-to-determine-my-pcs-ip-address-windows\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Fastest method to determine my PC’s IP address (Windows) - Super User</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"使用说明\"><a href=\"#使用说明\" class=\"headerlink\" title=\"使用说明\"></a>使用说明</h2><blockquote>\n<p>CLIP</p>\n<p>Description:<br>    Redirects output of command line tools to the Windows clipboard.<br>    This text output can then be pasted into other programs.</p>\n<p>Parameter List:<br>    /?                  Displays this help message.</p>\n<p>Examples:<br>    DIR | CLIP          Places a copy of the current directory<br>                        listing into the Windows clipboard.</p>\n<p>   CLIP &lt; README.TXT   Places a copy of the text from readme.txt<br>                        on to the Windows clipboard.</p>\n</blockquote>\n<h2 id=\"简单应用\"><a href=\"#简单应用\" class=\"headerlink\" title=\"简单应用\"></a>简单应用</h2><h3 id=\"将ip地址拷贝到剪贴板\"><a href=\"#将ip地址拷贝到剪贴板\" class=\"headerlink\" title=\"将ip地址拷贝到剪贴板\"></a>将ip地址拷贝到剪贴板</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipconfig | find <span class=\"string\">\"IPv4\"</span> | find /V <span class=\"string\">\"自动\"</span>  | find /V <span class=\"string\">\"Auto\"</span> | awk <span class=\"string\">\"&#123; print <span class=\"variable\">$(NF)</span>;&#125;\"</span> | CLIP</span><br></pre></td></tr></table></figure>\n<p>也可以添加一个alias，这样就不用每次敲<code>ipconfig</code>, 然后复制ip了</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://superuser.com/questions/382265/fastest-method-to-determine-my-pcs-ip-address-windows\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Fastest method to determine my PC’s IP address (Windows) - Super User</a></li>\n</ol>\n"},{"title":"MAT-Ubuntu无法打开Report","toc":true,"date":"2017-11-12T10:57:04.000Z","_content":"\n\n## 现象\n\n可以运行`Leak Suspects`，可以看到报告文件确实生成了，但是无法打开，看error log如下:\n\n```\nUnhandled event loop exception\n\norg.eclipse.swt.SWTException: Failed to execute runnable (org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet])\n\tat org.eclipse.swt.SWT.error(SWT.java:4491)\n\tat org.eclipse.swt.SWT.error(SWT.java:4406)\n\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:138)\n\tat org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3794)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3433)\n\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$4.run(PartRenderingEngine.java:1127)\n\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)\n\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.run(PartRenderingEngine.java:1018)\n\tat org.eclipse.e4.ui.internal.workbench.E4Workbench.createAndRunUI(E4Workbench.java:156)\n\tat org.eclipse.ui.internal.Workbench$5.run(Workbench.java:694)\n\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:606)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:150)\n\tat org.eclipse.mat.ui.rcp.Application.start(Application.java:26)\n\tat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:134)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:104)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:380)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:235)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:669)\n\tat org.eclipse.equinox.launcher.Main.basicRun(Main.java:608)\n\tat org.eclipse.equinox.launcher.Main.run(Main.java:1515)\n\tat org.eclipse.equinox.launcher.Main.main(Main.java:1488)\nCaused by: org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet]\n\tat org.eclipse.swt.SWT.error(SWT.java:4517)\n\tat org.eclipse.swt.browser.MozillaDelegate.<init>(MozillaDelegate.java:57)\n\tat org.eclipse.swt.browser.Mozilla.create(Mozilla.java:663)\n\tat org.eclipse.swt.browser.Browser.<init>(Browser.java:99)\n\tat org.eclipse.mat.ui.internal.panes.QueryTextResultPane.createPartControl(QueryTextResultPane.java:72)\n\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:585)\n\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:574)\n\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addNewPage(MultiPaneEditor.java:496)\n\tat org.eclipse.mat.ui.QueryExecution.doDisplayResult(QueryExecution.java:300)\n\tat org.eclipse.mat.ui.QueryExecution.access$0(QueryExecution.java:240)\n\tat org.eclipse.mat.ui.QueryExecution$1.run(QueryExecution.java:144)\n\tat org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)\n\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)\n\t... 24 more\n```\n\n## 解决方案\n\n这个是`gtk`的问题。\n\n添加`--launcher.GTK_version`和`2`到`MemoryAnalyzer.ini`文件中\n\n```\n-startup\nplugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar\n--launcher.library\nplugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.1.300.v20150602-1417\n--launcher.GTK_version\n2\n-vmargs\n-Xmx1024m\n```\n\n## 参考\n\n1. [Eclipse not working in 16.04 - Ask Ubuntu](https://askubuntu.com/questions/761604/eclipse-not-working-in-16-04)","source":"_posts/MAT-Ubuntu.md","raw":"title: MAT-Ubuntu无法打开Report\ntags: mat\ncategory: java\ntoc: true\ndate: 2017-11-12 18:57:04\n---\n\n\n## 现象\n\n可以运行`Leak Suspects`，可以看到报告文件确实生成了，但是无法打开，看error log如下:\n\n```\nUnhandled event loop exception\n\norg.eclipse.swt.SWTException: Failed to execute runnable (org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet])\n\tat org.eclipse.swt.SWT.error(SWT.java:4491)\n\tat org.eclipse.swt.SWT.error(SWT.java:4406)\n\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:138)\n\tat org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3794)\n\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3433)\n\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$4.run(PartRenderingEngine.java:1127)\n\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)\n\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.run(PartRenderingEngine.java:1018)\n\tat org.eclipse.e4.ui.internal.workbench.E4Workbench.createAndRunUI(E4Workbench.java:156)\n\tat org.eclipse.ui.internal.Workbench$5.run(Workbench.java:694)\n\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)\n\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:606)\n\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:150)\n\tat org.eclipse.mat.ui.rcp.Application.start(Application.java:26)\n\tat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:134)\n\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:104)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:380)\n\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:235)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:669)\n\tat org.eclipse.equinox.launcher.Main.basicRun(Main.java:608)\n\tat org.eclipse.equinox.launcher.Main.run(Main.java:1515)\n\tat org.eclipse.equinox.launcher.Main.main(Main.java:1488)\nCaused by: org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet]\n\tat org.eclipse.swt.SWT.error(SWT.java:4517)\n\tat org.eclipse.swt.browser.MozillaDelegate.<init>(MozillaDelegate.java:57)\n\tat org.eclipse.swt.browser.Mozilla.create(Mozilla.java:663)\n\tat org.eclipse.swt.browser.Browser.<init>(Browser.java:99)\n\tat org.eclipse.mat.ui.internal.panes.QueryTextResultPane.createPartControl(QueryTextResultPane.java:72)\n\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:585)\n\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:574)\n\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addNewPage(MultiPaneEditor.java:496)\n\tat org.eclipse.mat.ui.QueryExecution.doDisplayResult(QueryExecution.java:300)\n\tat org.eclipse.mat.ui.QueryExecution.access$0(QueryExecution.java:240)\n\tat org.eclipse.mat.ui.QueryExecution$1.run(QueryExecution.java:144)\n\tat org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)\n\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)\n\t... 24 more\n```\n\n## 解决方案\n\n这个是`gtk`的问题。\n\n添加`--launcher.GTK_version`和`2`到`MemoryAnalyzer.ini`文件中\n\n```\n-startup\nplugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar\n--launcher.library\nplugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.1.300.v20150602-1417\n--launcher.GTK_version\n2\n-vmargs\n-Xmx1024m\n```\n\n## 参考\n\n1. [Eclipse not working in 16.04 - Ask Ubuntu](https://askubuntu.com/questions/761604/eclipse-not-working-in-16-04)","slug":"MAT-Ubuntu","published":1,"updated":"2017-11-12T10:57:04.412Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8j004djh4kr4qfo9fn","content":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>可以运行<code>Leak Suspects</code>，可以看到报告文件确实生成了，但是无法打开，看error log如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Unhandled event loop exception</span><br><span class=\"line\"></span><br><span class=\"line\">org.eclipse.swt.SWTException: Failed to execute runnable (org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet])</span><br><span class=\"line\">\tat org.eclipse.swt.SWT.error(SWT.java:4491)</span><br><span class=\"line\">\tat org.eclipse.swt.SWT.error(SWT.java:4406)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:138)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3794)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3433)</span><br><span class=\"line\">\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$4.run(PartRenderingEngine.java:1127)</span><br><span class=\"line\">\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)</span><br><span class=\"line\">\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.run(PartRenderingEngine.java:1018)</span><br><span class=\"line\">\tat org.eclipse.e4.ui.internal.workbench.E4Workbench.createAndRunUI(E4Workbench.java:156)</span><br><span class=\"line\">\tat org.eclipse.ui.internal.Workbench$5.run(Workbench.java:694)</span><br><span class=\"line\">\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)</span><br><span class=\"line\">\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:606)</span><br><span class=\"line\">\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:150)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.rcp.Application.start(Application.java:26)</span><br><span class=\"line\">\tat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:134)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:104)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:380)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:235)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:669)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.basicRun(Main.java:608)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.run(Main.java:1515)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.main(Main.java:1488)</span><br><span class=\"line\">Caused by: org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet]</span><br><span class=\"line\">\tat org.eclipse.swt.SWT.error(SWT.java:4517)</span><br><span class=\"line\">\tat org.eclipse.swt.browser.MozillaDelegate.&lt;init&gt;(MozillaDelegate.java:57)</span><br><span class=\"line\">\tat org.eclipse.swt.browser.Mozilla.create(Mozilla.java:663)</span><br><span class=\"line\">\tat org.eclipse.swt.browser.Browser.&lt;init&gt;(Browser.java:99)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.internal.panes.QueryTextResultPane.createPartControl(QueryTextResultPane.java:72)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:585)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:574)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addNewPage(MultiPaneEditor.java:496)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.QueryExecution.doDisplayResult(QueryExecution.java:300)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.QueryExecution.access$0(QueryExecution.java:240)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.QueryExecution$1.run(QueryExecution.java:144)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)</span><br><span class=\"line\">\t... 24 more</span><br></pre></td></tr></table></figure>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>这个是<code>gtk</code>的问题。</p>\n<p>添加<code>--launcher.GTK_version</code>和<code>2</code>到<code>MemoryAnalyzer.ini</code>文件中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-startup</span><br><span class=\"line\">plugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar</span><br><span class=\"line\">--launcher.library</span><br><span class=\"line\">plugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.1.300.v20150602-1417</span><br><span class=\"line\">--launcher.GTK_version</span><br><span class=\"line\">2</span><br><span class=\"line\">-vmargs</span><br><span class=\"line\">-Xmx1024m</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://askubuntu.com/questions/761604/eclipse-not-working-in-16-04\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Eclipse not working in 16.04 - Ask Ubuntu</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>可以运行<code>Leak Suspects</code>，可以看到报告文件确实生成了，但是无法打开，看error log如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Unhandled event loop exception</span><br><span class=\"line\"></span><br><span class=\"line\">org.eclipse.swt.SWTException: Failed to execute runnable (org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet])</span><br><span class=\"line\">\tat org.eclipse.swt.SWT.error(SWT.java:4491)</span><br><span class=\"line\">\tat org.eclipse.swt.SWT.error(SWT.java:4406)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:138)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:3794)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3433)</span><br><span class=\"line\">\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$4.run(PartRenderingEngine.java:1127)</span><br><span class=\"line\">\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)</span><br><span class=\"line\">\tat org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.run(PartRenderingEngine.java:1018)</span><br><span class=\"line\">\tat org.eclipse.e4.ui.internal.workbench.E4Workbench.createAndRunUI(E4Workbench.java:156)</span><br><span class=\"line\">\tat org.eclipse.ui.internal.Workbench$5.run(Workbench.java:694)</span><br><span class=\"line\">\tat org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:337)</span><br><span class=\"line\">\tat org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:606)</span><br><span class=\"line\">\tat org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:150)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.rcp.Application.start(Application.java:26)</span><br><span class=\"line\">\tat org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:134)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:104)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:380)</span><br><span class=\"line\">\tat org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:235)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:669)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.basicRun(Main.java:608)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.run(Main.java:1515)</span><br><span class=\"line\">\tat org.eclipse.equinox.launcher.Main.main(Main.java:1488)</span><br><span class=\"line\">Caused by: org.eclipse.swt.SWTError: No more handles [Browser style SWT.MOZILLA and Java system property org.eclipse.swt.browser.DefaultType=mozilla are not supported with GTK 3 as XULRunner is not ported for GTK 3 yet]</span><br><span class=\"line\">\tat org.eclipse.swt.SWT.error(SWT.java:4517)</span><br><span class=\"line\">\tat org.eclipse.swt.browser.MozillaDelegate.&lt;init&gt;(MozillaDelegate.java:57)</span><br><span class=\"line\">\tat org.eclipse.swt.browser.Mozilla.create(Mozilla.java:663)</span><br><span class=\"line\">\tat org.eclipse.swt.browser.Browser.&lt;init&gt;(Browser.java:99)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.internal.panes.QueryTextResultPane.createPartControl(QueryTextResultPane.java:72)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:585)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addPage(MultiPaneEditor.java:574)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.editor.MultiPaneEditor.addNewPage(MultiPaneEditor.java:496)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.QueryExecution.doDisplayResult(QueryExecution.java:300)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.QueryExecution.access$0(QueryExecution.java:240)</span><br><span class=\"line\">\tat org.eclipse.mat.ui.QueryExecution$1.run(QueryExecution.java:144)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)</span><br><span class=\"line\">\tat org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)</span><br><span class=\"line\">\t... 24 more</span><br></pre></td></tr></table></figure>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>这个是<code>gtk</code>的问题。</p>\n<p>添加<code>--launcher.GTK_version</code>和<code>2</code>到<code>MemoryAnalyzer.ini</code>文件中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-startup</span><br><span class=\"line\">plugins/org.eclipse.equinox.launcher_1.3.100.v20150511-1540.jar</span><br><span class=\"line\">--launcher.library</span><br><span class=\"line\">plugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.1.300.v20150602-1417</span><br><span class=\"line\">--launcher.GTK_version</span><br><span class=\"line\">2</span><br><span class=\"line\">-vmargs</span><br><span class=\"line\">-Xmx1024m</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://askubuntu.com/questions/761604/eclipse-not-working-in-16-04\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Eclipse not working in 16.04 - Ask Ubuntu</a></li>\n</ol>\n"},{"title":"HttpMessageConverter 原理和源码","toc":true,"abbrlink":"55451865","date":"2016-11-28T18:48:45.000Z","_content":"\n## 架构\n{%  asset_img   arch.jpg  %}\n\n\n\n\n## HttpMessageConverter接口\n\n\n\n{%  asset_img http-message-converter.jpg    )\n\n\n\n\n>`HttpMessageConverter` used to\nmarshal objects into the HTTP request body and to unmarshal any response back into an object.\n\n提供将Java中的对象和http请求、响应相互转换的功能\n\n### spring 中的配置\n\nxml配置示例：\n\n```xml\n<mvc:annotation-driven conversion-service=\"conversionService\">\n    <mvc:message-converters>\n        <bean class=\"org.springframework.http.converter.StringHttpMessageConverter\"/>\n        <bean class=\"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter\">\n            <property name=\"objectMapper\" ref=\"jsonObjectMapper\"/>\n        </bean>\n    </mvc:message-converters>\n</mvc:annotation-driven>\n```\n\njava配置示例：\n\n```java\n@Configuration\npublic class WebConfig extends DelegatingWebMvcConfiguration {\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry){\n    // ...\n    }\n\n    @Override\n    @Bean\n    public RequestMappingHandlerAdapter requestMappingHandlerAdapter() {\n    // Create or let \"super\" create the adapter\n    // Then customize one of its properties\n    }\n}\n```\n\n### 接口描述\n```java\npackage org.springframework.http.converter;\n\nimport java.io.IOException;\nimport java.util.List;\n\nimport org.springframework.http.HttpInputMessage;\nimport org.springframework.http.HttpOutputMessage;\nimport org.springframework.http.MediaType;\n\n/**\n * Strategy interface that specifies a converter that can convert from and to HTTP requests and responses.\n *\n * @author Arjen Poutsma\n * @author Juergen Hoeller\n * @since 3.0\n */\npublic interface HttpMessageConverter<T> {\n\n\t/**\n\t * Indicates whether the given class can be read by this converter.\n\t * @param clazz the class to test for readability\n\t * @param mediaType the media type to read, can be {@code null} if not specified.\n\t * Typically the value of a {@code Content-Type} header.\n\t * @return {@code true} if readable; {@code false} otherwise\n\t */\n\tboolean canRead(Class<?> clazz, MediaType mediaType);\n\n\t/**\n\t * Indicates whether the given class can be written by this converter.\n\t * @param clazz the class to test for writability\n\t * @param mediaType the media type to write, can be {@code null} if not specified.\n\t * Typically the value of an {@code Accept} header.\n\t * @return {@code true} if writable; {@code false} otherwise\n\t */\n\tboolean canWrite(Class<?> clazz, MediaType mediaType);\n\n\t/**\n\t * Return the list of {@link MediaType} objects supported by this converter.\n\t * @return the list of supported media types\n\t */\n\tList<MediaType> getSupportedMediaTypes();\n\n\t/**\n\t * Read an object of the given type form the given input message, and returns it.\n\t * @param clazz the type of object to return. This type must have previously been passed to the\n\t * {@link #canRead canRead} method of this interface, which must have returned {@code true}.\n\t * @param inputMessage the HTTP input message to read from\n\t * @return the converted object\n\t * @throws IOException in case of I/O errors\n\t * @throws HttpMessageNotReadableException in case of conversion errors\n\t */\n\tT read(Class<? extends T> clazz, HttpInputMessage inputMessage)\n\t\t\tthrows IOException, HttpMessageNotReadableException;\n\n\t/**\n\t * Write an given object to the given output message.\n\t * @param t the object to write to the output message. The type of this object must have previously been\n\t * passed to the {@link #canWrite canWrite} method of this interface, which must have returned {@code true}.\n\t * @param contentType the content type to use when writing. May be {@code null} to indicate that the\n\t * default content type of the converter must be used. If not {@code null}, this media type must have\n\t * previously been passed to the {@link #canWrite canWrite} method of this interface, which must have\n\t * returned {@code true}.\n\t * @param outputMessage the message to write to\n\t * @throws IOException in case of I/O errors\n\t * @throws HttpMessageNotWritableException in case of conversion errors\n\t */\n\tvoid write(T t, MediaType contentType, HttpOutputMessage outputMessage)\n\t\t\tthrows IOException, HttpMessageNotWritableException;\n\n}\n\n```\n\n### spring 提供的实现类\n\n{%  asset_img   inherit.jpg  %}\n\n\n\n\n|名称|\n|---|\n|ByteArrayHttpMessageConverter|\n|FormHttpMessageConverter|\n|XmlAwareFormHttpMessageConverter|\n|ResourceHttpMessageConverter|\n|SourceHttpMessageConverter|\n|StringHttpMessageConverter|\n|SimpleXmlHttpMessageConverter|\n|MappingJackson2HttpMessageConverter|\n|GsonHttpMessageConverter|\n|SyndFeedHttpMessageConverter|\n|RssChannelHttpMessageConverter|\n|AtomFeedHttpMessageConverter|\n\n具体功能见 [RestTemplate Module](http://docs.spring.io/autorepo/docs/spring-android/1.0.x/reference/html/rest-template.html)\n\n想研究源码的可以从最简单的 `StringHttpMessageConverter`看起\n\n## Spring调用过程\n\n在DispatcherServlet初始化的过程会调用一个叫做`initHandlerAdapters`的方法，\n该方法内部会扫描容器中所有的类，以及他们的父类，找到所有实现了`HandlerAdapter`接口的类，\n并将他们注册到`DispatcherServlet`的`HandlerAdapters`中。\n\n\n如果没有扫描到的HandlerAdapter，这个方法会加载一些默认的HandlerAdapter。\n\n> The default implementation uses the \"DispatcherServlet.properties\" file (in the same\n  package as the DispatcherServlet class) to determine the class names. \n\n  {%  asset_img   DispatcherServlet-properties.jpg  %}\n\n\n\n\nSpring 4.3.2 中有一个实现了`HandlerAdapter`接口的类会被扫描到，这个类叫做`RequestMappingHandlerAdapter`\n\n### RequestMappingHandlerAdapter\n这个类在构造的时候就加载了许多messageConverter\n\n```java\n    public RequestMappingHandlerAdapter() {\n        StringHttpMessageConverter stringHttpMessageConverter = new StringHttpMessageConverter();\n        stringHttpMessageConverter.setWriteAcceptCharset(false);  // see SPR-7316\n\n        this.messageConverters = new ArrayList<HttpMessageConverter<?>>(4);\n        this.messageConverters.add(new ByteArrayHttpMessageConverter());\n        this.messageConverters.add(stringHttpMessageConverter);\n        this.messageConverters.add(new SourceHttpMessageConverter<Source>());\n        this.messageConverters.add(new AllEncompassingFormHttpMessageConverter());\n    }\n```\n其中`AllEncompassingFormHttpMessageConverter`继承自`FormHttpMessageConverter`， 它有一个变量叫做\n`partConverters`，存储了一系列的`HttpMessageConverter`\n```java\n    private List<HttpMessageConverter<?>> partConverters = new ArrayList<HttpMessageConverter<?>>();\n    public FormHttpMessageConverter() {\n        this.supportedMediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);\n        this.supportedMediaTypes.add(MediaType.MULTIPART_FORM_DATA);\n        this.partConverters.add(new ByteArrayHttpMessageConverter());\n        StringHttpMessageConverter stringHttpMessageConverter = new StringHttpMessageConverter();\n        stringHttpMessageConverter.setWriteAcceptCharset(false);\n        this.partConverters.add(stringHttpMessageConverter);\n        this.partConverters.add(new ResourceHttpMessageConverter());\n    }\n```\n在`AllEncompassingFormHttpMessageConverter`中又根据classPath中是否包含jackson、Gson等jar包来动态的\n注册了一些`HttpMessageConverter`:\n\n```java\npublic class AllEncompassingFormHttpMessageConverter extends FormHttpMessageConverter {\n\n    private static final boolean jaxb2Present =\n            ClassUtils.isPresent(\"javax.xml.bind.Binder\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n    private static final boolean jackson2Present =\n            ClassUtils.isPresent(\"com.fasterxml.jackson.databind.ObjectMapper\", AllEncompassingFormHttpMessageConverter.class.getClassLoader()) &&\n                    ClassUtils.isPresent(\"com.fasterxml.jackson.core.JsonGenerator\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n    private static final boolean jackson2XmlPresent =\n            ClassUtils.isPresent(\"com.fasterxml.jackson.dataformat.xml.XmlMapper\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n    private static final boolean gsonPresent =\n            ClassUtils.isPresent(\"com.google.gson.Gson\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n\n    public AllEncompassingFormHttpMessageConverter() {\n        addPartConverter(new SourceHttpMessageConverter<Source>());\n\n        if (jaxb2Present && !jackson2Present) {\n            addPartConverter(new Jaxb2RootElementHttpMessageConverter());\n        }\n\n        if (jackson2Present) {\n            addPartConverter(new MappingJackson2HttpMessageConverter());\n        }\n        else if (gsonPresent) {\n            addPartConverter(new GsonHttpMessageConverter());\n        }\n\n        if (jackson2XmlPresent) {\n            addPartConverter(new MappingJackson2XmlHttpMessageConverter());\n        }\n    }\n\n}\n```\n\n至于这些转换器是怎么使用的，要看`RequestMappingHandlerAdapter`中的`getDefaultArgumentResolver`\n\n```java\n/**\n     * Return the list of argument resolvers to use including built-in resolvers\n     * and custom resolvers provided via {@link #setCustomArgumentResolvers}.\n     */\n    private List<HandlerMethodArgumentResolver> getDefaultArgumentResolvers() {\n        List<HandlerMethodArgumentResolver> resolvers = new ArrayList<HandlerMethodArgumentResolver>();\n\n        // Annotation-based argument resolution\n        resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false));\n        resolvers.add(new RequestParamMapMethodArgumentResolver());\n        resolvers.add(new PathVariableMethodArgumentResolver());\n        resolvers.add(new PathVariableMapMethodArgumentResolver());\n        resolvers.add(new MatrixVariableMethodArgumentResolver());\n        resolvers.add(new MatrixVariableMapMethodArgumentResolver());\n        resolvers.add(new ServletModelAttributeMethodProcessor(false));\n        resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice));\n        resolvers.add(new RequestPartMethodArgumentResolver(getMessageConverters(), this.requestResponseBodyAdvice));\n        resolvers.add(new RequestHeaderMethodArgumentResolver(getBeanFactory()));\n        resolvers.add(new RequestHeaderMapMethodArgumentResolver());\n        resolvers.add(new ServletCookieValueMethodArgumentResolver(getBeanFactory()));\n        resolvers.add(new ExpressionValueMethodArgumentResolver(getBeanFactory()));\n\n        // Type-based argument resolution\n        resolvers.add(new ServletRequestMethodArgumentResolver());\n        resolvers.add(new ServletResponseMethodArgumentResolver());\n        resolvers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice));\n        resolvers.add(new RedirectAttributesMethodArgumentResolver());\n        resolvers.add(new ModelMethodProcessor());\n        resolvers.add(new MapMethodProcessor());\n        resolvers.add(new ErrorsMethodArgumentResolver());\n        resolvers.add(new SessionStatusMethodArgumentResolver());\n        resolvers.add(new UriComponentsBuilderMethodArgumentResolver());\n\n        // Custom arguments\n        if (getCustomArgumentResolvers() != null) {\n            resolvers.addAll(getCustomArgumentResolvers());\n        }\n\n        // Catch-all\n        resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), true));\n        resolvers.add(new ServletModelAttributeMethodProcessor(true));\n\n        return resolvers;\n    }\n```\n\n可以看到所有的Converter最终作为一个构造参数传入了`RequestResponseBodyMethodProcessor`和`RequestPartMethodArgumentResolver`。 前者其实是负责处理`@RequestBody`和`@ResponseBody`的, \n后者则是处理`@RequestPart`这个注解的。拿`RequestResponseBodyMethodProcessor`为例来看。\n\n这个类的父类实现了`HandlerMethodReturnValueHandler`接口，这个接口的作用对照上面的系统整体架构图\n可知，是处理Controller返回的结果值的，看其`handleReturnValue`方法 。\n\n```java\n    @Override\n    public void handleReturnValue(Object returnValue, MethodParameter returnType,\n            ModelAndViewContainer mavContainer, NativeWebRequest webRequest)\n            throws IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException {\n        mavContainer.setRequestHandled(true);\n        // Try even with null return value. ResponseBodyAdvice could get involved.\n        writeWithMessageConverters(returnValue, returnType, webRequest);\n    }\n```\n首先标记这个请求已经处理过了，然后调用了一个内部方法，从名字就可以看出来，是使用MessageConverter进行\n转换。\n\n```java\n    /**\n     * Writes the given return value to the given web request. Delegates to\n     * {@link #writeWithMessageConverters(Object, MethodParameter, ServletServerHttpRequest, ServletServerHttpResponse)}\n     */\n    protected <T> void writeWithMessageConverters(T returnValue, MethodParameter returnType, NativeWebRequest webRequest)\n            throws IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException {\n\n        ServletServerHttpRequest inputMessage = createInputMessage(webRequest);\n        ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);\n        writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);\n    }\n\n```\n真正的逻辑还是内部的`writeWithMessageConveters()\n\n```java\n/**\n     * Writes the given return type to the given output message.\n     * @param returnValue the value to write to the output message\n     * @param returnType the type of the value\n     * @param inputMessage the input messages. Used to inspect the {@code Accept} header.\n     * @param outputMessage the output message to write to\n     * @throws IOException thrown in case of I/O errors\n     * @throws HttpMediaTypeNotAcceptableException thrown when the conditions indicated by {@code Accept} header on\n     * the request cannot be met by the message converters\n     */\n    @SuppressWarnings(\"unchecked\")\n    protected <T> void writeWithMessageConverters(T returnValue, MethodParameter returnType,\n            ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)\n            throws IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException {\n\n        Class<?> returnValueClass = getReturnValueType(returnValue, returnType);\n        Type returnValueType = getGenericType(returnType);\n        HttpServletRequest servletRequest = inputMessage.getServletRequest();\n        //从请求头获取可能的返回类型（默认会加载两种策略，比如从路径名的后缀上推断）\n        List<MediaType> requestedMediaTypes = getAcceptableMediaTypes(servletRequest);\n        //根据请求和返回的值得类型，推断可能的返回值类型\n        List<MediaType> producibleMediaTypes = getProducibleMediaTypes(servletRequest, returnValueClass, returnValueType);\n\n        if (returnValue != null && producibleMediaTypes.isEmpty()) {\n            throw new IllegalArgumentException(\"No converter found for return value of type: \" + returnValueClass);\n        }\n        \n        //筛选\n        Set<MediaType> compatibleMediaTypes = new LinkedHashSet<MediaType>();\n        for (MediaType requestedType : requestedMediaTypes) {\n            for (MediaType producibleType : producibleMediaTypes) {\n                if (requestedType.isCompatibleWith(producibleType)) {\n                    compatibleMediaTypes.add(getMostSpecificMediaType(requestedType, producibleType));\n                }\n            }\n        }\n        if (compatibleMediaTypes.isEmpty()) {\n            if (returnValue != null) {\n                throw new HttpMediaTypeNotAcceptableException(producibleMediaTypes);\n            }\n            return;\n        }\n\n        List<MediaType> mediaTypes = new ArrayList<MediaType>(compatibleMediaTypes);\n        MediaType.sortBySpecificityAndQuality(mediaTypes);\n\n        MediaType selectedMediaType = null;\n        for (MediaType mediaType : mediaTypes) {\n            if (mediaType.isConcrete()) {//具体的，没有通配符的\n                selectedMediaType = mediaType;\n                break;// 找到一个就跳出循环\n            }\n            else if (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) {\n                selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;\n                break;// 找到一个就跳出循环\n            }\n        }\n\n            //找到能处理这种类型的HttpMessageConverter\n        if (selectedMediaType != null) {\n            selectedMediaType = selectedMediaType.removeQualityValue();\n            for (HttpMessageConverter<?> messageConverter : this.messageConverters) {\n                if (messageConverter instanceof GenericHttpMessageConverter) {\n                    if (((GenericHttpMessageConverter<T>) messageConverter).canWrite(returnValueType,\n                            returnValueClass, selectedMediaType)) {\n                        returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,\n                                (Class<? extends HttpMessageConverter<?>>) messageConverter.getClass(),\n                                inputMessage, outputMessage);\n                        if (returnValue != null) {\n                            addContentDispositionHeader(inputMessage, outputMessage);\n                            ((GenericHttpMessageConverter<T>) messageConverter).write(returnValue,\n                                    returnValueType, selectedMediaType, outputMessage);\n                            if (logger.isDebugEnabled()) {\n                                logger.debug(\"Written [\" + returnValue + \"] as \\\"\" +\n                                        selectedMediaType + \"\\\" using [\" + messageConverter + \"]\");\n                            }\n                        }\n                        return;\n                    }\n                }\n                else if (messageConverter.canWrite(returnValueClass, selectedMediaType)) {\n                    returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,\n                            (Class<? extends HttpMessageConverter<?>>) messageConverter.getClass(),\n                            inputMessage, outputMessage);\n                    if (returnValue != null) {\n                        addContentDispositionHeader(inputMessage, outputMessage);\n                        ((HttpMessageConverter<T>) messageConverter).write(returnValue,\n                                selectedMediaType, outputMessage);\n                        if (logger.isDebugEnabled()) {\n                            logger.debug(\"Written [\" + returnValue + \"] as \\\"\" +\n                                    selectedMediaType + \"\\\" using [\" + messageConverter + \"]\");\n                        }\n                    }\n                    return;\n                }\n            }\n        }\n\n        if (returnValue != null) {\n            throw new HttpMediaTypeNotAcceptableException(this.allSupportedMediaTypes);\n        }\n    }\n```\n\n至此，HttpMessageConverter如何工作的就真相大白了。\n\n## 参考链接\n\n1. [SpringMVC关于json、xml自动转换的原理研究(附带源码分析)](http://www.cnblogs.com/fangjian0423/p/springMVC-xml-json-convert.html)\n","source":"_posts/HttpMessageConverter.md","raw":"---\ntitle: HttpMessageConverter 原理和源码\ntags: messageConverter\ncategory: spring\ntoc: true\nabbrlink: '55451865'\ndate: 2016-11-29 02:48:45\n---\n\n## 架构\n{%  asset_img   arch.jpg  %}\n\n\n\n\n## HttpMessageConverter接口\n\n\n\n{%  asset_img http-message-converter.jpg    )\n\n\n\n\n>`HttpMessageConverter` used to\nmarshal objects into the HTTP request body and to unmarshal any response back into an object.\n\n提供将Java中的对象和http请求、响应相互转换的功能\n\n### spring 中的配置\n\nxml配置示例：\n\n```xml\n<mvc:annotation-driven conversion-service=\"conversionService\">\n    <mvc:message-converters>\n        <bean class=\"org.springframework.http.converter.StringHttpMessageConverter\"/>\n        <bean class=\"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter\">\n            <property name=\"objectMapper\" ref=\"jsonObjectMapper\"/>\n        </bean>\n    </mvc:message-converters>\n</mvc:annotation-driven>\n```\n\njava配置示例：\n\n```java\n@Configuration\npublic class WebConfig extends DelegatingWebMvcConfiguration {\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry){\n    // ...\n    }\n\n    @Override\n    @Bean\n    public RequestMappingHandlerAdapter requestMappingHandlerAdapter() {\n    // Create or let \"super\" create the adapter\n    // Then customize one of its properties\n    }\n}\n```\n\n### 接口描述\n```java\npackage org.springframework.http.converter;\n\nimport java.io.IOException;\nimport java.util.List;\n\nimport org.springframework.http.HttpInputMessage;\nimport org.springframework.http.HttpOutputMessage;\nimport org.springframework.http.MediaType;\n\n/**\n * Strategy interface that specifies a converter that can convert from and to HTTP requests and responses.\n *\n * @author Arjen Poutsma\n * @author Juergen Hoeller\n * @since 3.0\n */\npublic interface HttpMessageConverter<T> {\n\n\t/**\n\t * Indicates whether the given class can be read by this converter.\n\t * @param clazz the class to test for readability\n\t * @param mediaType the media type to read, can be {@code null} if not specified.\n\t * Typically the value of a {@code Content-Type} header.\n\t * @return {@code true} if readable; {@code false} otherwise\n\t */\n\tboolean canRead(Class<?> clazz, MediaType mediaType);\n\n\t/**\n\t * Indicates whether the given class can be written by this converter.\n\t * @param clazz the class to test for writability\n\t * @param mediaType the media type to write, can be {@code null} if not specified.\n\t * Typically the value of an {@code Accept} header.\n\t * @return {@code true} if writable; {@code false} otherwise\n\t */\n\tboolean canWrite(Class<?> clazz, MediaType mediaType);\n\n\t/**\n\t * Return the list of {@link MediaType} objects supported by this converter.\n\t * @return the list of supported media types\n\t */\n\tList<MediaType> getSupportedMediaTypes();\n\n\t/**\n\t * Read an object of the given type form the given input message, and returns it.\n\t * @param clazz the type of object to return. This type must have previously been passed to the\n\t * {@link #canRead canRead} method of this interface, which must have returned {@code true}.\n\t * @param inputMessage the HTTP input message to read from\n\t * @return the converted object\n\t * @throws IOException in case of I/O errors\n\t * @throws HttpMessageNotReadableException in case of conversion errors\n\t */\n\tT read(Class<? extends T> clazz, HttpInputMessage inputMessage)\n\t\t\tthrows IOException, HttpMessageNotReadableException;\n\n\t/**\n\t * Write an given object to the given output message.\n\t * @param t the object to write to the output message. The type of this object must have previously been\n\t * passed to the {@link #canWrite canWrite} method of this interface, which must have returned {@code true}.\n\t * @param contentType the content type to use when writing. May be {@code null} to indicate that the\n\t * default content type of the converter must be used. If not {@code null}, this media type must have\n\t * previously been passed to the {@link #canWrite canWrite} method of this interface, which must have\n\t * returned {@code true}.\n\t * @param outputMessage the message to write to\n\t * @throws IOException in case of I/O errors\n\t * @throws HttpMessageNotWritableException in case of conversion errors\n\t */\n\tvoid write(T t, MediaType contentType, HttpOutputMessage outputMessage)\n\t\t\tthrows IOException, HttpMessageNotWritableException;\n\n}\n\n```\n\n### spring 提供的实现类\n\n{%  asset_img   inherit.jpg  %}\n\n\n\n\n|名称|\n|---|\n|ByteArrayHttpMessageConverter|\n|FormHttpMessageConverter|\n|XmlAwareFormHttpMessageConverter|\n|ResourceHttpMessageConverter|\n|SourceHttpMessageConverter|\n|StringHttpMessageConverter|\n|SimpleXmlHttpMessageConverter|\n|MappingJackson2HttpMessageConverter|\n|GsonHttpMessageConverter|\n|SyndFeedHttpMessageConverter|\n|RssChannelHttpMessageConverter|\n|AtomFeedHttpMessageConverter|\n\n具体功能见 [RestTemplate Module](http://docs.spring.io/autorepo/docs/spring-android/1.0.x/reference/html/rest-template.html)\n\n想研究源码的可以从最简单的 `StringHttpMessageConverter`看起\n\n## Spring调用过程\n\n在DispatcherServlet初始化的过程会调用一个叫做`initHandlerAdapters`的方法，\n该方法内部会扫描容器中所有的类，以及他们的父类，找到所有实现了`HandlerAdapter`接口的类，\n并将他们注册到`DispatcherServlet`的`HandlerAdapters`中。\n\n\n如果没有扫描到的HandlerAdapter，这个方法会加载一些默认的HandlerAdapter。\n\n> The default implementation uses the \"DispatcherServlet.properties\" file (in the same\n  package as the DispatcherServlet class) to determine the class names. \n\n  {%  asset_img   DispatcherServlet-properties.jpg  %}\n\n\n\n\nSpring 4.3.2 中有一个实现了`HandlerAdapter`接口的类会被扫描到，这个类叫做`RequestMappingHandlerAdapter`\n\n### RequestMappingHandlerAdapter\n这个类在构造的时候就加载了许多messageConverter\n\n```java\n    public RequestMappingHandlerAdapter() {\n        StringHttpMessageConverter stringHttpMessageConverter = new StringHttpMessageConverter();\n        stringHttpMessageConverter.setWriteAcceptCharset(false);  // see SPR-7316\n\n        this.messageConverters = new ArrayList<HttpMessageConverter<?>>(4);\n        this.messageConverters.add(new ByteArrayHttpMessageConverter());\n        this.messageConverters.add(stringHttpMessageConverter);\n        this.messageConverters.add(new SourceHttpMessageConverter<Source>());\n        this.messageConverters.add(new AllEncompassingFormHttpMessageConverter());\n    }\n```\n其中`AllEncompassingFormHttpMessageConverter`继承自`FormHttpMessageConverter`， 它有一个变量叫做\n`partConverters`，存储了一系列的`HttpMessageConverter`\n```java\n    private List<HttpMessageConverter<?>> partConverters = new ArrayList<HttpMessageConverter<?>>();\n    public FormHttpMessageConverter() {\n        this.supportedMediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);\n        this.supportedMediaTypes.add(MediaType.MULTIPART_FORM_DATA);\n        this.partConverters.add(new ByteArrayHttpMessageConverter());\n        StringHttpMessageConverter stringHttpMessageConverter = new StringHttpMessageConverter();\n        stringHttpMessageConverter.setWriteAcceptCharset(false);\n        this.partConverters.add(stringHttpMessageConverter);\n        this.partConverters.add(new ResourceHttpMessageConverter());\n    }\n```\n在`AllEncompassingFormHttpMessageConverter`中又根据classPath中是否包含jackson、Gson等jar包来动态的\n注册了一些`HttpMessageConverter`:\n\n```java\npublic class AllEncompassingFormHttpMessageConverter extends FormHttpMessageConverter {\n\n    private static final boolean jaxb2Present =\n            ClassUtils.isPresent(\"javax.xml.bind.Binder\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n    private static final boolean jackson2Present =\n            ClassUtils.isPresent(\"com.fasterxml.jackson.databind.ObjectMapper\", AllEncompassingFormHttpMessageConverter.class.getClassLoader()) &&\n                    ClassUtils.isPresent(\"com.fasterxml.jackson.core.JsonGenerator\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n    private static final boolean jackson2XmlPresent =\n            ClassUtils.isPresent(\"com.fasterxml.jackson.dataformat.xml.XmlMapper\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n    private static final boolean gsonPresent =\n            ClassUtils.isPresent(\"com.google.gson.Gson\", AllEncompassingFormHttpMessageConverter.class.getClassLoader());\n\n\n    public AllEncompassingFormHttpMessageConverter() {\n        addPartConverter(new SourceHttpMessageConverter<Source>());\n\n        if (jaxb2Present && !jackson2Present) {\n            addPartConverter(new Jaxb2RootElementHttpMessageConverter());\n        }\n\n        if (jackson2Present) {\n            addPartConverter(new MappingJackson2HttpMessageConverter());\n        }\n        else if (gsonPresent) {\n            addPartConverter(new GsonHttpMessageConverter());\n        }\n\n        if (jackson2XmlPresent) {\n            addPartConverter(new MappingJackson2XmlHttpMessageConverter());\n        }\n    }\n\n}\n```\n\n至于这些转换器是怎么使用的，要看`RequestMappingHandlerAdapter`中的`getDefaultArgumentResolver`\n\n```java\n/**\n     * Return the list of argument resolvers to use including built-in resolvers\n     * and custom resolvers provided via {@link #setCustomArgumentResolvers}.\n     */\n    private List<HandlerMethodArgumentResolver> getDefaultArgumentResolvers() {\n        List<HandlerMethodArgumentResolver> resolvers = new ArrayList<HandlerMethodArgumentResolver>();\n\n        // Annotation-based argument resolution\n        resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false));\n        resolvers.add(new RequestParamMapMethodArgumentResolver());\n        resolvers.add(new PathVariableMethodArgumentResolver());\n        resolvers.add(new PathVariableMapMethodArgumentResolver());\n        resolvers.add(new MatrixVariableMethodArgumentResolver());\n        resolvers.add(new MatrixVariableMapMethodArgumentResolver());\n        resolvers.add(new ServletModelAttributeMethodProcessor(false));\n        resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice));\n        resolvers.add(new RequestPartMethodArgumentResolver(getMessageConverters(), this.requestResponseBodyAdvice));\n        resolvers.add(new RequestHeaderMethodArgumentResolver(getBeanFactory()));\n        resolvers.add(new RequestHeaderMapMethodArgumentResolver());\n        resolvers.add(new ServletCookieValueMethodArgumentResolver(getBeanFactory()));\n        resolvers.add(new ExpressionValueMethodArgumentResolver(getBeanFactory()));\n\n        // Type-based argument resolution\n        resolvers.add(new ServletRequestMethodArgumentResolver());\n        resolvers.add(new ServletResponseMethodArgumentResolver());\n        resolvers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice));\n        resolvers.add(new RedirectAttributesMethodArgumentResolver());\n        resolvers.add(new ModelMethodProcessor());\n        resolvers.add(new MapMethodProcessor());\n        resolvers.add(new ErrorsMethodArgumentResolver());\n        resolvers.add(new SessionStatusMethodArgumentResolver());\n        resolvers.add(new UriComponentsBuilderMethodArgumentResolver());\n\n        // Custom arguments\n        if (getCustomArgumentResolvers() != null) {\n            resolvers.addAll(getCustomArgumentResolvers());\n        }\n\n        // Catch-all\n        resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), true));\n        resolvers.add(new ServletModelAttributeMethodProcessor(true));\n\n        return resolvers;\n    }\n```\n\n可以看到所有的Converter最终作为一个构造参数传入了`RequestResponseBodyMethodProcessor`和`RequestPartMethodArgumentResolver`。 前者其实是负责处理`@RequestBody`和`@ResponseBody`的, \n后者则是处理`@RequestPart`这个注解的。拿`RequestResponseBodyMethodProcessor`为例来看。\n\n这个类的父类实现了`HandlerMethodReturnValueHandler`接口，这个接口的作用对照上面的系统整体架构图\n可知，是处理Controller返回的结果值的，看其`handleReturnValue`方法 。\n\n```java\n    @Override\n    public void handleReturnValue(Object returnValue, MethodParameter returnType,\n            ModelAndViewContainer mavContainer, NativeWebRequest webRequest)\n            throws IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException {\n        mavContainer.setRequestHandled(true);\n        // Try even with null return value. ResponseBodyAdvice could get involved.\n        writeWithMessageConverters(returnValue, returnType, webRequest);\n    }\n```\n首先标记这个请求已经处理过了，然后调用了一个内部方法，从名字就可以看出来，是使用MessageConverter进行\n转换。\n\n```java\n    /**\n     * Writes the given return value to the given web request. Delegates to\n     * {@link #writeWithMessageConverters(Object, MethodParameter, ServletServerHttpRequest, ServletServerHttpResponse)}\n     */\n    protected <T> void writeWithMessageConverters(T returnValue, MethodParameter returnType, NativeWebRequest webRequest)\n            throws IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException {\n\n        ServletServerHttpRequest inputMessage = createInputMessage(webRequest);\n        ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);\n        writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);\n    }\n\n```\n真正的逻辑还是内部的`writeWithMessageConveters()\n\n```java\n/**\n     * Writes the given return type to the given output message.\n     * @param returnValue the value to write to the output message\n     * @param returnType the type of the value\n     * @param inputMessage the input messages. Used to inspect the {@code Accept} header.\n     * @param outputMessage the output message to write to\n     * @throws IOException thrown in case of I/O errors\n     * @throws HttpMediaTypeNotAcceptableException thrown when the conditions indicated by {@code Accept} header on\n     * the request cannot be met by the message converters\n     */\n    @SuppressWarnings(\"unchecked\")\n    protected <T> void writeWithMessageConverters(T returnValue, MethodParameter returnType,\n            ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)\n            throws IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException {\n\n        Class<?> returnValueClass = getReturnValueType(returnValue, returnType);\n        Type returnValueType = getGenericType(returnType);\n        HttpServletRequest servletRequest = inputMessage.getServletRequest();\n        //从请求头获取可能的返回类型（默认会加载两种策略，比如从路径名的后缀上推断）\n        List<MediaType> requestedMediaTypes = getAcceptableMediaTypes(servletRequest);\n        //根据请求和返回的值得类型，推断可能的返回值类型\n        List<MediaType> producibleMediaTypes = getProducibleMediaTypes(servletRequest, returnValueClass, returnValueType);\n\n        if (returnValue != null && producibleMediaTypes.isEmpty()) {\n            throw new IllegalArgumentException(\"No converter found for return value of type: \" + returnValueClass);\n        }\n        \n        //筛选\n        Set<MediaType> compatibleMediaTypes = new LinkedHashSet<MediaType>();\n        for (MediaType requestedType : requestedMediaTypes) {\n            for (MediaType producibleType : producibleMediaTypes) {\n                if (requestedType.isCompatibleWith(producibleType)) {\n                    compatibleMediaTypes.add(getMostSpecificMediaType(requestedType, producibleType));\n                }\n            }\n        }\n        if (compatibleMediaTypes.isEmpty()) {\n            if (returnValue != null) {\n                throw new HttpMediaTypeNotAcceptableException(producibleMediaTypes);\n            }\n            return;\n        }\n\n        List<MediaType> mediaTypes = new ArrayList<MediaType>(compatibleMediaTypes);\n        MediaType.sortBySpecificityAndQuality(mediaTypes);\n\n        MediaType selectedMediaType = null;\n        for (MediaType mediaType : mediaTypes) {\n            if (mediaType.isConcrete()) {//具体的，没有通配符的\n                selectedMediaType = mediaType;\n                break;// 找到一个就跳出循环\n            }\n            else if (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) {\n                selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;\n                break;// 找到一个就跳出循环\n            }\n        }\n\n            //找到能处理这种类型的HttpMessageConverter\n        if (selectedMediaType != null) {\n            selectedMediaType = selectedMediaType.removeQualityValue();\n            for (HttpMessageConverter<?> messageConverter : this.messageConverters) {\n                if (messageConverter instanceof GenericHttpMessageConverter) {\n                    if (((GenericHttpMessageConverter<T>) messageConverter).canWrite(returnValueType,\n                            returnValueClass, selectedMediaType)) {\n                        returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,\n                                (Class<? extends HttpMessageConverter<?>>) messageConverter.getClass(),\n                                inputMessage, outputMessage);\n                        if (returnValue != null) {\n                            addContentDispositionHeader(inputMessage, outputMessage);\n                            ((GenericHttpMessageConverter<T>) messageConverter).write(returnValue,\n                                    returnValueType, selectedMediaType, outputMessage);\n                            if (logger.isDebugEnabled()) {\n                                logger.debug(\"Written [\" + returnValue + \"] as \\\"\" +\n                                        selectedMediaType + \"\\\" using [\" + messageConverter + \"]\");\n                            }\n                        }\n                        return;\n                    }\n                }\n                else if (messageConverter.canWrite(returnValueClass, selectedMediaType)) {\n                    returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,\n                            (Class<? extends HttpMessageConverter<?>>) messageConverter.getClass(),\n                            inputMessage, outputMessage);\n                    if (returnValue != null) {\n                        addContentDispositionHeader(inputMessage, outputMessage);\n                        ((HttpMessageConverter<T>) messageConverter).write(returnValue,\n                                selectedMediaType, outputMessage);\n                        if (logger.isDebugEnabled()) {\n                            logger.debug(\"Written [\" + returnValue + \"] as \\\"\" +\n                                    selectedMediaType + \"\\\" using [\" + messageConverter + \"]\");\n                        }\n                    }\n                    return;\n                }\n            }\n        }\n\n        if (returnValue != null) {\n            throw new HttpMediaTypeNotAcceptableException(this.allSupportedMediaTypes);\n        }\n    }\n```\n\n至此，HttpMessageConverter如何工作的就真相大白了。\n\n## 参考链接\n\n1. [SpringMVC关于json、xml自动转换的原理研究(附带源码分析)](http://www.cnblogs.com/fangjian0423/p/springMVC-xml-json-convert.html)\n","slug":"HttpMessageConverter","published":1,"updated":"2017-04-16T11:59:29.539Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8k004ejh4ks64jy9ky","content":"<h2 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h2><img src=\"/2016/11/29/HttpMessageConverter/arch.jpg\">\n<h2 id=\"HttpMessageConverter接口\"><a href=\"#HttpMessageConverter接口\" class=\"headerlink\" title=\"HttpMessageConverter接口\"></a>HttpMessageConverter接口</h2><img src=\"/2016/11/29/HttpMessageConverter/http-message-converter.jpg\" title=\") >`HttpMessageConverter` used to marshal objects into the HTTP request body and to unmarshal any response back into an object. 提供将Java中的对象和http请求、响应相互转换的功能 ### spring 中的配置 xml配置示例： undefined java配置示例： undefined ### 接口描述 undefined ### spring 提供的实现类 {% asset_img inherit.jpg\">\n<table>\n<thead>\n<tr>\n<th>名称</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ByteArrayHttpMessageConverter</td>\n</tr>\n<tr>\n<td>FormHttpMessageConverter</td>\n</tr>\n<tr>\n<td>XmlAwareFormHttpMessageConverter</td>\n</tr>\n<tr>\n<td>ResourceHttpMessageConverter</td>\n</tr>\n<tr>\n<td>SourceHttpMessageConverter</td>\n</tr>\n<tr>\n<td>StringHttpMessageConverter</td>\n</tr>\n<tr>\n<td>SimpleXmlHttpMessageConverter</td>\n</tr>\n<tr>\n<td>MappingJackson2HttpMessageConverter</td>\n</tr>\n<tr>\n<td>GsonHttpMessageConverter</td>\n</tr>\n<tr>\n<td>SyndFeedHttpMessageConverter</td>\n</tr>\n<tr>\n<td>RssChannelHttpMessageConverter</td>\n</tr>\n<tr>\n<td>AtomFeedHttpMessageConverter</td>\n</tr>\n</tbody>\n</table>\n<p>具体功能见 <a href=\"http://docs.spring.io/autorepo/docs/spring-android/1.0.x/reference/html/rest-template.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">RestTemplate Module</a></p>\n<p>想研究源码的可以从最简单的 <code>StringHttpMessageConverter</code>看起</p>\n<h2 id=\"Spring调用过程\"><a href=\"#Spring调用过程\" class=\"headerlink\" title=\"Spring调用过程\"></a>Spring调用过程</h2><p>在DispatcherServlet初始化的过程会调用一个叫做<code>initHandlerAdapters</code>的方法，<br>该方法内部会扫描容器中所有的类，以及他们的父类，找到所有实现了<code>HandlerAdapter</code>接口的类，<br>并将他们注册到<code>DispatcherServlet</code>的<code>HandlerAdapters</code>中。</p>\n<p>如果没有扫描到的HandlerAdapter，这个方法会加载一些默认的HandlerAdapter。</p>\n<blockquote>\n<p>The default implementation uses the “DispatcherServlet.properties” file (in the same<br>  package as the DispatcherServlet class) to determine the class names. </p>\n</blockquote>\n  <img src=\"/2016/11/29/HttpMessageConverter/DispatcherServlet-properties.jpg\">\n<p>Spring 4.3.2 中有一个实现了<code>HandlerAdapter</code>接口的类会被扫描到，这个类叫做<code>RequestMappingHandlerAdapter</code></p>\n<h3 id=\"RequestMappingHandlerAdapter\"><a href=\"#RequestMappingHandlerAdapter\" class=\"headerlink\" title=\"RequestMappingHandlerAdapter\"></a>RequestMappingHandlerAdapter</h3><p>这个类在构造的时候就加载了许多messageConverter</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RequestMappingHandlerAdapter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    StringHttpMessageConverter stringHttpMessageConverter = <span class=\"keyword\">new</span> StringHttpMessageConverter();</span><br><span class=\"line\">    stringHttpMessageConverter.setWriteAcceptCharset(<span class=\"keyword\">false</span>);  <span class=\"comment\">// see SPR-7316</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters = <span class=\"keyword\">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;(<span class=\"number\">4</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(<span class=\"keyword\">new</span> ByteArrayHttpMessageConverter());</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(stringHttpMessageConverter);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(<span class=\"keyword\">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(<span class=\"keyword\">new</span> AllEncompassingFormHttpMessageConverter());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>AllEncompassingFormHttpMessageConverter</code>继承自<code>FormHttpMessageConverter</code>， 它有一个变量叫做<br><code>partConverters</code>，存储了一系列的<code>HttpMessageConverter</code><br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; partConverters = <span class=\"keyword\">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">FormHttpMessageConverter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.supportedMediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.supportedMediaTypes.add(MediaType.MULTIPART_FORM_DATA);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.partConverters.add(<span class=\"keyword\">new</span> ByteArrayHttpMessageConverter());</span><br><span class=\"line\">    StringHttpMessageConverter stringHttpMessageConverter = <span class=\"keyword\">new</span> StringHttpMessageConverter();</span><br><span class=\"line\">    stringHttpMessageConverter.setWriteAcceptCharset(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.partConverters.add(stringHttpMessageConverter);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.partConverters.add(<span class=\"keyword\">new</span> ResourceHttpMessageConverter());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在<code>AllEncompassingFormHttpMessageConverter</code>中又根据classPath中是否包含jackson、Gson等jar包来动态的<br>注册了一些<code>HttpMessageConverter</code>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllEncompassingFormHttpMessageConverter</span> <span class=\"keyword\">extends</span> <span class=\"title\">FormHttpMessageConverter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> jaxb2Present =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"javax.xml.bind.Binder\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> jackson2Present =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"com.fasterxml.jackson.databind.ObjectMapper\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader()) &amp;&amp;</span><br><span class=\"line\">                    ClassUtils.isPresent(<span class=\"string\">\"com.fasterxml.jackson.core.JsonGenerator\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> jackson2XmlPresent =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"com.fasterxml.jackson.dataformat.xml.XmlMapper\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> gsonPresent =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"com.google.gson.Gson\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AllEncompassingFormHttpMessageConverter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        addPartConverter(<span class=\"keyword\">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jaxb2Present &amp;&amp; !jackson2Present) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> Jaxb2RootElementHttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jackson2Present) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> MappingJackson2HttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (gsonPresent) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> GsonHttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jackson2XmlPresent) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> MappingJackson2XmlHttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>至于这些转换器是怎么使用的，要看<code>RequestMappingHandlerAdapter</code>中的<code>getDefaultArgumentResolver</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Return the list of argument resolvers to use including built-in resolvers</span></span><br><span class=\"line\"><span class=\"comment\">     * and custom resolvers provided via &#123;<span class=\"doctag\">@link</span> #setCustomArgumentResolvers&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class=\"title\">getDefaultArgumentResolvers</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class=\"keyword\">new</span> ArrayList&lt;HandlerMethodArgumentResolver&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Annotation-based argument resolution</span></span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class=\"keyword\">false</span>));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestParamMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> PathVariableMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> PathVariableMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> MatrixVariableMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> MatrixVariableMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletModelAttributeMethodProcessor(<span class=\"keyword\">false</span>));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class=\"keyword\">this</span>.requestResponseBodyAdvice));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestPartMethodArgumentResolver(getMessageConverters(), <span class=\"keyword\">this</span>.requestResponseBodyAdvice));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestHeaderMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Type-based argument resolution</span></span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletRequestMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletResponseMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class=\"keyword\">this</span>.requestResponseBodyAdvice));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RedirectAttributesMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ModelMethodProcessor());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> MapMethodProcessor());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ErrorsMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> SessionStatusMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> UriComponentsBuilderMethodArgumentResolver());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Custom arguments</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getCustomArgumentResolvers() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            resolvers.addAll(getCustomArgumentResolvers());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Catch-all</span></span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class=\"keyword\">true</span>));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletModelAttributeMethodProcessor(<span class=\"keyword\">true</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> resolvers;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>可以看到所有的Converter最终作为一个构造参数传入了<code>RequestResponseBodyMethodProcessor</code>和<code>RequestPartMethodArgumentResolver</code>。 前者其实是负责处理<code>@RequestBody</code>和<code>@ResponseBody</code>的,<br>后者则是处理<code>@RequestPart</code>这个注解的。拿<code>RequestResponseBodyMethodProcessor</code>为例来看。</p>\n<p>这个类的父类实现了<code>HandlerMethodReturnValueHandler</code>接口，这个接口的作用对照上面的系统整体架构图<br>可知，是处理Controller返回的结果值的，看其<code>handleReturnValue</code>方法 。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleReturnValue</span><span class=\"params\">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class=\"line\">    mavContainer.setRequestHandled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class=\"line\">    writeWithMessageConverters(returnValue, returnType, webRequest);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>首先标记这个请求已经处理过了，然后调用了一个内部方法，从名字就可以看出来，是使用MessageConverter进行<br>转换。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Writes the given return value to the given web request. Delegates to</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;<span class=\"doctag\">@link</span> #writeWithMessageConverters(Object, MethodParameter, ServletServerHttpRequest, ServletServerHttpResponse)&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> &lt;T&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">writeWithMessageConverters</span><span class=\"params\">(T returnValue, MethodParameter returnType, NativeWebRequest webRequest)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ServletServerHttpRequest inputMessage = createInputMessage(webRequest);</span><br><span class=\"line\">    ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);</span><br><span class=\"line\">    writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>真正的逻辑还是内部的`writeWithMessageConveters()</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Writes the given return type to the given output message.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> returnValue the value to write to the output message</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> returnType the type of the value</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> inputMessage the input messages. Used to inspect the &#123;<span class=\"doctag\">@code</span> Accept&#125; header.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> outputMessage the output message to write to</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> IOException thrown in case of I/O errors</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> HttpMediaTypeNotAcceptableException thrown when the conditions indicated by &#123;<span class=\"doctag\">@code</span> Accept&#125; header on</span></span><br><span class=\"line\"><span class=\"comment\">     * the request cannot be met by the message converters</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"unchecked\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> &lt;T&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">writeWithMessageConverters</span><span class=\"params\">(T returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span></span></span><br><span class=\"line\"><span class=\"function\">            <span class=\"keyword\">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Class&lt;?&gt; returnValueClass = getReturnValueType(returnValue, returnType);</span><br><span class=\"line\">        Type returnValueType = getGenericType(returnType);</span><br><span class=\"line\">        HttpServletRequest servletRequest = inputMessage.getServletRequest();</span><br><span class=\"line\">        <span class=\"comment\">//从请求头获取可能的返回类型（默认会加载两种策略，比如从路径名的后缀上推断）</span></span><br><span class=\"line\">        List&lt;MediaType&gt; requestedMediaTypes = getAcceptableMediaTypes(servletRequest);</span><br><span class=\"line\">        <span class=\"comment\">//根据请求和返回的值得类型，推断可能的返回值类型</span></span><br><span class=\"line\">        List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(servletRequest, returnValueClass, returnValueType);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span> &amp;&amp; producibleMediaTypes.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"No converter found for return value of type: \"</span> + returnValueClass);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//筛选</span></span><br><span class=\"line\">        Set&lt;MediaType&gt; compatibleMediaTypes = <span class=\"keyword\">new</span> LinkedHashSet&lt;MediaType&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MediaType requestedType : requestedMediaTypes) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (MediaType producibleType : producibleMediaTypes) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (requestedType.isCompatibleWith(producibleType)) &#123;</span><br><span class=\"line\">                    compatibleMediaTypes.add(getMostSpecificMediaType(requestedType, producibleType));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compatibleMediaTypes.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> HttpMediaTypeNotAcceptableException(producibleMediaTypes);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;MediaType&gt; mediaTypes = <span class=\"keyword\">new</span> ArrayList&lt;MediaType&gt;(compatibleMediaTypes);</span><br><span class=\"line\">        MediaType.sortBySpecificityAndQuality(mediaTypes);</span><br><span class=\"line\"></span><br><span class=\"line\">        MediaType selectedMediaType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MediaType mediaType : mediaTypes) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mediaType.isConcrete()) &#123;<span class=\"comment\">//具体的，没有通配符的</span></span><br><span class=\"line\">                selectedMediaType = mediaType;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;<span class=\"comment\">// 找到一个就跳出循环</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) &#123;</span><br><span class=\"line\">                selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;<span class=\"comment\">// 找到一个就跳出循环</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//找到能处理这种类型的HttpMessageConverter</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (selectedMediaType != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            selectedMediaType = selectedMediaType.removeQualityValue();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (HttpMessageConverter&lt;?&gt; messageConverter : <span class=\"keyword\">this</span>.messageConverters) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (messageConverter <span class=\"keyword\">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (((GenericHttpMessageConverter&lt;T&gt;) messageConverter).canWrite(returnValueType,</span><br><span class=\"line\">                            returnValueClass, selectedMediaType)) &#123;</span><br><span class=\"line\">                        returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,</span><br><span class=\"line\">                                (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class=\"line\">                                inputMessage, outputMessage);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class=\"line\">                            ((GenericHttpMessageConverter&lt;T&gt;) messageConverter).write(returnValue,</span><br><span class=\"line\">                                    returnValueType, selectedMediaType, outputMessage);</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                                logger.debug(<span class=\"string\">\"Written [\"</span> + returnValue + <span class=\"string\">\"] as \\\"\"</span> +</span><br><span class=\"line\">                                        selectedMediaType + <span class=\"string\">\"\\\" using [\"</span> + messageConverter + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (messageConverter.canWrite(returnValueClass, selectedMediaType)) &#123;</span><br><span class=\"line\">                    returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,</span><br><span class=\"line\">                            (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class=\"line\">                            inputMessage, outputMessage);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class=\"line\">                        ((HttpMessageConverter&lt;T&gt;) messageConverter).write(returnValue,</span><br><span class=\"line\">                                selectedMediaType, outputMessage);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                            logger.debug(<span class=\"string\">\"Written [\"</span> + returnValue + <span class=\"string\">\"] as \\\"\"</span> +</span><br><span class=\"line\">                                    selectedMediaType + <span class=\"string\">\"\\\" using [\"</span> + messageConverter + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> HttpMediaTypeNotAcceptableException(<span class=\"keyword\">this</span>.allSupportedMediaTypes);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>至此，HttpMessageConverter如何工作的就真相大白了。</p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><a href=\"http://www.cnblogs.com/fangjian0423/p/springMVC-xml-json-convert.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SpringMVC关于json、xml自动转换的原理研究(附带源码分析)</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h2><img src=\"/2016/11/29/HttpMessageConverter/arch.jpg\">\n<h2 id=\"HttpMessageConverter接口\"><a href=\"#HttpMessageConverter接口\" class=\"headerlink\" title=\"HttpMessageConverter接口\"></a>HttpMessageConverter接口</h2><img src=\"/2016/11/29/HttpMessageConverter/http-message-converter.jpg\" title=\") >`HttpMessageConverter` used to marshal objects into the HTTP request body and to unmarshal any response back into an object. 提供将Java中的对象和http请求、响应相互转换的功能 ### spring 中的配置 xml配置示例： undefined java配置示例： undefined ### 接口描述 undefined ### spring 提供的实现类 {% asset_img inherit.jpg\">\n<table>\n<thead>\n<tr>\n<th>名称</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ByteArrayHttpMessageConverter</td>\n</tr>\n<tr>\n<td>FormHttpMessageConverter</td>\n</tr>\n<tr>\n<td>XmlAwareFormHttpMessageConverter</td>\n</tr>\n<tr>\n<td>ResourceHttpMessageConverter</td>\n</tr>\n<tr>\n<td>SourceHttpMessageConverter</td>\n</tr>\n<tr>\n<td>StringHttpMessageConverter</td>\n</tr>\n<tr>\n<td>SimpleXmlHttpMessageConverter</td>\n</tr>\n<tr>\n<td>MappingJackson2HttpMessageConverter</td>\n</tr>\n<tr>\n<td>GsonHttpMessageConverter</td>\n</tr>\n<tr>\n<td>SyndFeedHttpMessageConverter</td>\n</tr>\n<tr>\n<td>RssChannelHttpMessageConverter</td>\n</tr>\n<tr>\n<td>AtomFeedHttpMessageConverter</td>\n</tr>\n</tbody>\n</table>\n<p>具体功能见 <a href=\"http://docs.spring.io/autorepo/docs/spring-android/1.0.x/reference/html/rest-template.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">RestTemplate Module</a></p>\n<p>想研究源码的可以从最简单的 <code>StringHttpMessageConverter</code>看起</p>\n<h2 id=\"Spring调用过程\"><a href=\"#Spring调用过程\" class=\"headerlink\" title=\"Spring调用过程\"></a>Spring调用过程</h2><p>在DispatcherServlet初始化的过程会调用一个叫做<code>initHandlerAdapters</code>的方法，<br>该方法内部会扫描容器中所有的类，以及他们的父类，找到所有实现了<code>HandlerAdapter</code>接口的类，<br>并将他们注册到<code>DispatcherServlet</code>的<code>HandlerAdapters</code>中。</p>\n<p>如果没有扫描到的HandlerAdapter，这个方法会加载一些默认的HandlerAdapter。</p>\n<blockquote>\n<p>The default implementation uses the “DispatcherServlet.properties” file (in the same<br>  package as the DispatcherServlet class) to determine the class names. </p>\n</blockquote>\n  <img src=\"/2016/11/29/HttpMessageConverter/DispatcherServlet-properties.jpg\">\n<p>Spring 4.3.2 中有一个实现了<code>HandlerAdapter</code>接口的类会被扫描到，这个类叫做<code>RequestMappingHandlerAdapter</code></p>\n<h3 id=\"RequestMappingHandlerAdapter\"><a href=\"#RequestMappingHandlerAdapter\" class=\"headerlink\" title=\"RequestMappingHandlerAdapter\"></a>RequestMappingHandlerAdapter</h3><p>这个类在构造的时候就加载了许多messageConverter</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RequestMappingHandlerAdapter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    StringHttpMessageConverter stringHttpMessageConverter = <span class=\"keyword\">new</span> StringHttpMessageConverter();</span><br><span class=\"line\">    stringHttpMessageConverter.setWriteAcceptCharset(<span class=\"keyword\">false</span>);  <span class=\"comment\">// see SPR-7316</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters = <span class=\"keyword\">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;(<span class=\"number\">4</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(<span class=\"keyword\">new</span> ByteArrayHttpMessageConverter());</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(stringHttpMessageConverter);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(<span class=\"keyword\">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messageConverters.add(<span class=\"keyword\">new</span> AllEncompassingFormHttpMessageConverter());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>AllEncompassingFormHttpMessageConverter</code>继承自<code>FormHttpMessageConverter</code>， 它有一个变量叫做<br><code>partConverters</code>，存储了一系列的<code>HttpMessageConverter</code><br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; partConverters = <span class=\"keyword\">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">FormHttpMessageConverter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.supportedMediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.supportedMediaTypes.add(MediaType.MULTIPART_FORM_DATA);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.partConverters.add(<span class=\"keyword\">new</span> ByteArrayHttpMessageConverter());</span><br><span class=\"line\">    StringHttpMessageConverter stringHttpMessageConverter = <span class=\"keyword\">new</span> StringHttpMessageConverter();</span><br><span class=\"line\">    stringHttpMessageConverter.setWriteAcceptCharset(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.partConverters.add(stringHttpMessageConverter);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.partConverters.add(<span class=\"keyword\">new</span> ResourceHttpMessageConverter());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在<code>AllEncompassingFormHttpMessageConverter</code>中又根据classPath中是否包含jackson、Gson等jar包来动态的<br>注册了一些<code>HttpMessageConverter</code>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AllEncompassingFormHttpMessageConverter</span> <span class=\"keyword\">extends</span> <span class=\"title\">FormHttpMessageConverter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> jaxb2Present =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"javax.xml.bind.Binder\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> jackson2Present =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"com.fasterxml.jackson.databind.ObjectMapper\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader()) &amp;&amp;</span><br><span class=\"line\">                    ClassUtils.isPresent(<span class=\"string\">\"com.fasterxml.jackson.core.JsonGenerator\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> jackson2XmlPresent =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"com.fasterxml.jackson.dataformat.xml.XmlMapper\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> gsonPresent =</span><br><span class=\"line\">            ClassUtils.isPresent(<span class=\"string\">\"com.google.gson.Gson\"</span>, AllEncompassingFormHttpMessageConverter.class.getClassLoader());</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AllEncompassingFormHttpMessageConverter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        addPartConverter(<span class=\"keyword\">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jaxb2Present &amp;&amp; !jackson2Present) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> Jaxb2RootElementHttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jackson2Present) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> MappingJackson2HttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (gsonPresent) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> GsonHttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (jackson2XmlPresent) &#123;</span><br><span class=\"line\">            addPartConverter(<span class=\"keyword\">new</span> MappingJackson2XmlHttpMessageConverter());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>至于这些转换器是怎么使用的，要看<code>RequestMappingHandlerAdapter</code>中的<code>getDefaultArgumentResolver</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Return the list of argument resolvers to use including built-in resolvers</span></span><br><span class=\"line\"><span class=\"comment\">     * and custom resolvers provided via &#123;<span class=\"doctag\">@link</span> #setCustomArgumentResolvers&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class=\"title\">getDefaultArgumentResolvers</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class=\"keyword\">new</span> ArrayList&lt;HandlerMethodArgumentResolver&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Annotation-based argument resolution</span></span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class=\"keyword\">false</span>));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestParamMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> PathVariableMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> PathVariableMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> MatrixVariableMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> MatrixVariableMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletModelAttributeMethodProcessor(<span class=\"keyword\">false</span>));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class=\"keyword\">this</span>.requestResponseBodyAdvice));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestPartMethodArgumentResolver(getMessageConverters(), <span class=\"keyword\">this</span>.requestResponseBodyAdvice));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestHeaderMapMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Type-based argument resolution</span></span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletRequestMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletResponseMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class=\"keyword\">this</span>.requestResponseBodyAdvice));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RedirectAttributesMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ModelMethodProcessor());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> MapMethodProcessor());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ErrorsMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> SessionStatusMethodArgumentResolver());</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> UriComponentsBuilderMethodArgumentResolver());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Custom arguments</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (getCustomArgumentResolvers() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            resolvers.addAll(getCustomArgumentResolvers());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Catch-all</span></span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class=\"keyword\">true</span>));</span><br><span class=\"line\">        resolvers.add(<span class=\"keyword\">new</span> ServletModelAttributeMethodProcessor(<span class=\"keyword\">true</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> resolvers;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>可以看到所有的Converter最终作为一个构造参数传入了<code>RequestResponseBodyMethodProcessor</code>和<code>RequestPartMethodArgumentResolver</code>。 前者其实是负责处理<code>@RequestBody</code>和<code>@ResponseBody</code>的,<br>后者则是处理<code>@RequestPart</code>这个注解的。拿<code>RequestResponseBodyMethodProcessor</code>为例来看。</p>\n<p>这个类的父类实现了<code>HandlerMethodReturnValueHandler</code>接口，这个接口的作用对照上面的系统整体架构图<br>可知，是处理Controller返回的结果值的，看其<code>handleReturnValue</code>方法 。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleReturnValue</span><span class=\"params\">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class=\"line\">    mavContainer.setRequestHandled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class=\"line\">    writeWithMessageConverters(returnValue, returnType, webRequest);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>首先标记这个请求已经处理过了，然后调用了一个内部方法，从名字就可以看出来，是使用MessageConverter进行<br>转换。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Writes the given return value to the given web request. Delegates to</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;<span class=\"doctag\">@link</span> #writeWithMessageConverters(Object, MethodParameter, ServletServerHttpRequest, ServletServerHttpResponse)&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> &lt;T&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">writeWithMessageConverters</span><span class=\"params\">(T returnValue, MethodParameter returnType, NativeWebRequest webRequest)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ServletServerHttpRequest inputMessage = createInputMessage(webRequest);</span><br><span class=\"line\">    ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);</span><br><span class=\"line\">    writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>真正的逻辑还是内部的`writeWithMessageConveters()</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Writes the given return type to the given output message.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> returnValue the value to write to the output message</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> returnType the type of the value</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> inputMessage the input messages. Used to inspect the &#123;<span class=\"doctag\">@code</span> Accept&#125; header.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> outputMessage the output message to write to</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> IOException thrown in case of I/O errors</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> HttpMediaTypeNotAcceptableException thrown when the conditions indicated by &#123;<span class=\"doctag\">@code</span> Accept&#125; header on</span></span><br><span class=\"line\"><span class=\"comment\">     * the request cannot be met by the message converters</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"unchecked\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> &lt;T&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">writeWithMessageConverters</span><span class=\"params\">(T returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span></span></span><br><span class=\"line\"><span class=\"function\">            <span class=\"keyword\">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Class&lt;?&gt; returnValueClass = getReturnValueType(returnValue, returnType);</span><br><span class=\"line\">        Type returnValueType = getGenericType(returnType);</span><br><span class=\"line\">        HttpServletRequest servletRequest = inputMessage.getServletRequest();</span><br><span class=\"line\">        <span class=\"comment\">//从请求头获取可能的返回类型（默认会加载两种策略，比如从路径名的后缀上推断）</span></span><br><span class=\"line\">        List&lt;MediaType&gt; requestedMediaTypes = getAcceptableMediaTypes(servletRequest);</span><br><span class=\"line\">        <span class=\"comment\">//根据请求和返回的值得类型，推断可能的返回值类型</span></span><br><span class=\"line\">        List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(servletRequest, returnValueClass, returnValueType);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span> &amp;&amp; producibleMediaTypes.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"No converter found for return value of type: \"</span> + returnValueClass);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//筛选</span></span><br><span class=\"line\">        Set&lt;MediaType&gt; compatibleMediaTypes = <span class=\"keyword\">new</span> LinkedHashSet&lt;MediaType&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MediaType requestedType : requestedMediaTypes) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (MediaType producibleType : producibleMediaTypes) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (requestedType.isCompatibleWith(producibleType)) &#123;</span><br><span class=\"line\">                    compatibleMediaTypes.add(getMostSpecificMediaType(requestedType, producibleType));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (compatibleMediaTypes.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> HttpMediaTypeNotAcceptableException(producibleMediaTypes);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;MediaType&gt; mediaTypes = <span class=\"keyword\">new</span> ArrayList&lt;MediaType&gt;(compatibleMediaTypes);</span><br><span class=\"line\">        MediaType.sortBySpecificityAndQuality(mediaTypes);</span><br><span class=\"line\"></span><br><span class=\"line\">        MediaType selectedMediaType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MediaType mediaType : mediaTypes) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (mediaType.isConcrete()) &#123;<span class=\"comment\">//具体的，没有通配符的</span></span><br><span class=\"line\">                selectedMediaType = mediaType;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;<span class=\"comment\">// 找到一个就跳出循环</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) &#123;</span><br><span class=\"line\">                selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;<span class=\"comment\">// 找到一个就跳出循环</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//找到能处理这种类型的HttpMessageConverter</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (selectedMediaType != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            selectedMediaType = selectedMediaType.removeQualityValue();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (HttpMessageConverter&lt;?&gt; messageConverter : <span class=\"keyword\">this</span>.messageConverters) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (messageConverter <span class=\"keyword\">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (((GenericHttpMessageConverter&lt;T&gt;) messageConverter).canWrite(returnValueType,</span><br><span class=\"line\">                            returnValueClass, selectedMediaType)) &#123;</span><br><span class=\"line\">                        returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,</span><br><span class=\"line\">                                (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class=\"line\">                                inputMessage, outputMessage);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class=\"line\">                            ((GenericHttpMessageConverter&lt;T&gt;) messageConverter).write(returnValue,</span><br><span class=\"line\">                                    returnValueType, selectedMediaType, outputMessage);</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                                logger.debug(<span class=\"string\">\"Written [\"</span> + returnValue + <span class=\"string\">\"] as \\\"\"</span> +</span><br><span class=\"line\">                                        selectedMediaType + <span class=\"string\">\"\\\" using [\"</span> + messageConverter + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (messageConverter.canWrite(returnValueClass, selectedMediaType)) &#123;</span><br><span class=\"line\">                    returnValue = (T) getAdvice().beforeBodyWrite(returnValue, returnType, selectedMediaType,</span><br><span class=\"line\">                            (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class=\"line\">                            inputMessage, outputMessage);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class=\"line\">                        ((HttpMessageConverter&lt;T&gt;) messageConverter).write(returnValue,</span><br><span class=\"line\">                                selectedMediaType, outputMessage);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                            logger.debug(<span class=\"string\">\"Written [\"</span> + returnValue + <span class=\"string\">\"] as \\\"\"</span> +</span><br><span class=\"line\">                                    selectedMediaType + <span class=\"string\">\"\\\" using [\"</span> + messageConverter + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (returnValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> HttpMediaTypeNotAcceptableException(<span class=\"keyword\">this</span>.allSupportedMediaTypes);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>至此，HttpMessageConverter如何工作的就真相大白了。</p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><a href=\"http://www.cnblogs.com/fangjian0423/p/springMVC-xml-json-convert.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SpringMVC关于json、xml自动转换的原理研究(附带源码分析)</a></li>\n</ol>\n"},{"title":"atnode——在集群上批量执行命令","toc":true,"abbrlink":11630,"date":"2016-12-12T16:07:02.000Z","_content":"\n\n## atnodes\n\natnode是一个用perl写成的工具，它可以方便的在集群上执行命令\n\n[官网链接](http://search.cpan.org/~agent/SSH-Batch-0.029/bin/atnodes)\n\n\n```bash\natnodes \"echo alias grep=\\'grep -n --color\\' >> ~/.bashrc \"  xxx.xx[1-10].com  yyy.yy[1-10].com\n```\n\n上述的命令就会在后面两个列表的主机上都执行一遍了。\n\n\n## tonodes\n\n与atnodes类似，tonodes 可以将文件传输到集群上的没一个文件\n\n## 其他\n\nfornodes: Expand patterns to machine host list\n\nkey2nodes: Push SSH public keys to remote clusters \n\n## 作者博客\n\n[agentzh的微博](http://weibo.com/u/1834459124?topnav=1&wvr=6&topsug=1&is_all=1)","source":"_posts/atnode.md","raw":"---\ntitle: atnode——在集群上批量执行命令\ncategory: shell\ntoc: true\nabbrlink: 11630\ndate: 2016-12-13 00:07:02\ntags:\n---\n\n\n## atnodes\n\natnode是一个用perl写成的工具，它可以方便的在集群上执行命令\n\n[官网链接](http://search.cpan.org/~agent/SSH-Batch-0.029/bin/atnodes)\n\n\n```bash\natnodes \"echo alias grep=\\'grep -n --color\\' >> ~/.bashrc \"  xxx.xx[1-10].com  yyy.yy[1-10].com\n```\n\n上述的命令就会在后面两个列表的主机上都执行一遍了。\n\n\n## tonodes\n\n与atnodes类似，tonodes 可以将文件传输到集群上的没一个文件\n\n## 其他\n\nfornodes: Expand patterns to machine host list\n\nkey2nodes: Push SSH public keys to remote clusters \n\n## 作者博客\n\n[agentzh的微博](http://weibo.com/u/1834459124?topnav=1&wvr=6&topsug=1&is_all=1)","slug":"atnode","published":1,"updated":"2017-04-16T12:03:23.385Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8l004ijh4k0kzwo7u1","content":"<h2 id=\"atnodes\"><a href=\"#atnodes\" class=\"headerlink\" title=\"atnodes\"></a>atnodes</h2><p>atnode是一个用perl写成的工具，它可以方便的在集群上执行命令</p>\n<p><a href=\"http://search.cpan.org/~agent/SSH-Batch-0.029/bin/atnodes\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">官网链接</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">atnodes <span class=\"string\">\"echo alias grep=\\'grep -n --color\\' &gt;&gt; ~/.bashrc \"</span>  xxx.xx[1-10].com  yyy.yy[1-10].com</span><br></pre></td></tr></table></figure>\n<p>上述的命令就会在后面两个列表的主机上都执行一遍了。</p>\n<h2 id=\"tonodes\"><a href=\"#tonodes\" class=\"headerlink\" title=\"tonodes\"></a>tonodes</h2><p>与atnodes类似，tonodes 可以将文件传输到集群上的没一个文件</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>fornodes: Expand patterns to machine host list</p>\n<p>key2nodes: Push SSH public keys to remote clusters </p>\n<h2 id=\"作者博客\"><a href=\"#作者博客\" class=\"headerlink\" title=\"作者博客\"></a>作者博客</h2><p><a href=\"http://weibo.com/u/1834459124?topnav=1&amp;wvr=6&amp;topsug=1&amp;is_all=1\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">agentzh的微博</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"atnodes\"><a href=\"#atnodes\" class=\"headerlink\" title=\"atnodes\"></a>atnodes</h2><p>atnode是一个用perl写成的工具，它可以方便的在集群上执行命令</p>\n<p><a href=\"http://search.cpan.org/~agent/SSH-Batch-0.029/bin/atnodes\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">官网链接</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">atnodes <span class=\"string\">\"echo alias grep=\\'grep -n --color\\' &gt;&gt; ~/.bashrc \"</span>  xxx.xx[1-10].com  yyy.yy[1-10].com</span><br></pre></td></tr></table></figure>\n<p>上述的命令就会在后面两个列表的主机上都执行一遍了。</p>\n<h2 id=\"tonodes\"><a href=\"#tonodes\" class=\"headerlink\" title=\"tonodes\"></a>tonodes</h2><p>与atnodes类似，tonodes 可以将文件传输到集群上的没一个文件</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>fornodes: Expand patterns to machine host list</p>\n<p>key2nodes: Push SSH public keys to remote clusters </p>\n<h2 id=\"作者博客\"><a href=\"#作者博客\" class=\"headerlink\" title=\"作者博客\"></a>作者博客</h2><p><a href=\"http://weibo.com/u/1834459124?topnav=1&amp;wvr=6&amp;topsug=1&amp;is_all=1\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">agentzh的微博</a></p>\n"},{"title":"Guava中的ThreadFactoryBuilder","toc":true,"date":"2017-11-18T09:15:34.000Z","_content":"\n\n## 用法\n\njava中自定义线程池时可以传入一个`ThreadFactory`，用来创建线程。\n\n```java\n /**\n     * Creates a new {@code ThreadPoolExecutor} with the given initial\n     * parameters and default rejected execution handler.\n     *\n     * @param corePoolSize the number of threads to keep in the pool, even\n     *        if they are idle, unless {@code allowCoreThreadTimeOut} is set\n     * @param maximumPoolSize the maximum number of threads to allow in the\n     *        pool\n     * @param keepAliveTime when the number of threads is greater than\n     *        the core, this is the maximum time that excess idle threads\n     *        will wait for new tasks before terminating.\n     * @param unit the time unit for the {@code keepAliveTime} argument\n     * @param workQueue the queue to use for holding tasks before they are\n     *        executed.  This queue will hold only the {@code Runnable}\n     *        tasks submitted by the {@code execute} method.\n     * @param threadFactory the factory to use when the executor\n     *        creates a new thread\n     * @throws IllegalArgumentException if one of the following holds:<br>\n     *         {@code corePoolSize < 0}<br>\n     *         {@code keepAliveTime < 0}<br>\n     *         {@code maximumPoolSize <= 0}<br>\n     *         {@code maximumPoolSize < corePoolSize}\n     * @throws NullPointerException if {@code workQueue}\n     *         or {@code threadFactory} is null\n     */\n    public ThreadPoolExecutor(int corePoolSize,\n                              int maximumPoolSize,\n                              long keepAliveTime,\n                              TimeUnit unit,\n                              BlockingQueue<Runnable> workQueue,\n                              ThreadFactory threadFactory) {\n        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,\n             threadFactory, defaultHandler);\n    }\n```\n\n`ThreadFactory`接口只有一个方法，就是创建线程\n\n```java\npublic interface ThreadFactory {\n\n    /**\n     * Constructs a new {@code Thread}.  Implementations may also initialize\n     * priority, name, daemon status, {@code ThreadGroup}, etc.\n     *\n     * @param r a runnable to be executed by new thread instance\n     * @return constructed thread, or {@code null} if the request to\n     *         create a thread is rejected\n     */\n    Thread newThread(Runnable r);\n}\n```\n\n创建`Thread`时可以设置一些列的属性， 属性比较多，于是`guava`里有一个便利类 ———— `ThreadFactoryBuilder`。\n\n直接看`build`方法:\n\n```java\nprivate static ThreadFactory build(ThreadFactoryBuilder builder) {\n    final String nameFormat = builder.nameFormat;\n    final Boolean daemon = builder.daemon;\n    final Integer priority = builder.priority;\n    final UncaughtExceptionHandler uncaughtExceptionHandler =\n        builder.uncaughtExceptionHandler;\n    final ThreadFactory backingThreadFactory =\n        (builder.backingThreadFactory != null)\n        ? builder.backingThreadFactory\n        : Executors.defaultThreadFactory();\n    final AtomicLong count = (nameFormat != null) ? new AtomicLong(0) : null;\n    return new ThreadFactory() {\n      @Override public Thread newThread(Runnable runnable) {\n        Thread thread = backingThreadFactory.newThread(runnable);\n        if (nameFormat != null) {\n          thread.setName(format(nameFormat, count.getAndIncrement()));\n        }\n        if (daemon != null) {\n          thread.setDaemon(daemon);\n        }\n        if (priority != null) {\n          thread.setPriority(priority);\n        }\n        if (uncaughtExceptionHandler != null) {\n          thread.setUncaughtExceptionHandler(uncaughtExceptionHandler);\n        }\n        return thread;\n      }\n    };\n  }\n```\n\n使用起来挺顺手的：\n\n```java\n  private static ThreadPoolExecutor executor = new ThreadPoolExecutor(\n            10,\n            15,\n            10,\n            TimeUnit.SECONDS,\n            blockingQueue,\n            new ThreadFactoryBuilder().setNameFormat(\"guava-%d\").build(),\n            new ThreadPoolExecutor.DiscardPolicy()\n    );\n```\n\n主要就是给线程整一个名字，用`jstack`等工具排查问题时方便知道是哪个线程池里的。\n\n`jstack`的结果：\n\n```\n\"guava-9\" #19 prio=5 os_prio=0 tid=0x00007f5024468000 nid=0x5e3b waiting on condition [0x00007f50104f7000]\n   java.lang.Thread.State: WAITING (parking)\n        at sun.misc.Unsafe.park(Native Method)\n        - parking to wait for  <0x00000000d709af38> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)\n        at java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:403)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n```\n\n## 更多\n\n1. [ExecutorService-10个要诀和技巧 - ImportNew](http://www.importnew.com/20263.html)","source":"_posts/ThreadFactoryBuilder.md","raw":"title: Guava中的ThreadFactoryBuilder\ntags: concurrent\ncategory: guava\ntoc: true\ndate: 2017-11-18 17:15:34\n---\n\n\n## 用法\n\njava中自定义线程池时可以传入一个`ThreadFactory`，用来创建线程。\n\n```java\n /**\n     * Creates a new {@code ThreadPoolExecutor} with the given initial\n     * parameters and default rejected execution handler.\n     *\n     * @param corePoolSize the number of threads to keep in the pool, even\n     *        if they are idle, unless {@code allowCoreThreadTimeOut} is set\n     * @param maximumPoolSize the maximum number of threads to allow in the\n     *        pool\n     * @param keepAliveTime when the number of threads is greater than\n     *        the core, this is the maximum time that excess idle threads\n     *        will wait for new tasks before terminating.\n     * @param unit the time unit for the {@code keepAliveTime} argument\n     * @param workQueue the queue to use for holding tasks before they are\n     *        executed.  This queue will hold only the {@code Runnable}\n     *        tasks submitted by the {@code execute} method.\n     * @param threadFactory the factory to use when the executor\n     *        creates a new thread\n     * @throws IllegalArgumentException if one of the following holds:<br>\n     *         {@code corePoolSize < 0}<br>\n     *         {@code keepAliveTime < 0}<br>\n     *         {@code maximumPoolSize <= 0}<br>\n     *         {@code maximumPoolSize < corePoolSize}\n     * @throws NullPointerException if {@code workQueue}\n     *         or {@code threadFactory} is null\n     */\n    public ThreadPoolExecutor(int corePoolSize,\n                              int maximumPoolSize,\n                              long keepAliveTime,\n                              TimeUnit unit,\n                              BlockingQueue<Runnable> workQueue,\n                              ThreadFactory threadFactory) {\n        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,\n             threadFactory, defaultHandler);\n    }\n```\n\n`ThreadFactory`接口只有一个方法，就是创建线程\n\n```java\npublic interface ThreadFactory {\n\n    /**\n     * Constructs a new {@code Thread}.  Implementations may also initialize\n     * priority, name, daemon status, {@code ThreadGroup}, etc.\n     *\n     * @param r a runnable to be executed by new thread instance\n     * @return constructed thread, or {@code null} if the request to\n     *         create a thread is rejected\n     */\n    Thread newThread(Runnable r);\n}\n```\n\n创建`Thread`时可以设置一些列的属性， 属性比较多，于是`guava`里有一个便利类 ———— `ThreadFactoryBuilder`。\n\n直接看`build`方法:\n\n```java\nprivate static ThreadFactory build(ThreadFactoryBuilder builder) {\n    final String nameFormat = builder.nameFormat;\n    final Boolean daemon = builder.daemon;\n    final Integer priority = builder.priority;\n    final UncaughtExceptionHandler uncaughtExceptionHandler =\n        builder.uncaughtExceptionHandler;\n    final ThreadFactory backingThreadFactory =\n        (builder.backingThreadFactory != null)\n        ? builder.backingThreadFactory\n        : Executors.defaultThreadFactory();\n    final AtomicLong count = (nameFormat != null) ? new AtomicLong(0) : null;\n    return new ThreadFactory() {\n      @Override public Thread newThread(Runnable runnable) {\n        Thread thread = backingThreadFactory.newThread(runnable);\n        if (nameFormat != null) {\n          thread.setName(format(nameFormat, count.getAndIncrement()));\n        }\n        if (daemon != null) {\n          thread.setDaemon(daemon);\n        }\n        if (priority != null) {\n          thread.setPriority(priority);\n        }\n        if (uncaughtExceptionHandler != null) {\n          thread.setUncaughtExceptionHandler(uncaughtExceptionHandler);\n        }\n        return thread;\n      }\n    };\n  }\n```\n\n使用起来挺顺手的：\n\n```java\n  private static ThreadPoolExecutor executor = new ThreadPoolExecutor(\n            10,\n            15,\n            10,\n            TimeUnit.SECONDS,\n            blockingQueue,\n            new ThreadFactoryBuilder().setNameFormat(\"guava-%d\").build(),\n            new ThreadPoolExecutor.DiscardPolicy()\n    );\n```\n\n主要就是给线程整一个名字，用`jstack`等工具排查问题时方便知道是哪个线程池里的。\n\n`jstack`的结果：\n\n```\n\"guava-9\" #19 prio=5 os_prio=0 tid=0x00007f5024468000 nid=0x5e3b waiting on condition [0x00007f50104f7000]\n   java.lang.Thread.State: WAITING (parking)\n        at sun.misc.Unsafe.park(Native Method)\n        - parking to wait for  <0x00000000d709af38> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)\n        at java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:403)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n```\n\n## 更多\n\n1. [ExecutorService-10个要诀和技巧 - ImportNew](http://www.importnew.com/20263.html)","slug":"ThreadFactoryBuilder","published":1,"updated":"2017-11-18T09:15:34.206Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8n004ljh4kjj4jhicu","content":"<h2 id=\"用法\"><a href=\"#用法\" class=\"headerlink\" title=\"用法\"></a>用法</h2><p>java中自定义线程池时可以传入一个<code>ThreadFactory</code>，用来创建线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Creates a new &#123;<span class=\"doctag\">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class=\"line\"><span class=\"comment\">    * parameters and default rejected execution handler.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class=\"line\"><span class=\"comment\">    *        if they are idle, unless &#123;<span class=\"doctag\">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class=\"line\"><span class=\"comment\">    *        pool</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class=\"line\"><span class=\"comment\">    *        the core, this is the maximum time that excess idle threads</span></span><br><span class=\"line\"><span class=\"comment\">    *        will wait for new tasks before terminating.</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> unit the time unit for the &#123;<span class=\"doctag\">@code</span> keepAliveTime&#125; argument</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class=\"line\"><span class=\"comment\">    *        executed.  This queue will hold only the &#123;<span class=\"doctag\">@code</span> Runnable&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    *        tasks submitted by the &#123;<span class=\"doctag\">@code</span> execute&#125; method.</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> threadFactory the factory to use when the executor</span></span><br><span class=\"line\"><span class=\"comment\">    *        creates a new thread</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span> NullPointerException if &#123;<span class=\"doctag\">@code</span> workQueue&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    *         or &#123;<span class=\"doctag\">@code</span> threadFactory&#125; is null</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ThreadPoolExecutor</span><span class=\"params\">(<span class=\"keyword\">int</span> corePoolSize,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             <span class=\"keyword\">int</span> maximumPoolSize,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             <span class=\"keyword\">long</span> keepAliveTime,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             TimeUnit unit,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class=\"line\">            threadFactory, defaultHandler);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p><code>ThreadFactory</code>接口只有一个方法，就是创建线程</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ThreadFactory</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Constructs a new &#123;<span class=\"doctag\">@code</span> Thread&#125;.  Implementations may also initialize</span></span><br><span class=\"line\"><span class=\"comment\">     * priority, name, daemon status, &#123;<span class=\"doctag\">@code</span> ThreadGroup&#125;, etc.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> r a runnable to be executed by new thread instance</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> constructed thread, or &#123;<span class=\"doctag\">@code</span> null&#125; if the request to</span></span><br><span class=\"line\"><span class=\"comment\">     *         create a thread is rejected</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">Thread <span class=\"title\">newThread</span><span class=\"params\">(Runnable r)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>创建<code>Thread</code>时可以设置一些列的属性， 属性比较多，于是<code>guava</code>里有一个便利类 ———— <code>ThreadFactoryBuilder</code>。</p>\n<p>直接看<code>build</code>方法:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ThreadFactory <span class=\"title\">build</span><span class=\"params\">(ThreadFactoryBuilder builder)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> String nameFormat = builder.nameFormat;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Boolean daemon = builder.daemon;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Integer priority = builder.priority;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> UncaughtExceptionHandler uncaughtExceptionHandler =</span><br><span class=\"line\">        builder.uncaughtExceptionHandler;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> ThreadFactory backingThreadFactory =</span><br><span class=\"line\">        (builder.backingThreadFactory != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        ? builder.backingThreadFactory</span><br><span class=\"line\">        : Executors.defaultThreadFactory();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> AtomicLong count = (nameFormat != <span class=\"keyword\">null</span>) ? <span class=\"keyword\">new</span> AtomicLong(<span class=\"number\">0</span>) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ThreadFactory() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span> <span class=\"function\"><span class=\"keyword\">public</span> Thread <span class=\"title\">newThread</span><span class=\"params\">(Runnable runnable)</span> </span>&#123;</span><br><span class=\"line\">        Thread thread = backingThreadFactory.newThread(runnable);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nameFormat != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setName(format(nameFormat, count.getAndIncrement()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (daemon != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setDaemon(daemon);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (priority != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setPriority(priority);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (uncaughtExceptionHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setUncaughtExceptionHandler(uncaughtExceptionHandler);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> thread;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>使用起来挺顺手的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ThreadPoolExecutor executor = <span class=\"keyword\">new</span> ThreadPoolExecutor(</span><br><span class=\"line\">          <span class=\"number\">10</span>,</span><br><span class=\"line\">          <span class=\"number\">15</span>,</span><br><span class=\"line\">          <span class=\"number\">10</span>,</span><br><span class=\"line\">          TimeUnit.SECONDS,</span><br><span class=\"line\">          blockingQueue,</span><br><span class=\"line\">          <span class=\"keyword\">new</span> ThreadFactoryBuilder().setNameFormat(<span class=\"string\">\"guava-%d\"</span>).build(),</span><br><span class=\"line\">          <span class=\"keyword\">new</span> ThreadPoolExecutor.DiscardPolicy()</span><br><span class=\"line\">  );</span><br></pre></td></tr></table></figure>\n<p>主要就是给线程整一个名字，用<code>jstack</code>等工具排查问题时方便知道是哪个线程池里的。</p>\n<p><code>jstack</code>的结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;guava-9&quot; #19 prio=5 os_prio=0 tid=0x00007f5024468000 nid=0x5e3b waiting on condition [0x00007f50104f7000]</span><br><span class=\"line\">   java.lang.Thread.State: WAITING (parking)</span><br><span class=\"line\">        at sun.misc.Unsafe.park(Native Method)</span><br><span class=\"line\">        - parking to wait for  &lt;0x00000000d709af38&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class=\"line\">        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class=\"line\">        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class=\"line\">        at java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:403)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>\n<h2 id=\"更多\"><a href=\"#更多\" class=\"headerlink\" title=\"更多\"></a>更多</h2><ol>\n<li><a href=\"http://www.importnew.com/20263.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">ExecutorService-10个要诀和技巧 - ImportNew</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"用法\"><a href=\"#用法\" class=\"headerlink\" title=\"用法\"></a>用法</h2><p>java中自定义线程池时可以传入一个<code>ThreadFactory</code>，用来创建线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Creates a new &#123;<span class=\"doctag\">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class=\"line\"><span class=\"comment\">    * parameters and default rejected execution handler.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class=\"line\"><span class=\"comment\">    *        if they are idle, unless &#123;<span class=\"doctag\">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class=\"line\"><span class=\"comment\">    *        pool</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class=\"line\"><span class=\"comment\">    *        the core, this is the maximum time that excess idle threads</span></span><br><span class=\"line\"><span class=\"comment\">    *        will wait for new tasks before terminating.</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> unit the time unit for the &#123;<span class=\"doctag\">@code</span> keepAliveTime&#125; argument</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class=\"line\"><span class=\"comment\">    *        executed.  This queue will hold only the &#123;<span class=\"doctag\">@code</span> Runnable&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    *        tasks submitted by the &#123;<span class=\"doctag\">@code</span> execute&#125; method.</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> threadFactory the factory to use when the executor</span></span><br><span class=\"line\"><span class=\"comment\">    *        creates a new thread</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span> NullPointerException if &#123;<span class=\"doctag\">@code</span> workQueue&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    *         or &#123;<span class=\"doctag\">@code</span> threadFactory&#125; is null</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ThreadPoolExecutor</span><span class=\"params\">(<span class=\"keyword\">int</span> corePoolSize,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             <span class=\"keyword\">int</span> maximumPoolSize,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             <span class=\"keyword\">long</span> keepAliveTime,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             TimeUnit unit,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                             ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class=\"line\">            threadFactory, defaultHandler);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p><code>ThreadFactory</code>接口只有一个方法，就是创建线程</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ThreadFactory</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Constructs a new &#123;<span class=\"doctag\">@code</span> Thread&#125;.  Implementations may also initialize</span></span><br><span class=\"line\"><span class=\"comment\">     * priority, name, daemon status, &#123;<span class=\"doctag\">@code</span> ThreadGroup&#125;, etc.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> r a runnable to be executed by new thread instance</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> constructed thread, or &#123;<span class=\"doctag\">@code</span> null&#125; if the request to</span></span><br><span class=\"line\"><span class=\"comment\">     *         create a thread is rejected</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">Thread <span class=\"title\">newThread</span><span class=\"params\">(Runnable r)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>创建<code>Thread</code>时可以设置一些列的属性， 属性比较多，于是<code>guava</code>里有一个便利类 ———— <code>ThreadFactoryBuilder</code>。</p>\n<p>直接看<code>build</code>方法:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ThreadFactory <span class=\"title\">build</span><span class=\"params\">(ThreadFactoryBuilder builder)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> String nameFormat = builder.nameFormat;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Boolean daemon = builder.daemon;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Integer priority = builder.priority;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> UncaughtExceptionHandler uncaughtExceptionHandler =</span><br><span class=\"line\">        builder.uncaughtExceptionHandler;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> ThreadFactory backingThreadFactory =</span><br><span class=\"line\">        (builder.backingThreadFactory != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        ? builder.backingThreadFactory</span><br><span class=\"line\">        : Executors.defaultThreadFactory();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> AtomicLong count = (nameFormat != <span class=\"keyword\">null</span>) ? <span class=\"keyword\">new</span> AtomicLong(<span class=\"number\">0</span>) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ThreadFactory() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span> <span class=\"function\"><span class=\"keyword\">public</span> Thread <span class=\"title\">newThread</span><span class=\"params\">(Runnable runnable)</span> </span>&#123;</span><br><span class=\"line\">        Thread thread = backingThreadFactory.newThread(runnable);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nameFormat != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setName(format(nameFormat, count.getAndIncrement()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (daemon != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setDaemon(daemon);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (priority != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setPriority(priority);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (uncaughtExceptionHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          thread.setUncaughtExceptionHandler(uncaughtExceptionHandler);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> thread;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>使用起来挺顺手的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ThreadPoolExecutor executor = <span class=\"keyword\">new</span> ThreadPoolExecutor(</span><br><span class=\"line\">          <span class=\"number\">10</span>,</span><br><span class=\"line\">          <span class=\"number\">15</span>,</span><br><span class=\"line\">          <span class=\"number\">10</span>,</span><br><span class=\"line\">          TimeUnit.SECONDS,</span><br><span class=\"line\">          blockingQueue,</span><br><span class=\"line\">          <span class=\"keyword\">new</span> ThreadFactoryBuilder().setNameFormat(<span class=\"string\">\"guava-%d\"</span>).build(),</span><br><span class=\"line\">          <span class=\"keyword\">new</span> ThreadPoolExecutor.DiscardPolicy()</span><br><span class=\"line\">  );</span><br></pre></td></tr></table></figure>\n<p>主要就是给线程整一个名字，用<code>jstack</code>等工具排查问题时方便知道是哪个线程池里的。</p>\n<p><code>jstack</code>的结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;guava-9&quot; #19 prio=5 os_prio=0 tid=0x00007f5024468000 nid=0x5e3b waiting on condition [0x00007f50104f7000]</span><br><span class=\"line\">   java.lang.Thread.State: WAITING (parking)</span><br><span class=\"line\">        at sun.misc.Unsafe.park(Native Method)</span><br><span class=\"line\">        - parking to wait for  &lt;0x00000000d709af38&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class=\"line\">        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class=\"line\">        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class=\"line\">        at java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:403)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>\n<h2 id=\"更多\"><a href=\"#更多\" class=\"headerlink\" title=\"更多\"></a>更多</h2><ol>\n<li><a href=\"http://www.importnew.com/20263.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">ExecutorService-10个要诀和技巧 - ImportNew</a></li>\n</ol>\n"},{"title":"Spring MVC 中的异常处理","toc":true,"abbrlink":45325,"date":"2017-01-08T17:57:08.000Z","_content":"\n\n## Spring MVC的异常处理\n\nSpring中的异常处理主要有两种方式，*一种*是实现`HandlerExceptionResolver`接口，\n\n这个接口中只有一个方法`resolveException`，返回值是一个`ModelAndView`的对象; \n\n*另外一种*是使用`@ExceptionHandler`注解作用在方法上，注解的值来指定这个方法能处理的异常的类，\n\n如果注解的值是空的，能处理的类以方法的参数为准。\n\n```java\npublic interface HandlerExceptionResolver {\n\n    /**\n     * Try to resolve the given exception that got thrown during handler execution,\n     * returning a {@link ModelAndView} that represents a specific error page if appropriate.\n     * <p>The returned {@code ModelAndView} may be {@linkplain ModelAndView#isEmpty() empty}\n     * to indicate that the exception has been resolved successfully but that no view\n     * should be rendered, for instance by setting a status code.\n     * @param request current HTTP request\n     * @param response current HTTP response\n     * @param handler the executed handler, or {@code null} if none chosen at the\n     * time of the exception (for example, if multipart resolution failed)\n     * @param ex the exception that got thrown during handler execution\n     * @return a corresponding {@code ModelAndView} to forward to, or {@code null}\n     * for default processing\n     */\n    ModelAndView resolveException(\n            HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex);\n\n}\n\n//@ExceptionHandler\n@Controller\npublic class SimpleController {\n\n    // @RequestMapping methods omitted ...\n\n    @ExceptionHandler(IOException.class)\n    public ResponseEntity<String> handleIOException(IOException ex) {\n        // prepare responseEntity\n        return responseEntity;\n    }\n\n}\n```\n\n### 异常相关的类\n\n{% pullquote mindmap %}\n#Spring MVC Exception\n##HandlerExceptionResolver\n###SimpleMappingExceptionResolver\n###DefaultHandlerExceptionResolver\n##@ExceptionHandler\n###@ControllerAdvice\n###ResponseEntityExceptionHandler\n##Default Servlet Container Error Page\n##@ResponseStatus\n###ResponseStatusExceptionResolver\n{% endpullquote %}\n\n### `SimpleMappingExceptionResolver`\n\n> The SimpleMappingExceptionResolver enables you to take the\nclass name of any exception that might be thrown and map it to a view name. \n\n这个Resolver可以将异常对应的类名映射到一个对应的view name上。\n\n```xml\n<bean class=\"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver\">\n    <property name=\"exceptionMappings\">\n        <props>\n            <prop key=\"com.howtodoinjava.demo.exception.AuthException\">\n                error/authExceptionView\n            </prop>\n        </props>\n    </property>\n    <property name=\"defaultErrorView\" value=\"error/genericView\"/>\n</bean>\n```\n\n### `DefaultHandlerExceptionResolver`\n\n> The DefaultHandlerExceptionResolver translates Spring MVC exceptions to specific error\nstatus codes.\n\n这个Resolver的作用就是将Spring MVC产生的一些异常翻译成对应的http status code。Spring MVC中\n\n默认注册了这个Resolver。\n\n转换列表：\n\n| Exception   |                    HTTP Status Code|\n| --- | ----- |\n| BindException   |                   400 (Bad Request)|\n| ConversionNotSupportedException   |                   500 (Internal Server Error)|\n| HttpMediaTypeNotAcceptableException   |                   406 (Not Acceptable)|\n| HttpMediaTypeNotSupportedException   |                   415 (Unsupported Media Type)|\n| HttpMessageNotReadableException   |                   400 (Bad Request)|\n| HttpMessageNotWritableException   |                   500 (Internal Server Error)|\n| HttpRequestMethodNotSupportedException   |                   405 (Method Not Allowed)|\n| MethodArgumentNotValidException   |                   400 (Bad Request)|\n| MissingPathVariableException   |                   500 (Internal Server Error)|\n| MissingServletRequestParameterException   |                   400 (Bad Request)|\n| MissingServletRequestPartException   |                   400 (Bad Request)|\n| NoHandlerFoundException   |                   404 (Not Found)|\n| NoSuchRequestHandlingMethodException   |                   404 (Not Found)|\n\n### @ExceptionHandler和@ControllerAdvice\n\n`@ExceptionHandler` 可以指定异常的处理类，`@ControllerAdvice`则可以实现全局的异常统一处理。\n\n两者可配合使用，达到统一处理异常的效果。\n\n\n> The @ControllerAdvice annotation is a component annotation allowing implementation classes\nto be auto-detected through classpath scanning. It is automatically enabled when using the MVC\nnamespace or the MVC Java config.\n\n`@ControllerAdvice`默认在Spring MVC的命名空间中启用。\n\n> Classes annotated with @ControllerAdvice can contain @ExceptionHandler, @InitBinder,\nand @ModelAttribute annotated methods, and these methods will apply to @RequestMapping\nmethods across all controller hierarchies as opposed to the controller hierarchy within which they are\ndeclared.\n\n`@ControllerAdvice`声明的异常处理方法默认对全局都是有效的。\n\n```java\n// Target all Controllers annotated with @RestController\n@ControllerAdvice(annotations = RestController.class)\npublic class AnnotationAdvice {}\n\n// Target all Controllers within specific packages\n@ControllerAdvice(\"org.example.controllers\")\npublic class BasePackageAdvice {}\n\n// Target all Controllers assignable to specific classes\n@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})\npublic class AssignableTypesAdvice {}\n```\n\n还有一个`@RestControllerAdvice`和`@ControllerAdvice`相似，只是假定`@ResponseBody`出现在`@ExceptionHandler`上\n\n> @RestControllerAdvice is an alternative where @ExceptionHandler methods assume\n@ResponseBody semantics by default.\n\n### `ResponseEntityExceptionHandler`\n\n如果你想使用`@ExceptionHandler`来处理异常的话， 你可以继承这个类。\n\n这个类中定义好了一个异常处理的方法，来处理Spring MVC 的标准异常。\n\n```java\n/**\n     * Provides handling for standard Spring MVC exceptions.\n     * @param ex the target exception\n     * @param request the current request\n     */\n    @ExceptionHandler({\n            NoSuchRequestHandlingMethodException.class,\n            HttpRequestMethodNotSupportedException.class,\n            HttpMediaTypeNotSupportedException.class,\n            HttpMediaTypeNotAcceptableException.class,\n            MissingPathVariableException.class,\n            MissingServletRequestParameterException.class,\n            ServletRequestBindingException.class,\n            ConversionNotSupportedException.class,\n            TypeMismatchException.class,\n            HttpMessageNotReadableException.class,\n            HttpMessageNotWritableException.class,\n            MethodArgumentNotValidException.class,\n            MissingServletRequestPartException.class,\n            BindException.class,\n            NoHandlerFoundException.class\n        })\n    public final ResponseEntity<Object> handleException(Exception ex, WebRequest request) {\n\n            HttpHeaders headers = new HttpHeaders();\n\n            if (ex instanceof NoSuchRequestHandlingMethodException) {\n                HttpStatus status = HttpStatus.NOT_FOUND;\n                return handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, headers, status, request);\n            }\n            ...\n            ...\n    }\n```\n\n\n\n### @ResponseStatus\n\n用于在自定义异常，设置http的状态码\n\n```java\n    @ResponseStatus(value=HttpStatus.NOT_FOUND, reason=\"No such Order\")  // 404\n    public class OrderNotFoundException extends RuntimeException {\n        // ...\n    }\n```\n\nSpring MVC 中默认开启了`ResponseStatusExceptionResolver`，这个Resolver会处理上面\n\n设置的Http status code。\n\n> A business exception can be annotated with @ResponseStatus. When the exception is raised, the\nResponseStatusExceptionResolver handles it by setting the status of the response accordingly.\nBy default the DispatcherServlet registers the ResponseStatusExceptionResolver and it is\navailable for use.\n\n```java\n@Override\n    protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response,\n            Object handler, Exception ex) {\n\n        ResponseStatus responseStatus = AnnotatedElementUtils.findMergedAnnotation(ex.getClass(), ResponseStatus.class);\n        if (responseStatus != null) {\n            try {\n                return resolveResponseStatus(responseStatus, request, response, handler, ex);\n            }\n            catch (Exception resolveEx) {\n                logger.warn(\"Handling of @ResponseStatus resulted in Exception\", resolveEx);\n            }\n        }\n        else if (ex.getCause() instanceof Exception) {\n            ex = (Exception) ex.getCause();\n            return doResolveException(request, response, handler, ex);\n        }\n        return null;\n    }\n```\n\n通过工具类拿到注解上的值，然后调用内部的`resolveResponseStatus`\n\n```java\nprotected ModelAndView resolveResponseStatus(ResponseStatus responseStatus, HttpServletRequest request,\n            HttpServletResponse response, Object handler, Exception ex) throws Exception {\n\n        int statusCode = responseStatus.code().value();\n        String reason = responseStatus.reason();\n        if (this.messageSource != null) {\n            reason = this.messageSource.getMessage(reason, null, reason, LocaleContextHolder.getLocale());\n        }\n        if (!StringUtils.hasLength(reason)) {\n            response.sendError(statusCode);\n        }\n        else {\n            response.sendError(statusCode, reason);\n        }\n        return new ModelAndView();\n    }\n```\n\n最终将http status code 设置到reponse中。\n\n\n\n### 源码\n\n\nSpring MVC 的异常处理在`DispatcherServlet`的`doDispatch`方法中\n\n```java\nprotected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n        HttpServletRequest processedRequest = request;\n        HandlerExecutionChain mappedHandler = null;\n        boolean multipartRequestParsed = false;\n\n        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n        try {\n            ModelAndView mv = null;\n            Exception dispatchException = null;\n\n            try {\n                //do Handle\n                ...\n                }\n            catch (Exception ex) {\n                dispatchException = ex;\n            }\n            processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n        }\n        catch (Exception ex) {\n            triggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n        }\n        catch (Error err) {\n            triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);\n        }\n        finally {\n            //post process\n        }\n}\n\n```\n在内层的`try-catch`中有一个方法`processDispatchResult`, 在这个方法之前的catch块已经将处理过程可能出现的异常catch住了，并赋值给 `dispatchException`.\n\n然后调用`processDispatchResult`分发给能处理这个异常的`ExceptionResolver`。\n\n```java\n    /**\n     * Handle the result of handler selection and handler invocation, which is\n     * either a ModelAndView or an Exception to be resolved to a ModelAndView.\n     */\n    private void processDispatchResult(HttpServletRequest request, HttpServletResponse response,\n            HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception) throws Exception {\n\n        boolean errorView = false;\n\n        if (exception != null) {\n            if (exception instanceof ModelAndViewDefiningException) {\n                logger.debug(\"ModelAndViewDefiningException encountered\", exception);\n                mv = ((ModelAndViewDefiningException) exception).getModelAndView();\n            }\n            else {\n                Object handler = (mappedHandler != null ? mappedHandler.getHandler() : null);\n                mv = processHandlerException(request, response, handler, exception);\n                errorView = (mv != null);\n            }\n        }\n\n        // Did the handler return a view to render?\n        if (mv != null && !mv.wasCleared()) {\n            render(mv, request, response);\n            if (errorView) {\n                WebUtils.clearErrorRequestAttributes(request);\n            }\n        }\n        else {\n            if (logger.isDebugEnabled()) {\n                logger.debug(\"Null ModelAndView returned to DispatcherServlet with name '\" + getServletName() +\n                        \"': assuming HandlerAdapter completed request handling\");\n            }\n        }\n\n        if (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n            // Concurrent handling started during a forward\n            return;\n        }\n\n        if (mappedHandler != null) {\n            mappedHandler.triggerAfterCompletion(request, response, null);\n        }\n    }\n\nprotected ModelAndView processHandlerException(HttpServletRequest request, HttpServletResponse response,\n            Object handler, Exception ex) throws Exception {\n\n        // Check registered HandlerExceptionResolvers...\n        ModelAndView exMv = null;\n        for (HandlerExceptionResolver handlerExceptionResolver : this.handlerExceptionResolvers) {\n            exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);\n            if (exMv != null) {\n                break;\n            }\n        }\n        if (exMv != null) {\n            if (exMv.isEmpty()) {\n                request.setAttribute(EXCEPTION_ATTRIBUTE, ex);\n                return null;\n            }\n            // We might still need view name translation for a plain error model...\n            if (!exMv.hasView()) {\n                exMv.setViewName(getDefaultViewName(request));\n            }\n            if (logger.isDebugEnabled()) {\n                logger.debug(\"Handler execution resulted in exception - forwarding to resolved error view: \" + exMv, ex);\n            }\n            WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());\n            return exMv;\n        }\n\n        throw ex;\n    }\n\n```\n\n这个异常的处理和之前，查找handler的过程是一样的。\n\n遍历所有已经注册的`HandlerExceptionResolver`, 找到第一个能处理的。\n\n#### @ExceptionHandler的处理\n\n```java\n/**\n * Implementation of the {@link org.springframework.web.portlet.HandlerExceptionResolver} interface that handles\n * exceptions through the {@link ExceptionHandler} annotation.\n *\n * <p>This exception resolver is enabled by default in the {@link org.springframework.web.portlet.DispatcherPortlet}.\n *\n * @author Arjen Poutsma\n * @author Juergen Hoeller\n * @since 3.0\n */\npublic class AnnotationMethodHandlerExceptionResolver extends AbstractHandlerExceptionResolver {\n    ...\n\n    @Override\n    protected ModelAndView doResolveException(\n            PortletRequest request, MimeResponse response, Object handler, Exception ex) {\n\n        if (handler != null) {\n            Method handlerMethod = findBestExceptionHandlerMethod(handler, ex);\n            if (handlerMethod != null) {\n                NativeWebRequest webRequest = new PortletWebRequest(request, response);\n                try {\n                    Object[] args = resolveHandlerArguments(handlerMethod, handler, webRequest, ex);\n                    if (logger.isDebugEnabled()) {\n                        logger.debug(\"Invoking request handler method: \" + handlerMethod);\n                    }\n                    Object retVal = doInvokeMethod(handlerMethod, handler, args);\n                    return getModelAndView(retVal);\n                }\n                catch (Exception invocationEx) {\n                    logger.error(\"Invoking request method resulted in exception : \" + handlerMethod, invocationEx);\n                }\n            }\n        }\n        return null;\n    }\n\n}\n\n```\n\n和普通的处理类似，从所有标注了`@ExceptionHandler`的方法中找到最佳匹配，然后解析参数，调用。\n\n## web容器的错误处理\n\n`WEB-INF/web.xml`\n\n```xml\n<error-page>\n    <error-code>500</error-code>\n    <location>/Error.jsp</location>\n</error-page>\n\n<error-page>\n    <exception-type>java.lang.Exception</exception-type>\n    <location>/Error.jsp</location>\n</error-page>\n```\n\nlocation中的值可以是一个jsp，也可以是一个URL（包括`@Controller`注解的）\n\n处理error的Controller示例：\n\n```java\n@Controller\npublic class ErrorController {\n\n    @RequestMapping(path = \"/error\", produces = MediaType.APPLICATION_JSON_UTF8_VALUE)\n    @ResponseBody\n    public Map<String, Object> handle(HttpServletRequest request) {\n\n        Map<String, Object> map = new HashMap<String, Object>();\n        map.put(\"status\", request.getAttribute(\"javax.servlet.error.status_code\"));\n        map.put(\"reason\", request.getAttribute(\"javax.servlet.error.message\"));\n\n        return map;\n    }\n\n}\n```\n\nJSP示例：\n\n```\n<%@ page contentType=\"application/json\" pageEncoding=\"UTF-8\"%>\n{\nstatus:<%=request.getAttribute(\"javax.servlet.error.status_code\") %>,\nreason:<%=request.getAttribute(\"javax.servlet.error.message\") %>\n}\n```\n\n\n## 参考\n\n1. [SpringMVC 异常处理 - 纵酒挥刀斩人头 - 博客园](http://www.cnblogs.com/hupengcool/p/4586910.html)\n\n2. [22. Web MVC framework](https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-exceptionhandlers)\n\n3. [Spring MVC Mapping Exceptions to Views Example | Spring MVC SimpleMappingExceptionResolver Example](http://howtodoinjava.com/spring/spring-mvc/spring-mvc-simplemappingexceptionresolver-example/)\n\n4. [java - Custom Error Page in Tomcat 7 for Error Code 500 - Stack Overflow](http://stackoverflow.com/questions/15987212/custom-error-page-in-tomcat-7-for-error-code-500)","source":"_posts/Spring-mvc-exception.md","raw":"---\ntitle: Spring MVC 中的异常处理\ntags: exception\ncategory: spring\ntoc: true\nabbrlink: 45325\ndate: 2017-01-09 01:57:08\n---\n\n\n## Spring MVC的异常处理\n\nSpring中的异常处理主要有两种方式，*一种*是实现`HandlerExceptionResolver`接口，\n\n这个接口中只有一个方法`resolveException`，返回值是一个`ModelAndView`的对象; \n\n*另外一种*是使用`@ExceptionHandler`注解作用在方法上，注解的值来指定这个方法能处理的异常的类，\n\n如果注解的值是空的，能处理的类以方法的参数为准。\n\n```java\npublic interface HandlerExceptionResolver {\n\n    /**\n     * Try to resolve the given exception that got thrown during handler execution,\n     * returning a {@link ModelAndView} that represents a specific error page if appropriate.\n     * <p>The returned {@code ModelAndView} may be {@linkplain ModelAndView#isEmpty() empty}\n     * to indicate that the exception has been resolved successfully but that no view\n     * should be rendered, for instance by setting a status code.\n     * @param request current HTTP request\n     * @param response current HTTP response\n     * @param handler the executed handler, or {@code null} if none chosen at the\n     * time of the exception (for example, if multipart resolution failed)\n     * @param ex the exception that got thrown during handler execution\n     * @return a corresponding {@code ModelAndView} to forward to, or {@code null}\n     * for default processing\n     */\n    ModelAndView resolveException(\n            HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex);\n\n}\n\n//@ExceptionHandler\n@Controller\npublic class SimpleController {\n\n    // @RequestMapping methods omitted ...\n\n    @ExceptionHandler(IOException.class)\n    public ResponseEntity<String> handleIOException(IOException ex) {\n        // prepare responseEntity\n        return responseEntity;\n    }\n\n}\n```\n\n### 异常相关的类\n\n{% pullquote mindmap %}\n#Spring MVC Exception\n##HandlerExceptionResolver\n###SimpleMappingExceptionResolver\n###DefaultHandlerExceptionResolver\n##@ExceptionHandler\n###@ControllerAdvice\n###ResponseEntityExceptionHandler\n##Default Servlet Container Error Page\n##@ResponseStatus\n###ResponseStatusExceptionResolver\n{% endpullquote %}\n\n### `SimpleMappingExceptionResolver`\n\n> The SimpleMappingExceptionResolver enables you to take the\nclass name of any exception that might be thrown and map it to a view name. \n\n这个Resolver可以将异常对应的类名映射到一个对应的view name上。\n\n```xml\n<bean class=\"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver\">\n    <property name=\"exceptionMappings\">\n        <props>\n            <prop key=\"com.howtodoinjava.demo.exception.AuthException\">\n                error/authExceptionView\n            </prop>\n        </props>\n    </property>\n    <property name=\"defaultErrorView\" value=\"error/genericView\"/>\n</bean>\n```\n\n### `DefaultHandlerExceptionResolver`\n\n> The DefaultHandlerExceptionResolver translates Spring MVC exceptions to specific error\nstatus codes.\n\n这个Resolver的作用就是将Spring MVC产生的一些异常翻译成对应的http status code。Spring MVC中\n\n默认注册了这个Resolver。\n\n转换列表：\n\n| Exception   |                    HTTP Status Code|\n| --- | ----- |\n| BindException   |                   400 (Bad Request)|\n| ConversionNotSupportedException   |                   500 (Internal Server Error)|\n| HttpMediaTypeNotAcceptableException   |                   406 (Not Acceptable)|\n| HttpMediaTypeNotSupportedException   |                   415 (Unsupported Media Type)|\n| HttpMessageNotReadableException   |                   400 (Bad Request)|\n| HttpMessageNotWritableException   |                   500 (Internal Server Error)|\n| HttpRequestMethodNotSupportedException   |                   405 (Method Not Allowed)|\n| MethodArgumentNotValidException   |                   400 (Bad Request)|\n| MissingPathVariableException   |                   500 (Internal Server Error)|\n| MissingServletRequestParameterException   |                   400 (Bad Request)|\n| MissingServletRequestPartException   |                   400 (Bad Request)|\n| NoHandlerFoundException   |                   404 (Not Found)|\n| NoSuchRequestHandlingMethodException   |                   404 (Not Found)|\n\n### @ExceptionHandler和@ControllerAdvice\n\n`@ExceptionHandler` 可以指定异常的处理类，`@ControllerAdvice`则可以实现全局的异常统一处理。\n\n两者可配合使用，达到统一处理异常的效果。\n\n\n> The @ControllerAdvice annotation is a component annotation allowing implementation classes\nto be auto-detected through classpath scanning. It is automatically enabled when using the MVC\nnamespace or the MVC Java config.\n\n`@ControllerAdvice`默认在Spring MVC的命名空间中启用。\n\n> Classes annotated with @ControllerAdvice can contain @ExceptionHandler, @InitBinder,\nand @ModelAttribute annotated methods, and these methods will apply to @RequestMapping\nmethods across all controller hierarchies as opposed to the controller hierarchy within which they are\ndeclared.\n\n`@ControllerAdvice`声明的异常处理方法默认对全局都是有效的。\n\n```java\n// Target all Controllers annotated with @RestController\n@ControllerAdvice(annotations = RestController.class)\npublic class AnnotationAdvice {}\n\n// Target all Controllers within specific packages\n@ControllerAdvice(\"org.example.controllers\")\npublic class BasePackageAdvice {}\n\n// Target all Controllers assignable to specific classes\n@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})\npublic class AssignableTypesAdvice {}\n```\n\n还有一个`@RestControllerAdvice`和`@ControllerAdvice`相似，只是假定`@ResponseBody`出现在`@ExceptionHandler`上\n\n> @RestControllerAdvice is an alternative where @ExceptionHandler methods assume\n@ResponseBody semantics by default.\n\n### `ResponseEntityExceptionHandler`\n\n如果你想使用`@ExceptionHandler`来处理异常的话， 你可以继承这个类。\n\n这个类中定义好了一个异常处理的方法，来处理Spring MVC 的标准异常。\n\n```java\n/**\n     * Provides handling for standard Spring MVC exceptions.\n     * @param ex the target exception\n     * @param request the current request\n     */\n    @ExceptionHandler({\n            NoSuchRequestHandlingMethodException.class,\n            HttpRequestMethodNotSupportedException.class,\n            HttpMediaTypeNotSupportedException.class,\n            HttpMediaTypeNotAcceptableException.class,\n            MissingPathVariableException.class,\n            MissingServletRequestParameterException.class,\n            ServletRequestBindingException.class,\n            ConversionNotSupportedException.class,\n            TypeMismatchException.class,\n            HttpMessageNotReadableException.class,\n            HttpMessageNotWritableException.class,\n            MethodArgumentNotValidException.class,\n            MissingServletRequestPartException.class,\n            BindException.class,\n            NoHandlerFoundException.class\n        })\n    public final ResponseEntity<Object> handleException(Exception ex, WebRequest request) {\n\n            HttpHeaders headers = new HttpHeaders();\n\n            if (ex instanceof NoSuchRequestHandlingMethodException) {\n                HttpStatus status = HttpStatus.NOT_FOUND;\n                return handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, headers, status, request);\n            }\n            ...\n            ...\n    }\n```\n\n\n\n### @ResponseStatus\n\n用于在自定义异常，设置http的状态码\n\n```java\n    @ResponseStatus(value=HttpStatus.NOT_FOUND, reason=\"No such Order\")  // 404\n    public class OrderNotFoundException extends RuntimeException {\n        // ...\n    }\n```\n\nSpring MVC 中默认开启了`ResponseStatusExceptionResolver`，这个Resolver会处理上面\n\n设置的Http status code。\n\n> A business exception can be annotated with @ResponseStatus. When the exception is raised, the\nResponseStatusExceptionResolver handles it by setting the status of the response accordingly.\nBy default the DispatcherServlet registers the ResponseStatusExceptionResolver and it is\navailable for use.\n\n```java\n@Override\n    protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response,\n            Object handler, Exception ex) {\n\n        ResponseStatus responseStatus = AnnotatedElementUtils.findMergedAnnotation(ex.getClass(), ResponseStatus.class);\n        if (responseStatus != null) {\n            try {\n                return resolveResponseStatus(responseStatus, request, response, handler, ex);\n            }\n            catch (Exception resolveEx) {\n                logger.warn(\"Handling of @ResponseStatus resulted in Exception\", resolveEx);\n            }\n        }\n        else if (ex.getCause() instanceof Exception) {\n            ex = (Exception) ex.getCause();\n            return doResolveException(request, response, handler, ex);\n        }\n        return null;\n    }\n```\n\n通过工具类拿到注解上的值，然后调用内部的`resolveResponseStatus`\n\n```java\nprotected ModelAndView resolveResponseStatus(ResponseStatus responseStatus, HttpServletRequest request,\n            HttpServletResponse response, Object handler, Exception ex) throws Exception {\n\n        int statusCode = responseStatus.code().value();\n        String reason = responseStatus.reason();\n        if (this.messageSource != null) {\n            reason = this.messageSource.getMessage(reason, null, reason, LocaleContextHolder.getLocale());\n        }\n        if (!StringUtils.hasLength(reason)) {\n            response.sendError(statusCode);\n        }\n        else {\n            response.sendError(statusCode, reason);\n        }\n        return new ModelAndView();\n    }\n```\n\n最终将http status code 设置到reponse中。\n\n\n\n### 源码\n\n\nSpring MVC 的异常处理在`DispatcherServlet`的`doDispatch`方法中\n\n```java\nprotected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n        HttpServletRequest processedRequest = request;\n        HandlerExecutionChain mappedHandler = null;\n        boolean multipartRequestParsed = false;\n\n        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n        try {\n            ModelAndView mv = null;\n            Exception dispatchException = null;\n\n            try {\n                //do Handle\n                ...\n                }\n            catch (Exception ex) {\n                dispatchException = ex;\n            }\n            processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n        }\n        catch (Exception ex) {\n            triggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n        }\n        catch (Error err) {\n            triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);\n        }\n        finally {\n            //post process\n        }\n}\n\n```\n在内层的`try-catch`中有一个方法`processDispatchResult`, 在这个方法之前的catch块已经将处理过程可能出现的异常catch住了，并赋值给 `dispatchException`.\n\n然后调用`processDispatchResult`分发给能处理这个异常的`ExceptionResolver`。\n\n```java\n    /**\n     * Handle the result of handler selection and handler invocation, which is\n     * either a ModelAndView or an Exception to be resolved to a ModelAndView.\n     */\n    private void processDispatchResult(HttpServletRequest request, HttpServletResponse response,\n            HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception) throws Exception {\n\n        boolean errorView = false;\n\n        if (exception != null) {\n            if (exception instanceof ModelAndViewDefiningException) {\n                logger.debug(\"ModelAndViewDefiningException encountered\", exception);\n                mv = ((ModelAndViewDefiningException) exception).getModelAndView();\n            }\n            else {\n                Object handler = (mappedHandler != null ? mappedHandler.getHandler() : null);\n                mv = processHandlerException(request, response, handler, exception);\n                errorView = (mv != null);\n            }\n        }\n\n        // Did the handler return a view to render?\n        if (mv != null && !mv.wasCleared()) {\n            render(mv, request, response);\n            if (errorView) {\n                WebUtils.clearErrorRequestAttributes(request);\n            }\n        }\n        else {\n            if (logger.isDebugEnabled()) {\n                logger.debug(\"Null ModelAndView returned to DispatcherServlet with name '\" + getServletName() +\n                        \"': assuming HandlerAdapter completed request handling\");\n            }\n        }\n\n        if (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n            // Concurrent handling started during a forward\n            return;\n        }\n\n        if (mappedHandler != null) {\n            mappedHandler.triggerAfterCompletion(request, response, null);\n        }\n    }\n\nprotected ModelAndView processHandlerException(HttpServletRequest request, HttpServletResponse response,\n            Object handler, Exception ex) throws Exception {\n\n        // Check registered HandlerExceptionResolvers...\n        ModelAndView exMv = null;\n        for (HandlerExceptionResolver handlerExceptionResolver : this.handlerExceptionResolvers) {\n            exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);\n            if (exMv != null) {\n                break;\n            }\n        }\n        if (exMv != null) {\n            if (exMv.isEmpty()) {\n                request.setAttribute(EXCEPTION_ATTRIBUTE, ex);\n                return null;\n            }\n            // We might still need view name translation for a plain error model...\n            if (!exMv.hasView()) {\n                exMv.setViewName(getDefaultViewName(request));\n            }\n            if (logger.isDebugEnabled()) {\n                logger.debug(\"Handler execution resulted in exception - forwarding to resolved error view: \" + exMv, ex);\n            }\n            WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());\n            return exMv;\n        }\n\n        throw ex;\n    }\n\n```\n\n这个异常的处理和之前，查找handler的过程是一样的。\n\n遍历所有已经注册的`HandlerExceptionResolver`, 找到第一个能处理的。\n\n#### @ExceptionHandler的处理\n\n```java\n/**\n * Implementation of the {@link org.springframework.web.portlet.HandlerExceptionResolver} interface that handles\n * exceptions through the {@link ExceptionHandler} annotation.\n *\n * <p>This exception resolver is enabled by default in the {@link org.springframework.web.portlet.DispatcherPortlet}.\n *\n * @author Arjen Poutsma\n * @author Juergen Hoeller\n * @since 3.0\n */\npublic class AnnotationMethodHandlerExceptionResolver extends AbstractHandlerExceptionResolver {\n    ...\n\n    @Override\n    protected ModelAndView doResolveException(\n            PortletRequest request, MimeResponse response, Object handler, Exception ex) {\n\n        if (handler != null) {\n            Method handlerMethod = findBestExceptionHandlerMethod(handler, ex);\n            if (handlerMethod != null) {\n                NativeWebRequest webRequest = new PortletWebRequest(request, response);\n                try {\n                    Object[] args = resolveHandlerArguments(handlerMethod, handler, webRequest, ex);\n                    if (logger.isDebugEnabled()) {\n                        logger.debug(\"Invoking request handler method: \" + handlerMethod);\n                    }\n                    Object retVal = doInvokeMethod(handlerMethod, handler, args);\n                    return getModelAndView(retVal);\n                }\n                catch (Exception invocationEx) {\n                    logger.error(\"Invoking request method resulted in exception : \" + handlerMethod, invocationEx);\n                }\n            }\n        }\n        return null;\n    }\n\n}\n\n```\n\n和普通的处理类似，从所有标注了`@ExceptionHandler`的方法中找到最佳匹配，然后解析参数，调用。\n\n## web容器的错误处理\n\n`WEB-INF/web.xml`\n\n```xml\n<error-page>\n    <error-code>500</error-code>\n    <location>/Error.jsp</location>\n</error-page>\n\n<error-page>\n    <exception-type>java.lang.Exception</exception-type>\n    <location>/Error.jsp</location>\n</error-page>\n```\n\nlocation中的值可以是一个jsp，也可以是一个URL（包括`@Controller`注解的）\n\n处理error的Controller示例：\n\n```java\n@Controller\npublic class ErrorController {\n\n    @RequestMapping(path = \"/error\", produces = MediaType.APPLICATION_JSON_UTF8_VALUE)\n    @ResponseBody\n    public Map<String, Object> handle(HttpServletRequest request) {\n\n        Map<String, Object> map = new HashMap<String, Object>();\n        map.put(\"status\", request.getAttribute(\"javax.servlet.error.status_code\"));\n        map.put(\"reason\", request.getAttribute(\"javax.servlet.error.message\"));\n\n        return map;\n    }\n\n}\n```\n\nJSP示例：\n\n```\n<%@ page contentType=\"application/json\" pageEncoding=\"UTF-8\"%>\n{\nstatus:<%=request.getAttribute(\"javax.servlet.error.status_code\") %>,\nreason:<%=request.getAttribute(\"javax.servlet.error.message\") %>\n}\n```\n\n\n## 参考\n\n1. [SpringMVC 异常处理 - 纵酒挥刀斩人头 - 博客园](http://www.cnblogs.com/hupengcool/p/4586910.html)\n\n2. [22. Web MVC framework](https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-exceptionhandlers)\n\n3. [Spring MVC Mapping Exceptions to Views Example | Spring MVC SimpleMappingExceptionResolver Example](http://howtodoinjava.com/spring/spring-mvc/spring-mvc-simplemappingexceptionresolver-example/)\n\n4. [java - Custom Error Page in Tomcat 7 for Error Code 500 - Stack Overflow](http://stackoverflow.com/questions/15987212/custom-error-page-in-tomcat-7-for-error-code-500)","slug":"Spring-mvc-exception","published":1,"updated":"2017-04-16T12:03:23.385Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8o004ojh4kii72i3l0","content":"<h2 id=\"Spring-MVC的异常处理\"><a href=\"#Spring-MVC的异常处理\" class=\"headerlink\" title=\"Spring MVC的异常处理\"></a>Spring MVC的异常处理</h2><p>Spring中的异常处理主要有两种方式，<em>一种</em>是实现<code>HandlerExceptionResolver</code>接口，</p>\n<p>这个接口中只有一个方法<code>resolveException</code>，返回值是一个<code>ModelAndView</code>的对象; </p>\n<p><em>另外一种</em>是使用<code>@ExceptionHandler</code>注解作用在方法上，注解的值来指定这个方法能处理的异常的类，</p>\n<p>如果注解的值是空的，能处理的类以方法的参数为准。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">HandlerExceptionResolver</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Try to resolve the given exception that got thrown during handler execution,</span></span><br><span class=\"line\"><span class=\"comment\">     * returning a &#123;<span class=\"doctag\">@link</span> ModelAndView&#125; that represents a specific error page if appropriate.</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;The returned &#123;<span class=\"doctag\">@code</span> ModelAndView&#125; may be &#123;<span class=\"doctag\">@linkplain</span> ModelAndView#isEmpty() empty&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     * to indicate that the exception has been resolved successfully but that no view</span></span><br><span class=\"line\"><span class=\"comment\">     * should be rendered, for instance by setting a status code.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> response current HTTP response</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> handler the executed handler, or &#123;<span class=\"doctag\">@code</span> null&#125; if none chosen at the</span></span><br><span class=\"line\"><span class=\"comment\">     * time of the exception (for example, if multipart resolution failed)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ex the exception that got thrown during handler execution</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> a corresponding &#123;<span class=\"doctag\">@code</span> ModelAndView&#125; to forward to, or &#123;<span class=\"doctag\">@code</span> null&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     * for default processing</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">ModelAndView <span class=\"title\">resolveException</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//@ExceptionHandler</span></span><br><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// @RequestMapping methods omitted ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@ExceptionHandler</span>(IOException.class)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">handleIOException</span><span class=\"params\">(IOException ex)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// prepare responseEntity</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseEntity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"异常相关的类\"><a href=\"#异常相关的类\" class=\"headerlink\" title=\"异常相关的类\"></a>异常相关的类</h3><blockquote class=\"pullquote mindmap\"><p>#Spring MVC Exception</p>\n<p>##HandlerExceptionResolver</p>\n<p>###SimpleMappingExceptionResolver</p>\n<p>###DefaultHandlerExceptionResolver</p>\n<p>##@ExceptionHandler</p>\n<p>###@ControllerAdvice</p>\n<p>###ResponseEntityExceptionHandler</p>\n<p>##Default Servlet Container Error Page</p>\n<p>##@ResponseStatus</p>\n<p>###ResponseStatusExceptionResolver</p>\n</blockquote>\n<h3 id=\"SimpleMappingExceptionResolver\"><a href=\"#SimpleMappingExceptionResolver\" class=\"headerlink\" title=\"SimpleMappingExceptionResolver\"></a><code>SimpleMappingExceptionResolver</code></h3><blockquote>\n<p>The SimpleMappingExceptionResolver enables you to take the<br>class name of any exception that might be thrown and map it to a view name. </p>\n</blockquote>\n<p>这个Resolver可以将异常对应的类名映射到一个对应的view name上。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"exceptionMappings\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">\"com.howtodoinjava.demo.exception.AuthException\"</span>&gt;</span></span><br><span class=\"line\">                error/authExceptionView</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"defaultErrorView\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"error/genericView\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"DefaultHandlerExceptionResolver\"><a href=\"#DefaultHandlerExceptionResolver\" class=\"headerlink\" title=\"DefaultHandlerExceptionResolver\"></a><code>DefaultHandlerExceptionResolver</code></h3><blockquote>\n<p>The DefaultHandlerExceptionResolver translates Spring MVC exceptions to specific error<br>status codes.</p>\n</blockquote>\n<p>这个Resolver的作用就是将Spring MVC产生的一些异常翻译成对应的http status code。Spring MVC中</p>\n<p>默认注册了这个Resolver。</p>\n<p>转换列表：</p>\n<table>\n<thead>\n<tr>\n<th>Exception</th>\n<th>HTTP Status Code</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BindException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>ConversionNotSupportedException</td>\n<td>500 (Internal Server Error)</td>\n</tr>\n<tr>\n<td>HttpMediaTypeNotAcceptableException</td>\n<td>406 (Not Acceptable)</td>\n</tr>\n<tr>\n<td>HttpMediaTypeNotSupportedException</td>\n<td>415 (Unsupported Media Type)</td>\n</tr>\n<tr>\n<td>HttpMessageNotReadableException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>HttpMessageNotWritableException</td>\n<td>500 (Internal Server Error)</td>\n</tr>\n<tr>\n<td>HttpRequestMethodNotSupportedException</td>\n<td>405 (Method Not Allowed)</td>\n</tr>\n<tr>\n<td>MethodArgumentNotValidException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>MissingPathVariableException</td>\n<td>500 (Internal Server Error)</td>\n</tr>\n<tr>\n<td>MissingServletRequestParameterException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>MissingServletRequestPartException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>NoHandlerFoundException</td>\n<td>404 (Not Found)</td>\n</tr>\n<tr>\n<td>NoSuchRequestHandlingMethodException</td>\n<td>404 (Not Found)</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ExceptionHandler和-ControllerAdvice\"><a href=\"#ExceptionHandler和-ControllerAdvice\" class=\"headerlink\" title=\"@ExceptionHandler和@ControllerAdvice\"></a>@ExceptionHandler和@ControllerAdvice</h3><p><code>@ExceptionHandler</code> 可以指定异常的处理类，<code>@ControllerAdvice</code>则可以实现全局的异常统一处理。</p>\n<p>两者可配合使用，达到统一处理异常的效果。</p>\n<blockquote>\n<p>The @ControllerAdvice annotation is a component annotation allowing implementation classes<br>to be auto-detected through classpath scanning. It is automatically enabled when using the MVC<br>namespace or the MVC Java config.</p>\n</blockquote>\n<p><code>@ControllerAdvice</code>默认在Spring MVC的命名空间中启用。</p>\n<blockquote>\n<p>Classes annotated with @ControllerAdvice can contain @ExceptionHandler, @InitBinder,<br>and @ModelAttribute annotated methods, and these methods will apply to @RequestMapping<br>methods across all controller hierarchies as opposed to the controller hierarchy within which they are<br>declared.</p>\n</blockquote>\n<p><code>@ControllerAdvice</code>声明的异常处理方法默认对全局都是有效的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Target all Controllers annotated with @RestController</span></span><br><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span>(annotations = RestController.class)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnnotationAdvice</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Target all Controllers within specific packages</span></span><br><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span>(<span class=\"string\">\"org.example.controllers\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BasePackageAdvice</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Target all Controllers assignable to specific classes</span></span><br><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span>(assignableTypes = &#123;ControllerInterface.class, AbstractController.class&#125;)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AssignableTypesAdvice</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>还有一个<code>@RestControllerAdvice</code>和<code>@ControllerAdvice</code>相似，只是假定<code>@ResponseBody</code>出现在<code>@ExceptionHandler</code>上</p>\n<blockquote>\n<p>@RestControllerAdvice is an alternative where @ExceptionHandler methods assume<br>@ResponseBody semantics by default.</p>\n</blockquote>\n<h3 id=\"ResponseEntityExceptionHandler\"><a href=\"#ResponseEntityExceptionHandler\" class=\"headerlink\" title=\"ResponseEntityExceptionHandler\"></a><code>ResponseEntityExceptionHandler</code></h3><p>如果你想使用<code>@ExceptionHandler</code>来处理异常的话， 你可以继承这个类。</p>\n<p>这个类中定义好了一个异常处理的方法，来处理Spring MVC 的标准异常。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Provides handling for standard Spring MVC exceptions.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ex the target exception</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request the current request</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@ExceptionHandler</span>(&#123;</span><br><span class=\"line\">            NoSuchRequestHandlingMethodException.class,</span><br><span class=\"line\">            HttpRequestMethodNotSupportedException.class,</span><br><span class=\"line\">            HttpMediaTypeNotSupportedException.class,</span><br><span class=\"line\">            HttpMediaTypeNotAcceptableException.class,</span><br><span class=\"line\">            MissingPathVariableException.class,</span><br><span class=\"line\">            MissingServletRequestParameterException.class,</span><br><span class=\"line\">            ServletRequestBindingException.class,</span><br><span class=\"line\">            ConversionNotSupportedException.class,</span><br><span class=\"line\">            TypeMismatchException.class,</span><br><span class=\"line\">            HttpMessageNotReadableException.class,</span><br><span class=\"line\">            HttpMessageNotWritableException.class,</span><br><span class=\"line\">            MethodArgumentNotValidException.class,</span><br><span class=\"line\">            MissingServletRequestPartException.class,</span><br><span class=\"line\">            BindException.class,</span><br><span class=\"line\">            NoHandlerFoundException.class</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> ResponseEntity&lt;Object&gt; <span class=\"title\">handleException</span><span class=\"params\">(Exception ex, WebRequest request)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            HttpHeaders headers = <span class=\"keyword\">new</span> HttpHeaders();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (ex <span class=\"keyword\">instanceof</span> NoSuchRequestHandlingMethodException) &#123;</span><br><span class=\"line\">                HttpStatus status = HttpStatus.NOT_FOUND;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, headers, status, request);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            ...</span><br><span class=\"line\">            ...</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"ResponseStatus\"><a href=\"#ResponseStatus\" class=\"headerlink\" title=\"@ResponseStatus\"></a>@ResponseStatus</h3><p>用于在自定义异常，设置http的状态码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ResponseStatus</span>(value=HttpStatus.NOT_FOUND, reason=<span class=\"string\">\"No such Order\"</span>)  <span class=\"comment\">// 404</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OrderNotFoundException</span> <span class=\"keyword\">extends</span> <span class=\"title\">RuntimeException</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Spring MVC 中默认开启了<code>ResponseStatusExceptionResolver</code>，这个Resolver会处理上面</p>\n<p>设置的Http status code。</p>\n<blockquote>\n<p>A business exception can be annotated with @ResponseStatus. When the exception is raised, the<br>ResponseStatusExceptionResolver handles it by setting the status of the response accordingly.<br>By default the DispatcherServlet registers the ResponseStatusExceptionResolver and it is<br>available for use.</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">doResolveException</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            Object handler, Exception ex)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ResponseStatus responseStatus = AnnotatedElementUtils.findMergedAnnotation(ex.getClass(), ResponseStatus.class);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (responseStatus != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> resolveResponseStatus(responseStatus, request, response, handler, ex);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (Exception resolveEx) &#123;</span><br><span class=\"line\">                logger.warn(<span class=\"string\">\"Handling of @ResponseStatus resulted in Exception\"</span>, resolveEx);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ex.getCause() <span class=\"keyword\">instanceof</span> Exception) &#123;</span><br><span class=\"line\">            ex = (Exception) ex.getCause();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> doResolveException(request, response, handler, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>通过工具类拿到注解上的值，然后调用内部的<code>resolveResponseStatus</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">resolveResponseStatus</span><span class=\"params\">(ResponseStatus responseStatus, HttpServletRequest request,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            HttpServletResponse response, Object handler, Exception ex)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> statusCode = responseStatus.code().value();</span><br><span class=\"line\">        String reason = responseStatus.reason();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageSource != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            reason = <span class=\"keyword\">this</span>.messageSource.getMessage(reason, <span class=\"keyword\">null</span>, reason, LocaleContextHolder.getLocale());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.hasLength(reason)) &#123;</span><br><span class=\"line\">            response.sendError(statusCode);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            response.sendError(statusCode, reason);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ModelAndView();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>最终将http status code 设置到reponse中。</p>\n<h3 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h3><p>Spring MVC 的异常处理在<code>DispatcherServlet</code>的<code>doDispatch</code>方法中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        HttpServletRequest processedRequest = request;</span><br><span class=\"line\">        HandlerExecutionChain mappedHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> multipartRequestParsed = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ModelAndView mv = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            Exception dispatchException = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//do Handle</span></span><br><span class=\"line\">                ...</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">                dispatchException = ex;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">            triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (Error err) &#123;</span><br><span class=\"line\">            triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//post process</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在内层的<code>try-catch</code>中有一个方法<code>processDispatchResult</code>, 在这个方法之前的catch块已经将处理过程可能出现的异常catch住了，并赋值给 <code>dispatchException</code>.</p>\n<p>然后调用<code>processDispatchResult</code>分发给能处理这个异常的<code>ExceptionResolver</code>。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Handle the result of handler selection and handler invocation, which is</span></span><br><span class=\"line\"><span class=\"comment\">     * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processDispatchResult</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> errorView = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class=\"line\">                logger.debug(<span class=\"string\">\"ModelAndViewDefiningException encountered\"</span>, exception);</span><br><span class=\"line\">                mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                Object handler = (mappedHandler != <span class=\"keyword\">null</span> ? mappedHandler.getHandler() : <span class=\"keyword\">null</span>);</span><br><span class=\"line\">                mv = processHandlerException(request, response, handler, exception);</span><br><span class=\"line\">                errorView = (mv != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Did the handler return a view to render?</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mv != <span class=\"keyword\">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class=\"line\">            render(mv, request, response);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (errorView) &#123;</span><br><span class=\"line\">                WebUtils.clearErrorRequestAttributes(request);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                logger.debug(<span class=\"string\">\"Null ModelAndView returned to DispatcherServlet with name '\"</span> + getServletName() +</span><br><span class=\"line\">                        <span class=\"string\">\"': assuming HandlerAdapter completed request handling\"</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Concurrent handling started during a forward</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mappedHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mappedHandler.triggerAfterCompletion(request, response, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">processHandlerException</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            Object handler, Exception ex)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Check registered HandlerExceptionResolvers...</span></span><br><span class=\"line\">        ModelAndView exMv = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (HandlerExceptionResolver handlerExceptionResolver : <span class=\"keyword\">this</span>.handlerExceptionResolvers) &#123;</span><br><span class=\"line\">            exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (exMv != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exMv != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (exMv.isEmpty()) &#123;</span><br><span class=\"line\">                request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// We might still need view name translation for a plain error model...</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!exMv.hasView()) &#123;</span><br><span class=\"line\">                exMv.setViewName(getDefaultViewName(request));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                logger.debug(<span class=\"string\">\"Handler execution resulted in exception - forwarding to resolved error view: \"</span> + exMv, ex);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class=\"line\">            <span class=\"keyword\">return</span> exMv;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这个异常的处理和之前，查找handler的过程是一样的。</p>\n<p>遍历所有已经注册的<code>HandlerExceptionResolver</code>, 找到第一个能处理的。</p>\n<h4 id=\"ExceptionHandler的处理\"><a href=\"#ExceptionHandler的处理\" class=\"headerlink\" title=\"@ExceptionHandler的处理\"></a>@ExceptionHandler的处理</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Implementation of the &#123;<span class=\"doctag\">@link</span> org.springframework.web.portlet.HandlerExceptionResolver&#125; interface that handles</span></span><br><span class=\"line\"><span class=\"comment\"> * exceptions through the &#123;<span class=\"doctag\">@link</span> ExceptionHandler&#125; annotation.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;This exception resolver is enabled by default in the &#123;<span class=\"doctag\">@link</span> org.springframework.web.portlet.DispatcherPortlet&#125;.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> Arjen Poutsma</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> Juergen Hoeller</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> 3.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnnotationMethodHandlerExceptionResolver</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractHandlerExceptionResolver</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">doResolveException</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            PortletRequest request, MimeResponse response, Object handler, Exception ex)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (handler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            Method handlerMethod = findBestExceptionHandlerMethod(handler, ex);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (handlerMethod != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                NativeWebRequest webRequest = <span class=\"keyword\">new</span> PortletWebRequest(request, response);</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    Object[] args = resolveHandlerArguments(handlerMethod, handler, webRequest, ex);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                        logger.debug(<span class=\"string\">\"Invoking request handler method: \"</span> + handlerMethod);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    Object retVal = doInvokeMethod(handlerMethod, handler, args);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> getModelAndView(retVal);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (Exception invocationEx) &#123;</span><br><span class=\"line\">                    logger.error(<span class=\"string\">\"Invoking request method resulted in exception : \"</span> + handlerMethod, invocationEx);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>和普通的处理类似，从所有标注了<code>@ExceptionHandler</code>的方法中找到最佳匹配，然后解析参数，调用。</p>\n<h2 id=\"web容器的错误处理\"><a href=\"#web容器的错误处理\" class=\"headerlink\" title=\"web容器的错误处理\"></a>web容器的错误处理</h2><p><code>WEB-INF/web.xml</code></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>500<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/Error.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">exception-type</span>&gt;</span>java.lang.Exception<span class=\"tag\">&lt;/<span class=\"name\">exception-type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/Error.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>location中的值可以是一个jsp，也可以是一个URL（包括<code>@Controller</code>注解的）</p>\n<p>处理error的Controller示例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ErrorController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping</span>(path = <span class=\"string\">\"/error\"</span>, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">handle</span><span class=\"params\">(HttpServletRequest request)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">        map.put(<span class=\"string\">\"status\"</span>, request.getAttribute(<span class=\"string\">\"javax.servlet.error.status_code\"</span>));</span><br><span class=\"line\">        map.put(<span class=\"string\">\"reason\"</span>, request.getAttribute(<span class=\"string\">\"javax.servlet.error.message\"</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JSP示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%@ page contentType=&quot;application/json&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">status:&lt;%=request.getAttribute(&quot;javax.servlet.error.status_code&quot;) %&gt;,</span><br><span class=\"line\">reason:&lt;%=request.getAttribute(&quot;javax.servlet.error.message&quot;) %&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.cnblogs.com/hupengcool/p/4586910.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SpringMVC 异常处理 - 纵酒挥刀斩人头 - 博客园</a></p>\n</li>\n<li><p><a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-exceptionhandlers\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">22. Web MVC framework</a></p>\n</li>\n<li><p><a href=\"http://howtodoinjava.com/spring/spring-mvc/spring-mvc-simplemappingexceptionresolver-example/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Spring MVC Mapping Exceptions to Views Example | Spring MVC SimpleMappingExceptionResolver Example</a></p>\n</li>\n<li><p><a href=\"http://stackoverflow.com/questions/15987212/custom-error-page-in-tomcat-7-for-error-code-500\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - Custom Error Page in Tomcat 7 for Error Code 500 - Stack Overflow</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Spring-MVC的异常处理\"><a href=\"#Spring-MVC的异常处理\" class=\"headerlink\" title=\"Spring MVC的异常处理\"></a>Spring MVC的异常处理</h2><p>Spring中的异常处理主要有两种方式，<em>一种</em>是实现<code>HandlerExceptionResolver</code>接口，</p>\n<p>这个接口中只有一个方法<code>resolveException</code>，返回值是一个<code>ModelAndView</code>的对象; </p>\n<p><em>另外一种</em>是使用<code>@ExceptionHandler</code>注解作用在方法上，注解的值来指定这个方法能处理的异常的类，</p>\n<p>如果注解的值是空的，能处理的类以方法的参数为准。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">HandlerExceptionResolver</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Try to resolve the given exception that got thrown during handler execution,</span></span><br><span class=\"line\"><span class=\"comment\">     * returning a &#123;<span class=\"doctag\">@link</span> ModelAndView&#125; that represents a specific error page if appropriate.</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt;The returned &#123;<span class=\"doctag\">@code</span> ModelAndView&#125; may be &#123;<span class=\"doctag\">@linkplain</span> ModelAndView#isEmpty() empty&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     * to indicate that the exception has been resolved successfully but that no view</span></span><br><span class=\"line\"><span class=\"comment\">     * should be rendered, for instance by setting a status code.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> response current HTTP response</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> handler the executed handler, or &#123;<span class=\"doctag\">@code</span> null&#125; if none chosen at the</span></span><br><span class=\"line\"><span class=\"comment\">     * time of the exception (for example, if multipart resolution failed)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ex the exception that got thrown during handler execution</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> a corresponding &#123;<span class=\"doctag\">@code</span> ModelAndView&#125; to forward to, or &#123;<span class=\"doctag\">@code</span> null&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     * for default processing</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">ModelAndView <span class=\"title\">resolveException</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//@ExceptionHandler</span></span><br><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// @RequestMapping methods omitted ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@ExceptionHandler</span>(IOException.class)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">handleIOException</span><span class=\"params\">(IOException ex)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// prepare responseEntity</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> responseEntity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"异常相关的类\"><a href=\"#异常相关的类\" class=\"headerlink\" title=\"异常相关的类\"></a>异常相关的类</h3><blockquote class=\"pullquote mindmap\"><p>#Spring MVC Exception</p>\n<p>##HandlerExceptionResolver</p>\n<p>###SimpleMappingExceptionResolver</p>\n<p>###DefaultHandlerExceptionResolver</p>\n<p>##@ExceptionHandler</p>\n<p>###@ControllerAdvice</p>\n<p>###ResponseEntityExceptionHandler</p>\n<p>##Default Servlet Container Error Page</p>\n<p>##@ResponseStatus</p>\n<p>###ResponseStatusExceptionResolver</p>\n</blockquote>\n<h3 id=\"SimpleMappingExceptionResolver\"><a href=\"#SimpleMappingExceptionResolver\" class=\"headerlink\" title=\"SimpleMappingExceptionResolver\"></a><code>SimpleMappingExceptionResolver</code></h3><blockquote>\n<p>The SimpleMappingExceptionResolver enables you to take the<br>class name of any exception that might be thrown and map it to a view name. </p>\n</blockquote>\n<p>这个Resolver可以将异常对应的类名映射到一个对应的view name上。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"exceptionMappings\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">prop</span> <span class=\"attr\">key</span>=<span class=\"string\">\"com.howtodoinjava.demo.exception.AuthException\"</span>&gt;</span></span><br><span class=\"line\">                error/authExceptionView</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">prop</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">props</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"defaultErrorView\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"error/genericView\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"DefaultHandlerExceptionResolver\"><a href=\"#DefaultHandlerExceptionResolver\" class=\"headerlink\" title=\"DefaultHandlerExceptionResolver\"></a><code>DefaultHandlerExceptionResolver</code></h3><blockquote>\n<p>The DefaultHandlerExceptionResolver translates Spring MVC exceptions to specific error<br>status codes.</p>\n</blockquote>\n<p>这个Resolver的作用就是将Spring MVC产生的一些异常翻译成对应的http status code。Spring MVC中</p>\n<p>默认注册了这个Resolver。</p>\n<p>转换列表：</p>\n<table>\n<thead>\n<tr>\n<th>Exception</th>\n<th>HTTP Status Code</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BindException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>ConversionNotSupportedException</td>\n<td>500 (Internal Server Error)</td>\n</tr>\n<tr>\n<td>HttpMediaTypeNotAcceptableException</td>\n<td>406 (Not Acceptable)</td>\n</tr>\n<tr>\n<td>HttpMediaTypeNotSupportedException</td>\n<td>415 (Unsupported Media Type)</td>\n</tr>\n<tr>\n<td>HttpMessageNotReadableException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>HttpMessageNotWritableException</td>\n<td>500 (Internal Server Error)</td>\n</tr>\n<tr>\n<td>HttpRequestMethodNotSupportedException</td>\n<td>405 (Method Not Allowed)</td>\n</tr>\n<tr>\n<td>MethodArgumentNotValidException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>MissingPathVariableException</td>\n<td>500 (Internal Server Error)</td>\n</tr>\n<tr>\n<td>MissingServletRequestParameterException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>MissingServletRequestPartException</td>\n<td>400 (Bad Request)</td>\n</tr>\n<tr>\n<td>NoHandlerFoundException</td>\n<td>404 (Not Found)</td>\n</tr>\n<tr>\n<td>NoSuchRequestHandlingMethodException</td>\n<td>404 (Not Found)</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ExceptionHandler和-ControllerAdvice\"><a href=\"#ExceptionHandler和-ControllerAdvice\" class=\"headerlink\" title=\"@ExceptionHandler和@ControllerAdvice\"></a>@ExceptionHandler和@ControllerAdvice</h3><p><code>@ExceptionHandler</code> 可以指定异常的处理类，<code>@ControllerAdvice</code>则可以实现全局的异常统一处理。</p>\n<p>两者可配合使用，达到统一处理异常的效果。</p>\n<blockquote>\n<p>The @ControllerAdvice annotation is a component annotation allowing implementation classes<br>to be auto-detected through classpath scanning. It is automatically enabled when using the MVC<br>namespace or the MVC Java config.</p>\n</blockquote>\n<p><code>@ControllerAdvice</code>默认在Spring MVC的命名空间中启用。</p>\n<blockquote>\n<p>Classes annotated with @ControllerAdvice can contain @ExceptionHandler, @InitBinder,<br>and @ModelAttribute annotated methods, and these methods will apply to @RequestMapping<br>methods across all controller hierarchies as opposed to the controller hierarchy within which they are<br>declared.</p>\n</blockquote>\n<p><code>@ControllerAdvice</code>声明的异常处理方法默认对全局都是有效的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Target all Controllers annotated with @RestController</span></span><br><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span>(annotations = RestController.class)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnnotationAdvice</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Target all Controllers within specific packages</span></span><br><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span>(<span class=\"string\">\"org.example.controllers\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BasePackageAdvice</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Target all Controllers assignable to specific classes</span></span><br><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span>(assignableTypes = &#123;ControllerInterface.class, AbstractController.class&#125;)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AssignableTypesAdvice</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>还有一个<code>@RestControllerAdvice</code>和<code>@ControllerAdvice</code>相似，只是假定<code>@ResponseBody</code>出现在<code>@ExceptionHandler</code>上</p>\n<blockquote>\n<p>@RestControllerAdvice is an alternative where @ExceptionHandler methods assume<br>@ResponseBody semantics by default.</p>\n</blockquote>\n<h3 id=\"ResponseEntityExceptionHandler\"><a href=\"#ResponseEntityExceptionHandler\" class=\"headerlink\" title=\"ResponseEntityExceptionHandler\"></a><code>ResponseEntityExceptionHandler</code></h3><p>如果你想使用<code>@ExceptionHandler</code>来处理异常的话， 你可以继承这个类。</p>\n<p>这个类中定义好了一个异常处理的方法，来处理Spring MVC 的标准异常。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Provides handling for standard Spring MVC exceptions.</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ex the target exception</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> request the current request</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@ExceptionHandler</span>(&#123;</span><br><span class=\"line\">            NoSuchRequestHandlingMethodException.class,</span><br><span class=\"line\">            HttpRequestMethodNotSupportedException.class,</span><br><span class=\"line\">            HttpMediaTypeNotSupportedException.class,</span><br><span class=\"line\">            HttpMediaTypeNotAcceptableException.class,</span><br><span class=\"line\">            MissingPathVariableException.class,</span><br><span class=\"line\">            MissingServletRequestParameterException.class,</span><br><span class=\"line\">            ServletRequestBindingException.class,</span><br><span class=\"line\">            ConversionNotSupportedException.class,</span><br><span class=\"line\">            TypeMismatchException.class,</span><br><span class=\"line\">            HttpMessageNotReadableException.class,</span><br><span class=\"line\">            HttpMessageNotWritableException.class,</span><br><span class=\"line\">            MethodArgumentNotValidException.class,</span><br><span class=\"line\">            MissingServletRequestPartException.class,</span><br><span class=\"line\">            BindException.class,</span><br><span class=\"line\">            NoHandlerFoundException.class</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> ResponseEntity&lt;Object&gt; <span class=\"title\">handleException</span><span class=\"params\">(Exception ex, WebRequest request)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            HttpHeaders headers = <span class=\"keyword\">new</span> HttpHeaders();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (ex <span class=\"keyword\">instanceof</span> NoSuchRequestHandlingMethodException) &#123;</span><br><span class=\"line\">                HttpStatus status = HttpStatus.NOT_FOUND;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, headers, status, request);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            ...</span><br><span class=\"line\">            ...</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"ResponseStatus\"><a href=\"#ResponseStatus\" class=\"headerlink\" title=\"@ResponseStatus\"></a>@ResponseStatus</h3><p>用于在自定义异常，设置http的状态码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ResponseStatus</span>(value=HttpStatus.NOT_FOUND, reason=<span class=\"string\">\"No such Order\"</span>)  <span class=\"comment\">// 404</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OrderNotFoundException</span> <span class=\"keyword\">extends</span> <span class=\"title\">RuntimeException</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Spring MVC 中默认开启了<code>ResponseStatusExceptionResolver</code>，这个Resolver会处理上面</p>\n<p>设置的Http status code。</p>\n<blockquote>\n<p>A business exception can be annotated with @ResponseStatus. When the exception is raised, the<br>ResponseStatusExceptionResolver handles it by setting the status of the response accordingly.<br>By default the DispatcherServlet registers the ResponseStatusExceptionResolver and it is<br>available for use.</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">doResolveException</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            Object handler, Exception ex)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ResponseStatus responseStatus = AnnotatedElementUtils.findMergedAnnotation(ex.getClass(), ResponseStatus.class);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (responseStatus != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> resolveResponseStatus(responseStatus, request, response, handler, ex);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (Exception resolveEx) &#123;</span><br><span class=\"line\">                logger.warn(<span class=\"string\">\"Handling of @ResponseStatus resulted in Exception\"</span>, resolveEx);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ex.getCause() <span class=\"keyword\">instanceof</span> Exception) &#123;</span><br><span class=\"line\">            ex = (Exception) ex.getCause();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> doResolveException(request, response, handler, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>通过工具类拿到注解上的值，然后调用内部的<code>resolveResponseStatus</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">resolveResponseStatus</span><span class=\"params\">(ResponseStatus responseStatus, HttpServletRequest request,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            HttpServletResponse response, Object handler, Exception ex)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> statusCode = responseStatus.code().value();</span><br><span class=\"line\">        String reason = responseStatus.reason();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageSource != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            reason = <span class=\"keyword\">this</span>.messageSource.getMessage(reason, <span class=\"keyword\">null</span>, reason, LocaleContextHolder.getLocale());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.hasLength(reason)) &#123;</span><br><span class=\"line\">            response.sendError(statusCode);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            response.sendError(statusCode, reason);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ModelAndView();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>最终将http status code 设置到reponse中。</p>\n<h3 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h3><p>Spring MVC 的异常处理在<code>DispatcherServlet</code>的<code>doDispatch</code>方法中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        HttpServletRequest processedRequest = request;</span><br><span class=\"line\">        HandlerExecutionChain mappedHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> multipartRequestParsed = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ModelAndView mv = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            Exception dispatchException = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//do Handle</span></span><br><span class=\"line\">                ...</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">                dispatchException = ex;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">            triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span> (Error err) &#123;</span><br><span class=\"line\">            triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//post process</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在内层的<code>try-catch</code>中有一个方法<code>processDispatchResult</code>, 在这个方法之前的catch块已经将处理过程可能出现的异常catch住了，并赋值给 <code>dispatchException</code>.</p>\n<p>然后调用<code>processDispatchResult</code>分发给能处理这个异常的<code>ExceptionResolver</code>。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Handle the result of handler selection and handler invocation, which is</span></span><br><span class=\"line\"><span class=\"comment\">     * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processDispatchResult</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> errorView = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class=\"line\">                logger.debug(<span class=\"string\">\"ModelAndViewDefiningException encountered\"</span>, exception);</span><br><span class=\"line\">                mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                Object handler = (mappedHandler != <span class=\"keyword\">null</span> ? mappedHandler.getHandler() : <span class=\"keyword\">null</span>);</span><br><span class=\"line\">                mv = processHandlerException(request, response, handler, exception);</span><br><span class=\"line\">                errorView = (mv != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Did the handler return a view to render?</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mv != <span class=\"keyword\">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class=\"line\">            render(mv, request, response);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (errorView) &#123;</span><br><span class=\"line\">                WebUtils.clearErrorRequestAttributes(request);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                logger.debug(<span class=\"string\">\"Null ModelAndView returned to DispatcherServlet with name '\"</span> + getServletName() +</span><br><span class=\"line\">                        <span class=\"string\">\"': assuming HandlerAdapter completed request handling\"</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Concurrent handling started during a forward</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mappedHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            mappedHandler.triggerAfterCompletion(request, response, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">processHandlerException</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            Object handler, Exception ex)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Check registered HandlerExceptionResolvers...</span></span><br><span class=\"line\">        ModelAndView exMv = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (HandlerExceptionResolver handlerExceptionResolver : <span class=\"keyword\">this</span>.handlerExceptionResolvers) &#123;</span><br><span class=\"line\">            exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (exMv != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exMv != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (exMv.isEmpty()) &#123;</span><br><span class=\"line\">                request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// We might still need view name translation for a plain error model...</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!exMv.hasView()) &#123;</span><br><span class=\"line\">                exMv.setViewName(getDefaultViewName(request));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                logger.debug(<span class=\"string\">\"Handler execution resulted in exception - forwarding to resolved error view: \"</span> + exMv, ex);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class=\"line\">            <span class=\"keyword\">return</span> exMv;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这个异常的处理和之前，查找handler的过程是一样的。</p>\n<p>遍历所有已经注册的<code>HandlerExceptionResolver</code>, 找到第一个能处理的。</p>\n<h4 id=\"ExceptionHandler的处理\"><a href=\"#ExceptionHandler的处理\" class=\"headerlink\" title=\"@ExceptionHandler的处理\"></a>@ExceptionHandler的处理</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Implementation of the &#123;<span class=\"doctag\">@link</span> org.springframework.web.portlet.HandlerExceptionResolver&#125; interface that handles</span></span><br><span class=\"line\"><span class=\"comment\"> * exceptions through the &#123;<span class=\"doctag\">@link</span> ExceptionHandler&#125; annotation.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;This exception resolver is enabled by default in the &#123;<span class=\"doctag\">@link</span> org.springframework.web.portlet.DispatcherPortlet&#125;.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> Arjen Poutsma</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> Juergen Hoeller</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> 3.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnnotationMethodHandlerExceptionResolver</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractHandlerExceptionResolver</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">doResolveException</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            PortletRequest request, MimeResponse response, Object handler, Exception ex)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (handler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            Method handlerMethod = findBestExceptionHandlerMethod(handler, ex);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (handlerMethod != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                NativeWebRequest webRequest = <span class=\"keyword\">new</span> PortletWebRequest(request, response);</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    Object[] args = resolveHandlerArguments(handlerMethod, handler, webRequest, ex);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">                        logger.debug(<span class=\"string\">\"Invoking request handler method: \"</span> + handlerMethod);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    Object retVal = doInvokeMethod(handlerMethod, handler, args);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> getModelAndView(retVal);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">catch</span> (Exception invocationEx) &#123;</span><br><span class=\"line\">                    logger.error(<span class=\"string\">\"Invoking request method resulted in exception : \"</span> + handlerMethod, invocationEx);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>和普通的处理类似，从所有标注了<code>@ExceptionHandler</code>的方法中找到最佳匹配，然后解析参数，调用。</p>\n<h2 id=\"web容器的错误处理\"><a href=\"#web容器的错误处理\" class=\"headerlink\" title=\"web容器的错误处理\"></a>web容器的错误处理</h2><p><code>WEB-INF/web.xml</code></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>500<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/Error.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">exception-type</span>&gt;</span>java.lang.Exception<span class=\"tag\">&lt;/<span class=\"name\">exception-type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/Error.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>location中的值可以是一个jsp，也可以是一个URL（包括<code>@Controller</code>注解的）</p>\n<p>处理error的Controller示例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ErrorController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping</span>(path = <span class=\"string\">\"/error\"</span>, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">handle</span><span class=\"params\">(HttpServletRequest request)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, Object&gt; map = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">        map.put(<span class=\"string\">\"status\"</span>, request.getAttribute(<span class=\"string\">\"javax.servlet.error.status_code\"</span>));</span><br><span class=\"line\">        map.put(<span class=\"string\">\"reason\"</span>, request.getAttribute(<span class=\"string\">\"javax.servlet.error.message\"</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> map;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JSP示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%@ page contentType=&quot;application/json&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">status:&lt;%=request.getAttribute(&quot;javax.servlet.error.status_code&quot;) %&gt;,</span><br><span class=\"line\">reason:&lt;%=request.getAttribute(&quot;javax.servlet.error.message&quot;) %&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.cnblogs.com/hupengcool/p/4586910.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SpringMVC 异常处理 - 纵酒挥刀斩人头 - 博客园</a></p>\n</li>\n<li><p><a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-exceptionhandlers\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">22. Web MVC framework</a></p>\n</li>\n<li><p><a href=\"http://howtodoinjava.com/spring/spring-mvc/spring-mvc-simplemappingexceptionresolver-example/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Spring MVC Mapping Exceptions to Views Example | Spring MVC SimpleMappingExceptionResolver Example</a></p>\n</li>\n<li><p><a href=\"http://stackoverflow.com/questions/15987212/custom-error-page-in-tomcat-7-for-error-code-500\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - Custom Error Page in Tomcat 7 for Error Code 500 - Stack Overflow</a></p>\n</li>\n</ol>\n"},{"title":"Base64编码原理","toc":true,"abbrlink":29941,"date":"2016-09-26T06:37:33.000Z","_content":"\n## 是什么？\n\n> Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation. The term Base64 originates from a specific MIME content transfer encoding\n来自 [wikipedia](https://en.wikipedia.org/wiki/Base64)\n\n说白了就是将二进制的数据转换成字符编码。Base64由大小写字母各26个，`0-9`的10个数字，加号`+`\n以及斜杠`/`，一共64个字符组成，另外还用`=`来用作后缀，总共涉及的字符达到65个。\n\n> a）所有的二进制文件，都可以因此转化为可打印的文本编码，使用文本软件进行编辑；\n\n> b）能够对文本进行简单的加密。\n\n> 来自 [Base64笔记-阮一峰](http://www.ruanyifeng.com/blog/2008/06/base64.html)\n\n## 原理\n{%  asset_img   encoding.jpg  %}\n\n\n\n\n>转换的时候，将三个byte的数据，先后放入一个24bit的缓冲区中，先来的byte占高位。数据不足3byte的话，于缓冲器中剩下的bit用0补足。然后，每次取出6（因为26=64）个bit，按照其值选择ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/中的字符作为编码后的输出。不断进行，直到全部输入数据转换完成。\n\n> <https://zh.wikipedia.org/wiki/Base64>\n\n如果要编码的字节数不能被3整除:\n\n  1. 先使用0字节值在末尾补足，使其能够被3整除\n  2. 进行base64的编码\n  3. 在编码后的base64文本后加上一个或两个'='号，代表补足的字节数\n\n  {%  asset_img   encoding2.jpg  %}\n\n\n\n\n  Base64字符串只可能最后出现一个或两个\"=\"，中间是不可能出现\"=\"的\n\n## 用途\n\n>Base64 主要不是加密，它主要的用途是把一些二进制数转成普通字符用于网络传输。由于一些二进制字符在传输协议中属于控制字符，不能直接传送需要转换一下。Base64编码就是把二进制字节序列转化为ASCII字符序列。一般增加1/3长度，而且也是不可读的。\n\n>[BASE64编码原理及应用](http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html)\n\n>Base64常用于在通常处理文本数据的场合，表示、传输、存储一些二进制数据。包括MIME的email、在XML中存储复杂数据。\n\n> <https://zh.wikipedia.org/wiki/Base64>\n\n## python中简单使用\n\n``` python\n>>> import base64\n>>> encoded = base64.b64encode('hello world')\n>>> print encoded\naGVsbG8gd29ybGQ=\n>>> data = base64.b64decode(encoded)\n>>> print data\nhello world\n```\n\n[base64 — RFC 3548: Base16, Base32, Base64 Data Encodings](https://docs.python.org/2/library/base64.html)\n\n## 参考链接\n\n1. [Base64笔记_阮一峰](http://www.ruanyifeng.com/blog/2008/06/base64.html)\n\n2. [Base64_wiki](https://en.wikipedia.org/wiki/Base64)\n\n3. [BASE64编码原理及应用](http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html)\n\n4. [Base64加密](https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/Base64%E5%8A%A0%E5%AF%86.md)\n","source":"_posts/base64.md","raw":"---\ntitle: Base64编码原理\ntags: 编码\ncategory: base\ntoc: true\nabbrlink: 29941\ndate: 2016-09-26 14:37:33\n---\n\n## 是什么？\n\n> Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation. The term Base64 originates from a specific MIME content transfer encoding\n来自 [wikipedia](https://en.wikipedia.org/wiki/Base64)\n\n说白了就是将二进制的数据转换成字符编码。Base64由大小写字母各26个，`0-9`的10个数字，加号`+`\n以及斜杠`/`，一共64个字符组成，另外还用`=`来用作后缀，总共涉及的字符达到65个。\n\n> a）所有的二进制文件，都可以因此转化为可打印的文本编码，使用文本软件进行编辑；\n\n> b）能够对文本进行简单的加密。\n\n> 来自 [Base64笔记-阮一峰](http://www.ruanyifeng.com/blog/2008/06/base64.html)\n\n## 原理\n{%  asset_img   encoding.jpg  %}\n\n\n\n\n>转换的时候，将三个byte的数据，先后放入一个24bit的缓冲区中，先来的byte占高位。数据不足3byte的话，于缓冲器中剩下的bit用0补足。然后，每次取出6（因为26=64）个bit，按照其值选择ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/中的字符作为编码后的输出。不断进行，直到全部输入数据转换完成。\n\n> <https://zh.wikipedia.org/wiki/Base64>\n\n如果要编码的字节数不能被3整除:\n\n  1. 先使用0字节值在末尾补足，使其能够被3整除\n  2. 进行base64的编码\n  3. 在编码后的base64文本后加上一个或两个'='号，代表补足的字节数\n\n  {%  asset_img   encoding2.jpg  %}\n\n\n\n\n  Base64字符串只可能最后出现一个或两个\"=\"，中间是不可能出现\"=\"的\n\n## 用途\n\n>Base64 主要不是加密，它主要的用途是把一些二进制数转成普通字符用于网络传输。由于一些二进制字符在传输协议中属于控制字符，不能直接传送需要转换一下。Base64编码就是把二进制字节序列转化为ASCII字符序列。一般增加1/3长度，而且也是不可读的。\n\n>[BASE64编码原理及应用](http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html)\n\n>Base64常用于在通常处理文本数据的场合，表示、传输、存储一些二进制数据。包括MIME的email、在XML中存储复杂数据。\n\n> <https://zh.wikipedia.org/wiki/Base64>\n\n## python中简单使用\n\n``` python\n>>> import base64\n>>> encoded = base64.b64encode('hello world')\n>>> print encoded\naGVsbG8gd29ybGQ=\n>>> data = base64.b64decode(encoded)\n>>> print data\nhello world\n```\n\n[base64 — RFC 3548: Base16, Base32, Base64 Data Encodings](https://docs.python.org/2/library/base64.html)\n\n## 参考链接\n\n1. [Base64笔记_阮一峰](http://www.ruanyifeng.com/blog/2008/06/base64.html)\n\n2. [Base64_wiki](https://en.wikipedia.org/wiki/Base64)\n\n3. [BASE64编码原理及应用](http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html)\n\n4. [Base64加密](https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/Base64%E5%8A%A0%E5%AF%86.md)\n","slug":"base64","published":1,"updated":"2017-04-16T12:03:23.385Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8p004rjh4kbyspxyno","content":"<h2 id=\"是什么？\"><a href=\"#是什么？\" class=\"headerlink\" title=\"是什么？\"></a>是什么？</h2><blockquote>\n<p>Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation. The term Base64 originates from a specific MIME content transfer encoding<br>来自 <a href=\"https://en.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">wikipedia</a></p>\n</blockquote>\n<p>说白了就是将二进制的数据转换成字符编码。Base64由大小写字母各26个，<code>0-9</code>的10个数字，加号<code>+</code><br>以及斜杠<code>/</code>，一共64个字符组成，另外还用<code>=</code>来用作后缀，总共涉及的字符达到65个。</p>\n<blockquote>\n<p>a）所有的二进制文件，都可以因此转化为可打印的文本编码，使用文本软件进行编辑；</p>\n<p>b）能够对文本进行简单的加密。</p>\n<p>来自 <a href=\"http://www.ruanyifeng.com/blog/2008/06/base64.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64笔记-阮一峰</a></p>\n</blockquote>\n<h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><img src=\"/2016/09/26/base64/encoding.jpg\">\n<blockquote>\n<p>转换的时候，将三个byte的数据，先后放入一个24bit的缓冲区中，先来的byte占高位。数据不足3byte的话，于缓冲器中剩下的bit用0补足。然后，每次取出6（因为26=64）个bit，按照其值选择ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/中的字符作为编码后的输出。不断进行，直到全部输入数据转换完成。</p>\n<p><a href=\"https://zh.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://zh.wikipedia.org/wiki/Base64</a></p>\n</blockquote>\n<p>如果要编码的字节数不能被3整除:</p>\n<ol>\n<li>先使用0字节值在末尾补足，使其能够被3整除</li>\n<li>进行base64的编码</li>\n<li><p>在编码后的base64文本后加上一个或两个’=’号，代表补足的字节数</p>\n<img src=\"/2016/09/26/base64/encoding2.jpg\">\n</li>\n</ol>\n<p>  Base64字符串只可能最后出现一个或两个”=”，中间是不可能出现”=”的</p>\n<h2 id=\"用途\"><a href=\"#用途\" class=\"headerlink\" title=\"用途\"></a>用途</h2><blockquote>\n<p>Base64 主要不是加密，它主要的用途是把一些二进制数转成普通字符用于网络传输。由于一些二进制字符在传输协议中属于控制字符，不能直接传送需要转换一下。Base64编码就是把二进制字节序列转化为ASCII字符序列。一般增加1/3长度，而且也是不可读的。</p>\n<p><a href=\"http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">BASE64编码原理及应用</a></p>\n<p>Base64常用于在通常处理文本数据的场合，表示、传输、存储一些二进制数据。包括MIME的email、在XML中存储复杂数据。</p>\n<p><a href=\"https://zh.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://zh.wikipedia.org/wiki/Base64</a></p>\n</blockquote>\n<h2 id=\"python中简单使用\"><a href=\"#python中简单使用\" class=\"headerlink\" title=\"python中简单使用\"></a>python中简单使用</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>encoded = base64.b64encode(<span class=\"string\">'hello world'</span>)</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">print</span> encoded</span><br><span class=\"line\">aGVsbG8gd29ybGQ=</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>data = base64.b64decode(encoded)</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">print</span> data</span><br><span class=\"line\">hello world</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://docs.python.org/2/library/base64.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">base64 — RFC 3548: Base16, Base32, Base64 Data Encodings</a></p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2008/06/base64.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64笔记_阮一峰</a></p>\n</li>\n<li><p><a href=\"https://en.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64_wiki</a></p>\n</li>\n<li><p><a href=\"http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">BASE64编码原理及应用</a></p>\n</li>\n<li><p><a href=\"https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/Base64%E5%8A%A0%E5%AF%86.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64加密</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"是什么？\"><a href=\"#是什么？\" class=\"headerlink\" title=\"是什么？\"></a>是什么？</h2><blockquote>\n<p>Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation. The term Base64 originates from a specific MIME content transfer encoding<br>来自 <a href=\"https://en.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">wikipedia</a></p>\n</blockquote>\n<p>说白了就是将二进制的数据转换成字符编码。Base64由大小写字母各26个，<code>0-9</code>的10个数字，加号<code>+</code><br>以及斜杠<code>/</code>，一共64个字符组成，另外还用<code>=</code>来用作后缀，总共涉及的字符达到65个。</p>\n<blockquote>\n<p>a）所有的二进制文件，都可以因此转化为可打印的文本编码，使用文本软件进行编辑；</p>\n<p>b）能够对文本进行简单的加密。</p>\n<p>来自 <a href=\"http://www.ruanyifeng.com/blog/2008/06/base64.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64笔记-阮一峰</a></p>\n</blockquote>\n<h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><img src=\"/2016/09/26/base64/encoding.jpg\">\n<blockquote>\n<p>转换的时候，将三个byte的数据，先后放入一个24bit的缓冲区中，先来的byte占高位。数据不足3byte的话，于缓冲器中剩下的bit用0补足。然后，每次取出6（因为26=64）个bit，按照其值选择ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/中的字符作为编码后的输出。不断进行，直到全部输入数据转换完成。</p>\n<p><a href=\"https://zh.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://zh.wikipedia.org/wiki/Base64</a></p>\n</blockquote>\n<p>如果要编码的字节数不能被3整除:</p>\n<ol>\n<li>先使用0字节值在末尾补足，使其能够被3整除</li>\n<li>进行base64的编码</li>\n<li><p>在编码后的base64文本后加上一个或两个’=’号，代表补足的字节数</p>\n<img src=\"/2016/09/26/base64/encoding2.jpg\">\n</li>\n</ol>\n<p>  Base64字符串只可能最后出现一个或两个”=”，中间是不可能出现”=”的</p>\n<h2 id=\"用途\"><a href=\"#用途\" class=\"headerlink\" title=\"用途\"></a>用途</h2><blockquote>\n<p>Base64 主要不是加密，它主要的用途是把一些二进制数转成普通字符用于网络传输。由于一些二进制字符在传输协议中属于控制字符，不能直接传送需要转换一下。Base64编码就是把二进制字节序列转化为ASCII字符序列。一般增加1/3长度，而且也是不可读的。</p>\n<p><a href=\"http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">BASE64编码原理及应用</a></p>\n<p>Base64常用于在通常处理文本数据的场合，表示、传输、存储一些二进制数据。包括MIME的email、在XML中存储复杂数据。</p>\n<p><a href=\"https://zh.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://zh.wikipedia.org/wiki/Base64</a></p>\n</blockquote>\n<h2 id=\"python中简单使用\"><a href=\"#python中简单使用\" class=\"headerlink\" title=\"python中简单使用\"></a>python中简单使用</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>encoded = base64.b64encode(<span class=\"string\">'hello world'</span>)</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">print</span> encoded</span><br><span class=\"line\">aGVsbG8gd29ybGQ=</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>data = base64.b64decode(encoded)</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">print</span> data</span><br><span class=\"line\">hello world</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://docs.python.org/2/library/base64.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">base64 — RFC 3548: Base16, Base32, Base64 Data Encodings</a></p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2008/06/base64.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64笔记_阮一峰</a></p>\n</li>\n<li><p><a href=\"https://en.wikipedia.org/wiki/Base64\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64_wiki</a></p>\n</li>\n<li><p><a href=\"http://nieyong.github.io/wiki_web/BASE64%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">BASE64编码原理及应用</a></p>\n</li>\n<li><p><a href=\"https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/Base64%E5%8A%A0%E5%AF%86.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Base64加密</a></p>\n</li>\n</ol>\n"},{"title":"缓存System.currentTimeMillis的调用","toc":true,"date":"2017-12-02T14:16:31.000Z","_content":"\n\n## 系统时间缓存的必要\n\n{% asset_img time-cache.jpg %}\n\n除了网络服务器，监控系统和日志系统也会频繁的调用`System.currentTimeMillis`。看公\n司内部实现的异步日志中就对系统时间进行了缓存。\n\n## 实现\n\n{% gist a42cea0411b2cff131f34d82d030115b %}\n\n## 测试\n\n使用`JMH`做一个`benchmark`压力测试， `JMH`在做测试之前会有预热的过程，以排\n除`jit`等因素的影响，在系统达到稳定运行的时候再去对比两个方法的调用。\n\n```java\n public static void main(String[] args) throws RunnerException {\n Options opt = new OptionsBuilder()\n                .include(CurrentTimeMillions.class.getSimpleName())\n                .mode(Mode.AverageTime)\n                .measurementIterations(2000)\n                .forks(1)\n                .build();\n\n        new Runner(opt).run();\n    }\n```\n\n结果如下：\n\n```\n\n# Run complete. Total time: 01:07:53\n\nBenchmark                            Mode   Cnt   Score     Error  Units\nCurrentTimeMillions.test             avgt  2000  ≈ 10⁻⁸             s/op\nCurrentTimeMillions.testSystemTimer  avgt  2000  ≈ 10⁻⁹             s/op\n```\n\n可以看到还是差了一个数量级，如果对时间的精度要求没有那么高，还是可以缓存下的。\n\n\n## 查看调用的系统方法\n\n使用`strace`attach 到当前的进程，查看进程相应的调用\n\n```bash\nsudo strace -p  [pid]\n```\n\n输出结果如下：\n\n```\n➜ sudo strace -p 15588\nstrace: Process 15588 attached\nfutex(0x7f8c175f99d0, FUTEX_WAIT, 15589, NULL\n```\n\n并没有看到具体的系统调用，查找原因发现：\n\n> 这里使用 ltrace 是因为 linux 支持 VDSO 之后，gettimeofday 属于快速系统调用，使\n> 用 strace 是看不到执行结果的。\n\n> What is actually happening here is that we are linking to the vDSO (virtual\n> dynamic shared object), which is a small fully relocatable shared library\n> pre-mapped into the user address space. The linking happens during the first\n> call of gettimeofday, after which the call is resolved, and the first indirect\n> jump goes straight into the function.\n\n重新使用`ltrace`查看：\n\n命令：\n\n```bash\n➜  ~  sudo ltrace  -c -S  -p 16365\n^C% time     seconds  usecs/call     calls      function\n------ ----------- ----------- --------- --------------------\n 76.73   14.190163        1880      7544 SYS_getegid32\n 23.27    4.303741      614820         7 SYS_madvise1\n  0.00    0.000197          24         8 SYS_exit\n------ ----------- ----------- --------- --------------------\n100.00   18.494101                  7559 total\n```\n\n然而还是没有看到`gettimeofday`的调用，具体原因不得而知。\n\n## 结论\n\n> premature optimization is the root of all evil 过早优化是万恶之源\n\n如果系统的性能能满足我们的要求，就不要过早的做这些优化 ; 系统优化之前需要先做\nprofiling，找到真正的瓶颈，在次之前需要保持系统的简单，可靠。\n\n## 参考\n\n1. [SystemTimer CurrentTimeMillis 时间缓存 - CSDN 博客](http://blog.csdn.net/will_awoke/article/details/27084907)\n\n2. 《NIO trick and trap 》\n\n3. [System.nanoTime() 的实现分析 – 陈飞 – 码农](http://feiyang21687.github.io/SystemNano/)\n\n4. [jdk8 中的时间获取](http://blog.caoxudong.info/blog/2017/09/08/currentTimeMillis_in_java)\n\n5. [The slow currentTimeMillis()](http://pzemtsov.github.io/2017/07/23/the-slow-currenttimemillis.html)\n\n6. [Bug ID: JDK-8185891 System.currentTimeMillis() is slow on Linux, especially with the HPET time source](http://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8185891)\n","source":"_posts/cache-system-time.md","raw":"title: 缓存System.currentTimeMillis的调用\ntags: cache\ncategory: java\ntoc: true\ndate: 2017-12-02 22:16:31\n---\n\n\n## 系统时间缓存的必要\n\n{% asset_img time-cache.jpg %}\n\n除了网络服务器，监控系统和日志系统也会频繁的调用`System.currentTimeMillis`。看公\n司内部实现的异步日志中就对系统时间进行了缓存。\n\n## 实现\n\n{% gist a42cea0411b2cff131f34d82d030115b %}\n\n## 测试\n\n使用`JMH`做一个`benchmark`压力测试， `JMH`在做测试之前会有预热的过程，以排\n除`jit`等因素的影响，在系统达到稳定运行的时候再去对比两个方法的调用。\n\n```java\n public static void main(String[] args) throws RunnerException {\n Options opt = new OptionsBuilder()\n                .include(CurrentTimeMillions.class.getSimpleName())\n                .mode(Mode.AverageTime)\n                .measurementIterations(2000)\n                .forks(1)\n                .build();\n\n        new Runner(opt).run();\n    }\n```\n\n结果如下：\n\n```\n\n# Run complete. Total time: 01:07:53\n\nBenchmark                            Mode   Cnt   Score     Error  Units\nCurrentTimeMillions.test             avgt  2000  ≈ 10⁻⁸             s/op\nCurrentTimeMillions.testSystemTimer  avgt  2000  ≈ 10⁻⁹             s/op\n```\n\n可以看到还是差了一个数量级，如果对时间的精度要求没有那么高，还是可以缓存下的。\n\n\n## 查看调用的系统方法\n\n使用`strace`attach 到当前的进程，查看进程相应的调用\n\n```bash\nsudo strace -p  [pid]\n```\n\n输出结果如下：\n\n```\n➜ sudo strace -p 15588\nstrace: Process 15588 attached\nfutex(0x7f8c175f99d0, FUTEX_WAIT, 15589, NULL\n```\n\n并没有看到具体的系统调用，查找原因发现：\n\n> 这里使用 ltrace 是因为 linux 支持 VDSO 之后，gettimeofday 属于快速系统调用，使\n> 用 strace 是看不到执行结果的。\n\n> What is actually happening here is that we are linking to the vDSO (virtual\n> dynamic shared object), which is a small fully relocatable shared library\n> pre-mapped into the user address space. The linking happens during the first\n> call of gettimeofday, after which the call is resolved, and the first indirect\n> jump goes straight into the function.\n\n重新使用`ltrace`查看：\n\n命令：\n\n```bash\n➜  ~  sudo ltrace  -c -S  -p 16365\n^C% time     seconds  usecs/call     calls      function\n------ ----------- ----------- --------- --------------------\n 76.73   14.190163        1880      7544 SYS_getegid32\n 23.27    4.303741      614820         7 SYS_madvise1\n  0.00    0.000197          24         8 SYS_exit\n------ ----------- ----------- --------- --------------------\n100.00   18.494101                  7559 total\n```\n\n然而还是没有看到`gettimeofday`的调用，具体原因不得而知。\n\n## 结论\n\n> premature optimization is the root of all evil 过早优化是万恶之源\n\n如果系统的性能能满足我们的要求，就不要过早的做这些优化 ; 系统优化之前需要先做\nprofiling，找到真正的瓶颈，在次之前需要保持系统的简单，可靠。\n\n## 参考\n\n1. [SystemTimer CurrentTimeMillis 时间缓存 - CSDN 博客](http://blog.csdn.net/will_awoke/article/details/27084907)\n\n2. 《NIO trick and trap 》\n\n3. [System.nanoTime() 的实现分析 – 陈飞 – 码农](http://feiyang21687.github.io/SystemNano/)\n\n4. [jdk8 中的时间获取](http://blog.caoxudong.info/blog/2017/09/08/currentTimeMillis_in_java)\n\n5. [The slow currentTimeMillis()](http://pzemtsov.github.io/2017/07/23/the-slow-currenttimemillis.html)\n\n6. [Bug ID: JDK-8185891 System.currentTimeMillis() is slow on Linux, especially with the HPET time source](http://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8185891)\n","slug":"cache-system-time","published":1,"updated":"2017-12-02T14:16:31.044Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8q004ujh4k4c0ykylk","content":"<h2 id=\"系统时间缓存的必要\"><a href=\"#系统时间缓存的必要\" class=\"headerlink\" title=\"系统时间缓存的必要\"></a>系统时间缓存的必要</h2><img src=\"/2017/12/02/cache-system-time/time-cache.jpg\">\n<p>除了网络服务器，监控系统和日志系统也会频繁的调用<code>System.currentTimeMillis</code>。看公<br>司内部实现的异步日志中就对系统时间进行了缓存。</p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><script src=\"//gist.github.com/a42cea0411b2cff131f34d82d030115b.js\"></script>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>使用<code>JMH</code>做一个<code>benchmark</code>压力测试， <code>JMH</code>在做测试之前会有预热的过程，以排<br>除<code>jit</code>等因素的影响，在系统达到稳定运行的时候再去对比两个方法的调用。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> RunnerException </span>&#123;</span><br><span class=\"line\">Options opt = <span class=\"keyword\">new</span> OptionsBuilder()</span><br><span class=\"line\">               .include(CurrentTimeMillions.class.getSimpleName())</span><br><span class=\"line\">               .mode(Mode.AverageTime)</span><br><span class=\"line\">               .measurementIterations(<span class=\"number\">2000</span>)</span><br><span class=\"line\">               .forks(<span class=\"number\">1</span>)</span><br><span class=\"line\">               .build();</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">new</span> Runner(opt).run();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># Run complete. Total time: 01:07:53</span><br><span class=\"line\"></span><br><span class=\"line\">Benchmark                            Mode   Cnt   Score     Error  Units</span><br><span class=\"line\">CurrentTimeMillions.test             avgt  2000  ≈ 10⁻⁸             s/op</span><br><span class=\"line\">CurrentTimeMillions.testSystemTimer  avgt  2000  ≈ 10⁻⁹             s/op</span><br></pre></td></tr></table></figure>\n<p>可以看到还是差了一个数量级，如果对时间的精度要求没有那么高，还是可以缓存下的。</p>\n<h2 id=\"查看调用的系统方法\"><a href=\"#查看调用的系统方法\" class=\"headerlink\" title=\"查看调用的系统方法\"></a>查看调用的系统方法</h2><p>使用<code>strace</code>attach 到当前的进程，查看进程相应的调用</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo strace -p  [pid]</span><br></pre></td></tr></table></figure>\n<p>输出结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ sudo strace -p 15588</span><br><span class=\"line\">strace: Process 15588 attached</span><br><span class=\"line\">futex(0x7f8c175f99d0, FUTEX_WAIT, 15589, NULL</span><br></pre></td></tr></table></figure>\n<p>并没有看到具体的系统调用，查找原因发现：</p>\n<blockquote>\n<p>这里使用 ltrace 是因为 linux 支持 VDSO 之后，gettimeofday 属于快速系统调用，使<br>用 strace 是看不到执行结果的。</p>\n<p>What is actually happening here is that we are linking to the vDSO (virtual<br>dynamic shared object), which is a small fully relocatable shared library<br>pre-mapped into the user address space. The linking happens during the first<br>call of gettimeofday, after which the call is resolved, and the first indirect<br>jump goes straight into the function.</p>\n</blockquote>\n<p>重新使用<code>ltrace</code>查看：</p>\n<p>命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  sudo ltrace  -c -S  -p 16365</span><br><span class=\"line\">^C% time     seconds  usecs/call     calls      <span class=\"keyword\">function</span></span><br><span class=\"line\">------ ----------- ----------- --------- --------------------</span><br><span class=\"line\"> 76.73   14.190163        1880      7544 SYS_getegid32</span><br><span class=\"line\"> 23.27    4.303741      614820         7 SYS_madvise1</span><br><span class=\"line\">  0.00    0.000197          24         8 SYS_exit</span><br><span class=\"line\">------ ----------- ----------- --------- --------------------</span><br><span class=\"line\">100.00   18.494101                  7559 total</span><br></pre></td></tr></table></figure>\n<p>然而还是没有看到<code>gettimeofday</code>的调用，具体原因不得而知。</p>\n<h2 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h2><blockquote>\n<p>premature optimization is the root of all evil 过早优化是万恶之源</p>\n</blockquote>\n<p>如果系统的性能能满足我们的要求，就不要过早的做这些优化 ; 系统优化之前需要先做<br>profiling，找到真正的瓶颈，在次之前需要保持系统的简单，可靠。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://blog.csdn.net/will_awoke/article/details/27084907\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SystemTimer CurrentTimeMillis 时间缓存 - CSDN 博客</a></p>\n</li>\n<li><p>《NIO trick and trap 》</p>\n</li>\n<li><p><a href=\"http://feiyang21687.github.io/SystemNano/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">System.nanoTime() 的实现分析 – 陈飞 – 码农</a></p>\n</li>\n<li><p><a href=\"http://blog.caoxudong.info/blog/2017/09/08/currentTimeMillis_in_java\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">jdk8 中的时间获取</a></p>\n</li>\n<li><p><a href=\"http://pzemtsov.github.io/2017/07/23/the-slow-currenttimemillis.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The slow currentTimeMillis()</a></p>\n</li>\n<li><p><a href=\"http://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8185891\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Bug ID: JDK-8185891 System.currentTimeMillis() is slow on Linux, especially with the HPET time source</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"系统时间缓存的必要\"><a href=\"#系统时间缓存的必要\" class=\"headerlink\" title=\"系统时间缓存的必要\"></a>系统时间缓存的必要</h2><img src=\"/2017/12/02/cache-system-time/time-cache.jpg\">\n<p>除了网络服务器，监控系统和日志系统也会频繁的调用<code>System.currentTimeMillis</code>。看公<br>司内部实现的异步日志中就对系统时间进行了缓存。</p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><script src=\"//gist.github.com/a42cea0411b2cff131f34d82d030115b.js\"></script>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>使用<code>JMH</code>做一个<code>benchmark</code>压力测试， <code>JMH</code>在做测试之前会有预热的过程，以排<br>除<code>jit</code>等因素的影响，在系统达到稳定运行的时候再去对比两个方法的调用。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> RunnerException </span>&#123;</span><br><span class=\"line\">Options opt = <span class=\"keyword\">new</span> OptionsBuilder()</span><br><span class=\"line\">               .include(CurrentTimeMillions.class.getSimpleName())</span><br><span class=\"line\">               .mode(Mode.AverageTime)</span><br><span class=\"line\">               .measurementIterations(<span class=\"number\">2000</span>)</span><br><span class=\"line\">               .forks(<span class=\"number\">1</span>)</span><br><span class=\"line\">               .build();</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">new</span> Runner(opt).run();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># Run complete. Total time: 01:07:53</span><br><span class=\"line\"></span><br><span class=\"line\">Benchmark                            Mode   Cnt   Score     Error  Units</span><br><span class=\"line\">CurrentTimeMillions.test             avgt  2000  ≈ 10⁻⁸             s/op</span><br><span class=\"line\">CurrentTimeMillions.testSystemTimer  avgt  2000  ≈ 10⁻⁹             s/op</span><br></pre></td></tr></table></figure>\n<p>可以看到还是差了一个数量级，如果对时间的精度要求没有那么高，还是可以缓存下的。</p>\n<h2 id=\"查看调用的系统方法\"><a href=\"#查看调用的系统方法\" class=\"headerlink\" title=\"查看调用的系统方法\"></a>查看调用的系统方法</h2><p>使用<code>strace</code>attach 到当前的进程，查看进程相应的调用</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo strace -p  [pid]</span><br></pre></td></tr></table></figure>\n<p>输出结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ sudo strace -p 15588</span><br><span class=\"line\">strace: Process 15588 attached</span><br><span class=\"line\">futex(0x7f8c175f99d0, FUTEX_WAIT, 15589, NULL</span><br></pre></td></tr></table></figure>\n<p>并没有看到具体的系统调用，查找原因发现：</p>\n<blockquote>\n<p>这里使用 ltrace 是因为 linux 支持 VDSO 之后，gettimeofday 属于快速系统调用，使<br>用 strace 是看不到执行结果的。</p>\n<p>What is actually happening here is that we are linking to the vDSO (virtual<br>dynamic shared object), which is a small fully relocatable shared library<br>pre-mapped into the user address space. The linking happens during the first<br>call of gettimeofday, after which the call is resolved, and the first indirect<br>jump goes straight into the function.</p>\n</blockquote>\n<p>重新使用<code>ltrace</code>查看：</p>\n<p>命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  sudo ltrace  -c -S  -p 16365</span><br><span class=\"line\">^C% time     seconds  usecs/call     calls      <span class=\"keyword\">function</span></span><br><span class=\"line\">------ ----------- ----------- --------- --------------------</span><br><span class=\"line\"> 76.73   14.190163        1880      7544 SYS_getegid32</span><br><span class=\"line\"> 23.27    4.303741      614820         7 SYS_madvise1</span><br><span class=\"line\">  0.00    0.000197          24         8 SYS_exit</span><br><span class=\"line\">------ ----------- ----------- --------- --------------------</span><br><span class=\"line\">100.00   18.494101                  7559 total</span><br></pre></td></tr></table></figure>\n<p>然而还是没有看到<code>gettimeofday</code>的调用，具体原因不得而知。</p>\n<h2 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h2><blockquote>\n<p>premature optimization is the root of all evil 过早优化是万恶之源</p>\n</blockquote>\n<p>如果系统的性能能满足我们的要求，就不要过早的做这些优化 ; 系统优化之前需要先做<br>profiling，找到真正的瓶颈，在次之前需要保持系统的简单，可靠。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://blog.csdn.net/will_awoke/article/details/27084907\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">SystemTimer CurrentTimeMillis 时间缓存 - CSDN 博客</a></p>\n</li>\n<li><p>《NIO trick and trap 》</p>\n</li>\n<li><p><a href=\"http://feiyang21687.github.io/SystemNano/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">System.nanoTime() 的实现分析 – 陈飞 – 码农</a></p>\n</li>\n<li><p><a href=\"http://blog.caoxudong.info/blog/2017/09/08/currentTimeMillis_in_java\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">jdk8 中的时间获取</a></p>\n</li>\n<li><p><a href=\"http://pzemtsov.github.io/2017/07/23/the-slow-currenttimemillis.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The slow currentTimeMillis()</a></p>\n</li>\n<li><p><a href=\"http://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8185891\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Bug ID: JDK-8185891 System.currentTimeMillis() is slow on Linux, especially with the HPET time source</a></p>\n</li>\n</ol>\n"},{"title":"Spring自定义标签，使用和源码","toc":true,"abbrlink":46833,"date":"2016-10-23T11:43:57.000Z","_content":"\n\n## 自定义标签\n\nSpring中的标签具有很强的扩展性，我们可以很方便的扩展出自己的标签，做出类似下面的标签\n```xml\n<dubbo:service interface=\"com.foo.BarService\" ref=\"barService\" />\n<dubbo:reference id=\"barService\" interface=\"com.foo.BarService\" />\n```\n\n### 1. Authoring the schema\n定义标签的xml描述：\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsd:schema xmlns=\"http://www.mycompany.com/schema/myns\"\n        xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n        xmlns:beans=\"http://www.springframework.org/schema/beans\"\n        targetNamespace=\"http://www.mycompany.com/schema/myns\"\n        elementFormDefault=\"qualified\"\n        attributeFormDefault=\"unqualified\">\n\n    <xsd:import namespace=\"http://www.springframework.org/schema/beans\"/>\n\n    <xsd:element name=\"dateformat\">\n        <xsd:complexType>\n            <xsd:complexContent>\n                <xsd:extension base=\"beans:identifiedType\">\n                    <xsd:attribute name=\"lenient\" type=\"xsd:boolean\"/>\n                    <xsd:attribute name=\"pattern\" type=\"xsd:string\" use=\"required\"/>\n                </xsd:extension>\n            </xsd:complexContent>\n        </xsd:complexType>\n    </xsd:element>\n</xsd:schema>\n```\n定义了标签里面的属性和属性的类型， 在解析xml的时候spring会进行校验\n\n### 2. Coding a NamespaceHandler\n\n```java\npackage org.springframework.samples.xml;\n\nimport org.springframework.beans.factory.xml.NamespaceHandlerSupport;\n\npublic class MyNamespaceHandler extends NamespaceHandlerSupport {\n\n    public void init() {\n        registerBeanDefinitionParser(\"dateformat\", new SimpleDateFormatBeanDefinitionParser());\n    }\n\n}\n```\n主要是定义标签的处理类，这里是`SimpleDateFormatBeanDefinitionParser`\n\n### 3. BeanDefinitionParser\n```java\npackage org.springframework.samples.xml;\n\nimport org.springframework.beans.factory.support.BeanDefinitionBuilder;\nimport org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;\nimport org.springframework.util.StringUtils;\nimport org.w3c.dom.Element;\n\nimport java.text.SimpleDateFormat;\n\npublic class SimpleDateFormatBeanDefinitionParser extends AbstractSingleBeanDefinitionParser {\n\n    protected Class getBeanClass(Element element) {\n        return SimpleDateFormat.class;\n    }\n\n    protected void doParse(Element element, BeanDefinitionBuilder bean) {\n        // this will never be null since the schema explicitly requires that a value be supplied\n        String pattern = element.getAttribute(\"pattern\");\n        bean.addConstructorArg(pattern);\n\n        // this however is an optional property\n        String lenient = element.getAttribute(\"lenient\");\n        if (StringUtils.hasText(lenient)) {\n            bean.addPropertyValue(\"lenient\", Boolean.valueOf(lenient));\n        }\n    }\n\n}\n```\n\n该类继承自spring提供的抽象类`AbstractSingleBeanDefinitionParser`，提供了许多基本的功能，解析标签的方法在`doParse`中，spring会传入一个标签元素`Element`和`BeanDefinitionBuilder`的上下文。\n\n### 4. Registering the handler and the schema\n```\n└─META-INF\n        spring.handlers\n        spring.schemas\n```\n`spring.handlers`中的内容如下：\n\n```xml\nhttp\\://www.mycompany.com/schema/myns=org.springframework.samples.xml.MyNamespaceHandler\n```\n`spring.schemas`中内容如下：\n\n```xml\nhttp\\://www.mycompany.com/schema/myns/myns.xsd=org/springframework/samples/xml/myns.xsd\n```\n\nspring在加载这个jar包的时候会自动的从这些文件中解析到我们的配置，当解析到相应的标签的时候就会交给我们定义的解析类来处理。\n```xml\n<myns:dateformat id=\"dateFormat\"\npattern=\"yyyy-MM-dd HH:mm\"\nlenient=\"true\"/>\n```\n\n## Custom attributes on 'normal' elements\n\n除了自定义标签外，还可以为已有标签装饰一个新的属性\n\n```xml\n<bean id=\"checkingAccountService\" class=\"com.foo.DefaultCheckingAccountService\"\n        jcache:cache-name=\"checking.account\">\n    <!-- other dependencies here... -->\n</bean>\n```\nspring可以让我们单独处理这个`jcache:cache-name`这个属性。\n\n### 定义schema\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n\n<xsd:schema xmlns=\"http://www.foo.com/schema/jcache\"\n        xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n        targetNamespace=\"http://www.foo.com/schema/jcache\"\n        elementFormDefault=\"qualified\">\n\n    <xsd:attribute name=\"cache-name\" type=\"xsd:string\"/>\n\n</xsd:schema>\n```\n\n### NamespaceHandler\n\n```java\npublic class JCacheNamespaceHandler extends NamespaceHandlerSupport {\n\n    public void init() {\n        super.registerBeanDefinitionDecoratorForAttribute(\"cache-name\",\n            new JCacheInitializingBeanDefinitionDecorator());\n    }\n\n}\n```\n\n实际的调用行为已经被抽象到`NamespaceHandlerSupport`中\n\n```java\n/**\n * Decorates the supplied {@link Node} by delegating to the {@link BeanDefinitionDecorator} that\n * is registered to handle that {@link Node}.\n */\n@Override\npublic BeanDefinitionHolder decorate(\n    Node node, BeanDefinitionHolder definition, ParserContext parserContext) {\n\n  return findDecoratorForNode(node, parserContext).decorate(node, definition, parserContext);\n}\n```\n\n### BeanDefinitionDecorator\n\n```java\npublic class JCacheInitializingBeanDefinitionDecorator implements BeanDefinitionDecorator {\n\n    private static final String[] EMPTY_STRING_ARRAY = new String[0];\n\n    public BeanDefinitionHolder decorate(Node source, BeanDefinitionHolder holder,\n            ParserContext ctx) {\n        String initializerBeanName = registerJCacheInitializer(source, ctx);\n        createDependencyOnJCacheInitializer(holder, initializerBeanName);\n        return holder;\n    }\n\n    private void createDependencyOnJCacheInitializer(BeanDefinitionHolder holder,\n            String initializerBeanName) {\n        AbstractBeanDefinition definition = ((AbstractBeanDefinition) holder.getBeanDefinition());\n        String[] dependsOn = definition.getDependsOn();\n        if (dependsOn == null) {\n            dependsOn = new String[]{initializerBeanName};\n        } else {\n            List dependencies = new ArrayList(Arrays.asList(dependsOn));\n            dependencies.add(initializerBeanName);\n            dependsOn = (String[]) dependencies.toArray(EMPTY_STRING_ARRAY);\n        }\n        definition.setDependsOn(dependsOn);\n    }\n\n    private String registerJCacheInitializer(Node source, ParserContext ctx) {\n        String cacheName = ((Attr) source).getValue();\n        String beanName = cacheName + \"-initializer\";\n        if (!ctx.getRegistry().containsBeanDefinition(beanName)) {\n            BeanDefinitionBuilder initializer = BeanDefinitionBuilder.rootBeanDefinition(JCacheInitializer.class);\n            initializer.addConstructorArg(cacheName);\n            ctx.getRegistry().registerBeanDefinition(beanName, initializer.getBeanDefinition());\n        }\n        return beanName;\n    }\n\n}\n\n```\n\n### META-INF\n```xml\n# in 'META-INF/spring.handlers'\nhttp\\://www.foo.com/schema/jcache=com.foo.JCacheNamespaceHandler\n# in 'META-INF/spring.schemas'\nhttp\\://www.foo.com/schema/jcache/jcache.xsd=com/foo/jcache.xsd\n\n```\n\n## 参考\n\n1. [spring-framework-reference](http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/)\n","source":"_posts/custom-tag.md","raw":"---\ntitle: Spring自定义标签，使用和源码\ntags: 自定义标签\ncategory: spring\ntoc: true\nabbrlink: 46833\ndate: 2016-10-23 19:43:57\n---\n\n\n## 自定义标签\n\nSpring中的标签具有很强的扩展性，我们可以很方便的扩展出自己的标签，做出类似下面的标签\n```xml\n<dubbo:service interface=\"com.foo.BarService\" ref=\"barService\" />\n<dubbo:reference id=\"barService\" interface=\"com.foo.BarService\" />\n```\n\n### 1. Authoring the schema\n定义标签的xml描述：\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xsd:schema xmlns=\"http://www.mycompany.com/schema/myns\"\n        xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n        xmlns:beans=\"http://www.springframework.org/schema/beans\"\n        targetNamespace=\"http://www.mycompany.com/schema/myns\"\n        elementFormDefault=\"qualified\"\n        attributeFormDefault=\"unqualified\">\n\n    <xsd:import namespace=\"http://www.springframework.org/schema/beans\"/>\n\n    <xsd:element name=\"dateformat\">\n        <xsd:complexType>\n            <xsd:complexContent>\n                <xsd:extension base=\"beans:identifiedType\">\n                    <xsd:attribute name=\"lenient\" type=\"xsd:boolean\"/>\n                    <xsd:attribute name=\"pattern\" type=\"xsd:string\" use=\"required\"/>\n                </xsd:extension>\n            </xsd:complexContent>\n        </xsd:complexType>\n    </xsd:element>\n</xsd:schema>\n```\n定义了标签里面的属性和属性的类型， 在解析xml的时候spring会进行校验\n\n### 2. Coding a NamespaceHandler\n\n```java\npackage org.springframework.samples.xml;\n\nimport org.springframework.beans.factory.xml.NamespaceHandlerSupport;\n\npublic class MyNamespaceHandler extends NamespaceHandlerSupport {\n\n    public void init() {\n        registerBeanDefinitionParser(\"dateformat\", new SimpleDateFormatBeanDefinitionParser());\n    }\n\n}\n```\n主要是定义标签的处理类，这里是`SimpleDateFormatBeanDefinitionParser`\n\n### 3. BeanDefinitionParser\n```java\npackage org.springframework.samples.xml;\n\nimport org.springframework.beans.factory.support.BeanDefinitionBuilder;\nimport org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;\nimport org.springframework.util.StringUtils;\nimport org.w3c.dom.Element;\n\nimport java.text.SimpleDateFormat;\n\npublic class SimpleDateFormatBeanDefinitionParser extends AbstractSingleBeanDefinitionParser {\n\n    protected Class getBeanClass(Element element) {\n        return SimpleDateFormat.class;\n    }\n\n    protected void doParse(Element element, BeanDefinitionBuilder bean) {\n        // this will never be null since the schema explicitly requires that a value be supplied\n        String pattern = element.getAttribute(\"pattern\");\n        bean.addConstructorArg(pattern);\n\n        // this however is an optional property\n        String lenient = element.getAttribute(\"lenient\");\n        if (StringUtils.hasText(lenient)) {\n            bean.addPropertyValue(\"lenient\", Boolean.valueOf(lenient));\n        }\n    }\n\n}\n```\n\n该类继承自spring提供的抽象类`AbstractSingleBeanDefinitionParser`，提供了许多基本的功能，解析标签的方法在`doParse`中，spring会传入一个标签元素`Element`和`BeanDefinitionBuilder`的上下文。\n\n### 4. Registering the handler and the schema\n```\n└─META-INF\n        spring.handlers\n        spring.schemas\n```\n`spring.handlers`中的内容如下：\n\n```xml\nhttp\\://www.mycompany.com/schema/myns=org.springframework.samples.xml.MyNamespaceHandler\n```\n`spring.schemas`中内容如下：\n\n```xml\nhttp\\://www.mycompany.com/schema/myns/myns.xsd=org/springframework/samples/xml/myns.xsd\n```\n\nspring在加载这个jar包的时候会自动的从这些文件中解析到我们的配置，当解析到相应的标签的时候就会交给我们定义的解析类来处理。\n```xml\n<myns:dateformat id=\"dateFormat\"\npattern=\"yyyy-MM-dd HH:mm\"\nlenient=\"true\"/>\n```\n\n## Custom attributes on 'normal' elements\n\n除了自定义标签外，还可以为已有标签装饰一个新的属性\n\n```xml\n<bean id=\"checkingAccountService\" class=\"com.foo.DefaultCheckingAccountService\"\n        jcache:cache-name=\"checking.account\">\n    <!-- other dependencies here... -->\n</bean>\n```\nspring可以让我们单独处理这个`jcache:cache-name`这个属性。\n\n### 定义schema\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n\n<xsd:schema xmlns=\"http://www.foo.com/schema/jcache\"\n        xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n        targetNamespace=\"http://www.foo.com/schema/jcache\"\n        elementFormDefault=\"qualified\">\n\n    <xsd:attribute name=\"cache-name\" type=\"xsd:string\"/>\n\n</xsd:schema>\n```\n\n### NamespaceHandler\n\n```java\npublic class JCacheNamespaceHandler extends NamespaceHandlerSupport {\n\n    public void init() {\n        super.registerBeanDefinitionDecoratorForAttribute(\"cache-name\",\n            new JCacheInitializingBeanDefinitionDecorator());\n    }\n\n}\n```\n\n实际的调用行为已经被抽象到`NamespaceHandlerSupport`中\n\n```java\n/**\n * Decorates the supplied {@link Node} by delegating to the {@link BeanDefinitionDecorator} that\n * is registered to handle that {@link Node}.\n */\n@Override\npublic BeanDefinitionHolder decorate(\n    Node node, BeanDefinitionHolder definition, ParserContext parserContext) {\n\n  return findDecoratorForNode(node, parserContext).decorate(node, definition, parserContext);\n}\n```\n\n### BeanDefinitionDecorator\n\n```java\npublic class JCacheInitializingBeanDefinitionDecorator implements BeanDefinitionDecorator {\n\n    private static final String[] EMPTY_STRING_ARRAY = new String[0];\n\n    public BeanDefinitionHolder decorate(Node source, BeanDefinitionHolder holder,\n            ParserContext ctx) {\n        String initializerBeanName = registerJCacheInitializer(source, ctx);\n        createDependencyOnJCacheInitializer(holder, initializerBeanName);\n        return holder;\n    }\n\n    private void createDependencyOnJCacheInitializer(BeanDefinitionHolder holder,\n            String initializerBeanName) {\n        AbstractBeanDefinition definition = ((AbstractBeanDefinition) holder.getBeanDefinition());\n        String[] dependsOn = definition.getDependsOn();\n        if (dependsOn == null) {\n            dependsOn = new String[]{initializerBeanName};\n        } else {\n            List dependencies = new ArrayList(Arrays.asList(dependsOn));\n            dependencies.add(initializerBeanName);\n            dependsOn = (String[]) dependencies.toArray(EMPTY_STRING_ARRAY);\n        }\n        definition.setDependsOn(dependsOn);\n    }\n\n    private String registerJCacheInitializer(Node source, ParserContext ctx) {\n        String cacheName = ((Attr) source).getValue();\n        String beanName = cacheName + \"-initializer\";\n        if (!ctx.getRegistry().containsBeanDefinition(beanName)) {\n            BeanDefinitionBuilder initializer = BeanDefinitionBuilder.rootBeanDefinition(JCacheInitializer.class);\n            initializer.addConstructorArg(cacheName);\n            ctx.getRegistry().registerBeanDefinition(beanName, initializer.getBeanDefinition());\n        }\n        return beanName;\n    }\n\n}\n\n```\n\n### META-INF\n```xml\n# in 'META-INF/spring.handlers'\nhttp\\://www.foo.com/schema/jcache=com.foo.JCacheNamespaceHandler\n# in 'META-INF/spring.schemas'\nhttp\\://www.foo.com/schema/jcache/jcache.xsd=com/foo/jcache.xsd\n\n```\n\n## 参考\n\n1. [spring-framework-reference](http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/)\n","slug":"custom-tag","published":1,"updated":"2017-04-16T12:03:23.389Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8s004yjh4k3vdc1zkb","content":"<h2 id=\"自定义标签\"><a href=\"#自定义标签\" class=\"headerlink\" title=\"自定义标签\"></a>自定义标签</h2><p>Spring中的标签具有很强的扩展性，我们可以很方便的扩展出自己的标签，做出类似下面的标签<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:service</span> <span class=\"attr\">interface</span>=<span class=\"string\">\"com.foo.BarService\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"barService\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:reference</span> <span class=\"attr\">id</span>=<span class=\"string\">\"barService\"</span> <span class=\"attr\">interface</span>=<span class=\"string\">\"com.foo.BarService\"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"1-Authoring-the-schema\"><a href=\"#1-Authoring-the-schema\" class=\"headerlink\" title=\"1. Authoring the schema\"></a>1. Authoring the schema</h3><p>定义标签的xml描述：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xsd:schema</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://www.mycompany.com/schema/myns\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">xmlns:xsd</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">xmlns:beans</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">targetNamespace</span>=<span class=\"string\">\"http://www.mycompany.com/schema/myns\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">elementFormDefault</span>=<span class=\"string\">\"qualified\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">attributeFormDefault</span>=<span class=\"string\">\"unqualified\"</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xsd:import</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xsd:element</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dateformat\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">xsd:complexType</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">xsd:complexContent</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">xsd:extension</span> <span class=\"attr\">base</span>=<span class=\"string\">\"beans:identifiedType\"</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"lenient\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:boolean\"</span>/&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"pattern\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span> <span class=\"attr\">use</span>=<span class=\"string\">\"required\"</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">xsd:extension</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">xsd:complexContent</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">xsd:complexType</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">xsd:element</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>定义了标签里面的属性和属性的类型， 在解析xml的时候spring会进行校验</p>\n<h3 id=\"2-Coding-a-NamespaceHandler\"><a href=\"#2-Coding-a-NamespaceHandler\" class=\"headerlink\" title=\"2. Coding a NamespaceHandler\"></a>2. Coding a NamespaceHandler</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.samples.xml;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyNamespaceHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        registerBeanDefinitionParser(<span class=\"string\">\"dateformat\"</span>, <span class=\"keyword\">new</span> SimpleDateFormatBeanDefinitionParser());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要是定义标签的处理类，这里是<code>SimpleDateFormatBeanDefinitionParser</code></p>\n<h3 id=\"3-BeanDefinitionParser\"><a href=\"#3-BeanDefinitionParser\" class=\"headerlink\" title=\"3. BeanDefinitionParser\"></a>3. BeanDefinitionParser</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.samples.xml;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.w3c.dom.Element;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.text.SimpleDateFormat;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleDateFormatBeanDefinitionParser</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Class <span class=\"title\">getBeanClass</span><span class=\"params\">(Element element)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SimpleDateFormat.class;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doParse</span><span class=\"params\">(Element element, BeanDefinitionBuilder bean)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// this will never be null since the schema explicitly requires that a value be supplied</span></span><br><span class=\"line\">        String pattern = element.getAttribute(<span class=\"string\">\"pattern\"</span>);</span><br><span class=\"line\">        bean.addConstructorArg(pattern);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// this however is an optional property</span></span><br><span class=\"line\">        String lenient = element.getAttribute(<span class=\"string\">\"lenient\"</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtils.hasText(lenient)) &#123;</span><br><span class=\"line\">            bean.addPropertyValue(<span class=\"string\">\"lenient\"</span>, Boolean.valueOf(lenient));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该类继承自spring提供的抽象类<code>AbstractSingleBeanDefinitionParser</code>，提供了许多基本的功能，解析标签的方法在<code>doParse</code>中，spring会传入一个标签元素<code>Element</code>和<code>BeanDefinitionBuilder</code>的上下文。</p>\n<h3 id=\"4-Registering-the-handler-and-the-schema\"><a href=\"#4-Registering-the-handler-and-the-schema\" class=\"headerlink\" title=\"4. Registering the handler and the schema\"></a>4. Registering the handler and the schema</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">└─META-INF</span><br><span class=\"line\">        spring.handlers</span><br><span class=\"line\">        spring.schemas</span><br></pre></td></tr></table></figure>\n<p><code>spring.handlers</code>中的内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.mycompany.com/schema/myns=org.springframework.samples.xml.MyNamespaceHandler</span><br></pre></td></tr></table></figure>\n<p><code>spring.schemas</code>中内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.mycompany.com/schema/myns/myns.xsd=org/springframework/samples/xml/myns.xsd</span><br></pre></td></tr></table></figure>\n<p>spring在加载这个jar包的时候会自动的从这些文件中解析到我们的配置，当解析到相应的标签的时候就会交给我们定义的解析类来处理。<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">myns:dateformat</span> <span class=\"attr\">id</span>=<span class=\"string\">\"dateFormat\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">pattern</span>=<span class=\"string\">\"yyyy-MM-dd HH:mm\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">lenient</span>=<span class=\"string\">\"true\"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Custom-attributes-on-‘normal’-elements\"><a href=\"#Custom-attributes-on-‘normal’-elements\" class=\"headerlink\" title=\"Custom attributes on ‘normal’ elements\"></a>Custom attributes on ‘normal’ elements</h2><p>除了自定义标签外，还可以为已有标签装饰一个新的属性</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"checkingAccountService\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.foo.DefaultCheckingAccountService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">jcache:cache-name</span>=<span class=\"string\">\"checking.account\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- other dependencies here... --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>spring可以让我们单独处理这个<code>jcache:cache-name</code>这个属性。</p>\n<h3 id=\"定义schema\"><a href=\"#定义schema\" class=\"headerlink\" title=\"定义schema\"></a>定义schema</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xsd:schema</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://www.foo.com/schema/jcache\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">xmlns:xsd</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">targetNamespace</span>=<span class=\"string\">\"http://www.foo.com/schema/jcache\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">elementFormDefault</span>=<span class=\"string\">\"qualified\"</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"cache-name\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"NamespaceHandler\"><a href=\"#NamespaceHandler\" class=\"headerlink\" title=\"NamespaceHandler\"></a>NamespaceHandler</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JCacheNamespaceHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.registerBeanDefinitionDecoratorForAttribute(<span class=\"string\">\"cache-name\"</span>,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> JCacheInitializingBeanDefinitionDecorator());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>实际的调用行为已经被抽象到<code>NamespaceHandlerSupport</code>中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Decorates the supplied &#123;<span class=\"doctag\">@link</span> Node&#125; by delegating to the &#123;<span class=\"doctag\">@link</span> BeanDefinitionDecorator&#125; that</span></span><br><span class=\"line\"><span class=\"comment\"> * is registered to handle that &#123;<span class=\"doctag\">@link</span> Node&#125;.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> BeanDefinitionHolder <span class=\"title\">decorate</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    Node node, BeanDefinitionHolder definition, ParserContext parserContext)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> findDecoratorForNode(node, parserContext).decorate(node, definition, parserContext);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"BeanDefinitionDecorator\"><a href=\"#BeanDefinitionDecorator\" class=\"headerlink\" title=\"BeanDefinitionDecorator\"></a>BeanDefinitionDecorator</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JCacheInitializingBeanDefinitionDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title\">BeanDefinitionDecorator</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String[] EMPTY_STRING_ARRAY = <span class=\"keyword\">new</span> String[<span class=\"number\">0</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> BeanDefinitionHolder <span class=\"title\">decorate</span><span class=\"params\">(Node source, BeanDefinitionHolder holder,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            ParserContext ctx)</span> </span>&#123;</span><br><span class=\"line\">        String initializerBeanName = registerJCacheInitializer(source, ctx);</span><br><span class=\"line\">        createDependencyOnJCacheInitializer(holder, initializerBeanName);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> holder;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">createDependencyOnJCacheInitializer</span><span class=\"params\">(BeanDefinitionHolder holder,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            String initializerBeanName)</span> </span>&#123;</span><br><span class=\"line\">        AbstractBeanDefinition definition = ((AbstractBeanDefinition) holder.getBeanDefinition());</span><br><span class=\"line\">        String[] dependsOn = definition.getDependsOn();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (dependsOn == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            dependsOn = <span class=\"keyword\">new</span> String[]&#123;initializerBeanName&#125;;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            List dependencies = <span class=\"keyword\">new</span> ArrayList(Arrays.asList(dependsOn));</span><br><span class=\"line\">            dependencies.add(initializerBeanName);</span><br><span class=\"line\">            dependsOn = (String[]) dependencies.toArray(EMPTY_STRING_ARRAY);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        definition.setDependsOn(dependsOn);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">registerJCacheInitializer</span><span class=\"params\">(Node source, ParserContext ctx)</span> </span>&#123;</span><br><span class=\"line\">        String cacheName = ((Attr) source).getValue();</span><br><span class=\"line\">        String beanName = cacheName + <span class=\"string\">\"-initializer\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!ctx.getRegistry().containsBeanDefinition(beanName)) &#123;</span><br><span class=\"line\">            BeanDefinitionBuilder initializer = BeanDefinitionBuilder.rootBeanDefinition(JCacheInitializer.class);</span><br><span class=\"line\">            initializer.addConstructorArg(cacheName);</span><br><span class=\"line\">            ctx.getRegistry().registerBeanDefinition(beanName, initializer.getBeanDefinition());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> beanName;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"META-INF\"><a href=\"#META-INF\" class=\"headerlink\" title=\"META-INF\"></a>META-INF</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># in 'META-INF/spring.handlers'</span><br><span class=\"line\">http\\://www.foo.com/schema/jcache=com.foo.JCacheNamespaceHandler</span><br><span class=\"line\"># in 'META-INF/spring.schemas'</span><br><span class=\"line\">http\\://www.foo.com/schema/jcache/jcache.xsd=com/foo/jcache.xsd</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring-framework-reference</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"自定义标签\"><a href=\"#自定义标签\" class=\"headerlink\" title=\"自定义标签\"></a>自定义标签</h2><p>Spring中的标签具有很强的扩展性，我们可以很方便的扩展出自己的标签，做出类似下面的标签<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:service</span> <span class=\"attr\">interface</span>=<span class=\"string\">\"com.foo.BarService\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"barService\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:reference</span> <span class=\"attr\">id</span>=<span class=\"string\">\"barService\"</span> <span class=\"attr\">interface</span>=<span class=\"string\">\"com.foo.BarService\"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"1-Authoring-the-schema\"><a href=\"#1-Authoring-the-schema\" class=\"headerlink\" title=\"1. Authoring the schema\"></a>1. Authoring the schema</h3><p>定义标签的xml描述：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xsd:schema</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://www.mycompany.com/schema/myns\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">xmlns:xsd</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">xmlns:beans</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">targetNamespace</span>=<span class=\"string\">\"http://www.mycompany.com/schema/myns\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">elementFormDefault</span>=<span class=\"string\">\"qualified\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">attributeFormDefault</span>=<span class=\"string\">\"unqualified\"</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xsd:import</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xsd:element</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dateformat\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">xsd:complexType</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">xsd:complexContent</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">xsd:extension</span> <span class=\"attr\">base</span>=<span class=\"string\">\"beans:identifiedType\"</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"lenient\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:boolean\"</span>/&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"pattern\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span> <span class=\"attr\">use</span>=<span class=\"string\">\"required\"</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">xsd:extension</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">xsd:complexContent</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">xsd:complexType</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">xsd:element</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>定义了标签里面的属性和属性的类型， 在解析xml的时候spring会进行校验</p>\n<h3 id=\"2-Coding-a-NamespaceHandler\"><a href=\"#2-Coding-a-NamespaceHandler\" class=\"headerlink\" title=\"2. Coding a NamespaceHandler\"></a>2. Coding a NamespaceHandler</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.samples.xml;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyNamespaceHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        registerBeanDefinitionParser(<span class=\"string\">\"dateformat\"</span>, <span class=\"keyword\">new</span> SimpleDateFormatBeanDefinitionParser());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要是定义标签的处理类，这里是<code>SimpleDateFormatBeanDefinitionParser</code></p>\n<h3 id=\"3-BeanDefinitionParser\"><a href=\"#3-BeanDefinitionParser\" class=\"headerlink\" title=\"3. BeanDefinitionParser\"></a>3. BeanDefinitionParser</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.samples.xml;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.w3c.dom.Element;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.text.SimpleDateFormat;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleDateFormatBeanDefinitionParser</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Class <span class=\"title\">getBeanClass</span><span class=\"params\">(Element element)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> SimpleDateFormat.class;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doParse</span><span class=\"params\">(Element element, BeanDefinitionBuilder bean)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// this will never be null since the schema explicitly requires that a value be supplied</span></span><br><span class=\"line\">        String pattern = element.getAttribute(<span class=\"string\">\"pattern\"</span>);</span><br><span class=\"line\">        bean.addConstructorArg(pattern);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// this however is an optional property</span></span><br><span class=\"line\">        String lenient = element.getAttribute(<span class=\"string\">\"lenient\"</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtils.hasText(lenient)) &#123;</span><br><span class=\"line\">            bean.addPropertyValue(<span class=\"string\">\"lenient\"</span>, Boolean.valueOf(lenient));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该类继承自spring提供的抽象类<code>AbstractSingleBeanDefinitionParser</code>，提供了许多基本的功能，解析标签的方法在<code>doParse</code>中，spring会传入一个标签元素<code>Element</code>和<code>BeanDefinitionBuilder</code>的上下文。</p>\n<h3 id=\"4-Registering-the-handler-and-the-schema\"><a href=\"#4-Registering-the-handler-and-the-schema\" class=\"headerlink\" title=\"4. Registering the handler and the schema\"></a>4. Registering the handler and the schema</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">└─META-INF</span><br><span class=\"line\">        spring.handlers</span><br><span class=\"line\">        spring.schemas</span><br></pre></td></tr></table></figure>\n<p><code>spring.handlers</code>中的内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.mycompany.com/schema/myns=org.springframework.samples.xml.MyNamespaceHandler</span><br></pre></td></tr></table></figure>\n<p><code>spring.schemas</code>中内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.mycompany.com/schema/myns/myns.xsd=org/springframework/samples/xml/myns.xsd</span><br></pre></td></tr></table></figure>\n<p>spring在加载这个jar包的时候会自动的从这些文件中解析到我们的配置，当解析到相应的标签的时候就会交给我们定义的解析类来处理。<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">myns:dateformat</span> <span class=\"attr\">id</span>=<span class=\"string\">\"dateFormat\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">pattern</span>=<span class=\"string\">\"yyyy-MM-dd HH:mm\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">lenient</span>=<span class=\"string\">\"true\"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Custom-attributes-on-‘normal’-elements\"><a href=\"#Custom-attributes-on-‘normal’-elements\" class=\"headerlink\" title=\"Custom attributes on ‘normal’ elements\"></a>Custom attributes on ‘normal’ elements</h2><p>除了自定义标签外，还可以为已有标签装饰一个新的属性</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"checkingAccountService\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.foo.DefaultCheckingAccountService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">jcache:cache-name</span>=<span class=\"string\">\"checking.account\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- other dependencies here... --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>spring可以让我们单独处理这个<code>jcache:cache-name</code>这个属性。</p>\n<h3 id=\"定义schema\"><a href=\"#定义schema\" class=\"headerlink\" title=\"定义schema\"></a>定义schema</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xsd:schema</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://www.foo.com/schema/jcache\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">xmlns:xsd</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">targetNamespace</span>=<span class=\"string\">\"http://www.foo.com/schema/jcache\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">elementFormDefault</span>=<span class=\"string\">\"qualified\"</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"cache-name\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"NamespaceHandler\"><a href=\"#NamespaceHandler\" class=\"headerlink\" title=\"NamespaceHandler\"></a>NamespaceHandler</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JCacheNamespaceHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.registerBeanDefinitionDecoratorForAttribute(<span class=\"string\">\"cache-name\"</span>,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> JCacheInitializingBeanDefinitionDecorator());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>实际的调用行为已经被抽象到<code>NamespaceHandlerSupport</code>中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Decorates the supplied &#123;<span class=\"doctag\">@link</span> Node&#125; by delegating to the &#123;<span class=\"doctag\">@link</span> BeanDefinitionDecorator&#125; that</span></span><br><span class=\"line\"><span class=\"comment\"> * is registered to handle that &#123;<span class=\"doctag\">@link</span> Node&#125;.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> BeanDefinitionHolder <span class=\"title\">decorate</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    Node node, BeanDefinitionHolder definition, ParserContext parserContext)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> findDecoratorForNode(node, parserContext).decorate(node, definition, parserContext);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"BeanDefinitionDecorator\"><a href=\"#BeanDefinitionDecorator\" class=\"headerlink\" title=\"BeanDefinitionDecorator\"></a>BeanDefinitionDecorator</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JCacheInitializingBeanDefinitionDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title\">BeanDefinitionDecorator</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String[] EMPTY_STRING_ARRAY = <span class=\"keyword\">new</span> String[<span class=\"number\">0</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> BeanDefinitionHolder <span class=\"title\">decorate</span><span class=\"params\">(Node source, BeanDefinitionHolder holder,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            ParserContext ctx)</span> </span>&#123;</span><br><span class=\"line\">        String initializerBeanName = registerJCacheInitializer(source, ctx);</span><br><span class=\"line\">        createDependencyOnJCacheInitializer(holder, initializerBeanName);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> holder;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">createDependencyOnJCacheInitializer</span><span class=\"params\">(BeanDefinitionHolder holder,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            String initializerBeanName)</span> </span>&#123;</span><br><span class=\"line\">        AbstractBeanDefinition definition = ((AbstractBeanDefinition) holder.getBeanDefinition());</span><br><span class=\"line\">        String[] dependsOn = definition.getDependsOn();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (dependsOn == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            dependsOn = <span class=\"keyword\">new</span> String[]&#123;initializerBeanName&#125;;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            List dependencies = <span class=\"keyword\">new</span> ArrayList(Arrays.asList(dependsOn));</span><br><span class=\"line\">            dependencies.add(initializerBeanName);</span><br><span class=\"line\">            dependsOn = (String[]) dependencies.toArray(EMPTY_STRING_ARRAY);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        definition.setDependsOn(dependsOn);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">registerJCacheInitializer</span><span class=\"params\">(Node source, ParserContext ctx)</span> </span>&#123;</span><br><span class=\"line\">        String cacheName = ((Attr) source).getValue();</span><br><span class=\"line\">        String beanName = cacheName + <span class=\"string\">\"-initializer\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!ctx.getRegistry().containsBeanDefinition(beanName)) &#123;</span><br><span class=\"line\">            BeanDefinitionBuilder initializer = BeanDefinitionBuilder.rootBeanDefinition(JCacheInitializer.class);</span><br><span class=\"line\">            initializer.addConstructorArg(cacheName);</span><br><span class=\"line\">            ctx.getRegistry().registerBeanDefinition(beanName, initializer.getBeanDefinition());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> beanName;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"META-INF\"><a href=\"#META-INF\" class=\"headerlink\" title=\"META-INF\"></a>META-INF</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># in 'META-INF/spring.handlers'</span><br><span class=\"line\">http\\://www.foo.com/schema/jcache=com.foo.JCacheNamespaceHandler</span><br><span class=\"line\"># in 'META-INF/spring.schemas'</span><br><span class=\"line\">http\\://www.foo.com/schema/jcache/jcache.xsd=com/foo/jcache.xsd</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring-framework-reference</a></li>\n</ol>\n"},{"title":"Unicode历史","toc":true,"abbrlink":53759,"date":"2016-09-26T08:56:08.000Z","_content":"# 字符编码\n\n>字符编码（英语：Character encoding）、字集码是把字符集中的字符编码为指定集合中某一对象（例如：比特模式、自然数序列、8位组或者电脉冲），以便文本在计算机中存储和通过通信网络的传递。\n\n简单的说，就是计算机只认`0`和`1`，于是在数据取出来的时候根据一个类似字典的东西，按照一定的规则将比特信息转换成对应的字符信息，这样人们才可以理解到底存储了什么。\n## ASCII编码\n\n`ASCII`（American Standard Code for Information Interchange） 编码是基于拉丁字母的一套编码系统。\n\n`ASCII`使用指定的`7` 位或`8` 位二进制数组合来表示`128` 或`256` 种可能的字符。\n\n> ASCII的局限在于只能显示26个基本拉丁字母、阿拉伯数目字和英式标点符号，因此只能用于显示现代美国英语（而且在处理英语当中的外来词如naïve、café、élite等等时，所有重音符号都不得不去掉，即使这样做会违反拼写规则）。而EASCII虽然解决了部分西欧语言的显示问题，但对更多其他语言依然无能为力。因此现在的软件系统大多采用Unicode。\n\n后续有其扩展版本`EASCII`。这个扩展的版本虽然扩充了一些字符，增大了EASCII的表达能力，但是仍不能满足全球各个国家的需求。于是各个国家就自己搞了一套编码的规则，但是随着web的发展，越来越需要一套统一的编解码标准，于是Unicode应运而出。\n\n## Unicode编码\n\n{%  asset_img   Unicode_logo.jpg  %}\n\n\n\n\n>Unicode provides a unique number for every character,\n\n> no matter what the platform,\n\n> no matter what the program,\n\n> no matter what the language.\n\n定义：\n\n>Unicode（中文：万国码、国际码、统一码、单一码）是计算机科学领域里的一项业界标准。它对世界上大部分的文字系统进行了整理、编码，使得电脑可以用更为简单的方式来呈现和处理文字。\n\n>In Unicode, a character is de\u001cned as the smallest component of a written language that has semantic value.\nThe number assigned to a character is called a **code point**. A code point is denoted by \u0010U+\u0011 following by a\nhexadecimal number from 4 to 8 digits long. Most of the code points in use are 4 digits long. For example,\n`U+03C6` is the code point for the Greek character f.\n\n{%  asset_img   unicode-layout.jpg  %}\n\n\n\n\n>在文字处理方面，统一码为每一个字符而非字形定义唯一的代码（即一个整数）。换句话说，统一码以一种抽象的方式（即数字）来处理字符，并将视觉上的演绎工作（例如字体大小、外观形状、字体形态、文体等）留给其他软件来处理，例如网页浏览器或是文字处理器。\n\n### Java中判断是否是中文字符\n\n>Java判断一个字符串是否有中文一般情况是利用Unicode编码(CJK统一汉字的编码区间：0x4e00–0x9fbb)的正则来做判断，但是其实这个区间来判断中文不是非常精确，因为有些中文的标点符号比如：，。等等是不能识别的。\n\n具体的参见参考中的`Java 完美判断中文字符`\n\n\n### 遗留的问题\n\n>需要注意的是，Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。\n\n存储中存在的问题：\n\n1. 如何区分Unicode和ASCII码？\n\n2. 如何存储能节省空间？\n\n\n>它们造成的结果是：\n\n>1）出现了Unicode的多种存储方式，也就是说有许多种不同的二进制格式，可以用来表示Unicode。\n\n>2）Unicode在很长一段时间内无法推广，直到互联网的出现。\n\n### CJK\n\n>Q: What does the term \"CJK\" mean?\n\n>A: It is a commonly used acronym for \"Chinese, Japanese, and Korean\". The term \"CJK character\" generally refers to \"Chinese characters\", or more specifically, the Chinese (= Han) ideographs used in the writing systems of the Chinese and Japanese languages, occasionally for Korean, and historically in Vietnam.\n\n### UTF-8编码\n\n>互联网的普及，强烈要求出现一种统一的编码方式。**UTF-8就是在互联网上使用最广的一种Unicode的实现方式。**其他实现方式还包括UTF-16（字符用两个字节或四个字节表示）和UTF-32（字符用四个字节表示），不过在互联网上基本不用。重复一遍，这里的关系是，UTF-8是Unicode的实现方式之一。\n\n#### 8的含义\n> unicode在很长一段时间内无法推广，直到互联网的出现，为解决unicode如何在网络上传输的问题，于是面向传输的众多 **UTF（UCS Transfer Format）标准出现了，顾名思义，UTF-8就是每次8个位传输数据，而UTF-16就是每次16个位。**UTF-8就是在互联网上使用最广的一种unicode的实现方式，这是为传输而设计的编码，并使编码无国界，这样就可以显示全世界上所有文化的字符了。\n\n#### UTF-8和Unicode\n\n> UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度，当字符在ASCII 码的范围时，就用一个字节表示，保留了ASCII字符一个字节的编码做为它的一部分，注意的是unicode一个中文字符占2个字节，而UTF-8一个中 文字符占3个字节）。从unicode到uft-8并不是直接的对应，而是要过一些算法和规则来转换。\n\n### 编码方式\n\n>UTF-8的编码规则很简单，只有二条：\n\n>1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。\n\n>2）对于n字节的符号（n>1），**第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10**。剩下的没有提及的二进制位，全部为这个符号的unicode码。\n\n所以如果第一个字节是`0`开头的，那么就是兼容ASCII码的单字节字符；如果第一个字节是`1`开头的就是多字节字符，数一数前面有多少个`1`，就知道这个字符占了几个字节。\n\n所以UTF-8编码后的二进制形式应该如下：\n\n```\n0xxxxxxx 1个byte\n\n110xxxxx 10xxxxxx 2个byte\n\n1110xxxx 10xxxxxx 10xxxxxx 3个byte\n\n11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 4个byte\n\n111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 5个byte\n\n111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 6个byte\n```\n\n> The bytes `0xFE(11111110)` and `0xFF(11111111)` are never used in the UTF-8 encoding.\n\n这两个特殊的字节被用来标示是大端编码和小端编码\n\n\nUTF-8编码的范围和Unicode对应的关系如下：\n\n|总比特数 |Code Point占的位数  |范围|\n|---|----|---|\n| 1 | 7  | 00000000 - 0000007F |\n| 2 | 11 | 00000080 - 000007FF |\n| 3 | 16 | 00000800 - 0000FFFF |\n| 4 | 21 | 00001000 - 001FFFFF |\n| 5 | 26 | 00200000 - 03FFFFFF |\n| 6 | 31 | 04000000 - FFFFFFFF |\n\n编码示例：\n\n`U+05E7 ` 使用`UTF-8`编码示例:\n\n1. 查上表得知， `05E7`在 `0080 - 07FF` 范围内，总共占2个字节\n应该是类似 `110xxxxx 10xxxxxx `\n\n2. 将其写成二进制形式，`0000 0101 1110 0111`\n\n3. 将数据替换上述的`x`，得到 `11010111 10100111 = 0xD7A7`\n\n#### 字节序\n\nUTF-8最多使用6个byte表示一个字符，于是就存在一个字节序的问题。\n字节序分为两种：\n\n1. **Little-Endian**:\n 字节序低位在前  小尾 在操作系统上很常用，也是计算机系统上最常用的字节序\n2. **Big-Endian**: 字节序高位在前 大尾  也称为网络字节序\n\n```\n16进制数字0x12345678，little-endian的存储为:  0x78 0x56 0x34 0x12     地址依次为100, 101, 102, 103\n\n16进制数字0x12345678，big-endian的存储为:     0x12 0x34 0x56 0x78       地址依次为100, 101, 102, 103\n```\n>\"endian\"这个词出自《格列佛游记》。小人国的内战就源于吃鸡蛋时是究竟从大头(Big-Endian)敲开还是从小头(Little-Endian)敲开，由此曾发生过六次叛乱，其中一个皇帝送了命，另一个丢了王位。\n\n#### 字节序用途\n>Little-Endian最常用，大部分用户的操作系统（如windows, FreeBsd,Linux）是Little Endian的。\n\n>Big-Endian最常用在网络协议上，例如TCP/IP协议使用的是big endian. 操作系统上如MAC OS ,是Big Endian 的。\n本质上说，Little Endian还是Big Endian与操作系统和芯片类型都有关系。PowerPC系列采用big endian方式存储数据，x86系列则采用little endian方式存储数据。\n\n```\nBig Endian\n   低地址                                           高地址\n   ----------------------------------------->\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |     12     |      34    |     56      |     78    |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\nLittle Endian\n   低地址                                           高地址\n   ----------------------------------------->\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |     78     |      56    |     34      |     12    |\n```\n\n> Unicode规范中定义，每一个文件的最前面分别加入一个表示编码顺序的字符，这个字符的名字叫做\"零宽度非换行空格\"（ZERO WIDTH NO-BREAK SPACE），用FEFF表示。这正好是两个字节，而且FF比FE大1。\n如果一个文本文件的头两个字节是FE FF，就表示该文件采用大头方式；如果头两个字节是FF FE，就表示该文件采用小头方式。\n\n## emoji\n\n{%  asset_img   emoji.jpg  %}\n\n\n\n\nemoji表情采用的是 Unicode编码，Emoji就是一种在Unicode位于`\\u1F601-\\u1F64F`区段的字符。这个显然超过了目前常用的UTF-8字符集的编码范围`\\u0000-\\uFFFF`。\n\n使用utf8mb4编码便可以解决上述的问题\n\n## 宽字符\n\n宽字符（Wide character） 是程序设计的术语。它是一个抽象的术语（没有规定具体实现细节），用以表示比8位字符还宽的数据类型。它不同于Unicode。\n\nwchar_t在ANSI/ISO C中是一个数据类型，且某些其它的编程语言也用它来表示宽字符。\n\n## 参考文章\n\n1. [字符编码](https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81)\n\n2. [Unicode_and_Character_Sets.md](https://github.com/acmerfight/insight_python/blob/master/Unicode_and_Character_Sets.md)\n\n3. [Unicode and UTF-8](http://www.compsci.hunter.cuny.edu/~sweiss/resources/Unicode.pdf)\n\n4. [Java 完美判断中文字符](http://www.micmiu.com/lang/java/java-check-chinese/)\n\n5. [Full Emoji Data, v3.0](http://unicode.org/emoji/charts/full-emoji-list.html)\n\n6. [微信emoji表情编码](http://www.tuicool.com/articles/aQBVny)\n\n7. [关于Big Endian 和 Little Endian](http://blog.csdn.net/sunshine1314/article/details/2309655)\n\n8. [字符编码笔记：ASCII，Unicode和UTF-8](http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html)\n","source":"_posts/character-encoding.md","raw":"---\ntitle: Unicode历史\ntags: 编码\ncategory: base\ntoc: true\nabbrlink: 53759\ndate: 2016-09-26 16:56:08\n---\n# 字符编码\n\n>字符编码（英语：Character encoding）、字集码是把字符集中的字符编码为指定集合中某一对象（例如：比特模式、自然数序列、8位组或者电脉冲），以便文本在计算机中存储和通过通信网络的传递。\n\n简单的说，就是计算机只认`0`和`1`，于是在数据取出来的时候根据一个类似字典的东西，按照一定的规则将比特信息转换成对应的字符信息，这样人们才可以理解到底存储了什么。\n## ASCII编码\n\n`ASCII`（American Standard Code for Information Interchange） 编码是基于拉丁字母的一套编码系统。\n\n`ASCII`使用指定的`7` 位或`8` 位二进制数组合来表示`128` 或`256` 种可能的字符。\n\n> ASCII的局限在于只能显示26个基本拉丁字母、阿拉伯数目字和英式标点符号，因此只能用于显示现代美国英语（而且在处理英语当中的外来词如naïve、café、élite等等时，所有重音符号都不得不去掉，即使这样做会违反拼写规则）。而EASCII虽然解决了部分西欧语言的显示问题，但对更多其他语言依然无能为力。因此现在的软件系统大多采用Unicode。\n\n后续有其扩展版本`EASCII`。这个扩展的版本虽然扩充了一些字符，增大了EASCII的表达能力，但是仍不能满足全球各个国家的需求。于是各个国家就自己搞了一套编码的规则，但是随着web的发展，越来越需要一套统一的编解码标准，于是Unicode应运而出。\n\n## Unicode编码\n\n{%  asset_img   Unicode_logo.jpg  %}\n\n\n\n\n>Unicode provides a unique number for every character,\n\n> no matter what the platform,\n\n> no matter what the program,\n\n> no matter what the language.\n\n定义：\n\n>Unicode（中文：万国码、国际码、统一码、单一码）是计算机科学领域里的一项业界标准。它对世界上大部分的文字系统进行了整理、编码，使得电脑可以用更为简单的方式来呈现和处理文字。\n\n>In Unicode, a character is de\u001cned as the smallest component of a written language that has semantic value.\nThe number assigned to a character is called a **code point**. A code point is denoted by \u0010U+\u0011 following by a\nhexadecimal number from 4 to 8 digits long. Most of the code points in use are 4 digits long. For example,\n`U+03C6` is the code point for the Greek character f.\n\n{%  asset_img   unicode-layout.jpg  %}\n\n\n\n\n>在文字处理方面，统一码为每一个字符而非字形定义唯一的代码（即一个整数）。换句话说，统一码以一种抽象的方式（即数字）来处理字符，并将视觉上的演绎工作（例如字体大小、外观形状、字体形态、文体等）留给其他软件来处理，例如网页浏览器或是文字处理器。\n\n### Java中判断是否是中文字符\n\n>Java判断一个字符串是否有中文一般情况是利用Unicode编码(CJK统一汉字的编码区间：0x4e00–0x9fbb)的正则来做判断，但是其实这个区间来判断中文不是非常精确，因为有些中文的标点符号比如：，。等等是不能识别的。\n\n具体的参见参考中的`Java 完美判断中文字符`\n\n\n### 遗留的问题\n\n>需要注意的是，Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。\n\n存储中存在的问题：\n\n1. 如何区分Unicode和ASCII码？\n\n2. 如何存储能节省空间？\n\n\n>它们造成的结果是：\n\n>1）出现了Unicode的多种存储方式，也就是说有许多种不同的二进制格式，可以用来表示Unicode。\n\n>2）Unicode在很长一段时间内无法推广，直到互联网的出现。\n\n### CJK\n\n>Q: What does the term \"CJK\" mean?\n\n>A: It is a commonly used acronym for \"Chinese, Japanese, and Korean\". The term \"CJK character\" generally refers to \"Chinese characters\", or more specifically, the Chinese (= Han) ideographs used in the writing systems of the Chinese and Japanese languages, occasionally for Korean, and historically in Vietnam.\n\n### UTF-8编码\n\n>互联网的普及，强烈要求出现一种统一的编码方式。**UTF-8就是在互联网上使用最广的一种Unicode的实现方式。**其他实现方式还包括UTF-16（字符用两个字节或四个字节表示）和UTF-32（字符用四个字节表示），不过在互联网上基本不用。重复一遍，这里的关系是，UTF-8是Unicode的实现方式之一。\n\n#### 8的含义\n> unicode在很长一段时间内无法推广，直到互联网的出现，为解决unicode如何在网络上传输的问题，于是面向传输的众多 **UTF（UCS Transfer Format）标准出现了，顾名思义，UTF-8就是每次8个位传输数据，而UTF-16就是每次16个位。**UTF-8就是在互联网上使用最广的一种unicode的实现方式，这是为传输而设计的编码，并使编码无国界，这样就可以显示全世界上所有文化的字符了。\n\n#### UTF-8和Unicode\n\n> UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度，当字符在ASCII 码的范围时，就用一个字节表示，保留了ASCII字符一个字节的编码做为它的一部分，注意的是unicode一个中文字符占2个字节，而UTF-8一个中 文字符占3个字节）。从unicode到uft-8并不是直接的对应，而是要过一些算法和规则来转换。\n\n### 编码方式\n\n>UTF-8的编码规则很简单，只有二条：\n\n>1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。\n\n>2）对于n字节的符号（n>1），**第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10**。剩下的没有提及的二进制位，全部为这个符号的unicode码。\n\n所以如果第一个字节是`0`开头的，那么就是兼容ASCII码的单字节字符；如果第一个字节是`1`开头的就是多字节字符，数一数前面有多少个`1`，就知道这个字符占了几个字节。\n\n所以UTF-8编码后的二进制形式应该如下：\n\n```\n0xxxxxxx 1个byte\n\n110xxxxx 10xxxxxx 2个byte\n\n1110xxxx 10xxxxxx 10xxxxxx 3个byte\n\n11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 4个byte\n\n111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 5个byte\n\n111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 6个byte\n```\n\n> The bytes `0xFE(11111110)` and `0xFF(11111111)` are never used in the UTF-8 encoding.\n\n这两个特殊的字节被用来标示是大端编码和小端编码\n\n\nUTF-8编码的范围和Unicode对应的关系如下：\n\n|总比特数 |Code Point占的位数  |范围|\n|---|----|---|\n| 1 | 7  | 00000000 - 0000007F |\n| 2 | 11 | 00000080 - 000007FF |\n| 3 | 16 | 00000800 - 0000FFFF |\n| 4 | 21 | 00001000 - 001FFFFF |\n| 5 | 26 | 00200000 - 03FFFFFF |\n| 6 | 31 | 04000000 - FFFFFFFF |\n\n编码示例：\n\n`U+05E7 ` 使用`UTF-8`编码示例:\n\n1. 查上表得知， `05E7`在 `0080 - 07FF` 范围内，总共占2个字节\n应该是类似 `110xxxxx 10xxxxxx `\n\n2. 将其写成二进制形式，`0000 0101 1110 0111`\n\n3. 将数据替换上述的`x`，得到 `11010111 10100111 = 0xD7A7`\n\n#### 字节序\n\nUTF-8最多使用6个byte表示一个字符，于是就存在一个字节序的问题。\n字节序分为两种：\n\n1. **Little-Endian**:\n 字节序低位在前  小尾 在操作系统上很常用，也是计算机系统上最常用的字节序\n2. **Big-Endian**: 字节序高位在前 大尾  也称为网络字节序\n\n```\n16进制数字0x12345678，little-endian的存储为:  0x78 0x56 0x34 0x12     地址依次为100, 101, 102, 103\n\n16进制数字0x12345678，big-endian的存储为:     0x12 0x34 0x56 0x78       地址依次为100, 101, 102, 103\n```\n>\"endian\"这个词出自《格列佛游记》。小人国的内战就源于吃鸡蛋时是究竟从大头(Big-Endian)敲开还是从小头(Little-Endian)敲开，由此曾发生过六次叛乱，其中一个皇帝送了命，另一个丢了王位。\n\n#### 字节序用途\n>Little-Endian最常用，大部分用户的操作系统（如windows, FreeBsd,Linux）是Little Endian的。\n\n>Big-Endian最常用在网络协议上，例如TCP/IP协议使用的是big endian. 操作系统上如MAC OS ,是Big Endian 的。\n本质上说，Little Endian还是Big Endian与操作系统和芯片类型都有关系。PowerPC系列采用big endian方式存储数据，x86系列则采用little endian方式存储数据。\n\n```\nBig Endian\n   低地址                                           高地址\n   ----------------------------------------->\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |     12     |      34    |     56      |     78    |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n\nLittle Endian\n   低地址                                           高地址\n   ----------------------------------------->\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |     78     |      56    |     34      |     12    |\n```\n\n> Unicode规范中定义，每一个文件的最前面分别加入一个表示编码顺序的字符，这个字符的名字叫做\"零宽度非换行空格\"（ZERO WIDTH NO-BREAK SPACE），用FEFF表示。这正好是两个字节，而且FF比FE大1。\n如果一个文本文件的头两个字节是FE FF，就表示该文件采用大头方式；如果头两个字节是FF FE，就表示该文件采用小头方式。\n\n## emoji\n\n{%  asset_img   emoji.jpg  %}\n\n\n\n\nemoji表情采用的是 Unicode编码，Emoji就是一种在Unicode位于`\\u1F601-\\u1F64F`区段的字符。这个显然超过了目前常用的UTF-8字符集的编码范围`\\u0000-\\uFFFF`。\n\n使用utf8mb4编码便可以解决上述的问题\n\n## 宽字符\n\n宽字符（Wide character） 是程序设计的术语。它是一个抽象的术语（没有规定具体实现细节），用以表示比8位字符还宽的数据类型。它不同于Unicode。\n\nwchar_t在ANSI/ISO C中是一个数据类型，且某些其它的编程语言也用它来表示宽字符。\n\n## 参考文章\n\n1. [字符编码](https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81)\n\n2. [Unicode_and_Character_Sets.md](https://github.com/acmerfight/insight_python/blob/master/Unicode_and_Character_Sets.md)\n\n3. [Unicode and UTF-8](http://www.compsci.hunter.cuny.edu/~sweiss/resources/Unicode.pdf)\n\n4. [Java 完美判断中文字符](http://www.micmiu.com/lang/java/java-check-chinese/)\n\n5. [Full Emoji Data, v3.0](http://unicode.org/emoji/charts/full-emoji-list.html)\n\n6. [微信emoji表情编码](http://www.tuicool.com/articles/aQBVny)\n\n7. [关于Big Endian 和 Little Endian](http://blog.csdn.net/sunshine1314/article/details/2309655)\n\n8. [字符编码笔记：ASCII，Unicode和UTF-8](http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html)\n","slug":"character-encoding","published":1,"updated":"2017-04-16T12:04:30.006Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8t0050jh4ky7bsu2mx","content":"<h1 id=\"字符编码\"><a href=\"#字符编码\" class=\"headerlink\" title=\"字符编码\"></a>字符编码</h1><blockquote>\n<p>字符编码（英语：Character encoding）、字集码是把字符集中的字符编码为指定集合中某一对象（例如：比特模式、自然数序列、8位组或者电脉冲），以便文本在计算机中存储和通过通信网络的传递。</p>\n</blockquote>\n<p>简单的说，就是计算机只认<code>0</code>和<code>1</code>，于是在数据取出来的时候根据一个类似字典的东西，按照一定的规则将比特信息转换成对应的字符信息，这样人们才可以理解到底存储了什么。</p>\n<h2 id=\"ASCII编码\"><a href=\"#ASCII编码\" class=\"headerlink\" title=\"ASCII编码\"></a>ASCII编码</h2><p><code>ASCII</code>（American Standard Code for Information Interchange） 编码是基于拉丁字母的一套编码系统。</p>\n<p><code>ASCII</code>使用指定的<code>7</code> 位或<code>8</code> 位二进制数组合来表示<code>128</code> 或<code>256</code> 种可能的字符。</p>\n<blockquote>\n<p>ASCII的局限在于只能显示26个基本拉丁字母、阿拉伯数目字和英式标点符号，因此只能用于显示现代美国英语（而且在处理英语当中的外来词如naïve、café、élite等等时，所有重音符号都不得不去掉，即使这样做会违反拼写规则）。而EASCII虽然解决了部分西欧语言的显示问题，但对更多其他语言依然无能为力。因此现在的软件系统大多采用Unicode。</p>\n</blockquote>\n<p>后续有其扩展版本<code>EASCII</code>。这个扩展的版本虽然扩充了一些字符，增大了EASCII的表达能力，但是仍不能满足全球各个国家的需求。于是各个国家就自己搞了一套编码的规则，但是随着web的发展，越来越需要一套统一的编解码标准，于是Unicode应运而出。</p>\n<h2 id=\"Unicode编码\"><a href=\"#Unicode编码\" class=\"headerlink\" title=\"Unicode编码\"></a>Unicode编码</h2><img src=\"/2016/09/26/character-encoding/Unicode_logo.jpg\">\n<blockquote>\n<p>Unicode provides a unique number for every character,</p>\n<p>no matter what the platform,</p>\n<p>no matter what the program,</p>\n<p>no matter what the language.</p>\n</blockquote>\n<p>定义：</p>\n<blockquote>\n<p>Unicode（中文：万国码、国际码、统一码、单一码）是计算机科学领域里的一项业界标准。它对世界上大部分的文字系统进行了整理、编码，使得电脑可以用更为简单的方式来呈现和处理文字。</p>\n<p>In Unicode, a character is de\u001cned as the smallest component of a written language that has semantic value.<br>The number assigned to a character is called a <strong>code point</strong>. A code point is denoted by \u0010U+\u0011 following by a<br>hexadecimal number from 4 to 8 digits long. Most of the code points in use are 4 digits long. For example,<br><code>U+03C6</code> is the code point for the Greek character f.</p>\n</blockquote>\n<img src=\"/2016/09/26/character-encoding/unicode-layout.jpg\">\n<blockquote>\n<p>在文字处理方面，统一码为每一个字符而非字形定义唯一的代码（即一个整数）。换句话说，统一码以一种抽象的方式（即数字）来处理字符，并将视觉上的演绎工作（例如字体大小、外观形状、字体形态、文体等）留给其他软件来处理，例如网页浏览器或是文字处理器。</p>\n</blockquote>\n<h3 id=\"Java中判断是否是中文字符\"><a href=\"#Java中判断是否是中文字符\" class=\"headerlink\" title=\"Java中判断是否是中文字符\"></a>Java中判断是否是中文字符</h3><blockquote>\n<p>Java判断一个字符串是否有中文一般情况是利用Unicode编码(CJK统一汉字的编码区间：0x4e00–0x9fbb)的正则来做判断，但是其实这个区间来判断中文不是非常精确，因为有些中文的标点符号比如：，。等等是不能识别的。</p>\n</blockquote>\n<p>具体的参见参考中的<code>Java 完美判断中文字符</code></p>\n<h3 id=\"遗留的问题\"><a href=\"#遗留的问题\" class=\"headerlink\" title=\"遗留的问题\"></a>遗留的问题</h3><blockquote>\n<p>需要注意的是，Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。</p>\n</blockquote>\n<p>存储中存在的问题：</p>\n<ol>\n<li><p>如何区分Unicode和ASCII码？</p>\n</li>\n<li><p>如何存储能节省空间？</p>\n</li>\n</ol>\n<blockquote>\n<p>它们造成的结果是：</p>\n<p>1）出现了Unicode的多种存储方式，也就是说有许多种不同的二进制格式，可以用来表示Unicode。</p>\n<p>2）Unicode在很长一段时间内无法推广，直到互联网的出现。</p>\n</blockquote>\n<h3 id=\"CJK\"><a href=\"#CJK\" class=\"headerlink\" title=\"CJK\"></a>CJK</h3><blockquote>\n<p>Q: What does the term “CJK” mean?</p>\n<p>A: It is a commonly used acronym for “Chinese, Japanese, and Korean”. The term “CJK character” generally refers to “Chinese characters”, or more specifically, the Chinese (= Han) ideographs used in the writing systems of the Chinese and Japanese languages, occasionally for Korean, and historically in Vietnam.</p>\n</blockquote>\n<h3 id=\"UTF-8编码\"><a href=\"#UTF-8编码\" class=\"headerlink\" title=\"UTF-8编码\"></a>UTF-8编码</h3><blockquote>\n<p>互联网的普及，强烈要求出现一种统一的编码方式。<strong>UTF-8就是在互联网上使用最广的一种Unicode的实现方式。</strong>其他实现方式还包括UTF-16（字符用两个字节或四个字节表示）和UTF-32（字符用四个字节表示），不过在互联网上基本不用。重复一遍，这里的关系是，UTF-8是Unicode的实现方式之一。</p>\n</blockquote>\n<h4 id=\"8的含义\"><a href=\"#8的含义\" class=\"headerlink\" title=\"8的含义\"></a>8的含义</h4><blockquote>\n<p>unicode在很长一段时间内无法推广，直到互联网的出现，为解决unicode如何在网络上传输的问题，于是面向传输的众多 <strong>UTF（UCS Transfer Format）标准出现了，顾名思义，UTF-8就是每次8个位传输数据，而UTF-16就是每次16个位。</strong>UTF-8就是在互联网上使用最广的一种unicode的实现方式，这是为传输而设计的编码，并使编码无国界，这样就可以显示全世界上所有文化的字符了。</p>\n</blockquote>\n<h4 id=\"UTF-8和Unicode\"><a href=\"#UTF-8和Unicode\" class=\"headerlink\" title=\"UTF-8和Unicode\"></a>UTF-8和Unicode</h4><blockquote>\n<p>UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度，当字符在ASCII 码的范围时，就用一个字节表示，保留了ASCII字符一个字节的编码做为它的一部分，注意的是unicode一个中文字符占2个字节，而UTF-8一个中 文字符占3个字节）。从unicode到uft-8并不是直接的对应，而是要过一些算法和规则来转换。</p>\n</blockquote>\n<h3 id=\"编码方式\"><a href=\"#编码方式\" class=\"headerlink\" title=\"编码方式\"></a>编码方式</h3><blockquote>\n<p>UTF-8的编码规则很简单，只有二条：</p>\n<p>1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。</p>\n<p>2）对于n字节的符号（n&gt;1），<strong>第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10</strong>。剩下的没有提及的二进制位，全部为这个符号的unicode码。</p>\n</blockquote>\n<p>所以如果第一个字节是<code>0</code>开头的，那么就是兼容ASCII码的单字节字符；如果第一个字节是<code>1</code>开头的就是多字节字符，数一数前面有多少个<code>1</code>，就知道这个字符占了几个字节。</p>\n<p>所以UTF-8编码后的二进制形式应该如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0xxxxxxx 1个byte</span><br><span class=\"line\"></span><br><span class=\"line\">110xxxxx 10xxxxxx 2个byte</span><br><span class=\"line\"></span><br><span class=\"line\">1110xxxx 10xxxxxx 10xxxxxx 3个byte</span><br><span class=\"line\"></span><br><span class=\"line\">11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 4个byte</span><br><span class=\"line\"></span><br><span class=\"line\">111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 5个byte</span><br><span class=\"line\"></span><br><span class=\"line\">111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 6个byte</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>The bytes <code>0xFE(11111110)</code> and <code>0xFF(11111111)</code> are never used in the UTF-8 encoding.</p>\n</blockquote>\n<p>这两个特殊的字节被用来标示是大端编码和小端编码</p>\n<p>UTF-8编码的范围和Unicode对应的关系如下：</p>\n<table>\n<thead>\n<tr>\n<th>总比特数</th>\n<th>Code Point占的位数</th>\n<th>范围</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>7</td>\n<td>00000000 - 0000007F</td>\n</tr>\n<tr>\n<td>2</td>\n<td>11</td>\n<td>00000080 - 000007FF</td>\n</tr>\n<tr>\n<td>3</td>\n<td>16</td>\n<td>00000800 - 0000FFFF</td>\n</tr>\n<tr>\n<td>4</td>\n<td>21</td>\n<td>00001000 - 001FFFFF</td>\n</tr>\n<tr>\n<td>5</td>\n<td>26</td>\n<td>00200000 - 03FFFFFF</td>\n</tr>\n<tr>\n<td>6</td>\n<td>31</td>\n<td>04000000 - FFFFFFFF</td>\n</tr>\n</tbody>\n</table>\n<p>编码示例：</p>\n<p><code>U+05E7</code> 使用<code>UTF-8</code>编码示例:</p>\n<ol>\n<li><p>查上表得知， <code>05E7</code>在 <code>0080 - 07FF</code> 范围内，总共占2个字节<br>应该是类似 <code>110xxxxx 10xxxxxx</code></p>\n</li>\n<li><p>将其写成二进制形式，<code>0000 0101 1110 0111</code></p>\n</li>\n<li><p>将数据替换上述的<code>x</code>，得到 <code>11010111 10100111 = 0xD7A7</code></p>\n</li>\n</ol>\n<h4 id=\"字节序\"><a href=\"#字节序\" class=\"headerlink\" title=\"字节序\"></a>字节序</h4><p>UTF-8最多使用6个byte表示一个字符，于是就存在一个字节序的问题。<br>字节序分为两种：</p>\n<ol>\n<li><strong>Little-Endian</strong>:<br>字节序低位在前  小尾 在操作系统上很常用，也是计算机系统上最常用的字节序</li>\n<li><strong>Big-Endian</strong>: 字节序高位在前 大尾  也称为网络字节序</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">16进制数字0x12345678，little-endian的存储为:  0x78 0x56 0x34 0x12     地址依次为100, 101, 102, 103</span><br><span class=\"line\"></span><br><span class=\"line\">16进制数字0x12345678，big-endian的存储为:     0x12 0x34 0x56 0x78       地址依次为100, 101, 102, 103</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>“endian”这个词出自《格列佛游记》。小人国的内战就源于吃鸡蛋时是究竟从大头(Big-Endian)敲开还是从小头(Little-Endian)敲开，由此曾发生过六次叛乱，其中一个皇帝送了命，另一个丢了王位。</p>\n</blockquote>\n<h4 id=\"字节序用途\"><a href=\"#字节序用途\" class=\"headerlink\" title=\"字节序用途\"></a>字节序用途</h4><blockquote>\n<p>Little-Endian最常用，大部分用户的操作系统（如windows, FreeBsd,Linux）是Little Endian的。</p>\n<p>Big-Endian最常用在网络协议上，例如TCP/IP协议使用的是big endian. 操作系统上如MAC OS ,是Big Endian 的。<br>本质上说，Little Endian还是Big Endian与操作系统和芯片类型都有关系。PowerPC系列采用big endian方式存储数据，x86系列则采用little endian方式存储数据。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Big Endian</span><br><span class=\"line\">   低地址                                           高地址</span><br><span class=\"line\">   -----------------------------------------&gt;</span><br><span class=\"line\">   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class=\"line\">   |     12     |      34    |     56      |     78    |</span><br><span class=\"line\">   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class=\"line\"></span><br><span class=\"line\">Little Endian</span><br><span class=\"line\">   低地址                                           高地址</span><br><span class=\"line\">   -----------------------------------------&gt;</span><br><span class=\"line\">   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class=\"line\">   |     78     |      56    |     34      |     12    |</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Unicode规范中定义，每一个文件的最前面分别加入一个表示编码顺序的字符，这个字符的名字叫做”零宽度非换行空格”（ZERO WIDTH NO-BREAK SPACE），用FEFF表示。这正好是两个字节，而且FF比FE大1。<br>如果一个文本文件的头两个字节是FE FF，就表示该文件采用大头方式；如果头两个字节是FF FE，就表示该文件采用小头方式。</p>\n</blockquote>\n<h2 id=\"emoji\"><a href=\"#emoji\" class=\"headerlink\" title=\"emoji\"></a>emoji</h2><img src=\"/2016/09/26/character-encoding/emoji.jpg\">\n<p>emoji表情采用的是 Unicode编码，Emoji就是一种在Unicode位于<code>\\u1F601-\\u1F64F</code>区段的字符。这个显然超过了目前常用的UTF-8字符集的编码范围<code>\\u0000-\\uFFFF</code>。</p>\n<p>使用utf8mb4编码便可以解决上述的问题</p>\n<h2 id=\"宽字符\"><a href=\"#宽字符\" class=\"headerlink\" title=\"宽字符\"></a>宽字符</h2><p>宽字符（Wide character） 是程序设计的术语。它是一个抽象的术语（没有规定具体实现细节），用以表示比8位字符还宽的数据类型。它不同于Unicode。</p>\n<p>wchar_t在ANSI/ISO C中是一个数据类型，且某些其它的编程语言也用它来表示宽字符。</p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><ol>\n<li><p><a href=\"https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">字符编码</a></p>\n</li>\n<li><p><a href=\"https://github.com/acmerfight/insight_python/blob/master/Unicode_and_Character_Sets.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Unicode_and_Character_Sets.md</a></p>\n</li>\n<li><p><a href=\"http://www.compsci.hunter.cuny.edu/~sweiss/resources/Unicode.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Unicode and UTF-8</a></p>\n</li>\n<li><p><a href=\"http://www.micmiu.com/lang/java/java-check-chinese/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java 完美判断中文字符</a></p>\n</li>\n<li><p><a href=\"http://unicode.org/emoji/charts/full-emoji-list.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Full Emoji Data, v3.0</a></p>\n</li>\n<li><p><a href=\"http://www.tuicool.com/articles/aQBVny\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">微信emoji表情编码</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/sunshine1314/article/details/2309655\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">关于Big Endian 和 Little Endian</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">字符编码笔记：ASCII，Unicode和UTF-8</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"字符编码\"><a href=\"#字符编码\" class=\"headerlink\" title=\"字符编码\"></a>字符编码</h1><blockquote>\n<p>字符编码（英语：Character encoding）、字集码是把字符集中的字符编码为指定集合中某一对象（例如：比特模式、自然数序列、8位组或者电脉冲），以便文本在计算机中存储和通过通信网络的传递。</p>\n</blockquote>\n<p>简单的说，就是计算机只认<code>0</code>和<code>1</code>，于是在数据取出来的时候根据一个类似字典的东西，按照一定的规则将比特信息转换成对应的字符信息，这样人们才可以理解到底存储了什么。</p>\n<h2 id=\"ASCII编码\"><a href=\"#ASCII编码\" class=\"headerlink\" title=\"ASCII编码\"></a>ASCII编码</h2><p><code>ASCII</code>（American Standard Code for Information Interchange） 编码是基于拉丁字母的一套编码系统。</p>\n<p><code>ASCII</code>使用指定的<code>7</code> 位或<code>8</code> 位二进制数组合来表示<code>128</code> 或<code>256</code> 种可能的字符。</p>\n<blockquote>\n<p>ASCII的局限在于只能显示26个基本拉丁字母、阿拉伯数目字和英式标点符号，因此只能用于显示现代美国英语（而且在处理英语当中的外来词如naïve、café、élite等等时，所有重音符号都不得不去掉，即使这样做会违反拼写规则）。而EASCII虽然解决了部分西欧语言的显示问题，但对更多其他语言依然无能为力。因此现在的软件系统大多采用Unicode。</p>\n</blockquote>\n<p>后续有其扩展版本<code>EASCII</code>。这个扩展的版本虽然扩充了一些字符，增大了EASCII的表达能力，但是仍不能满足全球各个国家的需求。于是各个国家就自己搞了一套编码的规则，但是随着web的发展，越来越需要一套统一的编解码标准，于是Unicode应运而出。</p>\n<h2 id=\"Unicode编码\"><a href=\"#Unicode编码\" class=\"headerlink\" title=\"Unicode编码\"></a>Unicode编码</h2><img src=\"/2016/09/26/character-encoding/Unicode_logo.jpg\">\n<blockquote>\n<p>Unicode provides a unique number for every character,</p>\n<p>no matter what the platform,</p>\n<p>no matter what the program,</p>\n<p>no matter what the language.</p>\n</blockquote>\n<p>定义：</p>\n<blockquote>\n<p>Unicode（中文：万国码、国际码、统一码、单一码）是计算机科学领域里的一项业界标准。它对世界上大部分的文字系统进行了整理、编码，使得电脑可以用更为简单的方式来呈现和处理文字。</p>\n<p>In Unicode, a character is de\u001cned as the smallest component of a written language that has semantic value.<br>The number assigned to a character is called a <strong>code point</strong>. A code point is denoted by \u0010U+\u0011 following by a<br>hexadecimal number from 4 to 8 digits long. Most of the code points in use are 4 digits long. For example,<br><code>U+03C6</code> is the code point for the Greek character f.</p>\n</blockquote>\n<img src=\"/2016/09/26/character-encoding/unicode-layout.jpg\">\n<blockquote>\n<p>在文字处理方面，统一码为每一个字符而非字形定义唯一的代码（即一个整数）。换句话说，统一码以一种抽象的方式（即数字）来处理字符，并将视觉上的演绎工作（例如字体大小、外观形状、字体形态、文体等）留给其他软件来处理，例如网页浏览器或是文字处理器。</p>\n</blockquote>\n<h3 id=\"Java中判断是否是中文字符\"><a href=\"#Java中判断是否是中文字符\" class=\"headerlink\" title=\"Java中判断是否是中文字符\"></a>Java中判断是否是中文字符</h3><blockquote>\n<p>Java判断一个字符串是否有中文一般情况是利用Unicode编码(CJK统一汉字的编码区间：0x4e00–0x9fbb)的正则来做判断，但是其实这个区间来判断中文不是非常精确，因为有些中文的标点符号比如：，。等等是不能识别的。</p>\n</blockquote>\n<p>具体的参见参考中的<code>Java 完美判断中文字符</code></p>\n<h3 id=\"遗留的问题\"><a href=\"#遗留的问题\" class=\"headerlink\" title=\"遗留的问题\"></a>遗留的问题</h3><blockquote>\n<p>需要注意的是，Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。</p>\n</blockquote>\n<p>存储中存在的问题：</p>\n<ol>\n<li><p>如何区分Unicode和ASCII码？</p>\n</li>\n<li><p>如何存储能节省空间？</p>\n</li>\n</ol>\n<blockquote>\n<p>它们造成的结果是：</p>\n<p>1）出现了Unicode的多种存储方式，也就是说有许多种不同的二进制格式，可以用来表示Unicode。</p>\n<p>2）Unicode在很长一段时间内无法推广，直到互联网的出现。</p>\n</blockquote>\n<h3 id=\"CJK\"><a href=\"#CJK\" class=\"headerlink\" title=\"CJK\"></a>CJK</h3><blockquote>\n<p>Q: What does the term “CJK” mean?</p>\n<p>A: It is a commonly used acronym for “Chinese, Japanese, and Korean”. The term “CJK character” generally refers to “Chinese characters”, or more specifically, the Chinese (= Han) ideographs used in the writing systems of the Chinese and Japanese languages, occasionally for Korean, and historically in Vietnam.</p>\n</blockquote>\n<h3 id=\"UTF-8编码\"><a href=\"#UTF-8编码\" class=\"headerlink\" title=\"UTF-8编码\"></a>UTF-8编码</h3><blockquote>\n<p>互联网的普及，强烈要求出现一种统一的编码方式。<strong>UTF-8就是在互联网上使用最广的一种Unicode的实现方式。</strong>其他实现方式还包括UTF-16（字符用两个字节或四个字节表示）和UTF-32（字符用四个字节表示），不过在互联网上基本不用。重复一遍，这里的关系是，UTF-8是Unicode的实现方式之一。</p>\n</blockquote>\n<h4 id=\"8的含义\"><a href=\"#8的含义\" class=\"headerlink\" title=\"8的含义\"></a>8的含义</h4><blockquote>\n<p>unicode在很长一段时间内无法推广，直到互联网的出现，为解决unicode如何在网络上传输的问题，于是面向传输的众多 <strong>UTF（UCS Transfer Format）标准出现了，顾名思义，UTF-8就是每次8个位传输数据，而UTF-16就是每次16个位。</strong>UTF-8就是在互联网上使用最广的一种unicode的实现方式，这是为传输而设计的编码，并使编码无国界，这样就可以显示全世界上所有文化的字符了。</p>\n</blockquote>\n<h4 id=\"UTF-8和Unicode\"><a href=\"#UTF-8和Unicode\" class=\"headerlink\" title=\"UTF-8和Unicode\"></a>UTF-8和Unicode</h4><blockquote>\n<p>UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度，当字符在ASCII 码的范围时，就用一个字节表示，保留了ASCII字符一个字节的编码做为它的一部分，注意的是unicode一个中文字符占2个字节，而UTF-8一个中 文字符占3个字节）。从unicode到uft-8并不是直接的对应，而是要过一些算法和规则来转换。</p>\n</blockquote>\n<h3 id=\"编码方式\"><a href=\"#编码方式\" class=\"headerlink\" title=\"编码方式\"></a>编码方式</h3><blockquote>\n<p>UTF-8的编码规则很简单，只有二条：</p>\n<p>1）对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。</p>\n<p>2）对于n字节的符号（n&gt;1），<strong>第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10</strong>。剩下的没有提及的二进制位，全部为这个符号的unicode码。</p>\n</blockquote>\n<p>所以如果第一个字节是<code>0</code>开头的，那么就是兼容ASCII码的单字节字符；如果第一个字节是<code>1</code>开头的就是多字节字符，数一数前面有多少个<code>1</code>，就知道这个字符占了几个字节。</p>\n<p>所以UTF-8编码后的二进制形式应该如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0xxxxxxx 1个byte</span><br><span class=\"line\"></span><br><span class=\"line\">110xxxxx 10xxxxxx 2个byte</span><br><span class=\"line\"></span><br><span class=\"line\">1110xxxx 10xxxxxx 10xxxxxx 3个byte</span><br><span class=\"line\"></span><br><span class=\"line\">11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 4个byte</span><br><span class=\"line\"></span><br><span class=\"line\">111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 5个byte</span><br><span class=\"line\"></span><br><span class=\"line\">111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 6个byte</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>The bytes <code>0xFE(11111110)</code> and <code>0xFF(11111111)</code> are never used in the UTF-8 encoding.</p>\n</blockquote>\n<p>这两个特殊的字节被用来标示是大端编码和小端编码</p>\n<p>UTF-8编码的范围和Unicode对应的关系如下：</p>\n<table>\n<thead>\n<tr>\n<th>总比特数</th>\n<th>Code Point占的位数</th>\n<th>范围</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>7</td>\n<td>00000000 - 0000007F</td>\n</tr>\n<tr>\n<td>2</td>\n<td>11</td>\n<td>00000080 - 000007FF</td>\n</tr>\n<tr>\n<td>3</td>\n<td>16</td>\n<td>00000800 - 0000FFFF</td>\n</tr>\n<tr>\n<td>4</td>\n<td>21</td>\n<td>00001000 - 001FFFFF</td>\n</tr>\n<tr>\n<td>5</td>\n<td>26</td>\n<td>00200000 - 03FFFFFF</td>\n</tr>\n<tr>\n<td>6</td>\n<td>31</td>\n<td>04000000 - FFFFFFFF</td>\n</tr>\n</tbody>\n</table>\n<p>编码示例：</p>\n<p><code>U+05E7</code> 使用<code>UTF-8</code>编码示例:</p>\n<ol>\n<li><p>查上表得知， <code>05E7</code>在 <code>0080 - 07FF</code> 范围内，总共占2个字节<br>应该是类似 <code>110xxxxx 10xxxxxx</code></p>\n</li>\n<li><p>将其写成二进制形式，<code>0000 0101 1110 0111</code></p>\n</li>\n<li><p>将数据替换上述的<code>x</code>，得到 <code>11010111 10100111 = 0xD7A7</code></p>\n</li>\n</ol>\n<h4 id=\"字节序\"><a href=\"#字节序\" class=\"headerlink\" title=\"字节序\"></a>字节序</h4><p>UTF-8最多使用6个byte表示一个字符，于是就存在一个字节序的问题。<br>字节序分为两种：</p>\n<ol>\n<li><strong>Little-Endian</strong>:<br>字节序低位在前  小尾 在操作系统上很常用，也是计算机系统上最常用的字节序</li>\n<li><strong>Big-Endian</strong>: 字节序高位在前 大尾  也称为网络字节序</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">16进制数字0x12345678，little-endian的存储为:  0x78 0x56 0x34 0x12     地址依次为100, 101, 102, 103</span><br><span class=\"line\"></span><br><span class=\"line\">16进制数字0x12345678，big-endian的存储为:     0x12 0x34 0x56 0x78       地址依次为100, 101, 102, 103</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>“endian”这个词出自《格列佛游记》。小人国的内战就源于吃鸡蛋时是究竟从大头(Big-Endian)敲开还是从小头(Little-Endian)敲开，由此曾发生过六次叛乱，其中一个皇帝送了命，另一个丢了王位。</p>\n</blockquote>\n<h4 id=\"字节序用途\"><a href=\"#字节序用途\" class=\"headerlink\" title=\"字节序用途\"></a>字节序用途</h4><blockquote>\n<p>Little-Endian最常用，大部分用户的操作系统（如windows, FreeBsd,Linux）是Little Endian的。</p>\n<p>Big-Endian最常用在网络协议上，例如TCP/IP协议使用的是big endian. 操作系统上如MAC OS ,是Big Endian 的。<br>本质上说，Little Endian还是Big Endian与操作系统和芯片类型都有关系。PowerPC系列采用big endian方式存储数据，x86系列则采用little endian方式存储数据。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Big Endian</span><br><span class=\"line\">   低地址                                           高地址</span><br><span class=\"line\">   -----------------------------------------&gt;</span><br><span class=\"line\">   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class=\"line\">   |     12     |      34    |     56      |     78    |</span><br><span class=\"line\">   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class=\"line\"></span><br><span class=\"line\">Little Endian</span><br><span class=\"line\">   低地址                                           高地址</span><br><span class=\"line\">   -----------------------------------------&gt;</span><br><span class=\"line\">   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class=\"line\">   |     78     |      56    |     34      |     12    |</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Unicode规范中定义，每一个文件的最前面分别加入一个表示编码顺序的字符，这个字符的名字叫做”零宽度非换行空格”（ZERO WIDTH NO-BREAK SPACE），用FEFF表示。这正好是两个字节，而且FF比FE大1。<br>如果一个文本文件的头两个字节是FE FF，就表示该文件采用大头方式；如果头两个字节是FF FE，就表示该文件采用小头方式。</p>\n</blockquote>\n<h2 id=\"emoji\"><a href=\"#emoji\" class=\"headerlink\" title=\"emoji\"></a>emoji</h2><img src=\"/2016/09/26/character-encoding/emoji.jpg\">\n<p>emoji表情采用的是 Unicode编码，Emoji就是一种在Unicode位于<code>\\u1F601-\\u1F64F</code>区段的字符。这个显然超过了目前常用的UTF-8字符集的编码范围<code>\\u0000-\\uFFFF</code>。</p>\n<p>使用utf8mb4编码便可以解决上述的问题</p>\n<h2 id=\"宽字符\"><a href=\"#宽字符\" class=\"headerlink\" title=\"宽字符\"></a>宽字符</h2><p>宽字符（Wide character） 是程序设计的术语。它是一个抽象的术语（没有规定具体实现细节），用以表示比8位字符还宽的数据类型。它不同于Unicode。</p>\n<p>wchar_t在ANSI/ISO C中是一个数据类型，且某些其它的编程语言也用它来表示宽字符。</p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><ol>\n<li><p><a href=\"https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">字符编码</a></p>\n</li>\n<li><p><a href=\"https://github.com/acmerfight/insight_python/blob/master/Unicode_and_Character_Sets.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Unicode_and_Character_Sets.md</a></p>\n</li>\n<li><p><a href=\"http://www.compsci.hunter.cuny.edu/~sweiss/resources/Unicode.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Unicode and UTF-8</a></p>\n</li>\n<li><p><a href=\"http://www.micmiu.com/lang/java/java-check-chinese/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java 完美判断中文字符</a></p>\n</li>\n<li><p><a href=\"http://unicode.org/emoji/charts/full-emoji-list.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Full Emoji Data, v3.0</a></p>\n</li>\n<li><p><a href=\"http://www.tuicool.com/articles/aQBVny\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">微信emoji表情编码</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/sunshine1314/article/details/2309655\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">关于Big Endian 和 Little Endian</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">字符编码笔记：ASCII，Unicode和UTF-8</a></p>\n</li>\n</ol>\n"},{"title":"cygwin执行命令非常慢","toc":true,"abbrlink":50965,"date":"2017-02-19T16:30:03.000Z","_content":"\n\ncygwin在windows上提供了一套类似linux的开发环境，用起来还是挺爽的。\n\n但是一直困扰我的一个问题是，太慢！具体现象就是使用`ls`都得等半天才出结果。\n\n看网上的资料说cygwin确实慢，再加上我用了`oh-my-zsh`，更是慢上加慢。\n\n## 可能的原因\n\n貌似360对这些工具程序的调用都会做一个拦截，判断下是否有风险。\n\n于是干脆把360给卸载了，终于`ls`的速度变得可以接受。。。。\n\n\n## 参考\n\n1. [为什么Cygwin的执行shell命令很慢？ - IT屋-程序员软件开发技术分享社区](http://www.it1352.com/321952.html)\n\n","source":"_posts/cygwin-360.md","raw":"---\ntitle: cygwin执行命令非常慢\ntags: cygwin\ncategory: linux\ntoc: true\nabbrlink: 50965\ndate: 2017-02-20 00:30:03\n---\n\n\ncygwin在windows上提供了一套类似linux的开发环境，用起来还是挺爽的。\n\n但是一直困扰我的一个问题是，太慢！具体现象就是使用`ls`都得等半天才出结果。\n\n看网上的资料说cygwin确实慢，再加上我用了`oh-my-zsh`，更是慢上加慢。\n\n## 可能的原因\n\n貌似360对这些工具程序的调用都会做一个拦截，判断下是否有风险。\n\n于是干脆把360给卸载了，终于`ls`的速度变得可以接受。。。。\n\n\n## 参考\n\n1. [为什么Cygwin的执行shell命令很慢？ - IT屋-程序员软件开发技术分享社区](http://www.it1352.com/321952.html)\n\n","slug":"cygwin-360","published":1,"updated":"2017-04-16T12:03:23.389Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8v0054jh4kiexi9b1d","content":"<p>cygwin在windows上提供了一套类似linux的开发环境，用起来还是挺爽的。</p>\n<p>但是一直困扰我的一个问题是，太慢！具体现象就是使用<code>ls</code>都得等半天才出结果。</p>\n<p>看网上的资料说cygwin确实慢，再加上我用了<code>oh-my-zsh</code>，更是慢上加慢。</p>\n<h2 id=\"可能的原因\"><a href=\"#可能的原因\" class=\"headerlink\" title=\"可能的原因\"></a>可能的原因</h2><p>貌似360对这些工具程序的调用都会做一个拦截，判断下是否有风险。</p>\n<p>于是干脆把360给卸载了，终于<code>ls</code>的速度变得可以接受。。。。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://www.it1352.com/321952.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">为什么Cygwin的执行shell命令很慢？ - IT屋-程序员软件开发技术分享社区</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>cygwin在windows上提供了一套类似linux的开发环境，用起来还是挺爽的。</p>\n<p>但是一直困扰我的一个问题是，太慢！具体现象就是使用<code>ls</code>都得等半天才出结果。</p>\n<p>看网上的资料说cygwin确实慢，再加上我用了<code>oh-my-zsh</code>，更是慢上加慢。</p>\n<h2 id=\"可能的原因\"><a href=\"#可能的原因\" class=\"headerlink\" title=\"可能的原因\"></a>可能的原因</h2><p>貌似360对这些工具程序的调用都会做一个拦截，判断下是否有风险。</p>\n<p>于是干脆把360给卸载了，终于<code>ls</code>的速度变得可以接受。。。。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://www.it1352.com/321952.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">为什么Cygwin的执行shell命令很慢？ - IT屋-程序员软件开发技术分享社区</a></li>\n</ol>\n"},{"title":"用electron开发自己的工具","toc":true,"date":"2017-09-10T08:14:12.000Z","_content":"\n\n## electron 简介\n\nweb是天生跨平台的。\n\n前几年用ubuntu的时候，各种软件都没有相应的版本，十分的蛋疼。这几年随着web的发展，情况改善了许多。\n比如说chrome的app， 安装好之后和原生的应用几乎没有区别，可以从ubuntu的dash里面搜索到，可以独立打开。\n\n`electron`则是直接整一个微型的chrome，加上html写的界面，直接做客户端。也有类似`atom`， `visual source code`等大型应用也是使用`electron`构建的。\n\n{% asset_img electron.jpg %}\n\n\n## 简单的想法\n\n之前在windows平台，使用的非常顺手的一个剪贴板增强工具——[Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件](http://www.appinn.com/clibor/)， 这个软件非常好用的一个功能就是支持`定型文`。所谓的`定型文`就是你事先录制好的一些常用的\n条目，然后当你需要使用的时候，按快捷键呼出界面，选中想要的`定型文`，直接就给你复制到了剪贴板，十分的方便。\n\n{% asset_img item.png %}\n\n\nwindows不爽的就是shell不好用， 虽然有`cygwin`,`babun`，`cmder`等还算不错的终端，但是用起来卡卡的，所以最终我还是迁移到了ubuntu，各种命令，各种爽。\n\n但是，作为一个后端的开发，每天要上服务器上查各种问题，各种长长的命令，各种记不住，所以还是要有一个类似小抄试的工具来增强下工作效率。恰巧，上次在youtube上看electorn的一个视频——[Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube](https://www.youtube.com/watch?v=FNHBfN8c32U)。这个视频大概介绍了electron，介绍了一些使用electron开发的有意思的应用， 恰巧我看到了一个叫做`mojibar`的简单应用。\n\n{% asset_img mojibar.gif %}\n\n她的这个应用是，搜索moji表情对应的文字， 然后会筛选出来相应的结果，然后复制到剪贴板上，支持快捷键呼出。看到这个就瞬间来了灵感，这和我要的小抄应用简直十分吻合。好在`electron`并不复杂，就研究了下代码自己改造了一番，于是就有了这篇文章。\n\n## demo\n\n这个demo基本可以在日常的工作中使用了， github的repo在——[qsLI/quake-select](https://github.com/qsLI/quake-select)\n\n下面是界面的截图：\n\n{% asset_img select.png %}\n\n配置文件在json中，类似下面的形式：\n\n```json\n{\n  \"commands\": [\n    {\n      \"desc\": \"查看jvm堆的使用情况\",\n      \"command\": \"sudo -u tomcat jmap -heap  `pgrep -f 'tomcat'`\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"查看jvm最终加载的开关\",\n      \"command\": \"java -XX:+PrintFlagsFinal -version\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"\",\n      \"command\": \"sudo -u tomcat jcmd `pgrep -f tomcat` VM.flags\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"查看jvm加载的系统变量\",\n      \"command\": \"sudo -u tomcat jcmd `pgrep -f tomcat` VM.system_properties\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"查看本机jcmd支持的命令\",\n      \"command\": \"sudo -u tomcat jcmd `pgrep -f tomcat` help\",\n      \"tag\": \"opt\"\n    }\n  ]\n}\n\n```\n\n目前支持按照`command`和`tag`搜索， mojibar使用的这个库在ubuntu下菜单会显示不出来，以后有时间再fix。\n\n## 参考\n\n1. [Electron | Build cross platform desktop apps with JavaScript, HTML, and CSS.](https://electron.atom.io/)\n\n2. [使用 Electron 构建桌面应用 - 知乎专栏](https://zhuanlan.zhihu.com/p/20225295)\n\n3. [Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件](http://www.appinn.com/clibor/)\n\n4. [Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube](https://www.youtube.com/watch?v=FNHBfN8c32U)\n\n5. [muan/mojibar: Emoji searcher but as a menubar app.](https://github.com/muan/mojibar)","source":"_posts/electron.md","raw":"title: 用electron开发自己的工具\ntags: electron\ncategory: fe\ntoc: true\ndate: 2017-09-10 16:14:12\n---\n\n\n## electron 简介\n\nweb是天生跨平台的。\n\n前几年用ubuntu的时候，各种软件都没有相应的版本，十分的蛋疼。这几年随着web的发展，情况改善了许多。\n比如说chrome的app， 安装好之后和原生的应用几乎没有区别，可以从ubuntu的dash里面搜索到，可以独立打开。\n\n`electron`则是直接整一个微型的chrome，加上html写的界面，直接做客户端。也有类似`atom`， `visual source code`等大型应用也是使用`electron`构建的。\n\n{% asset_img electron.jpg %}\n\n\n## 简单的想法\n\n之前在windows平台，使用的非常顺手的一个剪贴板增强工具——[Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件](http://www.appinn.com/clibor/)， 这个软件非常好用的一个功能就是支持`定型文`。所谓的`定型文`就是你事先录制好的一些常用的\n条目，然后当你需要使用的时候，按快捷键呼出界面，选中想要的`定型文`，直接就给你复制到了剪贴板，十分的方便。\n\n{% asset_img item.png %}\n\n\nwindows不爽的就是shell不好用， 虽然有`cygwin`,`babun`，`cmder`等还算不错的终端，但是用起来卡卡的，所以最终我还是迁移到了ubuntu，各种命令，各种爽。\n\n但是，作为一个后端的开发，每天要上服务器上查各种问题，各种长长的命令，各种记不住，所以还是要有一个类似小抄试的工具来增强下工作效率。恰巧，上次在youtube上看electorn的一个视频——[Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube](https://www.youtube.com/watch?v=FNHBfN8c32U)。这个视频大概介绍了electron，介绍了一些使用electron开发的有意思的应用， 恰巧我看到了一个叫做`mojibar`的简单应用。\n\n{% asset_img mojibar.gif %}\n\n她的这个应用是，搜索moji表情对应的文字， 然后会筛选出来相应的结果，然后复制到剪贴板上，支持快捷键呼出。看到这个就瞬间来了灵感，这和我要的小抄应用简直十分吻合。好在`electron`并不复杂，就研究了下代码自己改造了一番，于是就有了这篇文章。\n\n## demo\n\n这个demo基本可以在日常的工作中使用了， github的repo在——[qsLI/quake-select](https://github.com/qsLI/quake-select)\n\n下面是界面的截图：\n\n{% asset_img select.png %}\n\n配置文件在json中，类似下面的形式：\n\n```json\n{\n  \"commands\": [\n    {\n      \"desc\": \"查看jvm堆的使用情况\",\n      \"command\": \"sudo -u tomcat jmap -heap  `pgrep -f 'tomcat'`\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"查看jvm最终加载的开关\",\n      \"command\": \"java -XX:+PrintFlagsFinal -version\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"\",\n      \"command\": \"sudo -u tomcat jcmd `pgrep -f tomcat` VM.flags\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"查看jvm加载的系统变量\",\n      \"command\": \"sudo -u tomcat jcmd `pgrep -f tomcat` VM.system_properties\",\n      \"tag\": \"opt\"\n    },\n    {\n      \"desc\": \"查看本机jcmd支持的命令\",\n      \"command\": \"sudo -u tomcat jcmd `pgrep -f tomcat` help\",\n      \"tag\": \"opt\"\n    }\n  ]\n}\n\n```\n\n目前支持按照`command`和`tag`搜索， mojibar使用的这个库在ubuntu下菜单会显示不出来，以后有时间再fix。\n\n## 参考\n\n1. [Electron | Build cross platform desktop apps with JavaScript, HTML, and CSS.](https://electron.atom.io/)\n\n2. [使用 Electron 构建桌面应用 - 知乎专栏](https://zhuanlan.zhihu.com/p/20225295)\n\n3. [Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件](http://www.appinn.com/clibor/)\n\n4. [Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube](https://www.youtube.com/watch?v=FNHBfN8c32U)\n\n5. [muan/mojibar: Emoji searcher but as a menubar app.](https://github.com/muan/mojibar)","slug":"electron","published":1,"updated":"2017-09-10T08:27:56.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8w0056jh4kpka0nrwi","content":"<h2 id=\"electron-简介\"><a href=\"#electron-简介\" class=\"headerlink\" title=\"electron 简介\"></a>electron 简介</h2><p>web是天生跨平台的。</p>\n<p>前几年用ubuntu的时候，各种软件都没有相应的版本，十分的蛋疼。这几年随着web的发展，情况改善了许多。<br>比如说chrome的app， 安装好之后和原生的应用几乎没有区别，可以从ubuntu的dash里面搜索到，可以独立打开。</p>\n<p><code>electron</code>则是直接整一个微型的chrome，加上html写的界面，直接做客户端。也有类似<code>atom</code>， <code>visual source code</code>等大型应用也是使用<code>electron</code>构建的。</p>\n<img src=\"/2017/09/10/electron/electron.jpg\">\n<h2 id=\"简单的想法\"><a href=\"#简单的想法\" class=\"headerlink\" title=\"简单的想法\"></a>简单的想法</h2><p>之前在windows平台，使用的非常顺手的一个剪贴板增强工具——<a href=\"http://www.appinn.com/clibor/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件</a>， 这个软件非常好用的一个功能就是支持<code>定型文</code>。所谓的<code>定型文</code>就是你事先录制好的一些常用的<br>条目，然后当你需要使用的时候，按快捷键呼出界面，选中想要的<code>定型文</code>，直接就给你复制到了剪贴板，十分的方便。</p>\n<img src=\"/2017/09/10/electron/item.png\">\n<p>windows不爽的就是shell不好用， 虽然有<code>cygwin</code>,<code>babun</code>，<code>cmder</code>等还算不错的终端，但是用起来卡卡的，所以最终我还是迁移到了ubuntu，各种命令，各种爽。</p>\n<p>但是，作为一个后端的开发，每天要上服务器上查各种问题，各种长长的命令，各种记不住，所以还是要有一个类似小抄试的工具来增强下工作效率。恰巧，上次在youtube上看electorn的一个视频——<a href=\"https://www.youtube.com/watch?v=FNHBfN8c32U\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube</a>。这个视频大概介绍了electron，介绍了一些使用electron开发的有意思的应用， 恰巧我看到了一个叫做<code>mojibar</code>的简单应用。</p>\n<img src=\"/2017/09/10/electron/mojibar.gif\">\n<p>她的这个应用是，搜索moji表情对应的文字， 然后会筛选出来相应的结果，然后复制到剪贴板上，支持快捷键呼出。看到这个就瞬间来了灵感，这和我要的小抄应用简直十分吻合。好在<code>electron</code>并不复杂，就研究了下代码自己改造了一番，于是就有了这篇文章。</p>\n<h2 id=\"demo\"><a href=\"#demo\" class=\"headerlink\" title=\"demo\"></a>demo</h2><p>这个demo基本可以在日常的工作中使用了， github的repo在——<a href=\"https://github.com/qsLI/quake-select\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">qsLI/quake-select</a></p>\n<p>下面是界面的截图：</p>\n<img src=\"/2017/09/10/electron/select.png\">\n<p>配置文件在json中，类似下面的形式：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"commands\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看jvm堆的使用情况\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jmap -heap  `pgrep -f 'tomcat'`\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看jvm最终加载的开关\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"java -XX:+PrintFlagsFinal -version\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jcmd `pgrep -f tomcat` VM.flags\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看jvm加载的系统变量\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jcmd `pgrep -f tomcat` VM.system_properties\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看本机jcmd支持的命令\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jcmd `pgrep -f tomcat` help\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>目前支持按照<code>command</code>和<code>tag</code>搜索， mojibar使用的这个库在ubuntu下菜单会显示不出来，以后有时间再fix。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://electron.atom.io/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Electron | Build cross platform desktop apps with JavaScript, HTML, and CSS.</a></p>\n</li>\n<li><p><a href=\"https://zhuanlan.zhihu.com/p/20225295\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">使用 Electron 构建桌面应用 - 知乎专栏</a></p>\n</li>\n<li><p><a href=\"http://www.appinn.com/clibor/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件</a></p>\n</li>\n<li><p><a href=\"https://www.youtube.com/watch?v=FNHBfN8c32U\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube</a></p>\n</li>\n<li><p><a href=\"https://github.com/muan/mojibar\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">muan/mojibar: Emoji searcher but as a menubar app.</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"electron-简介\"><a href=\"#electron-简介\" class=\"headerlink\" title=\"electron 简介\"></a>electron 简介</h2><p>web是天生跨平台的。</p>\n<p>前几年用ubuntu的时候，各种软件都没有相应的版本，十分的蛋疼。这几年随着web的发展，情况改善了许多。<br>比如说chrome的app， 安装好之后和原生的应用几乎没有区别，可以从ubuntu的dash里面搜索到，可以独立打开。</p>\n<p><code>electron</code>则是直接整一个微型的chrome，加上html写的界面，直接做客户端。也有类似<code>atom</code>， <code>visual source code</code>等大型应用也是使用<code>electron</code>构建的。</p>\n<img src=\"/2017/09/10/electron/electron.jpg\">\n<h2 id=\"简单的想法\"><a href=\"#简单的想法\" class=\"headerlink\" title=\"简单的想法\"></a>简单的想法</h2><p>之前在windows平台，使用的非常顺手的一个剪贴板增强工具——<a href=\"http://www.appinn.com/clibor/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件</a>， 这个软件非常好用的一个功能就是支持<code>定型文</code>。所谓的<code>定型文</code>就是你事先录制好的一些常用的<br>条目，然后当你需要使用的时候，按快捷键呼出界面，选中想要的<code>定型文</code>，直接就给你复制到了剪贴板，十分的方便。</p>\n<img src=\"/2017/09/10/electron/item.png\">\n<p>windows不爽的就是shell不好用， 虽然有<code>cygwin</code>,<code>babun</code>，<code>cmder</code>等还算不错的终端，但是用起来卡卡的，所以最终我还是迁移到了ubuntu，各种命令，各种爽。</p>\n<p>但是，作为一个后端的开发，每天要上服务器上查各种问题，各种长长的命令，各种记不住，所以还是要有一个类似小抄试的工具来增强下工作效率。恰巧，上次在youtube上看electorn的一个视频——<a href=\"https://www.youtube.com/watch?v=FNHBfN8c32U\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube</a>。这个视频大概介绍了electron，介绍了一些使用electron开发的有意思的应用， 恰巧我看到了一个叫做<code>mojibar</code>的简单应用。</p>\n<img src=\"/2017/09/10/electron/mojibar.gif\">\n<p>她的这个应用是，搜索moji表情对应的文字， 然后会筛选出来相应的结果，然后复制到剪贴板上，支持快捷键呼出。看到这个就瞬间来了灵感，这和我要的小抄应用简直十分吻合。好在<code>electron</code>并不复杂，就研究了下代码自己改造了一番，于是就有了这篇文章。</p>\n<h2 id=\"demo\"><a href=\"#demo\" class=\"headerlink\" title=\"demo\"></a>demo</h2><p>这个demo基本可以在日常的工作中使用了， github的repo在——<a href=\"https://github.com/qsLI/quake-select\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">qsLI/quake-select</a></p>\n<p>下面是界面的截图：</p>\n<img src=\"/2017/09/10/electron/select.png\">\n<p>配置文件在json中，类似下面的形式：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"commands\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看jvm堆的使用情况\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jmap -heap  `pgrep -f 'tomcat'`\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看jvm最终加载的开关\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"java -XX:+PrintFlagsFinal -version\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jcmd `pgrep -f tomcat` VM.flags\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看jvm加载的系统变量\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jcmd `pgrep -f tomcat` VM.system_properties\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"desc\"</span>: <span class=\"string\">\"查看本机jcmd支持的命令\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"command\"</span>: <span class=\"string\">\"sudo -u tomcat jcmd `pgrep -f tomcat` help\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"opt\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>目前支持按照<code>command</code>和<code>tag</code>搜索， mojibar使用的这个库在ubuntu下菜单会显示不出来，以后有时间再fix。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://electron.atom.io/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Electron | Build cross platform desktop apps with JavaScript, HTML, and CSS.</a></p>\n</li>\n<li><p><a href=\"https://zhuanlan.zhihu.com/p/20225295\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">使用 Electron 构建桌面应用 - 知乎专栏</a></p>\n</li>\n<li><p><a href=\"http://www.appinn.com/clibor/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Clibor – 来自日本的剪贴板辅助工具[Win] - 小众软件</a></p>\n</li>\n<li><p><a href=\"https://www.youtube.com/watch?v=FNHBfN8c32U\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Electron: Desktop Apps with Web Languages - GitHub Universe 2016 - YouTube</a></p>\n</li>\n<li><p><a href=\"https://github.com/muan/mojibar\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">muan/mojibar: Emoji searcher but as a menubar app.</a></p>\n</li>\n</ol>\n"},{"title":"fabric 分布式部署","toc":true,"abbrlink":42953,"date":"2015-11-03T15:55:34.000Z","_content":"\n## 前言\n   在一台linux主机上执行命令，如果太繁琐可以写成 Shell 脚本；如果在一个集群上批量执行命令呢？\n一台一台的ssh登录去执行当然是可以的，如果集群太大，就太繁琐了。下面介绍一些在集群上执行命令的方法。\n\n## ssh 远程执行命令\n\t通过 ssh 可以按照下面的方式远程执行命令\n``` bash\n ssh user@host 'command1;command2;command3'\n```\n或者使用管道\n``` bash\n ssh user@host 'command1|command2|command3'\n```\n或者使用如下的\n``` bash\n\t$ ssh [user]@[server] << EOF\n\tcommand 1\n\tcommand 2\n\tcommand 3\n\tEOF\n```\n或者将要执行的命令写入 Shell 脚本\n``` bash\n\t$ ssh user@host 'bash -s' < local_script.sh\n```\n\n可以通过指定ssh 参数 `-o StrictHostKeyChecking=no` 来省去下面的交互过程 \n \n\n\n![](http://farm8.staticflickr.com/7399/8778510478_4a428cc5f4.jpg    )\n\n\n\n\n**但是上面的方法执行 sudo 命令的时候会出错**\n此时需要加上 ssh 的 `-t` 参数\nman 一下 ssh 查找 -t 参数可以看到如下的解释\n\n> -t      \n> Force pseudo-tty allocation.  This can be used to execute arbi‐\n             trary screen-based programs on a remote machine, which can be\n             very useful, e.g. when implementing menu services.  Multiple -t\n             options force tty allocation, even if ssh has no local tty.\n\n具体的意思就是强制提供一个远程服务器的虚拟tty终端\n``` bash\n\tssh -t -p port user@host 'cmd'\n```\n即可执行sudo命令，但是自己还要手工输入远程服务器的密码\n---\n要想写在脚本中自动执行还需要使用 expect\nexpect是 linux下的一个命令用来处理执行命令中的交互，python 也有相应的库 pexpect\n> Expect  is a program that \"talks\" to other interactive programs accord‐\n       ing to a script. \n\n下面是参考的一些文章\n > [Send Remote Commands Via SSH](http://malcontentcomics.com/systemsboy/2006/07/send-remote-commands-via-ssh.html)\n > [Running Commands on a Remote Linux Server over SSH](http://www.shellhacks.com/en/Running-Commands-on-a-Remote-Linux-Server-over-SSH)\n\n## 其他集群管理命令\n\n如 pssh mussh\n\n> [linux集群管理工具mussh和pssh](http://xiaorui.cc/2014/07/09/linux%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7mussh%E5%92%8Cpssh/)\n\n## fabric \n\nfabric 是基于 ssh 的一个python库，主要用来做运维或者批量部署\n[fabric官网](http://www.fabfile.org/)\n* 安装 fabric\n``` bash\n\tpip install fabric\n```\n\n安装完成即可使用 fabric，fabric上手简单，功能强大\n\n``` bash\n\tfab -f xxx.py command\n```\nfab 默认在当前目录下寻找 fabfiles，如果你的文件是其他的名字，使用 `-f`指定即可\n\n脚本的编写\n``` python\n\tfrom fabric.api import run\n\n\tdef host_type():\n\t\trun('uname -s')\n```\n运行\n``` bash\n\t$ fab -H localhost,linuxbox host_type\n\t\t[localhost] run: uname -s\n\t\t[localhost] out: Darwin\n\t\t[linuxbox] run: uname -s\n\t\t[linuxbox] out: Linux\n\t\t\n\t\tDone.\n\t\tDisconnecting from localhost... done.\n\t\tDisconnecting from linuxbox... done.\n```\n使用 `-H`可以指定运行的host， 也可以在代码中指定。\n用户名和密码都是存在 env 环境变量中，也可在脚本中更改\n[The environment dictionary](http://docs.fabfile.org/en/1.10/usage/env.html?highlight=env)\n\n同时 fabric 还提供了一些装饰器，具体的可以查文档\n``` python\n\t@parralel\n\t@task\n\t@role()\n\t@host()\n```\n详细讲解可以参考这篇文章 [Python fabric实现远程操作和部署 ](http://wklken.me/posts/2013/03/25/python-tool-fabric.html)\n","source":"_posts/fabric.md","raw":"---\ntitle: fabric 分布式部署\ntags: fabric\ncategory: python\ntoc: true\nabbrlink: 42953\ndate: 2015-11-03 23:55:34\n---\n\n## 前言\n   在一台linux主机上执行命令，如果太繁琐可以写成 Shell 脚本；如果在一个集群上批量执行命令呢？\n一台一台的ssh登录去执行当然是可以的，如果集群太大，就太繁琐了。下面介绍一些在集群上执行命令的方法。\n\n## ssh 远程执行命令\n\t通过 ssh 可以按照下面的方式远程执行命令\n``` bash\n ssh user@host 'command1;command2;command3'\n```\n或者使用管道\n``` bash\n ssh user@host 'command1|command2|command3'\n```\n或者使用如下的\n``` bash\n\t$ ssh [user]@[server] << EOF\n\tcommand 1\n\tcommand 2\n\tcommand 3\n\tEOF\n```\n或者将要执行的命令写入 Shell 脚本\n``` bash\n\t$ ssh user@host 'bash -s' < local_script.sh\n```\n\n可以通过指定ssh 参数 `-o StrictHostKeyChecking=no` 来省去下面的交互过程 \n \n\n\n![](http://farm8.staticflickr.com/7399/8778510478_4a428cc5f4.jpg    )\n\n\n\n\n**但是上面的方法执行 sudo 命令的时候会出错**\n此时需要加上 ssh 的 `-t` 参数\nman 一下 ssh 查找 -t 参数可以看到如下的解释\n\n> -t      \n> Force pseudo-tty allocation.  This can be used to execute arbi‐\n             trary screen-based programs on a remote machine, which can be\n             very useful, e.g. when implementing menu services.  Multiple -t\n             options force tty allocation, even if ssh has no local tty.\n\n具体的意思就是强制提供一个远程服务器的虚拟tty终端\n``` bash\n\tssh -t -p port user@host 'cmd'\n```\n即可执行sudo命令，但是自己还要手工输入远程服务器的密码\n---\n要想写在脚本中自动执行还需要使用 expect\nexpect是 linux下的一个命令用来处理执行命令中的交互，python 也有相应的库 pexpect\n> Expect  is a program that \"talks\" to other interactive programs accord‐\n       ing to a script. \n\n下面是参考的一些文章\n > [Send Remote Commands Via SSH](http://malcontentcomics.com/systemsboy/2006/07/send-remote-commands-via-ssh.html)\n > [Running Commands on a Remote Linux Server over SSH](http://www.shellhacks.com/en/Running-Commands-on-a-Remote-Linux-Server-over-SSH)\n\n## 其他集群管理命令\n\n如 pssh mussh\n\n> [linux集群管理工具mussh和pssh](http://xiaorui.cc/2014/07/09/linux%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7mussh%E5%92%8Cpssh/)\n\n## fabric \n\nfabric 是基于 ssh 的一个python库，主要用来做运维或者批量部署\n[fabric官网](http://www.fabfile.org/)\n* 安装 fabric\n``` bash\n\tpip install fabric\n```\n\n安装完成即可使用 fabric，fabric上手简单，功能强大\n\n``` bash\n\tfab -f xxx.py command\n```\nfab 默认在当前目录下寻找 fabfiles，如果你的文件是其他的名字，使用 `-f`指定即可\n\n脚本的编写\n``` python\n\tfrom fabric.api import run\n\n\tdef host_type():\n\t\trun('uname -s')\n```\n运行\n``` bash\n\t$ fab -H localhost,linuxbox host_type\n\t\t[localhost] run: uname -s\n\t\t[localhost] out: Darwin\n\t\t[linuxbox] run: uname -s\n\t\t[linuxbox] out: Linux\n\t\t\n\t\tDone.\n\t\tDisconnecting from localhost... done.\n\t\tDisconnecting from linuxbox... done.\n```\n使用 `-H`可以指定运行的host， 也可以在代码中指定。\n用户名和密码都是存在 env 环境变量中，也可在脚本中更改\n[The environment dictionary](http://docs.fabfile.org/en/1.10/usage/env.html?highlight=env)\n\n同时 fabric 还提供了一些装饰器，具体的可以查文档\n``` python\n\t@parralel\n\t@task\n\t@role()\n\t@host()\n```\n详细讲解可以参考这篇文章 [Python fabric实现远程操作和部署 ](http://wklken.me/posts/2013/03/25/python-tool-fabric.html)\n","slug":"fabric","published":1,"updated":"2017-04-16T12:03:23.389Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8x0059jh4kjg8c9lpv","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>   在一台linux主机上执行命令，如果太繁琐可以写成 Shell 脚本；如果在一个集群上批量执行命令呢？<br>一台一台的ssh登录去执行当然是可以的，如果集群太大，就太繁琐了。下面介绍一些在集群上执行命令的方法。</p>\n<h2 id=\"ssh-远程执行命令\"><a href=\"#ssh-远程执行命令\" class=\"headerlink\" title=\"ssh 远程执行命令\"></a>ssh 远程执行命令</h2><pre><code>通过 ssh 可以按照下面的方式远程执行命令\n</code></pre><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh user@host <span class=\"string\">'command1;command2;command3'</span></span><br></pre></td></tr></table></figure>\n<p>或者使用管道<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh user@host <span class=\"string\">'command1|command2|command3'</span></span><br></pre></td></tr></table></figure></p>\n<p>或者使用如下的<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh [user]@[server] &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"built_in\">command</span> 1</span><br><span class=\"line\"><span class=\"built_in\">command</span> 2</span><br><span class=\"line\"><span class=\"built_in\">command</span> 3</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>或者将要执行的命令写入 Shell 脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh user@host <span class=\"string\">'bash -s'</span> &lt; local_script.sh</span><br></pre></td></tr></table></figure></p>\n<p>可以通过指定ssh 参数 <code>-o StrictHostKeyChecking=no</code> 来省去下面的交互过程 </p>\n<p><img src=\"http://farm8.staticflickr.com/7399/8778510478_4a428cc5f4.jpg\" alt=\"\"></p>\n<p><strong>但是上面的方法执行 sudo 命令的时候会出错</strong><br>此时需要加上 ssh 的 <code>-t</code> 参数<br>man 一下 ssh 查找 -t 参数可以看到如下的解释</p>\n<blockquote>\n<p>-t<br>Force pseudo-tty allocation.  This can be used to execute arbi‐<br>             trary screen-based programs on a remote machine, which can be<br>             very useful, e.g. when implementing menu services.  Multiple -t<br>             options force tty allocation, even if ssh has no local tty.</p>\n</blockquote>\n<p>具体的意思就是强制提供一个远程服务器的虚拟tty终端<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -t -p port user@host <span class=\"string\">'cmd'</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"即可执行sudo命令，但是自己还要手工输入远程服务器的密码\"><a href=\"#即可执行sudo命令，但是自己还要手工输入远程服务器的密码\" class=\"headerlink\" title=\"即可执行sudo命令，但是自己还要手工输入远程服务器的密码\"></a>即可执行sudo命令，但是自己还要手工输入远程服务器的密码</h2><p>要想写在脚本中自动执行还需要使用 expect<br>expect是 linux下的一个命令用来处理执行命令中的交互，python 也有相应的库 pexpect</p>\n<blockquote>\n<p>Expect  is a program that “talks” to other interactive programs accord‐<br>       ing to a script. </p>\n</blockquote>\n<p>下面是参考的一些文章</p>\n<blockquote>\n<p><a href=\"http://malcontentcomics.com/systemsboy/2006/07/send-remote-commands-via-ssh.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Send Remote Commands Via SSH</a><br><a href=\"http://www.shellhacks.com/en/Running-Commands-on-a-Remote-Linux-Server-over-SSH\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Running Commands on a Remote Linux Server over SSH</a></p>\n</blockquote>\n<h2 id=\"其他集群管理命令\"><a href=\"#其他集群管理命令\" class=\"headerlink\" title=\"其他集群管理命令\"></a>其他集群管理命令</h2><p>如 pssh mussh</p>\n<blockquote>\n<p><a href=\"http://xiaorui.cc/2014/07/09/linux%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7mussh%E5%92%8Cpssh/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">linux集群管理工具mussh和pssh</a></p>\n</blockquote>\n<h2 id=\"fabric\"><a href=\"#fabric\" class=\"headerlink\" title=\"fabric\"></a>fabric</h2><p>fabric 是基于 ssh 的一个python库，主要用来做运维或者批量部署<br><a href=\"http://www.fabfile.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">fabric官网</a></p>\n<ul>\n<li>安装 fabric<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fabric</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>安装完成即可使用 fabric，fabric上手简单，功能强大</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fab -f xxx.py <span class=\"built_in\">command</span></span><br></pre></td></tr></table></figure>\n<p>fab 默认在当前目录下寻找 fabfiles，如果你的文件是其他的名字，使用 <code>-f</code>指定即可</p>\n<p>脚本的编写<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> fabric.api <span class=\"keyword\">import</span> run</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">host_type</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\trun(<span class=\"string\">'uname -s'</span>)</span><br></pre></td></tr></table></figure></p>\n<p>运行<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ fab -H localhost,linuxbox host_type</span><br><span class=\"line\">\t[localhost] run: uname -s</span><br><span class=\"line\">\t[localhost] out: Darwin</span><br><span class=\"line\">\t[linuxbox] run: uname -s</span><br><span class=\"line\">\t[linuxbox] out: Linux</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tDone.</span><br><span class=\"line\">\tDisconnecting from localhost... <span class=\"keyword\">done</span>.</span><br><span class=\"line\">\tDisconnecting from linuxbox... <span class=\"keyword\">done</span>.</span><br></pre></td></tr></table></figure></p>\n<p>使用 <code>-H</code>可以指定运行的host， 也可以在代码中指定。<br>用户名和密码都是存在 env 环境变量中，也可在脚本中更改<br><a href=\"http://docs.fabfile.org/en/1.10/usage/env.html?highlight=env\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The environment dictionary</a></p>\n<p>同时 fabric 还提供了一些装饰器，具体的可以查文档<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@parralel</span></span><br><span class=\"line\"><span class=\"meta\">@task</span></span><br><span class=\"line\"><span class=\"meta\">@role()</span></span><br><span class=\"line\"><span class=\"meta\">@host()</span></span><br></pre></td></tr></table></figure></p>\n<p>详细讲解可以参考这篇文章 <a href=\"http://wklken.me/posts/2013/03/25/python-tool-fabric.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Python fabric实现远程操作和部署 </a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>   在一台linux主机上执行命令，如果太繁琐可以写成 Shell 脚本；如果在一个集群上批量执行命令呢？<br>一台一台的ssh登录去执行当然是可以的，如果集群太大，就太繁琐了。下面介绍一些在集群上执行命令的方法。</p>\n<h2 id=\"ssh-远程执行命令\"><a href=\"#ssh-远程执行命令\" class=\"headerlink\" title=\"ssh 远程执行命令\"></a>ssh 远程执行命令</h2><pre><code>通过 ssh 可以按照下面的方式远程执行命令\n</code></pre><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh user@host <span class=\"string\">'command1;command2;command3'</span></span><br></pre></td></tr></table></figure>\n<p>或者使用管道<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh user@host <span class=\"string\">'command1|command2|command3'</span></span><br></pre></td></tr></table></figure></p>\n<p>或者使用如下的<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh [user]@[server] &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"built_in\">command</span> 1</span><br><span class=\"line\"><span class=\"built_in\">command</span> 2</span><br><span class=\"line\"><span class=\"built_in\">command</span> 3</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>或者将要执行的命令写入 Shell 脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh user@host <span class=\"string\">'bash -s'</span> &lt; local_script.sh</span><br></pre></td></tr></table></figure></p>\n<p>可以通过指定ssh 参数 <code>-o StrictHostKeyChecking=no</code> 来省去下面的交互过程 </p>\n<p><img src=\"http://farm8.staticflickr.com/7399/8778510478_4a428cc5f4.jpg\" alt=\"\"></p>\n<p><strong>但是上面的方法执行 sudo 命令的时候会出错</strong><br>此时需要加上 ssh 的 <code>-t</code> 参数<br>man 一下 ssh 查找 -t 参数可以看到如下的解释</p>\n<blockquote>\n<p>-t<br>Force pseudo-tty allocation.  This can be used to execute arbi‐<br>             trary screen-based programs on a remote machine, which can be<br>             very useful, e.g. when implementing menu services.  Multiple -t<br>             options force tty allocation, even if ssh has no local tty.</p>\n</blockquote>\n<p>具体的意思就是强制提供一个远程服务器的虚拟tty终端<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -t -p port user@host <span class=\"string\">'cmd'</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"即可执行sudo命令，但是自己还要手工输入远程服务器的密码\"><a href=\"#即可执行sudo命令，但是自己还要手工输入远程服务器的密码\" class=\"headerlink\" title=\"即可执行sudo命令，但是自己还要手工输入远程服务器的密码\"></a>即可执行sudo命令，但是自己还要手工输入远程服务器的密码</h2><p>要想写在脚本中自动执行还需要使用 expect<br>expect是 linux下的一个命令用来处理执行命令中的交互，python 也有相应的库 pexpect</p>\n<blockquote>\n<p>Expect  is a program that “talks” to other interactive programs accord‐<br>       ing to a script. </p>\n</blockquote>\n<p>下面是参考的一些文章</p>\n<blockquote>\n<p><a href=\"http://malcontentcomics.com/systemsboy/2006/07/send-remote-commands-via-ssh.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Send Remote Commands Via SSH</a><br><a href=\"http://www.shellhacks.com/en/Running-Commands-on-a-Remote-Linux-Server-over-SSH\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Running Commands on a Remote Linux Server over SSH</a></p>\n</blockquote>\n<h2 id=\"其他集群管理命令\"><a href=\"#其他集群管理命令\" class=\"headerlink\" title=\"其他集群管理命令\"></a>其他集群管理命令</h2><p>如 pssh mussh</p>\n<blockquote>\n<p><a href=\"http://xiaorui.cc/2014/07/09/linux%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7mussh%E5%92%8Cpssh/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">linux集群管理工具mussh和pssh</a></p>\n</blockquote>\n<h2 id=\"fabric\"><a href=\"#fabric\" class=\"headerlink\" title=\"fabric\"></a>fabric</h2><p>fabric 是基于 ssh 的一个python库，主要用来做运维或者批量部署<br><a href=\"http://www.fabfile.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">fabric官网</a></p>\n<ul>\n<li>安装 fabric<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install fabric</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>安装完成即可使用 fabric，fabric上手简单，功能强大</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fab -f xxx.py <span class=\"built_in\">command</span></span><br></pre></td></tr></table></figure>\n<p>fab 默认在当前目录下寻找 fabfiles，如果你的文件是其他的名字，使用 <code>-f</code>指定即可</p>\n<p>脚本的编写<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> fabric.api <span class=\"keyword\">import</span> run</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">host_type</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\trun(<span class=\"string\">'uname -s'</span>)</span><br></pre></td></tr></table></figure></p>\n<p>运行<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ fab -H localhost,linuxbox host_type</span><br><span class=\"line\">\t[localhost] run: uname -s</span><br><span class=\"line\">\t[localhost] out: Darwin</span><br><span class=\"line\">\t[linuxbox] run: uname -s</span><br><span class=\"line\">\t[linuxbox] out: Linux</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tDone.</span><br><span class=\"line\">\tDisconnecting from localhost... <span class=\"keyword\">done</span>.</span><br><span class=\"line\">\tDisconnecting from linuxbox... <span class=\"keyword\">done</span>.</span><br></pre></td></tr></table></figure></p>\n<p>使用 <code>-H</code>可以指定运行的host， 也可以在代码中指定。<br>用户名和密码都是存在 env 环境变量中，也可在脚本中更改<br><a href=\"http://docs.fabfile.org/en/1.10/usage/env.html?highlight=env\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The environment dictionary</a></p>\n<p>同时 fabric 还提供了一些装饰器，具体的可以查文档<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@parralel</span></span><br><span class=\"line\"><span class=\"meta\">@task</span></span><br><span class=\"line\"><span class=\"meta\">@role()</span></span><br><span class=\"line\"><span class=\"meta\">@host()</span></span><br></pre></td></tr></table></figure></p>\n<p>详细讲解可以参考这篇文章 <a href=\"http://wklken.me/posts/2013/03/25/python-tool-fabric.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Python fabric实现远程操作和部署 </a></p>\n"},{"title":"executor总结","toc":true,"date":"2017-11-18T20:01:22.000Z","_content":"\n\n## shutdown()和shutdownNow()\n\n### shutdown()\n\n`shutdown()`会尝试中断空闲的线程，并把`ThreadPool`的状态置成`SHUTDOWN`,\n这个状态下，不能通过`submit()`或者`execute()`提交任务，但是正在执行的和任务队列中的任务还可以继续执行。\n\n```java\n    public void shutdown() {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            checkShutdownAccess();\n            advanceRunState(SHUTDOWN);\n            interruptIdleWorkers();\n            onShutdown(); // hook for ScheduledThreadPoolExecutor\n        } finally {\n            mainLock.unlock();\n        }\n        tryTerminate();\n    }   \n```\n任务队列中的任务拉取, 通过`getTask()`方法进行。\n\n```java\n  final void runWorker(Worker w) {\n        Thread wt = Thread.currentThread();\n        Runnable task = w.firstTask;\n        w.firstTask = null;\n        w.unlock(); // allow interrupts\n        boolean completedAbruptly = true;\n        try {\n            while (task != null || (task = getTask()) != null) {\n                w.lock();\n                // If pool is stopping, ensure thread is interrupted;\n                // if not, ensure thread is not interrupted.  This\n                // requires a recheck in second case to deal with\n                // shutdownNow race while clearing interrupt\n                if ((runStateAtLeast(ctl.get(), STOP) ||\n                     (Thread.interrupted() &&\n                      runStateAtLeast(ctl.get(), STOP))) &&\n                    !wt.isInterrupted())\n                    wt.interrupt();\n                try {\n                    beforeExecute(wt, task);\n                    Throwable thrown = null;\n                    try {\n                        task.run();\n                    } catch (RuntimeException x) {\n                        thrown = x; throw x;\n                    } catch (Error x) {\n                        thrown = x; throw x;\n                    } catch (Throwable x) {\n                        thrown = x; throw new Error(x);\n                    } finally {\n                        afterExecute(task, thrown);\n                    }\n                } finally {\n                    task = null;\n                    w.completedTasks++;\n                    w.unlock();\n                }\n            }\n            completedAbruptly = false;\n        } finally {\n            processWorkerExit(w, completedAbruptly);\n        }\n    }\n```\n\n### shutdownNow()\n\n`shutdownNow()`会中断所有的`worker`线程， 然后将队列里没有执行的任务全部停止并返回。\n\n```java\n public List<Runnable> shutdownNow() {\n        List<Runnable> tasks;\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            checkShutdownAccess();\n            advanceRunState(STOP);\n            interruptWorkers();\n            tasks = drainQueue();\n        } finally {\n            mainLock.unlock();\n        }\n        tryTerminate();\n        return tasks;\n    }   \n```\n\n中断线程池中的线程\n\n```java\n /**\n     * Interrupts all threads, even if active. Ignores SecurityExceptions\n     * (in which case some threads may remain uninterrupted).\n     */\n    private void interruptWorkers() {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (Worker w : workers)\n                w.interruptIfStarted();\n        } finally {\n            mainLock.unlock();\n        }\n    }\n\n     void interruptIfStarted() {\n            Thread t;\n            if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {\n                try {\n                    t.interrupt();\n                } catch (SecurityException ignore) {\n                }\n            }\n        }\n```\n\n停止任务队列中没有执行的任务\n\n```java\n /**\n     * Drains the task queue into a new list, normally using\n     * drainTo. But if the queue is a DelayQueue or any other kind of\n     * queue for which poll or drainTo may fail to remove some\n     * elements, it deletes them one by one.\n     */\n    private List<Runnable> drainQueue() {\n        BlockingQueue<Runnable> q = workQueue;\n        ArrayList<Runnable> taskList = new ArrayList<Runnable>();\n        q.drainTo(taskList);\n        if (!q.isEmpty()) {\n            for (Runnable r : q.toArray(new Runnable[0])) {\n                if (q.remove(r))\n                    taskList.add(r);\n            }\n        }\n        return taskList;\n    }\n```\n\njava中线程的停止是协作式的，线程要主动检查`interrupted`状态，并做出响应才能正确退出。\n\n### JVM退出\n\n-  非守护线程\n\n如果线程池里的线程是非守护线程， JVM会等待线程的退出，然后才会真正的推出。\n\n- 守护线程（不推荐）\n\nJVM退出的时候不会等待守护线程，因此如果要等待所有的任务执行完后再退出，需要自己代码处理, 可以使用`awaitTermination`方法。\n\n```java\npublic boolean awaitTermination(long timeout, TimeUnit unit)\n        throws InterruptedException {\n        long nanos = unit.toNanos(timeout);\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (;;) {\n                if (runStateAtLeast(ctl.get(), TERMINATED))\n                    return true;\n                if (nanos <= 0)\n                    return false;\n                nanos = termination.awaitNanos(nanos);\n            }\n        } finally {\n            mainLock.unlock();\n        }\n    }\n```\n\n其中`termination`是结束的条件队列\n\n```java\n\n    /**\n     * Lock held on access to workers set and related bookkeeping.\n     * While we could use a concurrent set of some sort, it turns out\n     * to be generally preferable to use a lock. Among the reasons is\n     * that this serializes interruptIdleWorkers, which avoids\n     * unnecessary interrupt storms, especially during shutdown.\n     * Otherwise exiting threads would concurrently interrupt those\n     * that have not yet interrupted. It also simplifies some of the\n     * associated statistics bookkeeping of largestPoolSize etc. We\n     * also hold mainLock on shutdown and shutdownNow, for the sake of\n     * ensuring workers set is stable while separately checking\n     * permission to interrupt and actually interrupting.\n     */\n    private final ReentrantLock mainLock = new ReentrantLock();\n    \n    /**\n     * Wait condition to support awaitTermination\n     */\n    private final Condition termination = mainLock.newCondition();\n```\n\n线程池在退出的时候会唤醒等待在这个队列上的线程。\n\n```java\nfinal void tryTerminate() {\n        for (;;) {\n            int c = ctl.get();\n            if (isRunning(c) ||\n                runStateAtLeast(c, TIDYING) ||\n                (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))\n                return;\n            if (workerCountOf(c) != 0) { // Eligible to terminate\n                interruptIdleWorkers(ONLY_ONE);\n                return;\n            }\n\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {\n                    try {\n                        terminated();\n                    } finally {\n                        ctl.set(ctlOf(TERMINATED, 0));\n                        termination.signalAll(); // 唤醒等待在这个条件上的线程\n                    }\n                    return;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            // else retry on failed CAS\n        }\n    }\n```\n\n\n## 参考\n\n1. [拆轮子：全面剖析 ThreadPoolExecutor（2）-众人拾柴 - 简书](http://cdn2.jianshu.io/p/c079d59ba7c8)","source":"_posts/executor.md","raw":"title: executor总结\ntags: executor\ncategory: java\ntoc: true\ndate: 2017-11-19 04:01:22\n---\n\n\n## shutdown()和shutdownNow()\n\n### shutdown()\n\n`shutdown()`会尝试中断空闲的线程，并把`ThreadPool`的状态置成`SHUTDOWN`,\n这个状态下，不能通过`submit()`或者`execute()`提交任务，但是正在执行的和任务队列中的任务还可以继续执行。\n\n```java\n    public void shutdown() {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            checkShutdownAccess();\n            advanceRunState(SHUTDOWN);\n            interruptIdleWorkers();\n            onShutdown(); // hook for ScheduledThreadPoolExecutor\n        } finally {\n            mainLock.unlock();\n        }\n        tryTerminate();\n    }   \n```\n任务队列中的任务拉取, 通过`getTask()`方法进行。\n\n```java\n  final void runWorker(Worker w) {\n        Thread wt = Thread.currentThread();\n        Runnable task = w.firstTask;\n        w.firstTask = null;\n        w.unlock(); // allow interrupts\n        boolean completedAbruptly = true;\n        try {\n            while (task != null || (task = getTask()) != null) {\n                w.lock();\n                // If pool is stopping, ensure thread is interrupted;\n                // if not, ensure thread is not interrupted.  This\n                // requires a recheck in second case to deal with\n                // shutdownNow race while clearing interrupt\n                if ((runStateAtLeast(ctl.get(), STOP) ||\n                     (Thread.interrupted() &&\n                      runStateAtLeast(ctl.get(), STOP))) &&\n                    !wt.isInterrupted())\n                    wt.interrupt();\n                try {\n                    beforeExecute(wt, task);\n                    Throwable thrown = null;\n                    try {\n                        task.run();\n                    } catch (RuntimeException x) {\n                        thrown = x; throw x;\n                    } catch (Error x) {\n                        thrown = x; throw x;\n                    } catch (Throwable x) {\n                        thrown = x; throw new Error(x);\n                    } finally {\n                        afterExecute(task, thrown);\n                    }\n                } finally {\n                    task = null;\n                    w.completedTasks++;\n                    w.unlock();\n                }\n            }\n            completedAbruptly = false;\n        } finally {\n            processWorkerExit(w, completedAbruptly);\n        }\n    }\n```\n\n### shutdownNow()\n\n`shutdownNow()`会中断所有的`worker`线程， 然后将队列里没有执行的任务全部停止并返回。\n\n```java\n public List<Runnable> shutdownNow() {\n        List<Runnable> tasks;\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            checkShutdownAccess();\n            advanceRunState(STOP);\n            interruptWorkers();\n            tasks = drainQueue();\n        } finally {\n            mainLock.unlock();\n        }\n        tryTerminate();\n        return tasks;\n    }   \n```\n\n中断线程池中的线程\n\n```java\n /**\n     * Interrupts all threads, even if active. Ignores SecurityExceptions\n     * (in which case some threads may remain uninterrupted).\n     */\n    private void interruptWorkers() {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (Worker w : workers)\n                w.interruptIfStarted();\n        } finally {\n            mainLock.unlock();\n        }\n    }\n\n     void interruptIfStarted() {\n            Thread t;\n            if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {\n                try {\n                    t.interrupt();\n                } catch (SecurityException ignore) {\n                }\n            }\n        }\n```\n\n停止任务队列中没有执行的任务\n\n```java\n /**\n     * Drains the task queue into a new list, normally using\n     * drainTo. But if the queue is a DelayQueue or any other kind of\n     * queue for which poll or drainTo may fail to remove some\n     * elements, it deletes them one by one.\n     */\n    private List<Runnable> drainQueue() {\n        BlockingQueue<Runnable> q = workQueue;\n        ArrayList<Runnable> taskList = new ArrayList<Runnable>();\n        q.drainTo(taskList);\n        if (!q.isEmpty()) {\n            for (Runnable r : q.toArray(new Runnable[0])) {\n                if (q.remove(r))\n                    taskList.add(r);\n            }\n        }\n        return taskList;\n    }\n```\n\njava中线程的停止是协作式的，线程要主动检查`interrupted`状态，并做出响应才能正确退出。\n\n### JVM退出\n\n-  非守护线程\n\n如果线程池里的线程是非守护线程， JVM会等待线程的退出，然后才会真正的推出。\n\n- 守护线程（不推荐）\n\nJVM退出的时候不会等待守护线程，因此如果要等待所有的任务执行完后再退出，需要自己代码处理, 可以使用`awaitTermination`方法。\n\n```java\npublic boolean awaitTermination(long timeout, TimeUnit unit)\n        throws InterruptedException {\n        long nanos = unit.toNanos(timeout);\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (;;) {\n                if (runStateAtLeast(ctl.get(), TERMINATED))\n                    return true;\n                if (nanos <= 0)\n                    return false;\n                nanos = termination.awaitNanos(nanos);\n            }\n        } finally {\n            mainLock.unlock();\n        }\n    }\n```\n\n其中`termination`是结束的条件队列\n\n```java\n\n    /**\n     * Lock held on access to workers set and related bookkeeping.\n     * While we could use a concurrent set of some sort, it turns out\n     * to be generally preferable to use a lock. Among the reasons is\n     * that this serializes interruptIdleWorkers, which avoids\n     * unnecessary interrupt storms, especially during shutdown.\n     * Otherwise exiting threads would concurrently interrupt those\n     * that have not yet interrupted. It also simplifies some of the\n     * associated statistics bookkeeping of largestPoolSize etc. We\n     * also hold mainLock on shutdown and shutdownNow, for the sake of\n     * ensuring workers set is stable while separately checking\n     * permission to interrupt and actually interrupting.\n     */\n    private final ReentrantLock mainLock = new ReentrantLock();\n    \n    /**\n     * Wait condition to support awaitTermination\n     */\n    private final Condition termination = mainLock.newCondition();\n```\n\n线程池在退出的时候会唤醒等待在这个队列上的线程。\n\n```java\nfinal void tryTerminate() {\n        for (;;) {\n            int c = ctl.get();\n            if (isRunning(c) ||\n                runStateAtLeast(c, TIDYING) ||\n                (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))\n                return;\n            if (workerCountOf(c) != 0) { // Eligible to terminate\n                interruptIdleWorkers(ONLY_ONE);\n                return;\n            }\n\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {\n                    try {\n                        terminated();\n                    } finally {\n                        ctl.set(ctlOf(TERMINATED, 0));\n                        termination.signalAll(); // 唤醒等待在这个条件上的线程\n                    }\n                    return;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            // else retry on failed CAS\n        }\n    }\n```\n\n\n## 参考\n\n1. [拆轮子：全面剖析 ThreadPoolExecutor（2）-众人拾柴 - 简书](http://cdn2.jianshu.io/p/c079d59ba7c8)","slug":"executor","published":1,"updated":"2017-11-18T20:01:22.412Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd8z005cjh4khyn8021a","content":"<h2 id=\"shutdown-和shutdownNow\"><a href=\"#shutdown-和shutdownNow\" class=\"headerlink\" title=\"shutdown()和shutdownNow()\"></a>shutdown()和shutdownNow()</h2><h3 id=\"shutdown\"><a href=\"#shutdown\" class=\"headerlink\" title=\"shutdown()\"></a>shutdown()</h3><p><code>shutdown()</code>会尝试中断空闲的线程，并把<code>ThreadPool</code>的状态置成<code>SHUTDOWN</code>,<br>这个状态下，不能通过<code>submit()</code>或者<code>execute()</code>提交任务，但是正在执行的和任务队列中的任务还可以继续执行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">    mainLock.lock();</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        checkShutdownAccess();</span><br><span class=\"line\">        advanceRunState(SHUTDOWN);</span><br><span class=\"line\">        interruptIdleWorkers();</span><br><span class=\"line\">        onShutdown(); <span class=\"comment\">// hook for ScheduledThreadPoolExecutor</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        mainLock.unlock();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    tryTerminate();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>任务队列中的任务拉取, 通过<code>getTask()</code>方法进行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">runWorker</span><span class=\"params\">(Worker w)</span> </span>&#123;</span><br><span class=\"line\">      Thread wt = Thread.currentThread();</span><br><span class=\"line\">      Runnable task = w.firstTask;</span><br><span class=\"line\">      w.firstTask = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      w.unlock(); <span class=\"comment\">// allow interrupts</span></span><br><span class=\"line\">      <span class=\"keyword\">boolean</span> completedAbruptly = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">while</span> (task != <span class=\"keyword\">null</span> || (task = getTask()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              w.lock();</span><br><span class=\"line\">              <span class=\"comment\">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class=\"line\">              <span class=\"comment\">// if not, ensure thread is not interrupted.  This</span></span><br><span class=\"line\">              <span class=\"comment\">// requires a recheck in second case to deal with</span></span><br><span class=\"line\">              <span class=\"comment\">// shutdownNow race while clearing interrupt</span></span><br><span class=\"line\">              <span class=\"keyword\">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class=\"line\">                   (Thread.interrupted() &amp;&amp;</span><br><span class=\"line\">                    runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class=\"line\">                  !wt.isInterrupted())</span><br><span class=\"line\">                  wt.interrupt();</span><br><span class=\"line\">              <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                  beforeExecute(wt, task);</span><br><span class=\"line\">                  Throwable thrown = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                      task.run();</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (RuntimeException x) &#123;</span><br><span class=\"line\">                      thrown = x; <span class=\"keyword\">throw</span> x;</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (Error x) &#123;</span><br><span class=\"line\">                      thrown = x; <span class=\"keyword\">throw</span> x;</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (Throwable x) &#123;</span><br><span class=\"line\">                      thrown = x; <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Error(x);</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                      afterExecute(task, thrown);</span><br><span class=\"line\">                  &#125;</span><br><span class=\"line\">              &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                  task = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                  w.completedTasks++;</span><br><span class=\"line\">                  w.unlock();</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          completedAbruptly = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">          processWorkerExit(w, completedAbruptly);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"shutdownNow\"><a href=\"#shutdownNow\" class=\"headerlink\" title=\"shutdownNow()\"></a>shutdownNow()</h3><p><code>shutdownNow()</code>会中断所有的<code>worker</code>线程， 然后将队列里没有执行的任务全部停止并返回。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List&lt;Runnable&gt; <span class=\"title\">shutdownNow</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       List&lt;Runnable&gt; tasks;</span><br><span class=\"line\">       <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           checkShutdownAccess();</span><br><span class=\"line\">           advanceRunState(STOP);</span><br><span class=\"line\">           interruptWorkers();</span><br><span class=\"line\">           tasks = drainQueue();</span><br><span class=\"line\">       &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       tryTerminate();</span><br><span class=\"line\">       <span class=\"keyword\">return</span> tasks;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>中断线程池中的线程</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Interrupts all threads, even if active. Ignores SecurityExceptions</span></span><br><span class=\"line\"><span class=\"comment\">    * (in which case some threads may remain uninterrupted).</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">interruptWorkers</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           <span class=\"keyword\">for</span> (Worker w : workers)</span><br><span class=\"line\">               w.interruptIfStarted();</span><br><span class=\"line\">       &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">interruptIfStarted</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">           Thread t;</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (getState() &gt;= <span class=\"number\">0</span> &amp;&amp; (t = thread) != <span class=\"keyword\">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class=\"line\">               <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                   t.interrupt();</span><br><span class=\"line\">               &#125; <span class=\"keyword\">catch</span> (SecurityException ignore) &#123;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br></pre></td></tr></table></figure>\n<p>停止任务队列中没有执行的任务</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Drains the task queue into a new list, normally using</span></span><br><span class=\"line\"><span class=\"comment\">    * drainTo. But if the queue is a DelayQueue or any other kind of</span></span><br><span class=\"line\"><span class=\"comment\">    * queue for which poll or drainTo may fail to remove some</span></span><br><span class=\"line\"><span class=\"comment\">    * elements, it deletes them one by one.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">private</span> List&lt;Runnable&gt; <span class=\"title\">drainQueue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class=\"line\">       ArrayList&lt;Runnable&gt; taskList = <span class=\"keyword\">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class=\"line\">       q.drainTo(taskList);</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (!q.isEmpty()) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">for</span> (Runnable r : q.toArray(<span class=\"keyword\">new</span> Runnable[<span class=\"number\">0</span>])) &#123;</span><br><span class=\"line\">               <span class=\"keyword\">if</span> (q.remove(r))</span><br><span class=\"line\">                   taskList.add(r);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> taskList;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>java中线程的停止是协作式的，线程要主动检查<code>interrupted</code>状态，并做出响应才能正确退出。</p>\n<h3 id=\"JVM退出\"><a href=\"#JVM退出\" class=\"headerlink\" title=\"JVM退出\"></a>JVM退出</h3><ul>\n<li>非守护线程</li>\n</ul>\n<p>如果线程池里的线程是非守护线程， JVM会等待线程的退出，然后才会真正的推出。</p>\n<ul>\n<li>守护线程（不推荐）</li>\n</ul>\n<p>JVM退出的时候不会等待守护线程，因此如果要等待所有的任务执行完后再退出，需要自己代码处理, 可以使用<code>awaitTermination</code>方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">awaitTermination</span><span class=\"params\">(<span class=\"keyword\">long</span> timeout, TimeUnit unit)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">long</span> nanos = unit.toNanos(timeout);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">        mainLock.lock();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (nanos &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                nanos = termination.awaitNanos(nanos);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            mainLock.unlock();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>termination</code>是结束的条件队列</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Lock held on access to workers set and related bookkeeping.</span></span><br><span class=\"line\"><span class=\"comment\"> * While we could use a concurrent set of some sort, it turns out</span></span><br><span class=\"line\"><span class=\"comment\"> * to be generally preferable to use a lock. Among the reasons is</span></span><br><span class=\"line\"><span class=\"comment\"> * that this serializes interruptIdleWorkers, which avoids</span></span><br><span class=\"line\"><span class=\"comment\"> * unnecessary interrupt storms, especially during shutdown.</span></span><br><span class=\"line\"><span class=\"comment\"> * Otherwise exiting threads would concurrently interrupt those</span></span><br><span class=\"line\"><span class=\"comment\"> * that have not yet interrupted. It also simplifies some of the</span></span><br><span class=\"line\"><span class=\"comment\"> * associated statistics bookkeeping of largestPoolSize etc. We</span></span><br><span class=\"line\"><span class=\"comment\"> * also hold mainLock on shutdown and shutdownNow, for the sake of</span></span><br><span class=\"line\"><span class=\"comment\"> * ensuring workers set is stable while separately checking</span></span><br><span class=\"line\"><span class=\"comment\"> * permission to interrupt and actually interrupting.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">new</span> ReentrantLock();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Wait condition to support awaitTermination</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Condition termination = mainLock.newCondition();</span><br></pre></td></tr></table></figure>\n<p>线程池在退出的时候会唤醒等待在这个队列上的线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">tryTerminate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> c = ctl.get();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isRunning(c) ||</span><br><span class=\"line\">                runStateAtLeast(c, TIDYING) ||</span><br><span class=\"line\">                (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (workerCountOf(c) != <span class=\"number\">0</span>) &#123; <span class=\"comment\">// Eligible to terminate</span></span><br><span class=\"line\">                interruptIdleWorkers(ONLY_ONE);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">            mainLock.lock();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class=\"number\">0</span>))) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        terminated();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                        ctl.set(ctlOf(TERMINATED, <span class=\"number\">0</span>));</span><br><span class=\"line\">                        termination.signalAll(); <span class=\"comment\">// 唤醒等待在这个条件上的线程</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                mainLock.unlock();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// else retry on failed CAS</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://cdn2.jianshu.io/p/c079d59ba7c8\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">拆轮子：全面剖析 ThreadPoolExecutor（2）-众人拾柴 - 简书</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"shutdown-和shutdownNow\"><a href=\"#shutdown-和shutdownNow\" class=\"headerlink\" title=\"shutdown()和shutdownNow()\"></a>shutdown()和shutdownNow()</h2><h3 id=\"shutdown\"><a href=\"#shutdown\" class=\"headerlink\" title=\"shutdown()\"></a>shutdown()</h3><p><code>shutdown()</code>会尝试中断空闲的线程，并把<code>ThreadPool</code>的状态置成<code>SHUTDOWN</code>,<br>这个状态下，不能通过<code>submit()</code>或者<code>execute()</code>提交任务，但是正在执行的和任务队列中的任务还可以继续执行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">    mainLock.lock();</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        checkShutdownAccess();</span><br><span class=\"line\">        advanceRunState(SHUTDOWN);</span><br><span class=\"line\">        interruptIdleWorkers();</span><br><span class=\"line\">        onShutdown(); <span class=\"comment\">// hook for ScheduledThreadPoolExecutor</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        mainLock.unlock();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    tryTerminate();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>任务队列中的任务拉取, 通过<code>getTask()</code>方法进行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">runWorker</span><span class=\"params\">(Worker w)</span> </span>&#123;</span><br><span class=\"line\">      Thread wt = Thread.currentThread();</span><br><span class=\"line\">      Runnable task = w.firstTask;</span><br><span class=\"line\">      w.firstTask = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      w.unlock(); <span class=\"comment\">// allow interrupts</span></span><br><span class=\"line\">      <span class=\"keyword\">boolean</span> completedAbruptly = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">while</span> (task != <span class=\"keyword\">null</span> || (task = getTask()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              w.lock();</span><br><span class=\"line\">              <span class=\"comment\">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class=\"line\">              <span class=\"comment\">// if not, ensure thread is not interrupted.  This</span></span><br><span class=\"line\">              <span class=\"comment\">// requires a recheck in second case to deal with</span></span><br><span class=\"line\">              <span class=\"comment\">// shutdownNow race while clearing interrupt</span></span><br><span class=\"line\">              <span class=\"keyword\">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class=\"line\">                   (Thread.interrupted() &amp;&amp;</span><br><span class=\"line\">                    runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class=\"line\">                  !wt.isInterrupted())</span><br><span class=\"line\">                  wt.interrupt();</span><br><span class=\"line\">              <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                  beforeExecute(wt, task);</span><br><span class=\"line\">                  Throwable thrown = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                      task.run();</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (RuntimeException x) &#123;</span><br><span class=\"line\">                      thrown = x; <span class=\"keyword\">throw</span> x;</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (Error x) &#123;</span><br><span class=\"line\">                      thrown = x; <span class=\"keyword\">throw</span> x;</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (Throwable x) &#123;</span><br><span class=\"line\">                      thrown = x; <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Error(x);</span><br><span class=\"line\">                  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                      afterExecute(task, thrown);</span><br><span class=\"line\">                  &#125;</span><br><span class=\"line\">              &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                  task = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                  w.completedTasks++;</span><br><span class=\"line\">                  w.unlock();</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          completedAbruptly = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">          processWorkerExit(w, completedAbruptly);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"shutdownNow\"><a href=\"#shutdownNow\" class=\"headerlink\" title=\"shutdownNow()\"></a>shutdownNow()</h3><p><code>shutdownNow()</code>会中断所有的<code>worker</code>线程， 然后将队列里没有执行的任务全部停止并返回。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List&lt;Runnable&gt; <span class=\"title\">shutdownNow</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       List&lt;Runnable&gt; tasks;</span><br><span class=\"line\">       <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           checkShutdownAccess();</span><br><span class=\"line\">           advanceRunState(STOP);</span><br><span class=\"line\">           interruptWorkers();</span><br><span class=\"line\">           tasks = drainQueue();</span><br><span class=\"line\">       &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       tryTerminate();</span><br><span class=\"line\">       <span class=\"keyword\">return</span> tasks;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>中断线程池中的线程</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Interrupts all threads, even if active. Ignores SecurityExceptions</span></span><br><span class=\"line\"><span class=\"comment\">    * (in which case some threads may remain uninterrupted).</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">interruptWorkers</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">       mainLock.lock();</span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           <span class=\"keyword\">for</span> (Worker w : workers)</span><br><span class=\"line\">               w.interruptIfStarted();</span><br><span class=\"line\">       &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">           mainLock.unlock();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">interruptIfStarted</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">           Thread t;</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (getState() &gt;= <span class=\"number\">0</span> &amp;&amp; (t = thread) != <span class=\"keyword\">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class=\"line\">               <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                   t.interrupt();</span><br><span class=\"line\">               &#125; <span class=\"keyword\">catch</span> (SecurityException ignore) &#123;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br></pre></td></tr></table></figure>\n<p>停止任务队列中没有执行的任务</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Drains the task queue into a new list, normally using</span></span><br><span class=\"line\"><span class=\"comment\">    * drainTo. But if the queue is a DelayQueue or any other kind of</span></span><br><span class=\"line\"><span class=\"comment\">    * queue for which poll or drainTo may fail to remove some</span></span><br><span class=\"line\"><span class=\"comment\">    * elements, it deletes them one by one.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">private</span> List&lt;Runnable&gt; <span class=\"title\">drainQueue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       BlockingQueue&lt;Runnable&gt; q = workQueue;</span><br><span class=\"line\">       ArrayList&lt;Runnable&gt; taskList = <span class=\"keyword\">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class=\"line\">       q.drainTo(taskList);</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (!q.isEmpty()) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">for</span> (Runnable r : q.toArray(<span class=\"keyword\">new</span> Runnable[<span class=\"number\">0</span>])) &#123;</span><br><span class=\"line\">               <span class=\"keyword\">if</span> (q.remove(r))</span><br><span class=\"line\">                   taskList.add(r);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> taskList;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>java中线程的停止是协作式的，线程要主动检查<code>interrupted</code>状态，并做出响应才能正确退出。</p>\n<h3 id=\"JVM退出\"><a href=\"#JVM退出\" class=\"headerlink\" title=\"JVM退出\"></a>JVM退出</h3><ul>\n<li>非守护线程</li>\n</ul>\n<p>如果线程池里的线程是非守护线程， JVM会等待线程的退出，然后才会真正的推出。</p>\n<ul>\n<li>守护线程（不推荐）</li>\n</ul>\n<p>JVM退出的时候不会等待守护线程，因此如果要等待所有的任务执行完后再退出，需要自己代码处理, 可以使用<code>awaitTermination</code>方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">awaitTermination</span><span class=\"params\">(<span class=\"keyword\">long</span> timeout, TimeUnit unit)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">long</span> nanos = unit.toNanos(timeout);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">        mainLock.lock();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (runStateAtLeast(ctl.get(), TERMINATED))</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (nanos &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                nanos = termination.awaitNanos(nanos);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            mainLock.unlock();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>termination</code>是结束的条件队列</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Lock held on access to workers set and related bookkeeping.</span></span><br><span class=\"line\"><span class=\"comment\"> * While we could use a concurrent set of some sort, it turns out</span></span><br><span class=\"line\"><span class=\"comment\"> * to be generally preferable to use a lock. Among the reasons is</span></span><br><span class=\"line\"><span class=\"comment\"> * that this serializes interruptIdleWorkers, which avoids</span></span><br><span class=\"line\"><span class=\"comment\"> * unnecessary interrupt storms, especially during shutdown.</span></span><br><span class=\"line\"><span class=\"comment\"> * Otherwise exiting threads would concurrently interrupt those</span></span><br><span class=\"line\"><span class=\"comment\"> * that have not yet interrupted. It also simplifies some of the</span></span><br><span class=\"line\"><span class=\"comment\"> * associated statistics bookkeeping of largestPoolSize etc. We</span></span><br><span class=\"line\"><span class=\"comment\"> * also hold mainLock on shutdown and shutdownNow, for the sake of</span></span><br><span class=\"line\"><span class=\"comment\"> * ensuring workers set is stable while separately checking</span></span><br><span class=\"line\"><span class=\"comment\"> * permission to interrupt and actually interrupting.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">new</span> ReentrantLock();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Wait condition to support awaitTermination</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Condition termination = mainLock.newCondition();</span><br></pre></td></tr></table></figure>\n<p>线程池在退出的时候会唤醒等待在这个队列上的线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">tryTerminate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> c = ctl.get();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isRunning(c) ||</span><br><span class=\"line\">                runStateAtLeast(c, TIDYING) ||</span><br><span class=\"line\">                (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (workerCountOf(c) != <span class=\"number\">0</span>) &#123; <span class=\"comment\">// Eligible to terminate</span></span><br><span class=\"line\">                interruptIdleWorkers(ONLY_ONE);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">final</span> ReentrantLock mainLock = <span class=\"keyword\">this</span>.mainLock;</span><br><span class=\"line\">            mainLock.lock();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class=\"number\">0</span>))) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        terminated();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                        ctl.set(ctlOf(TERMINATED, <span class=\"number\">0</span>));</span><br><span class=\"line\">                        termination.signalAll(); <span class=\"comment\">// 唤醒等待在这个条件上的线程</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                mainLock.unlock();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// else retry on failed CAS</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://cdn2.jianshu.io/p/c079d59ba7c8\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">拆轮子：全面剖析 ThreadPoolExecutor（2）-众人拾柴 - 简书</a></li>\n</ol>\n"},{"title":"git查看已合并分支的fork点","toc":true,"date":"2017-09-11T16:25:40.000Z","_content":"\n\n## 一个问题\n\n有些需求有好几期，做后面几期的可能完全不了解前几期做了什么，拿到分支号后，就需要找到最初的commit点。由于这个分支已经merge到了master上，所以找最近的ancestor就不对了。\n\n```bash\ngit merge-base branch1 branch2 //只能找到最近的祖先\n```\n\n那么如何找到这个分支最初的fork点呢，下面给出两种方案，亲测有效。\n\n## 解决方案\n\n### git 别名\n\n```bash\ngit config --global alias.oldest-ancestor '!zsh -c '\\''diff -u <(git rev-list --first-parent \"${1:-master}\") <(git rev-list --first-parent \"${2:-HEAD}\") | sed -ne \"s/^ //p\" | head -1'\\'' -'\ngit config --global alias.branchdiff '!sh -c \"git diff `git oldest-ancestor`..\"'\ngit config --global alias.branchlog '!sh -c \"git log `git oldest-ancestor`..\"'\n```\n\n上述三个命令就可以找到最初的commit点，以及这个分支做了什么。参见`stackoverflow`上的回答:  [Finding a branch point with Git? - Stack Overflow](https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git)\n\n### git分支图\n\n如果你使用`zsh`, 内置的有两个相关的命令`glgg`,`glgga`.\n\n- `glgg`： 显示当前分支的分支图\n\n```bash\n➜  ~  alias glgg\nglgg='git log --graph'\n```\n\n{% asset_img glgg.png %}\n\n- `glgga`: 显示所有分支的分支图 \n\n```bash\n➜  ~  alias glgga\nglgga='git log --graph --decorate --all'\n```\n{% asset_img glgga.png %}\n\n从分支图中可以快速的看出当前分支是在哪里fork出来的\n\n#### 分支图的显示方式\n\n- reverse chronological： 默认显示方式，会按照commit的时间，逆序显示\n\n- topo order： 按照commit的拓扑顺序显示，子提交在父提交之前显示\n\n查看fork点的时候，最好是按照拓扑排序显示，这样分支图不会很乱，便于找到。\n\n\n### 可视化工具\n\n可视化工具和git log的用法是一样的，顺着查找即可。这里我用`idea`为例：\n\n{% asset_img idea.png %}\n\n开启InteliSort后，注意红框勾上。\n\n{% asset_img idea-sorted.png %}\n\n开启后是按照提交排序的，并没有按照插入的时间，这样可以清楚的顺着提交找到最初的fork点。\n\n## 参考\n\n1. [Finding a branch point with Git? - Stack Overflow](https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git)\n\n2. [git图示所有分支的历史 - ChuckLu - 博客园](http://www.cnblogs.com/chucklu/p/4748394.html)\n\n3. [Git Book 中文版 - 查看历史 －Git日志](http://gitbook.liuhui998.com/3_4.html)\n","source":"_posts/git-branch-log.md","raw":"title: git查看已合并分支的fork点\ntags:\n  - git\n  - idea\ncategory: git\ntoc: true\ndate: 2017-09-12 00:25:40\n---\n\n\n## 一个问题\n\n有些需求有好几期，做后面几期的可能完全不了解前几期做了什么，拿到分支号后，就需要找到最初的commit点。由于这个分支已经merge到了master上，所以找最近的ancestor就不对了。\n\n```bash\ngit merge-base branch1 branch2 //只能找到最近的祖先\n```\n\n那么如何找到这个分支最初的fork点呢，下面给出两种方案，亲测有效。\n\n## 解决方案\n\n### git 别名\n\n```bash\ngit config --global alias.oldest-ancestor '!zsh -c '\\''diff -u <(git rev-list --first-parent \"${1:-master}\") <(git rev-list --first-parent \"${2:-HEAD}\") | sed -ne \"s/^ //p\" | head -1'\\'' -'\ngit config --global alias.branchdiff '!sh -c \"git diff `git oldest-ancestor`..\"'\ngit config --global alias.branchlog '!sh -c \"git log `git oldest-ancestor`..\"'\n```\n\n上述三个命令就可以找到最初的commit点，以及这个分支做了什么。参见`stackoverflow`上的回答:  [Finding a branch point with Git? - Stack Overflow](https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git)\n\n### git分支图\n\n如果你使用`zsh`, 内置的有两个相关的命令`glgg`,`glgga`.\n\n- `glgg`： 显示当前分支的分支图\n\n```bash\n➜  ~  alias glgg\nglgg='git log --graph'\n```\n\n{% asset_img glgg.png %}\n\n- `glgga`: 显示所有分支的分支图 \n\n```bash\n➜  ~  alias glgga\nglgga='git log --graph --decorate --all'\n```\n{% asset_img glgga.png %}\n\n从分支图中可以快速的看出当前分支是在哪里fork出来的\n\n#### 分支图的显示方式\n\n- reverse chronological： 默认显示方式，会按照commit的时间，逆序显示\n\n- topo order： 按照commit的拓扑顺序显示，子提交在父提交之前显示\n\n查看fork点的时候，最好是按照拓扑排序显示，这样分支图不会很乱，便于找到。\n\n\n### 可视化工具\n\n可视化工具和git log的用法是一样的，顺着查找即可。这里我用`idea`为例：\n\n{% asset_img idea.png %}\n\n开启InteliSort后，注意红框勾上。\n\n{% asset_img idea-sorted.png %}\n\n开启后是按照提交排序的，并没有按照插入的时间，这样可以清楚的顺着提交找到最初的fork点。\n\n## 参考\n\n1. [Finding a branch point with Git? - Stack Overflow](https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git)\n\n2. [git图示所有分支的历史 - ChuckLu - 博客园](http://www.cnblogs.com/chucklu/p/4748394.html)\n\n3. [Git Book 中文版 - 查看历史 －Git日志](http://gitbook.liuhui998.com/3_4.html)\n","slug":"git-branch-log","published":1,"updated":"2017-09-11T16:25:40.548Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd90005gjh4kdu5mxkht","content":"<h2 id=\"一个问题\"><a href=\"#一个问题\" class=\"headerlink\" title=\"一个问题\"></a>一个问题</h2><p>有些需求有好几期，做后面几期的可能完全不了解前几期做了什么，拿到分支号后，就需要找到最初的commit点。由于这个分支已经merge到了master上，所以找最近的ancestor就不对了。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git merge-base branch1 branch2 //只能找到最近的祖先</span><br></pre></td></tr></table></figure>\n<p>那么如何找到这个分支最初的fork点呢，下面给出两种方案，亲测有效。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><h3 id=\"git-别名\"><a href=\"#git-别名\" class=\"headerlink\" title=\"git 别名\"></a>git 别名</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global alias.oldest-ancestor <span class=\"string\">'!zsh -c '</span>\\<span class=\"string\">''</span>diff -u &lt;(git rev-list --first-parent <span class=\"string\">\"<span class=\"variable\">$&#123;1:-master&#125;</span>\"</span>) &lt;(git rev-list --first-parent <span class=\"string\">\"<span class=\"variable\">$&#123;2:-HEAD&#125;</span>\"</span>) | sed -ne <span class=\"string\">\"s/^ //p\"</span> | head -1<span class=\"string\">'\\'</span><span class=\"string\">' -'</span></span><br><span class=\"line\">git config --global alias.branchdiff <span class=\"string\">'!sh -c \"git diff `git oldest-ancestor`..\"'</span></span><br><span class=\"line\">git config --global alias.branchlog <span class=\"string\">'!sh -c \"git log `git oldest-ancestor`..\"'</span></span><br></pre></td></tr></table></figure>\n<p>上述三个命令就可以找到最初的commit点，以及这个分支做了什么。参见<code>stackoverflow</code>上的回答:  <a href=\"https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Finding a branch point with Git? - Stack Overflow</a></p>\n<h3 id=\"git分支图\"><a href=\"#git分支图\" class=\"headerlink\" title=\"git分支图\"></a>git分支图</h3><p>如果你使用<code>zsh</code>, 内置的有两个相关的命令<code>glgg</code>,<code>glgga</code>.</p>\n<ul>\n<li><code>glgg</code>： 显示当前分支的分支图</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  <span class=\"built_in\">alias</span> glgg</span><br><span class=\"line\">glgg=<span class=\"string\">'git log --graph'</span></span><br></pre></td></tr></table></figure>\n<img src=\"/2017/09/12/git-branch-log/glgg.png\">\n<ul>\n<li><code>glgga</code>: 显示所有分支的分支图 </li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  <span class=\"built_in\">alias</span> glgga</span><br><span class=\"line\">glgga=<span class=\"string\">'git log --graph --decorate --all'</span></span><br></pre></td></tr></table></figure>\n<img src=\"/2017/09/12/git-branch-log/glgga.png\">\n<p>从分支图中可以快速的看出当前分支是在哪里fork出来的</p>\n<h4 id=\"分支图的显示方式\"><a href=\"#分支图的显示方式\" class=\"headerlink\" title=\"分支图的显示方式\"></a>分支图的显示方式</h4><ul>\n<li><p>reverse chronological： 默认显示方式，会按照commit的时间，逆序显示</p>\n</li>\n<li><p>topo order： 按照commit的拓扑顺序显示，子提交在父提交之前显示</p>\n</li>\n</ul>\n<p>查看fork点的时候，最好是按照拓扑排序显示，这样分支图不会很乱，便于找到。</p>\n<h3 id=\"可视化工具\"><a href=\"#可视化工具\" class=\"headerlink\" title=\"可视化工具\"></a>可视化工具</h3><p>可视化工具和git log的用法是一样的，顺着查找即可。这里我用<code>idea</code>为例：</p>\n<img src=\"/2017/09/12/git-branch-log/idea.png\">\n<p>开启InteliSort后，注意红框勾上。</p>\n<img src=\"/2017/09/12/git-branch-log/idea-sorted.png\">\n<p>开启后是按照提交排序的，并没有按照插入的时间，这样可以清楚的顺着提交找到最初的fork点。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Finding a branch point with Git? - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://www.cnblogs.com/chucklu/p/4748394.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">git图示所有分支的历史 - ChuckLu - 博客园</a></p>\n</li>\n<li><p><a href=\"http://gitbook.liuhui998.com/3_4.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Git Book 中文版 - 查看历史 －Git日志</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一个问题\"><a href=\"#一个问题\" class=\"headerlink\" title=\"一个问题\"></a>一个问题</h2><p>有些需求有好几期，做后面几期的可能完全不了解前几期做了什么，拿到分支号后，就需要找到最初的commit点。由于这个分支已经merge到了master上，所以找最近的ancestor就不对了。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git merge-base branch1 branch2 //只能找到最近的祖先</span><br></pre></td></tr></table></figure>\n<p>那么如何找到这个分支最初的fork点呢，下面给出两种方案，亲测有效。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><h3 id=\"git-别名\"><a href=\"#git-别名\" class=\"headerlink\" title=\"git 别名\"></a>git 别名</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global alias.oldest-ancestor <span class=\"string\">'!zsh -c '</span>\\<span class=\"string\">''</span>diff -u &lt;(git rev-list --first-parent <span class=\"string\">\"<span class=\"variable\">$&#123;1:-master&#125;</span>\"</span>) &lt;(git rev-list --first-parent <span class=\"string\">\"<span class=\"variable\">$&#123;2:-HEAD&#125;</span>\"</span>) | sed -ne <span class=\"string\">\"s/^ //p\"</span> | head -1<span class=\"string\">'\\'</span><span class=\"string\">' -'</span></span><br><span class=\"line\">git config --global alias.branchdiff <span class=\"string\">'!sh -c \"git diff `git oldest-ancestor`..\"'</span></span><br><span class=\"line\">git config --global alias.branchlog <span class=\"string\">'!sh -c \"git log `git oldest-ancestor`..\"'</span></span><br></pre></td></tr></table></figure>\n<p>上述三个命令就可以找到最初的commit点，以及这个分支做了什么。参见<code>stackoverflow</code>上的回答:  <a href=\"https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Finding a branch point with Git? - Stack Overflow</a></p>\n<h3 id=\"git分支图\"><a href=\"#git分支图\" class=\"headerlink\" title=\"git分支图\"></a>git分支图</h3><p>如果你使用<code>zsh</code>, 内置的有两个相关的命令<code>glgg</code>,<code>glgga</code>.</p>\n<ul>\n<li><code>glgg</code>： 显示当前分支的分支图</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  <span class=\"built_in\">alias</span> glgg</span><br><span class=\"line\">glgg=<span class=\"string\">'git log --graph'</span></span><br></pre></td></tr></table></figure>\n<img src=\"/2017/09/12/git-branch-log/glgg.png\">\n<ul>\n<li><code>glgga</code>: 显示所有分支的分支图 </li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~  <span class=\"built_in\">alias</span> glgga</span><br><span class=\"line\">glgga=<span class=\"string\">'git log --graph --decorate --all'</span></span><br></pre></td></tr></table></figure>\n<img src=\"/2017/09/12/git-branch-log/glgga.png\">\n<p>从分支图中可以快速的看出当前分支是在哪里fork出来的</p>\n<h4 id=\"分支图的显示方式\"><a href=\"#分支图的显示方式\" class=\"headerlink\" title=\"分支图的显示方式\"></a>分支图的显示方式</h4><ul>\n<li><p>reverse chronological： 默认显示方式，会按照commit的时间，逆序显示</p>\n</li>\n<li><p>topo order： 按照commit的拓扑顺序显示，子提交在父提交之前显示</p>\n</li>\n</ul>\n<p>查看fork点的时候，最好是按照拓扑排序显示，这样分支图不会很乱，便于找到。</p>\n<h3 id=\"可视化工具\"><a href=\"#可视化工具\" class=\"headerlink\" title=\"可视化工具\"></a>可视化工具</h3><p>可视化工具和git log的用法是一样的，顺着查找即可。这里我用<code>idea</code>为例：</p>\n<img src=\"/2017/09/12/git-branch-log/idea.png\">\n<p>开启InteliSort后，注意红框勾上。</p>\n<img src=\"/2017/09/12/git-branch-log/idea-sorted.png\">\n<p>开启后是按照提交排序的，并没有按照插入的时间，这样可以清楚的顺着提交找到最初的fork点。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://stackoverflow.com/questions/1527234/finding-a-branch-point-with-git\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Finding a branch point with Git? - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://www.cnblogs.com/chucklu/p/4748394.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">git图示所有分支的历史 - ChuckLu - 博客园</a></p>\n</li>\n<li><p><a href=\"http://gitbook.liuhui998.com/3_4.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Git Book 中文版 - 查看历史 －Git日志</a></p>\n</li>\n</ol>\n"},{"title":"dubbo泛化调用原理","toc":true,"date":"2018-05-02T12:50:44.000Z","_content":"\n\n## 介绍\n\n>泛接口调用方式主要用于客户端没有API接口及模型类元的情况，参数及返回值中的所有POJO均用Map表示，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过GenericService调用所有服务实现。\n\n截图为qunar的dubbo服务测试框架, 只需将参数按照指定的格式填入, 就可以直接调用相应的dubbo接口.\n\n{%  asset_img   generic.png  通过泛化调用手工发起dubbo请求 %}\n\n\n## 使用\n\n泛化调用需要接口声明为泛化, 可以在声明接口的时候指定,\n\n```xml\n<dubbo:reference id=\"barService\" interface=\"com.foo.BarService\" generic=\"true\" />\n```\n\n也可以在代码中进行设置:\n\n```java\n            ReferenceConfig<GenericService> reference = new ReferenceConfig<GenericService>();\n            reference.setApplication(new ApplicationConfig(\"generic-consumer\"));\n            reference.setInterface(DemoService.class);\n            reference.setUrl(\"dubbo://127.0.0.1:29581?scope=remote\");\n            // 声明为泛化\n            reference.setGeneric(true);\n            GenericService genericService = reference.get();\n```\n\n然后就可以使用泛化调用的方式去调用接口了\n\n```java\n                List<Map<String, Object>> users = new ArrayList<Map<String, Object>>();\n                Map<String, Object> user = new HashMap<String, Object>();\n                user.put(\"class\", \"com.alibaba.dubbo.config.api.User\");\n                user.put(\"name\", \"actual.provider\");\n                users.add(user);\n                // 泛化调用\n                users = (List<Map<String, Object>>) genericService.$invoke(\"getUsers\", new String[] {List.class.getName()}, new Object[] {users});\n                Assert.assertEquals(1, users.size());\n                Assert.assertEquals(\"actual.provider\", users.get(0).get(\"name\"));\n```\n\n\n## 实现\n\n泛化调用是通过dubbo的filter机制实现的, 大概流程如下:\n\n```\n+-------------------------------------------+               +-------------------------------------------+\n|  consumer 端                               |               | provider 端                                |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                    +------------------+   |               |       +--------------+                    |\n|                    |GenericImplFilter |   |  Invocation   |       |GenericFilter |                    |\n|             +----> |                  +-------------------------> |              |                    |\n|             |      +------------------+   |               |       +--------------+                    |\n| +-----------+                             |               |                      |    +-----------+   |\n| |           |                             |               |                      |    |           |   |\n| |Client     |                             |               |                      +--> | Service   |   |\n| |           |                             |               |                           |           |   |\n| +-----------+                             |               |                           +-------+---+   |\n|                                           |               |                                   |       |\n|      ^             +------------------+   |               |       +--------------+            |       |\n|      |             |GenericImplFilter |   |               |       |GenericFilter | <----------+       |\n|      +-------------+                  | <-------------------------+              |                    |\n|                    +------------------+   |               |       +--------------+                    |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n+-------------------------------------------+               +-------------------------------------------+\n```\n\n\n###  GenericService\n\n`GenericService`这个接口和java的反射调用非常像, 只需提供调用的方法名称,  参数的类型以及参数的值就可以直接调用对应方法了.\n\n接口的实现如下:\n\n```java\npackage com.alibaba.dubbo.rpc.service;\n\n/**\n * 通用服务接口\n * \n * @author william.liangf\n * @export\n */\npublic interface GenericService {\n\n    /**\n     * 泛化调用\n     * \n     * @param method 方法名，如：findPerson，如果有重载方法，需带上参数列表，如：findPerson(java.lang.String)\n     * @param parameterTypes 参数类型\n     * @param args 参数列表\n     * @return 返回值\n     * @throws Throwable 方法抛出的异常\n     */\n    Object $invoke(String method, String[] parameterTypes, Object[] args) throws GenericException;\n\n}\n```\n\n### PojoUtils\n\n>PojoUtils. Travel object deeply, and convert complex type to simple type.\n\nsimple type包含primitive type, String, Number(Integer, Long), Date, Array of Primitive type, collection等\n\n举一个简单的例子, java类User定义如下:\n\n```java\npublic class User {\n\n    private  int age;\n    private  String name;\n    private Date birthDay;\n    private Address address;\n    public User() {\n    }\n\n    public User(int age, String name, Date birthDay) {\n        this.age = age;\n        this.name = name;\n        this.birthDay = birthDay;\n    }\n\n    public int getAge() {\n        return age;\n    }\n\n    public String getName() {\n        return name;\n    }\n\n    public Date getBirthDay() {\n        return birthDay;\n    }\n\n    public void setAge(int age) {\n        this.age = age;\n    }\n\n    public void setName(String name) {\n        this.name = name;\n    }\n\n    public void setBirthDay(Date birthDay) {\n        this.birthDay = birthDay;\n    }\n将hashmap结构的参数转换成对应的pojo\n    public Address getAddress() {\n        return address;\n    }\n\n    public void setAddress(Address address) {\n        this.address = address;\n    }\n\n    @Override\n    public String toString() {\n        return ReflectionToStringBuilder.toString(this);\n    }\n}￼￼ ￼ ￼ ￼ ￼ ￼￼\n\n```\n\n序列化代码:\n\n```java\n       final Object generalized = PojoUtils.generalize(user);\n        System.out.println(\"generalized = \" + JSON.toJSONString(generalized));\n```\n\ngeneralize之后其实是一个`hashmap`, 写成json字符串之后如下:\n\n```￼￼\n{\n    \"birthDay\": 1525258281516,\n    \"address\": {\n        \"zipCode\": 10086,\n        \"street\": \"haidian street\",\n        \"class\": \"com.air.rmi.dubbo.bean.Address\"\n    },\n    \"name\": \"Kevin\",\n    \"class\": \"com.air.rmi.dubbo.bean.User\",\n    \"age\": 26\n}\n```\n\n### 相关filters\n\n- `GenericFilter`: 负责provider端参数的转换.\n\n1. 调用时,将hashmap结构的参数转换成对应的pojo\n2. 返回结果时, 将pojo转换成hashmap\n\n```java\n            // 调用时\n            args = PojoUtils.realize(args, params, method.getGenericParameterTypes()\n            // 返回结果时\n            return new RpcResult(PojoUtils.generalize(result.getValue()));\n```\n\n- `GenericImplFilter`: 负责consumer端参数的转换, 将POJO转换成hashmap结构\n\n```java\n            Object[] args = PojoUtils.generalize(arguments);\n```\n\n这样consumer端传过来的只是一个map, 并不要有provider端的jar包, 根据这个就可以实现dubbo接口的测试平台.\n\n## 参考\n\n- [6.16 泛化引用 · GitBook](https://dubbo.incubator.apache.org/books/dubbo-user-book/demos/generic-reference.html)\n- [Dubbo高级特性实践-泛化调用 - 简书](https://www.jianshu.com/p/ff0947529de4)\n- [dubbo高级用法之泛化与接口自适应](https://zhuanlan.zhihu.com/p/29410596)","source":"_posts/dubbo-generic-invoke.md","raw":"title: dubbo泛化调用原理\ntags: generic\ncategory: dubbo\ntoc: true\ndate: 2018-05-02 20:50:44\n---\n\n\n## 介绍\n\n>泛接口调用方式主要用于客户端没有API接口及模型类元的情况，参数及返回值中的所有POJO均用Map表示，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过GenericService调用所有服务实现。\n\n截图为qunar的dubbo服务测试框架, 只需将参数按照指定的格式填入, 就可以直接调用相应的dubbo接口.\n\n{%  asset_img   generic.png  通过泛化调用手工发起dubbo请求 %}\n\n\n## 使用\n\n泛化调用需要接口声明为泛化, 可以在声明接口的时候指定,\n\n```xml\n<dubbo:reference id=\"barService\" interface=\"com.foo.BarService\" generic=\"true\" />\n```\n\n也可以在代码中进行设置:\n\n```java\n            ReferenceConfig<GenericService> reference = new ReferenceConfig<GenericService>();\n            reference.setApplication(new ApplicationConfig(\"generic-consumer\"));\n            reference.setInterface(DemoService.class);\n            reference.setUrl(\"dubbo://127.0.0.1:29581?scope=remote\");\n            // 声明为泛化\n            reference.setGeneric(true);\n            GenericService genericService = reference.get();\n```\n\n然后就可以使用泛化调用的方式去调用接口了\n\n```java\n                List<Map<String, Object>> users = new ArrayList<Map<String, Object>>();\n                Map<String, Object> user = new HashMap<String, Object>();\n                user.put(\"class\", \"com.alibaba.dubbo.config.api.User\");\n                user.put(\"name\", \"actual.provider\");\n                users.add(user);\n                // 泛化调用\n                users = (List<Map<String, Object>>) genericService.$invoke(\"getUsers\", new String[] {List.class.getName()}, new Object[] {users});\n                Assert.assertEquals(1, users.size());\n                Assert.assertEquals(\"actual.provider\", users.get(0).get(\"name\"));\n```\n\n\n## 实现\n\n泛化调用是通过dubbo的filter机制实现的, 大概流程如下:\n\n```\n+-------------------------------------------+               +-------------------------------------------+\n|  consumer 端                               |               | provider 端                                |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                    +------------------+   |               |       +--------------+                    |\n|                    |GenericImplFilter |   |  Invocation   |       |GenericFilter |                    |\n|             +----> |                  +-------------------------> |              |                    |\n|             |      +------------------+   |               |       +--------------+                    |\n| +-----------+                             |               |                      |    +-----------+   |\n| |           |                             |               |                      |    |           |   |\n| |Client     |                             |               |                      +--> | Service   |   |\n| |           |                             |               |                           |           |   |\n| +-----------+                             |               |                           +-------+---+   |\n|                                           |               |                                   |       |\n|      ^             +------------------+   |               |       +--------------+            |       |\n|      |             |GenericImplFilter |   |               |       |GenericFilter | <----------+       |\n|      +-------------+                  | <-------------------------+              |                    |\n|                    +------------------+   |               |       +--------------+                    |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n|                                           |               |                                           |\n+-------------------------------------------+               +-------------------------------------------+\n```\n\n\n###  GenericService\n\n`GenericService`这个接口和java的反射调用非常像, 只需提供调用的方法名称,  参数的类型以及参数的值就可以直接调用对应方法了.\n\n接口的实现如下:\n\n```java\npackage com.alibaba.dubbo.rpc.service;\n\n/**\n * 通用服务接口\n * \n * @author william.liangf\n * @export\n */\npublic interface GenericService {\n\n    /**\n     * 泛化调用\n     * \n     * @param method 方法名，如：findPerson，如果有重载方法，需带上参数列表，如：findPerson(java.lang.String)\n     * @param parameterTypes 参数类型\n     * @param args 参数列表\n     * @return 返回值\n     * @throws Throwable 方法抛出的异常\n     */\n    Object $invoke(String method, String[] parameterTypes, Object[] args) throws GenericException;\n\n}\n```\n\n### PojoUtils\n\n>PojoUtils. Travel object deeply, and convert complex type to simple type.\n\nsimple type包含primitive type, String, Number(Integer, Long), Date, Array of Primitive type, collection等\n\n举一个简单的例子, java类User定义如下:\n\n```java\npublic class User {\n\n    private  int age;\n    private  String name;\n    private Date birthDay;\n    private Address address;\n    public User() {\n    }\n\n    public User(int age, String name, Date birthDay) {\n        this.age = age;\n        this.name = name;\n        this.birthDay = birthDay;\n    }\n\n    public int getAge() {\n        return age;\n    }\n\n    public String getName() {\n        return name;\n    }\n\n    public Date getBirthDay() {\n        return birthDay;\n    }\n\n    public void setAge(int age) {\n        this.age = age;\n    }\n\n    public void setName(String name) {\n        this.name = name;\n    }\n\n    public void setBirthDay(Date birthDay) {\n        this.birthDay = birthDay;\n    }\n将hashmap结构的参数转换成对应的pojo\n    public Address getAddress() {\n        return address;\n    }\n\n    public void setAddress(Address address) {\n        this.address = address;\n    }\n\n    @Override\n    public String toString() {\n        return ReflectionToStringBuilder.toString(this);\n    }\n}￼￼ ￼ ￼ ￼ ￼ ￼￼\n\n```\n\n序列化代码:\n\n```java\n       final Object generalized = PojoUtils.generalize(user);\n        System.out.println(\"generalized = \" + JSON.toJSONString(generalized));\n```\n\ngeneralize之后其实是一个`hashmap`, 写成json字符串之后如下:\n\n```￼￼\n{\n    \"birthDay\": 1525258281516,\n    \"address\": {\n        \"zipCode\": 10086,\n        \"street\": \"haidian street\",\n        \"class\": \"com.air.rmi.dubbo.bean.Address\"\n    },\n    \"name\": \"Kevin\",\n    \"class\": \"com.air.rmi.dubbo.bean.User\",\n    \"age\": 26\n}\n```\n\n### 相关filters\n\n- `GenericFilter`: 负责provider端参数的转换.\n\n1. 调用时,将hashmap结构的参数转换成对应的pojo\n2. 返回结果时, 将pojo转换成hashmap\n\n```java\n            // 调用时\n            args = PojoUtils.realize(args, params, method.getGenericParameterTypes()\n            // 返回结果时\n            return new RpcResult(PojoUtils.generalize(result.getValue()));\n```\n\n- `GenericImplFilter`: 负责consumer端参数的转换, 将POJO转换成hashmap结构\n\n```java\n            Object[] args = PojoUtils.generalize(arguments);\n```\n\n这样consumer端传过来的只是一个map, 并不要有provider端的jar包, 根据这个就可以实现dubbo接口的测试平台.\n\n## 参考\n\n- [6.16 泛化引用 · GitBook](https://dubbo.incubator.apache.org/books/dubbo-user-book/demos/generic-reference.html)\n- [Dubbo高级特性实践-泛化调用 - 简书](https://www.jianshu.com/p/ff0947529de4)\n- [dubbo高级用法之泛化与接口自适应](https://zhuanlan.zhihu.com/p/29410596)","slug":"dubbo-generic-invoke","published":1,"updated":"2018-05-02T12:53:35.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd91005jjh4kz9viz7g2","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><blockquote>\n<p>泛接口调用方式主要用于客户端没有API接口及模型类元的情况，参数及返回值中的所有POJO均用Map表示，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过GenericService调用所有服务实现。</p>\n</blockquote>\n<p>截图为qunar的dubbo服务测试框架, 只需将参数按照指定的格式填入, 就可以直接调用相应的dubbo接口.</p>\n<img src=\"/2018/05/02/dubbo-generic-invoke/generic.png\" title=\"通过泛化调用手工发起dubbo请求\">\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>泛化调用需要接口声明为泛化, 可以在声明接口的时候指定,</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:reference</span> <span class=\"attr\">id</span>=<span class=\"string\">\"barService\"</span> <span class=\"attr\">interface</span>=<span class=\"string\">\"com.foo.BarService\"</span> <span class=\"attr\">generic</span>=<span class=\"string\">\"true\"</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n<p>也可以在代码中进行设置:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ReferenceConfig&lt;GenericService&gt; reference = <span class=\"keyword\">new</span> ReferenceConfig&lt;GenericService&gt;();</span><br><span class=\"line\">reference.setApplication(<span class=\"keyword\">new</span> ApplicationConfig(<span class=\"string\">\"generic-consumer\"</span>));</span><br><span class=\"line\">reference.setInterface(DemoService.class);</span><br><span class=\"line\">reference.setUrl(<span class=\"string\">\"dubbo://127.0.0.1:29581?scope=remote\"</span>);</span><br><span class=\"line\"><span class=\"comment\">// 声明为泛化</span></span><br><span class=\"line\">reference.setGeneric(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">GenericService genericService = reference.get();</span><br></pre></td></tr></table></figure>\n<p>然后就可以使用泛化调用的方式去调用接口了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List&lt;Map&lt;String, Object&gt;&gt; users = <span class=\"keyword\">new</span> ArrayList&lt;Map&lt;String, Object&gt;&gt;();</span><br><span class=\"line\">Map&lt;String, Object&gt; user = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">user.put(<span class=\"string\">\"class\"</span>, <span class=\"string\">\"com.alibaba.dubbo.config.api.User\"</span>);</span><br><span class=\"line\">user.put(<span class=\"string\">\"name\"</span>, <span class=\"string\">\"actual.provider\"</span>);</span><br><span class=\"line\">users.add(user);</span><br><span class=\"line\"><span class=\"comment\">// 泛化调用</span></span><br><span class=\"line\">users = (List&lt;Map&lt;String, Object&gt;&gt;) genericService.$invoke(<span class=\"string\">\"getUsers\"</span>, <span class=\"keyword\">new</span> String[] &#123;List.class.getName()&#125;, <span class=\"keyword\">new</span> Object[] &#123;users&#125;);</span><br><span class=\"line\">Assert.assertEquals(<span class=\"number\">1</span>, users.size());</span><br><span class=\"line\">Assert.assertEquals(<span class=\"string\">\"actual.provider\"</span>, users.get(<span class=\"number\">0</span>).get(<span class=\"string\">\"name\"</span>));</span><br></pre></td></tr></table></figure>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><p>泛化调用是通过dubbo的filter机制实现的, 大概流程如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+-------------------------------------------+               +-------------------------------------------+</span><br><span class=\"line\">|  consumer 端                               |               | provider 端                                |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                    +------------------+   |               |       +--------------+                    |</span><br><span class=\"line\">|                    |GenericImplFilter |   |  Invocation   |       |GenericFilter |                    |</span><br><span class=\"line\">|             +----&gt; |                  +-------------------------&gt; |              |                    |</span><br><span class=\"line\">|             |      +------------------+   |               |       +--------------+                    |</span><br><span class=\"line\">| +-----------+                             |               |                      |    +-----------+   |</span><br><span class=\"line\">| |           |                             |               |                      |    |           |   |</span><br><span class=\"line\">| |Client     |                             |               |                      +--&gt; | Service   |   |</span><br><span class=\"line\">| |           |                             |               |                           |           |   |</span><br><span class=\"line\">| +-----------+                             |               |                           +-------+---+   |</span><br><span class=\"line\">|                                           |               |                                   |       |</span><br><span class=\"line\">|      ^             +------------------+   |               |       +--------------+            |       |</span><br><span class=\"line\">|      |             |GenericImplFilter |   |               |       |GenericFilter | &lt;----------+       |</span><br><span class=\"line\">|      +-------------+                  | &lt;-------------------------+              |                    |</span><br><span class=\"line\">|                    +------------------+   |               |       +--------------+                    |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">+-------------------------------------------+               +-------------------------------------------+</span><br></pre></td></tr></table></figure>\n<h3 id=\"GenericService\"><a href=\"#GenericService\" class=\"headerlink\" title=\"GenericService\"></a>GenericService</h3><p><code>GenericService</code>这个接口和java的反射调用非常像, 只需提供调用的方法名称,  参数的类型以及参数的值就可以直接调用对应方法了.</p>\n<p>接口的实现如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.alibaba.dubbo.rpc.service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 通用服务接口</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> william.liangf</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@export</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">GenericService</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 泛化调用</span></span><br><span class=\"line\"><span class=\"comment\">     * </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> method 方法名，如：findPerson，如果有重载方法，需带上参数列表，如：findPerson(java.lang.String)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> parameterTypes 参数类型</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args 参数列表</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> 返回值</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Throwable 方法抛出的异常</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    Object $invoke(String method, String[] parameterTypes, Object[] args) <span class=\"keyword\">throws</span> GenericException;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"PojoUtils\"><a href=\"#PojoUtils\" class=\"headerlink\" title=\"PojoUtils\"></a>PojoUtils</h3><blockquote>\n<p>PojoUtils. Travel object deeply, and convert complex type to simple type.</p>\n</blockquote>\n<p>simple type包含primitive type, String, Number(Integer, Long), Date, Array of Primitive type, collection等</p>\n<p>举一个简单的例子, java类User定义如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span>  <span class=\"keyword\">int</span> age;</span><br><span class=\"line\">    <span class=\"keyword\">private</span>  String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Date birthDay;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Address address;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">User</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">User</span><span class=\"params\">(<span class=\"keyword\">int</span> age, String name, Date birthDay)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.birthDay = birthDay;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getAge</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Date <span class=\"title\">getBirthDay</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> birthDay;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAge</span><span class=\"params\">(<span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setBirthDay</span><span class=\"params\">(Date birthDay)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.birthDay = birthDay;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">将hashmap结构的参数转换成对应的pojo</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Address <span class=\"title\">getAddress</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAddress</span><span class=\"params\">(Address address)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.address = address;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ReflectionToStringBuilder.toString(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;￼￼ ￼ ￼ ￼ ￼ ￼￼</span><br></pre></td></tr></table></figure>\n<p>序列化代码:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Object generalized = PojoUtils.generalize(user);</span><br><span class=\"line\"> System.out.println(<span class=\"string\">\"generalized = \"</span> + JSON.toJSONString(generalized));</span><br></pre></td></tr></table></figure>\n<p>generalize之后其实是一个<code>hashmap</code>, 写成json字符串之后如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;birthDay&quot;: 1525258281516,</span><br><span class=\"line\">    &quot;address&quot;: &#123;</span><br><span class=\"line\">        &quot;zipCode&quot;: 10086,</span><br><span class=\"line\">        &quot;street&quot;: &quot;haidian street&quot;,</span><br><span class=\"line\">        &quot;class&quot;: &quot;com.air.rmi.dubbo.bean.Address&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;name&quot;: &quot;Kevin&quot;,</span><br><span class=\"line\">    &quot;class&quot;: &quot;com.air.rmi.dubbo.bean.User&quot;,</span><br><span class=\"line\">    &quot;age&quot;: 26</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"相关filters\"><a href=\"#相关filters\" class=\"headerlink\" title=\"相关filters\"></a>相关filters</h3><ul>\n<li><code>GenericFilter</code>: 负责provider端参数的转换.</li>\n</ul>\n<ol>\n<li>调用时,将hashmap结构的参数转换成对应的pojo</li>\n<li>返回结果时, 将pojo转换成hashmap</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 调用时</span></span><br><span class=\"line\">args = PojoUtils.realize(args, params, method.getGenericParameterTypes()</span><br><span class=\"line\"><span class=\"comment\">// 返回结果时</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RpcResult(PojoUtils.generalize(result.getValue()));</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>GenericImplFilter</code>: 负责consumer端参数的转换, 将POJO转换成hashmap结构</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object[] args = PojoUtils.generalize(arguments);</span><br></pre></td></tr></table></figure>\n<p>这样consumer端传过来的只是一个map, 并不要有provider端的jar包, 根据这个就可以实现dubbo接口的测试平台.</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://dubbo.incubator.apache.org/books/dubbo-user-book/demos/generic-reference.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">6.16 泛化引用 · GitBook</a></li>\n<li><a href=\"https://www.jianshu.com/p/ff0947529de4\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Dubbo高级特性实践-泛化调用 - 简书</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/29410596\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">dubbo高级用法之泛化与接口自适应</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><blockquote>\n<p>泛接口调用方式主要用于客户端没有API接口及模型类元的情况，参数及返回值中的所有POJO均用Map表示，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过GenericService调用所有服务实现。</p>\n</blockquote>\n<p>截图为qunar的dubbo服务测试框架, 只需将参数按照指定的格式填入, 就可以直接调用相应的dubbo接口.</p>\n<img src=\"/2018/05/02/dubbo-generic-invoke/generic.png\" title=\"通过泛化调用手工发起dubbo请求\">\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>泛化调用需要接口声明为泛化, 可以在声明接口的时候指定,</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:reference</span> <span class=\"attr\">id</span>=<span class=\"string\">\"barService\"</span> <span class=\"attr\">interface</span>=<span class=\"string\">\"com.foo.BarService\"</span> <span class=\"attr\">generic</span>=<span class=\"string\">\"true\"</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n<p>也可以在代码中进行设置:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ReferenceConfig&lt;GenericService&gt; reference = <span class=\"keyword\">new</span> ReferenceConfig&lt;GenericService&gt;();</span><br><span class=\"line\">reference.setApplication(<span class=\"keyword\">new</span> ApplicationConfig(<span class=\"string\">\"generic-consumer\"</span>));</span><br><span class=\"line\">reference.setInterface(DemoService.class);</span><br><span class=\"line\">reference.setUrl(<span class=\"string\">\"dubbo://127.0.0.1:29581?scope=remote\"</span>);</span><br><span class=\"line\"><span class=\"comment\">// 声明为泛化</span></span><br><span class=\"line\">reference.setGeneric(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">GenericService genericService = reference.get();</span><br></pre></td></tr></table></figure>\n<p>然后就可以使用泛化调用的方式去调用接口了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">List&lt;Map&lt;String, Object&gt;&gt; users = <span class=\"keyword\">new</span> ArrayList&lt;Map&lt;String, Object&gt;&gt;();</span><br><span class=\"line\">Map&lt;String, Object&gt; user = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">user.put(<span class=\"string\">\"class\"</span>, <span class=\"string\">\"com.alibaba.dubbo.config.api.User\"</span>);</span><br><span class=\"line\">user.put(<span class=\"string\">\"name\"</span>, <span class=\"string\">\"actual.provider\"</span>);</span><br><span class=\"line\">users.add(user);</span><br><span class=\"line\"><span class=\"comment\">// 泛化调用</span></span><br><span class=\"line\">users = (List&lt;Map&lt;String, Object&gt;&gt;) genericService.$invoke(<span class=\"string\">\"getUsers\"</span>, <span class=\"keyword\">new</span> String[] &#123;List.class.getName()&#125;, <span class=\"keyword\">new</span> Object[] &#123;users&#125;);</span><br><span class=\"line\">Assert.assertEquals(<span class=\"number\">1</span>, users.size());</span><br><span class=\"line\">Assert.assertEquals(<span class=\"string\">\"actual.provider\"</span>, users.get(<span class=\"number\">0</span>).get(<span class=\"string\">\"name\"</span>));</span><br></pre></td></tr></table></figure>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><p>泛化调用是通过dubbo的filter机制实现的, 大概流程如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+-------------------------------------------+               +-------------------------------------------+</span><br><span class=\"line\">|  consumer 端                               |               | provider 端                                |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                    +------------------+   |               |       +--------------+                    |</span><br><span class=\"line\">|                    |GenericImplFilter |   |  Invocation   |       |GenericFilter |                    |</span><br><span class=\"line\">|             +----&gt; |                  +-------------------------&gt; |              |                    |</span><br><span class=\"line\">|             |      +------------------+   |               |       +--------------+                    |</span><br><span class=\"line\">| +-----------+                             |               |                      |    +-----------+   |</span><br><span class=\"line\">| |           |                             |               |                      |    |           |   |</span><br><span class=\"line\">| |Client     |                             |               |                      +--&gt; | Service   |   |</span><br><span class=\"line\">| |           |                             |               |                           |           |   |</span><br><span class=\"line\">| +-----------+                             |               |                           +-------+---+   |</span><br><span class=\"line\">|                                           |               |                                   |       |</span><br><span class=\"line\">|      ^             +------------------+   |               |       +--------------+            |       |</span><br><span class=\"line\">|      |             |GenericImplFilter |   |               |       |GenericFilter | &lt;----------+       |</span><br><span class=\"line\">|      +-------------+                  | &lt;-------------------------+              |                    |</span><br><span class=\"line\">|                    +------------------+   |               |       +--------------+                    |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">|                                           |               |                                           |</span><br><span class=\"line\">+-------------------------------------------+               +-------------------------------------------+</span><br></pre></td></tr></table></figure>\n<h3 id=\"GenericService\"><a href=\"#GenericService\" class=\"headerlink\" title=\"GenericService\"></a>GenericService</h3><p><code>GenericService</code>这个接口和java的反射调用非常像, 只需提供调用的方法名称,  参数的类型以及参数的值就可以直接调用对应方法了.</p>\n<p>接口的实现如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.alibaba.dubbo.rpc.service;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 通用服务接口</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> william.liangf</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@export</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">GenericService</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 泛化调用</span></span><br><span class=\"line\"><span class=\"comment\">     * </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> method 方法名，如：findPerson，如果有重载方法，需带上参数列表，如：findPerson(java.lang.String)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> parameterTypes 参数类型</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args 参数列表</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> 返回值</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Throwable 方法抛出的异常</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    Object $invoke(String method, String[] parameterTypes, Object[] args) <span class=\"keyword\">throws</span> GenericException;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"PojoUtils\"><a href=\"#PojoUtils\" class=\"headerlink\" title=\"PojoUtils\"></a>PojoUtils</h3><blockquote>\n<p>PojoUtils. Travel object deeply, and convert complex type to simple type.</p>\n</blockquote>\n<p>simple type包含primitive type, String, Number(Integer, Long), Date, Array of Primitive type, collection等</p>\n<p>举一个简单的例子, java类User定义如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span>  <span class=\"keyword\">int</span> age;</span><br><span class=\"line\">    <span class=\"keyword\">private</span>  String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Date birthDay;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Address address;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">User</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">User</span><span class=\"params\">(<span class=\"keyword\">int</span> age, String name, Date birthDay)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.birthDay = birthDay;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getAge</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Date <span class=\"title\">getBirthDay</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> birthDay;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAge</span><span class=\"params\">(<span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setBirthDay</span><span class=\"params\">(Date birthDay)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.birthDay = birthDay;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">将hashmap结构的参数转换成对应的pojo</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Address <span class=\"title\">getAddress</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAddress</span><span class=\"params\">(Address address)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.address = address;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ReflectionToStringBuilder.toString(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;￼￼ ￼ ￼ ￼ ￼ ￼￼</span><br></pre></td></tr></table></figure>\n<p>序列化代码:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Object generalized = PojoUtils.generalize(user);</span><br><span class=\"line\"> System.out.println(<span class=\"string\">\"generalized = \"</span> + JSON.toJSONString(generalized));</span><br></pre></td></tr></table></figure>\n<p>generalize之后其实是一个<code>hashmap</code>, 写成json字符串之后如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;birthDay&quot;: 1525258281516,</span><br><span class=\"line\">    &quot;address&quot;: &#123;</span><br><span class=\"line\">        &quot;zipCode&quot;: 10086,</span><br><span class=\"line\">        &quot;street&quot;: &quot;haidian street&quot;,</span><br><span class=\"line\">        &quot;class&quot;: &quot;com.air.rmi.dubbo.bean.Address&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;name&quot;: &quot;Kevin&quot;,</span><br><span class=\"line\">    &quot;class&quot;: &quot;com.air.rmi.dubbo.bean.User&quot;,</span><br><span class=\"line\">    &quot;age&quot;: 26</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"相关filters\"><a href=\"#相关filters\" class=\"headerlink\" title=\"相关filters\"></a>相关filters</h3><ul>\n<li><code>GenericFilter</code>: 负责provider端参数的转换.</li>\n</ul>\n<ol>\n<li>调用时,将hashmap结构的参数转换成对应的pojo</li>\n<li>返回结果时, 将pojo转换成hashmap</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 调用时</span></span><br><span class=\"line\">args = PojoUtils.realize(args, params, method.getGenericParameterTypes()</span><br><span class=\"line\"><span class=\"comment\">// 返回结果时</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RpcResult(PojoUtils.generalize(result.getValue()));</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>GenericImplFilter</code>: 负责consumer端参数的转换, 将POJO转换成hashmap结构</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object[] args = PojoUtils.generalize(arguments);</span><br></pre></td></tr></table></figure>\n<p>这样consumer端传过来的只是一个map, 并不要有provider端的jar包, 根据这个就可以实现dubbo接口的测试平台.</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://dubbo.incubator.apache.org/books/dubbo-user-book/demos/generic-reference.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">6.16 泛化引用 · GitBook</a></li>\n<li><a href=\"https://www.jianshu.com/p/ff0947529de4\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Dubbo高级特性实践-泛化调用 - 简书</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/29410596\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">dubbo高级用法之泛化与接口自适应</a></li>\n</ul>\n"},{"title":"Let's go!(Go语言学习)","toc":true,"date":"2018-01-20T13:42:33.000Z","_content":"\n\n\n## go学习资料\n\n### go tutorial\n\n[A Tour of Go](https://tour.golang.org/list)\n\n简单的语法介绍, 可以在线编译/运行\n\n{% asset_image go-tour.png %}\n\n### 环境搭建\n\n#### go get访问被墙网站\n\n有些包只有墙外才能访问到, 因此第一步必须翻墙.\n\n> 另一个方法是实用 cow, 这是shadowsocks-go作者的另一个开发项目，根据项目介绍很容易的配置,可以在本机启动一个http代理，以shadowsocks为二级代理。\n\n补充一点, 用alias的方式, 可以只指定go使用代理\n\n```bash\n$ alias go='http_proxy=127.0.0.1:8080  https_proxy=127.0.0.1:8080 go'\n```\n\n\n## 参考\n\n1. [如何在长城后面go get一些库 | 鸟窝](http://colobu.com/2017/01/26/how-to-go-get-behind-GFW/)\n\n2. [A Tour of Go](https://tour.golang.org/list)\n\n3. [How do I configure Go to use a proxy? - Stack Overflow](https://stackoverflow.com/questions/10383299/how-do-i-configure-go-to-use-a-proxy)","source":"_posts/go-figure.md","raw":"title: Let's go!(Go语言学习)\ntags: go学习资料\ncategory: go\ntoc: true\ndate: 2018-01-20 21:42:33\n---\n\n\n\n## go学习资料\n\n### go tutorial\n\n[A Tour of Go](https://tour.golang.org/list)\n\n简单的语法介绍, 可以在线编译/运行\n\n{% asset_image go-tour.png %}\n\n### 环境搭建\n\n#### go get访问被墙网站\n\n有些包只有墙外才能访问到, 因此第一步必须翻墙.\n\n> 另一个方法是实用 cow, 这是shadowsocks-go作者的另一个开发项目，根据项目介绍很容易的配置,可以在本机启动一个http代理，以shadowsocks为二级代理。\n\n补充一点, 用alias的方式, 可以只指定go使用代理\n\n```bash\n$ alias go='http_proxy=127.0.0.1:8080  https_proxy=127.0.0.1:8080 go'\n```\n\n\n## 参考\n\n1. [如何在长城后面go get一些库 | 鸟窝](http://colobu.com/2017/01/26/how-to-go-get-behind-GFW/)\n\n2. [A Tour of Go](https://tour.golang.org/list)\n\n3. [How do I configure Go to use a proxy? - Stack Overflow](https://stackoverflow.com/questions/10383299/how-do-i-configure-go-to-use-a-proxy)","slug":"go-figure","published":1,"updated":"2018-01-20T13:43:07.419Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd92005mjh4kqt4pipbr","content":"<h2 id=\"go学习资料\"><a href=\"#go学习资料\" class=\"headerlink\" title=\"go学习资料\"></a>go学习资料</h2><h3 id=\"go-tutorial\"><a href=\"#go-tutorial\" class=\"headerlink\" title=\"go tutorial\"></a>go tutorial</h3><p><a href=\"https://tour.golang.org/list\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">A Tour of Go</a></p>\n<p>简单的语法介绍, 可以在线编译/运行</p>\n<img src=\"/2018/01/20/go-figure/go-tour.png\">\n<h3 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h3><h4 id=\"go-get访问被墙网站\"><a href=\"#go-get访问被墙网站\" class=\"headerlink\" title=\"go get访问被墙网站\"></a>go get访问被墙网站</h4><p>有些包只有墙外才能访问到, 因此第一步必须翻墙.</p>\n<blockquote>\n<p>另一个方法是实用 cow, 这是shadowsocks-go作者的另一个开发项目，根据项目介绍很容易的配置,可以在本机启动一个http代理，以shadowsocks为二级代理。</p>\n</blockquote>\n<p>补充一点, 用alias的方式, 可以只指定go使用代理</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">alias</span> go=<span class=\"string\">'http_proxy=127.0.0.1:8080  https_proxy=127.0.0.1:8080 go'</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://colobu.com/2017/01/26/how-to-go-get-behind-GFW/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">如何在长城后面go get一些库 | 鸟窝</a></p>\n</li>\n<li><p><a href=\"https://tour.golang.org/list\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">A Tour of Go</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/10383299/how-do-i-configure-go-to-use-a-proxy\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">How do I configure Go to use a proxy? - Stack Overflow</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"go学习资料\"><a href=\"#go学习资料\" class=\"headerlink\" title=\"go学习资料\"></a>go学习资料</h2><h3 id=\"go-tutorial\"><a href=\"#go-tutorial\" class=\"headerlink\" title=\"go tutorial\"></a>go tutorial</h3><p><a href=\"https://tour.golang.org/list\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">A Tour of Go</a></p>\n<p>简单的语法介绍, 可以在线编译/运行</p>\n<img src=\"/2018/01/20/go-figure/go-tour.png\">\n<h3 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h3><h4 id=\"go-get访问被墙网站\"><a href=\"#go-get访问被墙网站\" class=\"headerlink\" title=\"go get访问被墙网站\"></a>go get访问被墙网站</h4><p>有些包只有墙外才能访问到, 因此第一步必须翻墙.</p>\n<blockquote>\n<p>另一个方法是实用 cow, 这是shadowsocks-go作者的另一个开发项目，根据项目介绍很容易的配置,可以在本机启动一个http代理，以shadowsocks为二级代理。</p>\n</blockquote>\n<p>补充一点, 用alias的方式, 可以只指定go使用代理</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">alias</span> go=<span class=\"string\">'http_proxy=127.0.0.1:8080  https_proxy=127.0.0.1:8080 go'</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://colobu.com/2017/01/26/how-to-go-get-behind-GFW/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">如何在长城后面go get一些库 | 鸟窝</a></p>\n</li>\n<li><p><a href=\"https://tour.golang.org/list\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">A Tour of Go</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/10383299/how-do-i-configure-go-to-use-a-proxy\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">How do I configure Go to use a proxy? - Stack Overflow</a></p>\n</li>\n</ol>\n"},{"title":"Spring中的factory-bean和FactoryBean","toc":true,"abbrlink":2286,"date":"2017-02-13T16:50:40.000Z","_content":"\n\n\n### factory-bean\n\nspring的bean标签的一个属性，用来指定创建实例的方法\n\n```java\npublic class ClientService {\n    private static ClientService clientService = new ClientService();\n    private ClientService() {}\n\n    public static ClientService createInstance() {\n        return clientService;\n    }\n}\n\npublic class DefaultServiceLocator {\n\n    private static ClientService clientService = new ClientServiceImpl();\n    private static AccountService accountService = new AccountServiceImpl();\n\n    private DefaultServiceLocator() {}\n\n    public ClientService createClientServiceInstance() {\n        return clientService;\n    }\n\n    public AccountService createAccountServiceInstance() {\n        return accountService;\n    }\n\n}\n\n```\n#### 第一种写法\n\n```xml\n<bean id=\"clientService\"\n    class=\"examples.ClientService\"\n    factory-method=\"createInstance\"/>\n```\n这种写法要求`factory-method`必须是`static`的\n\n#### 第二种写法\n\n```xml\n<bean id=\"serviceLocator\" class=\"examples.DefaultServiceLocator\">\n    <!-- inject any dependencies required by this locator bean -->\n</bean>\n\n<bean id=\"clientService\"\n    factory-bean=\"serviceLocator\"\n    factory-method=\"createClientServiceInstance\"/>\n\n<bean id=\"accountService\"\n    factory-bean=\"serviceLocator\"\n    factory-method=\"createAccountServiceInstance\"/>\n```\n\n这种写法多了一个`factory-bean`，指定了使用哪个类的哪个方法去创建，不要求这个方法是`static`，但是`factory-bean`对应的类必须交由spring管理。\n\n一个类中可以包含多个创建的方法。\n\n\n### FactoryBean\n\n是Spring提供的一个接口，用来定制Bean的初始化逻辑。\n\n> If you have complex initialization code that is better expressed in Java as opposed to a (potentially) verbose amount of XML, you can create your own FactoryBean\n\n>   Interface to be implemented by objects used within a {@link BeanFactory} which\n    are themselves factories for individual objects. If a bean implements this\n    interface, it is used as a factory for an object to expose, not directly as a\n    bean instance that will be exposed itself.\n\n这个接口有三个方法：\n\n- Object getObject()\n\n获取创建的对象\n\n- boolean isSingleton()\n\n返回的对象是否是单例的\n\n- Class getObjectType()\n\n获取返回的对象的类型\n\n`GsonFactoryBean`就实现了`FactoryBean`接口，是一个不错的例子，大概代码如下：\n\n```java\npublic class GsonFactoryBean implements FactoryBean<Gson>, InitializingBean {\n\n    private boolean base64EncodeByteArrays = false;\n\n    private boolean serializeNulls = false;\n\n    private boolean prettyPrinting = false;\n\n    private boolean disableHtmlEscaping = false;\n\n    private String dateFormatPattern;\n\n    private Gson gson;\n\n    public void setBase64EncodeByteArrays(boolean base64EncodeByteArrays) {\n        this.base64EncodeByteArrays = base64EncodeByteArrays;\n    }\n\n    public void setSerializeNulls(boolean serializeNulls) {\n        this.serializeNulls = serializeNulls;\n    }\n\n    public void setPrettyPrinting(boolean prettyPrinting) {\n        this.prettyPrinting = prettyPrinting;\n    }\n\n    public void setDisableHtmlEscaping(boolean disableHtmlEscaping) {\n        this.disableHtmlEscaping = disableHtmlEscaping;\n    }\n\n    public void setDateFormatPattern(String dateFormatPattern) {\n        this.dateFormatPattern = dateFormatPattern;\n    }\n\n\n    @Override\n    public void afterPropertiesSet() {\n        GsonBuilder builder = (this.base64EncodeByteArrays ?\n                GsonBuilderUtils.gsonBuilderWithBase64EncodedByteArrays() : new GsonBuilder());\n        if (this.serializeNulls) {\n            builder.serializeNulls();\n        }\n        if (this.prettyPrinting) {\n            builder.setPrettyPrinting();\n        }\n        if (this.disableHtmlEscaping) {\n            builder.disableHtmlEscaping();\n        }\n        if (this.dateFormatPattern != null) {\n            builder.setDateFormat(this.dateFormatPattern);\n        }\n        this.gson = builder.create();\n    }\n\n    @Override\n    public Gson getObject() {\n        return this.gson;\n    }\n\n    @Override\n    public Class<?> getObjectType() {\n        return Gson.class;\n    }\n\n    @Override\n    public boolean isSingleton() {\n        return true;\n    }\n\n}\n```\n`GsonFactoryBean`除了实现了`FactoryBean`接口，还实现了`InitializingBean`接口，这个接口只有一个方法\n\n`afterPropertiesSet`。这个方法会在bean的所有提供的属性被设置之后，被BeanFactory调用，是spring保留的一个扩展点。\n\n`GsonFactoryBean`在这个方法中将收集到的配置信息传给builder，构建出一个`Gson`对象（这种一般是大对象，一个容器中有一个就够了）。\n\n```xml\n  <bean id=\"gsonFactoryBean\" class=\"org.springframework.http.converter.json.GsonFactoryBean\">\n    <property name=\"dateFormatPattern\" value=\"yyyy-MM-dd\"/>\n    <property name=\"disableHtmlEscaping\" value=\"true\"/>\n    <property name=\"prettyPrinting\" value=\"true\"/>\n</bean>\n```\n\n### 参考\n\n1. [7. The IoC container](https://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html)\n\n\n","source":"_posts/factorybean.md","raw":"---\ntitle: Spring中的factory-bean和FactoryBean\ntags: beanfactory\ncategory: spring\ntoc: true\nabbrlink: 2286\ndate: 2017-02-14 00:50:40\n---\n\n\n\n### factory-bean\n\nspring的bean标签的一个属性，用来指定创建实例的方法\n\n```java\npublic class ClientService {\n    private static ClientService clientService = new ClientService();\n    private ClientService() {}\n\n    public static ClientService createInstance() {\n        return clientService;\n    }\n}\n\npublic class DefaultServiceLocator {\n\n    private static ClientService clientService = new ClientServiceImpl();\n    private static AccountService accountService = new AccountServiceImpl();\n\n    private DefaultServiceLocator() {}\n\n    public ClientService createClientServiceInstance() {\n        return clientService;\n    }\n\n    public AccountService createAccountServiceInstance() {\n        return accountService;\n    }\n\n}\n\n```\n#### 第一种写法\n\n```xml\n<bean id=\"clientService\"\n    class=\"examples.ClientService\"\n    factory-method=\"createInstance\"/>\n```\n这种写法要求`factory-method`必须是`static`的\n\n#### 第二种写法\n\n```xml\n<bean id=\"serviceLocator\" class=\"examples.DefaultServiceLocator\">\n    <!-- inject any dependencies required by this locator bean -->\n</bean>\n\n<bean id=\"clientService\"\n    factory-bean=\"serviceLocator\"\n    factory-method=\"createClientServiceInstance\"/>\n\n<bean id=\"accountService\"\n    factory-bean=\"serviceLocator\"\n    factory-method=\"createAccountServiceInstance\"/>\n```\n\n这种写法多了一个`factory-bean`，指定了使用哪个类的哪个方法去创建，不要求这个方法是`static`，但是`factory-bean`对应的类必须交由spring管理。\n\n一个类中可以包含多个创建的方法。\n\n\n### FactoryBean\n\n是Spring提供的一个接口，用来定制Bean的初始化逻辑。\n\n> If you have complex initialization code that is better expressed in Java as opposed to a (potentially) verbose amount of XML, you can create your own FactoryBean\n\n>   Interface to be implemented by objects used within a {@link BeanFactory} which\n    are themselves factories for individual objects. If a bean implements this\n    interface, it is used as a factory for an object to expose, not directly as a\n    bean instance that will be exposed itself.\n\n这个接口有三个方法：\n\n- Object getObject()\n\n获取创建的对象\n\n- boolean isSingleton()\n\n返回的对象是否是单例的\n\n- Class getObjectType()\n\n获取返回的对象的类型\n\n`GsonFactoryBean`就实现了`FactoryBean`接口，是一个不错的例子，大概代码如下：\n\n```java\npublic class GsonFactoryBean implements FactoryBean<Gson>, InitializingBean {\n\n    private boolean base64EncodeByteArrays = false;\n\n    private boolean serializeNulls = false;\n\n    private boolean prettyPrinting = false;\n\n    private boolean disableHtmlEscaping = false;\n\n    private String dateFormatPattern;\n\n    private Gson gson;\n\n    public void setBase64EncodeByteArrays(boolean base64EncodeByteArrays) {\n        this.base64EncodeByteArrays = base64EncodeByteArrays;\n    }\n\n    public void setSerializeNulls(boolean serializeNulls) {\n        this.serializeNulls = serializeNulls;\n    }\n\n    public void setPrettyPrinting(boolean prettyPrinting) {\n        this.prettyPrinting = prettyPrinting;\n    }\n\n    public void setDisableHtmlEscaping(boolean disableHtmlEscaping) {\n        this.disableHtmlEscaping = disableHtmlEscaping;\n    }\n\n    public void setDateFormatPattern(String dateFormatPattern) {\n        this.dateFormatPattern = dateFormatPattern;\n    }\n\n\n    @Override\n    public void afterPropertiesSet() {\n        GsonBuilder builder = (this.base64EncodeByteArrays ?\n                GsonBuilderUtils.gsonBuilderWithBase64EncodedByteArrays() : new GsonBuilder());\n        if (this.serializeNulls) {\n            builder.serializeNulls();\n        }\n        if (this.prettyPrinting) {\n            builder.setPrettyPrinting();\n        }\n        if (this.disableHtmlEscaping) {\n            builder.disableHtmlEscaping();\n        }\n        if (this.dateFormatPattern != null) {\n            builder.setDateFormat(this.dateFormatPattern);\n        }\n        this.gson = builder.create();\n    }\n\n    @Override\n    public Gson getObject() {\n        return this.gson;\n    }\n\n    @Override\n    public Class<?> getObjectType() {\n        return Gson.class;\n    }\n\n    @Override\n    public boolean isSingleton() {\n        return true;\n    }\n\n}\n```\n`GsonFactoryBean`除了实现了`FactoryBean`接口，还实现了`InitializingBean`接口，这个接口只有一个方法\n\n`afterPropertiesSet`。这个方法会在bean的所有提供的属性被设置之后，被BeanFactory调用，是spring保留的一个扩展点。\n\n`GsonFactoryBean`在这个方法中将收集到的配置信息传给builder，构建出一个`Gson`对象（这种一般是大对象，一个容器中有一个就够了）。\n\n```xml\n  <bean id=\"gsonFactoryBean\" class=\"org.springframework.http.converter.json.GsonFactoryBean\">\n    <property name=\"dateFormatPattern\" value=\"yyyy-MM-dd\"/>\n    <property name=\"disableHtmlEscaping\" value=\"true\"/>\n    <property name=\"prettyPrinting\" value=\"true\"/>\n</bean>\n```\n\n### 参考\n\n1. [7. The IoC container](https://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html)\n\n\n","slug":"factorybean","published":1,"updated":"2017-04-16T12:03:23.389Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd94005qjh4kdomkakm6","content":"<h3 id=\"factory-bean\"><a href=\"#factory-bean\" class=\"headerlink\" title=\"factory-bean\"></a>factory-bean</h3><p>spring的bean标签的一个属性，用来指定创建实例的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClientService</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ClientService clientService = <span class=\"keyword\">new</span> ClientService();</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">ClientService</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ClientService <span class=\"title\">createInstance</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> clientService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultServiceLocator</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ClientService clientService = <span class=\"keyword\">new</span> ClientServiceImpl();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> AccountService accountService = <span class=\"keyword\">new</span> AccountServiceImpl();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">DefaultServiceLocator</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ClientService <span class=\"title\">createClientServiceInstance</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> clientService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AccountService <span class=\"title\">createAccountServiceInstance</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> accountService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"第一种写法\"><a href=\"#第一种写法\" class=\"headerlink\" title=\"第一种写法\"></a>第一种写法</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"clientService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">class</span>=<span class=\"string\">\"examples.ClientService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-method</span>=<span class=\"string\">\"createInstance\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这种写法要求<code>factory-method</code>必须是<code>static</code>的</p>\n<h4 id=\"第二种写法\"><a href=\"#第二种写法\" class=\"headerlink\" title=\"第二种写法\"></a>第二种写法</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"serviceLocator\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"examples.DefaultServiceLocator\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"clientService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-bean</span>=<span class=\"string\">\"serviceLocator\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-method</span>=<span class=\"string\">\"createClientServiceInstance\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-bean</span>=<span class=\"string\">\"serviceLocator\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-method</span>=<span class=\"string\">\"createAccountServiceInstance\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这种写法多了一个<code>factory-bean</code>，指定了使用哪个类的哪个方法去创建，不要求这个方法是<code>static</code>，但是<code>factory-bean</code>对应的类必须交由spring管理。</p>\n<p>一个类中可以包含多个创建的方法。</p>\n<h3 id=\"FactoryBean\"><a href=\"#FactoryBean\" class=\"headerlink\" title=\"FactoryBean\"></a>FactoryBean</h3><p>是Spring提供的一个接口，用来定制Bean的初始化逻辑。</p>\n<blockquote>\n<p>If you have complex initialization code that is better expressed in Java as opposed to a (potentially) verbose amount of XML, you can create your own FactoryBean</p>\n<p>  Interface to be implemented by objects used within a {@link BeanFactory} which<br>    are themselves factories for individual objects. If a bean implements this<br>    interface, it is used as a factory for an object to expose, not directly as a<br>    bean instance that will be exposed itself.</p>\n</blockquote>\n<p>这个接口有三个方法：</p>\n<ul>\n<li>Object getObject()</li>\n</ul>\n<p>获取创建的对象</p>\n<ul>\n<li>boolean isSingleton()</li>\n</ul>\n<p>返回的对象是否是单例的</p>\n<ul>\n<li>Class getObjectType()</li>\n</ul>\n<p>获取返回的对象的类型</p>\n<p><code>GsonFactoryBean</code>就实现了<code>FactoryBean</code>接口，是一个不错的例子，大概代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GsonFactoryBean</span> <span class=\"keyword\">implements</span> <span class=\"title\">FactoryBean</span>&lt;<span class=\"title\">Gson</span>&gt;, <span class=\"title\">InitializingBean</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> base64EncodeByteArrays = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> serializeNulls = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> prettyPrinting = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> disableHtmlEscaping = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String dateFormatPattern;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Gson gson;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setBase64EncodeByteArrays</span><span class=\"params\">(<span class=\"keyword\">boolean</span> base64EncodeByteArrays)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.base64EncodeByteArrays = base64EncodeByteArrays;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSerializeNulls</span><span class=\"params\">(<span class=\"keyword\">boolean</span> serializeNulls)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.serializeNulls = serializeNulls;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setPrettyPrinting</span><span class=\"params\">(<span class=\"keyword\">boolean</span> prettyPrinting)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.prettyPrinting = prettyPrinting;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setDisableHtmlEscaping</span><span class=\"params\">(<span class=\"keyword\">boolean</span> disableHtmlEscaping)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.disableHtmlEscaping = disableHtmlEscaping;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setDateFormatPattern</span><span class=\"params\">(String dateFormatPattern)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dateFormatPattern = dateFormatPattern;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterPropertiesSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        GsonBuilder builder = (<span class=\"keyword\">this</span>.base64EncodeByteArrays ?</span><br><span class=\"line\">                GsonBuilderUtils.gsonBuilderWithBase64EncodedByteArrays() : <span class=\"keyword\">new</span> GsonBuilder());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.serializeNulls) &#123;</span><br><span class=\"line\">            builder.serializeNulls();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.prettyPrinting) &#123;</span><br><span class=\"line\">            builder.setPrettyPrinting();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.disableHtmlEscaping) &#123;</span><br><span class=\"line\">            builder.disableHtmlEscaping();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.dateFormatPattern != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            builder.setDateFormat(<span class=\"keyword\">this</span>.dateFormatPattern);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.gson = builder.create();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Gson <span class=\"title\">getObject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.gson;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Gson.class;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isSingleton</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>GsonFactoryBean</code>除了实现了<code>FactoryBean</code>接口，还实现了<code>InitializingBean</code>接口，这个接口只有一个方法</p>\n<p><code>afterPropertiesSet</code>。这个方法会在bean的所有提供的属性被设置之后，被BeanFactory调用，是spring保留的一个扩展点。</p>\n<p><code>GsonFactoryBean</code>在这个方法中将收集到的配置信息传给builder，构建出一个<code>Gson</code>对象（这种一般是大对象，一个容器中有一个就够了）。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"gsonFactoryBean\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.http.converter.json.GsonFactoryBean\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dateFormatPattern\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"yyyy-MM-dd\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"disableHtmlEscaping\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"true\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"prettyPrinting\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"true\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><ol>\n<li><a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">7. The IoC container</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"factory-bean\"><a href=\"#factory-bean\" class=\"headerlink\" title=\"factory-bean\"></a>factory-bean</h3><p>spring的bean标签的一个属性，用来指定创建实例的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClientService</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ClientService clientService = <span class=\"keyword\">new</span> ClientService();</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">ClientService</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ClientService <span class=\"title\">createInstance</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> clientService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultServiceLocator</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ClientService clientService = <span class=\"keyword\">new</span> ClientServiceImpl();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> AccountService accountService = <span class=\"keyword\">new</span> AccountServiceImpl();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">DefaultServiceLocator</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ClientService <span class=\"title\">createClientServiceInstance</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> clientService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> AccountService <span class=\"title\">createAccountServiceInstance</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> accountService;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"第一种写法\"><a href=\"#第一种写法\" class=\"headerlink\" title=\"第一种写法\"></a>第一种写法</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"clientService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">class</span>=<span class=\"string\">\"examples.ClientService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-method</span>=<span class=\"string\">\"createInstance\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这种写法要求<code>factory-method</code>必须是<code>static</code>的</p>\n<h4 id=\"第二种写法\"><a href=\"#第二种写法\" class=\"headerlink\" title=\"第二种写法\"></a>第二种写法</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"serviceLocator\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"examples.DefaultServiceLocator\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"clientService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-bean</span>=<span class=\"string\">\"serviceLocator\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-method</span>=<span class=\"string\">\"createClientServiceInstance\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountService\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-bean</span>=<span class=\"string\">\"serviceLocator\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">factory-method</span>=<span class=\"string\">\"createAccountServiceInstance\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这种写法多了一个<code>factory-bean</code>，指定了使用哪个类的哪个方法去创建，不要求这个方法是<code>static</code>，但是<code>factory-bean</code>对应的类必须交由spring管理。</p>\n<p>一个类中可以包含多个创建的方法。</p>\n<h3 id=\"FactoryBean\"><a href=\"#FactoryBean\" class=\"headerlink\" title=\"FactoryBean\"></a>FactoryBean</h3><p>是Spring提供的一个接口，用来定制Bean的初始化逻辑。</p>\n<blockquote>\n<p>If you have complex initialization code that is better expressed in Java as opposed to a (potentially) verbose amount of XML, you can create your own FactoryBean</p>\n<p>  Interface to be implemented by objects used within a {@link BeanFactory} which<br>    are themselves factories for individual objects. If a bean implements this<br>    interface, it is used as a factory for an object to expose, not directly as a<br>    bean instance that will be exposed itself.</p>\n</blockquote>\n<p>这个接口有三个方法：</p>\n<ul>\n<li>Object getObject()</li>\n</ul>\n<p>获取创建的对象</p>\n<ul>\n<li>boolean isSingleton()</li>\n</ul>\n<p>返回的对象是否是单例的</p>\n<ul>\n<li>Class getObjectType()</li>\n</ul>\n<p>获取返回的对象的类型</p>\n<p><code>GsonFactoryBean</code>就实现了<code>FactoryBean</code>接口，是一个不错的例子，大概代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GsonFactoryBean</span> <span class=\"keyword\">implements</span> <span class=\"title\">FactoryBean</span>&lt;<span class=\"title\">Gson</span>&gt;, <span class=\"title\">InitializingBean</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> base64EncodeByteArrays = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> serializeNulls = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> prettyPrinting = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> disableHtmlEscaping = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String dateFormatPattern;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Gson gson;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setBase64EncodeByteArrays</span><span class=\"params\">(<span class=\"keyword\">boolean</span> base64EncodeByteArrays)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.base64EncodeByteArrays = base64EncodeByteArrays;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSerializeNulls</span><span class=\"params\">(<span class=\"keyword\">boolean</span> serializeNulls)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.serializeNulls = serializeNulls;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setPrettyPrinting</span><span class=\"params\">(<span class=\"keyword\">boolean</span> prettyPrinting)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.prettyPrinting = prettyPrinting;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setDisableHtmlEscaping</span><span class=\"params\">(<span class=\"keyword\">boolean</span> disableHtmlEscaping)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.disableHtmlEscaping = disableHtmlEscaping;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setDateFormatPattern</span><span class=\"params\">(String dateFormatPattern)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dateFormatPattern = dateFormatPattern;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterPropertiesSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        GsonBuilder builder = (<span class=\"keyword\">this</span>.base64EncodeByteArrays ?</span><br><span class=\"line\">                GsonBuilderUtils.gsonBuilderWithBase64EncodedByteArrays() : <span class=\"keyword\">new</span> GsonBuilder());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.serializeNulls) &#123;</span><br><span class=\"line\">            builder.serializeNulls();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.prettyPrinting) &#123;</span><br><span class=\"line\">            builder.setPrettyPrinting();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.disableHtmlEscaping) &#123;</span><br><span class=\"line\">            builder.disableHtmlEscaping();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.dateFormatPattern != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            builder.setDateFormat(<span class=\"keyword\">this</span>.dateFormatPattern);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.gson = builder.create();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Gson <span class=\"title\">getObject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.gson;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Gson.class;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isSingleton</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>GsonFactoryBean</code>除了实现了<code>FactoryBean</code>接口，还实现了<code>InitializingBean</code>接口，这个接口只有一个方法</p>\n<p><code>afterPropertiesSet</code>。这个方法会在bean的所有提供的属性被设置之后，被BeanFactory调用，是spring保留的一个扩展点。</p>\n<p><code>GsonFactoryBean</code>在这个方法中将收集到的配置信息传给builder，构建出一个<code>Gson</code>对象（这种一般是大对象，一个容器中有一个就够了）。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"gsonFactoryBean\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.http.converter.json.GsonFactoryBean\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dateFormatPattern\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"yyyy-MM-dd\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"disableHtmlEscaping\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"true\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"prettyPrinting\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"true\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><ol>\n<li><a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">7. The IoC container</a></li>\n</ol>\n"},{"title":"git-checkout 常用命令","toc":true,"date":"2017-09-11T16:38:12.000Z","_content":"\n\n## tips\n\n- 从另外一个分支检出文件\n\n```bash\ngit checkout source_branch <paths>...\n```\n\n## 参考\n\n1. [Git tip: How to \"merge\" specific files from another branch - jasonrudolph.com](http://jasonrudolph.com/blog/2009/02/25/git-tip-how-to-merge-specific-files-from-another-branch/)\n\n","source":"_posts/git-checkout.md","raw":"title: git-checkout 常用命令\ntags: git\ncategory: git\ntoc: true\ndate: 2017-09-12 00:38:12\n---\n\n\n## tips\n\n- 从另外一个分支检出文件\n\n```bash\ngit checkout source_branch <paths>...\n```\n\n## 参考\n\n1. [Git tip: How to \"merge\" specific files from another branch - jasonrudolph.com](http://jasonrudolph.com/blog/2009/02/25/git-tip-how-to-merge-specific-files-from-another-branch/)\n\n","slug":"git-checkout","published":1,"updated":"2017-09-11T16:38:12.137Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd95005sjh4k0aqkyoee","content":"<h2 id=\"tips\"><a href=\"#tips\" class=\"headerlink\" title=\"tips\"></a>tips</h2><ul>\n<li>从另外一个分支检出文件</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git checkout source_branch &lt;paths&gt;...</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://jasonrudolph.com/blog/2009/02/25/git-tip-how-to-merge-specific-files-from-another-branch/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Git tip: How to “merge” specific files from another branch - jasonrudolph.com</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"tips\"><a href=\"#tips\" class=\"headerlink\" title=\"tips\"></a>tips</h2><ul>\n<li>从另外一个分支检出文件</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git checkout source_branch &lt;paths&gt;...</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"http://jasonrudolph.com/blog/2009/02/25/git-tip-how-to-merge-specific-files-from-another-branch/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Git tip: How to “merge” specific files from another branch - jasonrudolph.com</a></li>\n</ol>\n"},{"title":"grep 总结","toc":true,"abbrlink":46663,"date":"2016-12-06T16:12:54.000Z","_content":"\n\n## 常见用法\n\n示例文本：\n> \"Night gathers, and now my watch begins. It shall not end \nuntil my death. I shall take no wife, hold no lands, father no \nchildren. I shall wear no crowns and win no glory. I shall live \nand die at my post. I am the sword in the darkness. I am the \nwatcher on the walls. I am the shield that guards the realms of \nmen. I pledge my life and honor to the Night's Watch, for this \nnight and all the nights to come.\"\n\n\n### `grep 'keyword' filename`\n\n在一个文件按照关键字查找\n\n `grep 'now' test.txt` 输出\n\n > \"Night gathers, and now my watch begins. It shall not end\n\n### `grep -n `\n\n显示行号\n\n `grep -n 'now' test.txt` 输出\n\n> 1:\"Night gathers, and now my watch begins. It shall not end\n\n### `grep -i` \n\n忽略大小写\n\n `grep -i 'watch' test.txt` 输出\n\n> \"Night gathers, and now my watch begins. It shall not end\nwatcher on the walls. I am the shield that guards the realms of\nmen. I pledge my life and honor to the Night's Watch, for this\n\n### `grep -v`\n\n输出不包含 `-v` 后面关键字的行\n\n`grep -v 'watch' test.txt` 输出\n\n> until my death. I shall take no wife, hold no lands, father no\nchildren. I shall wear no crowns and win no glory. I shall live\nand die at my post. I am the sword in the darkness. I am the\nmen. I pledge my life and honor to the Night's Watch, for this\nnight and all the nights to come.\"\n\n### `grep -e`\n\n提供正则的支持，关键字中可以包含正则表达式\n\n### `grep -B10`\n\n输出匹配行的同事， 也输出匹配行之前的10行（before）\n\n### `grep -A10`\n\n输出匹配行的同时，也输出匹配行之后的10行（after）\n\n### `grep -C10`\n\n输出匹配行的同时，输出之前和之后的10行\n\n### `grep -o`\n\n只输出匹配的内容\n\n`grep -o 'watch' test.txt`\n\n> watch\n  watch\n\n### `grep -c`\n\n输出匹配的行数的个数\n\n`grep -ci 'watch' test.txt`\n\n> 3\n\n## `grep -P`\n\n支持Perl style的正则表达式\n\n> -P, --perl-regexp\n>  Interpret PATTERN as a Perl regular expression.  This is highly experimental and grep -P may warn of  unimplemented\n>  features.\n\n### 零宽断言\n\n## 捕获组\n\n\n### `grep -l`\n\n显示有匹配行的文件，只显示文件名称，不显示内容\n\n`grep -l 'watch' test.txt`\n\n> test.txt\n\n### `grep -H`\n\n在匹配行的前面同时输出文件名\n\n`grep -H 'watch' test.txt`\n\n> test.txt:\"Night gathers, and now my watch begins. It shall not end\ntest.txt:watcher on the walls. I am the shield that guards the realms of\n\n## 高亮\n\n### grep --color\n\n`grep -H --color 'watch' test.txt`\n\n{%  asset_img   color.jpg  %}\n\n\n\n\n### 设置环境变量\n\n在用户目录下的`.bashrc`中设置环境变量，也可以达到高亮的目的\n\n```bash\nexport GREP_OPTIONS='--color=auto'\n```\n\n添加之后记得`source ~/.bashrc`, 然后才能生效\n\n## egrep\n\n> egrep 命令与 grep 命令带 -E 标志是一样的，除了错误消息和使用情况消息不同以及 -s 标志的功能不同之外。\n\n### 多关键字\n\n使用正则就可以同时搜索多个关键字\n\n`grep -E 'keyword1 | keyword2' filename`\n\n`grep --color -E  'am | to' test.txt`\n\n{%  asset_img   egrep.jpg  %}\n\n\n\n\n## zgrep\n\nzgrep 可以在压缩文件中搜索内容\n\n## 参考\n\n1. [HowTo: Use grep Command In Linux / UNIX – Examples](https://www.cyberciti.biz/faq/howto-use-grep-command-in-linux-unix/)\n\n2. [egrep 命令 - IBM](https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_61/com.ibm.aix.cmds2/egrep.htm)","source":"_posts/grep.md","raw":"---\ntitle: grep 总结\ncategory: shell\ntoc: true\nabbrlink: 46663\ndate: 2016-12-07 00:12:54\ntags:\n---\n\n\n## 常见用法\n\n示例文本：\n> \"Night gathers, and now my watch begins. It shall not end \nuntil my death. I shall take no wife, hold no lands, father no \nchildren. I shall wear no crowns and win no glory. I shall live \nand die at my post. I am the sword in the darkness. I am the \nwatcher on the walls. I am the shield that guards the realms of \nmen. I pledge my life and honor to the Night's Watch, for this \nnight and all the nights to come.\"\n\n\n### `grep 'keyword' filename`\n\n在一个文件按照关键字查找\n\n `grep 'now' test.txt` 输出\n\n > \"Night gathers, and now my watch begins. It shall not end\n\n### `grep -n `\n\n显示行号\n\n `grep -n 'now' test.txt` 输出\n\n> 1:\"Night gathers, and now my watch begins. It shall not end\n\n### `grep -i` \n\n忽略大小写\n\n `grep -i 'watch' test.txt` 输出\n\n> \"Night gathers, and now my watch begins. It shall not end\nwatcher on the walls. I am the shield that guards the realms of\nmen. I pledge my life and honor to the Night's Watch, for this\n\n### `grep -v`\n\n输出不包含 `-v` 后面关键字的行\n\n`grep -v 'watch' test.txt` 输出\n\n> until my death. I shall take no wife, hold no lands, father no\nchildren. I shall wear no crowns and win no glory. I shall live\nand die at my post. I am the sword in the darkness. I am the\nmen. I pledge my life and honor to the Night's Watch, for this\nnight and all the nights to come.\"\n\n### `grep -e`\n\n提供正则的支持，关键字中可以包含正则表达式\n\n### `grep -B10`\n\n输出匹配行的同事， 也输出匹配行之前的10行（before）\n\n### `grep -A10`\n\n输出匹配行的同时，也输出匹配行之后的10行（after）\n\n### `grep -C10`\n\n输出匹配行的同时，输出之前和之后的10行\n\n### `grep -o`\n\n只输出匹配的内容\n\n`grep -o 'watch' test.txt`\n\n> watch\n  watch\n\n### `grep -c`\n\n输出匹配的行数的个数\n\n`grep -ci 'watch' test.txt`\n\n> 3\n\n## `grep -P`\n\n支持Perl style的正则表达式\n\n> -P, --perl-regexp\n>  Interpret PATTERN as a Perl regular expression.  This is highly experimental and grep -P may warn of  unimplemented\n>  features.\n\n### 零宽断言\n\n## 捕获组\n\n\n### `grep -l`\n\n显示有匹配行的文件，只显示文件名称，不显示内容\n\n`grep -l 'watch' test.txt`\n\n> test.txt\n\n### `grep -H`\n\n在匹配行的前面同时输出文件名\n\n`grep -H 'watch' test.txt`\n\n> test.txt:\"Night gathers, and now my watch begins. It shall not end\ntest.txt:watcher on the walls. I am the shield that guards the realms of\n\n## 高亮\n\n### grep --color\n\n`grep -H --color 'watch' test.txt`\n\n{%  asset_img   color.jpg  %}\n\n\n\n\n### 设置环境变量\n\n在用户目录下的`.bashrc`中设置环境变量，也可以达到高亮的目的\n\n```bash\nexport GREP_OPTIONS='--color=auto'\n```\n\n添加之后记得`source ~/.bashrc`, 然后才能生效\n\n## egrep\n\n> egrep 命令与 grep 命令带 -E 标志是一样的，除了错误消息和使用情况消息不同以及 -s 标志的功能不同之外。\n\n### 多关键字\n\n使用正则就可以同时搜索多个关键字\n\n`grep -E 'keyword1 | keyword2' filename`\n\n`grep --color -E  'am | to' test.txt`\n\n{%  asset_img   egrep.jpg  %}\n\n\n\n\n## zgrep\n\nzgrep 可以在压缩文件中搜索内容\n\n## 参考\n\n1. [HowTo: Use grep Command In Linux / UNIX – Examples](https://www.cyberciti.biz/faq/howto-use-grep-command-in-linux-unix/)\n\n2. [egrep 命令 - IBM](https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_61/com.ibm.aix.cmds2/egrep.htm)","slug":"grep","published":1,"updated":"2017-11-07T03:15:34.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd96005xjh4kdgcj1f7x","content":"<h2 id=\"常见用法\"><a href=\"#常见用法\" class=\"headerlink\" title=\"常见用法\"></a>常见用法</h2><p>示例文本：</p>\n<blockquote>\n<p>“Night gathers, and now my watch begins. It shall not end<br>until my death. I shall take no wife, hold no lands, father no<br>children. I shall wear no crowns and win no glory. I shall live<br>and die at my post. I am the sword in the darkness. I am the<br>watcher on the walls. I am the shield that guards the realms of<br>men. I pledge my life and honor to the Night’s Watch, for this<br>night and all the nights to come.”</p>\n</blockquote>\n<h3 id=\"grep-39-keyword-39-filename\"><a href=\"#grep-39-keyword-39-filename\" class=\"headerlink\" title=\"grep &#39;keyword&#39; filename\"></a><code>grep &#39;keyword&#39; filename</code></h3><p>在一个文件按照关键字查找</p>\n<p> <code>grep &#39;now&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>“Night gathers, and now my watch begins. It shall not end</p>\n</blockquote>\n<h3 id=\"grep-n\"><a href=\"#grep-n\" class=\"headerlink\" title=\"grep -n\"></a><code>grep -n</code></h3><p>显示行号</p>\n<p> <code>grep -n &#39;now&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>1:”Night gathers, and now my watch begins. It shall not end</p>\n</blockquote>\n<h3 id=\"grep-i\"><a href=\"#grep-i\" class=\"headerlink\" title=\"grep -i\"></a><code>grep -i</code></h3><p>忽略大小写</p>\n<p> <code>grep -i &#39;watch&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>“Night gathers, and now my watch begins. It shall not end<br>watcher on the walls. I am the shield that guards the realms of<br>men. I pledge my life and honor to the Night’s Watch, for this</p>\n</blockquote>\n<h3 id=\"grep-v\"><a href=\"#grep-v\" class=\"headerlink\" title=\"grep -v\"></a><code>grep -v</code></h3><p>输出不包含 <code>-v</code> 后面关键字的行</p>\n<p><code>grep -v &#39;watch&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>until my death. I shall take no wife, hold no lands, father no<br>children. I shall wear no crowns and win no glory. I shall live<br>and die at my post. I am the sword in the darkness. I am the<br>men. I pledge my life and honor to the Night’s Watch, for this<br>night and all the nights to come.”</p>\n</blockquote>\n<h3 id=\"grep-e\"><a href=\"#grep-e\" class=\"headerlink\" title=\"grep -e\"></a><code>grep -e</code></h3><p>提供正则的支持，关键字中可以包含正则表达式</p>\n<h3 id=\"grep-B10\"><a href=\"#grep-B10\" class=\"headerlink\" title=\"grep -B10\"></a><code>grep -B10</code></h3><p>输出匹配行的同事， 也输出匹配行之前的10行（before）</p>\n<h3 id=\"grep-A10\"><a href=\"#grep-A10\" class=\"headerlink\" title=\"grep -A10\"></a><code>grep -A10</code></h3><p>输出匹配行的同时，也输出匹配行之后的10行（after）</p>\n<h3 id=\"grep-C10\"><a href=\"#grep-C10\" class=\"headerlink\" title=\"grep -C10\"></a><code>grep -C10</code></h3><p>输出匹配行的同时，输出之前和之后的10行</p>\n<h3 id=\"grep-o\"><a href=\"#grep-o\" class=\"headerlink\" title=\"grep -o\"></a><code>grep -o</code></h3><p>只输出匹配的内容</p>\n<p><code>grep -o &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>watch<br>  watch</p>\n</blockquote>\n<h3 id=\"grep-c\"><a href=\"#grep-c\" class=\"headerlink\" title=\"grep -c\"></a><code>grep -c</code></h3><p>输出匹配的行数的个数</p>\n<p><code>grep -ci &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>3</p>\n</blockquote>\n<h2 id=\"grep-P\"><a href=\"#grep-P\" class=\"headerlink\" title=\"grep -P\"></a><code>grep -P</code></h2><p>支持Perl style的正则表达式</p>\n<blockquote>\n<p>-P, –perl-regexp<br> Interpret PATTERN as a Perl regular expression.  This is highly experimental and grep -P may warn of  unimplemented<br> features.</p>\n</blockquote>\n<h3 id=\"零宽断言\"><a href=\"#零宽断言\" class=\"headerlink\" title=\"零宽断言\"></a>零宽断言</h3><h2 id=\"捕获组\"><a href=\"#捕获组\" class=\"headerlink\" title=\"捕获组\"></a>捕获组</h2><h3 id=\"grep-l\"><a href=\"#grep-l\" class=\"headerlink\" title=\"grep -l\"></a><code>grep -l</code></h3><p>显示有匹配行的文件，只显示文件名称，不显示内容</p>\n<p><code>grep -l &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>test.txt</p>\n</blockquote>\n<h3 id=\"grep-H\"><a href=\"#grep-H\" class=\"headerlink\" title=\"grep -H\"></a><code>grep -H</code></h3><p>在匹配行的前面同时输出文件名</p>\n<p><code>grep -H &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>test.txt:”Night gathers, and now my watch begins. It shall not end<br>test.txt:watcher on the walls. I am the shield that guards the realms of</p>\n</blockquote>\n<h2 id=\"高亮\"><a href=\"#高亮\" class=\"headerlink\" title=\"高亮\"></a>高亮</h2><h3 id=\"grep-–color\"><a href=\"#grep-–color\" class=\"headerlink\" title=\"grep –color\"></a>grep –color</h3><p><code>grep -H --color &#39;watch&#39; test.txt</code></p>\n<img src=\"/2016/12/07/grep/color.jpg\">\n<h3 id=\"设置环境变量\"><a href=\"#设置环境变量\" class=\"headerlink\" title=\"设置环境变量\"></a>设置环境变量</h3><p>在用户目录下的<code>.bashrc</code>中设置环境变量，也可以达到高亮的目的</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> GREP_OPTIONS=<span class=\"string\">'--color=auto'</span></span><br></pre></td></tr></table></figure>\n<p>添加之后记得<code>source ~/.bashrc</code>, 然后才能生效</p>\n<h2 id=\"egrep\"><a href=\"#egrep\" class=\"headerlink\" title=\"egrep\"></a>egrep</h2><blockquote>\n<p>egrep 命令与 grep 命令带 -E 标志是一样的，除了错误消息和使用情况消息不同以及 -s 标志的功能不同之外。</p>\n</blockquote>\n<h3 id=\"多关键字\"><a href=\"#多关键字\" class=\"headerlink\" title=\"多关键字\"></a>多关键字</h3><p>使用正则就可以同时搜索多个关键字</p>\n<p><code>grep -E &#39;keyword1 | keyword2&#39; filename</code></p>\n<p><code>grep --color -E  &#39;am | to&#39; test.txt</code></p>\n<img src=\"/2016/12/07/grep/egrep.jpg\">\n<h2 id=\"zgrep\"><a href=\"#zgrep\" class=\"headerlink\" title=\"zgrep\"></a>zgrep</h2><p>zgrep 可以在压缩文件中搜索内容</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://www.cyberciti.biz/faq/howto-use-grep-command-in-linux-unix/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">HowTo: Use grep Command In Linux / UNIX – Examples</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_61/com.ibm.aix.cmds2/egrep.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">egrep 命令 - IBM</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"常见用法\"><a href=\"#常见用法\" class=\"headerlink\" title=\"常见用法\"></a>常见用法</h2><p>示例文本：</p>\n<blockquote>\n<p>“Night gathers, and now my watch begins. It shall not end<br>until my death. I shall take no wife, hold no lands, father no<br>children. I shall wear no crowns and win no glory. I shall live<br>and die at my post. I am the sword in the darkness. I am the<br>watcher on the walls. I am the shield that guards the realms of<br>men. I pledge my life and honor to the Night’s Watch, for this<br>night and all the nights to come.”</p>\n</blockquote>\n<h3 id=\"grep-39-keyword-39-filename\"><a href=\"#grep-39-keyword-39-filename\" class=\"headerlink\" title=\"grep &#39;keyword&#39; filename\"></a><code>grep &#39;keyword&#39; filename</code></h3><p>在一个文件按照关键字查找</p>\n<p> <code>grep &#39;now&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>“Night gathers, and now my watch begins. It shall not end</p>\n</blockquote>\n<h3 id=\"grep-n\"><a href=\"#grep-n\" class=\"headerlink\" title=\"grep -n\"></a><code>grep -n</code></h3><p>显示行号</p>\n<p> <code>grep -n &#39;now&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>1:”Night gathers, and now my watch begins. It shall not end</p>\n</blockquote>\n<h3 id=\"grep-i\"><a href=\"#grep-i\" class=\"headerlink\" title=\"grep -i\"></a><code>grep -i</code></h3><p>忽略大小写</p>\n<p> <code>grep -i &#39;watch&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>“Night gathers, and now my watch begins. It shall not end<br>watcher on the walls. I am the shield that guards the realms of<br>men. I pledge my life and honor to the Night’s Watch, for this</p>\n</blockquote>\n<h3 id=\"grep-v\"><a href=\"#grep-v\" class=\"headerlink\" title=\"grep -v\"></a><code>grep -v</code></h3><p>输出不包含 <code>-v</code> 后面关键字的行</p>\n<p><code>grep -v &#39;watch&#39; test.txt</code> 输出</p>\n<blockquote>\n<p>until my death. I shall take no wife, hold no lands, father no<br>children. I shall wear no crowns and win no glory. I shall live<br>and die at my post. I am the sword in the darkness. I am the<br>men. I pledge my life and honor to the Night’s Watch, for this<br>night and all the nights to come.”</p>\n</blockquote>\n<h3 id=\"grep-e\"><a href=\"#grep-e\" class=\"headerlink\" title=\"grep -e\"></a><code>grep -e</code></h3><p>提供正则的支持，关键字中可以包含正则表达式</p>\n<h3 id=\"grep-B10\"><a href=\"#grep-B10\" class=\"headerlink\" title=\"grep -B10\"></a><code>grep -B10</code></h3><p>输出匹配行的同事， 也输出匹配行之前的10行（before）</p>\n<h3 id=\"grep-A10\"><a href=\"#grep-A10\" class=\"headerlink\" title=\"grep -A10\"></a><code>grep -A10</code></h3><p>输出匹配行的同时，也输出匹配行之后的10行（after）</p>\n<h3 id=\"grep-C10\"><a href=\"#grep-C10\" class=\"headerlink\" title=\"grep -C10\"></a><code>grep -C10</code></h3><p>输出匹配行的同时，输出之前和之后的10行</p>\n<h3 id=\"grep-o\"><a href=\"#grep-o\" class=\"headerlink\" title=\"grep -o\"></a><code>grep -o</code></h3><p>只输出匹配的内容</p>\n<p><code>grep -o &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>watch<br>  watch</p>\n</blockquote>\n<h3 id=\"grep-c\"><a href=\"#grep-c\" class=\"headerlink\" title=\"grep -c\"></a><code>grep -c</code></h3><p>输出匹配的行数的个数</p>\n<p><code>grep -ci &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>3</p>\n</blockquote>\n<h2 id=\"grep-P\"><a href=\"#grep-P\" class=\"headerlink\" title=\"grep -P\"></a><code>grep -P</code></h2><p>支持Perl style的正则表达式</p>\n<blockquote>\n<p>-P, –perl-regexp<br> Interpret PATTERN as a Perl regular expression.  This is highly experimental and grep -P may warn of  unimplemented<br> features.</p>\n</blockquote>\n<h3 id=\"零宽断言\"><a href=\"#零宽断言\" class=\"headerlink\" title=\"零宽断言\"></a>零宽断言</h3><h2 id=\"捕获组\"><a href=\"#捕获组\" class=\"headerlink\" title=\"捕获组\"></a>捕获组</h2><h3 id=\"grep-l\"><a href=\"#grep-l\" class=\"headerlink\" title=\"grep -l\"></a><code>grep -l</code></h3><p>显示有匹配行的文件，只显示文件名称，不显示内容</p>\n<p><code>grep -l &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>test.txt</p>\n</blockquote>\n<h3 id=\"grep-H\"><a href=\"#grep-H\" class=\"headerlink\" title=\"grep -H\"></a><code>grep -H</code></h3><p>在匹配行的前面同时输出文件名</p>\n<p><code>grep -H &#39;watch&#39; test.txt</code></p>\n<blockquote>\n<p>test.txt:”Night gathers, and now my watch begins. It shall not end<br>test.txt:watcher on the walls. I am the shield that guards the realms of</p>\n</blockquote>\n<h2 id=\"高亮\"><a href=\"#高亮\" class=\"headerlink\" title=\"高亮\"></a>高亮</h2><h3 id=\"grep-–color\"><a href=\"#grep-–color\" class=\"headerlink\" title=\"grep –color\"></a>grep –color</h3><p><code>grep -H --color &#39;watch&#39; test.txt</code></p>\n<img src=\"/2016/12/07/grep/color.jpg\">\n<h3 id=\"设置环境变量\"><a href=\"#设置环境变量\" class=\"headerlink\" title=\"设置环境变量\"></a>设置环境变量</h3><p>在用户目录下的<code>.bashrc</code>中设置环境变量，也可以达到高亮的目的</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> GREP_OPTIONS=<span class=\"string\">'--color=auto'</span></span><br></pre></td></tr></table></figure>\n<p>添加之后记得<code>source ~/.bashrc</code>, 然后才能生效</p>\n<h2 id=\"egrep\"><a href=\"#egrep\" class=\"headerlink\" title=\"egrep\"></a>egrep</h2><blockquote>\n<p>egrep 命令与 grep 命令带 -E 标志是一样的，除了错误消息和使用情况消息不同以及 -s 标志的功能不同之外。</p>\n</blockquote>\n<h3 id=\"多关键字\"><a href=\"#多关键字\" class=\"headerlink\" title=\"多关键字\"></a>多关键字</h3><p>使用正则就可以同时搜索多个关键字</p>\n<p><code>grep -E &#39;keyword1 | keyword2&#39; filename</code></p>\n<p><code>grep --color -E  &#39;am | to&#39; test.txt</code></p>\n<img src=\"/2016/12/07/grep/egrep.jpg\">\n<h2 id=\"zgrep\"><a href=\"#zgrep\" class=\"headerlink\" title=\"zgrep\"></a>zgrep</h2><p>zgrep 可以在压缩文件中搜索内容</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://www.cyberciti.biz/faq/howto-use-grep-command-in-linux-unix/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">HowTo: Use grep Command In Linux / UNIX – Examples</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_61/com.ibm.aix.cmds2/egrep.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">egrep 命令 - IBM</a></p>\n</li>\n</ol>\n"},{"title":"使用google perf工具来排查堆外内存占用","toc":true,"date":"2017-12-02T11:24:38.000Z","_content":"\n\n## 现象\n\n线上机器内存不足，经常被系统`oom killer`干掉。\n\n如果`tomcat`运行的好好的，突然被干掉了，没有任何线索，那么就可以使用下面的命令看看是不是`oom killer`搞的鬼\n\n```bash\nsudo dmesg | grep -i kill | less\n\nOut of memory: Kill process 23195 (java) score 558 or sacrifice child\nKilled process 23195, UID 40001, (java) total-vm:81176732kB, anon-rss:64507900kB, file-rss:2604kB\n```\n\n其中`anon-rss`是程序占用的物理内存，  64507900kB = 61.519527435302734 GB\n系统总的内存也才`62GB`，linux发现没有可分配的内存，就会启用`oom killer`的机制，根据`oom_score_adj`的值去干掉相应的进程了。\n\n系统上`oom_score_adj`的值\n\n```\n43722 total pagecache pages\n4335 pages in swap cache\nSwap cache stats: add 1009840, delete 1005505, find 76432470/76485037\nFree swap  = 49990420kB\nTotal swap = 50331644kB\n16777215 pages RAM\n282254 pages reserved\n36481 pages shared\n16386140 pages non-shared\n[ pid ]   uid  tgid total_vm      rss cpu oom_adj oom_score_adj name\n[ 1419]     0  1419     2883       94  18     -17         -1000 udevd\n[ 2894]     0  2894     2660      105   6     -17         -1000 udevd\n[ 2895]     0  2895     2882       43   2     -17         -1000 udevd\n[  388]     0   388    16557       63  12     -17         -1000 sshd\n[ 1340]     0  1340   152806     9114   6       0             0 salt-minion\n[ 1341]     0  1341   110173     5224  22       0             0 salt-minion\n[14168]     0 14168     6899      149   6     -17         -1000 auditd\n```\n\n`tomcat`的进程占用内存最多，得分也最高 —— 558\n\n### tomcat的配置\n\n\n```bash\n -Xms44g -Xmx44g -server \\\n-XX:+UseG1GC -XX:MaxGCPauseMillis=200 \\\n-XX:InitiatingHeapOccupancyPercent=65 -XX:SurvivorRatio=8 \\\n-XX:MaxTenuringThreshold=15 \\\n-verbosegc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps \\\n-XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy \\\n-XX:-TraceClassUnloading \\\n-XX:+DisableExplicitGC \n```\n\njvm最大的堆只有44GB， 但是从上面的日志中看到实际占用的内存达到了62GB，几乎把整个系统的内存都吃掉了。\n既然堆内没有问题，问题自然应该出在堆外内存的占用上。\n\n## java 堆外内存\n\n[JVM源码分析之堆外内存完全解读 - 你假笨](http://lovestblog.cn/blog/2015/05/12/direct-buffer/) 中说道：\n\n>对于System.gc的实现，之前写了一篇文章来重点介绍，JVM源码分析之SystemGC完全解读，它会对新生代的老生代都会进行内存回收，这样会比较彻底地回收DirectByteBuffer对象以及他们关联的堆外内存，我们dump内存发现DirectByteBuffer对象本身其实是很小的，但是它后面可能关联了一个非常大的堆外内存，因此我们通常称之为『冰山对象』，我们做ygc的时候会将新生代里的不可达的DirectByteBuffer对象及其堆外内存回收了，但是无法对old里的DirectByteBuffer对象及其堆外内存进行回收，这也是我们通常碰到的最大的问题，如果有大量的DirectByteBuffer对象移到了old，但是又一直没有做cms gc或者full gc，而只进行ygc，那么我们的物理内存可能被慢慢耗光，但是我们还不知道发生了什么，因为heap明明剩余的内存还很多(前提是我们禁用了System.gc)。\n\n白衣大侠也建议：\n\n>这时，就只能靠前面提到的申请额度超限时触发的system.gc()来救场了。但这道最后的保险其实也不很好，首先它会中断整个进程，然后它让当前线程睡了整整一百毫秒，而且如果gc没在一百毫秒内完成，它仍然会无情的抛出OOM异常。还有，万一，万一大家迷信某个调优指南设置了-DisableExplicitGC禁止了system.gc()，那就不好玩了。\n>所以，堆外内存还是自己主动点回收更好，比如Netty就是这么做的。\n\n\n### 限制堆外内存的大小\n\n加上`-XX:MaxDirectMemorySize=4g`， 去除`-XX:+DisableExplicitG`观察了几天，发现并不能解决问题，于是继续使用`google perf tools`去观察下堆外内存的使用\n\n## google perf tools\n\n[下载地址](https://github.com/gperftools/gperftools/tree/master)\n\n### 原理\n\n> 该工具主要利用了unix的一个环境变量LD_PRELOAD，它允许你要加载的动态库优先加载起来，相当于一个Hook了，\n> 于是可以针对同一个函数可以选择不同的动态库里的实现了，比如googleperftools就是将malloc方法替换成了tcmalloc的实现，这样就可以跟踪内存分配路径了\n\n### 使用\n\n`tomcat`的启动变量中加入下面的配置\n```bash\nexport LD_PRELOAD=/usr/local/lib/libtcmalloc.so\nexport HEAPPROFILE=/home/q/perf-result/\nexport HEAP_PROFILE_ALLOCATION_INTERVAL=2000000000\n```\nHEAPPROFILE是存放结果的地址\n\n>HEAP_PROFILE_ALLOCATION_INTERVAL\tdefault: 1073741824 (1 Gb)\tDump heap profiling information once every specified number of bytes has been allocated by the program.\n\n查看运行中的日志:\n```\nDumping heap profile to /home/q/perf-result/_23207.0927.heap (1755151 MB allocated cumulatively, 1267 MB currently in use) \n```\n\n日志中会显示累计的对外内存的分配和当前使用的堆外内存的大小。\n\n### 分析结果\n\n#### 文本形式的\n\n命令：\n```bash\n/usr/local/bin/pprof --text /home/q/java/default/bin/java _23207.0035.heap\n```\n\n输出结果如下：\n\n```\nUsing local file /home/q/java/default/bin/java.\nUsing local file _23207.1012.heap.\nTotal: 1283.1 MB\n\n     0.0   0.0% 100.0%     39.5   3.1% PtrQueue::enqueue_known_active\n     0.0   0.0% 100.0%     39.5   3.1% PtrQueueSet::allocate_buffer\n     0.0   0.0% 100.0%     42.2   3.3% G1ParTask::work\n     0.0   0.0% 100.0%     42.2   3.3% GangWorker::loop\n     0.0   0.0% 100.0%     75.6   5.9% ObjArrayKlass::oop_oop_iterate_nv_m@8fbe80\n     0.0   0.0% 100.0%    146.2  11.4% 0x00007f63bf0e5825\n     0.0   0.0% 100.0%    146.2  11.4% JVM_InternString\n     0.0   0.0% 100.0%    146.2  11.4% StringTable::intern@a24ca0\n     0.0   0.0% 100.0%    147.2  11.5% StringTable::basic_add\n     0.0   0.0% 100.0%    147.3  11.5% StringTable::intern@a24780\n     0.0   0.0% 100.0%    152.4  11.9% Hashtable::new_entry\n     0.0   0.0% 100.0%    170.5  13.3% AllocateHeap\n     0.0   0.0% 100.0%    256.0  20.0% ConcurrentMark::ConcurrentMark\n     0.0   0.0% 100.0%    265.5  20.7% InstanceKlass::oop_oop_iterate_nv\n     0.0   0.0% 100.0%    287.2  22.4% G1CollectedHeap::initialize\n     0.0   0.0% 100.0%    305.4  23.8% Universe::initialize_heap\n     0.0   0.0% 100.0%    306.3  23.9% universe_init\n     0.0   0.0% 100.0%    307.0  23.9% init_globals\n     0.0   0.0% 100.0%    307.1  23.9% JNI_CreateJavaVM\n     0.0   0.0% 100.0%    307.1  23.9% Threads::create_vm\n     0.0   0.0% 100.0%    307.2  23.9% JavaMain\n     0.0   0.0% 100.0%    326.5  25.4% ConcurrentG1RefineThread::run\n     0.0   0.0% 100.0%    326.5  25.4% RefineCardTableEntryClosure::do_card_ptr\n     0.0   0.0% 100.0%    329.8  25.7% 0x00007f63bfae74a7\n     0.0   0.0% 100.0%    348.5  27.2% DirtyCardQueueSet::apply_closure_to_completed_buffer\n     0.0   0.0% 100.0%    349.7  27.3% G1RemSet::refine_card\n     0.0   0.0% 100.0%    349.7  27.3% HeapRegion::oops_on_card_seq_iterate_careful\n     0.0   0.0% 100.0%    349.7  27.3% OtherRegionsTable::add_reference\n     0.0   0.0% 100.0%    351.0  27.4% os::malloc@913e80\n     0.0   0.0% 100.0%    351.0  27.4% Unsafe_AllocateMemory\n     0.0   0.0% 100.0%    408.4  31.8% java_start\n     0.0   0.0% 100.0%    562.6  43.8% BitMap::resize\n     0.0   0.0% 100.0%    598.5  46.6% ArrayAllocator::allocate\n     0.0   0.0% 100.0%    715.5  55.8% __clone\n     0.0   0.0% 100.0%    715.5  55.8% start_thread\n  1277.3  99.5%  99.5%   1277.3  99.5% os::malloc@9137e0\n```\n\n结果代表的含义:\n\n```\nAnalyzing Text Output\n\nText mode has lines of output that look like this:\n\n       14   2.1%  17.2%       58   8.7% std::_Rb_tree::find\nHere is how to interpret the columns:\n\n1. Number of profiling samples in this function\n2. Percentage of profiling samples in this function\n3. Percentage of profiling samples in the functions printed so far\n4. Number of profiling samples in this function and its callees\n5. Percentage of profiling samples in this function and its callees\n6. Function name\n```\n\n[Gperftools CPU Profiler](https://gperftools.github.io/gperftools/cpuprofile.html)中有更加详细的说明\n\n#### pdf形式的结果\n\n相比文字的结果，图片形式的调用关系，更加清楚和直观。\n\n命令如下:\n\n```bash\nsudo yum install ghostscript\nsudo yum install dot\nsudo yum install graphviz -y\nsudo pprof --pdf  /home/q/java/default/bin/java _19877.19793.heap > result.pdf\n```\n\n结果：\n\n{% pdf  result.pdf %}\n\n## 可能的原因\n\n从google perf tools的结果来看主要的堆外内存来自\n\n```\n0x00007f52e05126a5\n0.0 (0.0%)\nof 7089.3 (82.5%)\n```\n\n这个再往上就没有地址了。\n\n### heap 占用\n\n查看出问题机器的`heap`占用情况如下\n\n```\njmap -histo:live `pgrep -f 'tomcat'`\n\n num     #instances         #bytes  class name\n\n----------------------------------------------\n\n   1:      15272979      940261992  [C\n\n   2:      19182959      767318360  java.util.ArrayList\n\n   3:      15397474      739078752  qunar.tc.plato.zeno.util.collections.offheap.map.OffHeapHashMap\n\n   4:      13281544      637514112  java.util.concurrent.ConcurrentHashMap$Node\n\n   5:      10136730      612997544  [Ljava.lang.Object;\n\n   6:      15265576      488498432  java.lang.String\n\n   7:       4694324      413100512  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaSHotelBizInfo\n\n   8:           854      379525944  [Ljava.util.concurrent.ConcurrentHashMap$Node;\n\n   9:      15397474      369539376  qunar.tc.plato.zeno.util.collections.offheap.set.OffHeapHashSet\n\n  10:       4694324      337991328  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaContactConfig\n```\n\n前面的都是去哪儿自己开发的堆外缓存占用的对象，缓存的内容也多是酒店相关的元数据。结合工具的结果，推测问题出在堆外缓存。\n堆外缓存采用的是内存映射的方式，大量使用了`DirectByteBuffer`这种冰山对象。\n\n### 疑点\n\n这个系统目前处于重构阶段，之前也是使用的堆外缓存，并没有出现问题。不过，目前在逐渐下掉堆外缓存的使用，到时候可以再看看是否出问题。\n\n## 杂谈\n\n### 使用pmap查看进程的内存映射\n\n```\nsudo -u tomcat pmap -x  25147 | less\n\nAddress           Kbytes     RSS   Dirty Mode   Mapping\n0000000000400000       4       0       0 r-x--  java\n0000000000600000       4       4       4 rw---  java\n0000000001d3f000    1484    1224    1224 rw---    [ anon ]\n0000003e0a400000     128     112       0 r-x--  ld-2.12.so\n0000003e0a61f000       4       4       4 r----  ld-2.12.so\n0000003e0a620000       4       4       4 rw---  ld-2.12.so\n0000003e0a621000       4       4       4 rw---    [ anon ]\n0000003e0a800000       8       8       0 r-x--  libdl-2.12.so\n0000003e0a802000    2048       0       0 -----  libdl-2.12.so\n0000003e0aa02000       4       4       4 r----  libdl-2.12.so\n0000003e0aa03000       4       4       4 rw---  libdl-2.12.so\n0000003e0ac00000    1576     680       0 r-x--  libc-2.12.so\n0000003e0ad8a000    2048       0       0 -----  libc-2.12.so\n0000003e0af8a000      16      16       8 r----  libc-2.12.so\n0000003e0af8e000       4       4       4 rw---  libc-2.12.so\n0000003e0af8f000      20      20      20 rw---    [ anon ]\n0000003e0b000000      92      72       0 r-x--  libpthread-2.12.so\n0000003e0b017000    2048       0       0 -----  libpthread-2.12.so\n0000003e0b217000       4       4       4 r----  libpthread-2.12.so\n0000003e0b218000       4       4       4 rw---  libpthread-2.12.so\n0000003e0b219000      16       4       4 rw---    [ anon ]\n```\n\n将内存块的内容dump成文件（慎重，会影响服务）\n```\nsudo  gdb --batch --pid 25147 -ex \" dump memory /home/qisheng.li/c.dump 0x00007eefcc000000 0x00007eefcf000000\"\n```\n\n查看文件的内容：\n\n```\n[qisheng.li@xxx.h.cn2 ~]$ view c.dump\n```\n\n{% asset_image  '2017年 09月 05日 星期二 01:34:24 CST.png' %}\n\n这个dump是我在`2017年 09月 05日 星期二 01:34:24 CST`做的，但是内容看起来是tomcat respone的内容，奇怪的是内容的时间是`2017 17:38:18 GMT`，不知道是什么原因导致的，如果你知道，烦请告知。\n\n直接查看堆外的内存块，无疑是最快排查堆外占用的方法，但是内存块的选择非常依赖经验， 我尝试了下，并没有找到问题。\n\n`参考5`中的大神，通过dump内存块，发现是netty使用的`directBuffer`分配的大量64M的内存块。\n\n\n#### JDK8中的 Native Memory Tracker\n\n在启动参数中开启：\n```\n-XX:NativeMemoryTracking=[off | summary | detail]\n```\n也可以在jvm退出的时候，打印相关的统计信息\n>NMT at VM Exit\n>Use the following VM diagnostic command line option to obtain last memory usage data at VM exit when Native Memory Tracking is enabled. The level of detail is based on tracking level.\n```\n-XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics\n```\n在程序运行时可以使用`jcmd`查看内存的分配情况\n```\njcmd <pid> VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]\n```\n\n输出的结果:\n\n```\n\nsudo -u tomcat jcmd `pgrep -f tomcat` VM.native_memory detail\n31549:\n\nNative Memory Tracking:\n\nTotal: reserved=50215227KB, committed=49947839KB\n-                 Java Heap (reserved=46137344KB, committed=46137344KB)\n                            (mmap: reserved=46137344KB, committed=46137344KB) \n \n-                     Class (reserved=92639KB, committed=91707KB)\n                            (classes #14958)\n                            (malloc=2527KB #50184) \n                            (mmap: reserved=90112KB, committed=89180KB) \n \n-                    Thread (reserved=914804KB, committed=914804KB)\n                            (thread #883)\n                            (stack: reserved=906696KB, committed=906696KB)\n                            (malloc=2904KB #4435) \n                            (arena=5203KB #1764)\n \n-                      Code (reserved=263567KB, committed=87223KB)\n                            (malloc=13967KB #19565) \n                            (mmap: reserved=249600KB, committed=73256KB) \n \n-                        GC (reserved=1849937KB, committed=1849937KB)\n                            (malloc=105041KB #121050) \n                            (mmap: reserved=1744896KB, committed=1744896KB) \n \n-                  Compiler (reserved=13354KB, committed=13354KB)\n                            (malloc=3061KB #3484) \n                            (arena=10292KB #13)\n \n-                  Internal (reserved=813935KB, committed=813935KB)\n                            (malloc=813903KB #102254) \n                            (mmap: reserved=32KB, committed=32KB) \n \n-                    Symbol (reserved=18071KB, committed=18071KB)\n                            (malloc=14355KB #138545) \n                            (arena=3716KB #1)\n \n-    Native Memory Tracking (reserved=7274KB, committed=7274KB)\n                            (malloc=298KB #4295) \n                            (tracking overhead=6976KB)\n \n-               Arena Chunk (reserved=14191KB, committed=14191KB)\n                            (malloc=14191KB) \n \n-                   Unknown (reserved=90112KB, committed=0KB)\n                            (mmap: reserved=90112KB, committed=0KB) \n \nVirtual memory map:\n \n[0x00007ef481693000 - 0x00007ef481794000] reserved and committed 1028KB for Thread Stack from\n    [0x00007f0486546f74] JavaThread::run()+0x24\n    [0x00007f04863fab88] java_start(Thread*)+0x108\n \n[0x00007ef481794000 - 0x00007ef481895000] reserved and committed 1028KB for Thread Stack from\n    [0x00007f0486546f74] JavaThread::run()+0x24\n    [0x00007f04863fab88] java_start(Thread*)+0x108\n \n[0x00007ef48224d000 - 0x00007ef48244d000] reserved 2048KB for Class from\n    [0x00007f0486593c66] ReservedSpace::initialize(unsigned long, unsigned long, bool, char*, unsigned long, bool)+0x256\n    [0x00007f0486593d0b] ReservedSpace::ReservedSpace(unsigned long, unsigned long, bool, char*, unsigned long)+0x1b\n    [0x00007f0486379cda] VirtualSpaceNode::VirtualSpaceNode(unsigned long)+0x17a\n    [0x00007f048637a59a] VirtualSpaceList::create_new_virtual_space(unsigned long)+0x5a\n\n\t[0x00007ef48228d000 - 0x00007ef4823cd000] committed 1280KB from\n            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199\n            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76\n            [0x00007f048637a750] VirtualSpaceList::expand_by(unsigned long, unsigned long)+0xf0\n            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3\n\n\t[0x00007ef48224d000 - 0x00007ef48228d000] committed 256KB from\n            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199\n            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76\n            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3\n            [0x00007f048637c432] SpaceManager::grow_and_allocate(unsigned long)+0x2d2\n\n```\n\n{% asset_image memory-mapping.jpg %}\n\n如果通过上述的映射关系能直接找到系统的`StringTable`等对应的分区，dump内存下来应该能很快的发现问题，不知道行不行得通。\n\n\n\n\n## 参考\n\n1. [进程物理内存远大于Xmx的问题分析 - 你假笨](http://lovestblog.cn/blog/2015/08/21/rssxmx/)\n\n2. [JVM源码分析之堆外内存完全解读 - 你假笨](http://lovestblog.cn/blog/2015/05/12/direct-buffer/)\n\n3. [Netty之Java堆外内存扫盲贴 | 江南白衣](http://calvin1978.blogcn.com/articles/directbytebuffer.html)\n\n4. [Java内存之本地内存分析神器： NMT 和 pmap - CSDN博客](http://blog.csdn.net/jicahoo/article/details/50933469)\n\n5. [Java堆外内存排查小结](http://mp.weixin.qq.com/s?__biz=MzA4MTc4NTUxNQ==&mid=2650518452&idx=1&sn=c196bba265f888ed086b7059ca5d3fd2&chksm=8780b470b0f73d66c79b7df96435d48caa8c49a9a6b696e543c0df24e3356202ccde69f2f671&mpshare=1&scene=1&srcid=0831YG589PwShEgNLJ8CKQOp#rd)\n\n6. [Native Memory Tracking](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/nmt-8.html)\n\n7. [Gperftools CPU Profiler](https://gperftools.github.io/gperftools/cpuprofile.html)\n\n8. [Google Perftools Mac OS 安装与使用 | Whosemario的家](http://whosemario.github.io/2016/09/27/google-preftool-1/index.html)","source":"_posts/google-perf-tools.md","raw":"title: 使用google perf工具来排查堆外内存占用\ntags: google-perf\ncategory: perf\ntoc: true\ndate: 2017-12-02 19:24:38\n---\n\n\n## 现象\n\n线上机器内存不足，经常被系统`oom killer`干掉。\n\n如果`tomcat`运行的好好的，突然被干掉了，没有任何线索，那么就可以使用下面的命令看看是不是`oom killer`搞的鬼\n\n```bash\nsudo dmesg | grep -i kill | less\n\nOut of memory: Kill process 23195 (java) score 558 or sacrifice child\nKilled process 23195, UID 40001, (java) total-vm:81176732kB, anon-rss:64507900kB, file-rss:2604kB\n```\n\n其中`anon-rss`是程序占用的物理内存，  64507900kB = 61.519527435302734 GB\n系统总的内存也才`62GB`，linux发现没有可分配的内存，就会启用`oom killer`的机制，根据`oom_score_adj`的值去干掉相应的进程了。\n\n系统上`oom_score_adj`的值\n\n```\n43722 total pagecache pages\n4335 pages in swap cache\nSwap cache stats: add 1009840, delete 1005505, find 76432470/76485037\nFree swap  = 49990420kB\nTotal swap = 50331644kB\n16777215 pages RAM\n282254 pages reserved\n36481 pages shared\n16386140 pages non-shared\n[ pid ]   uid  tgid total_vm      rss cpu oom_adj oom_score_adj name\n[ 1419]     0  1419     2883       94  18     -17         -1000 udevd\n[ 2894]     0  2894     2660      105   6     -17         -1000 udevd\n[ 2895]     0  2895     2882       43   2     -17         -1000 udevd\n[  388]     0   388    16557       63  12     -17         -1000 sshd\n[ 1340]     0  1340   152806     9114   6       0             0 salt-minion\n[ 1341]     0  1341   110173     5224  22       0             0 salt-minion\n[14168]     0 14168     6899      149   6     -17         -1000 auditd\n```\n\n`tomcat`的进程占用内存最多，得分也最高 —— 558\n\n### tomcat的配置\n\n\n```bash\n -Xms44g -Xmx44g -server \\\n-XX:+UseG1GC -XX:MaxGCPauseMillis=200 \\\n-XX:InitiatingHeapOccupancyPercent=65 -XX:SurvivorRatio=8 \\\n-XX:MaxTenuringThreshold=15 \\\n-verbosegc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps \\\n-XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy \\\n-XX:-TraceClassUnloading \\\n-XX:+DisableExplicitGC \n```\n\njvm最大的堆只有44GB， 但是从上面的日志中看到实际占用的内存达到了62GB，几乎把整个系统的内存都吃掉了。\n既然堆内没有问题，问题自然应该出在堆外内存的占用上。\n\n## java 堆外内存\n\n[JVM源码分析之堆外内存完全解读 - 你假笨](http://lovestblog.cn/blog/2015/05/12/direct-buffer/) 中说道：\n\n>对于System.gc的实现，之前写了一篇文章来重点介绍，JVM源码分析之SystemGC完全解读，它会对新生代的老生代都会进行内存回收，这样会比较彻底地回收DirectByteBuffer对象以及他们关联的堆外内存，我们dump内存发现DirectByteBuffer对象本身其实是很小的，但是它后面可能关联了一个非常大的堆外内存，因此我们通常称之为『冰山对象』，我们做ygc的时候会将新生代里的不可达的DirectByteBuffer对象及其堆外内存回收了，但是无法对old里的DirectByteBuffer对象及其堆外内存进行回收，这也是我们通常碰到的最大的问题，如果有大量的DirectByteBuffer对象移到了old，但是又一直没有做cms gc或者full gc，而只进行ygc，那么我们的物理内存可能被慢慢耗光，但是我们还不知道发生了什么，因为heap明明剩余的内存还很多(前提是我们禁用了System.gc)。\n\n白衣大侠也建议：\n\n>这时，就只能靠前面提到的申请额度超限时触发的system.gc()来救场了。但这道最后的保险其实也不很好，首先它会中断整个进程，然后它让当前线程睡了整整一百毫秒，而且如果gc没在一百毫秒内完成，它仍然会无情的抛出OOM异常。还有，万一，万一大家迷信某个调优指南设置了-DisableExplicitGC禁止了system.gc()，那就不好玩了。\n>所以，堆外内存还是自己主动点回收更好，比如Netty就是这么做的。\n\n\n### 限制堆外内存的大小\n\n加上`-XX:MaxDirectMemorySize=4g`， 去除`-XX:+DisableExplicitG`观察了几天，发现并不能解决问题，于是继续使用`google perf tools`去观察下堆外内存的使用\n\n## google perf tools\n\n[下载地址](https://github.com/gperftools/gperftools/tree/master)\n\n### 原理\n\n> 该工具主要利用了unix的一个环境变量LD_PRELOAD，它允许你要加载的动态库优先加载起来，相当于一个Hook了，\n> 于是可以针对同一个函数可以选择不同的动态库里的实现了，比如googleperftools就是将malloc方法替换成了tcmalloc的实现，这样就可以跟踪内存分配路径了\n\n### 使用\n\n`tomcat`的启动变量中加入下面的配置\n```bash\nexport LD_PRELOAD=/usr/local/lib/libtcmalloc.so\nexport HEAPPROFILE=/home/q/perf-result/\nexport HEAP_PROFILE_ALLOCATION_INTERVAL=2000000000\n```\nHEAPPROFILE是存放结果的地址\n\n>HEAP_PROFILE_ALLOCATION_INTERVAL\tdefault: 1073741824 (1 Gb)\tDump heap profiling information once every specified number of bytes has been allocated by the program.\n\n查看运行中的日志:\n```\nDumping heap profile to /home/q/perf-result/_23207.0927.heap (1755151 MB allocated cumulatively, 1267 MB currently in use) \n```\n\n日志中会显示累计的对外内存的分配和当前使用的堆外内存的大小。\n\n### 分析结果\n\n#### 文本形式的\n\n命令：\n```bash\n/usr/local/bin/pprof --text /home/q/java/default/bin/java _23207.0035.heap\n```\n\n输出结果如下：\n\n```\nUsing local file /home/q/java/default/bin/java.\nUsing local file _23207.1012.heap.\nTotal: 1283.1 MB\n\n     0.0   0.0% 100.0%     39.5   3.1% PtrQueue::enqueue_known_active\n     0.0   0.0% 100.0%     39.5   3.1% PtrQueueSet::allocate_buffer\n     0.0   0.0% 100.0%     42.2   3.3% G1ParTask::work\n     0.0   0.0% 100.0%     42.2   3.3% GangWorker::loop\n     0.0   0.0% 100.0%     75.6   5.9% ObjArrayKlass::oop_oop_iterate_nv_m@8fbe80\n     0.0   0.0% 100.0%    146.2  11.4% 0x00007f63bf0e5825\n     0.0   0.0% 100.0%    146.2  11.4% JVM_InternString\n     0.0   0.0% 100.0%    146.2  11.4% StringTable::intern@a24ca0\n     0.0   0.0% 100.0%    147.2  11.5% StringTable::basic_add\n     0.0   0.0% 100.0%    147.3  11.5% StringTable::intern@a24780\n     0.0   0.0% 100.0%    152.4  11.9% Hashtable::new_entry\n     0.0   0.0% 100.0%    170.5  13.3% AllocateHeap\n     0.0   0.0% 100.0%    256.0  20.0% ConcurrentMark::ConcurrentMark\n     0.0   0.0% 100.0%    265.5  20.7% InstanceKlass::oop_oop_iterate_nv\n     0.0   0.0% 100.0%    287.2  22.4% G1CollectedHeap::initialize\n     0.0   0.0% 100.0%    305.4  23.8% Universe::initialize_heap\n     0.0   0.0% 100.0%    306.3  23.9% universe_init\n     0.0   0.0% 100.0%    307.0  23.9% init_globals\n     0.0   0.0% 100.0%    307.1  23.9% JNI_CreateJavaVM\n     0.0   0.0% 100.0%    307.1  23.9% Threads::create_vm\n     0.0   0.0% 100.0%    307.2  23.9% JavaMain\n     0.0   0.0% 100.0%    326.5  25.4% ConcurrentG1RefineThread::run\n     0.0   0.0% 100.0%    326.5  25.4% RefineCardTableEntryClosure::do_card_ptr\n     0.0   0.0% 100.0%    329.8  25.7% 0x00007f63bfae74a7\n     0.0   0.0% 100.0%    348.5  27.2% DirtyCardQueueSet::apply_closure_to_completed_buffer\n     0.0   0.0% 100.0%    349.7  27.3% G1RemSet::refine_card\n     0.0   0.0% 100.0%    349.7  27.3% HeapRegion::oops_on_card_seq_iterate_careful\n     0.0   0.0% 100.0%    349.7  27.3% OtherRegionsTable::add_reference\n     0.0   0.0% 100.0%    351.0  27.4% os::malloc@913e80\n     0.0   0.0% 100.0%    351.0  27.4% Unsafe_AllocateMemory\n     0.0   0.0% 100.0%    408.4  31.8% java_start\n     0.0   0.0% 100.0%    562.6  43.8% BitMap::resize\n     0.0   0.0% 100.0%    598.5  46.6% ArrayAllocator::allocate\n     0.0   0.0% 100.0%    715.5  55.8% __clone\n     0.0   0.0% 100.0%    715.5  55.8% start_thread\n  1277.3  99.5%  99.5%   1277.3  99.5% os::malloc@9137e0\n```\n\n结果代表的含义:\n\n```\nAnalyzing Text Output\n\nText mode has lines of output that look like this:\n\n       14   2.1%  17.2%       58   8.7% std::_Rb_tree::find\nHere is how to interpret the columns:\n\n1. Number of profiling samples in this function\n2. Percentage of profiling samples in this function\n3. Percentage of profiling samples in the functions printed so far\n4. Number of profiling samples in this function and its callees\n5. Percentage of profiling samples in this function and its callees\n6. Function name\n```\n\n[Gperftools CPU Profiler](https://gperftools.github.io/gperftools/cpuprofile.html)中有更加详细的说明\n\n#### pdf形式的结果\n\n相比文字的结果，图片形式的调用关系，更加清楚和直观。\n\n命令如下:\n\n```bash\nsudo yum install ghostscript\nsudo yum install dot\nsudo yum install graphviz -y\nsudo pprof --pdf  /home/q/java/default/bin/java _19877.19793.heap > result.pdf\n```\n\n结果：\n\n{% pdf  result.pdf %}\n\n## 可能的原因\n\n从google perf tools的结果来看主要的堆外内存来自\n\n```\n0x00007f52e05126a5\n0.0 (0.0%)\nof 7089.3 (82.5%)\n```\n\n这个再往上就没有地址了。\n\n### heap 占用\n\n查看出问题机器的`heap`占用情况如下\n\n```\njmap -histo:live `pgrep -f 'tomcat'`\n\n num     #instances         #bytes  class name\n\n----------------------------------------------\n\n   1:      15272979      940261992  [C\n\n   2:      19182959      767318360  java.util.ArrayList\n\n   3:      15397474      739078752  qunar.tc.plato.zeno.util.collections.offheap.map.OffHeapHashMap\n\n   4:      13281544      637514112  java.util.concurrent.ConcurrentHashMap$Node\n\n   5:      10136730      612997544  [Ljava.lang.Object;\n\n   6:      15265576      488498432  java.lang.String\n\n   7:       4694324      413100512  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaSHotelBizInfo\n\n   8:           854      379525944  [Ljava.util.concurrent.ConcurrentHashMap$Node;\n\n   9:      15397474      369539376  qunar.tc.plato.zeno.util.collections.offheap.set.OffHeapHashSet\n\n  10:       4694324      337991328  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaContactConfig\n```\n\n前面的都是去哪儿自己开发的堆外缓存占用的对象，缓存的内容也多是酒店相关的元数据。结合工具的结果，推测问题出在堆外缓存。\n堆外缓存采用的是内存映射的方式，大量使用了`DirectByteBuffer`这种冰山对象。\n\n### 疑点\n\n这个系统目前处于重构阶段，之前也是使用的堆外缓存，并没有出现问题。不过，目前在逐渐下掉堆外缓存的使用，到时候可以再看看是否出问题。\n\n## 杂谈\n\n### 使用pmap查看进程的内存映射\n\n```\nsudo -u tomcat pmap -x  25147 | less\n\nAddress           Kbytes     RSS   Dirty Mode   Mapping\n0000000000400000       4       0       0 r-x--  java\n0000000000600000       4       4       4 rw---  java\n0000000001d3f000    1484    1224    1224 rw---    [ anon ]\n0000003e0a400000     128     112       0 r-x--  ld-2.12.so\n0000003e0a61f000       4       4       4 r----  ld-2.12.so\n0000003e0a620000       4       4       4 rw---  ld-2.12.so\n0000003e0a621000       4       4       4 rw---    [ anon ]\n0000003e0a800000       8       8       0 r-x--  libdl-2.12.so\n0000003e0a802000    2048       0       0 -----  libdl-2.12.so\n0000003e0aa02000       4       4       4 r----  libdl-2.12.so\n0000003e0aa03000       4       4       4 rw---  libdl-2.12.so\n0000003e0ac00000    1576     680       0 r-x--  libc-2.12.so\n0000003e0ad8a000    2048       0       0 -----  libc-2.12.so\n0000003e0af8a000      16      16       8 r----  libc-2.12.so\n0000003e0af8e000       4       4       4 rw---  libc-2.12.so\n0000003e0af8f000      20      20      20 rw---    [ anon ]\n0000003e0b000000      92      72       0 r-x--  libpthread-2.12.so\n0000003e0b017000    2048       0       0 -----  libpthread-2.12.so\n0000003e0b217000       4       4       4 r----  libpthread-2.12.so\n0000003e0b218000       4       4       4 rw---  libpthread-2.12.so\n0000003e0b219000      16       4       4 rw---    [ anon ]\n```\n\n将内存块的内容dump成文件（慎重，会影响服务）\n```\nsudo  gdb --batch --pid 25147 -ex \" dump memory /home/qisheng.li/c.dump 0x00007eefcc000000 0x00007eefcf000000\"\n```\n\n查看文件的内容：\n\n```\n[qisheng.li@xxx.h.cn2 ~]$ view c.dump\n```\n\n{% asset_image  '2017年 09月 05日 星期二 01:34:24 CST.png' %}\n\n这个dump是我在`2017年 09月 05日 星期二 01:34:24 CST`做的，但是内容看起来是tomcat respone的内容，奇怪的是内容的时间是`2017 17:38:18 GMT`，不知道是什么原因导致的，如果你知道，烦请告知。\n\n直接查看堆外的内存块，无疑是最快排查堆外占用的方法，但是内存块的选择非常依赖经验， 我尝试了下，并没有找到问题。\n\n`参考5`中的大神，通过dump内存块，发现是netty使用的`directBuffer`分配的大量64M的内存块。\n\n\n#### JDK8中的 Native Memory Tracker\n\n在启动参数中开启：\n```\n-XX:NativeMemoryTracking=[off | summary | detail]\n```\n也可以在jvm退出的时候，打印相关的统计信息\n>NMT at VM Exit\n>Use the following VM diagnostic command line option to obtain last memory usage data at VM exit when Native Memory Tracking is enabled. The level of detail is based on tracking level.\n```\n-XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics\n```\n在程序运行时可以使用`jcmd`查看内存的分配情况\n```\njcmd <pid> VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]\n```\n\n输出的结果:\n\n```\n\nsudo -u tomcat jcmd `pgrep -f tomcat` VM.native_memory detail\n31549:\n\nNative Memory Tracking:\n\nTotal: reserved=50215227KB, committed=49947839KB\n-                 Java Heap (reserved=46137344KB, committed=46137344KB)\n                            (mmap: reserved=46137344KB, committed=46137344KB) \n \n-                     Class (reserved=92639KB, committed=91707KB)\n                            (classes #14958)\n                            (malloc=2527KB #50184) \n                            (mmap: reserved=90112KB, committed=89180KB) \n \n-                    Thread (reserved=914804KB, committed=914804KB)\n                            (thread #883)\n                            (stack: reserved=906696KB, committed=906696KB)\n                            (malloc=2904KB #4435) \n                            (arena=5203KB #1764)\n \n-                      Code (reserved=263567KB, committed=87223KB)\n                            (malloc=13967KB #19565) \n                            (mmap: reserved=249600KB, committed=73256KB) \n \n-                        GC (reserved=1849937KB, committed=1849937KB)\n                            (malloc=105041KB #121050) \n                            (mmap: reserved=1744896KB, committed=1744896KB) \n \n-                  Compiler (reserved=13354KB, committed=13354KB)\n                            (malloc=3061KB #3484) \n                            (arena=10292KB #13)\n \n-                  Internal (reserved=813935KB, committed=813935KB)\n                            (malloc=813903KB #102254) \n                            (mmap: reserved=32KB, committed=32KB) \n \n-                    Symbol (reserved=18071KB, committed=18071KB)\n                            (malloc=14355KB #138545) \n                            (arena=3716KB #1)\n \n-    Native Memory Tracking (reserved=7274KB, committed=7274KB)\n                            (malloc=298KB #4295) \n                            (tracking overhead=6976KB)\n \n-               Arena Chunk (reserved=14191KB, committed=14191KB)\n                            (malloc=14191KB) \n \n-                   Unknown (reserved=90112KB, committed=0KB)\n                            (mmap: reserved=90112KB, committed=0KB) \n \nVirtual memory map:\n \n[0x00007ef481693000 - 0x00007ef481794000] reserved and committed 1028KB for Thread Stack from\n    [0x00007f0486546f74] JavaThread::run()+0x24\n    [0x00007f04863fab88] java_start(Thread*)+0x108\n \n[0x00007ef481794000 - 0x00007ef481895000] reserved and committed 1028KB for Thread Stack from\n    [0x00007f0486546f74] JavaThread::run()+0x24\n    [0x00007f04863fab88] java_start(Thread*)+0x108\n \n[0x00007ef48224d000 - 0x00007ef48244d000] reserved 2048KB for Class from\n    [0x00007f0486593c66] ReservedSpace::initialize(unsigned long, unsigned long, bool, char*, unsigned long, bool)+0x256\n    [0x00007f0486593d0b] ReservedSpace::ReservedSpace(unsigned long, unsigned long, bool, char*, unsigned long)+0x1b\n    [0x00007f0486379cda] VirtualSpaceNode::VirtualSpaceNode(unsigned long)+0x17a\n    [0x00007f048637a59a] VirtualSpaceList::create_new_virtual_space(unsigned long)+0x5a\n\n\t[0x00007ef48228d000 - 0x00007ef4823cd000] committed 1280KB from\n            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199\n            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76\n            [0x00007f048637a750] VirtualSpaceList::expand_by(unsigned long, unsigned long)+0xf0\n            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3\n\n\t[0x00007ef48224d000 - 0x00007ef48228d000] committed 256KB from\n            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199\n            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76\n            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3\n            [0x00007f048637c432] SpaceManager::grow_and_allocate(unsigned long)+0x2d2\n\n```\n\n{% asset_image memory-mapping.jpg %}\n\n如果通过上述的映射关系能直接找到系统的`StringTable`等对应的分区，dump内存下来应该能很快的发现问题，不知道行不行得通。\n\n\n\n\n## 参考\n\n1. [进程物理内存远大于Xmx的问题分析 - 你假笨](http://lovestblog.cn/blog/2015/08/21/rssxmx/)\n\n2. [JVM源码分析之堆外内存完全解读 - 你假笨](http://lovestblog.cn/blog/2015/05/12/direct-buffer/)\n\n3. [Netty之Java堆外内存扫盲贴 | 江南白衣](http://calvin1978.blogcn.com/articles/directbytebuffer.html)\n\n4. [Java内存之本地内存分析神器： NMT 和 pmap - CSDN博客](http://blog.csdn.net/jicahoo/article/details/50933469)\n\n5. [Java堆外内存排查小结](http://mp.weixin.qq.com/s?__biz=MzA4MTc4NTUxNQ==&mid=2650518452&idx=1&sn=c196bba265f888ed086b7059ca5d3fd2&chksm=8780b470b0f73d66c79b7df96435d48caa8c49a9a6b696e543c0df24e3356202ccde69f2f671&mpshare=1&scene=1&srcid=0831YG589PwShEgNLJ8CKQOp#rd)\n\n6. [Native Memory Tracking](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/nmt-8.html)\n\n7. [Gperftools CPU Profiler](https://gperftools.github.io/gperftools/cpuprofile.html)\n\n8. [Google Perftools Mac OS 安装与使用 | Whosemario的家](http://whosemario.github.io/2016/09/27/google-preftool-1/index.html)","slug":"google-perf-tools","published":1,"updated":"2017-12-02T11:24:38.257Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd97005zjh4kbe0xku6a","content":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>线上机器内存不足，经常被系统<code>oom killer</code>干掉。</p>\n<p>如果<code>tomcat</code>运行的好好的，突然被干掉了，没有任何线索，那么就可以使用下面的命令看看是不是<code>oom killer</code>搞的鬼</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dmesg | grep -i <span class=\"built_in\">kill</span> | less</span><br><span class=\"line\"></span><br><span class=\"line\">Out of memory: Kill process 23195 (java) score 558 or sacrifice child</span><br><span class=\"line\">Killed process 23195, UID 40001, (java) total-vm:81176732kB, anon-rss:64507900kB, file-rss:2604kB</span><br></pre></td></tr></table></figure>\n<p>其中<code>anon-rss</code>是程序占用的物理内存，  64507900kB = 61.519527435302734 GB<br>系统总的内存也才<code>62GB</code>，linux发现没有可分配的内存，就会启用<code>oom killer</code>的机制，根据<code>oom_score_adj</code>的值去干掉相应的进程了。</p>\n<p>系统上<code>oom_score_adj</code>的值</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">43722 total pagecache pages</span><br><span class=\"line\">4335 pages in swap cache</span><br><span class=\"line\">Swap cache stats: add 1009840, delete 1005505, find 76432470/76485037</span><br><span class=\"line\">Free swap  = 49990420kB</span><br><span class=\"line\">Total swap = 50331644kB</span><br><span class=\"line\">16777215 pages RAM</span><br><span class=\"line\">282254 pages reserved</span><br><span class=\"line\">36481 pages shared</span><br><span class=\"line\">16386140 pages non-shared</span><br><span class=\"line\">[ pid ]   uid  tgid total_vm      rss cpu oom_adj oom_score_adj name</span><br><span class=\"line\">[ 1419]     0  1419     2883       94  18     -17         -1000 udevd</span><br><span class=\"line\">[ 2894]     0  2894     2660      105   6     -17         -1000 udevd</span><br><span class=\"line\">[ 2895]     0  2895     2882       43   2     -17         -1000 udevd</span><br><span class=\"line\">[  388]     0   388    16557       63  12     -17         -1000 sshd</span><br><span class=\"line\">[ 1340]     0  1340   152806     9114   6       0             0 salt-minion</span><br><span class=\"line\">[ 1341]     0  1341   110173     5224  22       0             0 salt-minion</span><br><span class=\"line\">[14168]     0 14168     6899      149   6     -17         -1000 auditd</span><br></pre></td></tr></table></figure>\n<p><code>tomcat</code>的进程占用内存最多，得分也最高 —— 558</p>\n<h3 id=\"tomcat的配置\"><a href=\"#tomcat的配置\" class=\"headerlink\" title=\"tomcat的配置\"></a>tomcat的配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> -Xms44g -Xmx44g -server \\</span><br><span class=\"line\">-XX:+UseG1GC -XX:MaxGCPauseMillis=200 \\</span><br><span class=\"line\">-XX:InitiatingHeapOccupancyPercent=65 -XX:SurvivorRatio=8 \\</span><br><span class=\"line\">-XX:MaxTenuringThreshold=15 \\</span><br><span class=\"line\">-verbosegc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps \\</span><br><span class=\"line\">-XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy \\</span><br><span class=\"line\">-XX:-TraceClassUnloading \\</span><br><span class=\"line\">-XX:+DisableExplicitGC</span><br></pre></td></tr></table></figure>\n<p>jvm最大的堆只有44GB， 但是从上面的日志中看到实际占用的内存达到了62GB，几乎把整个系统的内存都吃掉了。<br>既然堆内没有问题，问题自然应该出在堆外内存的占用上。</p>\n<h2 id=\"java-堆外内存\"><a href=\"#java-堆外内存\" class=\"headerlink\" title=\"java 堆外内存\"></a>java 堆外内存</h2><p><a href=\"http://lovestblog.cn/blog/2015/05/12/direct-buffer/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM源码分析之堆外内存完全解读 - 你假笨</a> 中说道：</p>\n<blockquote>\n<p>对于System.gc的实现，之前写了一篇文章来重点介绍，JVM源码分析之SystemGC完全解读，它会对新生代的老生代都会进行内存回收，这样会比较彻底地回收DirectByteBuffer对象以及他们关联的堆外内存，我们dump内存发现DirectByteBuffer对象本身其实是很小的，但是它后面可能关联了一个非常大的堆外内存，因此我们通常称之为『冰山对象』，我们做ygc的时候会将新生代里的不可达的DirectByteBuffer对象及其堆外内存回收了，但是无法对old里的DirectByteBuffer对象及其堆外内存进行回收，这也是我们通常碰到的最大的问题，如果有大量的DirectByteBuffer对象移到了old，但是又一直没有做cms gc或者full gc，而只进行ygc，那么我们的物理内存可能被慢慢耗光，但是我们还不知道发生了什么，因为heap明明剩余的内存还很多(前提是我们禁用了System.gc)。</p>\n</blockquote>\n<p>白衣大侠也建议：</p>\n<blockquote>\n<p>这时，就只能靠前面提到的申请额度超限时触发的system.gc()来救场了。但这道最后的保险其实也不很好，首先它会中断整个进程，然后它让当前线程睡了整整一百毫秒，而且如果gc没在一百毫秒内完成，它仍然会无情的抛出OOM异常。还有，万一，万一大家迷信某个调优指南设置了-DisableExplicitGC禁止了system.gc()，那就不好玩了。<br>所以，堆外内存还是自己主动点回收更好，比如Netty就是这么做的。</p>\n</blockquote>\n<h3 id=\"限制堆外内存的大小\"><a href=\"#限制堆外内存的大小\" class=\"headerlink\" title=\"限制堆外内存的大小\"></a>限制堆外内存的大小</h3><p>加上<code>-XX:MaxDirectMemorySize=4g</code>， 去除<code>-XX:+DisableExplicitG</code>观察了几天，发现并不能解决问题，于是继续使用<code>google perf tools</code>去观察下堆外内存的使用</p>\n<h2 id=\"google-perf-tools\"><a href=\"#google-perf-tools\" class=\"headerlink\" title=\"google perf tools\"></a>google perf tools</h2><p><a href=\"https://github.com/gperftools/gperftools/tree/master\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">下载地址</a></p>\n<h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><blockquote>\n<p>该工具主要利用了unix的一个环境变量LD_PRELOAD，它允许你要加载的动态库优先加载起来，相当于一个Hook了，<br>于是可以针对同一个函数可以选择不同的动态库里的实现了，比如googleperftools就是将malloc方法替换成了tcmalloc的实现，这样就可以跟踪内存分配路径了</p>\n</blockquote>\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><p><code>tomcat</code>的启动变量中加入下面的配置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> LD_PRELOAD=/usr/<span class=\"built_in\">local</span>/lib/libtcmalloc.so</span><br><span class=\"line\"><span class=\"built_in\">export</span> HEAPPROFILE=/home/q/perf-result/</span><br><span class=\"line\"><span class=\"built_in\">export</span> HEAP_PROFILE_ALLOCATION_INTERVAL=2000000000</span><br></pre></td></tr></table></figure></p>\n<p>HEAPPROFILE是存放结果的地址</p>\n<blockquote>\n<p>HEAP_PROFILE_ALLOCATION_INTERVAL    default: 1073741824 (1 Gb)    Dump heap profiling information once every specified number of bytes has been allocated by the program.</p>\n</blockquote>\n<p>查看运行中的日志:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Dumping heap profile to /home/q/perf-result/_23207.0927.heap (1755151 MB allocated cumulatively, 1267 MB currently in use)</span><br></pre></td></tr></table></figure></p>\n<p>日志中会显示累计的对外内存的分配和当前使用的堆外内存的大小。</p>\n<h3 id=\"分析结果\"><a href=\"#分析结果\" class=\"headerlink\" title=\"分析结果\"></a>分析结果</h3><h4 id=\"文本形式的\"><a href=\"#文本形式的\" class=\"headerlink\" title=\"文本形式的\"></a>文本形式的</h4><p>命令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/<span class=\"built_in\">local</span>/bin/pprof --text /home/q/java/default/bin/java _23207.0035.heap</span><br></pre></td></tr></table></figure></p>\n<p>输出结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Using local file /home/q/java/default/bin/java.</span><br><span class=\"line\">Using local file _23207.1012.heap.</span><br><span class=\"line\">Total: 1283.1 MB</span><br><span class=\"line\"></span><br><span class=\"line\">     0.0   0.0% 100.0%     39.5   3.1% PtrQueue::enqueue_known_active</span><br><span class=\"line\">     0.0   0.0% 100.0%     39.5   3.1% PtrQueueSet::allocate_buffer</span><br><span class=\"line\">     0.0   0.0% 100.0%     42.2   3.3% G1ParTask::work</span><br><span class=\"line\">     0.0   0.0% 100.0%     42.2   3.3% GangWorker::loop</span><br><span class=\"line\">     0.0   0.0% 100.0%     75.6   5.9% ObjArrayKlass::oop_oop_iterate_nv_m@8fbe80</span><br><span class=\"line\">     0.0   0.0% 100.0%    146.2  11.4% 0x00007f63bf0e5825</span><br><span class=\"line\">     0.0   0.0% 100.0%    146.2  11.4% JVM_InternString</span><br><span class=\"line\">     0.0   0.0% 100.0%    146.2  11.4% StringTable::intern@a24ca0</span><br><span class=\"line\">     0.0   0.0% 100.0%    147.2  11.5% StringTable::basic_add</span><br><span class=\"line\">     0.0   0.0% 100.0%    147.3  11.5% StringTable::intern@a24780</span><br><span class=\"line\">     0.0   0.0% 100.0%    152.4  11.9% Hashtable::new_entry</span><br><span class=\"line\">     0.0   0.0% 100.0%    170.5  13.3% AllocateHeap</span><br><span class=\"line\">     0.0   0.0% 100.0%    256.0  20.0% ConcurrentMark::ConcurrentMark</span><br><span class=\"line\">     0.0   0.0% 100.0%    265.5  20.7% InstanceKlass::oop_oop_iterate_nv</span><br><span class=\"line\">     0.0   0.0% 100.0%    287.2  22.4% G1CollectedHeap::initialize</span><br><span class=\"line\">     0.0   0.0% 100.0%    305.4  23.8% Universe::initialize_heap</span><br><span class=\"line\">     0.0   0.0% 100.0%    306.3  23.9% universe_init</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.0  23.9% init_globals</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.1  23.9% JNI_CreateJavaVM</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.1  23.9% Threads::create_vm</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.2  23.9% JavaMain</span><br><span class=\"line\">     0.0   0.0% 100.0%    326.5  25.4% ConcurrentG1RefineThread::run</span><br><span class=\"line\">     0.0   0.0% 100.0%    326.5  25.4% RefineCardTableEntryClosure::do_card_ptr</span><br><span class=\"line\">     0.0   0.0% 100.0%    329.8  25.7% 0x00007f63bfae74a7</span><br><span class=\"line\">     0.0   0.0% 100.0%    348.5  27.2% DirtyCardQueueSet::apply_closure_to_completed_buffer</span><br><span class=\"line\">     0.0   0.0% 100.0%    349.7  27.3% G1RemSet::refine_card</span><br><span class=\"line\">     0.0   0.0% 100.0%    349.7  27.3% HeapRegion::oops_on_card_seq_iterate_careful</span><br><span class=\"line\">     0.0   0.0% 100.0%    349.7  27.3% OtherRegionsTable::add_reference</span><br><span class=\"line\">     0.0   0.0% 100.0%    351.0  27.4% os::malloc@913e80</span><br><span class=\"line\">     0.0   0.0% 100.0%    351.0  27.4% Unsafe_AllocateMemory</span><br><span class=\"line\">     0.0   0.0% 100.0%    408.4  31.8% java_start</span><br><span class=\"line\">     0.0   0.0% 100.0%    562.6  43.8% BitMap::resize</span><br><span class=\"line\">     0.0   0.0% 100.0%    598.5  46.6% ArrayAllocator::allocate</span><br><span class=\"line\">     0.0   0.0% 100.0%    715.5  55.8% __clone</span><br><span class=\"line\">     0.0   0.0% 100.0%    715.5  55.8% start_thread</span><br><span class=\"line\">  1277.3  99.5%  99.5%   1277.3  99.5% os::malloc@9137e0</span><br></pre></td></tr></table></figure>\n<p>结果代表的含义:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Analyzing Text Output</span><br><span class=\"line\"></span><br><span class=\"line\">Text mode has lines of output that look like this:</span><br><span class=\"line\"></span><br><span class=\"line\">       14   2.1%  17.2%       58   8.7% std::_Rb_tree::find</span><br><span class=\"line\">Here is how to interpret the columns:</span><br><span class=\"line\"></span><br><span class=\"line\">1. Number of profiling samples in this function</span><br><span class=\"line\">2. Percentage of profiling samples in this function</span><br><span class=\"line\">3. Percentage of profiling samples in the functions printed so far</span><br><span class=\"line\">4. Number of profiling samples in this function and its callees</span><br><span class=\"line\">5. Percentage of profiling samples in this function and its callees</span><br><span class=\"line\">6. Function name</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://gperftools.github.io/gperftools/cpuprofile.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Gperftools CPU Profiler</a>中有更加详细的说明</p>\n<h4 id=\"pdf形式的结果\"><a href=\"#pdf形式的结果\" class=\"headerlink\" title=\"pdf形式的结果\"></a>pdf形式的结果</h4><p>相比文字的结果，图片形式的调用关系，更加清楚和直观。</p>\n<p>命令如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install ghostscript</span><br><span class=\"line\">sudo yum install dot</span><br><span class=\"line\">sudo yum install graphviz -y</span><br><span class=\"line\">sudo pprof --pdf  /home/q/java/default/bin/java _19877.19793.heap &gt; result.pdf</span><br></pre></td></tr></table></figure>\n<p>结果：</p>\n\n\n\t<div class=\"row\">\n    <embed src=\"result.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n<h2 id=\"可能的原因\"><a href=\"#可能的原因\" class=\"headerlink\" title=\"可能的原因\"></a>可能的原因</h2><p>从google perf tools的结果来看主要的堆外内存来自</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x00007f52e05126a5</span><br><span class=\"line\">0.0 (0.0%)</span><br><span class=\"line\">of 7089.3 (82.5%)</span><br></pre></td></tr></table></figure>\n<p>这个再往上就没有地址了。</p>\n<h3 id=\"heap-占用\"><a href=\"#heap-占用\" class=\"headerlink\" title=\"heap 占用\"></a>heap 占用</h3><p>查看出问题机器的<code>heap</code>占用情况如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jmap -histo:live `pgrep -f &apos;tomcat&apos;`</span><br><span class=\"line\"></span><br><span class=\"line\"> num     #instances         #bytes  class name</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">   1:      15272979      940261992  [C</span><br><span class=\"line\"></span><br><span class=\"line\">   2:      19182959      767318360  java.util.ArrayList</span><br><span class=\"line\"></span><br><span class=\"line\">   3:      15397474      739078752  qunar.tc.plato.zeno.util.collections.offheap.map.OffHeapHashMap</span><br><span class=\"line\"></span><br><span class=\"line\">   4:      13281544      637514112  java.util.concurrent.ConcurrentHashMap$Node</span><br><span class=\"line\"></span><br><span class=\"line\">   5:      10136730      612997544  [Ljava.lang.Object;</span><br><span class=\"line\"></span><br><span class=\"line\">   6:      15265576      488498432  java.lang.String</span><br><span class=\"line\"></span><br><span class=\"line\">   7:       4694324      413100512  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaSHotelBizInfo</span><br><span class=\"line\"></span><br><span class=\"line\">   8:           854      379525944  [Ljava.util.concurrent.ConcurrentHashMap$Node;</span><br><span class=\"line\"></span><br><span class=\"line\">   9:      15397474      369539376  qunar.tc.plato.zeno.util.collections.offheap.set.OffHeapHashSet</span><br><span class=\"line\"></span><br><span class=\"line\">  10:       4694324      337991328  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaContactConfig</span><br></pre></td></tr></table></figure>\n<p>前面的都是去哪儿自己开发的堆外缓存占用的对象，缓存的内容也多是酒店相关的元数据。结合工具的结果，推测问题出在堆外缓存。<br>堆外缓存采用的是内存映射的方式，大量使用了<code>DirectByteBuffer</code>这种冰山对象。</p>\n<h3 id=\"疑点\"><a href=\"#疑点\" class=\"headerlink\" title=\"疑点\"></a>疑点</h3><p>这个系统目前处于重构阶段，之前也是使用的堆外缓存，并没有出现问题。不过，目前在逐渐下掉堆外缓存的使用，到时候可以再看看是否出问题。</p>\n<h2 id=\"杂谈\"><a href=\"#杂谈\" class=\"headerlink\" title=\"杂谈\"></a>杂谈</h2><h3 id=\"使用pmap查看进程的内存映射\"><a href=\"#使用pmap查看进程的内存映射\" class=\"headerlink\" title=\"使用pmap查看进程的内存映射\"></a>使用pmap查看进程的内存映射</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat pmap -x  25147 | less</span><br><span class=\"line\"></span><br><span class=\"line\">Address           Kbytes     RSS   Dirty Mode   Mapping</span><br><span class=\"line\">0000000000400000       4       0       0 r-x--  java</span><br><span class=\"line\">0000000000600000       4       4       4 rw---  java</span><br><span class=\"line\">0000000001d3f000    1484    1224    1224 rw---    [ anon ]</span><br><span class=\"line\">0000003e0a400000     128     112       0 r-x--  ld-2.12.so</span><br><span class=\"line\">0000003e0a61f000       4       4       4 r----  ld-2.12.so</span><br><span class=\"line\">0000003e0a620000       4       4       4 rw---  ld-2.12.so</span><br><span class=\"line\">0000003e0a621000       4       4       4 rw---    [ anon ]</span><br><span class=\"line\">0000003e0a800000       8       8       0 r-x--  libdl-2.12.so</span><br><span class=\"line\">0000003e0a802000    2048       0       0 -----  libdl-2.12.so</span><br><span class=\"line\">0000003e0aa02000       4       4       4 r----  libdl-2.12.so</span><br><span class=\"line\">0000003e0aa03000       4       4       4 rw---  libdl-2.12.so</span><br><span class=\"line\">0000003e0ac00000    1576     680       0 r-x--  libc-2.12.so</span><br><span class=\"line\">0000003e0ad8a000    2048       0       0 -----  libc-2.12.so</span><br><span class=\"line\">0000003e0af8a000      16      16       8 r----  libc-2.12.so</span><br><span class=\"line\">0000003e0af8e000       4       4       4 rw---  libc-2.12.so</span><br><span class=\"line\">0000003e0af8f000      20      20      20 rw---    [ anon ]</span><br><span class=\"line\">0000003e0b000000      92      72       0 r-x--  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b017000    2048       0       0 -----  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b217000       4       4       4 r----  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b218000       4       4       4 rw---  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b219000      16       4       4 rw---    [ anon ]</span><br></pre></td></tr></table></figure>\n<p>将内存块的内容dump成文件（慎重，会影响服务）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo  gdb --batch --pid 25147 -ex &quot; dump memory /home/qisheng.li/c.dump 0x00007eefcc000000 0x00007eefcf000000&quot;</span><br></pre></td></tr></table></figure></p>\n<p>查看文件的内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx.h.cn2 ~]$ view c.dump</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/12/02/google-perf-tools/2017年%2009月%2005日%20星期二%2001:34:24%20CST.png\">\n<p>这个dump是我在<code>2017年 09月 05日 星期二 01:34:24 CST</code>做的，但是内容看起来是tomcat respone的内容，奇怪的是内容的时间是<code>2017 17:38:18 GMT</code>，不知道是什么原因导致的，如果你知道，烦请告知。</p>\n<p>直接查看堆外的内存块，无疑是最快排查堆外占用的方法，但是内存块的选择非常依赖经验， 我尝试了下，并没有找到问题。</p>\n<p><code>参考5</code>中的大神，通过dump内存块，发现是netty使用的<code>directBuffer</code>分配的大量64M的内存块。</p>\n<h4 id=\"JDK8中的-Native-Memory-Tracker\"><a href=\"#JDK8中的-Native-Memory-Tracker\" class=\"headerlink\" title=\"JDK8中的 Native Memory Tracker\"></a>JDK8中的 Native Memory Tracker</h4><p>在启动参数中开启：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:NativeMemoryTracking=[off | summary | detail]</span><br></pre></td></tr></table></figure></p>\n<p>也可以在jvm退出的时候，打印相关的统计信息</p>\n<blockquote>\n<p>NMT at VM Exit<br>Use the following VM diagnostic command line option to obtain last memory usage data at VM exit when Native Memory Tracking is enabled. The level of detail is based on tracking level.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>在程序运行时可以使用<code>jcmd</code>查看内存的分配情况<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]</span><br></pre></td></tr></table></figure></p>\n<p>输出的结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">sudo -u tomcat jcmd `pgrep -f tomcat` VM.native_memory detail</span><br><span class=\"line\">31549:</span><br><span class=\"line\"></span><br><span class=\"line\">Native Memory Tracking:</span><br><span class=\"line\"></span><br><span class=\"line\">Total: reserved=50215227KB, committed=49947839KB</span><br><span class=\"line\">-                 Java Heap (reserved=46137344KB, committed=46137344KB)</span><br><span class=\"line\">                            (mmap: reserved=46137344KB, committed=46137344KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                     Class (reserved=92639KB, committed=91707KB)</span><br><span class=\"line\">                            (classes #14958)</span><br><span class=\"line\">                            (malloc=2527KB #50184) </span><br><span class=\"line\">                            (mmap: reserved=90112KB, committed=89180KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                    Thread (reserved=914804KB, committed=914804KB)</span><br><span class=\"line\">                            (thread #883)</span><br><span class=\"line\">                            (stack: reserved=906696KB, committed=906696KB)</span><br><span class=\"line\">                            (malloc=2904KB #4435) </span><br><span class=\"line\">                            (arena=5203KB #1764)</span><br><span class=\"line\"> </span><br><span class=\"line\">-                      Code (reserved=263567KB, committed=87223KB)</span><br><span class=\"line\">                            (malloc=13967KB #19565) </span><br><span class=\"line\">                            (mmap: reserved=249600KB, committed=73256KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                        GC (reserved=1849937KB, committed=1849937KB)</span><br><span class=\"line\">                            (malloc=105041KB #121050) </span><br><span class=\"line\">                            (mmap: reserved=1744896KB, committed=1744896KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                  Compiler (reserved=13354KB, committed=13354KB)</span><br><span class=\"line\">                            (malloc=3061KB #3484) </span><br><span class=\"line\">                            (arena=10292KB #13)</span><br><span class=\"line\"> </span><br><span class=\"line\">-                  Internal (reserved=813935KB, committed=813935KB)</span><br><span class=\"line\">                            (malloc=813903KB #102254) </span><br><span class=\"line\">                            (mmap: reserved=32KB, committed=32KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                    Symbol (reserved=18071KB, committed=18071KB)</span><br><span class=\"line\">                            (malloc=14355KB #138545) </span><br><span class=\"line\">                            (arena=3716KB #1)</span><br><span class=\"line\"> </span><br><span class=\"line\">-    Native Memory Tracking (reserved=7274KB, committed=7274KB)</span><br><span class=\"line\">                            (malloc=298KB #4295) </span><br><span class=\"line\">                            (tracking overhead=6976KB)</span><br><span class=\"line\"> </span><br><span class=\"line\">-               Arena Chunk (reserved=14191KB, committed=14191KB)</span><br><span class=\"line\">                            (malloc=14191KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                   Unknown (reserved=90112KB, committed=0KB)</span><br><span class=\"line\">                            (mmap: reserved=90112KB, committed=0KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">Virtual memory map:</span><br><span class=\"line\"> </span><br><span class=\"line\">[0x00007ef481693000 - 0x00007ef481794000] reserved and committed 1028KB for Thread Stack from</span><br><span class=\"line\">    [0x00007f0486546f74] JavaThread::run()+0x24</span><br><span class=\"line\">    [0x00007f04863fab88] java_start(Thread*)+0x108</span><br><span class=\"line\"> </span><br><span class=\"line\">[0x00007ef481794000 - 0x00007ef481895000] reserved and committed 1028KB for Thread Stack from</span><br><span class=\"line\">    [0x00007f0486546f74] JavaThread::run()+0x24</span><br><span class=\"line\">    [0x00007f04863fab88] java_start(Thread*)+0x108</span><br><span class=\"line\"> </span><br><span class=\"line\">[0x00007ef48224d000 - 0x00007ef48244d000] reserved 2048KB for Class from</span><br><span class=\"line\">    [0x00007f0486593c66] ReservedSpace::initialize(unsigned long, unsigned long, bool, char*, unsigned long, bool)+0x256</span><br><span class=\"line\">    [0x00007f0486593d0b] ReservedSpace::ReservedSpace(unsigned long, unsigned long, bool, char*, unsigned long)+0x1b</span><br><span class=\"line\">    [0x00007f0486379cda] VirtualSpaceNode::VirtualSpaceNode(unsigned long)+0x17a</span><br><span class=\"line\">    [0x00007f048637a59a] VirtualSpaceList::create_new_virtual_space(unsigned long)+0x5a</span><br><span class=\"line\"></span><br><span class=\"line\">\t[0x00007ef48228d000 - 0x00007ef4823cd000] committed 1280KB from</span><br><span class=\"line\">            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199</span><br><span class=\"line\">            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76</span><br><span class=\"line\">            [0x00007f048637a750] VirtualSpaceList::expand_by(unsigned long, unsigned long)+0xf0</span><br><span class=\"line\">            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3</span><br><span class=\"line\"></span><br><span class=\"line\">\t[0x00007ef48224d000 - 0x00007ef48228d000] committed 256KB from</span><br><span class=\"line\">            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199</span><br><span class=\"line\">            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76</span><br><span class=\"line\">            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3</span><br><span class=\"line\">            [0x00007f048637c432] SpaceManager::grow_and_allocate(unsigned long)+0x2d2</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/12/02/google-perf-tools/memory-mapping.jpg\">\n<p>如果通过上述的映射关系能直接找到系统的<code>StringTable</code>等对应的分区，dump内存下来应该能很快的发现问题，不知道行不行得通。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://lovestblog.cn/blog/2015/08/21/rssxmx/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">进程物理内存远大于Xmx的问题分析 - 你假笨</a></p>\n</li>\n<li><p><a href=\"http://lovestblog.cn/blog/2015/05/12/direct-buffer/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM源码分析之堆外内存完全解读 - 你假笨</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/directbytebuffer.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Netty之Java堆外内存扫盲贴 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/jicahoo/article/details/50933469\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java内存之本地内存分析神器： NMT 和 pmap - CSDN博客</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzA4MTc4NTUxNQ==&amp;mid=2650518452&amp;idx=1&amp;sn=c196bba265f888ed086b7059ca5d3fd2&amp;chksm=8780b470b0f73d66c79b7df96435d48caa8c49a9a6b696e543c0df24e3356202ccde69f2f671&amp;mpshare=1&amp;scene=1&amp;srcid=0831YG589PwShEgNLJ8CKQOp#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java堆外内存排查小结</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/nmt-8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Native Memory Tracking</a></p>\n</li>\n<li><p><a href=\"https://gperftools.github.io/gperftools/cpuprofile.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Gperftools CPU Profiler</a></p>\n</li>\n<li><p><a href=\"http://whosemario.github.io/2016/09/27/google-preftool-1/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Google Perftools Mac OS 安装与使用 | Whosemario的家</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>线上机器内存不足，经常被系统<code>oom killer</code>干掉。</p>\n<p>如果<code>tomcat</code>运行的好好的，突然被干掉了，没有任何线索，那么就可以使用下面的命令看看是不是<code>oom killer</code>搞的鬼</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dmesg | grep -i <span class=\"built_in\">kill</span> | less</span><br><span class=\"line\"></span><br><span class=\"line\">Out of memory: Kill process 23195 (java) score 558 or sacrifice child</span><br><span class=\"line\">Killed process 23195, UID 40001, (java) total-vm:81176732kB, anon-rss:64507900kB, file-rss:2604kB</span><br></pre></td></tr></table></figure>\n<p>其中<code>anon-rss</code>是程序占用的物理内存，  64507900kB = 61.519527435302734 GB<br>系统总的内存也才<code>62GB</code>，linux发现没有可分配的内存，就会启用<code>oom killer</code>的机制，根据<code>oom_score_adj</code>的值去干掉相应的进程了。</p>\n<p>系统上<code>oom_score_adj</code>的值</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">43722 total pagecache pages</span><br><span class=\"line\">4335 pages in swap cache</span><br><span class=\"line\">Swap cache stats: add 1009840, delete 1005505, find 76432470/76485037</span><br><span class=\"line\">Free swap  = 49990420kB</span><br><span class=\"line\">Total swap = 50331644kB</span><br><span class=\"line\">16777215 pages RAM</span><br><span class=\"line\">282254 pages reserved</span><br><span class=\"line\">36481 pages shared</span><br><span class=\"line\">16386140 pages non-shared</span><br><span class=\"line\">[ pid ]   uid  tgid total_vm      rss cpu oom_adj oom_score_adj name</span><br><span class=\"line\">[ 1419]     0  1419     2883       94  18     -17         -1000 udevd</span><br><span class=\"line\">[ 2894]     0  2894     2660      105   6     -17         -1000 udevd</span><br><span class=\"line\">[ 2895]     0  2895     2882       43   2     -17         -1000 udevd</span><br><span class=\"line\">[  388]     0   388    16557       63  12     -17         -1000 sshd</span><br><span class=\"line\">[ 1340]     0  1340   152806     9114   6       0             0 salt-minion</span><br><span class=\"line\">[ 1341]     0  1341   110173     5224  22       0             0 salt-minion</span><br><span class=\"line\">[14168]     0 14168     6899      149   6     -17         -1000 auditd</span><br></pre></td></tr></table></figure>\n<p><code>tomcat</code>的进程占用内存最多，得分也最高 —— 558</p>\n<h3 id=\"tomcat的配置\"><a href=\"#tomcat的配置\" class=\"headerlink\" title=\"tomcat的配置\"></a>tomcat的配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> -Xms44g -Xmx44g -server \\</span><br><span class=\"line\">-XX:+UseG1GC -XX:MaxGCPauseMillis=200 \\</span><br><span class=\"line\">-XX:InitiatingHeapOccupancyPercent=65 -XX:SurvivorRatio=8 \\</span><br><span class=\"line\">-XX:MaxTenuringThreshold=15 \\</span><br><span class=\"line\">-verbosegc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps \\</span><br><span class=\"line\">-XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy \\</span><br><span class=\"line\">-XX:-TraceClassUnloading \\</span><br><span class=\"line\">-XX:+DisableExplicitGC</span><br></pre></td></tr></table></figure>\n<p>jvm最大的堆只有44GB， 但是从上面的日志中看到实际占用的内存达到了62GB，几乎把整个系统的内存都吃掉了。<br>既然堆内没有问题，问题自然应该出在堆外内存的占用上。</p>\n<h2 id=\"java-堆外内存\"><a href=\"#java-堆外内存\" class=\"headerlink\" title=\"java 堆外内存\"></a>java 堆外内存</h2><p><a href=\"http://lovestblog.cn/blog/2015/05/12/direct-buffer/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM源码分析之堆外内存完全解读 - 你假笨</a> 中说道：</p>\n<blockquote>\n<p>对于System.gc的实现，之前写了一篇文章来重点介绍，JVM源码分析之SystemGC完全解读，它会对新生代的老生代都会进行内存回收，这样会比较彻底地回收DirectByteBuffer对象以及他们关联的堆外内存，我们dump内存发现DirectByteBuffer对象本身其实是很小的，但是它后面可能关联了一个非常大的堆外内存，因此我们通常称之为『冰山对象』，我们做ygc的时候会将新生代里的不可达的DirectByteBuffer对象及其堆外内存回收了，但是无法对old里的DirectByteBuffer对象及其堆外内存进行回收，这也是我们通常碰到的最大的问题，如果有大量的DirectByteBuffer对象移到了old，但是又一直没有做cms gc或者full gc，而只进行ygc，那么我们的物理内存可能被慢慢耗光，但是我们还不知道发生了什么，因为heap明明剩余的内存还很多(前提是我们禁用了System.gc)。</p>\n</blockquote>\n<p>白衣大侠也建议：</p>\n<blockquote>\n<p>这时，就只能靠前面提到的申请额度超限时触发的system.gc()来救场了。但这道最后的保险其实也不很好，首先它会中断整个进程，然后它让当前线程睡了整整一百毫秒，而且如果gc没在一百毫秒内完成，它仍然会无情的抛出OOM异常。还有，万一，万一大家迷信某个调优指南设置了-DisableExplicitGC禁止了system.gc()，那就不好玩了。<br>所以，堆外内存还是自己主动点回收更好，比如Netty就是这么做的。</p>\n</blockquote>\n<h3 id=\"限制堆外内存的大小\"><a href=\"#限制堆外内存的大小\" class=\"headerlink\" title=\"限制堆外内存的大小\"></a>限制堆外内存的大小</h3><p>加上<code>-XX:MaxDirectMemorySize=4g</code>， 去除<code>-XX:+DisableExplicitG</code>观察了几天，发现并不能解决问题，于是继续使用<code>google perf tools</code>去观察下堆外内存的使用</p>\n<h2 id=\"google-perf-tools\"><a href=\"#google-perf-tools\" class=\"headerlink\" title=\"google perf tools\"></a>google perf tools</h2><p><a href=\"https://github.com/gperftools/gperftools/tree/master\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">下载地址</a></p>\n<h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><blockquote>\n<p>该工具主要利用了unix的一个环境变量LD_PRELOAD，它允许你要加载的动态库优先加载起来，相当于一个Hook了，<br>于是可以针对同一个函数可以选择不同的动态库里的实现了，比如googleperftools就是将malloc方法替换成了tcmalloc的实现，这样就可以跟踪内存分配路径了</p>\n</blockquote>\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><p><code>tomcat</code>的启动变量中加入下面的配置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> LD_PRELOAD=/usr/<span class=\"built_in\">local</span>/lib/libtcmalloc.so</span><br><span class=\"line\"><span class=\"built_in\">export</span> HEAPPROFILE=/home/q/perf-result/</span><br><span class=\"line\"><span class=\"built_in\">export</span> HEAP_PROFILE_ALLOCATION_INTERVAL=2000000000</span><br></pre></td></tr></table></figure></p>\n<p>HEAPPROFILE是存放结果的地址</p>\n<blockquote>\n<p>HEAP_PROFILE_ALLOCATION_INTERVAL    default: 1073741824 (1 Gb)    Dump heap profiling information once every specified number of bytes has been allocated by the program.</p>\n</blockquote>\n<p>查看运行中的日志:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Dumping heap profile to /home/q/perf-result/_23207.0927.heap (1755151 MB allocated cumulatively, 1267 MB currently in use)</span><br></pre></td></tr></table></figure></p>\n<p>日志中会显示累计的对外内存的分配和当前使用的堆外内存的大小。</p>\n<h3 id=\"分析结果\"><a href=\"#分析结果\" class=\"headerlink\" title=\"分析结果\"></a>分析结果</h3><h4 id=\"文本形式的\"><a href=\"#文本形式的\" class=\"headerlink\" title=\"文本形式的\"></a>文本形式的</h4><p>命令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/<span class=\"built_in\">local</span>/bin/pprof --text /home/q/java/default/bin/java _23207.0035.heap</span><br></pre></td></tr></table></figure></p>\n<p>输出结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Using local file /home/q/java/default/bin/java.</span><br><span class=\"line\">Using local file _23207.1012.heap.</span><br><span class=\"line\">Total: 1283.1 MB</span><br><span class=\"line\"></span><br><span class=\"line\">     0.0   0.0% 100.0%     39.5   3.1% PtrQueue::enqueue_known_active</span><br><span class=\"line\">     0.0   0.0% 100.0%     39.5   3.1% PtrQueueSet::allocate_buffer</span><br><span class=\"line\">     0.0   0.0% 100.0%     42.2   3.3% G1ParTask::work</span><br><span class=\"line\">     0.0   0.0% 100.0%     42.2   3.3% GangWorker::loop</span><br><span class=\"line\">     0.0   0.0% 100.0%     75.6   5.9% ObjArrayKlass::oop_oop_iterate_nv_m@8fbe80</span><br><span class=\"line\">     0.0   0.0% 100.0%    146.2  11.4% 0x00007f63bf0e5825</span><br><span class=\"line\">     0.0   0.0% 100.0%    146.2  11.4% JVM_InternString</span><br><span class=\"line\">     0.0   0.0% 100.0%    146.2  11.4% StringTable::intern@a24ca0</span><br><span class=\"line\">     0.0   0.0% 100.0%    147.2  11.5% StringTable::basic_add</span><br><span class=\"line\">     0.0   0.0% 100.0%    147.3  11.5% StringTable::intern@a24780</span><br><span class=\"line\">     0.0   0.0% 100.0%    152.4  11.9% Hashtable::new_entry</span><br><span class=\"line\">     0.0   0.0% 100.0%    170.5  13.3% AllocateHeap</span><br><span class=\"line\">     0.0   0.0% 100.0%    256.0  20.0% ConcurrentMark::ConcurrentMark</span><br><span class=\"line\">     0.0   0.0% 100.0%    265.5  20.7% InstanceKlass::oop_oop_iterate_nv</span><br><span class=\"line\">     0.0   0.0% 100.0%    287.2  22.4% G1CollectedHeap::initialize</span><br><span class=\"line\">     0.0   0.0% 100.0%    305.4  23.8% Universe::initialize_heap</span><br><span class=\"line\">     0.0   0.0% 100.0%    306.3  23.9% universe_init</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.0  23.9% init_globals</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.1  23.9% JNI_CreateJavaVM</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.1  23.9% Threads::create_vm</span><br><span class=\"line\">     0.0   0.0% 100.0%    307.2  23.9% JavaMain</span><br><span class=\"line\">     0.0   0.0% 100.0%    326.5  25.4% ConcurrentG1RefineThread::run</span><br><span class=\"line\">     0.0   0.0% 100.0%    326.5  25.4% RefineCardTableEntryClosure::do_card_ptr</span><br><span class=\"line\">     0.0   0.0% 100.0%    329.8  25.7% 0x00007f63bfae74a7</span><br><span class=\"line\">     0.0   0.0% 100.0%    348.5  27.2% DirtyCardQueueSet::apply_closure_to_completed_buffer</span><br><span class=\"line\">     0.0   0.0% 100.0%    349.7  27.3% G1RemSet::refine_card</span><br><span class=\"line\">     0.0   0.0% 100.0%    349.7  27.3% HeapRegion::oops_on_card_seq_iterate_careful</span><br><span class=\"line\">     0.0   0.0% 100.0%    349.7  27.3% OtherRegionsTable::add_reference</span><br><span class=\"line\">     0.0   0.0% 100.0%    351.0  27.4% os::malloc@913e80</span><br><span class=\"line\">     0.0   0.0% 100.0%    351.0  27.4% Unsafe_AllocateMemory</span><br><span class=\"line\">     0.0   0.0% 100.0%    408.4  31.8% java_start</span><br><span class=\"line\">     0.0   0.0% 100.0%    562.6  43.8% BitMap::resize</span><br><span class=\"line\">     0.0   0.0% 100.0%    598.5  46.6% ArrayAllocator::allocate</span><br><span class=\"line\">     0.0   0.0% 100.0%    715.5  55.8% __clone</span><br><span class=\"line\">     0.0   0.0% 100.0%    715.5  55.8% start_thread</span><br><span class=\"line\">  1277.3  99.5%  99.5%   1277.3  99.5% os::malloc@9137e0</span><br></pre></td></tr></table></figure>\n<p>结果代表的含义:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Analyzing Text Output</span><br><span class=\"line\"></span><br><span class=\"line\">Text mode has lines of output that look like this:</span><br><span class=\"line\"></span><br><span class=\"line\">       14   2.1%  17.2%       58   8.7% std::_Rb_tree::find</span><br><span class=\"line\">Here is how to interpret the columns:</span><br><span class=\"line\"></span><br><span class=\"line\">1. Number of profiling samples in this function</span><br><span class=\"line\">2. Percentage of profiling samples in this function</span><br><span class=\"line\">3. Percentage of profiling samples in the functions printed so far</span><br><span class=\"line\">4. Number of profiling samples in this function and its callees</span><br><span class=\"line\">5. Percentage of profiling samples in this function and its callees</span><br><span class=\"line\">6. Function name</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://gperftools.github.io/gperftools/cpuprofile.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Gperftools CPU Profiler</a>中有更加详细的说明</p>\n<h4 id=\"pdf形式的结果\"><a href=\"#pdf形式的结果\" class=\"headerlink\" title=\"pdf形式的结果\"></a>pdf形式的结果</h4><p>相比文字的结果，图片形式的调用关系，更加清楚和直观。</p>\n<p>命令如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install ghostscript</span><br><span class=\"line\">sudo yum install dot</span><br><span class=\"line\">sudo yum install graphviz -y</span><br><span class=\"line\">sudo pprof --pdf  /home/q/java/default/bin/java _19877.19793.heap &gt; result.pdf</span><br></pre></td></tr></table></figure>\n<p>结果：</p>\n\n\n\t<div class=\"row\">\n    <embed src=\"result.pdf\" width=\"100%\" height=\"550\" type=\"application/pdf\">\n\t</div>\n\n\n\n<h2 id=\"可能的原因\"><a href=\"#可能的原因\" class=\"headerlink\" title=\"可能的原因\"></a>可能的原因</h2><p>从google perf tools的结果来看主要的堆外内存来自</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x00007f52e05126a5</span><br><span class=\"line\">0.0 (0.0%)</span><br><span class=\"line\">of 7089.3 (82.5%)</span><br></pre></td></tr></table></figure>\n<p>这个再往上就没有地址了。</p>\n<h3 id=\"heap-占用\"><a href=\"#heap-占用\" class=\"headerlink\" title=\"heap 占用\"></a>heap 占用</h3><p>查看出问题机器的<code>heap</code>占用情况如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jmap -histo:live `pgrep -f &apos;tomcat&apos;`</span><br><span class=\"line\"></span><br><span class=\"line\"> num     #instances         #bytes  class name</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">   1:      15272979      940261992  [C</span><br><span class=\"line\"></span><br><span class=\"line\">   2:      19182959      767318360  java.util.ArrayList</span><br><span class=\"line\"></span><br><span class=\"line\">   3:      15397474      739078752  qunar.tc.plato.zeno.util.collections.offheap.map.OffHeapHashMap</span><br><span class=\"line\"></span><br><span class=\"line\">   4:      13281544      637514112  java.util.concurrent.ConcurrentHashMap$Node</span><br><span class=\"line\"></span><br><span class=\"line\">   5:      10136730      612997544  [Ljava.lang.Object;</span><br><span class=\"line\"></span><br><span class=\"line\">   6:      15265576      488498432  java.lang.String</span><br><span class=\"line\"></span><br><span class=\"line\">   7:       4694324      413100512  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaSHotelBizInfo</span><br><span class=\"line\"></span><br><span class=\"line\">   8:           854      379525944  [Ljava.util.concurrent.ConcurrentHashMap$Node;</span><br><span class=\"line\"></span><br><span class=\"line\">   9:      15397474      369539376  qunar.tc.plato.zeno.util.collections.offheap.set.OffHeapHashSet</span><br><span class=\"line\"></span><br><span class=\"line\">  10:       4694324      337991328  _plato.com.qunar.hotel.price.data.center.plato.beans.shotel.IMetaContactConfig</span><br></pre></td></tr></table></figure>\n<p>前面的都是去哪儿自己开发的堆外缓存占用的对象，缓存的内容也多是酒店相关的元数据。结合工具的结果，推测问题出在堆外缓存。<br>堆外缓存采用的是内存映射的方式，大量使用了<code>DirectByteBuffer</code>这种冰山对象。</p>\n<h3 id=\"疑点\"><a href=\"#疑点\" class=\"headerlink\" title=\"疑点\"></a>疑点</h3><p>这个系统目前处于重构阶段，之前也是使用的堆外缓存，并没有出现问题。不过，目前在逐渐下掉堆外缓存的使用，到时候可以再看看是否出问题。</p>\n<h2 id=\"杂谈\"><a href=\"#杂谈\" class=\"headerlink\" title=\"杂谈\"></a>杂谈</h2><h3 id=\"使用pmap查看进程的内存映射\"><a href=\"#使用pmap查看进程的内存映射\" class=\"headerlink\" title=\"使用pmap查看进程的内存映射\"></a>使用pmap查看进程的内存映射</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat pmap -x  25147 | less</span><br><span class=\"line\"></span><br><span class=\"line\">Address           Kbytes     RSS   Dirty Mode   Mapping</span><br><span class=\"line\">0000000000400000       4       0       0 r-x--  java</span><br><span class=\"line\">0000000000600000       4       4       4 rw---  java</span><br><span class=\"line\">0000000001d3f000    1484    1224    1224 rw---    [ anon ]</span><br><span class=\"line\">0000003e0a400000     128     112       0 r-x--  ld-2.12.so</span><br><span class=\"line\">0000003e0a61f000       4       4       4 r----  ld-2.12.so</span><br><span class=\"line\">0000003e0a620000       4       4       4 rw---  ld-2.12.so</span><br><span class=\"line\">0000003e0a621000       4       4       4 rw---    [ anon ]</span><br><span class=\"line\">0000003e0a800000       8       8       0 r-x--  libdl-2.12.so</span><br><span class=\"line\">0000003e0a802000    2048       0       0 -----  libdl-2.12.so</span><br><span class=\"line\">0000003e0aa02000       4       4       4 r----  libdl-2.12.so</span><br><span class=\"line\">0000003e0aa03000       4       4       4 rw---  libdl-2.12.so</span><br><span class=\"line\">0000003e0ac00000    1576     680       0 r-x--  libc-2.12.so</span><br><span class=\"line\">0000003e0ad8a000    2048       0       0 -----  libc-2.12.so</span><br><span class=\"line\">0000003e0af8a000      16      16       8 r----  libc-2.12.so</span><br><span class=\"line\">0000003e0af8e000       4       4       4 rw---  libc-2.12.so</span><br><span class=\"line\">0000003e0af8f000      20      20      20 rw---    [ anon ]</span><br><span class=\"line\">0000003e0b000000      92      72       0 r-x--  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b017000    2048       0       0 -----  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b217000       4       4       4 r----  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b218000       4       4       4 rw---  libpthread-2.12.so</span><br><span class=\"line\">0000003e0b219000      16       4       4 rw---    [ anon ]</span><br></pre></td></tr></table></figure>\n<p>将内存块的内容dump成文件（慎重，会影响服务）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo  gdb --batch --pid 25147 -ex &quot; dump memory /home/qisheng.li/c.dump 0x00007eefcc000000 0x00007eefcf000000&quot;</span><br></pre></td></tr></table></figure></p>\n<p>查看文件的内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx.h.cn2 ~]$ view c.dump</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/12/02/google-perf-tools/2017年%2009月%2005日%20星期二%2001:34:24%20CST.png\">\n<p>这个dump是我在<code>2017年 09月 05日 星期二 01:34:24 CST</code>做的，但是内容看起来是tomcat respone的内容，奇怪的是内容的时间是<code>2017 17:38:18 GMT</code>，不知道是什么原因导致的，如果你知道，烦请告知。</p>\n<p>直接查看堆外的内存块，无疑是最快排查堆外占用的方法，但是内存块的选择非常依赖经验， 我尝试了下，并没有找到问题。</p>\n<p><code>参考5</code>中的大神，通过dump内存块，发现是netty使用的<code>directBuffer</code>分配的大量64M的内存块。</p>\n<h4 id=\"JDK8中的-Native-Memory-Tracker\"><a href=\"#JDK8中的-Native-Memory-Tracker\" class=\"headerlink\" title=\"JDK8中的 Native Memory Tracker\"></a>JDK8中的 Native Memory Tracker</h4><p>在启动参数中开启：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:NativeMemoryTracking=[off | summary | detail]</span><br></pre></td></tr></table></figure></p>\n<p>也可以在jvm退出的时候，打印相关的统计信息</p>\n<blockquote>\n<p>NMT at VM Exit<br>Use the following VM diagnostic command line option to obtain last memory usage data at VM exit when Native Memory Tracking is enabled. The level of detail is based on tracking level.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>在程序运行时可以使用<code>jcmd</code>查看内存的分配情况<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]</span><br></pre></td></tr></table></figure></p>\n<p>输出的结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">sudo -u tomcat jcmd `pgrep -f tomcat` VM.native_memory detail</span><br><span class=\"line\">31549:</span><br><span class=\"line\"></span><br><span class=\"line\">Native Memory Tracking:</span><br><span class=\"line\"></span><br><span class=\"line\">Total: reserved=50215227KB, committed=49947839KB</span><br><span class=\"line\">-                 Java Heap (reserved=46137344KB, committed=46137344KB)</span><br><span class=\"line\">                            (mmap: reserved=46137344KB, committed=46137344KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                     Class (reserved=92639KB, committed=91707KB)</span><br><span class=\"line\">                            (classes #14958)</span><br><span class=\"line\">                            (malloc=2527KB #50184) </span><br><span class=\"line\">                            (mmap: reserved=90112KB, committed=89180KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                    Thread (reserved=914804KB, committed=914804KB)</span><br><span class=\"line\">                            (thread #883)</span><br><span class=\"line\">                            (stack: reserved=906696KB, committed=906696KB)</span><br><span class=\"line\">                            (malloc=2904KB #4435) </span><br><span class=\"line\">                            (arena=5203KB #1764)</span><br><span class=\"line\"> </span><br><span class=\"line\">-                      Code (reserved=263567KB, committed=87223KB)</span><br><span class=\"line\">                            (malloc=13967KB #19565) </span><br><span class=\"line\">                            (mmap: reserved=249600KB, committed=73256KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                        GC (reserved=1849937KB, committed=1849937KB)</span><br><span class=\"line\">                            (malloc=105041KB #121050) </span><br><span class=\"line\">                            (mmap: reserved=1744896KB, committed=1744896KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                  Compiler (reserved=13354KB, committed=13354KB)</span><br><span class=\"line\">                            (malloc=3061KB #3484) </span><br><span class=\"line\">                            (arena=10292KB #13)</span><br><span class=\"line\"> </span><br><span class=\"line\">-                  Internal (reserved=813935KB, committed=813935KB)</span><br><span class=\"line\">                            (malloc=813903KB #102254) </span><br><span class=\"line\">                            (mmap: reserved=32KB, committed=32KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                    Symbol (reserved=18071KB, committed=18071KB)</span><br><span class=\"line\">                            (malloc=14355KB #138545) </span><br><span class=\"line\">                            (arena=3716KB #1)</span><br><span class=\"line\"> </span><br><span class=\"line\">-    Native Memory Tracking (reserved=7274KB, committed=7274KB)</span><br><span class=\"line\">                            (malloc=298KB #4295) </span><br><span class=\"line\">                            (tracking overhead=6976KB)</span><br><span class=\"line\"> </span><br><span class=\"line\">-               Arena Chunk (reserved=14191KB, committed=14191KB)</span><br><span class=\"line\">                            (malloc=14191KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">-                   Unknown (reserved=90112KB, committed=0KB)</span><br><span class=\"line\">                            (mmap: reserved=90112KB, committed=0KB) </span><br><span class=\"line\"> </span><br><span class=\"line\">Virtual memory map:</span><br><span class=\"line\"> </span><br><span class=\"line\">[0x00007ef481693000 - 0x00007ef481794000] reserved and committed 1028KB for Thread Stack from</span><br><span class=\"line\">    [0x00007f0486546f74] JavaThread::run()+0x24</span><br><span class=\"line\">    [0x00007f04863fab88] java_start(Thread*)+0x108</span><br><span class=\"line\"> </span><br><span class=\"line\">[0x00007ef481794000 - 0x00007ef481895000] reserved and committed 1028KB for Thread Stack from</span><br><span class=\"line\">    [0x00007f0486546f74] JavaThread::run()+0x24</span><br><span class=\"line\">    [0x00007f04863fab88] java_start(Thread*)+0x108</span><br><span class=\"line\"> </span><br><span class=\"line\">[0x00007ef48224d000 - 0x00007ef48244d000] reserved 2048KB for Class from</span><br><span class=\"line\">    [0x00007f0486593c66] ReservedSpace::initialize(unsigned long, unsigned long, bool, char*, unsigned long, bool)+0x256</span><br><span class=\"line\">    [0x00007f0486593d0b] ReservedSpace::ReservedSpace(unsigned long, unsigned long, bool, char*, unsigned long)+0x1b</span><br><span class=\"line\">    [0x00007f0486379cda] VirtualSpaceNode::VirtualSpaceNode(unsigned long)+0x17a</span><br><span class=\"line\">    [0x00007f048637a59a] VirtualSpaceList::create_new_virtual_space(unsigned long)+0x5a</span><br><span class=\"line\"></span><br><span class=\"line\">\t[0x00007ef48228d000 - 0x00007ef4823cd000] committed 1280KB from</span><br><span class=\"line\">            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199</span><br><span class=\"line\">            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76</span><br><span class=\"line\">            [0x00007f048637a750] VirtualSpaceList::expand_by(unsigned long, unsigned long)+0xf0</span><br><span class=\"line\">            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3</span><br><span class=\"line\"></span><br><span class=\"line\">\t[0x00007ef48224d000 - 0x00007ef48228d000] committed 256KB from</span><br><span class=\"line\">            [0x00007f0486593549] VirtualSpace::expand_by(unsigned long, bool)+0x199</span><br><span class=\"line\">            [0x00007f0486377936] VirtualSpaceList::expand_node_by(VirtualSpaceNode*, unsigned long, unsigned long)+0x76</span><br><span class=\"line\">            [0x00007f048637a8e3] VirtualSpaceList::get_new_chunk(unsigned long, unsigned long, unsigned long)+0xb3</span><br><span class=\"line\">            [0x00007f048637c432] SpaceManager::grow_and_allocate(unsigned long)+0x2d2</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/12/02/google-perf-tools/memory-mapping.jpg\">\n<p>如果通过上述的映射关系能直接找到系统的<code>StringTable</code>等对应的分区，dump内存下来应该能很快的发现问题，不知道行不行得通。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://lovestblog.cn/blog/2015/08/21/rssxmx/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">进程物理内存远大于Xmx的问题分析 - 你假笨</a></p>\n</li>\n<li><p><a href=\"http://lovestblog.cn/blog/2015/05/12/direct-buffer/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM源码分析之堆外内存完全解读 - 你假笨</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/directbytebuffer.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Netty之Java堆外内存扫盲贴 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/jicahoo/article/details/50933469\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java内存之本地内存分析神器： NMT 和 pmap - CSDN博客</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzA4MTc4NTUxNQ==&amp;mid=2650518452&amp;idx=1&amp;sn=c196bba265f888ed086b7059ca5d3fd2&amp;chksm=8780b470b0f73d66c79b7df96435d48caa8c49a9a6b696e543c0df24e3356202ccde69f2f671&amp;mpshare=1&amp;scene=1&amp;srcid=0831YG589PwShEgNLJ8CKQOp#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java堆外内存排查小结</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/nmt-8.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Native Memory Tracking</a></p>\n</li>\n<li><p><a href=\"https://gperftools.github.io/gperftools/cpuprofile.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Gperftools CPU Profiler</a></p>\n</li>\n<li><p><a href=\"http://whosemario.github.io/2016/09/27/google-preftool-1/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Google Perftools Mac OS 安装与使用 | Whosemario的家</a></p>\n</li>\n</ol>\n"},{"title":"greys启动分析","toc":true,"date":"2018-04-01T17:31:53.000Z","_content":"\n\n# greys 简介\n\ngreys的使用参见链接： {% post_link greys %}\n\n# greys.sh\n\n一般使用greys时，启动命令如下：\n\n```bash\nsudo -u tomcat -H ./greys.sh [pid]\n```\n\n`greys.sh`的最后一行`main \"${@}\"`将命令行的所有参数都传给了main函数， 看main函数的实现：\n\n```bash\n    while getopts \"PUJC\" ARG\n    do\n        case ${ARG} in\n            P) OPTION_CHECK_PERMISSION=0;;\n            U) OPTION_UPDATE_IF_NECESSARY=0;;\n            J) OPTION_ATTACH_JVM=0;;\n            C) OPTION_ACTIVE_CONSOLE=0;;\n            ?) usage;exit 1;;\n        esac\n    done\n```\n\n首先脚本使用`getopts`来获取命令行的参数， 指定解析`-P`、`-U`、`-J`、`-C`这几个参数，设置一些flag。\n注意下case语句中的`？`， 代表无法识别的命令行参数, 这时就打印出help，然后退出程序：\n\n>The GNU getopt command uses the GNU getopt() library function to do the parsing of the arguments and options.\n\n>If getopt() does not recognize an option character, it prints an error message to stderr, stores the character in optopt, and returns ?. The calling program may prevent the error message by setting opterr to 0.\n\n然后greys.sh这个脚本会检查greys的版本是否有更新， 除了检查更新就是`attach jvm`和`active console`：\n\n```bash\n    if [[ ${OPTION_ATTACH_JVM} -eq 1 ]]; then\n        attach_jvm ${greys_local_version}\\\n            || exit_on_err 1 \"attach to target jvm(${TARGET_PID}) failed.\"\n    fi\n\n    if [[ ${OPTION_ACTIVE_CONSOLE} -eq 1 ]]; then\n        active_console ${greys_local_version}\\\n            || exit_on_err 1 \"active console failed.\"\n    fi\n```\n\n`${OPTION_ATTACH_JVM}`和`${OPTION_ACTIVE_CONSOLE}`的默认值都是1：\n\n```bash\n\n# the option to control greys.sh attach target jvm\nOPTION_ATTACH_JVM=1\n\n# the option to control greys.sh active greys-console\nOPTION_ACTIVE_CONSOLE=1\n```\n\n\n# attach jvm分析\n\n```bash\nattach_jvm()\n{\n    local greys_lib_dir=${GREYS_LIB_DIR}/${1}/greys\n\n    # if [ ${TARGET_IP} = ${DEFAULT_TARGET_IP} ]; then\n    if [ ! -z ${TARGET_PID} ]; then\n        ${JAVA_HOME}/bin/java \\\n            ${BOOT_CLASSPATH} ${JVM_OPTS} \\\n            -jar ${greys_lib_dir}/greys-core.jar \\\n                -pid ${TARGET_PID} \\\n                -target ${TARGET_IP}\":\"${TARGET_PORT} \\\n                -core \"${greys_lib_dir}/greys-core.jar\" \\\n                -agent \"${greys_lib_dir}/greys-agent.jar\"\n    fi\n}\n```\n\nattach jvm这个函数，就是调用 greys-core这个jar包，  jar包执行时会调用指定的`Main-Class`的的main方法。\n`Main-Class`在`META-INF`中指定， 查看文件的内容:\n\n```bash\n➜  greys  unzip -q -c greys-core.jar  META-INF/MANIFEST.MF\nManifest-Version: 1.0\nArchiver-Version: Plexus Archiver\nCreated-By: Apache Maven\nBuilt-By: vlinux\nBuild-Jdk: 1.8.0_91\nMain-Class: com.github.ompc.greys.core.GreysLauncher\n```\n\n因此执行这个jar包后，会调用`GreysLauncher`的main方法。\n\n## attach到jvm过程\n\n`GreysLauncher`在main函数中做了两件事情，一是解析命令行配置， 二是attach到具体的jvm上。\n\n```java\n    public static void main(String[] args) {\n        try {\n            new GreysLauncher(args);\n        } catch (Throwable t) {\n            System.err.println(\"start greys failed, because : \" + getCauseMessage(t));\n            System.exit(-1);\n        }\n    }\n\n    public GreysLauncher(String[] args) throws Exception {\n\n        // 解析配置文件\n        Configure configure = analyzeConfigure(args);\n\n        // 加载agent\n        attachAgent(configure);\n    }\n```\n\n配置文件就是脚本中指定的参数，主要有如下字段：\n\n```java\n    private String targetIp;                // 目标主机IP\n    private int targetPort;                 // 目标进程号\n    private int javaPid;                    // 对方java进程号\n    private int connectTimeout = 6000;      // 连接超时时间(ms)\n    private String greysCore;               // greys-core.jar的位置\n    private String greysAgent;              // greys-agent.jar的位置\n```\n\n### attach原理\n\n{% asset_img  attach.jpg jps实现原理 %}\n\n我们在用`jstack`命令查看jvm的线程dump的时候，经常看到这两个进程，一个是`\"Signal Dispatcher\"`, 另外一个是`\"Attach Listener\"`;\n这两个线程就和attach功能密切相关。\n\n```\n\"Signal Dispatcher\" #4 daemon prio=9 os_prio=0 tid=0x00007f23b80d2800 nid=0xb82e runnable [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"Attach Listener\" #28 daemon prio=9 os_prio=0 tid=0x00007f2328001000 nid=0x3bb5 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n```\n\n`Signal Dispatcher`负责响应`SIGQUIT`, 并创建 `Attach Listener`。`Attach Listener`负责建立通信，执行相应的命令。\n\nattach jvm就是根据`com.sun.tools.attach.VirtualMachine`的接口提供的方法——`attach`和`loadAgent`\n\n### GreysLauncher\n\n```java\n  Object vmObj = null;\n        try {\n            if (null == attachVmdObj) { // 使用 attach(String pid) 这种方式\n                vmObj = vmClass.getMethod(\"attach\", String.class).invoke(null, \"\" + configure.getJavaPid());\n            } else {\n                vmObj = vmClass.getMethod(\"attach\", vmdClass).invoke(null, attachVmdObj);\n            }\n            vmClass.getMethod(\"loadAgent\", String.class, String.class).invoke(vmObj, configure.getGreysAgent(), configure.getGreysCore() + \";\" + configure.toString());\n        } finally {\n            if (null != vmObj) {\n                vmClass.getMethod(\"detach\", (Class<?>[]) null).invoke(vmObj, (Object[]) null);\n            }\n        }\n```\n\n通过上面的代码， `greys-core.jar`和`greys-agent.jar`这两个jar包就被引入到了jvm\n\n> The loadAgent method is used to load agents that are written in the Java Language and deployed in a JAR file. (See java.lang.instrument for a detailed description on how these agents are loaded and started).\n\n`loadAgent`会将`greys-core.jar`和`greys-agent.jar`两个jar包引入进来。jar包引入后会从`/META-INF/MANIFEST.MF`中读取配置的agent类。\n\n## agent启动过程\n\nagent有两种启动方式，一种再jvm启动的时候一起启动， 一种是动态的attach到一个运行的jvm上。\n\n### 随启动参数启动\n\n以agent形式启动需要在jvm启动参数添加：\n\n```\n    -javaagent:btrace-agent.jar\n```\n\n这种加载方式需要实现下面两个接口中的一个：\n\n```java\n/**\n * JVM先尝试调用这个方法\n */\npublic static void premain(String agentArgs, Instrumentation inst);\n/**\n * 如果上面的方法不存在，则尝试调用这个方法\n */\npublic static void premain(String agentArgs);\n```\n\n同时必须在`MANIFEST.MF`中包含`Premain-Class`指定对应的类。\n\n\n### 动态attach的方式启动\n\nattach形式需要实现下面的两个接口\n\n```java\n/**\n * 首先尝试调用这个方法\n */\npublic static void agentmain(String agentArgs, Instrumentation inst);\n\n\n/**\n * 上面的方法不存在，会尝试调用这个方法\n */\npublic static void agentmain(String agentArgs);\n```\n\n同时在Jar包中必须指定 `Agent-Class`, 因此当此jar包被加载时，jvm会从`/META-INF/MANIFEST.MF`中读取配置的`Premain-Class`和`Agent-Class`, `greys-agent`的信息显示如下：\n\n```xml\nManifest-Version: 1.0\nArchiver-Version: Plexus Archiver\nCreated-By: Apache Maven\nBuilt-By: vlinux\nBuild-Jdk: 1.8.0_91\nAgent-Class: com.github.ompc.greys.agent.AgentLauncher\nCan-Redefine-Classes: true\nCan-Retransform-Classes: true\nPremain-Class: com.github.ompc.greys.agent.AgentLauncher\n```\n\n因此入口定位在`AgentLauncher`。\n\n### AgentLauncher\n\n`AgentLauncher`的主要完成了一下的功能：\n    - 自定义类加载器，减少对现有工程的侵蚀\n    - 启动一个`GaServer`监听指定的端口\n\n`GaServer`读取用户的输入的命令， 将命令交给`CommandHandler`在新的线程中进行具体的处理。\n\n# active console分析\n\n```bash\n# active console\n# $1 : greys_local_version\nactive_console()\n{\n\n    local greys_lib_dir=${GREYS_LIB_DIR}/${1}/greys\n\n    if type ${JAVA_HOME}/bin/java 2>&1 >> /dev/null; then\n\n        # use default console\n        ${JAVA_HOME}/bin/java \\\n            -cp ${greys_lib_dir}/greys-core.jar \\\n            com.github.ompc.greys.core.GreysConsole \\\n                ${TARGET_IP} \\\n                ${TARGET_PORT}\n\n    elif type telnet 2>&1 >> /dev/null; then\n\n        # use telnet\n        telnet ${TARGET_IP} ${TARGET_PORT}\n\n    elif type nc 2>&1 >> /dev/null; then\n\n        # use netcat\n        nc ${TARGET_IP} ${TARGET_PORT}\n\n    else\n\n        echo \"'telnet' or 'nc' is required.\" 1>&2\n        return 1\n\n    fi\n}\n```\n\n`active console`主要是启动一个客户端， 它对不同的方式做了判断; 以java方式启动的会执行`greys-core.jar`的`GreysConsole`\n的main方法：\n\n```java\n    public static void main(String... args) throws IOException {\n        new GreysConsole(new InetSocketAddress(args[0], Integer.valueOf(args[1])));\n    }\n   \n```\n\n在`GreysConsole`的构造函数中连接到上面启动的`GaServer`， 将用户输入的命令发送到server端， 然后将server端的返回显示在交互式shell上。\n\n```java\n    // com.github.ompc.greys.core.GreysConsole#activeConsoleReader\n    /**\n     * 发送命令到服务端\n     */\n    private void activeConsoleReader() {\n        final Thread socketThread = new Thread(\"ga-console-reader-daemon\") {\n\n            private StringBuilder lineBuffer = new StringBuilder();\n\n            @Override\n            public void run() {\n                try {\n\n                    while (isRunning) {\n\n                        final String line = console.readLine();\n\n                        // 如果是\\结尾，则说明还有下文，需要对换行做特殊处理\n                        if (StringUtils.endsWith(line, \"\\\\\")) {\n                            // 去掉结尾的\\\n                            lineBuffer.append(line.substring(0, line.length() - 1));\n                            continue;\n                        } else {\n                            lineBuffer.append(line);\n                        }\n\n                        final String lineForWrite = lineBuffer.toString();\n                        lineBuffer = new StringBuilder();\n\n                        // replace ! to \\!\n                        // history.add(StringUtils.replace(lineForWrite, \"!\", \"\\\\!\"));\n\n                        // flush if need\n                        if (history instanceof Flushable) {\n                            ((Flushable) history).flush();\n                        }\n\n                        console.setPrompt(EMPTY);\n                        if (isNotBlank(lineForWrite)) {\n                            socketWriter.write(lineForWrite + \"\\n\");\n                        } else {\n                            socketWriter.write(\"\\n\");\n                        }\n                        socketWriter.flush();\n\n                    }\n                } catch (IOException e) {\n                    err(\"read fail : %s\", e.getMessage());\n                    shutdown();\n                }\n\n            }\n\n        };\n        socketThread.setDaemon(true);\n        socketThread.start();\n    }\n\n    // com.github.ompc.greys.core.GreysConsole#loopForWriter\n    // 将服务端返回输出到界面\n    private void loopForWriter() {\n        try {\n            while (isRunning) {\n                final int c = socketReader.read();\n                if (c == EOF) {\n                    break;\n                }\n                if (c == EOT) {\n                    hackingForReDrawPrompt();\n                    console.setPrompt(DEFAULT_PROMPT);\n                    console.redrawLine();\n                } else {\n                    out.write(c);\n                }\n                out.flush();\n            }\n        } catch (IOException e) {\n            err(\"write fail : %s\", e.getMessage());\n            shutdown();\n        }\n\n    }\n```\n\n# Misc\n\n## 使用maven生成MainFest文件\n\n### maven-jar-plugin\n\n```xml\n <build>\n        <finalName>qtracer-agent</finalName>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-jar-plugin</artifactId>\n                <version>2.4</version>\n                <configuration>\n                    <archive>\n                        <manifestEntries>\n                            <Premain-Class>qunar.tc.qtracer.instrument.AgentMain</Premain-Class>\n                            <Agent-Class>qunar.tc.qtracer.instrument.AgentMain</Agent-Class>\n                            <Can-Redefine-Classes>true</Can-Redefine-Classes>\n                            <Can-Retransform-Classes>true</Can-Retransform-Classes>\n                        </manifestEntries>\n                    </archive>\n                </configuration>\n            </plugin>\n        </plugins>\n    </build>\n```\n\n### maven-assembly-plugin\n\n```xml\n<plugin>\n    <artifactId>maven-assembly-plugin</artifactId>\n    <configuration>\n        <archive>\n            <manifestEntries>\n                <Premain-Class>**.**.InstrumentTest</Premain-Class>\n                <Agent-Class>**.**..InstrumentTest</Agent-Class>\n                <Can-Redefine-Classes>true</Can-Redefine-Classes>\n                <Can-Retransform-Classes>true</Can-Retransform-Classes>\n            </manifestEntries>\n        </archive>\n    </configuration>\n</plugin>\n```\n\n# 参考链接\n\n- [bash - How to specify -? option with GNU getopt - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/15740/how-to-specify-option-with-gnu-getopt)\n- [getopt(3): Parse options - Linux man page](https://linux.die.net/man/3/getopt)\n- [VirtualMachine (Attach API )](https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html)\n- [谈谈Java Intrumentation和相关应用 | Yilun Fan's Blog](http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/)\n- [Grays Anatomy源码浅析--ClassLoader,Java,Method,DES,null,方法,INVOKING](http://www.bijishequ.com/detail/435931?p=29-55)\n- [java.lang.instrument (Java Platform SE 8 )](https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html)\n- [Java SE 6 新特性: Instrumentation 新功能](https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html)\n- [JVM(TM) Tool Interface 1.2.1](https://docs.oracle.com/javase/7/docs/platform/jvmti/jvmti.html#writingAgents)\n- [Learning JVMTI · GitBook](https://www.gitbook.com/book/sachin-handiekar/learning-jvmti/details)\n- [JVM Attach机制实现 - 你假笨](http://lovestblog.cn/blog/2014/06/18/jvm-attach/)\n- [Shell,信号量以及java进程的退出](https://www.slideshare.net/hongjiang/shelljava)\n- [Java SE 6 新特性: JMX 与系统管理](https://www.ibm.com/developerworks/cn/java/j-lo-jse63/)","source":"_posts/greys-start.md","raw":"title: greys启动分析\ntags: greys\ncategory: perf\ntoc: true\ndate: 2018-04-02 01:31:53\n---\n\n\n# greys 简介\n\ngreys的使用参见链接： {% post_link greys %}\n\n# greys.sh\n\n一般使用greys时，启动命令如下：\n\n```bash\nsudo -u tomcat -H ./greys.sh [pid]\n```\n\n`greys.sh`的最后一行`main \"${@}\"`将命令行的所有参数都传给了main函数， 看main函数的实现：\n\n```bash\n    while getopts \"PUJC\" ARG\n    do\n        case ${ARG} in\n            P) OPTION_CHECK_PERMISSION=0;;\n            U) OPTION_UPDATE_IF_NECESSARY=0;;\n            J) OPTION_ATTACH_JVM=0;;\n            C) OPTION_ACTIVE_CONSOLE=0;;\n            ?) usage;exit 1;;\n        esac\n    done\n```\n\n首先脚本使用`getopts`来获取命令行的参数， 指定解析`-P`、`-U`、`-J`、`-C`这几个参数，设置一些flag。\n注意下case语句中的`？`， 代表无法识别的命令行参数, 这时就打印出help，然后退出程序：\n\n>The GNU getopt command uses the GNU getopt() library function to do the parsing of the arguments and options.\n\n>If getopt() does not recognize an option character, it prints an error message to stderr, stores the character in optopt, and returns ?. The calling program may prevent the error message by setting opterr to 0.\n\n然后greys.sh这个脚本会检查greys的版本是否有更新， 除了检查更新就是`attach jvm`和`active console`：\n\n```bash\n    if [[ ${OPTION_ATTACH_JVM} -eq 1 ]]; then\n        attach_jvm ${greys_local_version}\\\n            || exit_on_err 1 \"attach to target jvm(${TARGET_PID}) failed.\"\n    fi\n\n    if [[ ${OPTION_ACTIVE_CONSOLE} -eq 1 ]]; then\n        active_console ${greys_local_version}\\\n            || exit_on_err 1 \"active console failed.\"\n    fi\n```\n\n`${OPTION_ATTACH_JVM}`和`${OPTION_ACTIVE_CONSOLE}`的默认值都是1：\n\n```bash\n\n# the option to control greys.sh attach target jvm\nOPTION_ATTACH_JVM=1\n\n# the option to control greys.sh active greys-console\nOPTION_ACTIVE_CONSOLE=1\n```\n\n\n# attach jvm分析\n\n```bash\nattach_jvm()\n{\n    local greys_lib_dir=${GREYS_LIB_DIR}/${1}/greys\n\n    # if [ ${TARGET_IP} = ${DEFAULT_TARGET_IP} ]; then\n    if [ ! -z ${TARGET_PID} ]; then\n        ${JAVA_HOME}/bin/java \\\n            ${BOOT_CLASSPATH} ${JVM_OPTS} \\\n            -jar ${greys_lib_dir}/greys-core.jar \\\n                -pid ${TARGET_PID} \\\n                -target ${TARGET_IP}\":\"${TARGET_PORT} \\\n                -core \"${greys_lib_dir}/greys-core.jar\" \\\n                -agent \"${greys_lib_dir}/greys-agent.jar\"\n    fi\n}\n```\n\nattach jvm这个函数，就是调用 greys-core这个jar包，  jar包执行时会调用指定的`Main-Class`的的main方法。\n`Main-Class`在`META-INF`中指定， 查看文件的内容:\n\n```bash\n➜  greys  unzip -q -c greys-core.jar  META-INF/MANIFEST.MF\nManifest-Version: 1.0\nArchiver-Version: Plexus Archiver\nCreated-By: Apache Maven\nBuilt-By: vlinux\nBuild-Jdk: 1.8.0_91\nMain-Class: com.github.ompc.greys.core.GreysLauncher\n```\n\n因此执行这个jar包后，会调用`GreysLauncher`的main方法。\n\n## attach到jvm过程\n\n`GreysLauncher`在main函数中做了两件事情，一是解析命令行配置， 二是attach到具体的jvm上。\n\n```java\n    public static void main(String[] args) {\n        try {\n            new GreysLauncher(args);\n        } catch (Throwable t) {\n            System.err.println(\"start greys failed, because : \" + getCauseMessage(t));\n            System.exit(-1);\n        }\n    }\n\n    public GreysLauncher(String[] args) throws Exception {\n\n        // 解析配置文件\n        Configure configure = analyzeConfigure(args);\n\n        // 加载agent\n        attachAgent(configure);\n    }\n```\n\n配置文件就是脚本中指定的参数，主要有如下字段：\n\n```java\n    private String targetIp;                // 目标主机IP\n    private int targetPort;                 // 目标进程号\n    private int javaPid;                    // 对方java进程号\n    private int connectTimeout = 6000;      // 连接超时时间(ms)\n    private String greysCore;               // greys-core.jar的位置\n    private String greysAgent;              // greys-agent.jar的位置\n```\n\n### attach原理\n\n{% asset_img  attach.jpg jps实现原理 %}\n\n我们在用`jstack`命令查看jvm的线程dump的时候，经常看到这两个进程，一个是`\"Signal Dispatcher\"`, 另外一个是`\"Attach Listener\"`;\n这两个线程就和attach功能密切相关。\n\n```\n\"Signal Dispatcher\" #4 daemon prio=9 os_prio=0 tid=0x00007f23b80d2800 nid=0xb82e runnable [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"Attach Listener\" #28 daemon prio=9 os_prio=0 tid=0x00007f2328001000 nid=0x3bb5 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n```\n\n`Signal Dispatcher`负责响应`SIGQUIT`, 并创建 `Attach Listener`。`Attach Listener`负责建立通信，执行相应的命令。\n\nattach jvm就是根据`com.sun.tools.attach.VirtualMachine`的接口提供的方法——`attach`和`loadAgent`\n\n### GreysLauncher\n\n```java\n  Object vmObj = null;\n        try {\n            if (null == attachVmdObj) { // 使用 attach(String pid) 这种方式\n                vmObj = vmClass.getMethod(\"attach\", String.class).invoke(null, \"\" + configure.getJavaPid());\n            } else {\n                vmObj = vmClass.getMethod(\"attach\", vmdClass).invoke(null, attachVmdObj);\n            }\n            vmClass.getMethod(\"loadAgent\", String.class, String.class).invoke(vmObj, configure.getGreysAgent(), configure.getGreysCore() + \";\" + configure.toString());\n        } finally {\n            if (null != vmObj) {\n                vmClass.getMethod(\"detach\", (Class<?>[]) null).invoke(vmObj, (Object[]) null);\n            }\n        }\n```\n\n通过上面的代码， `greys-core.jar`和`greys-agent.jar`这两个jar包就被引入到了jvm\n\n> The loadAgent method is used to load agents that are written in the Java Language and deployed in a JAR file. (See java.lang.instrument for a detailed description on how these agents are loaded and started).\n\n`loadAgent`会将`greys-core.jar`和`greys-agent.jar`两个jar包引入进来。jar包引入后会从`/META-INF/MANIFEST.MF`中读取配置的agent类。\n\n## agent启动过程\n\nagent有两种启动方式，一种再jvm启动的时候一起启动， 一种是动态的attach到一个运行的jvm上。\n\n### 随启动参数启动\n\n以agent形式启动需要在jvm启动参数添加：\n\n```\n    -javaagent:btrace-agent.jar\n```\n\n这种加载方式需要实现下面两个接口中的一个：\n\n```java\n/**\n * JVM先尝试调用这个方法\n */\npublic static void premain(String agentArgs, Instrumentation inst);\n/**\n * 如果上面的方法不存在，则尝试调用这个方法\n */\npublic static void premain(String agentArgs);\n```\n\n同时必须在`MANIFEST.MF`中包含`Premain-Class`指定对应的类。\n\n\n### 动态attach的方式启动\n\nattach形式需要实现下面的两个接口\n\n```java\n/**\n * 首先尝试调用这个方法\n */\npublic static void agentmain(String agentArgs, Instrumentation inst);\n\n\n/**\n * 上面的方法不存在，会尝试调用这个方法\n */\npublic static void agentmain(String agentArgs);\n```\n\n同时在Jar包中必须指定 `Agent-Class`, 因此当此jar包被加载时，jvm会从`/META-INF/MANIFEST.MF`中读取配置的`Premain-Class`和`Agent-Class`, `greys-agent`的信息显示如下：\n\n```xml\nManifest-Version: 1.0\nArchiver-Version: Plexus Archiver\nCreated-By: Apache Maven\nBuilt-By: vlinux\nBuild-Jdk: 1.8.0_91\nAgent-Class: com.github.ompc.greys.agent.AgentLauncher\nCan-Redefine-Classes: true\nCan-Retransform-Classes: true\nPremain-Class: com.github.ompc.greys.agent.AgentLauncher\n```\n\n因此入口定位在`AgentLauncher`。\n\n### AgentLauncher\n\n`AgentLauncher`的主要完成了一下的功能：\n    - 自定义类加载器，减少对现有工程的侵蚀\n    - 启动一个`GaServer`监听指定的端口\n\n`GaServer`读取用户的输入的命令， 将命令交给`CommandHandler`在新的线程中进行具体的处理。\n\n# active console分析\n\n```bash\n# active console\n# $1 : greys_local_version\nactive_console()\n{\n\n    local greys_lib_dir=${GREYS_LIB_DIR}/${1}/greys\n\n    if type ${JAVA_HOME}/bin/java 2>&1 >> /dev/null; then\n\n        # use default console\n        ${JAVA_HOME}/bin/java \\\n            -cp ${greys_lib_dir}/greys-core.jar \\\n            com.github.ompc.greys.core.GreysConsole \\\n                ${TARGET_IP} \\\n                ${TARGET_PORT}\n\n    elif type telnet 2>&1 >> /dev/null; then\n\n        # use telnet\n        telnet ${TARGET_IP} ${TARGET_PORT}\n\n    elif type nc 2>&1 >> /dev/null; then\n\n        # use netcat\n        nc ${TARGET_IP} ${TARGET_PORT}\n\n    else\n\n        echo \"'telnet' or 'nc' is required.\" 1>&2\n        return 1\n\n    fi\n}\n```\n\n`active console`主要是启动一个客户端， 它对不同的方式做了判断; 以java方式启动的会执行`greys-core.jar`的`GreysConsole`\n的main方法：\n\n```java\n    public static void main(String... args) throws IOException {\n        new GreysConsole(new InetSocketAddress(args[0], Integer.valueOf(args[1])));\n    }\n   \n```\n\n在`GreysConsole`的构造函数中连接到上面启动的`GaServer`， 将用户输入的命令发送到server端， 然后将server端的返回显示在交互式shell上。\n\n```java\n    // com.github.ompc.greys.core.GreysConsole#activeConsoleReader\n    /**\n     * 发送命令到服务端\n     */\n    private void activeConsoleReader() {\n        final Thread socketThread = new Thread(\"ga-console-reader-daemon\") {\n\n            private StringBuilder lineBuffer = new StringBuilder();\n\n            @Override\n            public void run() {\n                try {\n\n                    while (isRunning) {\n\n                        final String line = console.readLine();\n\n                        // 如果是\\结尾，则说明还有下文，需要对换行做特殊处理\n                        if (StringUtils.endsWith(line, \"\\\\\")) {\n                            // 去掉结尾的\\\n                            lineBuffer.append(line.substring(0, line.length() - 1));\n                            continue;\n                        } else {\n                            lineBuffer.append(line);\n                        }\n\n                        final String lineForWrite = lineBuffer.toString();\n                        lineBuffer = new StringBuilder();\n\n                        // replace ! to \\!\n                        // history.add(StringUtils.replace(lineForWrite, \"!\", \"\\\\!\"));\n\n                        // flush if need\n                        if (history instanceof Flushable) {\n                            ((Flushable) history).flush();\n                        }\n\n                        console.setPrompt(EMPTY);\n                        if (isNotBlank(lineForWrite)) {\n                            socketWriter.write(lineForWrite + \"\\n\");\n                        } else {\n                            socketWriter.write(\"\\n\");\n                        }\n                        socketWriter.flush();\n\n                    }\n                } catch (IOException e) {\n                    err(\"read fail : %s\", e.getMessage());\n                    shutdown();\n                }\n\n            }\n\n        };\n        socketThread.setDaemon(true);\n        socketThread.start();\n    }\n\n    // com.github.ompc.greys.core.GreysConsole#loopForWriter\n    // 将服务端返回输出到界面\n    private void loopForWriter() {\n        try {\n            while (isRunning) {\n                final int c = socketReader.read();\n                if (c == EOF) {\n                    break;\n                }\n                if (c == EOT) {\n                    hackingForReDrawPrompt();\n                    console.setPrompt(DEFAULT_PROMPT);\n                    console.redrawLine();\n                } else {\n                    out.write(c);\n                }\n                out.flush();\n            }\n        } catch (IOException e) {\n            err(\"write fail : %s\", e.getMessage());\n            shutdown();\n        }\n\n    }\n```\n\n# Misc\n\n## 使用maven生成MainFest文件\n\n### maven-jar-plugin\n\n```xml\n <build>\n        <finalName>qtracer-agent</finalName>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-jar-plugin</artifactId>\n                <version>2.4</version>\n                <configuration>\n                    <archive>\n                        <manifestEntries>\n                            <Premain-Class>qunar.tc.qtracer.instrument.AgentMain</Premain-Class>\n                            <Agent-Class>qunar.tc.qtracer.instrument.AgentMain</Agent-Class>\n                            <Can-Redefine-Classes>true</Can-Redefine-Classes>\n                            <Can-Retransform-Classes>true</Can-Retransform-Classes>\n                        </manifestEntries>\n                    </archive>\n                </configuration>\n            </plugin>\n        </plugins>\n    </build>\n```\n\n### maven-assembly-plugin\n\n```xml\n<plugin>\n    <artifactId>maven-assembly-plugin</artifactId>\n    <configuration>\n        <archive>\n            <manifestEntries>\n                <Premain-Class>**.**.InstrumentTest</Premain-Class>\n                <Agent-Class>**.**..InstrumentTest</Agent-Class>\n                <Can-Redefine-Classes>true</Can-Redefine-Classes>\n                <Can-Retransform-Classes>true</Can-Retransform-Classes>\n            </manifestEntries>\n        </archive>\n    </configuration>\n</plugin>\n```\n\n# 参考链接\n\n- [bash - How to specify -? option with GNU getopt - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/15740/how-to-specify-option-with-gnu-getopt)\n- [getopt(3): Parse options - Linux man page](https://linux.die.net/man/3/getopt)\n- [VirtualMachine (Attach API )](https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html)\n- [谈谈Java Intrumentation和相关应用 | Yilun Fan's Blog](http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/)\n- [Grays Anatomy源码浅析--ClassLoader,Java,Method,DES,null,方法,INVOKING](http://www.bijishequ.com/detail/435931?p=29-55)\n- [java.lang.instrument (Java Platform SE 8 )](https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html)\n- [Java SE 6 新特性: Instrumentation 新功能](https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html)\n- [JVM(TM) Tool Interface 1.2.1](https://docs.oracle.com/javase/7/docs/platform/jvmti/jvmti.html#writingAgents)\n- [Learning JVMTI · GitBook](https://www.gitbook.com/book/sachin-handiekar/learning-jvmti/details)\n- [JVM Attach机制实现 - 你假笨](http://lovestblog.cn/blog/2014/06/18/jvm-attach/)\n- [Shell,信号量以及java进程的退出](https://www.slideshare.net/hongjiang/shelljava)\n- [Java SE 6 新特性: JMX 与系统管理](https://www.ibm.com/developerworks/cn/java/j-lo-jse63/)","slug":"greys-start","published":1,"updated":"2018-05-05T03:20:59.841Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd980062jh4khkvqckho","content":"<h1 id=\"greys-简介\"><a href=\"#greys-简介\" class=\"headerlink\" title=\"greys 简介\"></a>greys 简介</h1><p>greys的使用参见链接： <a href=\"/2017/11/12/greys/\" title=\"使用greys来排查线上问题\">使用greys来排查线上问题</a></p>\n<h1 id=\"greys-sh\"><a href=\"#greys-sh\" class=\"headerlink\" title=\"greys.sh\"></a>greys.sh</h1><p>一般使用greys时，启动命令如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat -H ./greys.sh [pid]</span><br></pre></td></tr></table></figure>\n<p><code>greys.sh</code>的最后一行<code>main &quot;${@}&quot;</code>将命令行的所有参数都传给了main函数， 看main函数的实现：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">getopts</span> <span class=\"string\">\"PUJC\"</span> ARG</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"variable\">$&#123;ARG&#125;</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">        P) OPTION_CHECK_PERMISSION=0;;</span><br><span class=\"line\">        U) OPTION_UPDATE_IF_NECESSARY=0;;</span><br><span class=\"line\">        J) OPTION_ATTACH_JVM=0;;</span><br><span class=\"line\">        C) OPTION_ACTIVE_CONSOLE=0;;</span><br><span class=\"line\">        ?) usage;<span class=\"built_in\">exit</span> 1;;</span><br><span class=\"line\">    <span class=\"keyword\">esac</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p>首先脚本使用<code>getopts</code>来获取命令行的参数， 指定解析<code>-P</code>、<code>-U</code>、<code>-J</code>、<code>-C</code>这几个参数，设置一些flag。<br>注意下case语句中的<code>？</code>， 代表无法识别的命令行参数, 这时就打印出help，然后退出程序：</p>\n<blockquote>\n<p>The GNU getopt command uses the GNU getopt() library function to do the parsing of the arguments and options.</p>\n<p>If getopt() does not recognize an option character, it prints an error message to stderr, stores the character in optopt, and returns ?. The calling program may prevent the error message by setting opterr to 0.</p>\n</blockquote>\n<p>然后greys.sh这个脚本会检查greys的版本是否有更新， 除了检查更新就是<code>attach jvm</code>和<code>active console</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;OPTION_ATTACH_JVM&#125;</span> -eq 1 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    attach_jvm <span class=\"variable\">$&#123;greys_local_version&#125;</span>\\</span><br><span class=\"line\">        || exit_on_err 1 <span class=\"string\">\"attach to target jvm(<span class=\"variable\">$&#123;TARGET_PID&#125;</span>) failed.\"</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;OPTION_ACTIVE_CONSOLE&#125;</span> -eq 1 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    active_console <span class=\"variable\">$&#123;greys_local_version&#125;</span>\\</span><br><span class=\"line\">        || exit_on_err 1 <span class=\"string\">\"active console failed.\"</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n<p><code>${OPTION_ATTACH_JVM}</code>和<code>${OPTION_ACTIVE_CONSOLE}</code>的默认值都是1：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># the option to control greys.sh attach target jvm</span></span><br><span class=\"line\">OPTION_ATTACH_JVM=1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># the option to control greys.sh active greys-console</span></span><br><span class=\"line\">OPTION_ACTIVE_CONSOLE=1</span><br></pre></td></tr></table></figure>\n<h1 id=\"attach-jvm分析\"><a href=\"#attach-jvm分析\" class=\"headerlink\" title=\"attach jvm分析\"></a>attach jvm分析</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">attach_jvm()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">local</span> greys_lib_dir=<span class=\"variable\">$&#123;GREYS_LIB_DIR&#125;</span>/<span class=\"variable\">$&#123;1&#125;</span>/greys</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># if [ $&#123;TARGET_IP&#125; = $&#123;DEFAULT_TARGET_IP&#125; ]; then</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -z <span class=\"variable\">$&#123;TARGET_PID&#125;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"variable\">$&#123;JAVA_HOME&#125;</span>/bin/java \\</span><br><span class=\"line\">            <span class=\"variable\">$&#123;BOOT_CLASSPATH&#125;</span> <span class=\"variable\">$&#123;JVM_OPTS&#125;</span> \\</span><br><span class=\"line\">            -jar <span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \\</span><br><span class=\"line\">                -pid <span class=\"variable\">$&#123;TARGET_PID&#125;</span> \\</span><br><span class=\"line\">                -target <span class=\"variable\">$&#123;TARGET_IP&#125;</span><span class=\"string\">\":\"</span><span class=\"variable\">$&#123;TARGET_PORT&#125;</span> \\</span><br><span class=\"line\">                -core <span class=\"string\">\"<span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-core.jar\"</span> \\</span><br><span class=\"line\">                -agent <span class=\"string\">\"<span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-agent.jar\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>attach jvm这个函数，就是调用 greys-core这个jar包，  jar包执行时会调用指定的<code>Main-Class</code>的的main方法。<br><code>Main-Class</code>在<code>META-INF</code>中指定， 查看文件的内容:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  greys  unzip -q -c greys-core.jar  META-INF/MANIFEST.MF</span><br><span class=\"line\">Manifest-Version: 1.0</span><br><span class=\"line\">Archiver-Version: Plexus Archiver</span><br><span class=\"line\">Created-By: Apache Maven</span><br><span class=\"line\">Built-By: vlinux</span><br><span class=\"line\">Build-Jdk: 1.8.0_91</span><br><span class=\"line\">Main-Class: com.github.ompc.greys.core.GreysLauncher</span><br></pre></td></tr></table></figure>\n<p>因此执行这个jar包后，会调用<code>GreysLauncher</code>的main方法。</p>\n<h2 id=\"attach到jvm过程\"><a href=\"#attach到jvm过程\" class=\"headerlink\" title=\"attach到jvm过程\"></a>attach到jvm过程</h2><p><code>GreysLauncher</code>在main函数中做了两件事情，一是解析命令行配置， 二是attach到具体的jvm上。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> GreysLauncher(args);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</span><br><span class=\"line\">        System.err.println(<span class=\"string\">\"start greys failed, because : \"</span> + getCauseMessage(t));</span><br><span class=\"line\">        System.exit(-<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">GreysLauncher</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析配置文件</span></span><br><span class=\"line\">    Configure configure = analyzeConfigure(args);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 加载agent</span></span><br><span class=\"line\">    attachAgent(configure);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>配置文件就是脚本中指定的参数，主要有如下字段：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> String targetIp;                <span class=\"comment\">// 目标主机IP</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> targetPort;                 <span class=\"comment\">// 目标进程号</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> javaPid;                    <span class=\"comment\">// 对方java进程号</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> connectTimeout = <span class=\"number\">6000</span>;      <span class=\"comment\">// 连接超时时间(ms)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String greysCore;               <span class=\"comment\">// greys-core.jar的位置</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String greysAgent;              <span class=\"comment\">// greys-agent.jar的位置</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"attach原理\"><a href=\"#attach原理\" class=\"headerlink\" title=\"attach原理\"></a>attach原理</h3><img src=\"/2018/04/02/greys-start/attach.jpg\" title=\"jps实现原理\">\n<p>我们在用<code>jstack</code>命令查看jvm的线程dump的时候，经常看到这两个进程，一个是<code>&quot;Signal Dispatcher&quot;</code>, 另外一个是<code>&quot;Attach Listener&quot;</code>;<br>这两个线程就和attach功能密切相关。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f23b80d2800 nid=0xb82e runnable [0x0000000000000000]</span><br><span class=\"line\">   java.lang.Thread.State: RUNNABLE</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;Attach Listener&quot; #28 daemon prio=9 os_prio=0 tid=0x00007f2328001000 nid=0x3bb5 waiting on condition [0x0000000000000000]</span><br><span class=\"line\">   java.lang.Thread.State: RUNNABLE</span><br></pre></td></tr></table></figure>\n<p><code>Signal Dispatcher</code>负责响应<code>SIGQUIT</code>, 并创建 <code>Attach Listener</code>。<code>Attach Listener</code>负责建立通信，执行相应的命令。</p>\n<p>attach jvm就是根据<code>com.sun.tools.attach.VirtualMachine</code>的接口提供的方法——<code>attach</code>和<code>loadAgent</code></p>\n<h3 id=\"GreysLauncher\"><a href=\"#GreysLauncher\" class=\"headerlink\" title=\"GreysLauncher\"></a>GreysLauncher</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object vmObj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == attachVmdObj) &#123; <span class=\"comment\">// 使用 attach(String pid) 这种方式</span></span><br><span class=\"line\">              vmObj = vmClass.getMethod(<span class=\"string\">\"attach\"</span>, String.class).invoke(<span class=\"keyword\">null</span>, <span class=\"string\">\"\"</span> + configure.getJavaPid());</span><br><span class=\"line\">          &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              vmObj = vmClass.getMethod(<span class=\"string\">\"attach\"</span>, vmdClass).invoke(<span class=\"keyword\">null</span>, attachVmdObj);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          vmClass.getMethod(<span class=\"string\">\"loadAgent\"</span>, String.class, String.class).invoke(vmObj, configure.getGreysAgent(), configure.getGreysCore() + <span class=\"string\">\";\"</span> + configure.toString());</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != vmObj) &#123;</span><br><span class=\"line\">              vmClass.getMethod(<span class=\"string\">\"detach\"</span>, (Class&lt;?&gt;[]) <span class=\"keyword\">null</span>).invoke(vmObj, (Object[]) <span class=\"keyword\">null</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br></pre></td></tr></table></figure>\n<p>通过上面的代码， <code>greys-core.jar</code>和<code>greys-agent.jar</code>这两个jar包就被引入到了jvm</p>\n<blockquote>\n<p>The loadAgent method is used to load agents that are written in the Java Language and deployed in a JAR file. (See java.lang.instrument for a detailed description on how these agents are loaded and started).</p>\n</blockquote>\n<p><code>loadAgent</code>会将<code>greys-core.jar</code>和<code>greys-agent.jar</code>两个jar包引入进来。jar包引入后会从<code>/META-INF/MANIFEST.MF</code>中读取配置的agent类。</p>\n<h2 id=\"agent启动过程\"><a href=\"#agent启动过程\" class=\"headerlink\" title=\"agent启动过程\"></a>agent启动过程</h2><p>agent有两种启动方式，一种再jvm启动的时候一起启动， 一种是动态的attach到一个运行的jvm上。</p>\n<h3 id=\"随启动参数启动\"><a href=\"#随启动参数启动\" class=\"headerlink\" title=\"随启动参数启动\"></a>随启动参数启动</h3><p>以agent形式启动需要在jvm启动参数添加：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-javaagent:btrace-agent.jar</span><br></pre></td></tr></table></figure>\n<p>这种加载方式需要实现下面两个接口中的一个：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * JVM先尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">premain</span><span class=\"params\">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果上面的方法不存在，则尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">premain</span><span class=\"params\">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>\n<p>同时必须在<code>MANIFEST.MF</code>中包含<code>Premain-Class</code>指定对应的类。</p>\n<h3 id=\"动态attach的方式启动\"><a href=\"#动态attach的方式启动\" class=\"headerlink\" title=\"动态attach的方式启动\"></a>动态attach的方式启动</h3><p>attach形式需要实现下面的两个接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 首先尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">agentmain</span><span class=\"params\">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 上面的方法不存在，会尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">agentmain</span><span class=\"params\">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>\n<p>同时在Jar包中必须指定 <code>Agent-Class</code>, 因此当此jar包被加载时，jvm会从<code>/META-INF/MANIFEST.MF</code>中读取配置的<code>Premain-Class</code>和<code>Agent-Class</code>, <code>greys-agent</code>的信息显示如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Manifest-Version: 1.0</span><br><span class=\"line\">Archiver-Version: Plexus Archiver</span><br><span class=\"line\">Created-By: Apache Maven</span><br><span class=\"line\">Built-By: vlinux</span><br><span class=\"line\">Build-Jdk: 1.8.0_91</span><br><span class=\"line\">Agent-Class: com.github.ompc.greys.agent.AgentLauncher</span><br><span class=\"line\">Can-Redefine-Classes: true</span><br><span class=\"line\">Can-Retransform-Classes: true</span><br><span class=\"line\">Premain-Class: com.github.ompc.greys.agent.AgentLauncher</span><br></pre></td></tr></table></figure>\n<p>因此入口定位在<code>AgentLauncher</code>。</p>\n<h3 id=\"AgentLauncher\"><a href=\"#AgentLauncher\" class=\"headerlink\" title=\"AgentLauncher\"></a>AgentLauncher</h3><p><code>AgentLauncher</code>的主要完成了一下的功能：</p>\n<pre><code>- 自定义类加载器，减少对现有工程的侵蚀\n- 启动一个`GaServer`监听指定的端口\n</code></pre><p><code>GaServer</code>读取用户的输入的命令， 将命令交给<code>CommandHandler</code>在新的线程中进行具体的处理。</p>\n<h1 id=\"active-console分析\"><a href=\"#active-console分析\" class=\"headerlink\" title=\"active console分析\"></a>active console分析</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># active console</span></span><br><span class=\"line\"><span class=\"comment\"># $1 : greys_local_version</span></span><br><span class=\"line\">active_console()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">local</span> greys_lib_dir=<span class=\"variable\">$&#123;GREYS_LIB_DIR&#125;</span>/<span class=\"variable\">$&#123;1&#125;</span>/greys</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">type</span> <span class=\"variable\">$&#123;JAVA_HOME&#125;</span>/bin/java 2&gt;&amp;1 &gt;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># use default console</span></span><br><span class=\"line\">        <span class=\"variable\">$&#123;JAVA_HOME&#125;</span>/bin/java \\</span><br><span class=\"line\">            -cp <span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \\</span><br><span class=\"line\">            com.github.ompc.greys.core.GreysConsole \\</span><br><span class=\"line\">                <span class=\"variable\">$&#123;TARGET_IP&#125;</span> \\</span><br><span class=\"line\">                <span class=\"variable\">$&#123;TARGET_PORT&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"built_in\">type</span> telnet 2&gt;&amp;1 &gt;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># use telnet</span></span><br><span class=\"line\">        telnet <span class=\"variable\">$&#123;TARGET_IP&#125;</span> <span class=\"variable\">$&#123;TARGET_PORT&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"built_in\">type</span> nc 2&gt;&amp;1 &gt;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># use netcat</span></span><br><span class=\"line\">        nc <span class=\"variable\">$&#123;TARGET_IP&#125;</span> <span class=\"variable\">$&#123;TARGET_PORT&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"'telnet' or 'nc' is required.\"</span> 1&gt;&amp;2</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>active console</code>主要是启动一个客户端， 它对不同的方式做了判断; 以java方式启动的会执行<code>greys-core.jar</code>的<code>GreysConsole</code><br>的main方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String... args)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> GreysConsole(<span class=\"keyword\">new</span> InetSocketAddress(args[<span class=\"number\">0</span>], Integer.valueOf(args[<span class=\"number\">1</span>])));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在<code>GreysConsole</code>的构造函数中连接到上面启动的<code>GaServer</code>， 将用户输入的命令发送到server端， 然后将server端的返回显示在交互式shell上。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// com.github.ompc.greys.core.GreysConsole#activeConsoleReader</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 发送命令到服务端</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">activeConsoleReader</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Thread socketThread = <span class=\"keyword\">new</span> Thread(<span class=\"string\">\"ga-console-reader-daemon\"</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> StringBuilder lineBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">while</span> (isRunning) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">final</span> String line = console.readLine();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 如果是\\结尾，则说明还有下文，需要对换行做特殊处理</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (StringUtils.endsWith(line, <span class=\"string\">\"\\\\\"</span>)) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 去掉结尾的\\</span></span><br><span class=\"line\">                        lineBuffer.append(line.substring(<span class=\"number\">0</span>, line.length() - <span class=\"number\">1</span>));</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        lineBuffer.append(line);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">final</span> String lineForWrite = lineBuffer.toString();</span><br><span class=\"line\">                    lineBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// replace ! to \\!</span></span><br><span class=\"line\">                    <span class=\"comment\">// history.add(StringUtils.replace(lineForWrite, \"!\", \"\\\\!\"));</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// flush if need</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (history <span class=\"keyword\">instanceof</span> Flushable) &#123;</span><br><span class=\"line\">                        ((Flushable) history).flush();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    console.setPrompt(EMPTY);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (isNotBlank(lineForWrite)) &#123;</span><br><span class=\"line\">                        socketWriter.write(lineForWrite + <span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        socketWriter.write(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    socketWriter.flush();</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                err(<span class=\"string\">\"read fail : %s\"</span>, e.getMessage());</span><br><span class=\"line\">                shutdown();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    socketThread.setDaemon(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    socketThread.start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// com.github.ompc.greys.core.GreysConsole#loopForWriter</span></span><br><span class=\"line\"><span class=\"comment\">// 将服务端返回输出到界面</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">loopForWriter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (isRunning) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> c = socketReader.read();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == EOF) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == EOT) &#123;</span><br><span class=\"line\">                hackingForReDrawPrompt();</span><br><span class=\"line\">                console.setPrompt(DEFAULT_PROMPT);</span><br><span class=\"line\">                console.redrawLine();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                out.write(c);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            out.flush();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">        err(<span class=\"string\">\"write fail : %s\"</span>, e.getMessage());</span><br><span class=\"line\">        shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"Misc\"><a href=\"#Misc\" class=\"headerlink\" title=\"Misc\"></a>Misc</h1><h2 id=\"使用maven生成MainFest文件\"><a href=\"#使用maven生成MainFest文件\" class=\"headerlink\" title=\"使用maven生成MainFest文件\"></a>使用maven生成MainFest文件</h2><h3 id=\"maven-jar-plugin\"><a href=\"#maven-jar-plugin\" class=\"headerlink\" title=\"maven-jar-plugin\"></a>maven-jar-plugin</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">finalName</span>&gt;</span>qtracer-agent<span class=\"tag\">&lt;/<span class=\"name\">finalName</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-jar-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.4<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                   <span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Premain-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class=\"tag\">&lt;/<span class=\"name\">Premain-Class</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Agent-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class=\"tag\">&lt;/<span class=\"name\">Agent-Class</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Can-Redefine-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Redefine-Classes</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Can-Retransform-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Retransform-Classes</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;/<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">                   <span class=\"tag\">&lt;/<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"maven-assembly-plugin\"><a href=\"#maven-assembly-plugin\" class=\"headerlink\" title=\"maven-assembly-plugin\"></a>maven-assembly-plugin</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-assembly-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Premain-Class</span>&gt;</span>**.**.InstrumentTest<span class=\"tag\">&lt;/<span class=\"name\">Premain-Class</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Agent-Class</span>&gt;</span>**.**..InstrumentTest<span class=\"tag\">&lt;/<span class=\"name\">Agent-Class</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Can-Redefine-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Redefine-Classes</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Can-Retransform-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Retransform-Classes</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h1><ul>\n<li><a href=\"https://unix.stackexchange.com/questions/15740/how-to-specify-option-with-gnu-getopt\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">bash - How to specify -? option with GNU getopt - Unix &amp; Linux Stack Exchange</a></li>\n<li><a href=\"https://linux.die.net/man/3/getopt\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">getopt(3): Parse options - Linux man page</a></li>\n<li><a href=\"https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">VirtualMachine (Attach API )</a></li>\n<li><a href=\"http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">谈谈Java Intrumentation和相关应用 | Yilun Fan’s Blog</a></li>\n<li><a href=\"http://www.bijishequ.com/detail/435931?p=29-55\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Grays Anatomy源码浅析–ClassLoader,Java,Method,DES,null,方法,INVOKING</a></li>\n<li><a href=\"https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java.lang.instrument (Java Platform SE 8 )</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SE 6 新特性: Instrumentation 新功能</a></li>\n<li><a href=\"https://docs.oracle.com/javase/7/docs/platform/jvmti/jvmti.html#writingAgents\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM(TM) Tool Interface 1.2.1</a></li>\n<li><a href=\"https://www.gitbook.com/book/sachin-handiekar/learning-jvmti/details\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Learning JVMTI · GitBook</a></li>\n<li><a href=\"http://lovestblog.cn/blog/2014/06/18/jvm-attach/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM Attach机制实现 - 你假笨</a></li>\n<li><a href=\"https://www.slideshare.net/hongjiang/shelljava\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Shell,信号量以及java进程的退出</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-jse63/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SE 6 新特性: JMX 与系统管理</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"greys-简介\"><a href=\"#greys-简介\" class=\"headerlink\" title=\"greys 简介\"></a>greys 简介</h1><p>greys的使用参见链接： <a href=\"/2017/11/12/greys/\" title=\"使用greys来排查线上问题\">使用greys来排查线上问题</a></p>\n<h1 id=\"greys-sh\"><a href=\"#greys-sh\" class=\"headerlink\" title=\"greys.sh\"></a>greys.sh</h1><p>一般使用greys时，启动命令如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat -H ./greys.sh [pid]</span><br></pre></td></tr></table></figure>\n<p><code>greys.sh</code>的最后一行<code>main &quot;${@}&quot;</code>将命令行的所有参数都传给了main函数， 看main函数的实现：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">getopts</span> <span class=\"string\">\"PUJC\"</span> ARG</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"variable\">$&#123;ARG&#125;</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">        P) OPTION_CHECK_PERMISSION=0;;</span><br><span class=\"line\">        U) OPTION_UPDATE_IF_NECESSARY=0;;</span><br><span class=\"line\">        J) OPTION_ATTACH_JVM=0;;</span><br><span class=\"line\">        C) OPTION_ACTIVE_CONSOLE=0;;</span><br><span class=\"line\">        ?) usage;<span class=\"built_in\">exit</span> 1;;</span><br><span class=\"line\">    <span class=\"keyword\">esac</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p>首先脚本使用<code>getopts</code>来获取命令行的参数， 指定解析<code>-P</code>、<code>-U</code>、<code>-J</code>、<code>-C</code>这几个参数，设置一些flag。<br>注意下case语句中的<code>？</code>， 代表无法识别的命令行参数, 这时就打印出help，然后退出程序：</p>\n<blockquote>\n<p>The GNU getopt command uses the GNU getopt() library function to do the parsing of the arguments and options.</p>\n<p>If getopt() does not recognize an option character, it prints an error message to stderr, stores the character in optopt, and returns ?. The calling program may prevent the error message by setting opterr to 0.</p>\n</blockquote>\n<p>然后greys.sh这个脚本会检查greys的版本是否有更新， 除了检查更新就是<code>attach jvm</code>和<code>active console</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;OPTION_ATTACH_JVM&#125;</span> -eq 1 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    attach_jvm <span class=\"variable\">$&#123;greys_local_version&#125;</span>\\</span><br><span class=\"line\">        || exit_on_err 1 <span class=\"string\">\"attach to target jvm(<span class=\"variable\">$&#123;TARGET_PID&#125;</span>) failed.\"</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;OPTION_ACTIVE_CONSOLE&#125;</span> -eq 1 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    active_console <span class=\"variable\">$&#123;greys_local_version&#125;</span>\\</span><br><span class=\"line\">        || exit_on_err 1 <span class=\"string\">\"active console failed.\"</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n<p><code>${OPTION_ATTACH_JVM}</code>和<code>${OPTION_ACTIVE_CONSOLE}</code>的默认值都是1：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># the option to control greys.sh attach target jvm</span></span><br><span class=\"line\">OPTION_ATTACH_JVM=1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># the option to control greys.sh active greys-console</span></span><br><span class=\"line\">OPTION_ACTIVE_CONSOLE=1</span><br></pre></td></tr></table></figure>\n<h1 id=\"attach-jvm分析\"><a href=\"#attach-jvm分析\" class=\"headerlink\" title=\"attach jvm分析\"></a>attach jvm分析</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">attach_jvm()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">local</span> greys_lib_dir=<span class=\"variable\">$&#123;GREYS_LIB_DIR&#125;</span>/<span class=\"variable\">$&#123;1&#125;</span>/greys</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># if [ $&#123;TARGET_IP&#125; = $&#123;DEFAULT_TARGET_IP&#125; ]; then</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -z <span class=\"variable\">$&#123;TARGET_PID&#125;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"variable\">$&#123;JAVA_HOME&#125;</span>/bin/java \\</span><br><span class=\"line\">            <span class=\"variable\">$&#123;BOOT_CLASSPATH&#125;</span> <span class=\"variable\">$&#123;JVM_OPTS&#125;</span> \\</span><br><span class=\"line\">            -jar <span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \\</span><br><span class=\"line\">                -pid <span class=\"variable\">$&#123;TARGET_PID&#125;</span> \\</span><br><span class=\"line\">                -target <span class=\"variable\">$&#123;TARGET_IP&#125;</span><span class=\"string\">\":\"</span><span class=\"variable\">$&#123;TARGET_PORT&#125;</span> \\</span><br><span class=\"line\">                -core <span class=\"string\">\"<span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-core.jar\"</span> \\</span><br><span class=\"line\">                -agent <span class=\"string\">\"<span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-agent.jar\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>attach jvm这个函数，就是调用 greys-core这个jar包，  jar包执行时会调用指定的<code>Main-Class</code>的的main方法。<br><code>Main-Class</code>在<code>META-INF</code>中指定， 查看文件的内容:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  greys  unzip -q -c greys-core.jar  META-INF/MANIFEST.MF</span><br><span class=\"line\">Manifest-Version: 1.0</span><br><span class=\"line\">Archiver-Version: Plexus Archiver</span><br><span class=\"line\">Created-By: Apache Maven</span><br><span class=\"line\">Built-By: vlinux</span><br><span class=\"line\">Build-Jdk: 1.8.0_91</span><br><span class=\"line\">Main-Class: com.github.ompc.greys.core.GreysLauncher</span><br></pre></td></tr></table></figure>\n<p>因此执行这个jar包后，会调用<code>GreysLauncher</code>的main方法。</p>\n<h2 id=\"attach到jvm过程\"><a href=\"#attach到jvm过程\" class=\"headerlink\" title=\"attach到jvm过程\"></a>attach到jvm过程</h2><p><code>GreysLauncher</code>在main函数中做了两件事情，一是解析命令行配置， 二是attach到具体的jvm上。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> GreysLauncher(args);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</span><br><span class=\"line\">        System.err.println(<span class=\"string\">\"start greys failed, because : \"</span> + getCauseMessage(t));</span><br><span class=\"line\">        System.exit(-<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">GreysLauncher</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析配置文件</span></span><br><span class=\"line\">    Configure configure = analyzeConfigure(args);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 加载agent</span></span><br><span class=\"line\">    attachAgent(configure);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>配置文件就是脚本中指定的参数，主要有如下字段：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> String targetIp;                <span class=\"comment\">// 目标主机IP</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> targetPort;                 <span class=\"comment\">// 目标进程号</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> javaPid;                    <span class=\"comment\">// 对方java进程号</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> connectTimeout = <span class=\"number\">6000</span>;      <span class=\"comment\">// 连接超时时间(ms)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String greysCore;               <span class=\"comment\">// greys-core.jar的位置</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String greysAgent;              <span class=\"comment\">// greys-agent.jar的位置</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"attach原理\"><a href=\"#attach原理\" class=\"headerlink\" title=\"attach原理\"></a>attach原理</h3><img src=\"/2018/04/02/greys-start/attach.jpg\" title=\"jps实现原理\">\n<p>我们在用<code>jstack</code>命令查看jvm的线程dump的时候，经常看到这两个进程，一个是<code>&quot;Signal Dispatcher&quot;</code>, 另外一个是<code>&quot;Attach Listener&quot;</code>;<br>这两个线程就和attach功能密切相关。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f23b80d2800 nid=0xb82e runnable [0x0000000000000000]</span><br><span class=\"line\">   java.lang.Thread.State: RUNNABLE</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;Attach Listener&quot; #28 daemon prio=9 os_prio=0 tid=0x00007f2328001000 nid=0x3bb5 waiting on condition [0x0000000000000000]</span><br><span class=\"line\">   java.lang.Thread.State: RUNNABLE</span><br></pre></td></tr></table></figure>\n<p><code>Signal Dispatcher</code>负责响应<code>SIGQUIT</code>, 并创建 <code>Attach Listener</code>。<code>Attach Listener</code>负责建立通信，执行相应的命令。</p>\n<p>attach jvm就是根据<code>com.sun.tools.attach.VirtualMachine</code>的接口提供的方法——<code>attach</code>和<code>loadAgent</code></p>\n<h3 id=\"GreysLauncher\"><a href=\"#GreysLauncher\" class=\"headerlink\" title=\"GreysLauncher\"></a>GreysLauncher</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object vmObj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == attachVmdObj) &#123; <span class=\"comment\">// 使用 attach(String pid) 这种方式</span></span><br><span class=\"line\">              vmObj = vmClass.getMethod(<span class=\"string\">\"attach\"</span>, String.class).invoke(<span class=\"keyword\">null</span>, <span class=\"string\">\"\"</span> + configure.getJavaPid());</span><br><span class=\"line\">          &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              vmObj = vmClass.getMethod(<span class=\"string\">\"attach\"</span>, vmdClass).invoke(<span class=\"keyword\">null</span>, attachVmdObj);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          vmClass.getMethod(<span class=\"string\">\"loadAgent\"</span>, String.class, String.class).invoke(vmObj, configure.getGreysAgent(), configure.getGreysCore() + <span class=\"string\">\";\"</span> + configure.toString());</span><br><span class=\"line\">      &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != vmObj) &#123;</span><br><span class=\"line\">              vmClass.getMethod(<span class=\"string\">\"detach\"</span>, (Class&lt;?&gt;[]) <span class=\"keyword\">null</span>).invoke(vmObj, (Object[]) <span class=\"keyword\">null</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br></pre></td></tr></table></figure>\n<p>通过上面的代码， <code>greys-core.jar</code>和<code>greys-agent.jar</code>这两个jar包就被引入到了jvm</p>\n<blockquote>\n<p>The loadAgent method is used to load agents that are written in the Java Language and deployed in a JAR file. (See java.lang.instrument for a detailed description on how these agents are loaded and started).</p>\n</blockquote>\n<p><code>loadAgent</code>会将<code>greys-core.jar</code>和<code>greys-agent.jar</code>两个jar包引入进来。jar包引入后会从<code>/META-INF/MANIFEST.MF</code>中读取配置的agent类。</p>\n<h2 id=\"agent启动过程\"><a href=\"#agent启动过程\" class=\"headerlink\" title=\"agent启动过程\"></a>agent启动过程</h2><p>agent有两种启动方式，一种再jvm启动的时候一起启动， 一种是动态的attach到一个运行的jvm上。</p>\n<h3 id=\"随启动参数启动\"><a href=\"#随启动参数启动\" class=\"headerlink\" title=\"随启动参数启动\"></a>随启动参数启动</h3><p>以agent形式启动需要在jvm启动参数添加：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-javaagent:btrace-agent.jar</span><br></pre></td></tr></table></figure>\n<p>这种加载方式需要实现下面两个接口中的一个：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * JVM先尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">premain</span><span class=\"params\">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 如果上面的方法不存在，则尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">premain</span><span class=\"params\">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>\n<p>同时必须在<code>MANIFEST.MF</code>中包含<code>Premain-Class</code>指定对应的类。</p>\n<h3 id=\"动态attach的方式启动\"><a href=\"#动态attach的方式启动\" class=\"headerlink\" title=\"动态attach的方式启动\"></a>动态attach的方式启动</h3><p>attach形式需要实现下面的两个接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 首先尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">agentmain</span><span class=\"params\">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 上面的方法不存在，会尝试调用这个方法</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">agentmain</span><span class=\"params\">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>\n<p>同时在Jar包中必须指定 <code>Agent-Class</code>, 因此当此jar包被加载时，jvm会从<code>/META-INF/MANIFEST.MF</code>中读取配置的<code>Premain-Class</code>和<code>Agent-Class</code>, <code>greys-agent</code>的信息显示如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Manifest-Version: 1.0</span><br><span class=\"line\">Archiver-Version: Plexus Archiver</span><br><span class=\"line\">Created-By: Apache Maven</span><br><span class=\"line\">Built-By: vlinux</span><br><span class=\"line\">Build-Jdk: 1.8.0_91</span><br><span class=\"line\">Agent-Class: com.github.ompc.greys.agent.AgentLauncher</span><br><span class=\"line\">Can-Redefine-Classes: true</span><br><span class=\"line\">Can-Retransform-Classes: true</span><br><span class=\"line\">Premain-Class: com.github.ompc.greys.agent.AgentLauncher</span><br></pre></td></tr></table></figure>\n<p>因此入口定位在<code>AgentLauncher</code>。</p>\n<h3 id=\"AgentLauncher\"><a href=\"#AgentLauncher\" class=\"headerlink\" title=\"AgentLauncher\"></a>AgentLauncher</h3><p><code>AgentLauncher</code>的主要完成了一下的功能：</p>\n<pre><code>- 自定义类加载器，减少对现有工程的侵蚀\n- 启动一个`GaServer`监听指定的端口\n</code></pre><p><code>GaServer</code>读取用户的输入的命令， 将命令交给<code>CommandHandler</code>在新的线程中进行具体的处理。</p>\n<h1 id=\"active-console分析\"><a href=\"#active-console分析\" class=\"headerlink\" title=\"active console分析\"></a>active console分析</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># active console</span></span><br><span class=\"line\"><span class=\"comment\"># $1 : greys_local_version</span></span><br><span class=\"line\">active_console()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">local</span> greys_lib_dir=<span class=\"variable\">$&#123;GREYS_LIB_DIR&#125;</span>/<span class=\"variable\">$&#123;1&#125;</span>/greys</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">type</span> <span class=\"variable\">$&#123;JAVA_HOME&#125;</span>/bin/java 2&gt;&amp;1 &gt;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># use default console</span></span><br><span class=\"line\">        <span class=\"variable\">$&#123;JAVA_HOME&#125;</span>/bin/java \\</span><br><span class=\"line\">            -cp <span class=\"variable\">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \\</span><br><span class=\"line\">            com.github.ompc.greys.core.GreysConsole \\</span><br><span class=\"line\">                <span class=\"variable\">$&#123;TARGET_IP&#125;</span> \\</span><br><span class=\"line\">                <span class=\"variable\">$&#123;TARGET_PORT&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"built_in\">type</span> telnet 2&gt;&amp;1 &gt;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># use telnet</span></span><br><span class=\"line\">        telnet <span class=\"variable\">$&#123;TARGET_IP&#125;</span> <span class=\"variable\">$&#123;TARGET_PORT&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> <span class=\"built_in\">type</span> nc 2&gt;&amp;1 &gt;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># use netcat</span></span><br><span class=\"line\">        nc <span class=\"variable\">$&#123;TARGET_IP&#125;</span> <span class=\"variable\">$&#123;TARGET_PORT&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">\"'telnet' or 'nc' is required.\"</span> 1&gt;&amp;2</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 1</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>active console</code>主要是启动一个客户端， 它对不同的方式做了判断; 以java方式启动的会执行<code>greys-core.jar</code>的<code>GreysConsole</code><br>的main方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String... args)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> GreysConsole(<span class=\"keyword\">new</span> InetSocketAddress(args[<span class=\"number\">0</span>], Integer.valueOf(args[<span class=\"number\">1</span>])));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在<code>GreysConsole</code>的构造函数中连接到上面启动的<code>GaServer</code>， 将用户输入的命令发送到server端， 然后将server端的返回显示在交互式shell上。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// com.github.ompc.greys.core.GreysConsole#activeConsoleReader</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 发送命令到服务端</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">activeConsoleReader</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Thread socketThread = <span class=\"keyword\">new</span> Thread(<span class=\"string\">\"ga-console-reader-daemon\"</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> StringBuilder lineBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">while</span> (isRunning) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">final</span> String line = console.readLine();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// 如果是\\结尾，则说明还有下文，需要对换行做特殊处理</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (StringUtils.endsWith(line, <span class=\"string\">\"\\\\\"</span>)) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 去掉结尾的\\</span></span><br><span class=\"line\">                        lineBuffer.append(line.substring(<span class=\"number\">0</span>, line.length() - <span class=\"number\">1</span>));</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        lineBuffer.append(line);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">final</span> String lineForWrite = lineBuffer.toString();</span><br><span class=\"line\">                    lineBuffer = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// replace ! to \\!</span></span><br><span class=\"line\">                    <span class=\"comment\">// history.add(StringUtils.replace(lineForWrite, \"!\", \"\\\\!\"));</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// flush if need</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (history <span class=\"keyword\">instanceof</span> Flushable) &#123;</span><br><span class=\"line\">                        ((Flushable) history).flush();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    console.setPrompt(EMPTY);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (isNotBlank(lineForWrite)) &#123;</span><br><span class=\"line\">                        socketWriter.write(lineForWrite + <span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        socketWriter.write(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    socketWriter.flush();</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                err(<span class=\"string\">\"read fail : %s\"</span>, e.getMessage());</span><br><span class=\"line\">                shutdown();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    socketThread.setDaemon(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    socketThread.start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// com.github.ompc.greys.core.GreysConsole#loopForWriter</span></span><br><span class=\"line\"><span class=\"comment\">// 将服务端返回输出到界面</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">loopForWriter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (isRunning) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> c = socketReader.read();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == EOF) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == EOT) &#123;</span><br><span class=\"line\">                hackingForReDrawPrompt();</span><br><span class=\"line\">                console.setPrompt(DEFAULT_PROMPT);</span><br><span class=\"line\">                console.redrawLine();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                out.write(c);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            out.flush();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">        err(<span class=\"string\">\"write fail : %s\"</span>, e.getMessage());</span><br><span class=\"line\">        shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"Misc\"><a href=\"#Misc\" class=\"headerlink\" title=\"Misc\"></a>Misc</h1><h2 id=\"使用maven生成MainFest文件\"><a href=\"#使用maven生成MainFest文件\" class=\"headerlink\" title=\"使用maven生成MainFest文件\"></a>使用maven生成MainFest文件</h2><h3 id=\"maven-jar-plugin\"><a href=\"#maven-jar-plugin\" class=\"headerlink\" title=\"maven-jar-plugin\"></a>maven-jar-plugin</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">finalName</span>&gt;</span>qtracer-agent<span class=\"tag\">&lt;/<span class=\"name\">finalName</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-jar-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.4<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                   <span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Premain-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class=\"tag\">&lt;/<span class=\"name\">Premain-Class</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Agent-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class=\"tag\">&lt;/<span class=\"name\">Agent-Class</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Can-Redefine-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Redefine-Classes</span>&gt;</span></span><br><span class=\"line\">                           <span class=\"tag\">&lt;<span class=\"name\">Can-Retransform-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Retransform-Classes</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;/<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">                   <span class=\"tag\">&lt;/<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"maven-assembly-plugin\"><a href=\"#maven-assembly-plugin\" class=\"headerlink\" title=\"maven-assembly-plugin\"></a>maven-assembly-plugin</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-assembly-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Premain-Class</span>&gt;</span>**.**.InstrumentTest<span class=\"tag\">&lt;/<span class=\"name\">Premain-Class</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Agent-Class</span>&gt;</span>**.**..InstrumentTest<span class=\"tag\">&lt;/<span class=\"name\">Agent-Class</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Can-Redefine-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Redefine-Classes</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">Can-Retransform-Classes</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">Can-Retransform-Classes</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">manifestEntries</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">archive</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h1><ul>\n<li><a href=\"https://unix.stackexchange.com/questions/15740/how-to-specify-option-with-gnu-getopt\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">bash - How to specify -? option with GNU getopt - Unix &amp; Linux Stack Exchange</a></li>\n<li><a href=\"https://linux.die.net/man/3/getopt\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">getopt(3): Parse options - Linux man page</a></li>\n<li><a href=\"https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">VirtualMachine (Attach API )</a></li>\n<li><a href=\"http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">谈谈Java Intrumentation和相关应用 | Yilun Fan’s Blog</a></li>\n<li><a href=\"http://www.bijishequ.com/detail/435931?p=29-55\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Grays Anatomy源码浅析–ClassLoader,Java,Method,DES,null,方法,INVOKING</a></li>\n<li><a href=\"https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java.lang.instrument (Java Platform SE 8 )</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SE 6 新特性: Instrumentation 新功能</a></li>\n<li><a href=\"https://docs.oracle.com/javase/7/docs/platform/jvmti/jvmti.html#writingAgents\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM(TM) Tool Interface 1.2.1</a></li>\n<li><a href=\"https://www.gitbook.com/book/sachin-handiekar/learning-jvmti/details\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Learning JVMTI · GitBook</a></li>\n<li><a href=\"http://lovestblog.cn/blog/2014/06/18/jvm-attach/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM Attach机制实现 - 你假笨</a></li>\n<li><a href=\"https://www.slideshare.net/hongjiang/shelljava\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Shell,信号量以及java进程的退出</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/java/j-lo-jse63/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SE 6 新特性: JMX 与系统管理</a></li>\n</ul>\n"},{"title":"hexo迁移到ubuntu","toc":false,"abbrlink":48430,"_content":"\n系统切换到ubuntu之后，使用的apt安装的node，默认权限是sudo。安装hexo之后也必须以sudo身份执行。\n需要修改下node的权限，命令如下：\n\n```\n➜  qsli.github.com (hexo|✚1…)  npm config get prefix\n/usr/local\n```\n修改owner\n\n```\nsudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}\n```\n\n修改owner之后就可以正常执行hexo了。\n\n## 参考\n\n1. [03 - Fixing npm permissions | npm Documentation](https://docs.npmjs.com/getting-started/fixing-npm-permissions)\n","source":"_posts/hexo-ubuntu.md","raw":"---\ntitle: hexo迁移到ubuntu\ntoc: false\ntags: hexo\ncategory: hexo\nabbrlink: 48430\n---\n\n系统切换到ubuntu之后，使用的apt安装的node，默认权限是sudo。安装hexo之后也必须以sudo身份执行。\n需要修改下node的权限，命令如下：\n\n```\n➜  qsli.github.com (hexo|✚1…)  npm config get prefix\n/usr/local\n```\n修改owner\n\n```\nsudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}\n```\n\n修改owner之后就可以正常执行hexo了。\n\n## 参考\n\n1. [03 - Fixing npm permissions | npm Documentation](https://docs.npmjs.com/getting-started/fixing-npm-permissions)\n","slug":"hexo-ubuntu","published":1,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-18T16:08:15.398Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd990066jh4k7sn5zdzz","content":"<p>系统切换到ubuntu之后，使用的apt安装的node，默认权限是sudo。安装hexo之后也必须以sudo身份执行。<br>需要修改下node的权限，命令如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  qsli.github.com (hexo|✚1…)  npm config get prefix</span><br><span class=\"line\">/usr/local</span><br></pre></td></tr></table></figure>\n<p>修改owner</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo chown -R $(whoami) $(npm config get prefix)/&#123;lib/node_modules,bin,share&#125;</span><br></pre></td></tr></table></figure>\n<p>修改owner之后就可以正常执行hexo了。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://docs.npmjs.com/getting-started/fixing-npm-permissions\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">03 - Fixing npm permissions | npm Documentation</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>系统切换到ubuntu之后，使用的apt安装的node，默认权限是sudo。安装hexo之后也必须以sudo身份执行。<br>需要修改下node的权限，命令如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  qsli.github.com (hexo|✚1…)  npm config get prefix</span><br><span class=\"line\">/usr/local</span><br></pre></td></tr></table></figure>\n<p>修改owner</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo chown -R $(whoami) $(npm config get prefix)/&#123;lib/node_modules,bin,share&#125;</span><br></pre></td></tr></table></figure>\n<p>修改owner之后就可以正常执行hexo了。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://docs.npmjs.com/getting-started/fixing-npm-permissions\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">03 - Fixing npm permissions | npm Documentation</a></li>\n</ol>\n"},{"title":"guava-eventbus","toc":true,"abbrlink":1379,"date":"2017-01-16T17:30:26.000Z","_content":"\n\n## 从观察者模式说起\n\n### 观察者模式类图\n\n观察者模式是软件设计中经常使用到的一种模式，又叫发布-订阅模式（Publish/Subscribe）、模型-视图(Model/View)模式、源-监听器（Source/Listener）模式或从属者（Dependents）模式。\n\n{% plantuml %}\n\npackage subject{\n  object Subject {\n  + notifyObservers()\n  + addObserver()\n  + deleteObserver()\n  }\n\n  object ConcreteSubjectA{\n  + notifyObservers()\n  }\n\n  object ConcreteSubjectB{\n  + notifyObservers()\n  }\n\n  Subject <|-- ConcreteSubjectA\n  Subject <|-- ConcreteSubjectB\n}\n\npackage observer{\n  object Observer{\n  + notify()\n  }\n\n  Subject o-- \"*\" Observer : (Observer Collection)\n\n  object ConcreteObserverA{\n  + notify()\n  }\n\n  object ConcreteObserverB{\n  + notify()\n  }\n\n  Observer <|-- ConcreteObserverA\n  Observer <|-- ConcreteObserverB\n\n}\n\nConcreteSubjectA -[#green,dotted]> ConcreteObserverA\nConcreteSubjectA  -[#green,dotted]> ConcreteObserverB\n\n{% endplantuml %}\n\n### Java中的支持\n\nJava中有一个`Observable`类和一个`Observer`接口, `Observable`类已经实现了添加、删除观察者的方法。\n\n- 主题继承自`Observable`，继承一些便利方法\n\n```java\npublic class Subject extends Observable {\n\n    private final String subject = \"play with some fun\";\n\n    public void push(String message) {\n        notifyObservers(message);\n    }\n\n    public String getSubject() {\n        return subject;\n    }\n\n    public static void main(String[] args) {\n        Subject subject = new Subject();\n        subject.addObserver(new Watcher(\"001\"));\n        subject.addObserver(new Watcher(\"007\"));\n        subject.setChanged();\n        //will do nothing until setChanged() is called\n        subject.push(\"My watch is ended!\");\n    }\n}\n\n```\n\n\n- 观察者继承`Observer`接口，只有一个`update`方法用来更新数据\n\n```java\npublic class Watcher implements Observer {\n\n    private final String id;\n\n    public Watcher(String id) {\n        this.id = id;\n        System.out.println(\"My watch begins! \" + id);\n    }\n\n    @Override\n    public void update(Observable o, Object arg) {\n        System.out.println(\"-----------------------------------------------------------\");\n        System.out.println(id);\n        Subject subject = (Subject) o;\n        System.out.println(\"subject is : \" + subject.getSubject());\n        System.out.println(\"update data is : \" + (String)arg );\n    }\n}\n```\n\n输出示例：\n\n```\nMy watch begins! 001\nMy watch begins! 007\n-----------------------------------------------------------\n007\nsubject is : play with some fun\nupdate data is : My watch is ended!\n-----------------------------------------------------------\n001\nsubject is : play with some fun\nupdate data is : My watch is ended!\n\n```\n\n### EventBus\n\n>EventBus allows publish-subscribe-style communication between components without requiring the components to explicitly register with one another (and thus be aware of each other). It is designed exclusively to replace traditional Java in-process event distribution using explicit registration. It is not a general-purpose publish-subscribe system, nor is it intended for interprocess communication.\n\n\nEventBus的优点：\n\n- 无需定义接口，使用注解的形式。\n- 可以在一个类中实现多个事件的捕获。\n\n> Due to erasure, no single class can implement a generic interface more than once with different type parameters. \n\n- 支持子类的捕获。\n- 支持捕获无人处理的event（让我想起了死漂）。\n- 传递的事件类型可以是任意的。\n\n\n```java\npublic class Person {\n    private String name;\n    private int age;\n\n    public Person() {\n\n    }\n\n    public Person(String name, int age) {\n        this.name = name;\n        this.age = age;\n    }\n\n    public String getName() {\n        return name;\n    }\n\n    public void setName(String name) {\n        this.name = name;\n    }\n\n    public int getAge() {\n        return age;\n    }\n\n    public void setAge(int age) {\n        this.age = age;\n    }\n\n    @Override\n    public String toString() {\n        return \"Person{\" +\n                \"name='\" + name + '\\'' +\n                \", age=\" + age +\n                '}';\n    }\n}\n\npublic class Customer extends Person  implements Serializable {\n\n    private List<String> hobbies;\n\n    public Customer(String name, int age) {\n        super(name, age);\n    }\n\n    public List<String> getHobbies() {\n        return hobbies;\n    }\n\n    public void setHobbies(List<String> hobbies) {\n        this.hobbies = hobbies;\n    }\n}\n\n```\n\n定义一个`Person`类和一个`Customer`类，用于测试继承关系的捕捉\n\n```java\npublic class EventBusTest {\n\n    public static void main(String[] args) {\n        EventBus eventBus = new EventBus();\n        eventBus.register(new EventBusChangeRecorder());\n        Customer customer = new Customer(\"customer\", 66);\n        Person p = new Person(\"person\", 11);\n        eventBus.post(customer);\n        eventBus.post(p);\n        eventBus.post(new Integer(123));\n        eventBus.post(\"Hello World\");\n    }\n\n    static class EventBusChangeRecorder {\n        @Subscribe\n        public void recordCustomerChange(Customer customer) {\n            System.out.println(\"-----------------------------------\");\n            System.out.println(\"recieved change:\");\n            System.out.println(\"customer name: \" + customer.getName());\n            System.out.println(\"cutomer age: \" + customer.getAge());\n            System.out.println(\"\\n\\n\");\n        }\n\n        @Subscribe\n        public void valueChange(Integer val) {//注意方法的类型\n            System.out.println(\"-----------------------------------\");\n            System.out.println(\"val = \" + val);\n            System.out.println(\"\\n\");\n        }\n\n        @Subscribe\n        public void deadEvent(DeadEvent deadEvent) {\n            System.out.println(\"-----------------------------------\");\n            System.out.println(\"deadEvent = \" + deadEvent);\n            System.out.println(\"\\n\");\n        }\n\n        @Subscribe\n        public void hierarchy(Person person) {\n            System.out.println(\"-----------------------------------\");\n            //will recieve all person and it's subtype\n            System.out.println(person);\n            System.out.println(\"\\n\");\n        }\n\n    }\n\n}\n\n\n```\n\n在我的电脑上的执行结果:\n\n```\n-----------------------------------\nrecieved change:\ncustomer name: customer\ncutomer age: 66\n\n\n\n-----------------------------------\nPerson{name='customer', age=66}\n\n\n-----------------------------------\nPerson{name='person', age=11}\n\n\n-----------------------------------\nval = 123\n\n\n-----------------------------------\ndeadEvent = DeadEvent{source=EventBus{default}, event=Hello World}\n```\n\n### 源码解析\n\n#### listener注册过程\n\n`EventBus`中有一个成员变量叫做`subscribers`, 负责管理所有注册进来的listener\n\n```java\n  private final SubscriberRegistry subscribers = new SubscriberRegistry(this);\n```\n\n`register(Object object)`方法就是调用`subscribers`的注册方法\n\n```java\n  /**\n   * Registers all subscriber methods on {@code object} to receive events.\n   *\n   * @param object object whose subscriber methods should be registered.\n   */\n  public void register(Object object) {\n    subscribers.register(object);\n  }\n\n    /**\n   * Registers all subscriber methods on the given listener object.\n   */\n  void register(Object listener) {\n    //解析注解，生成<EventType, ListenMethod>的multimap\n    Multimap<Class<?>, Subscriber> listenerMethods = findAllSubscribers(listener);\n\n    for (Map.Entry<Class<?>, Collection<Subscriber>> entry : listenerMethods.asMap().entrySet()) {\n      Class<?> eventType = entry.getKey();\n      Collection<Subscriber> eventMethodsInListener = entry.getValue();\n\n      CopyOnWriteArraySet<Subscriber> eventSubscribers = subscribers.get(eventType);\n\n      //新建或者添加到已有的事件对应的Listener中\n      if (eventSubscribers == null) {\n        CopyOnWriteArraySet<Subscriber> newSet = new CopyOnWriteArraySet<Subscriber>();\n        eventSubscribers =\n            MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);\n      }\n\n      eventSubscribers.addAll(eventMethodsInListener);\n    }\n  }\n\n\n    /**\n   * Returns all subscribers for the given listener grouped by the type of event they subscribe to.\n   */\n  private Multimap<Class<?>, Subscriber> findAllSubscribers(Object listener) {\n    Multimap<Class<?>, Subscriber> methodsInListener = HashMultimap.create();\n    Class<?> clazz = listener.getClass();\n    for (Method method : getAnnotatedMethods(clazz)) {//有缓存哦\n      Class<?>[] parameterTypes = method.getParameterTypes();\n      Class<?> eventType = parameterTypes[0];\n      methodsInListener.put(eventType, Subscriber.create(bus, listener, method));\n    }\n    return methodsInListener;\n  }\n```\n\n在`subscribers`的注册方法中完成了对注解`@Subscribe`的解析。\n\n#### 事件分发过程\n\n`EventBus`的post方法\n\n```java\n  /**\n   * Posts an event to all registered subscribers. This method will return successfully after the\n   * event has been posted to all subscribers, and regardless of any exceptions thrown by\n   * subscribers.\n   *\n   * <p>If no subscribers have been subscribed for {@code event}'s class, and {@code event} is not\n   * already a {@link DeadEvent}, it will be wrapped in a DeadEvent and reposted.\n   *\n   * @param event event to post.\n   */\n  public void post(Object event) {\n    Iterator<Subscriber> eventSubscribers = subscribers.getSubscribers(event);\n    if (eventSubscribers.hasNext()) {\n      dispatcher.dispatch(event, eventSubscribers);\n    } else if (!(event instanceof DeadEvent)) {\n      // the event had no subscribers and was not itself a DeadEvent\n      post(new DeadEvent(this, event));\n    }\n  }\n```\n\n这里的`dispatcher`默认是`Dispatcher.perThreadDispatchQueue()`\n\n它的`dispatch`方法实现如下：\n\n```java\n\n    /**\n     * Per-thread queue of events to dispatch.\n     */\n    private final ThreadLocal<Queue<Event>> queue =\n        new ThreadLocal<Queue<Event>>() {\n          @Override\n          protected Queue<Event> initialValue() {\n            return Queues.newArrayDeque();\n          }\n        };\n\n    /**\n     * Per-thread dispatch state, used to avoid reentrant event dispatching.\n     */\n    private final ThreadLocal<Boolean> dispatching =\n        new ThreadLocal<Boolean>() {\n          @Override\n          protected Boolean initialValue() {\n            return false;\n          }\n        };\n\n\n    @Override\n    void dispatch(Object event, Iterator<Subscriber> subscribers) {\n      //入参校验\n      checkNotNull(event);\n      checkNotNull(subscribers);\n      //从ThreadLocal中拿到队列\n      Queue<Event> queueForThread = queue.get();\n      //先把事件入队列\n      queueForThread.offer(new Event(event, subscribers));\n\n      if (!dispatching.get()) {\n        dispatching.set(true);\n        try {\n          Event nextEvent;\n          //遍历队列中的事件，并分发给相应的订阅者\n          while ((nextEvent = queueForThread.poll()) != null) {\n            while (nextEvent.subscribers.hasNext()) {\n              nextEvent.subscribers.next().dispatchEvent(nextEvent.event);\n            }\n          }\n        } finally {\n          dispatching.remove();\n          queue.remove();\n        }\n      }\n    }\n```\n\nEventBus的注解提取（简单的缓存），构建相应的Map，以及事件的分发设计地非常好，有了一个大型系统完整的雏形。\n\n## 参考\n\n1. [Guava学习笔记：EventBus - peida - 博客园](http://www.cnblogs.com/peida/p/EventBus.html)\n\n2. [EventBusExplained · google/guava Wiki](https://github.com/google/guava/wiki/EventBusExplained)\n\n3. [观察者模式 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F)\n\n4. [观察者模式 — Graphic Design Patterns](http://design-patterns.readthedocs.io/zh_CN/latest/behavioral_patterns/observer.html)","source":"_posts/guava-eventbus.md","raw":"---\ntitle: guava-eventbus\ntags: event-bus\ncategory: guava\ntoc: true\nabbrlink: 1379\ndate: 2017-01-17 01:30:26\n---\n\n\n## 从观察者模式说起\n\n### 观察者模式类图\n\n观察者模式是软件设计中经常使用到的一种模式，又叫发布-订阅模式（Publish/Subscribe）、模型-视图(Model/View)模式、源-监听器（Source/Listener）模式或从属者（Dependents）模式。\n\n{% plantuml %}\n\npackage subject{\n  object Subject {\n  + notifyObservers()\n  + addObserver()\n  + deleteObserver()\n  }\n\n  object ConcreteSubjectA{\n  + notifyObservers()\n  }\n\n  object ConcreteSubjectB{\n  + notifyObservers()\n  }\n\n  Subject <|-- ConcreteSubjectA\n  Subject <|-- ConcreteSubjectB\n}\n\npackage observer{\n  object Observer{\n  + notify()\n  }\n\n  Subject o-- \"*\" Observer : (Observer Collection)\n\n  object ConcreteObserverA{\n  + notify()\n  }\n\n  object ConcreteObserverB{\n  + notify()\n  }\n\n  Observer <|-- ConcreteObserverA\n  Observer <|-- ConcreteObserverB\n\n}\n\nConcreteSubjectA -[#green,dotted]> ConcreteObserverA\nConcreteSubjectA  -[#green,dotted]> ConcreteObserverB\n\n{% endplantuml %}\n\n### Java中的支持\n\nJava中有一个`Observable`类和一个`Observer`接口, `Observable`类已经实现了添加、删除观察者的方法。\n\n- 主题继承自`Observable`，继承一些便利方法\n\n```java\npublic class Subject extends Observable {\n\n    private final String subject = \"play with some fun\";\n\n    public void push(String message) {\n        notifyObservers(message);\n    }\n\n    public String getSubject() {\n        return subject;\n    }\n\n    public static void main(String[] args) {\n        Subject subject = new Subject();\n        subject.addObserver(new Watcher(\"001\"));\n        subject.addObserver(new Watcher(\"007\"));\n        subject.setChanged();\n        //will do nothing until setChanged() is called\n        subject.push(\"My watch is ended!\");\n    }\n}\n\n```\n\n\n- 观察者继承`Observer`接口，只有一个`update`方法用来更新数据\n\n```java\npublic class Watcher implements Observer {\n\n    private final String id;\n\n    public Watcher(String id) {\n        this.id = id;\n        System.out.println(\"My watch begins! \" + id);\n    }\n\n    @Override\n    public void update(Observable o, Object arg) {\n        System.out.println(\"-----------------------------------------------------------\");\n        System.out.println(id);\n        Subject subject = (Subject) o;\n        System.out.println(\"subject is : \" + subject.getSubject());\n        System.out.println(\"update data is : \" + (String)arg );\n    }\n}\n```\n\n输出示例：\n\n```\nMy watch begins! 001\nMy watch begins! 007\n-----------------------------------------------------------\n007\nsubject is : play with some fun\nupdate data is : My watch is ended!\n-----------------------------------------------------------\n001\nsubject is : play with some fun\nupdate data is : My watch is ended!\n\n```\n\n### EventBus\n\n>EventBus allows publish-subscribe-style communication between components without requiring the components to explicitly register with one another (and thus be aware of each other). It is designed exclusively to replace traditional Java in-process event distribution using explicit registration. It is not a general-purpose publish-subscribe system, nor is it intended for interprocess communication.\n\n\nEventBus的优点：\n\n- 无需定义接口，使用注解的形式。\n- 可以在一个类中实现多个事件的捕获。\n\n> Due to erasure, no single class can implement a generic interface more than once with different type parameters. \n\n- 支持子类的捕获。\n- 支持捕获无人处理的event（让我想起了死漂）。\n- 传递的事件类型可以是任意的。\n\n\n```java\npublic class Person {\n    private String name;\n    private int age;\n\n    public Person() {\n\n    }\n\n    public Person(String name, int age) {\n        this.name = name;\n        this.age = age;\n    }\n\n    public String getName() {\n        return name;\n    }\n\n    public void setName(String name) {\n        this.name = name;\n    }\n\n    public int getAge() {\n        return age;\n    }\n\n    public void setAge(int age) {\n        this.age = age;\n    }\n\n    @Override\n    public String toString() {\n        return \"Person{\" +\n                \"name='\" + name + '\\'' +\n                \", age=\" + age +\n                '}';\n    }\n}\n\npublic class Customer extends Person  implements Serializable {\n\n    private List<String> hobbies;\n\n    public Customer(String name, int age) {\n        super(name, age);\n    }\n\n    public List<String> getHobbies() {\n        return hobbies;\n    }\n\n    public void setHobbies(List<String> hobbies) {\n        this.hobbies = hobbies;\n    }\n}\n\n```\n\n定义一个`Person`类和一个`Customer`类，用于测试继承关系的捕捉\n\n```java\npublic class EventBusTest {\n\n    public static void main(String[] args) {\n        EventBus eventBus = new EventBus();\n        eventBus.register(new EventBusChangeRecorder());\n        Customer customer = new Customer(\"customer\", 66);\n        Person p = new Person(\"person\", 11);\n        eventBus.post(customer);\n        eventBus.post(p);\n        eventBus.post(new Integer(123));\n        eventBus.post(\"Hello World\");\n    }\n\n    static class EventBusChangeRecorder {\n        @Subscribe\n        public void recordCustomerChange(Customer customer) {\n            System.out.println(\"-----------------------------------\");\n            System.out.println(\"recieved change:\");\n            System.out.println(\"customer name: \" + customer.getName());\n            System.out.println(\"cutomer age: \" + customer.getAge());\n            System.out.println(\"\\n\\n\");\n        }\n\n        @Subscribe\n        public void valueChange(Integer val) {//注意方法的类型\n            System.out.println(\"-----------------------------------\");\n            System.out.println(\"val = \" + val);\n            System.out.println(\"\\n\");\n        }\n\n        @Subscribe\n        public void deadEvent(DeadEvent deadEvent) {\n            System.out.println(\"-----------------------------------\");\n            System.out.println(\"deadEvent = \" + deadEvent);\n            System.out.println(\"\\n\");\n        }\n\n        @Subscribe\n        public void hierarchy(Person person) {\n            System.out.println(\"-----------------------------------\");\n            //will recieve all person and it's subtype\n            System.out.println(person);\n            System.out.println(\"\\n\");\n        }\n\n    }\n\n}\n\n\n```\n\n在我的电脑上的执行结果:\n\n```\n-----------------------------------\nrecieved change:\ncustomer name: customer\ncutomer age: 66\n\n\n\n-----------------------------------\nPerson{name='customer', age=66}\n\n\n-----------------------------------\nPerson{name='person', age=11}\n\n\n-----------------------------------\nval = 123\n\n\n-----------------------------------\ndeadEvent = DeadEvent{source=EventBus{default}, event=Hello World}\n```\n\n### 源码解析\n\n#### listener注册过程\n\n`EventBus`中有一个成员变量叫做`subscribers`, 负责管理所有注册进来的listener\n\n```java\n  private final SubscriberRegistry subscribers = new SubscriberRegistry(this);\n```\n\n`register(Object object)`方法就是调用`subscribers`的注册方法\n\n```java\n  /**\n   * Registers all subscriber methods on {@code object} to receive events.\n   *\n   * @param object object whose subscriber methods should be registered.\n   */\n  public void register(Object object) {\n    subscribers.register(object);\n  }\n\n    /**\n   * Registers all subscriber methods on the given listener object.\n   */\n  void register(Object listener) {\n    //解析注解，生成<EventType, ListenMethod>的multimap\n    Multimap<Class<?>, Subscriber> listenerMethods = findAllSubscribers(listener);\n\n    for (Map.Entry<Class<?>, Collection<Subscriber>> entry : listenerMethods.asMap().entrySet()) {\n      Class<?> eventType = entry.getKey();\n      Collection<Subscriber> eventMethodsInListener = entry.getValue();\n\n      CopyOnWriteArraySet<Subscriber> eventSubscribers = subscribers.get(eventType);\n\n      //新建或者添加到已有的事件对应的Listener中\n      if (eventSubscribers == null) {\n        CopyOnWriteArraySet<Subscriber> newSet = new CopyOnWriteArraySet<Subscriber>();\n        eventSubscribers =\n            MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);\n      }\n\n      eventSubscribers.addAll(eventMethodsInListener);\n    }\n  }\n\n\n    /**\n   * Returns all subscribers for the given listener grouped by the type of event they subscribe to.\n   */\n  private Multimap<Class<?>, Subscriber> findAllSubscribers(Object listener) {\n    Multimap<Class<?>, Subscriber> methodsInListener = HashMultimap.create();\n    Class<?> clazz = listener.getClass();\n    for (Method method : getAnnotatedMethods(clazz)) {//有缓存哦\n      Class<?>[] parameterTypes = method.getParameterTypes();\n      Class<?> eventType = parameterTypes[0];\n      methodsInListener.put(eventType, Subscriber.create(bus, listener, method));\n    }\n    return methodsInListener;\n  }\n```\n\n在`subscribers`的注册方法中完成了对注解`@Subscribe`的解析。\n\n#### 事件分发过程\n\n`EventBus`的post方法\n\n```java\n  /**\n   * Posts an event to all registered subscribers. This method will return successfully after the\n   * event has been posted to all subscribers, and regardless of any exceptions thrown by\n   * subscribers.\n   *\n   * <p>If no subscribers have been subscribed for {@code event}'s class, and {@code event} is not\n   * already a {@link DeadEvent}, it will be wrapped in a DeadEvent and reposted.\n   *\n   * @param event event to post.\n   */\n  public void post(Object event) {\n    Iterator<Subscriber> eventSubscribers = subscribers.getSubscribers(event);\n    if (eventSubscribers.hasNext()) {\n      dispatcher.dispatch(event, eventSubscribers);\n    } else if (!(event instanceof DeadEvent)) {\n      // the event had no subscribers and was not itself a DeadEvent\n      post(new DeadEvent(this, event));\n    }\n  }\n```\n\n这里的`dispatcher`默认是`Dispatcher.perThreadDispatchQueue()`\n\n它的`dispatch`方法实现如下：\n\n```java\n\n    /**\n     * Per-thread queue of events to dispatch.\n     */\n    private final ThreadLocal<Queue<Event>> queue =\n        new ThreadLocal<Queue<Event>>() {\n          @Override\n          protected Queue<Event> initialValue() {\n            return Queues.newArrayDeque();\n          }\n        };\n\n    /**\n     * Per-thread dispatch state, used to avoid reentrant event dispatching.\n     */\n    private final ThreadLocal<Boolean> dispatching =\n        new ThreadLocal<Boolean>() {\n          @Override\n          protected Boolean initialValue() {\n            return false;\n          }\n        };\n\n\n    @Override\n    void dispatch(Object event, Iterator<Subscriber> subscribers) {\n      //入参校验\n      checkNotNull(event);\n      checkNotNull(subscribers);\n      //从ThreadLocal中拿到队列\n      Queue<Event> queueForThread = queue.get();\n      //先把事件入队列\n      queueForThread.offer(new Event(event, subscribers));\n\n      if (!dispatching.get()) {\n        dispatching.set(true);\n        try {\n          Event nextEvent;\n          //遍历队列中的事件，并分发给相应的订阅者\n          while ((nextEvent = queueForThread.poll()) != null) {\n            while (nextEvent.subscribers.hasNext()) {\n              nextEvent.subscribers.next().dispatchEvent(nextEvent.event);\n            }\n          }\n        } finally {\n          dispatching.remove();\n          queue.remove();\n        }\n      }\n    }\n```\n\nEventBus的注解提取（简单的缓存），构建相应的Map，以及事件的分发设计地非常好，有了一个大型系统完整的雏形。\n\n## 参考\n\n1. [Guava学习笔记：EventBus - peida - 博客园](http://www.cnblogs.com/peida/p/EventBus.html)\n\n2. [EventBusExplained · google/guava Wiki](https://github.com/google/guava/wiki/EventBusExplained)\n\n3. [观察者模式 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F)\n\n4. [观察者模式 — Graphic Design Patterns](http://design-patterns.readthedocs.io/zh_CN/latest/behavioral_patterns/observer.html)","slug":"guava-eventbus","published":1,"updated":"2017-04-16T12:04:30.006Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9b0069jh4ktlumckdh","content":"<h2 id=\"从观察者模式说起\"><a href=\"#从观察者模式说起\" class=\"headerlink\" title=\"从观察者模式说起\"></a>从观察者模式说起</h2><h3 id=\"观察者模式类图\"><a href=\"#观察者模式类图\" class=\"headerlink\" title=\"观察者模式类图\"></a>观察者模式类图</h3><p>观察者模式是软件设计中经常使用到的一种模式，又叫发布-订阅模式（Publish/Subscribe）、模型-视图(Model/View)模式、源-监听器（Source/Listener）模式或从属者（Dependents）模式。</p>\n<img src=\"http://www.plantuml.com/plantuml/svg/ZL1B3e8m4Dtt51FSWCe5Z36X7825I-C2w4XGqffIJOnwTm5f1IdYRlBcVMOUESVfASuGoajon5JT2O1e9jY-4QYX1N2XyiCjIagKLvIbwpLep9Y6MeHXWGfxu9DyJ4F1KraHMlDWtFo7YawezENhX-yF4YVsb5GMkXJHUdTQYJgGFc6OB2fZP-uODgp0DNCeYg8YvO9xbXyrBR0dZB2fdMqoUw-QY4a69NKTtnM2lvjb4f4lcL0AsNvZiHw8_b1HyW80\">\n<h3 id=\"Java中的支持\"><a href=\"#Java中的支持\" class=\"headerlink\" title=\"Java中的支持\"></a>Java中的支持</h3><p>Java中有一个<code>Observable</code>类和一个<code>Observer</code>接口, <code>Observable</code>类已经实现了添加、删除观察者的方法。</p>\n<ul>\n<li>主题继承自<code>Observable</code>，继承一些便利方法</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Subject</span> <span class=\"keyword\">extends</span> <span class=\"title\">Observable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String subject = <span class=\"string\">\"play with some fun\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">push</span><span class=\"params\">(String message)</span> </span>&#123;</span><br><span class=\"line\">        notifyObservers(message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getSubject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> subject;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Subject subject = <span class=\"keyword\">new</span> Subject();</span><br><span class=\"line\">        subject.addObserver(<span class=\"keyword\">new</span> Watcher(<span class=\"string\">\"001\"</span>));</span><br><span class=\"line\">        subject.addObserver(<span class=\"keyword\">new</span> Watcher(<span class=\"string\">\"007\"</span>));</span><br><span class=\"line\">        subject.setChanged();</span><br><span class=\"line\">        <span class=\"comment\">//will do nothing until setChanged() is called</span></span><br><span class=\"line\">        subject.push(<span class=\"string\">\"My watch is ended!\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>观察者继承<code>Observer</code>接口，只有一个<code>update</code>方法用来更新数据</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Watcher</span> <span class=\"keyword\">implements</span> <span class=\"title\">Observer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Watcher</span><span class=\"params\">(String id)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"My watch begins! \"</span> + id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">update</span><span class=\"params\">(Observable o, Object arg)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"-----------------------------------------------------------\"</span>);</span><br><span class=\"line\">        System.out.println(id);</span><br><span class=\"line\">        Subject subject = (Subject) o;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"subject is : \"</span> + subject.getSubject());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"update data is : \"</span> + (String)arg );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">My watch begins! 001</span><br><span class=\"line\">My watch begins! 007</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\">007</span><br><span class=\"line\">subject is : play with some fun</span><br><span class=\"line\">update data is : My watch is ended!</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\">001</span><br><span class=\"line\">subject is : play with some fun</span><br><span class=\"line\">update data is : My watch is ended!</span><br></pre></td></tr></table></figure>\n<h3 id=\"EventBus\"><a href=\"#EventBus\" class=\"headerlink\" title=\"EventBus\"></a>EventBus</h3><blockquote>\n<p>EventBus allows publish-subscribe-style communication between components without requiring the components to explicitly register with one another (and thus be aware of each other). It is designed exclusively to replace traditional Java in-process event distribution using explicit registration. It is not a general-purpose publish-subscribe system, nor is it intended for interprocess communication.</p>\n</blockquote>\n<p>EventBus的优点：</p>\n<ul>\n<li>无需定义接口，使用注解的形式。</li>\n<li>可以在一个类中实现多个事件的捕获。</li>\n</ul>\n<blockquote>\n<p>Due to erasure, no single class can implement a generic interface more than once with different type parameters. </p>\n</blockquote>\n<ul>\n<li>支持子类的捕获。</li>\n<li>支持捕获无人处理的event（让我想起了死漂）。</li>\n<li>传递的事件类型可以是任意的。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> age;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Person</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Person</span><span class=\"params\">(String name, <span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getAge</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAge</span><span class=\"params\">(<span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"Person&#123;\"</span> +</span><br><span class=\"line\">                <span class=\"string\">\"name='\"</span> + name + <span class=\"string\">'\\''</span> +</span><br><span class=\"line\">                <span class=\"string\">\", age=\"</span> + age +</span><br><span class=\"line\">                <span class=\"string\">'&#125;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Customer</span> <span class=\"keyword\">extends</span> <span class=\"title\">Person</span>  <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; hobbies;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Customer</span><span class=\"params\">(String name, <span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(name, age);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;String&gt; <span class=\"title\">getHobbies</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setHobbies</span><span class=\"params\">(List&lt;String&gt; hobbies)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hobbies = hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>定义一个<code>Person</code>类和一个<code>Customer</code>类，用于测试继承关系的捕捉</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EventBusTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        EventBus eventBus = <span class=\"keyword\">new</span> EventBus();</span><br><span class=\"line\">        eventBus.register(<span class=\"keyword\">new</span> EventBusChangeRecorder());</span><br><span class=\"line\">        Customer customer = <span class=\"keyword\">new</span> Customer(<span class=\"string\">\"customer\"</span>, <span class=\"number\">66</span>);</span><br><span class=\"line\">        Person p = <span class=\"keyword\">new</span> Person(<span class=\"string\">\"person\"</span>, <span class=\"number\">11</span>);</span><br><span class=\"line\">        eventBus.post(customer);</span><br><span class=\"line\">        eventBus.post(p);</span><br><span class=\"line\">        eventBus.post(<span class=\"keyword\">new</span> Integer(<span class=\"number\">123</span>));</span><br><span class=\"line\">        eventBus.post(<span class=\"string\">\"Hello World\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EventBusChangeRecorder</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">recordCustomerChange</span><span class=\"params\">(Customer customer)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"recieved change:\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"customer name: \"</span> + customer.getName());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"cutomer age: \"</span> + customer.getAge());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">valueChange</span><span class=\"params\">(Integer val)</span> </span>&#123;<span class=\"comment\">//注意方法的类型</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"val = \"</span> + val);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deadEvent</span><span class=\"params\">(DeadEvent deadEvent)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"deadEvent = \"</span> + deadEvent);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">hierarchy</span><span class=\"params\">(Person person)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            <span class=\"comment\">//will recieve all person and it's subtype</span></span><br><span class=\"line\">            System.out.println(person);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在我的电脑上的执行结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----------------------------------</span><br><span class=\"line\">recieved change:</span><br><span class=\"line\">customer name: customer</span><br><span class=\"line\">cutomer age: 66</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">Person&#123;name=&apos;customer&apos;, age=66&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">Person&#123;name=&apos;person&apos;, age=11&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">val = 123</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">deadEvent = DeadEvent&#123;source=EventBus&#123;default&#125;, event=Hello World&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h3><h4 id=\"listener注册过程\"><a href=\"#listener注册过程\" class=\"headerlink\" title=\"listener注册过程\"></a>listener注册过程</h4><p><code>EventBus</code>中有一个成员变量叫做<code>subscribers</code>, 负责管理所有注册进来的listener</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SubscriberRegistry subscribers = <span class=\"keyword\">new</span> SubscriberRegistry(<span class=\"keyword\">this</span>);</span><br></pre></td></tr></table></figure>\n<p><code>register(Object object)</code>方法就是调用<code>subscribers</code>的注册方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Registers all subscriber methods on &#123;<span class=\"doctag\">@code</span> object&#125; to receive events.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> object object whose subscriber methods should be registered.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(Object object)</span> </span>&#123;</span><br><span class=\"line\">  subscribers.register(object);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Registers all subscriber methods on the given listener object.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(Object listener)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//解析注解，生成&lt;EventType, ListenMethod&gt;的multimap</span></span><br><span class=\"line\">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; listenerMethods = findAllSubscribers(listener);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Map.Entry&lt;Class&lt;?&gt;, Collection&lt;Subscriber&gt;&gt; entry : listenerMethods.asMap().entrySet()) &#123;</span><br><span class=\"line\">    Class&lt;?&gt; eventType = entry.getKey();</span><br><span class=\"line\">    Collection&lt;Subscriber&gt; eventMethodsInListener = entry.getValue();</span><br><span class=\"line\"></span><br><span class=\"line\">    CopyOnWriteArraySet&lt;Subscriber&gt; eventSubscribers = subscribers.get(eventType);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//新建或者添加到已有的事件对应的Listener中</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventSubscribers == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      CopyOnWriteArraySet&lt;Subscriber&gt; newSet = <span class=\"keyword\">new</span> CopyOnWriteArraySet&lt;Subscriber&gt;();</span><br><span class=\"line\">      eventSubscribers =</span><br><span class=\"line\">          MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    eventSubscribers.addAll(eventMethodsInListener);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Returns all subscribers for the given listener grouped by the type of event they subscribe to.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Multimap&lt;Class&lt;?&gt;, Subscriber&gt; findAllSubscribers(Object listener) &#123;</span><br><span class=\"line\">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; methodsInListener = HashMultimap.create();</span><br><span class=\"line\">  Class&lt;?&gt; clazz = listener.getClass();</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Method method : getAnnotatedMethods(clazz)) &#123;<span class=\"comment\">//有缓存哦</span></span><br><span class=\"line\">    Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class=\"line\">    Class&lt;?&gt; eventType = parameterTypes[<span class=\"number\">0</span>];</span><br><span class=\"line\">    methodsInListener.put(eventType, Subscriber.create(bus, listener, method));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> methodsInListener;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在<code>subscribers</code>的注册方法中完成了对注解<code>@Subscribe</code>的解析。</p>\n<h4 id=\"事件分发过程\"><a href=\"#事件分发过程\" class=\"headerlink\" title=\"事件分发过程\"></a>事件分发过程</h4><p><code>EventBus</code>的post方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Posts an event to all registered subscribers. This method will return successfully after the</span></span><br><span class=\"line\"><span class=\"comment\"> * event has been posted to all subscribers, and regardless of any exceptions thrown by</span></span><br><span class=\"line\"><span class=\"comment\"> * subscribers.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;If no subscribers have been subscribed for &#123;<span class=\"doctag\">@code</span> event&#125;'s class, and &#123;<span class=\"doctag\">@code</span> event&#125; is not</span></span><br><span class=\"line\"><span class=\"comment\"> * already a &#123;<span class=\"doctag\">@link</span> DeadEvent&#125;, it will be wrapped in a DeadEvent and reposted.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> event event to post.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">post</span><span class=\"params\">(Object event)</span> </span>&#123;</span><br><span class=\"line\">  Iterator&lt;Subscriber&gt; eventSubscribers = subscribers.getSubscribers(event);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (eventSubscribers.hasNext()) &#123;</span><br><span class=\"line\">    dispatcher.dispatch(event, eventSubscribers);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!(event <span class=\"keyword\">instanceof</span> DeadEvent)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// the event had no subscribers and was not itself a DeadEvent</span></span><br><span class=\"line\">    post(<span class=\"keyword\">new</span> DeadEvent(<span class=\"keyword\">this</span>, event));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的<code>dispatcher</code>默认是<code>Dispatcher.perThreadDispatchQueue()</code></p>\n<p>它的<code>dispatch</code>方法实现如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Per-thread queue of events to dispatch.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt; queue =</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt;() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">protected</span> Queue&lt;Event&gt; <span class=\"title\">initialValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Queues.newArrayDeque();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Per-thread dispatch state, used to avoid reentrant event dispatching.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocal&lt;Boolean&gt; dispatching =</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ThreadLocal&lt;Boolean&gt;() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">protected</span> Boolean <span class=\"title\">initialValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">dispatch</span><span class=\"params\">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//入参校验</span></span><br><span class=\"line\">  checkNotNull(event);</span><br><span class=\"line\">  checkNotNull(subscribers);</span><br><span class=\"line\">  <span class=\"comment\">//从ThreadLocal中拿到队列</span></span><br><span class=\"line\">  Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class=\"line\">  <span class=\"comment\">//先把事件入队列</span></span><br><span class=\"line\">  queueForThread.offer(<span class=\"keyword\">new</span> Event(event, subscribers));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!dispatching.get()) &#123;</span><br><span class=\"line\">    dispatching.set(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      Event nextEvent;</span><br><span class=\"line\">      <span class=\"comment\">//遍历队列中的事件，并分发给相应的订阅者</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> ((nextEvent = queueForThread.poll()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class=\"line\">          nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">      dispatching.remove();</span><br><span class=\"line\">      queue.remove();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>EventBus的注解提取（简单的缓存），构建相应的Map，以及事件的分发设计地非常好，有了一个大型系统完整的雏形。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.cnblogs.com/peida/p/EventBus.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Guava学习笔记：EventBus - peida - 博客园</a></p>\n</li>\n<li><p><a href=\"https://github.com/google/guava/wiki/EventBusExplained\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">EventBusExplained · google/guava Wiki</a></p>\n</li>\n<li><p><a href=\"https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">观察者模式 - 维基百科，自由的百科全书</a></p>\n</li>\n<li><p><a href=\"http://design-patterns.readthedocs.io/zh_CN/latest/behavioral_patterns/observer.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">观察者模式 — Graphic Design Patterns</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"从观察者模式说起\"><a href=\"#从观察者模式说起\" class=\"headerlink\" title=\"从观察者模式说起\"></a>从观察者模式说起</h2><h3 id=\"观察者模式类图\"><a href=\"#观察者模式类图\" class=\"headerlink\" title=\"观察者模式类图\"></a>观察者模式类图</h3><p>观察者模式是软件设计中经常使用到的一种模式，又叫发布-订阅模式（Publish/Subscribe）、模型-视图(Model/View)模式、源-监听器（Source/Listener）模式或从属者（Dependents）模式。</p>\n<img src=\"http://www.plantuml.com/plantuml/svg/ZL1B3e8m4Dtt51FSWCe5Z36X7825I-C2w4XGqffIJOnwTm5f1IdYRlBcVMOUESVfASuGoajon5JT2O1e9jY-4QYX1N2XyiCjIagKLvIbwpLep9Y6MeHXWGfxu9DyJ4F1KraHMlDWtFo7YawezENhX-yF4YVsb5GMkXJHUdTQYJgGFc6OB2fZP-uODgp0DNCeYg8YvO9xbXyrBR0dZB2fdMqoUw-QY4a69NKTtnM2lvjb4f4lcL0AsNvZiHw8_b1HyW80\">\n<h3 id=\"Java中的支持\"><a href=\"#Java中的支持\" class=\"headerlink\" title=\"Java中的支持\"></a>Java中的支持</h3><p>Java中有一个<code>Observable</code>类和一个<code>Observer</code>接口, <code>Observable</code>类已经实现了添加、删除观察者的方法。</p>\n<ul>\n<li>主题继承自<code>Observable</code>，继承一些便利方法</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Subject</span> <span class=\"keyword\">extends</span> <span class=\"title\">Observable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String subject = <span class=\"string\">\"play with some fun\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">push</span><span class=\"params\">(String message)</span> </span>&#123;</span><br><span class=\"line\">        notifyObservers(message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getSubject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> subject;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Subject subject = <span class=\"keyword\">new</span> Subject();</span><br><span class=\"line\">        subject.addObserver(<span class=\"keyword\">new</span> Watcher(<span class=\"string\">\"001\"</span>));</span><br><span class=\"line\">        subject.addObserver(<span class=\"keyword\">new</span> Watcher(<span class=\"string\">\"007\"</span>));</span><br><span class=\"line\">        subject.setChanged();</span><br><span class=\"line\">        <span class=\"comment\">//will do nothing until setChanged() is called</span></span><br><span class=\"line\">        subject.push(<span class=\"string\">\"My watch is ended!\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>观察者继承<code>Observer</code>接口，只有一个<code>update</code>方法用来更新数据</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Watcher</span> <span class=\"keyword\">implements</span> <span class=\"title\">Observer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Watcher</span><span class=\"params\">(String id)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"My watch begins! \"</span> + id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">update</span><span class=\"params\">(Observable o, Object arg)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"-----------------------------------------------------------\"</span>);</span><br><span class=\"line\">        System.out.println(id);</span><br><span class=\"line\">        Subject subject = (Subject) o;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"subject is : \"</span> + subject.getSubject());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"update data is : \"</span> + (String)arg );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">My watch begins! 001</span><br><span class=\"line\">My watch begins! 007</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\">007</span><br><span class=\"line\">subject is : play with some fun</span><br><span class=\"line\">update data is : My watch is ended!</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\">001</span><br><span class=\"line\">subject is : play with some fun</span><br><span class=\"line\">update data is : My watch is ended!</span><br></pre></td></tr></table></figure>\n<h3 id=\"EventBus\"><a href=\"#EventBus\" class=\"headerlink\" title=\"EventBus\"></a>EventBus</h3><blockquote>\n<p>EventBus allows publish-subscribe-style communication between components without requiring the components to explicitly register with one another (and thus be aware of each other). It is designed exclusively to replace traditional Java in-process event distribution using explicit registration. It is not a general-purpose publish-subscribe system, nor is it intended for interprocess communication.</p>\n</blockquote>\n<p>EventBus的优点：</p>\n<ul>\n<li>无需定义接口，使用注解的形式。</li>\n<li>可以在一个类中实现多个事件的捕获。</li>\n</ul>\n<blockquote>\n<p>Due to erasure, no single class can implement a generic interface more than once with different type parameters. </p>\n</blockquote>\n<ul>\n<li>支持子类的捕获。</li>\n<li>支持捕获无人处理的event（让我想起了死漂）。</li>\n<li>传递的事件类型可以是任意的。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> age;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Person</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Person</span><span class=\"params\">(String name, <span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getAge</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAge</span><span class=\"params\">(<span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"Person&#123;\"</span> +</span><br><span class=\"line\">                <span class=\"string\">\"name='\"</span> + name + <span class=\"string\">'\\''</span> +</span><br><span class=\"line\">                <span class=\"string\">\", age=\"</span> + age +</span><br><span class=\"line\">                <span class=\"string\">'&#125;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Customer</span> <span class=\"keyword\">extends</span> <span class=\"title\">Person</span>  <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; hobbies;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Customer</span><span class=\"params\">(String name, <span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(name, age);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;String&gt; <span class=\"title\">getHobbies</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setHobbies</span><span class=\"params\">(List&lt;String&gt; hobbies)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hobbies = hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>定义一个<code>Person</code>类和一个<code>Customer</code>类，用于测试继承关系的捕捉</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EventBusTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        EventBus eventBus = <span class=\"keyword\">new</span> EventBus();</span><br><span class=\"line\">        eventBus.register(<span class=\"keyword\">new</span> EventBusChangeRecorder());</span><br><span class=\"line\">        Customer customer = <span class=\"keyword\">new</span> Customer(<span class=\"string\">\"customer\"</span>, <span class=\"number\">66</span>);</span><br><span class=\"line\">        Person p = <span class=\"keyword\">new</span> Person(<span class=\"string\">\"person\"</span>, <span class=\"number\">11</span>);</span><br><span class=\"line\">        eventBus.post(customer);</span><br><span class=\"line\">        eventBus.post(p);</span><br><span class=\"line\">        eventBus.post(<span class=\"keyword\">new</span> Integer(<span class=\"number\">123</span>));</span><br><span class=\"line\">        eventBus.post(<span class=\"string\">\"Hello World\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EventBusChangeRecorder</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">recordCustomerChange</span><span class=\"params\">(Customer customer)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"recieved change:\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"customer name: \"</span> + customer.getName());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"cutomer age: \"</span> + customer.getAge());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">valueChange</span><span class=\"params\">(Integer val)</span> </span>&#123;<span class=\"comment\">//注意方法的类型</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"val = \"</span> + val);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deadEvent</span><span class=\"params\">(DeadEvent deadEvent)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"deadEvent = \"</span> + deadEvent);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Subscribe</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">hierarchy</span><span class=\"params\">(Person person)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-----------------------------------\"</span>);</span><br><span class=\"line\">            <span class=\"comment\">//will recieve all person and it's subtype</span></span><br><span class=\"line\">            System.out.println(person);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在我的电脑上的执行结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----------------------------------</span><br><span class=\"line\">recieved change:</span><br><span class=\"line\">customer name: customer</span><br><span class=\"line\">cutomer age: 66</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">Person&#123;name=&apos;customer&apos;, age=66&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">Person&#123;name=&apos;person&apos;, age=11&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">val = 123</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------------</span><br><span class=\"line\">deadEvent = DeadEvent&#123;source=EventBus&#123;default&#125;, event=Hello World&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h3><h4 id=\"listener注册过程\"><a href=\"#listener注册过程\" class=\"headerlink\" title=\"listener注册过程\"></a>listener注册过程</h4><p><code>EventBus</code>中有一个成员变量叫做<code>subscribers</code>, 负责管理所有注册进来的listener</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SubscriberRegistry subscribers = <span class=\"keyword\">new</span> SubscriberRegistry(<span class=\"keyword\">this</span>);</span><br></pre></td></tr></table></figure>\n<p><code>register(Object object)</code>方法就是调用<code>subscribers</code>的注册方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Registers all subscriber methods on &#123;<span class=\"doctag\">@code</span> object&#125; to receive events.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> object object whose subscriber methods should be registered.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(Object object)</span> </span>&#123;</span><br><span class=\"line\">  subscribers.register(object);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Registers all subscriber methods on the given listener object.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">register</span><span class=\"params\">(Object listener)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//解析注解，生成&lt;EventType, ListenMethod&gt;的multimap</span></span><br><span class=\"line\">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; listenerMethods = findAllSubscribers(listener);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Map.Entry&lt;Class&lt;?&gt;, Collection&lt;Subscriber&gt;&gt; entry : listenerMethods.asMap().entrySet()) &#123;</span><br><span class=\"line\">    Class&lt;?&gt; eventType = entry.getKey();</span><br><span class=\"line\">    Collection&lt;Subscriber&gt; eventMethodsInListener = entry.getValue();</span><br><span class=\"line\"></span><br><span class=\"line\">    CopyOnWriteArraySet&lt;Subscriber&gt; eventSubscribers = subscribers.get(eventType);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//新建或者添加到已有的事件对应的Listener中</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventSubscribers == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      CopyOnWriteArraySet&lt;Subscriber&gt; newSet = <span class=\"keyword\">new</span> CopyOnWriteArraySet&lt;Subscriber&gt;();</span><br><span class=\"line\">      eventSubscribers =</span><br><span class=\"line\">          MoreObjects.firstNonNull(subscribers.putIfAbsent(eventType, newSet), newSet);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    eventSubscribers.addAll(eventMethodsInListener);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Returns all subscribers for the given listener grouped by the type of event they subscribe to.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Multimap&lt;Class&lt;?&gt;, Subscriber&gt; findAllSubscribers(Object listener) &#123;</span><br><span class=\"line\">  Multimap&lt;Class&lt;?&gt;, Subscriber&gt; methodsInListener = HashMultimap.create();</span><br><span class=\"line\">  Class&lt;?&gt; clazz = listener.getClass();</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Method method : getAnnotatedMethods(clazz)) &#123;<span class=\"comment\">//有缓存哦</span></span><br><span class=\"line\">    Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class=\"line\">    Class&lt;?&gt; eventType = parameterTypes[<span class=\"number\">0</span>];</span><br><span class=\"line\">    methodsInListener.put(eventType, Subscriber.create(bus, listener, method));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> methodsInListener;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在<code>subscribers</code>的注册方法中完成了对注解<code>@Subscribe</code>的解析。</p>\n<h4 id=\"事件分发过程\"><a href=\"#事件分发过程\" class=\"headerlink\" title=\"事件分发过程\"></a>事件分发过程</h4><p><code>EventBus</code>的post方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Posts an event to all registered subscribers. This method will return successfully after the</span></span><br><span class=\"line\"><span class=\"comment\"> * event has been posted to all subscribers, and regardless of any exceptions thrown by</span></span><br><span class=\"line\"><span class=\"comment\"> * subscribers.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;If no subscribers have been subscribed for &#123;<span class=\"doctag\">@code</span> event&#125;'s class, and &#123;<span class=\"doctag\">@code</span> event&#125; is not</span></span><br><span class=\"line\"><span class=\"comment\"> * already a &#123;<span class=\"doctag\">@link</span> DeadEvent&#125;, it will be wrapped in a DeadEvent and reposted.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> event event to post.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">post</span><span class=\"params\">(Object event)</span> </span>&#123;</span><br><span class=\"line\">  Iterator&lt;Subscriber&gt; eventSubscribers = subscribers.getSubscribers(event);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (eventSubscribers.hasNext()) &#123;</span><br><span class=\"line\">    dispatcher.dispatch(event, eventSubscribers);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!(event <span class=\"keyword\">instanceof</span> DeadEvent)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// the event had no subscribers and was not itself a DeadEvent</span></span><br><span class=\"line\">    post(<span class=\"keyword\">new</span> DeadEvent(<span class=\"keyword\">this</span>, event));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的<code>dispatcher</code>默认是<code>Dispatcher.perThreadDispatchQueue()</code></p>\n<p>它的<code>dispatch</code>方法实现如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Per-thread queue of events to dispatch.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt; queue =</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ThreadLocal&lt;Queue&lt;Event&gt;&gt;() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">protected</span> Queue&lt;Event&gt; <span class=\"title\">initialValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Queues.newArrayDeque();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Per-thread dispatch state, used to avoid reentrant event dispatching.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocal&lt;Boolean&gt; dispatching =</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ThreadLocal&lt;Boolean&gt;() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">protected</span> Boolean <span class=\"title\">initialValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">dispatch</span><span class=\"params\">(Object event, Iterator&lt;Subscriber&gt; subscribers)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//入参校验</span></span><br><span class=\"line\">  checkNotNull(event);</span><br><span class=\"line\">  checkNotNull(subscribers);</span><br><span class=\"line\">  <span class=\"comment\">//从ThreadLocal中拿到队列</span></span><br><span class=\"line\">  Queue&lt;Event&gt; queueForThread = queue.get();</span><br><span class=\"line\">  <span class=\"comment\">//先把事件入队列</span></span><br><span class=\"line\">  queueForThread.offer(<span class=\"keyword\">new</span> Event(event, subscribers));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!dispatching.get()) &#123;</span><br><span class=\"line\">    dispatching.set(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      Event nextEvent;</span><br><span class=\"line\">      <span class=\"comment\">//遍历队列中的事件，并分发给相应的订阅者</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> ((nextEvent = queueForThread.poll()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (nextEvent.subscribers.hasNext()) &#123;</span><br><span class=\"line\">          nextEvent.subscribers.next().dispatchEvent(nextEvent.event);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">      dispatching.remove();</span><br><span class=\"line\">      queue.remove();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>EventBus的注解提取（简单的缓存），构建相应的Map，以及事件的分发设计地非常好，有了一个大型系统完整的雏形。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.cnblogs.com/peida/p/EventBus.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Guava学习笔记：EventBus - peida - 博客园</a></p>\n</li>\n<li><p><a href=\"https://github.com/google/guava/wiki/EventBusExplained\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">EventBusExplained · google/guava Wiki</a></p>\n</li>\n<li><p><a href=\"https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">观察者模式 - 维基百科，自由的百科全书</a></p>\n</li>\n<li><p><a href=\"http://design-patterns.readthedocs.io/zh_CN/latest/behavioral_patterns/observer.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">观察者模式 — Graphic Design Patterns</a></p>\n</li>\n</ol>\n"},{"title":"Hexo搭建博客","abbrlink":705,"date":"2015-10-08T02:30:14.000Z","_content":"Welcome to [Hexo](http://hexo.io/)! This is your very first post. Check [documentation](http://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](http://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](http://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](http://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](http://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](http://hexo.io/docs/deployment.html)\n\n### hexo 草稿\n\n``` bash\n$ hexo new draft <title>\n$ hexo server --draft\n$ hexo publish <filename>\n```\n\n### 静态资源\n\n对于那些想要更有规律地提供图片和其他资源以及想要将他们的资源分布在各个文章上的人来说，Hexo也提供了更组织化的方式来管理资源。这个稍微有些复杂但是管理资源非常方便的功能可以通过将 config.yml 文件中的 post_asset_folder 选项设为 true 来打开。\n```\n_config.yml\npost_asset_folder: true\n```\n\n当资源文件管理功能打开后，Hexo将会在你每一次通过 hexo new [layout] <title> 命令创建新文章时自动创建一个文件夹。这个资源文件夹将会有与这个 markdown 文件一样的名字。将所有与你的文章有关的资源放在这个关联文件夹中之后，你可以通过相对路径来引用它们，这样你就得到了一个更简单而且方便得多的工作流。\n\n### 内链\n\n[Hexo使用内链及文章中加入图片的方法](http://marshal.ohtly.com/2015/09/12/internal-link-and-image-for-hexo/)\n\n```\n{% post_link ec2-build-md %}\n\n```\n\n### seo\n\n[Hexo Seo优化让你的博客在google搜索排名第一](http://www.jianshu.com/p/86557c34b671)\n\n## Markdown 语法简介\n```\n\n1、分段： 两个回车\n\n2、换行 两个空格 + 回车\n\n3、标题 #~###### 井号的个数表示几级标题，即Markdown可以表示一级标题到六级标题\n\n4、引用 >\n\n5、列表 *，+，-，1.，选其中之一，注意后面有个空格\n\n6、代码区块 四个空格开头\n\n7、链接 [文字](链接地址)\n\n8、图片 {% 图片地址 图片说明 %}\n，图片地址可以是本地路劲，也可以是网络地址\n\n9、强调 **文字**，__文字__，_文字_，*文字*\n\n10、代码 ```\n\n >[Markdown——入门指南](http://www.jianshu.com/p/1e402922ee32/)\n\n ## 在Hexo中插入gist\n\n ```\n {% gist 1f10fa5b8b76f3b5efaf74ad3d6da413  %}\n ```\n 其中一长串是gist生成的id\n\n\n## 使用markdown来画mindmap\n\n{% pullquote mindmap %}\n#主题\n##一级分支\n###二级分支\n##一级分支\n##一级分支\n###二级分支\n####三级分支\n{% endpullquote %}\n\n# 参考\n\n- [hexo的站内链接问题 | Node 小栈](http://blog.gezhiqiang.com/2016/11/27/hexo-inner-link/)","source":"_posts/hello-world.md","raw":"---\ntitle: Hexo搭建博客\ncategories: hexo\ntags: hexo install\nabbrlink: 705\ndate: 2015-10-08 10:30:14\n---\nWelcome to [Hexo](http://hexo.io/)! This is your very first post. Check [documentation](http://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](http://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](http://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](http://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](http://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](http://hexo.io/docs/deployment.html)\n\n### hexo 草稿\n\n``` bash\n$ hexo new draft <title>\n$ hexo server --draft\n$ hexo publish <filename>\n```\n\n### 静态资源\n\n对于那些想要更有规律地提供图片和其他资源以及想要将他们的资源分布在各个文章上的人来说，Hexo也提供了更组织化的方式来管理资源。这个稍微有些复杂但是管理资源非常方便的功能可以通过将 config.yml 文件中的 post_asset_folder 选项设为 true 来打开。\n```\n_config.yml\npost_asset_folder: true\n```\n\n当资源文件管理功能打开后，Hexo将会在你每一次通过 hexo new [layout] <title> 命令创建新文章时自动创建一个文件夹。这个资源文件夹将会有与这个 markdown 文件一样的名字。将所有与你的文章有关的资源放在这个关联文件夹中之后，你可以通过相对路径来引用它们，这样你就得到了一个更简单而且方便得多的工作流。\n\n### 内链\n\n[Hexo使用内链及文章中加入图片的方法](http://marshal.ohtly.com/2015/09/12/internal-link-and-image-for-hexo/)\n\n```\n{% post_link ec2-build-md %}\n\n```\n\n### seo\n\n[Hexo Seo优化让你的博客在google搜索排名第一](http://www.jianshu.com/p/86557c34b671)\n\n## Markdown 语法简介\n```\n\n1、分段： 两个回车\n\n2、换行 两个空格 + 回车\n\n3、标题 #~###### 井号的个数表示几级标题，即Markdown可以表示一级标题到六级标题\n\n4、引用 >\n\n5、列表 *，+，-，1.，选其中之一，注意后面有个空格\n\n6、代码区块 四个空格开头\n\n7、链接 [文字](链接地址)\n\n8、图片 {% 图片地址 图片说明 %}\n，图片地址可以是本地路劲，也可以是网络地址\n\n9、强调 **文字**，__文字__，_文字_，*文字*\n\n10、代码 ```\n\n >[Markdown——入门指南](http://www.jianshu.com/p/1e402922ee32/)\n\n ## 在Hexo中插入gist\n\n ```\n {% gist 1f10fa5b8b76f3b5efaf74ad3d6da413  %}\n ```\n 其中一长串是gist生成的id\n\n\n## 使用markdown来画mindmap\n\n{% pullquote mindmap %}\n#主题\n##一级分支\n###二级分支\n##一级分支\n##一级分支\n###二级分支\n####三级分支\n{% endpullquote %}\n\n# 参考\n\n- [hexo的站内链接问题 | Node 小栈](http://blog.gezhiqiang.com/2016/11/27/hexo-inner-link/)","slug":"hello-world","published":1,"updated":"2018-05-05T03:20:45.429Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9c006cjh4kblicnzzp","content":"<p>Welcome to <a href=\"http://hexo.io/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo</a>! This is your very first post. Check <a href=\"http://hexo.io/docs/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"http://hexo.io/docs/troubleshooting.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/writing.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/server.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/generating.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/deployment.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Deployment</a></p>\n<h3 id=\"hexo-草稿\"><a href=\"#hexo-草稿\" class=\"headerlink\" title=\"hexo 草稿\"></a>hexo 草稿</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new draft &lt;title&gt;</span><br><span class=\"line\">$ hexo server --draft</span><br><span class=\"line\">$ hexo publish &lt;filename&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"静态资源\"><a href=\"#静态资源\" class=\"headerlink\" title=\"静态资源\"></a>静态资源</h3><p>对于那些想要更有规律地提供图片和其他资源以及想要将他们的资源分布在各个文章上的人来说，Hexo也提供了更组织化的方式来管理资源。这个稍微有些复杂但是管理资源非常方便的功能可以通过将 config.yml 文件中的 post_asset_folder 选项设为 true 来打开。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_config.yml</span><br><span class=\"line\">post_asset_folder: true</span><br></pre></td></tr></table></figure></p>\n<p>当资源文件管理功能打开后，Hexo将会在你每一次通过 hexo new [layout] <title> 命令创建新文章时自动创建一个文件夹。这个资源文件夹将会有与这个 markdown 文件一样的名字。将所有与你的文章有关的资源放在这个关联文件夹中之后，你可以通过相对路径来引用它们，这样你就得到了一个更简单而且方便得多的工作流。</title></p>\n<h3 id=\"内链\"><a href=\"#内链\" class=\"headerlink\" title=\"内链\"></a>内链</h3><p><a href=\"http://marshal.ohtly.com/2015/09/12/internal-link-and-image-for-hexo/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo使用内链及文章中加入图片的方法</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% post_link ec2-build-md %&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"seo\"><a href=\"#seo\" class=\"headerlink\" title=\"seo\"></a>seo</h3><p><a href=\"http://www.jianshu.com/p/86557c34b671\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo Seo优化让你的博客在google搜索排名第一</a></p>\n<h2 id=\"Markdown-语法简介\"><a href=\"#Markdown-语法简介\" class=\"headerlink\" title=\"Markdown 语法简介\"></a>Markdown 语法简介</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">1、分段： 两个回车</span><br><span class=\"line\"></span><br><span class=\"line\">2、换行 两个空格 + 回车</span><br><span class=\"line\"></span><br><span class=\"line\">3、标题 #~###### 井号的个数表示几级标题，即Markdown可以表示一级标题到六级标题</span><br><span class=\"line\"></span><br><span class=\"line\">4、引用 &gt;</span><br><span class=\"line\"></span><br><span class=\"line\">5、列表 *，+，-，1.，选其中之一，注意后面有个空格</span><br><span class=\"line\"></span><br><span class=\"line\">6、代码区块 四个空格开头</span><br><span class=\"line\"></span><br><span class=\"line\">7、链接 [文字](链接地址)</span><br><span class=\"line\"></span><br><span class=\"line\">8、图片 &#123;% 图片地址 图片说明 %&#125;</span><br><span class=\"line\">，图片地址可以是本地路劲，也可以是网络地址</span><br><span class=\"line\"></span><br><span class=\"line\">9、强调 **文字**，__文字__，_文字_，*文字*</span><br><span class=\"line\"></span><br><span class=\"line\">10、代码</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><a href=\"http://www.jianshu.com/p/1e402922ee32/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Markdown——入门指南</a></p>\n</blockquote>\n<h2 id=\"在Hexo中插入gist\"><a href=\"#在Hexo中插入gist\" class=\"headerlink\" title=\"在Hexo中插入gist\"></a>在Hexo中插入gist</h2> <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% gist 1f10fa5b8b76f3b5efaf74ad3d6da413  %&#125;</span><br></pre></td></tr></table></figure>\n<p> 其中一长串是gist生成的id</p>\n<h2 id=\"使用markdown来画mindmap\"><a href=\"#使用markdown来画mindmap\" class=\"headerlink\" title=\"使用markdown来画mindmap\"></a>使用markdown来画mindmap</h2><blockquote class=\"pullquote mindmap\"><p>#主题</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>##一级分支</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>####三级分支</p>\n</blockquote>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"http://blog.gezhiqiang.com/2016/11/27/hexo-inner-link/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">hexo的站内链接问题 | Node 小栈</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>Welcome to <a href=\"http://hexo.io/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo</a>! This is your very first post. Check <a href=\"http://hexo.io/docs/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"http://hexo.io/docs/troubleshooting.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/writing.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/server.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/generating.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/deployment.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Deployment</a></p>\n<h3 id=\"hexo-草稿\"><a href=\"#hexo-草稿\" class=\"headerlink\" title=\"hexo 草稿\"></a>hexo 草稿</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new draft &lt;title&gt;</span><br><span class=\"line\">$ hexo server --draft</span><br><span class=\"line\">$ hexo publish &lt;filename&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"静态资源\"><a href=\"#静态资源\" class=\"headerlink\" title=\"静态资源\"></a>静态资源</h3><p>对于那些想要更有规律地提供图片和其他资源以及想要将他们的资源分布在各个文章上的人来说，Hexo也提供了更组织化的方式来管理资源。这个稍微有些复杂但是管理资源非常方便的功能可以通过将 config.yml 文件中的 post_asset_folder 选项设为 true 来打开。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_config.yml</span><br><span class=\"line\">post_asset_folder: true</span><br></pre></td></tr></table></figure></p>\n<p>当资源文件管理功能打开后，Hexo将会在你每一次通过 hexo new [layout] <title> 命令创建新文章时自动创建一个文件夹。这个资源文件夹将会有与这个 markdown 文件一样的名字。将所有与你的文章有关的资源放在这个关联文件夹中之后，你可以通过相对路径来引用它们，这样你就得到了一个更简单而且方便得多的工作流。</title></p>\n<h3 id=\"内链\"><a href=\"#内链\" class=\"headerlink\" title=\"内链\"></a>内链</h3><p><a href=\"http://marshal.ohtly.com/2015/09/12/internal-link-and-image-for-hexo/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo使用内链及文章中加入图片的方法</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% post_link ec2-build-md %&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"seo\"><a href=\"#seo\" class=\"headerlink\" title=\"seo\"></a>seo</h3><p><a href=\"http://www.jianshu.com/p/86557c34b671\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo Seo优化让你的博客在google搜索排名第一</a></p>\n<h2 id=\"Markdown-语法简介\"><a href=\"#Markdown-语法简介\" class=\"headerlink\" title=\"Markdown 语法简介\"></a>Markdown 语法简介</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">1、分段： 两个回车</span><br><span class=\"line\"></span><br><span class=\"line\">2、换行 两个空格 + 回车</span><br><span class=\"line\"></span><br><span class=\"line\">3、标题 #~###### 井号的个数表示几级标题，即Markdown可以表示一级标题到六级标题</span><br><span class=\"line\"></span><br><span class=\"line\">4、引用 &gt;</span><br><span class=\"line\"></span><br><span class=\"line\">5、列表 *，+，-，1.，选其中之一，注意后面有个空格</span><br><span class=\"line\"></span><br><span class=\"line\">6、代码区块 四个空格开头</span><br><span class=\"line\"></span><br><span class=\"line\">7、链接 [文字](链接地址)</span><br><span class=\"line\"></span><br><span class=\"line\">8、图片 &#123;% 图片地址 图片说明 %&#125;</span><br><span class=\"line\">，图片地址可以是本地路劲，也可以是网络地址</span><br><span class=\"line\"></span><br><span class=\"line\">9、强调 **文字**，__文字__，_文字_，*文字*</span><br><span class=\"line\"></span><br><span class=\"line\">10、代码</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><a href=\"http://www.jianshu.com/p/1e402922ee32/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Markdown——入门指南</a></p>\n</blockquote>\n<h2 id=\"在Hexo中插入gist\"><a href=\"#在Hexo中插入gist\" class=\"headerlink\" title=\"在Hexo中插入gist\"></a>在Hexo中插入gist</h2> <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% gist 1f10fa5b8b76f3b5efaf74ad3d6da413  %&#125;</span><br></pre></td></tr></table></figure>\n<p> 其中一长串是gist生成的id</p>\n<h2 id=\"使用markdown来画mindmap\"><a href=\"#使用markdown来画mindmap\" class=\"headerlink\" title=\"使用markdown来画mindmap\"></a>使用markdown来画mindmap</h2><blockquote class=\"pullquote mindmap\"><p>#主题</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>##一级分支</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>####三级分支</p>\n</blockquote>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"http://blog.gezhiqiang.com/2016/11/27/hexo-inner-link/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">hexo的站内链接问题 | Node 小栈</a></li>\n</ul>\n"},{"title":"Intellij Idea中临时文件功能","toc":true,"abbrlink":15997,"date":"2017-02-14T17:10:09.000Z","_content":"\n\n## 缘起\n\nIntellij中默认新建文件必须指定存储的位置，但是有的时候我们可能只是想创建一个临时的文件顺手记录一些东西。这个功能类似`NotePad++`或者`sublime text`中的新建tab，这个tab默认是不落地到文件的，但是其中的内容会以临时文件存储起来。\n    \n在Google上搜索了大半天，也没有找到类似的功能（主要是关键词提炼的不行）。后来阴差阳错地搜到了scratches file, 翻译了一下，正是我要找的功能！ (英语差真是害死人啊！)\n\n> scratch file 过期文件；临时文件\n\n### scratches优势\n\n>1. The scratch code in scripting languages is *executable*.\n\n>2. you can run and *debug* it.\n\n>3. *Local history* for scratches is supported.\n\n>4. It is possible to perform *clipboard operations* with scratches.\n\n>5. The scratches are *stored*, depending on your operating system,\nUnder IntelliJ IDEA home, in the directory config/scratches (on Windows/*NIX)\n~ Library->Preferences-><IntelliJ IDEA>XX->scratches(on OS X)\nYou can undo or redo changes in scratches.\n\n### 使用\n\n以下功能基于Intellij Idea 2016.3.4\n\n`Ctrl + Shift + A`在搜索框中输入 `scratch`，可以看到如下的两个功能：\n\n{%  asset_img   search.jpg  %}\n\n这里会出现两个scratch 相关的选项， 一个是scratch buffer， 一个是scratch file。\nscratch buffer不用选择语法，scratch file则会让你选择对应的语法\n\n{%  asset_img   new.jpg  %}\n\n创建之后，可以在下面的位置查看:\n\n{%  asset_img   menu.jpg  %}\n\n{%  asset_img   scratches.jpg  %}\n\n### 其他\n\n快捷键需要按的键比较多，可以自己定制下，比如使用先后按键的那种。\n\n{%  asset_img   keymap.jpg  %}\n\n## 参考\n\n1. [IntelliJ IDEA 2016.3 Help :: Scratches](https://www.jetbrains.com/help/idea/2016.3/scratches.html)\n\n2. [Sessions And Projects - Notepad++ Wiki](http://docs.notepad-plus-plus.org/index.php/Sessions_And_Projects)\n","source":"_posts/idea-scratches.md","raw":"---\ntitle: Intellij Idea中临时文件功能\ncategory: idea\ntoc: true\nabbrlink: 15997\ndate: 2017-02-15 01:10:09\ntags:\n---\n\n\n## 缘起\n\nIntellij中默认新建文件必须指定存储的位置，但是有的时候我们可能只是想创建一个临时的文件顺手记录一些东西。这个功能类似`NotePad++`或者`sublime text`中的新建tab，这个tab默认是不落地到文件的，但是其中的内容会以临时文件存储起来。\n    \n在Google上搜索了大半天，也没有找到类似的功能（主要是关键词提炼的不行）。后来阴差阳错地搜到了scratches file, 翻译了一下，正是我要找的功能！ (英语差真是害死人啊！)\n\n> scratch file 过期文件；临时文件\n\n### scratches优势\n\n>1. The scratch code in scripting languages is *executable*.\n\n>2. you can run and *debug* it.\n\n>3. *Local history* for scratches is supported.\n\n>4. It is possible to perform *clipboard operations* with scratches.\n\n>5. The scratches are *stored*, depending on your operating system,\nUnder IntelliJ IDEA home, in the directory config/scratches (on Windows/*NIX)\n~ Library->Preferences-><IntelliJ IDEA>XX->scratches(on OS X)\nYou can undo or redo changes in scratches.\n\n### 使用\n\n以下功能基于Intellij Idea 2016.3.4\n\n`Ctrl + Shift + A`在搜索框中输入 `scratch`，可以看到如下的两个功能：\n\n{%  asset_img   search.jpg  %}\n\n这里会出现两个scratch 相关的选项， 一个是scratch buffer， 一个是scratch file。\nscratch buffer不用选择语法，scratch file则会让你选择对应的语法\n\n{%  asset_img   new.jpg  %}\n\n创建之后，可以在下面的位置查看:\n\n{%  asset_img   menu.jpg  %}\n\n{%  asset_img   scratches.jpg  %}\n\n### 其他\n\n快捷键需要按的键比较多，可以自己定制下，比如使用先后按键的那种。\n\n{%  asset_img   keymap.jpg  %}\n\n## 参考\n\n1. [IntelliJ IDEA 2016.3 Help :: Scratches](https://www.jetbrains.com/help/idea/2016.3/scratches.html)\n\n2. [Sessions And Projects - Notepad++ Wiki](http://docs.notepad-plus-plus.org/index.php/Sessions_And_Projects)\n","slug":"idea-scratches","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9d006gjh4kp06lr90k","content":"<h2 id=\"缘起\"><a href=\"#缘起\" class=\"headerlink\" title=\"缘起\"></a>缘起</h2><p>Intellij中默认新建文件必须指定存储的位置，但是有的时候我们可能只是想创建一个临时的文件顺手记录一些东西。这个功能类似<code>NotePad++</code>或者<code>sublime text</code>中的新建tab，这个tab默认是不落地到文件的，但是其中的内容会以临时文件存储起来。</p>\n<p>在Google上搜索了大半天，也没有找到类似的功能（主要是关键词提炼的不行）。后来阴差阳错地搜到了scratches file, 翻译了一下，正是我要找的功能！ (英语差真是害死人啊！)</p>\n<blockquote>\n<p>scratch file 过期文件；临时文件</p>\n</blockquote>\n<h3 id=\"scratches优势\"><a href=\"#scratches优势\" class=\"headerlink\" title=\"scratches优势\"></a>scratches优势</h3><blockquote>\n<ol>\n<li><p>The scratch code in scripting languages is <em>executable</em>.</p>\n</li>\n<li><p>you can run and <em>debug</em> it.</p>\n</li>\n<li><p><em>Local history</em> for scratches is supported.</p>\n</li>\n<li><p>It is possible to perform <em>clipboard operations</em> with scratches.</p>\n</li>\n<li><p>The scratches are <em>stored</em>, depending on your operating system,<br>Under IntelliJ IDEA home, in the directory config/scratches (on Windows/*NIX)<br>~ Library-&gt;Preferences-&gt;<intellij idea=\"\">XX-&gt;scratches(on OS X)<br>You can undo or redo changes in scratches.</intellij></p>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><p>以下功能基于Intellij Idea 2016.3.4</p>\n<p><code>Ctrl + Shift + A</code>在搜索框中输入 <code>scratch</code>，可以看到如下的两个功能：</p>\n<img src=\"/2017/02/15/idea-scratches/search.jpg\">\n<p>这里会出现两个scratch 相关的选项， 一个是scratch buffer， 一个是scratch file。<br>scratch buffer不用选择语法，scratch file则会让你选择对应的语法</p>\n<img src=\"/2017/02/15/idea-scratches/new.jpg\">\n<p>创建之后，可以在下面的位置查看:</p>\n<img src=\"/2017/02/15/idea-scratches/menu.jpg\">\n<img src=\"/2017/02/15/idea-scratches/scratches.jpg\">\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><p>快捷键需要按的键比较多，可以自己定制下，比如使用先后按键的那种。</p>\n<img src=\"/2017/02/15/idea-scratches/keymap.jpg\">\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://www.jetbrains.com/help/idea/2016.3/scratches.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">IntelliJ IDEA 2016.3 Help :: Scratches</a></p>\n</li>\n<li><p><a href=\"http://docs.notepad-plus-plus.org/index.php/Sessions_And_Projects\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Sessions And Projects - Notepad++ Wiki</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"缘起\"><a href=\"#缘起\" class=\"headerlink\" title=\"缘起\"></a>缘起</h2><p>Intellij中默认新建文件必须指定存储的位置，但是有的时候我们可能只是想创建一个临时的文件顺手记录一些东西。这个功能类似<code>NotePad++</code>或者<code>sublime text</code>中的新建tab，这个tab默认是不落地到文件的，但是其中的内容会以临时文件存储起来。</p>\n<p>在Google上搜索了大半天，也没有找到类似的功能（主要是关键词提炼的不行）。后来阴差阳错地搜到了scratches file, 翻译了一下，正是我要找的功能！ (英语差真是害死人啊！)</p>\n<blockquote>\n<p>scratch file 过期文件；临时文件</p>\n</blockquote>\n<h3 id=\"scratches优势\"><a href=\"#scratches优势\" class=\"headerlink\" title=\"scratches优势\"></a>scratches优势</h3><blockquote>\n<ol>\n<li><p>The scratch code in scripting languages is <em>executable</em>.</p>\n</li>\n<li><p>you can run and <em>debug</em> it.</p>\n</li>\n<li><p><em>Local history</em> for scratches is supported.</p>\n</li>\n<li><p>It is possible to perform <em>clipboard operations</em> with scratches.</p>\n</li>\n<li><p>The scratches are <em>stored</em>, depending on your operating system,<br>Under IntelliJ IDEA home, in the directory config/scratches (on Windows/*NIX)<br>~ Library-&gt;Preferences-&gt;<intellij idea=\"\">XX-&gt;scratches(on OS X)<br>You can undo or redo changes in scratches.</intellij></p>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><p>以下功能基于Intellij Idea 2016.3.4</p>\n<p><code>Ctrl + Shift + A</code>在搜索框中输入 <code>scratch</code>，可以看到如下的两个功能：</p>\n<img src=\"/2017/02/15/idea-scratches/search.jpg\">\n<p>这里会出现两个scratch 相关的选项， 一个是scratch buffer， 一个是scratch file。<br>scratch buffer不用选择语法，scratch file则会让你选择对应的语法</p>\n<img src=\"/2017/02/15/idea-scratches/new.jpg\">\n<p>创建之后，可以在下面的位置查看:</p>\n<img src=\"/2017/02/15/idea-scratches/menu.jpg\">\n<img src=\"/2017/02/15/idea-scratches/scratches.jpg\">\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><p>快捷键需要按的键比较多，可以自己定制下，比如使用先后按键的那种。</p>\n<img src=\"/2017/02/15/idea-scratches/keymap.jpg\">\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://www.jetbrains.com/help/idea/2016.3/scratches.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">IntelliJ IDEA 2016.3 Help :: Scratches</a></p>\n</li>\n<li><p><a href=\"http://docs.notepad-plus-plus.org/index.php/Sessions_And_Projects\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Sessions And Projects - Notepad++ Wiki</a></p>\n</li>\n</ol>\n"},{"title":"Linux下删除文件","toc":true,"abbrlink":10191,"date":"2017-09-10T04:20:09.000Z","_content":"\n\n# 文件存储\n\n{%  asset_img   inode.png  linux文件的存储 %}\n\n## 软链接和硬链接\n\n软链接(Symbolic Link):\n\n硬链接(Hard Link):\n\n> 硬链接就是在Directory中加入一条filename和Inode的对应关系，所以如果你删除了原来的文件，是不对硬链接文件有任何影响的，因为删除文件就是将link count 减少，当发现指向Inode为filename数量0的时候，系统会回收相应的Inode和Block空间。但是软链接就不同了，在Linux下所有的都是文件，所以软链接也有自己的Inode和block ，但是创建软链接不会在增加原文件Inode-Index，当删除原文件的时候，相应的Index不再能找到，所以导致软链接不能用。但是软链接有自身的优势，可以跨分区，这样就可以解决当前Inode数据区不足够写入，可以使用软链接指向空间充足的空间。\n\n### 区别\n\n软链接  硬链接 区别\n\n{%  asset_img   links.png  软链接和硬链接的区别 %}\n\n\n## 文件是否被占用\n\n一切皆文件，所以lsof（list open file）就很重要\n\nlsof -i ：8080 查看端口占用\n\nsocket 也是文件\n\n\n```\nsudo lsof  catalina.out\n\nCOMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF     NODE NAME\njava    40916 tomcat    1w   REG    8,7   933679 27656540 catalina.out\njava    40916 tomcat    2w   REG    8,7   933679 27656540 catalina.out\n```\n\n>‘‘REG’’ for a regular file\n> FD         is the File Descriptor number of the file or:\n\n                       cwd  current working directory;\n                       Lnn  library references (AIX);\n                       err  FD information error (see NAME column);\n                       jld  jail directory (FreeBSD);\n                       ltx  shared library text (code and data);\n                       Mxx  hex memory-mapped type number xx.\n                       m86  DOS Merge mapped file;\n                       mem  memory-mapped file;\n                       mmap memory-mapped device;\n                       pd   parent directory;\n                       rtd  root directory;\n                       tr   kernel trace file (OpenBSD);\n                       txt  program text (code and data);\n                       v86  VP/ix mapped file;\n\n                  FD is followed by one of these characters, describing the mode under which the file is open:\n\n                       r for read access;\n                       w for write access;\n                       u for read and write access;\n                       space if mode unknown and no lock\n                            character follows;\n                       ‘-’ if mode unknown and lock\n                            character follows.\n\n\n可以看出上面的文件的fd是1, w权限\n\n\n\n系统，每个进程，文件描述符。\n\n```bash\nsudo ls /proc/40916/fd\n```\n\n下面的两个命令是等价的：\n\n```bash\nsudo cat /proc/40916/fd/2\n\nsudo cat catalina.out\n```\n## 删除文件\n\n删除文件之前应该先看下文件的占用情况，`lsof`可以查看到文件被哪个进程占用。\n\n如果被占用，直接使用`rm`删除相当于只是删除了文件名和inode的关联, 但是文件占用的空间还在(block), 应该使用下面的命令进行删除：\n\n\n> You misunderstand: deletion will be complete only after all processes using the file at the time of deletion have reached completion: only then the deleted inode will be returned to the pool of available inodes, and the content of the file may begin to be corrupted by over-writing. Until then, the inode is alive and well, and is pointing to the area of the disk containing the file in question. As soon as less completes, the soft link will disappear, and so will the file testing.txt.\n\n> \t当我们使用rm命令的时候，系统并不会真正删除这个资料。除非有档案非要将资料存储在原来档案的这些block中。这样原来的block就会被新档案给覆盖掉。 \n\n\n```bash\ncat /dev/null > filename\n或者\ntruncate -s 0 filename\n```\n\n### stat 命令\n\n```bash\nsudo stat /proc/40916/fd/2\n\nFile: `/proc/40916/fd/2' -> `/home/q/www/qta.open.coupon.provider/logs/catalina.out'\n  Size: 64        \tBlocks: 0          IO Block: 1024   symbolic link\nDevice: 3h/3d\tInode: 3017464897  Links: 1\nAccess: (0300/l-wx------)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)\nAccess: 2017-07-05 05:05:06.318550652 +0800\nModify: 2017-06-15 12:35:24.590599522 +0800\nChange: 2017-06-15 12:35:24.590599522 +0800\n\n\nsudo stat catalina.out\n\nFile: `catalina.out'\n  Size: 962851    \tBlocks: 1896       IO Block: 4096   regular file\nDevice: 807h/2055d\tInode: 27656540    Links: 1\nAccess: (0644/-rw-r--r--)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)\nAccess: 2017-07-06 00:51:44.243427414 +0800\nModify: 2017-07-06 00:52:27.096557541 +0800\nChange: 2017-07-06 00:52:27.096557541 +0800\n\nsudo ls -i /proc/40916/fd/2\n\n3017464897 /proc/40916/fd/2\n```\n\n可以看出, 文件描述符是一个软链接.\n\n### 目录下的文件占用空间很小, 但是目录占用空间很大\n\n这种情况, 最常见的就是文件被删除了, 但是还有进程占用它. 于是这个文件占用的block就没有释放掉.\n\n```bash\nsudo lsof | grep deleted\n```\n\n使用上面的命令就可以看到,那些文件被删除了, 但是还在被占用.  kill掉相应的进程, 空间就自己回来了.\n\n\n\n## 参考\n\n1. [3. lsof 一切皆文件 — Linux Tools Quick Tutorial](http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/lsof.html)\n\n2. [How to clean log file? - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/92384/how-to-clean-log-file)\n\n3. [shell script - Empty the contents of a file - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/88808/empty-the-contents-of-a-file)\n\n4. [通过Inode原理分析Linux中ln命令 - Michael Chu - ITeye技术网站](http://himichaelchu.iteye.com/blog/2116023)\n\n5. [理解 Linux 的硬链接与软链接](https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html)\n\n6. [linux - why do symbolic links in /prox/$PID/fd/ act as hard links? - Super User](https://superuser.com/questions/1112781/why-do-symbolic-links-in-prox-pid-fd-act-as-hard-links)","source":"_posts/how-to-delete-file-correctly.md","raw":"title: Linux下删除文件\ntags: lsof\ncategory: linux\ntoc: true\nabbrlink: 10191\ndate: 2017-09-10 12:20:09\n---\n\n\n# 文件存储\n\n{%  asset_img   inode.png  linux文件的存储 %}\n\n## 软链接和硬链接\n\n软链接(Symbolic Link):\n\n硬链接(Hard Link):\n\n> 硬链接就是在Directory中加入一条filename和Inode的对应关系，所以如果你删除了原来的文件，是不对硬链接文件有任何影响的，因为删除文件就是将link count 减少，当发现指向Inode为filename数量0的时候，系统会回收相应的Inode和Block空间。但是软链接就不同了，在Linux下所有的都是文件，所以软链接也有自己的Inode和block ，但是创建软链接不会在增加原文件Inode-Index，当删除原文件的时候，相应的Index不再能找到，所以导致软链接不能用。但是软链接有自身的优势，可以跨分区，这样就可以解决当前Inode数据区不足够写入，可以使用软链接指向空间充足的空间。\n\n### 区别\n\n软链接  硬链接 区别\n\n{%  asset_img   links.png  软链接和硬链接的区别 %}\n\n\n## 文件是否被占用\n\n一切皆文件，所以lsof（list open file）就很重要\n\nlsof -i ：8080 查看端口占用\n\nsocket 也是文件\n\n\n```\nsudo lsof  catalina.out\n\nCOMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF     NODE NAME\njava    40916 tomcat    1w   REG    8,7   933679 27656540 catalina.out\njava    40916 tomcat    2w   REG    8,7   933679 27656540 catalina.out\n```\n\n>‘‘REG’’ for a regular file\n> FD         is the File Descriptor number of the file or:\n\n                       cwd  current working directory;\n                       Lnn  library references (AIX);\n                       err  FD information error (see NAME column);\n                       jld  jail directory (FreeBSD);\n                       ltx  shared library text (code and data);\n                       Mxx  hex memory-mapped type number xx.\n                       m86  DOS Merge mapped file;\n                       mem  memory-mapped file;\n                       mmap memory-mapped device;\n                       pd   parent directory;\n                       rtd  root directory;\n                       tr   kernel trace file (OpenBSD);\n                       txt  program text (code and data);\n                       v86  VP/ix mapped file;\n\n                  FD is followed by one of these characters, describing the mode under which the file is open:\n\n                       r for read access;\n                       w for write access;\n                       u for read and write access;\n                       space if mode unknown and no lock\n                            character follows;\n                       ‘-’ if mode unknown and lock\n                            character follows.\n\n\n可以看出上面的文件的fd是1, w权限\n\n\n\n系统，每个进程，文件描述符。\n\n```bash\nsudo ls /proc/40916/fd\n```\n\n下面的两个命令是等价的：\n\n```bash\nsudo cat /proc/40916/fd/2\n\nsudo cat catalina.out\n```\n## 删除文件\n\n删除文件之前应该先看下文件的占用情况，`lsof`可以查看到文件被哪个进程占用。\n\n如果被占用，直接使用`rm`删除相当于只是删除了文件名和inode的关联, 但是文件占用的空间还在(block), 应该使用下面的命令进行删除：\n\n\n> You misunderstand: deletion will be complete only after all processes using the file at the time of deletion have reached completion: only then the deleted inode will be returned to the pool of available inodes, and the content of the file may begin to be corrupted by over-writing. Until then, the inode is alive and well, and is pointing to the area of the disk containing the file in question. As soon as less completes, the soft link will disappear, and so will the file testing.txt.\n\n> \t当我们使用rm命令的时候，系统并不会真正删除这个资料。除非有档案非要将资料存储在原来档案的这些block中。这样原来的block就会被新档案给覆盖掉。 \n\n\n```bash\ncat /dev/null > filename\n或者\ntruncate -s 0 filename\n```\n\n### stat 命令\n\n```bash\nsudo stat /proc/40916/fd/2\n\nFile: `/proc/40916/fd/2' -> `/home/q/www/qta.open.coupon.provider/logs/catalina.out'\n  Size: 64        \tBlocks: 0          IO Block: 1024   symbolic link\nDevice: 3h/3d\tInode: 3017464897  Links: 1\nAccess: (0300/l-wx------)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)\nAccess: 2017-07-05 05:05:06.318550652 +0800\nModify: 2017-06-15 12:35:24.590599522 +0800\nChange: 2017-06-15 12:35:24.590599522 +0800\n\n\nsudo stat catalina.out\n\nFile: `catalina.out'\n  Size: 962851    \tBlocks: 1896       IO Block: 4096   regular file\nDevice: 807h/2055d\tInode: 27656540    Links: 1\nAccess: (0644/-rw-r--r--)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)\nAccess: 2017-07-06 00:51:44.243427414 +0800\nModify: 2017-07-06 00:52:27.096557541 +0800\nChange: 2017-07-06 00:52:27.096557541 +0800\n\nsudo ls -i /proc/40916/fd/2\n\n3017464897 /proc/40916/fd/2\n```\n\n可以看出, 文件描述符是一个软链接.\n\n### 目录下的文件占用空间很小, 但是目录占用空间很大\n\n这种情况, 最常见的就是文件被删除了, 但是还有进程占用它. 于是这个文件占用的block就没有释放掉.\n\n```bash\nsudo lsof | grep deleted\n```\n\n使用上面的命令就可以看到,那些文件被删除了, 但是还在被占用.  kill掉相应的进程, 空间就自己回来了.\n\n\n\n## 参考\n\n1. [3. lsof 一切皆文件 — Linux Tools Quick Tutorial](http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/lsof.html)\n\n2. [How to clean log file? - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/92384/how-to-clean-log-file)\n\n3. [shell script - Empty the contents of a file - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/88808/empty-the-contents-of-a-file)\n\n4. [通过Inode原理分析Linux中ln命令 - Michael Chu - ITeye技术网站](http://himichaelchu.iteye.com/blog/2116023)\n\n5. [理解 Linux 的硬链接与软链接](https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html)\n\n6. [linux - why do symbolic links in /prox/$PID/fd/ act as hard links? - Super User](https://superuser.com/questions/1112781/why-do-symbolic-links-in-prox-pid-fd-act-as-hard-links)","slug":"how-to-delete-file-correctly","published":1,"updated":"2017-09-10T04:20:09.254Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9e006ijh4khkpj1kc5","content":"<h1 id=\"文件存储\"><a href=\"#文件存储\" class=\"headerlink\" title=\"文件存储\"></a>文件存储</h1><img src=\"/2017/09/10/how-to-delete-file-correctly/inode.png\" title=\"linux文件的存储\">\n<h2 id=\"软链接和硬链接\"><a href=\"#软链接和硬链接\" class=\"headerlink\" title=\"软链接和硬链接\"></a>软链接和硬链接</h2><p>软链接(Symbolic Link):</p>\n<p>硬链接(Hard Link):</p>\n<blockquote>\n<p>硬链接就是在Directory中加入一条filename和Inode的对应关系，所以如果你删除了原来的文件，是不对硬链接文件有任何影响的，因为删除文件就是将link count 减少，当发现指向Inode为filename数量0的时候，系统会回收相应的Inode和Block空间。但是软链接就不同了，在Linux下所有的都是文件，所以软链接也有自己的Inode和block ，但是创建软链接不会在增加原文件Inode-Index，当删除原文件的时候，相应的Index不再能找到，所以导致软链接不能用。但是软链接有自身的优势，可以跨分区，这样就可以解决当前Inode数据区不足够写入，可以使用软链接指向空间充足的空间。</p>\n</blockquote>\n<h3 id=\"区别\"><a href=\"#区别\" class=\"headerlink\" title=\"区别\"></a>区别</h3><p>软链接  硬链接 区别</p>\n<img src=\"/2017/09/10/how-to-delete-file-correctly/links.png\" title=\"软链接和硬链接的区别\">\n<h2 id=\"文件是否被占用\"><a href=\"#文件是否被占用\" class=\"headerlink\" title=\"文件是否被占用\"></a>文件是否被占用</h2><p>一切皆文件，所以lsof（list open file）就很重要</p>\n<p>lsof -i ：8080 查看端口占用</p>\n<p>socket 也是文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lsof  catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF     NODE NAME</span><br><span class=\"line\">java    40916 tomcat    1w   REG    8,7   933679 27656540 catalina.out</span><br><span class=\"line\">java    40916 tomcat    2w   REG    8,7   933679 27656540 catalina.out</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>‘‘REG’’ for a regular file<br>FD         is the File Descriptor number of the file or:</p>\n</blockquote>\n<pre><code>     cwd  current working directory;\n     Lnn  library references (AIX);\n     err  FD information error (see NAME column);\n     jld  jail directory (FreeBSD);\n     ltx  shared library text (code and data);\n     Mxx  hex memory-mapped type number xx.\n     m86  DOS Merge mapped file;\n     mem  memory-mapped file;\n     mmap memory-mapped device;\n     pd   parent directory;\n     rtd  root directory;\n     tr   kernel trace file (OpenBSD);\n     txt  program text (code and data);\n     v86  VP/ix mapped file;\n\nFD is followed by one of these characters, describing the mode under which the file is open:\n\n     r for read access;\n     w for write access;\n     u for read and write access;\n     space if mode unknown and no lock\n          character follows;\n     ‘-’ if mode unknown and lock\n          character follows.\n</code></pre><p>可以看出上面的文件的fd是1, w权限</p>\n<p>系统，每个进程，文件描述符。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ls /proc/40916/fd</span><br></pre></td></tr></table></figure>\n<p>下面的两个命令是等价的：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo cat /proc/40916/fd/2</span><br><span class=\"line\"></span><br><span class=\"line\">sudo cat catalina.out</span><br></pre></td></tr></table></figure>\n<h2 id=\"删除文件\"><a href=\"#删除文件\" class=\"headerlink\" title=\"删除文件\"></a>删除文件</h2><p>删除文件之前应该先看下文件的占用情况，<code>lsof</code>可以查看到文件被哪个进程占用。</p>\n<p>如果被占用，直接使用<code>rm</code>删除相当于只是删除了文件名和inode的关联, 但是文件占用的空间还在(block), 应该使用下面的命令进行删除：</p>\n<blockquote>\n<p>You misunderstand: deletion will be complete only after all processes using the file at the time of deletion have reached completion: only then the deleted inode will be returned to the pool of available inodes, and the content of the file may begin to be corrupted by over-writing. Until then, the inode is alive and well, and is pointing to the area of the disk containing the file in question. As soon as less completes, the soft link will disappear, and so will the file testing.txt.</p>\n<pre><code>当我们使用rm命令的时候，系统并不会真正删除这个资料。除非有档案非要将资料存储在原来档案的这些block中。这样原来的block就会被新档案给覆盖掉。 \n</code></pre></blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /dev/null &gt; filename</span><br><span class=\"line\">或者</span><br><span class=\"line\">truncate -s 0 filename</span><br></pre></td></tr></table></figure>\n<h3 id=\"stat-命令\"><a href=\"#stat-命令\" class=\"headerlink\" title=\"stat 命令\"></a>stat 命令</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">stat</span> /proc/40916/fd/2</span><br><span class=\"line\"></span><br><span class=\"line\">File: `/proc/40916/fd/2<span class=\"string\">' -&gt; `/home/q/www/qta.open.coupon.provider/logs/catalina.out'</span></span><br><span class=\"line\">  Size: 64        \tBlocks: 0          IO Block: 1024   symbolic link</span><br><span class=\"line\">Device: 3h/3d\tInode: 3017464897  Links: 1</span><br><span class=\"line\">Access: (0300/l-wx------)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)</span><br><span class=\"line\">Access: 2017-07-05 05:05:06.318550652 +0800</span><br><span class=\"line\">Modify: 2017-06-15 12:35:24.590599522 +0800</span><br><span class=\"line\">Change: 2017-06-15 12:35:24.590599522 +0800</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo <span class=\"built_in\">stat</span> catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">File: `catalina.out<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">  Size: 962851    \tBlocks: 1896       IO Block: 4096   regular file</span></span><br><span class=\"line\"><span class=\"string\">Device: 807h/2055d\tInode: 27656540    Links: 1</span></span><br><span class=\"line\"><span class=\"string\">Access: (0644/-rw-r--r--)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)</span></span><br><span class=\"line\"><span class=\"string\">Access: 2017-07-06 00:51:44.243427414 +0800</span></span><br><span class=\"line\"><span class=\"string\">Modify: 2017-07-06 00:52:27.096557541 +0800</span></span><br><span class=\"line\"><span class=\"string\">Change: 2017-07-06 00:52:27.096557541 +0800</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">sudo ls -i /proc/40916/fd/2</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">3017464897 /proc/40916/fd/2</span></span><br></pre></td></tr></table></figure>\n<p>可以看出, 文件描述符是一个软链接.</p>\n<h3 id=\"目录下的文件占用空间很小-但是目录占用空间很大\"><a href=\"#目录下的文件占用空间很小-但是目录占用空间很大\" class=\"headerlink\" title=\"目录下的文件占用空间很小, 但是目录占用空间很大\"></a>目录下的文件占用空间很小, 但是目录占用空间很大</h3><p>这种情况, 最常见的就是文件被删除了, 但是还有进程占用它. 于是这个文件占用的block就没有释放掉.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lsof | grep deleted</span><br></pre></td></tr></table></figure>\n<p>使用上面的命令就可以看到,那些文件被删除了, 但是还在被占用.  kill掉相应的进程, 空间就自己回来了.</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/lsof.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">3. lsof 一切皆文件 — Linux Tools Quick Tutorial</a></p>\n</li>\n<li><p><a href=\"https://unix.stackexchange.com/questions/92384/how-to-clean-log-file\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">How to clean log file? - Unix &amp; Linux Stack Exchange</a></p>\n</li>\n<li><p><a href=\"https://unix.stackexchange.com/questions/88808/empty-the-contents-of-a-file\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">shell script - Empty the contents of a file - Unix &amp; Linux Stack Exchange</a></p>\n</li>\n<li><p><a href=\"http://himichaelchu.iteye.com/blog/2116023\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">通过Inode原理分析Linux中ln命令 - Michael Chu - ITeye技术网站</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">理解 Linux 的硬链接与软链接</a></p>\n</li>\n<li><p><a href=\"https://superuser.com/questions/1112781/why-do-symbolic-links-in-prox-pid-fd-act-as-hard-links\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">linux - why do symbolic links in /prox/$PID/fd/ act as hard links? - Super User</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"文件存储\"><a href=\"#文件存储\" class=\"headerlink\" title=\"文件存储\"></a>文件存储</h1><img src=\"/2017/09/10/how-to-delete-file-correctly/inode.png\" title=\"linux文件的存储\">\n<h2 id=\"软链接和硬链接\"><a href=\"#软链接和硬链接\" class=\"headerlink\" title=\"软链接和硬链接\"></a>软链接和硬链接</h2><p>软链接(Symbolic Link):</p>\n<p>硬链接(Hard Link):</p>\n<blockquote>\n<p>硬链接就是在Directory中加入一条filename和Inode的对应关系，所以如果你删除了原来的文件，是不对硬链接文件有任何影响的，因为删除文件就是将link count 减少，当发现指向Inode为filename数量0的时候，系统会回收相应的Inode和Block空间。但是软链接就不同了，在Linux下所有的都是文件，所以软链接也有自己的Inode和block ，但是创建软链接不会在增加原文件Inode-Index，当删除原文件的时候，相应的Index不再能找到，所以导致软链接不能用。但是软链接有自身的优势，可以跨分区，这样就可以解决当前Inode数据区不足够写入，可以使用软链接指向空间充足的空间。</p>\n</blockquote>\n<h3 id=\"区别\"><a href=\"#区别\" class=\"headerlink\" title=\"区别\"></a>区别</h3><p>软链接  硬链接 区别</p>\n<img src=\"/2017/09/10/how-to-delete-file-correctly/links.png\" title=\"软链接和硬链接的区别\">\n<h2 id=\"文件是否被占用\"><a href=\"#文件是否被占用\" class=\"headerlink\" title=\"文件是否被占用\"></a>文件是否被占用</h2><p>一切皆文件，所以lsof（list open file）就很重要</p>\n<p>lsof -i ：8080 查看端口占用</p>\n<p>socket 也是文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lsof  catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF     NODE NAME</span><br><span class=\"line\">java    40916 tomcat    1w   REG    8,7   933679 27656540 catalina.out</span><br><span class=\"line\">java    40916 tomcat    2w   REG    8,7   933679 27656540 catalina.out</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>‘‘REG’’ for a regular file<br>FD         is the File Descriptor number of the file or:</p>\n</blockquote>\n<pre><code>     cwd  current working directory;\n     Lnn  library references (AIX);\n     err  FD information error (see NAME column);\n     jld  jail directory (FreeBSD);\n     ltx  shared library text (code and data);\n     Mxx  hex memory-mapped type number xx.\n     m86  DOS Merge mapped file;\n     mem  memory-mapped file;\n     mmap memory-mapped device;\n     pd   parent directory;\n     rtd  root directory;\n     tr   kernel trace file (OpenBSD);\n     txt  program text (code and data);\n     v86  VP/ix mapped file;\n\nFD is followed by one of these characters, describing the mode under which the file is open:\n\n     r for read access;\n     w for write access;\n     u for read and write access;\n     space if mode unknown and no lock\n          character follows;\n     ‘-’ if mode unknown and lock\n          character follows.\n</code></pre><p>可以看出上面的文件的fd是1, w权限</p>\n<p>系统，每个进程，文件描述符。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ls /proc/40916/fd</span><br></pre></td></tr></table></figure>\n<p>下面的两个命令是等价的：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo cat /proc/40916/fd/2</span><br><span class=\"line\"></span><br><span class=\"line\">sudo cat catalina.out</span><br></pre></td></tr></table></figure>\n<h2 id=\"删除文件\"><a href=\"#删除文件\" class=\"headerlink\" title=\"删除文件\"></a>删除文件</h2><p>删除文件之前应该先看下文件的占用情况，<code>lsof</code>可以查看到文件被哪个进程占用。</p>\n<p>如果被占用，直接使用<code>rm</code>删除相当于只是删除了文件名和inode的关联, 但是文件占用的空间还在(block), 应该使用下面的命令进行删除：</p>\n<blockquote>\n<p>You misunderstand: deletion will be complete only after all processes using the file at the time of deletion have reached completion: only then the deleted inode will be returned to the pool of available inodes, and the content of the file may begin to be corrupted by over-writing. Until then, the inode is alive and well, and is pointing to the area of the disk containing the file in question. As soon as less completes, the soft link will disappear, and so will the file testing.txt.</p>\n<pre><code>当我们使用rm命令的时候，系统并不会真正删除这个资料。除非有档案非要将资料存储在原来档案的这些block中。这样原来的block就会被新档案给覆盖掉。 \n</code></pre></blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /dev/null &gt; filename</span><br><span class=\"line\">或者</span><br><span class=\"line\">truncate -s 0 filename</span><br></pre></td></tr></table></figure>\n<h3 id=\"stat-命令\"><a href=\"#stat-命令\" class=\"headerlink\" title=\"stat 命令\"></a>stat 命令</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">stat</span> /proc/40916/fd/2</span><br><span class=\"line\"></span><br><span class=\"line\">File: `/proc/40916/fd/2<span class=\"string\">' -&gt; `/home/q/www/qta.open.coupon.provider/logs/catalina.out'</span></span><br><span class=\"line\">  Size: 64        \tBlocks: 0          IO Block: 1024   symbolic link</span><br><span class=\"line\">Device: 3h/3d\tInode: 3017464897  Links: 1</span><br><span class=\"line\">Access: (0300/l-wx------)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)</span><br><span class=\"line\">Access: 2017-07-05 05:05:06.318550652 +0800</span><br><span class=\"line\">Modify: 2017-06-15 12:35:24.590599522 +0800</span><br><span class=\"line\">Change: 2017-06-15 12:35:24.590599522 +0800</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo <span class=\"built_in\">stat</span> catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">File: `catalina.out<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">  Size: 962851    \tBlocks: 1896       IO Block: 4096   regular file</span></span><br><span class=\"line\"><span class=\"string\">Device: 807h/2055d\tInode: 27656540    Links: 1</span></span><br><span class=\"line\"><span class=\"string\">Access: (0644/-rw-r--r--)  Uid: (40001/  tomcat)   Gid: (40001/  tomcat)</span></span><br><span class=\"line\"><span class=\"string\">Access: 2017-07-06 00:51:44.243427414 +0800</span></span><br><span class=\"line\"><span class=\"string\">Modify: 2017-07-06 00:52:27.096557541 +0800</span></span><br><span class=\"line\"><span class=\"string\">Change: 2017-07-06 00:52:27.096557541 +0800</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">sudo ls -i /proc/40916/fd/2</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">3017464897 /proc/40916/fd/2</span></span><br></pre></td></tr></table></figure>\n<p>可以看出, 文件描述符是一个软链接.</p>\n<h3 id=\"目录下的文件占用空间很小-但是目录占用空间很大\"><a href=\"#目录下的文件占用空间很小-但是目录占用空间很大\" class=\"headerlink\" title=\"目录下的文件占用空间很小, 但是目录占用空间很大\"></a>目录下的文件占用空间很小, 但是目录占用空间很大</h3><p>这种情况, 最常见的就是文件被删除了, 但是还有进程占用它. 于是这个文件占用的block就没有释放掉.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lsof | grep deleted</span><br></pre></td></tr></table></figure>\n<p>使用上面的命令就可以看到,那些文件被删除了, 但是还在被占用.  kill掉相应的进程, 空间就自己回来了.</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/lsof.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">3. lsof 一切皆文件 — Linux Tools Quick Tutorial</a></p>\n</li>\n<li><p><a href=\"https://unix.stackexchange.com/questions/92384/how-to-clean-log-file\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">How to clean log file? - Unix &amp; Linux Stack Exchange</a></p>\n</li>\n<li><p><a href=\"https://unix.stackexchange.com/questions/88808/empty-the-contents-of-a-file\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">shell script - Empty the contents of a file - Unix &amp; Linux Stack Exchange</a></p>\n</li>\n<li><p><a href=\"http://himichaelchu.iteye.com/blog/2116023\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">通过Inode原理分析Linux中ln命令 - Michael Chu - ITeye技术网站</a></p>\n</li>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">理解 Linux 的硬链接与软链接</a></p>\n</li>\n<li><p><a href=\"https://superuser.com/questions/1112781/why-do-symbolic-links-in-prox-pid-fd-act-as-hard-links\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">linux - why do symbolic links in /prox/$PID/fd/ act as hard links? - Super User</a></p>\n</li>\n</ol>\n"},{"title":"idea文件模板","toc":true,"abbrlink":41545,"date":"2016-12-22T17:10:59.000Z","_content":"\n\n# 版权信息\n\n代码前面一般都会有相应的版权信息，拿guava的代码为例\n\n```java\n/*\n * Copyright (C) 2007 The Guava Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.google.common.collect;\n\n```\n\n## idea自动生成版权信息\n\n`File` > `Settings` > `Copyright` > `Copyright Profiles`\n\n新建一个profile，填入如下的内容\n```\n/* * Copyright (c) $today.year xx.com. All Rights Reserved. */\n```\n\n`$today.year`代表当前的年\n\n{%  asset_img   profiles.jpg  %}\n\n\n\n\n新建java文件时就自动生成了版权信息：\n\n```java\n/*\n *  * Copyright (c) 2016 Qunar.com. All Rights Reserved. \n */\n\npackage com.xxx.handler;\n```\n\n\n# 作者、日期、邮箱等\n\n`File` > `Settings` > `File and Ocde Templates` > `Includes` > `File Header`\n\n```java\n#set( $email = \"xx@xx.com\")\n#set( $author = \"xxx\")\n\n/**\n * @author ${author}\n * @email ${email}\n * @date ${DATE} ${TIME}\n */\n\n```\n\n这个使用的`velocity`渲染的，可以参考`velocity`的语法\n\n","source":"_posts/idea-template.md","raw":"---\ntitle: idea文件模板\ntags: template\ncategory: idea\ntoc: true\nabbrlink: 41545\ndate: 2016-12-23 01:10:59\n---\n\n\n# 版权信息\n\n代码前面一般都会有相应的版权信息，拿guava的代码为例\n\n```java\n/*\n * Copyright (C) 2007 The Guava Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.google.common.collect;\n\n```\n\n## idea自动生成版权信息\n\n`File` > `Settings` > `Copyright` > `Copyright Profiles`\n\n新建一个profile，填入如下的内容\n```\n/* * Copyright (c) $today.year xx.com. All Rights Reserved. */\n```\n\n`$today.year`代表当前的年\n\n{%  asset_img   profiles.jpg  %}\n\n\n\n\n新建java文件时就自动生成了版权信息：\n\n```java\n/*\n *  * Copyright (c) 2016 Qunar.com. All Rights Reserved. \n */\n\npackage com.xxx.handler;\n```\n\n\n# 作者、日期、邮箱等\n\n`File` > `Settings` > `File and Ocde Templates` > `Includes` > `File Header`\n\n```java\n#set( $email = \"xx@xx.com\")\n#set( $author = \"xxx\")\n\n/**\n * @author ${author}\n * @email ${email}\n * @date ${DATE} ${TIME}\n */\n\n```\n\n这个使用的`velocity`渲染的，可以参考`velocity`的语法\n\n","slug":"idea-template","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9g006mjh4khprju80m","content":"<h1 id=\"版权信息\"><a href=\"#版权信息\" class=\"headerlink\" title=\"版权信息\"></a>版权信息</h1><p>代码前面一般都会有相应的版权信息，拿guava的代码为例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Copyright (C) 2007 The Guava Authors</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * Licensed under the Apache License, Version 2.0 (the \"License\");</span></span><br><span class=\"line\"><span class=\"comment\"> * you may not use this file except in compliance with the License.</span></span><br><span class=\"line\"><span class=\"comment\"> * You may obtain a copy of the License at</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class=\"line\"><span class=\"comment\"> * distributed under the License is distributed on an \"AS IS\" BASIS,</span></span><br><span class=\"line\"><span class=\"comment\"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class=\"line\"><span class=\"comment\"> * See the License for the specific language governing permissions and</span></span><br><span class=\"line\"><span class=\"comment\"> * limitations under the License.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.google.common.collect;</span><br></pre></td></tr></table></figure>\n<h2 id=\"idea自动生成版权信息\"><a href=\"#idea自动生成版权信息\" class=\"headerlink\" title=\"idea自动生成版权信息\"></a>idea自动生成版权信息</h2><p><code>File</code> &gt; <code>Settings</code> &gt; <code>Copyright</code> &gt; <code>Copyright Profiles</code></p>\n<p>新建一个profile，填入如下的内容<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* * Copyright (c) $today.year xx.com. All Rights Reserved. */</span><br></pre></td></tr></table></figure></p>\n<p><code>$today.year</code>代表当前的年</p>\n<img src=\"/2016/12/23/idea-template/profiles.jpg\">\n<p>新建java文件时就自动生成了版权信息：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> *  * Copyright (c) 2016 Qunar.com. All Rights Reserved. </span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.xxx.handler;</span><br></pre></td></tr></table></figure>\n<h1 id=\"作者、日期、邮箱等\"><a href=\"#作者、日期、邮箱等\" class=\"headerlink\" title=\"作者、日期、邮箱等\"></a>作者、日期、邮箱等</h1><p><code>File</code> &gt; <code>Settings</code> &gt; <code>File and Ocde Templates</code> &gt; <code>Includes</code> &gt; <code>File Header</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#set( $email = \"xx@xx.com\")</span><br><span class=\"line\">#set( $author = \"xxx\")</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> $&#123;author&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@email</span> $&#123;email&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> $&#123;DATE&#125; $&#123;TIME&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n<p>这个使用的<code>velocity</code>渲染的，可以参考<code>velocity</code>的语法</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"版权信息\"><a href=\"#版权信息\" class=\"headerlink\" title=\"版权信息\"></a>版权信息</h1><p>代码前面一般都会有相应的版权信息，拿guava的代码为例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Copyright (C) 2007 The Guava Authors</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * Licensed under the Apache License, Version 2.0 (the \"License\");</span></span><br><span class=\"line\"><span class=\"comment\"> * you may not use this file except in compliance with the License.</span></span><br><span class=\"line\"><span class=\"comment\"> * You may obtain a copy of the License at</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class=\"line\"><span class=\"comment\"> * distributed under the License is distributed on an \"AS IS\" BASIS,</span></span><br><span class=\"line\"><span class=\"comment\"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class=\"line\"><span class=\"comment\"> * See the License for the specific language governing permissions and</span></span><br><span class=\"line\"><span class=\"comment\"> * limitations under the License.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.google.common.collect;</span><br></pre></td></tr></table></figure>\n<h2 id=\"idea自动生成版权信息\"><a href=\"#idea自动生成版权信息\" class=\"headerlink\" title=\"idea自动生成版权信息\"></a>idea自动生成版权信息</h2><p><code>File</code> &gt; <code>Settings</code> &gt; <code>Copyright</code> &gt; <code>Copyright Profiles</code></p>\n<p>新建一个profile，填入如下的内容<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* * Copyright (c) $today.year xx.com. All Rights Reserved. */</span><br></pre></td></tr></table></figure></p>\n<p><code>$today.year</code>代表当前的年</p>\n<img src=\"/2016/12/23/idea-template/profiles.jpg\">\n<p>新建java文件时就自动生成了版权信息：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> *  * Copyright (c) 2016 Qunar.com. All Rights Reserved. </span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.xxx.handler;</span><br></pre></td></tr></table></figure>\n<h1 id=\"作者、日期、邮箱等\"><a href=\"#作者、日期、邮箱等\" class=\"headerlink\" title=\"作者、日期、邮箱等\"></a>作者、日期、邮箱等</h1><p><code>File</code> &gt; <code>Settings</code> &gt; <code>File and Ocde Templates</code> &gt; <code>Includes</code> &gt; <code>File Header</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#set( $email = \"xx@xx.com\")</span><br><span class=\"line\">#set( $author = \"xxx\")</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> $&#123;author&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@email</span> $&#123;email&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> $&#123;DATE&#125; $&#123;TIME&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n<p>这个使用的<code>velocity</code>渲染的，可以参考<code>velocity</code>的语法</p>\n"},{"title":"jackson对guava新增集合的支持","toc":true,"abbrlink":45407,"date":"2016-11-15T16:10:21.000Z","_content":"\n\n\n## 问题\n\nGuava中新增了不少好用的集合比如`MultiMap`、`MultiSet`、`Table`等，当使用jackson进行序列化的时候\n\n这些集合并不能正确的序列化，出现下面的情况：\n\n正常序列化应该为：\n```json\n{\n  \"fields\":{\n    \"Field1\":[\n      {\n        \"index\":0,\n        \"header\":\"Field1\",\n        \"fieldType\":\"fieldtype\",\n        \"description\":null,\n        \"cleanHeader\":null\n      }\n    ],\n    \"Field2\":[\n      {\n        \"index\":1,\n        \"header\":\"Field2\",\n        \"fieldType\":\"fieldtype\",\n        \"description\":null,\n        \"cleanHeader\":null\n      }\n    ]\n  }\n}\n```\n\n使用默认的spring出现的是：\n\n```json\n{\n  \"fields\":{\n    \"empty\": false\n  }\n}\n```\n\n## 解决方案\n\n要解决这个问题就要手动向jackson的ObjectMapper中注册一个Module\n\n```java\nTable study = getTable();\n\nObjectMapper mapper = new ObjectMapper();\nmapper.registerModule(new GuavaModule());\n\nString tableString = mapper.writeValueAsString(table);\n```\n\n\n\n这个`GuavaModule`是jackson对Guava集合支持的包，它的maven依赖如下：\n\n```xml\n<dependency>\n  <groupId>com.fasterxml.jackson.datatype</groupId>\n  <artifactId>jackson-datatype-guava</artifactId>\n  <version>2.2.0</version>\n</dependency>\n```\n\n也可以使用基于xml配置的方式将这个Module导入\n```xml\n<!-- JSON parser configuration-->\n<bean id=\"guavaObjectMapper\" class=\"com.fasterxml.jackson.databind.ObjectMapper\"/>\n\n<bean class=\"org.springframework.beans.factory.config.MethodInvokingFactoryBean\">\n    <property name=\"targetObject\"><ref local=\"guavaObjectMapper\" /></property>\n    <property name=\"targetMethod\"><value>registerModule</value></property>\n    <property name=\"arguments\">\n        <list>\n            <bean id=\"guavaModule\" class=\"com.fasterxml.jackson.datatype.guava.GuavaModule\"/>\n        </list>\n    </property>\n</bean>\n\n\n<mvc:annotation-driven>\n    <mvc:message-converters register-defaults=\"true\">\n        <bean class=\"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter\">\n            <property name=\"objectMapper\">\n                <ref  local=\"guavaObjectMapper\"/>\n            </property>\n        </bean>\n    </mvc:message-converters>\n</mvc:annotation-driven>\n```\n\n## 支持的类型\n\n{%  asset_img   jar.png  %}\n\n\n\n\n## 参考\n\n1. [Spring MVC configuration + Jackson + Guava multimap](http://stackoverflow.com/questions/26979120/spring-mvc-configuration-jackson-guava-multimap)\n\n2. [Json to guava multimap](http://www.leveluplunch.com/java/examples/convert-json-to-guava-multimap-with-jackson/)\n","source":"_posts/jackson-guava.md","raw":"---\ntitle: jackson对guava新增集合的支持\ntags: jackson\ncategory: spring\ntoc: true\nabbrlink: 45407\ndate: 2016-11-16 00:10:21\n---\n\n\n\n## 问题\n\nGuava中新增了不少好用的集合比如`MultiMap`、`MultiSet`、`Table`等，当使用jackson进行序列化的时候\n\n这些集合并不能正确的序列化，出现下面的情况：\n\n正常序列化应该为：\n```json\n{\n  \"fields\":{\n    \"Field1\":[\n      {\n        \"index\":0,\n        \"header\":\"Field1\",\n        \"fieldType\":\"fieldtype\",\n        \"description\":null,\n        \"cleanHeader\":null\n      }\n    ],\n    \"Field2\":[\n      {\n        \"index\":1,\n        \"header\":\"Field2\",\n        \"fieldType\":\"fieldtype\",\n        \"description\":null,\n        \"cleanHeader\":null\n      }\n    ]\n  }\n}\n```\n\n使用默认的spring出现的是：\n\n```json\n{\n  \"fields\":{\n    \"empty\": false\n  }\n}\n```\n\n## 解决方案\n\n要解决这个问题就要手动向jackson的ObjectMapper中注册一个Module\n\n```java\nTable study = getTable();\n\nObjectMapper mapper = new ObjectMapper();\nmapper.registerModule(new GuavaModule());\n\nString tableString = mapper.writeValueAsString(table);\n```\n\n\n\n这个`GuavaModule`是jackson对Guava集合支持的包，它的maven依赖如下：\n\n```xml\n<dependency>\n  <groupId>com.fasterxml.jackson.datatype</groupId>\n  <artifactId>jackson-datatype-guava</artifactId>\n  <version>2.2.0</version>\n</dependency>\n```\n\n也可以使用基于xml配置的方式将这个Module导入\n```xml\n<!-- JSON parser configuration-->\n<bean id=\"guavaObjectMapper\" class=\"com.fasterxml.jackson.databind.ObjectMapper\"/>\n\n<bean class=\"org.springframework.beans.factory.config.MethodInvokingFactoryBean\">\n    <property name=\"targetObject\"><ref local=\"guavaObjectMapper\" /></property>\n    <property name=\"targetMethod\"><value>registerModule</value></property>\n    <property name=\"arguments\">\n        <list>\n            <bean id=\"guavaModule\" class=\"com.fasterxml.jackson.datatype.guava.GuavaModule\"/>\n        </list>\n    </property>\n</bean>\n\n\n<mvc:annotation-driven>\n    <mvc:message-converters register-defaults=\"true\">\n        <bean class=\"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter\">\n            <property name=\"objectMapper\">\n                <ref  local=\"guavaObjectMapper\"/>\n            </property>\n        </bean>\n    </mvc:message-converters>\n</mvc:annotation-driven>\n```\n\n## 支持的类型\n\n{%  asset_img   jar.png  %}\n\n\n\n\n## 参考\n\n1. [Spring MVC configuration + Jackson + Guava multimap](http://stackoverflow.com/questions/26979120/spring-mvc-configuration-jackson-guava-multimap)\n\n2. [Json to guava multimap](http://www.leveluplunch.com/java/examples/convert-json-to-guava-multimap-with-jackson/)\n","slug":"jackson-guava","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9i006pjh4k80qcy1dp","content":"<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>Guava中新增了不少好用的集合比如<code>MultiMap</code>、<code>MultiSet</code>、<code>Table</code>等，当使用jackson进行序列化的时候</p>\n<p>这些集合并不能正确的序列化，出现下面的情况：</p>\n<p>正常序列化应该为：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"fields\"</span>:&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"Field1\"</span>:[</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"index\"</span>:<span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"header\"</span>:<span class=\"string\">\"Field1\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"fieldType\"</span>:<span class=\"string\">\"fieldtype\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"description\"</span>:<span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"cleanHeader\"</span>:<span class=\"literal\">null</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">\"Field2\"</span>:[</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"index\"</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"header\"</span>:<span class=\"string\">\"Field2\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"fieldType\"</span>:<span class=\"string\">\"fieldtype\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"description\"</span>:<span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"cleanHeader\"</span>:<span class=\"literal\">null</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>使用默认的spring出现的是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"fields\"</span>:&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"empty\"</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>要解决这个问题就要手动向jackson的ObjectMapper中注册一个Module</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Table study = getTable();</span><br><span class=\"line\"></span><br><span class=\"line\">ObjectMapper mapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">mapper.registerModule(<span class=\"keyword\">new</span> GuavaModule());</span><br><span class=\"line\"></span><br><span class=\"line\">String tableString = mapper.writeValueAsString(table);</span><br></pre></td></tr></table></figure>\n<p>这个<code>GuavaModule</code>是jackson对Guava集合支持的包，它的maven依赖如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-datatype-guava<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.2.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>也可以使用基于xml配置的方式将这个Module导入<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- JSON parser configuration--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"guavaObjectMapper\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.fasterxml.jackson.databind.ObjectMapper\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.beans.factory.config.MethodInvokingFactoryBean\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"targetObject\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">local</span>=<span class=\"string\">\"guavaObjectMapper\"</span> /&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"targetMethod\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>registerModule<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"arguments\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"guavaModule\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.fasterxml.jackson.datatype.guava.GuavaModule\"</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:message-converters</span> <span class=\"attr\">register-defaults</span>=<span class=\"string\">\"true\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"objectMapper\"</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">ref</span>  <span class=\"attr\">local</span>=<span class=\"string\">\"guavaObjectMapper\"</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">mvc:message-converters</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"支持的类型\"><a href=\"#支持的类型\" class=\"headerlink\" title=\"支持的类型\"></a>支持的类型</h2><img src=\"/2016/11/16/jackson-guava/jar.png\">\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://stackoverflow.com/questions/26979120/spring-mvc-configuration-jackson-guava-multimap\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Spring MVC configuration + Jackson + Guava multimap</a></p>\n</li>\n<li><p><a href=\"http://www.leveluplunch.com/java/examples/convert-json-to-guava-multimap-with-jackson/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Json to guava multimap</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>Guava中新增了不少好用的集合比如<code>MultiMap</code>、<code>MultiSet</code>、<code>Table</code>等，当使用jackson进行序列化的时候</p>\n<p>这些集合并不能正确的序列化，出现下面的情况：</p>\n<p>正常序列化应该为：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"fields\"</span>:&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"Field1\"</span>:[</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"index\"</span>:<span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"header\"</span>:<span class=\"string\">\"Field1\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"fieldType\"</span>:<span class=\"string\">\"fieldtype\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"description\"</span>:<span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"cleanHeader\"</span>:<span class=\"literal\">null</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">\"Field2\"</span>:[</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"index\"</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"header\"</span>:<span class=\"string\">\"Field2\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"fieldType\"</span>:<span class=\"string\">\"fieldtype\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"description\"</span>:<span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"cleanHeader\"</span>:<span class=\"literal\">null</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>使用默认的spring出现的是：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"fields\"</span>:&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"empty\"</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>要解决这个问题就要手动向jackson的ObjectMapper中注册一个Module</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Table study = getTable();</span><br><span class=\"line\"></span><br><span class=\"line\">ObjectMapper mapper = <span class=\"keyword\">new</span> ObjectMapper();</span><br><span class=\"line\">mapper.registerModule(<span class=\"keyword\">new</span> GuavaModule());</span><br><span class=\"line\"></span><br><span class=\"line\">String tableString = mapper.writeValueAsString(table);</span><br></pre></td></tr></table></figure>\n<p>这个<code>GuavaModule</code>是jackson对Guava集合支持的包，它的maven依赖如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-datatype-guava<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.2.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>也可以使用基于xml配置的方式将这个Module导入<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- JSON parser configuration--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"guavaObjectMapper\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.fasterxml.jackson.databind.ObjectMapper\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.beans.factory.config.MethodInvokingFactoryBean\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"targetObject\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">local</span>=<span class=\"string\">\"guavaObjectMapper\"</span> /&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"targetMethod\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>registerModule<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"arguments\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"guavaModule\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.fasterxml.jackson.datatype.guava.GuavaModule\"</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:message-converters</span> <span class=\"attr\">register-defaults</span>=<span class=\"string\">\"true\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"objectMapper\"</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">ref</span>  <span class=\"attr\">local</span>=<span class=\"string\">\"guavaObjectMapper\"</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">mvc:message-converters</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"支持的类型\"><a href=\"#支持的类型\" class=\"headerlink\" title=\"支持的类型\"></a>支持的类型</h2><img src=\"/2016/11/16/jackson-guava/jar.png\">\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://stackoverflow.com/questions/26979120/spring-mvc-configuration-jackson-guava-multimap\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Spring MVC configuration + Jackson + Guava multimap</a></p>\n</li>\n<li><p><a href=\"http://www.leveluplunch.com/java/examples/convert-json-to-guava-multimap-with-jackson/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Json to guava multimap</a></p>\n</li>\n</ol>\n"},{"title":"jar文件查看","toc":true,"abbrlink":15538,"date":"2017-01-27T09:03:36.000Z","_content":"\n\n查看jar包内容\n\n```bash\nunzip -q -c myarchive.jar META-INF/MANIFEST.MF\n```\n> `-q` will suppress verbose output from the unzip program\n\n> `-c` will extract to stdout\n\n```\nunzip -q -c servlet-api.jar META-INF/MANIFEST.MF\nManifest-Version: 1.0\nAnt-Version: Apache Ant 1.8.1\nCreated-By: 1.6.0_45-b06 (Sun Microsystems Inc.)\nX-Compile-Source-JDK: 1.6\nX-Compile-Target-JDK: 1.6\n\nName: javax/servlet/\nSpecification-Title: Java API for Servlets\nSpecification-Version: 3.0\nSpecification-Vendor: Sun Microsystems, Inc.\nImplementation-Title: javax.servlet\nImplementation-Version: 3.0.FR\nImplementation-Vendor: Apache Software Foundation\n\n```\n\n## jar命令\n\n在linux下如何查看一个jar文件中有哪些类呢？\n\n`jar tf test.jar`\n\n```bash\nMETA-INF/\nMETA-INF/MANIFEST.MF\njavax/\njavax/servlet/\njavax/servlet/annotation/\njavax/servlet/descriptor/\njavax/servlet/http/\n...\njavax/servlet/resources/xml.xsd\nMETA-INF/NOTICE\nMETA-INF/LICENSE\n```\n\n## grepjar\n\n有些时候，我们需要查看一个jar文件中是否包含了某个方法，这个在linux下可以通过下面的命令来查询\n\n`grepjar methodName class.jar`\n\n```bash\n$ grepjar 'getStatus' servlet-api.jar\njavax/servlet/http/HttpServletResponse.class:getStatus\njavax/servlet/http/HttpServletResponseWrapper.class:getStatus\n```\n\n参数：\n\n||option || meaning ||\n|-b |  Print byte offset of match.|\n|--|---------------|\n|-c |  Print number of matches.|\n|-i |  Compare case-insensitively.|\n|-n |  Print line number of each match.|\n|-s |  Suppress error messages.|\n|-w |  Force PATTERN to match only whole words.|\n|-e | PATTERN  Use PATTERN as regular expression.|\n|--help |  Print help, then exit.|\n|-V |  |\n|--version |   Print version number, then exit.|\n\n\n## 参考\n\n[How to read MANIFEST.MF file from JAR using Bash - Stack Overflow](http://stackoverflow.com/questions/7066063/how-to-read-manifest-mf-file-from-jar-using-bash)\n\n[吴峰子 — linux查看jar中的类以及类中方法命令](http://xiaofengwu.tumblr.com/post/63518704051/linux%E6%9F%A5%E7%9C%8Bjar%E4%B8%AD%E7%9A%84%E7%B1%BB%E4%BB%A5%E5%8F%8A%E7%B1%BB%E4%B8%AD%E6%96%B9%E6%B3%95%E5%91%BD%E4%BB%A4)\n\n[grepdiff - Unix, Linux Command](http://www.tutorialspoint.com/unix_commands/grepjar.htm)\n\n\n","source":"_posts/jar.md","raw":"---\ntitle: jar文件查看\ntags: jar\ncategory: java\ntoc: true\nabbrlink: 15538\ndate: 2017-01-27 17:03:36\n---\n\n\n查看jar包内容\n\n```bash\nunzip -q -c myarchive.jar META-INF/MANIFEST.MF\n```\n> `-q` will suppress verbose output from the unzip program\n\n> `-c` will extract to stdout\n\n```\nunzip -q -c servlet-api.jar META-INF/MANIFEST.MF\nManifest-Version: 1.0\nAnt-Version: Apache Ant 1.8.1\nCreated-By: 1.6.0_45-b06 (Sun Microsystems Inc.)\nX-Compile-Source-JDK: 1.6\nX-Compile-Target-JDK: 1.6\n\nName: javax/servlet/\nSpecification-Title: Java API for Servlets\nSpecification-Version: 3.0\nSpecification-Vendor: Sun Microsystems, Inc.\nImplementation-Title: javax.servlet\nImplementation-Version: 3.0.FR\nImplementation-Vendor: Apache Software Foundation\n\n```\n\n## jar命令\n\n在linux下如何查看一个jar文件中有哪些类呢？\n\n`jar tf test.jar`\n\n```bash\nMETA-INF/\nMETA-INF/MANIFEST.MF\njavax/\njavax/servlet/\njavax/servlet/annotation/\njavax/servlet/descriptor/\njavax/servlet/http/\n...\njavax/servlet/resources/xml.xsd\nMETA-INF/NOTICE\nMETA-INF/LICENSE\n```\n\n## grepjar\n\n有些时候，我们需要查看一个jar文件中是否包含了某个方法，这个在linux下可以通过下面的命令来查询\n\n`grepjar methodName class.jar`\n\n```bash\n$ grepjar 'getStatus' servlet-api.jar\njavax/servlet/http/HttpServletResponse.class:getStatus\njavax/servlet/http/HttpServletResponseWrapper.class:getStatus\n```\n\n参数：\n\n||option || meaning ||\n|-b |  Print byte offset of match.|\n|--|---------------|\n|-c |  Print number of matches.|\n|-i |  Compare case-insensitively.|\n|-n |  Print line number of each match.|\n|-s |  Suppress error messages.|\n|-w |  Force PATTERN to match only whole words.|\n|-e | PATTERN  Use PATTERN as regular expression.|\n|--help |  Print help, then exit.|\n|-V |  |\n|--version |   Print version number, then exit.|\n\n\n## 参考\n\n[How to read MANIFEST.MF file from JAR using Bash - Stack Overflow](http://stackoverflow.com/questions/7066063/how-to-read-manifest-mf-file-from-jar-using-bash)\n\n[吴峰子 — linux查看jar中的类以及类中方法命令](http://xiaofengwu.tumblr.com/post/63518704051/linux%E6%9F%A5%E7%9C%8Bjar%E4%B8%AD%E7%9A%84%E7%B1%BB%E4%BB%A5%E5%8F%8A%E7%B1%BB%E4%B8%AD%E6%96%B9%E6%B3%95%E5%91%BD%E4%BB%A4)\n\n[grepdiff - Unix, Linux Command](http://www.tutorialspoint.com/unix_commands/grepjar.htm)\n\n\n","slug":"jar","published":1,"updated":"2017-04-16T12:04:30.010Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9j006sjh4k5tau9uuq","content":"<p>查看jar包内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip -q -c myarchive.jar META-INF/MANIFEST.MF</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>-q</code> will suppress verbose output from the unzip program</p>\n<p><code>-c</code> will extract to stdout</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip -q -c servlet-api.jar META-INF/MANIFEST.MF</span><br><span class=\"line\">Manifest-Version: 1.0</span><br><span class=\"line\">Ant-Version: Apache Ant 1.8.1</span><br><span class=\"line\">Created-By: 1.6.0_45-b06 (Sun Microsystems Inc.)</span><br><span class=\"line\">X-Compile-Source-JDK: 1.6</span><br><span class=\"line\">X-Compile-Target-JDK: 1.6</span><br><span class=\"line\"></span><br><span class=\"line\">Name: javax/servlet/</span><br><span class=\"line\">Specification-Title: Java API for Servlets</span><br><span class=\"line\">Specification-Version: 3.0</span><br><span class=\"line\">Specification-Vendor: Sun Microsystems, Inc.</span><br><span class=\"line\">Implementation-Title: javax.servlet</span><br><span class=\"line\">Implementation-Version: 3.0.FR</span><br><span class=\"line\">Implementation-Vendor: Apache Software Foundation</span><br></pre></td></tr></table></figure>\n<h2 id=\"jar命令\"><a href=\"#jar命令\" class=\"headerlink\" title=\"jar命令\"></a>jar命令</h2><p>在linux下如何查看一个jar文件中有哪些类呢？</p>\n<p><code>jar tf test.jar</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">META-INF/</span><br><span class=\"line\">META-INF/MANIFEST.MF</span><br><span class=\"line\">javax/</span><br><span class=\"line\">javax/servlet/</span><br><span class=\"line\">javax/servlet/annotation/</span><br><span class=\"line\">javax/servlet/descriptor/</span><br><span class=\"line\">javax/servlet/http/</span><br><span class=\"line\">...</span><br><span class=\"line\">javax/servlet/resources/xml.xsd</span><br><span class=\"line\">META-INF/NOTICE</span><br><span class=\"line\">META-INF/LICENSE</span><br></pre></td></tr></table></figure>\n<h2 id=\"grepjar\"><a href=\"#grepjar\" class=\"headerlink\" title=\"grepjar\"></a>grepjar</h2><p>有些时候，我们需要查看一个jar文件中是否包含了某个方法，这个在linux下可以通过下面的命令来查询</p>\n<p><code>grepjar methodName class.jar</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ grepjar <span class=\"string\">'getStatus'</span> servlet-api.jar</span><br><span class=\"line\">javax/servlet/http/HttpServletResponse.class:getStatus</span><br><span class=\"line\">javax/servlet/http/HttpServletResponseWrapper.class:getStatus</span><br></pre></td></tr></table></figure>\n<p>参数：</p>\n<p>||option || meaning ||<br>|-b |  Print byte offset of match.|<br>|–|—————|<br>|-c |  Print number of matches.|<br>|-i |  Compare case-insensitively.|<br>|-n |  Print line number of each match.|<br>|-s |  Suppress error messages.|<br>|-w |  Force PATTERN to match only whole words.|<br>|-e | PATTERN  Use PATTERN as regular expression.|<br>|–help |  Print help, then exit.|<br>|-V |  |<br>|–version |   Print version number, then exit.|</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://stackoverflow.com/questions/7066063/how-to-read-manifest-mf-file-from-jar-using-bash\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">How to read MANIFEST.MF file from JAR using Bash - Stack Overflow</a></p>\n<p><a href=\"http://xiaofengwu.tumblr.com/post/63518704051/linux%E6%9F%A5%E7%9C%8Bjar%E4%B8%AD%E7%9A%84%E7%B1%BB%E4%BB%A5%E5%8F%8A%E7%B1%BB%E4%B8%AD%E6%96%B9%E6%B3%95%E5%91%BD%E4%BB%A4\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">吴峰子 — linux查看jar中的类以及类中方法命令</a></p>\n<p><a href=\"http://www.tutorialspoint.com/unix_commands/grepjar.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">grepdiff - Unix, Linux Command</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>查看jar包内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip -q -c myarchive.jar META-INF/MANIFEST.MF</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>-q</code> will suppress verbose output from the unzip program</p>\n<p><code>-c</code> will extract to stdout</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unzip -q -c servlet-api.jar META-INF/MANIFEST.MF</span><br><span class=\"line\">Manifest-Version: 1.0</span><br><span class=\"line\">Ant-Version: Apache Ant 1.8.1</span><br><span class=\"line\">Created-By: 1.6.0_45-b06 (Sun Microsystems Inc.)</span><br><span class=\"line\">X-Compile-Source-JDK: 1.6</span><br><span class=\"line\">X-Compile-Target-JDK: 1.6</span><br><span class=\"line\"></span><br><span class=\"line\">Name: javax/servlet/</span><br><span class=\"line\">Specification-Title: Java API for Servlets</span><br><span class=\"line\">Specification-Version: 3.0</span><br><span class=\"line\">Specification-Vendor: Sun Microsystems, Inc.</span><br><span class=\"line\">Implementation-Title: javax.servlet</span><br><span class=\"line\">Implementation-Version: 3.0.FR</span><br><span class=\"line\">Implementation-Vendor: Apache Software Foundation</span><br></pre></td></tr></table></figure>\n<h2 id=\"jar命令\"><a href=\"#jar命令\" class=\"headerlink\" title=\"jar命令\"></a>jar命令</h2><p>在linux下如何查看一个jar文件中有哪些类呢？</p>\n<p><code>jar tf test.jar</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">META-INF/</span><br><span class=\"line\">META-INF/MANIFEST.MF</span><br><span class=\"line\">javax/</span><br><span class=\"line\">javax/servlet/</span><br><span class=\"line\">javax/servlet/annotation/</span><br><span class=\"line\">javax/servlet/descriptor/</span><br><span class=\"line\">javax/servlet/http/</span><br><span class=\"line\">...</span><br><span class=\"line\">javax/servlet/resources/xml.xsd</span><br><span class=\"line\">META-INF/NOTICE</span><br><span class=\"line\">META-INF/LICENSE</span><br></pre></td></tr></table></figure>\n<h2 id=\"grepjar\"><a href=\"#grepjar\" class=\"headerlink\" title=\"grepjar\"></a>grepjar</h2><p>有些时候，我们需要查看一个jar文件中是否包含了某个方法，这个在linux下可以通过下面的命令来查询</p>\n<p><code>grepjar methodName class.jar</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ grepjar <span class=\"string\">'getStatus'</span> servlet-api.jar</span><br><span class=\"line\">javax/servlet/http/HttpServletResponse.class:getStatus</span><br><span class=\"line\">javax/servlet/http/HttpServletResponseWrapper.class:getStatus</span><br></pre></td></tr></table></figure>\n<p>参数：</p>\n<p>||option || meaning ||<br>|-b |  Print byte offset of match.|<br>|–|—————|<br>|-c |  Print number of matches.|<br>|-i |  Compare case-insensitively.|<br>|-n |  Print line number of each match.|<br>|-s |  Suppress error messages.|<br>|-w |  Force PATTERN to match only whole words.|<br>|-e | PATTERN  Use PATTERN as regular expression.|<br>|–help |  Print help, then exit.|<br>|-V |  |<br>|–version |   Print version number, then exit.|</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://stackoverflow.com/questions/7066063/how-to-read-manifest-mf-file-from-jar-using-bash\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">How to read MANIFEST.MF file from JAR using Bash - Stack Overflow</a></p>\n<p><a href=\"http://xiaofengwu.tumblr.com/post/63518704051/linux%E6%9F%A5%E7%9C%8Bjar%E4%B8%AD%E7%9A%84%E7%B1%BB%E4%BB%A5%E5%8F%8A%E7%B1%BB%E4%B8%AD%E6%96%B9%E6%B3%95%E5%91%BD%E4%BB%A4\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">吴峰子 — linux查看jar中的类以及类中方法命令</a></p>\n<p><a href=\"http://www.tutorialspoint.com/unix_commands/grepjar.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">grepdiff - Unix, Linux Command</a></p>\n"},{"title":"Java中的异常处理","toc":true,"abbrlink":"22260569","date":"2016-09-25T14:49:04.000Z","_content":"\n## 异常的分类\n\n* 业务异常\n\n> 处理业务的时候80%的时候是没问题的，但可能有20%的时候事情没\n> 有按理想的方向发展。例如注册用户的时候，正常情况是注册成功，但\n> 可能用户提交请求的时候，系统发现用户名已经被别人注册了，这是就\n> 可以抛出一个UserAlreadyExistsException\n>\n来自 <https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md>\n\n业务异常一般是上层可以处理的，一般声明为`CheckedException`，强制上层进行捕获处理\n\n业务异常定义示例摘自[spring mvc 异常统一处理](http://gaojiewyh.iteye.com/blog/1297746#bc2369985)：\n\n```\npublic class BusinessException extends Exception {  \n   \n    private static final long serialVersionUID = 1L;  \n   \n    public BusinessException() {  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    public BusinessException(String message) {  \n        super(message);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    public BusinessException(Throwable cause) {  \n        super(cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    public BusinessException(String message, Throwable cause) {  \n        super(message, cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n}  \n```\n\n一般是继承自`Exception`, 这样就成为`CheckedException`， 必须强制捕获\n\n* 逻辑异常\n\n> 系统异常与具体业务流程没有直接的关系，例如编程错误导致的NullPointExcpetion，\n> 还有环境问题，例如磁盘损坏或者网络连接不稳定造成了IOException。\n\n> 来自  <https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md>\n\n系统异常一般是上层无法处理的，所以一般声明为`UncheckedException`，不强制用户捕获。\n```\npublic class SystemException extends RuntimeException {  \n   \n    private static final long serialVersionUID = 1L;  \n   \n    public SystemException() {  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    /** \n     * @param message \n     */  \n    public SystemException(String message) {  \n        super(message);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    /** \n     * @param cause \n     */  \n    public SystemException(Throwable cause) {  \n        super(cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    /** \n     * @param message \n     * @param cause \n     */  \n    public SystemException(String message, Throwable cause) {  \n        super(message, cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n}  \n\n```\n\n## 异常的捕获\n\n• 在Service层中应该捕获Dao层抛出的异常并且包装成相应的异常，如业务异常、系统异常等\n\n  业务层中，通过异常链保存原始异常信息。程序员必须自己编码来保存原始异常的信息。在业务逻辑中，捕获DataAccessException异常，处理包装成SystemException异常抛出。捕获ObjectNotFoundException，DuplicateKeyException异常，处理包装成BusinessException异常抛出。业务层中应根据业务的不同，将异常尽量分得细一点，否则，自定义的异常没有太多的意义。\n\n来自 <http://gaojiewyh.iteye.com/blog/1739662>\n\n```\npublic addUser(User user) throws BusinessException,SystemException{  \n        try{  \n              userDao.addUser(user);  \n        }catch(DuplicatekeyException ex){  \n             log.infor(\"......................\");  \n             throw new BusinessException(ex.getCause(),\"国际化信息\"）；  \n        }catch(DataAccessException ex){  \n             log.error(\"......................\");  \n             throw new SystemException(ex.getCause(),\"国际化信息\"）；  \n        }  \n}  \n\n```\n\n## 常见误区\n\n### 一、定义上捕获者需要用到的信息\n\n```\npublic class DuplicateUsernameException extends Exception {  \n}  \n```\n\n#### 理由: \n它除了有一个\"意义明确\"的名字以外没有任何有用的信息了。不要忘记Exception跟其他的Java类一样，客户端可以调用其中的方法来得到更多的信息。  \n\n```\npublic class DuplicateUsernameException extends Exception {\n    private static final long serialVersionUID = -6113064394525919823L;\n    private String username = null;\n    private String[] availableNames = new String[0];\n \n    public DuplicateUsernameException(String username) {\n            this.username = username;\n    }\n \n    public DuplicateUsernameException(String username, String[] availableNames) {\n            this(username);\n            this.availableNames = availableNames;\n    }\n \n    public String requestedUsername() {\n            return this.username;\n    }\n \n    public String[] availableNames() {\n            return this.availableNames;\n    }\n}\n```\n来自 <http://www.iteye.com/topic/857443>\n\n### 二、尽可能避免（因抛出异常带来的）接口污染\n\n来自 <http://lavasoft.blog.51cto.com/62575/244138/>\n\n### 三、异常链传播\n\n```\npublic void dataAccessCode(){\n    try{\n        ..some code that throws SQLException\n    }catch(SQLException ex){\n        throw new RuntimeException(ex);\n    }\n}\n```\n\n## 参考链接：\n\n1. [Best Practices for Exception Handling](http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html?page=2)\n\n2. [基于Spring的异常体系处理](http://gaojiewyh.iteye.com/blog/1739662)\n\n3. [spring mvc 异常统一处理](http://gaojiewyh.iteye.com/blog/1297746#bc2369985)\n\n4. [异常处理最佳实践.md](https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md)\n","source":"_posts/java-exception.md","raw":"---\ntitle: Java中的异常处理\ntags: exception\ncategory: java\ntoc: true\nabbrlink: '22260569'\ndate: 2016-09-25 22:49:04\n---\n\n## 异常的分类\n\n* 业务异常\n\n> 处理业务的时候80%的时候是没问题的，但可能有20%的时候事情没\n> 有按理想的方向发展。例如注册用户的时候，正常情况是注册成功，但\n> 可能用户提交请求的时候，系统发现用户名已经被别人注册了，这是就\n> 可以抛出一个UserAlreadyExistsException\n>\n来自 <https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md>\n\n业务异常一般是上层可以处理的，一般声明为`CheckedException`，强制上层进行捕获处理\n\n业务异常定义示例摘自[spring mvc 异常统一处理](http://gaojiewyh.iteye.com/blog/1297746#bc2369985)：\n\n```\npublic class BusinessException extends Exception {  \n   \n    private static final long serialVersionUID = 1L;  \n   \n    public BusinessException() {  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    public BusinessException(String message) {  \n        super(message);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    public BusinessException(Throwable cause) {  \n        super(cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    public BusinessException(String message, Throwable cause) {  \n        super(message, cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n}  \n```\n\n一般是继承自`Exception`, 这样就成为`CheckedException`， 必须强制捕获\n\n* 逻辑异常\n\n> 系统异常与具体业务流程没有直接的关系，例如编程错误导致的NullPointExcpetion，\n> 还有环境问题，例如磁盘损坏或者网络连接不稳定造成了IOException。\n\n> 来自  <https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md>\n\n系统异常一般是上层无法处理的，所以一般声明为`UncheckedException`，不强制用户捕获。\n```\npublic class SystemException extends RuntimeException {  \n   \n    private static final long serialVersionUID = 1L;  \n   \n    public SystemException() {  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    /** \n     * @param message \n     */  \n    public SystemException(String message) {  \n        super(message);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    /** \n     * @param cause \n     */  \n    public SystemException(Throwable cause) {  \n        super(cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n    /** \n     * @param message \n     * @param cause \n     */  \n    public SystemException(String message, Throwable cause) {  \n        super(message, cause);  \n        // TODO Auto-generated constructor stub  \n    }  \n   \n}  \n\n```\n\n## 异常的捕获\n\n• 在Service层中应该捕获Dao层抛出的异常并且包装成相应的异常，如业务异常、系统异常等\n\n  业务层中，通过异常链保存原始异常信息。程序员必须自己编码来保存原始异常的信息。在业务逻辑中，捕获DataAccessException异常，处理包装成SystemException异常抛出。捕获ObjectNotFoundException，DuplicateKeyException异常，处理包装成BusinessException异常抛出。业务层中应根据业务的不同，将异常尽量分得细一点，否则，自定义的异常没有太多的意义。\n\n来自 <http://gaojiewyh.iteye.com/blog/1739662>\n\n```\npublic addUser(User user) throws BusinessException,SystemException{  \n        try{  \n              userDao.addUser(user);  \n        }catch(DuplicatekeyException ex){  \n             log.infor(\"......................\");  \n             throw new BusinessException(ex.getCause(),\"国际化信息\"）；  \n        }catch(DataAccessException ex){  \n             log.error(\"......................\");  \n             throw new SystemException(ex.getCause(),\"国际化信息\"）；  \n        }  \n}  \n\n```\n\n## 常见误区\n\n### 一、定义上捕获者需要用到的信息\n\n```\npublic class DuplicateUsernameException extends Exception {  \n}  \n```\n\n#### 理由: \n它除了有一个\"意义明确\"的名字以外没有任何有用的信息了。不要忘记Exception跟其他的Java类一样，客户端可以调用其中的方法来得到更多的信息。  \n\n```\npublic class DuplicateUsernameException extends Exception {\n    private static final long serialVersionUID = -6113064394525919823L;\n    private String username = null;\n    private String[] availableNames = new String[0];\n \n    public DuplicateUsernameException(String username) {\n            this.username = username;\n    }\n \n    public DuplicateUsernameException(String username, String[] availableNames) {\n            this(username);\n            this.availableNames = availableNames;\n    }\n \n    public String requestedUsername() {\n            return this.username;\n    }\n \n    public String[] availableNames() {\n            return this.availableNames;\n    }\n}\n```\n来自 <http://www.iteye.com/topic/857443>\n\n### 二、尽可能避免（因抛出异常带来的）接口污染\n\n来自 <http://lavasoft.blog.51cto.com/62575/244138/>\n\n### 三、异常链传播\n\n```\npublic void dataAccessCode(){\n    try{\n        ..some code that throws SQLException\n    }catch(SQLException ex){\n        throw new RuntimeException(ex);\n    }\n}\n```\n\n## 参考链接：\n\n1. [Best Practices for Exception Handling](http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html?page=2)\n\n2. [基于Spring的异常体系处理](http://gaojiewyh.iteye.com/blog/1739662)\n\n3. [spring mvc 异常统一处理](http://gaojiewyh.iteye.com/blog/1297746#bc2369985)\n\n4. [异常处理最佳实践.md](https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md)\n","slug":"java-exception","published":1,"updated":"2017-04-16T11:59:29.543Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9l006wjh4kbohgi00j","content":"<h2 id=\"异常的分类\"><a href=\"#异常的分类\" class=\"headerlink\" title=\"异常的分类\"></a>异常的分类</h2><ul>\n<li>业务异常</li>\n</ul>\n<blockquote>\n<p>处理业务的时候80%的时候是没问题的，但可能有20%的时候事情没<br>有按理想的方向发展。例如注册用户的时候，正常情况是注册成功，但<br>可能用户提交请求的时候，系统发现用户名已经被别人注册了，这是就<br>可以抛出一个UserAlreadyExistsException</p>\n<p>来自 <a href=\"https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md</a></p>\n</blockquote>\n<p>业务异常一般是上层可以处理的，一般声明为<code>CheckedException</code>，强制上层进行捕获处理</p>\n<p>业务异常定义示例摘自<a href=\"http://gaojiewyh.iteye.com/blog/1297746#bc2369985\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring mvc 异常统一处理</a>：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class BusinessException extends Exception &#123;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    private static final long serialVersionUID = 1L;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException() &#123;  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException(String message) &#123;  </span><br><span class=\"line\">        super(message);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException(Throwable cause) &#123;  </span><br><span class=\"line\">        super(cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException(String message, Throwable cause) &#123;  </span><br><span class=\"line\">        super(message, cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一般是继承自<code>Exception</code>, 这样就成为<code>CheckedException</code>， 必须强制捕获</p>\n<ul>\n<li>逻辑异常</li>\n</ul>\n<blockquote>\n<p>系统异常与具体业务流程没有直接的关系，例如编程错误导致的NullPointExcpetion，<br>还有环境问题，例如磁盘损坏或者网络连接不稳定造成了IOException。</p>\n<p>来自  <a href=\"https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md</a></p>\n</blockquote>\n<p>系统异常一般是上层无法处理的，所以一般声明为<code>UncheckedException</code>，不强制用户捕获。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class SystemException extends RuntimeException &#123;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    private static final long serialVersionUID = 1L;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public SystemException() &#123;  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    /** </span><br><span class=\"line\">     * @param message </span><br><span class=\"line\">     */  </span><br><span class=\"line\">    public SystemException(String message) &#123;  </span><br><span class=\"line\">        super(message);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    /** </span><br><span class=\"line\">     * @param cause </span><br><span class=\"line\">     */  </span><br><span class=\"line\">    public SystemException(Throwable cause) &#123;  </span><br><span class=\"line\">        super(cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    /** </span><br><span class=\"line\">     * @param message </span><br><span class=\"line\">     * @param cause </span><br><span class=\"line\">     */  </span><br><span class=\"line\">    public SystemException(String message, Throwable cause) &#123;  </span><br><span class=\"line\">        super(message, cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"异常的捕获\"><a href=\"#异常的捕获\" class=\"headerlink\" title=\"异常的捕获\"></a>异常的捕获</h2><p>• 在Service层中应该捕获Dao层抛出的异常并且包装成相应的异常，如业务异常、系统异常等</p>\n<p>  业务层中，通过异常链保存原始异常信息。程序员必须自己编码来保存原始异常的信息。在业务逻辑中，捕获DataAccessException异常，处理包装成SystemException异常抛出。捕获ObjectNotFoundException，DuplicateKeyException异常，处理包装成BusinessException异常抛出。业务层中应根据业务的不同，将异常尽量分得细一点，否则，自定义的异常没有太多的意义。</p>\n<p>来自 <a href=\"http://gaojiewyh.iteye.com/blog/1739662\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://gaojiewyh.iteye.com/blog/1739662</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public addUser(User user) throws BusinessException,SystemException&#123;  </span><br><span class=\"line\">        try&#123;  </span><br><span class=\"line\">              userDao.addUser(user);  </span><br><span class=\"line\">        &#125;catch(DuplicatekeyException ex)&#123;  </span><br><span class=\"line\">             log.infor(&quot;......................&quot;);  </span><br><span class=\"line\">             throw new BusinessException(ex.getCause(),&quot;国际化信息&quot;）；  </span><br><span class=\"line\">        &#125;catch(DataAccessException ex)&#123;  </span><br><span class=\"line\">             log.error(&quot;......................&quot;);  </span><br><span class=\"line\">             throw new SystemException(ex.getCause(),&quot;国际化信息&quot;）；  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"常见误区\"><a href=\"#常见误区\" class=\"headerlink\" title=\"常见误区\"></a>常见误区</h2><h3 id=\"一、定义上捕获者需要用到的信息\"><a href=\"#一、定义上捕获者需要用到的信息\" class=\"headerlink\" title=\"一、定义上捕获者需要用到的信息\"></a>一、定义上捕获者需要用到的信息</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class DuplicateUsernameException extends Exception &#123;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"理由\"><a href=\"#理由\" class=\"headerlink\" title=\"理由:\"></a>理由:</h4><p>它除了有一个”意义明确”的名字以外没有任何有用的信息了。不要忘记Exception跟其他的Java类一样，客户端可以调用其中的方法来得到更多的信息。  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class DuplicateUsernameException extends Exception &#123;</span><br><span class=\"line\">    private static final long serialVersionUID = -6113064394525919823L;</span><br><span class=\"line\">    private String username = null;</span><br><span class=\"line\">    private String[] availableNames = new String[0];</span><br><span class=\"line\"> </span><br><span class=\"line\">    public DuplicateUsernameException(String username) &#123;</span><br><span class=\"line\">            this.username = username;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    public DuplicateUsernameException(String username, String[] availableNames) &#123;</span><br><span class=\"line\">            this(username);</span><br><span class=\"line\">            this.availableNames = availableNames;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    public String requestedUsername() &#123;</span><br><span class=\"line\">            return this.username;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    public String[] availableNames() &#123;</span><br><span class=\"line\">            return this.availableNames;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>来自 <a href=\"http://www.iteye.com/topic/857443\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.iteye.com/topic/857443</a></p>\n<h3 id=\"二、尽可能避免（因抛出异常带来的）接口污染\"><a href=\"#二、尽可能避免（因抛出异常带来的）接口污染\" class=\"headerlink\" title=\"二、尽可能避免（因抛出异常带来的）接口污染\"></a>二、尽可能避免（因抛出异常带来的）接口污染</h3><p>来自 <a href=\"http://lavasoft.blog.51cto.com/62575/244138/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://lavasoft.blog.51cto.com/62575/244138/</a></p>\n<h3 id=\"三、异常链传播\"><a href=\"#三、异常链传播\" class=\"headerlink\" title=\"三、异常链传播\"></a>三、异常链传播</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void dataAccessCode()&#123;</span><br><span class=\"line\">    try&#123;</span><br><span class=\"line\">        ..some code that throws SQLException</span><br><span class=\"line\">    &#125;catch(SQLException ex)&#123;</span><br><span class=\"line\">        throw new RuntimeException(ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接：\"><a href=\"#参考链接：\" class=\"headerlink\" title=\"参考链接：\"></a>参考链接：</h2><ol>\n<li><p><a href=\"http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html?page=2\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Best Practices for Exception Handling</a></p>\n</li>\n<li><p><a href=\"http://gaojiewyh.iteye.com/blog/1739662\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">基于Spring的异常体系处理</a></p>\n</li>\n<li><p><a href=\"http://gaojiewyh.iteye.com/blog/1297746#bc2369985\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring mvc 异常统一处理</a></p>\n</li>\n<li><p><a href=\"https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">异常处理最佳实践.md</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"异常的分类\"><a href=\"#异常的分类\" class=\"headerlink\" title=\"异常的分类\"></a>异常的分类</h2><ul>\n<li>业务异常</li>\n</ul>\n<blockquote>\n<p>处理业务的时候80%的时候是没问题的，但可能有20%的时候事情没<br>有按理想的方向发展。例如注册用户的时候，正常情况是注册成功，但<br>可能用户提交请求的时候，系统发现用户名已经被别人注册了，这是就<br>可以抛出一个UserAlreadyExistsException</p>\n<p>来自 <a href=\"https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md</a></p>\n</blockquote>\n<p>业务异常一般是上层可以处理的，一般声明为<code>CheckedException</code>，强制上层进行捕获处理</p>\n<p>业务异常定义示例摘自<a href=\"http://gaojiewyh.iteye.com/blog/1297746#bc2369985\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring mvc 异常统一处理</a>：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class BusinessException extends Exception &#123;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    private static final long serialVersionUID = 1L;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException() &#123;  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException(String message) &#123;  </span><br><span class=\"line\">        super(message);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException(Throwable cause) &#123;  </span><br><span class=\"line\">        super(cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public BusinessException(String message, Throwable cause) &#123;  </span><br><span class=\"line\">        super(message, cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一般是继承自<code>Exception</code>, 这样就成为<code>CheckedException</code>， 必须强制捕获</p>\n<ul>\n<li>逻辑异常</li>\n</ul>\n<blockquote>\n<p>系统异常与具体业务流程没有直接的关系，例如编程错误导致的NullPointExcpetion，<br>还有环境问题，例如磁盘损坏或者网络连接不稳定造成了IOException。</p>\n<p>来自  <a href=\"https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md</a></p>\n</blockquote>\n<p>系统异常一般是上层无法处理的，所以一般声明为<code>UncheckedException</code>，不强制用户捕获。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class SystemException extends RuntimeException &#123;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    private static final long serialVersionUID = 1L;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    public SystemException() &#123;  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    /** </span><br><span class=\"line\">     * @param message </span><br><span class=\"line\">     */  </span><br><span class=\"line\">    public SystemException(String message) &#123;  </span><br><span class=\"line\">        super(message);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    /** </span><br><span class=\"line\">     * @param cause </span><br><span class=\"line\">     */  </span><br><span class=\"line\">    public SystemException(Throwable cause) &#123;  </span><br><span class=\"line\">        super(cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">    /** </span><br><span class=\"line\">     * @param message </span><br><span class=\"line\">     * @param cause </span><br><span class=\"line\">     */  </span><br><span class=\"line\">    public SystemException(String message, Throwable cause) &#123;  </span><br><span class=\"line\">        super(message, cause);  </span><br><span class=\"line\">        // TODO Auto-generated constructor stub  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">   </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"异常的捕获\"><a href=\"#异常的捕获\" class=\"headerlink\" title=\"异常的捕获\"></a>异常的捕获</h2><p>• 在Service层中应该捕获Dao层抛出的异常并且包装成相应的异常，如业务异常、系统异常等</p>\n<p>  业务层中，通过异常链保存原始异常信息。程序员必须自己编码来保存原始异常的信息。在业务逻辑中，捕获DataAccessException异常，处理包装成SystemException异常抛出。捕获ObjectNotFoundException，DuplicateKeyException异常，处理包装成BusinessException异常抛出。业务层中应根据业务的不同，将异常尽量分得细一点，否则，自定义的异常没有太多的意义。</p>\n<p>来自 <a href=\"http://gaojiewyh.iteye.com/blog/1739662\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://gaojiewyh.iteye.com/blog/1739662</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public addUser(User user) throws BusinessException,SystemException&#123;  </span><br><span class=\"line\">        try&#123;  </span><br><span class=\"line\">              userDao.addUser(user);  </span><br><span class=\"line\">        &#125;catch(DuplicatekeyException ex)&#123;  </span><br><span class=\"line\">             log.infor(&quot;......................&quot;);  </span><br><span class=\"line\">             throw new BusinessException(ex.getCause(),&quot;国际化信息&quot;）；  </span><br><span class=\"line\">        &#125;catch(DataAccessException ex)&#123;  </span><br><span class=\"line\">             log.error(&quot;......................&quot;);  </span><br><span class=\"line\">             throw new SystemException(ex.getCause(),&quot;国际化信息&quot;）；  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"常见误区\"><a href=\"#常见误区\" class=\"headerlink\" title=\"常见误区\"></a>常见误区</h2><h3 id=\"一、定义上捕获者需要用到的信息\"><a href=\"#一、定义上捕获者需要用到的信息\" class=\"headerlink\" title=\"一、定义上捕获者需要用到的信息\"></a>一、定义上捕获者需要用到的信息</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class DuplicateUsernameException extends Exception &#123;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"理由\"><a href=\"#理由\" class=\"headerlink\" title=\"理由:\"></a>理由:</h4><p>它除了有一个”意义明确”的名字以外没有任何有用的信息了。不要忘记Exception跟其他的Java类一样，客户端可以调用其中的方法来得到更多的信息。  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class DuplicateUsernameException extends Exception &#123;</span><br><span class=\"line\">    private static final long serialVersionUID = -6113064394525919823L;</span><br><span class=\"line\">    private String username = null;</span><br><span class=\"line\">    private String[] availableNames = new String[0];</span><br><span class=\"line\"> </span><br><span class=\"line\">    public DuplicateUsernameException(String username) &#123;</span><br><span class=\"line\">            this.username = username;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    public DuplicateUsernameException(String username, String[] availableNames) &#123;</span><br><span class=\"line\">            this(username);</span><br><span class=\"line\">            this.availableNames = availableNames;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    public String requestedUsername() &#123;</span><br><span class=\"line\">            return this.username;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    public String[] availableNames() &#123;</span><br><span class=\"line\">            return this.availableNames;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>来自 <a href=\"http://www.iteye.com/topic/857443\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.iteye.com/topic/857443</a></p>\n<h3 id=\"二、尽可能避免（因抛出异常带来的）接口污染\"><a href=\"#二、尽可能避免（因抛出异常带来的）接口污染\" class=\"headerlink\" title=\"二、尽可能避免（因抛出异常带来的）接口污染\"></a>二、尽可能避免（因抛出异常带来的）接口污染</h3><p>来自 <a href=\"http://lavasoft.blog.51cto.com/62575/244138/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://lavasoft.blog.51cto.com/62575/244138/</a></p>\n<h3 id=\"三、异常链传播\"><a href=\"#三、异常链传播\" class=\"headerlink\" title=\"三、异常链传播\"></a>三、异常链传播</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void dataAccessCode()&#123;</span><br><span class=\"line\">    try&#123;</span><br><span class=\"line\">        ..some code that throws SQLException</span><br><span class=\"line\">    &#125;catch(SQLException ex)&#123;</span><br><span class=\"line\">        throw new RuntimeException(ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接：\"><a href=\"#参考链接：\" class=\"headerlink\" title=\"参考链接：\"></a>参考链接：</h2><ol>\n<li><p><a href=\"http://www.onjava.com/pub/a/onjava/2003/11/19/exceptions.html?page=2\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Best Practices for Exception Handling</a></p>\n</li>\n<li><p><a href=\"http://gaojiewyh.iteye.com/blog/1739662\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">基于Spring的异常体系处理</a></p>\n</li>\n<li><p><a href=\"http://gaojiewyh.iteye.com/blog/1297746#bc2369985\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">spring mvc 异常统一处理</a></p>\n</li>\n<li><p><a href=\"https://github.com/kyfxbl/blog/blob/master/source/_posts/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">异常处理最佳实践.md</a></p>\n</li>\n</ol>\n"},{"title":"java 访问权限区别","toc":true,"abbrlink":50465,"date":"2015-10-20T01:57:22.000Z","_content":"\n## 类成员的访问权限\n<!-- more -->\n\n|  Modifier |  Class  | Package      | Subclass  |  World       |   \n| ----------| --------| -------------| --------- | ------------- \n|  public   |   √     |   √           |  √         |   √           |   \n|  protect  |   √     |   √           |   √        |    x          |  \n|  no modifier |   √  |   √            |  x         |    x          |   \n|  private  |   √     |     x        |     x      |       x       |   \n\n没有修饰符的话就相当于package可见，如果子类不在同一个package则也不能访问相应的方法。\n\n## 参考\n\n > [Controlling Access to Members of a Class](https://docs.oracle.com/javase/tutorial/java/javaOO/accesscontrol.html)\n > [JAVA修饰符类型](http://blog.csdn.net/johnstrive/article/details/5880357)","source":"_posts/java-permission-control.md","raw":"---\ntitle: java 访问权限区别\ntags: 访问权限\ncategory: java\ntoc: true\nabbrlink: 50465\ndate: 2015-10-20 09:57:22\n---\n\n## 类成员的访问权限\n<!-- more -->\n\n|  Modifier |  Class  | Package      | Subclass  |  World       |   \n| ----------| --------| -------------| --------- | ------------- \n|  public   |   √     |   √           |  √         |   √           |   \n|  protect  |   √     |   √           |   √        |    x          |  \n|  no modifier |   √  |   √            |  x         |    x          |   \n|  private  |   √     |     x        |     x      |       x       |   \n\n没有修饰符的话就相当于package可见，如果子类不在同一个package则也不能访问相应的方法。\n\n## 参考\n\n > [Controlling Access to Members of a Class](https://docs.oracle.com/javase/tutorial/java/javaOO/accesscontrol.html)\n > [JAVA修饰符类型](http://blog.csdn.net/johnstrive/article/details/5880357)","slug":"java-permission-control","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9n0070jh4k8c2026ew","content":"<h2 id=\"类成员的访问权限\"><a href=\"#类成员的访问权限\" class=\"headerlink\" title=\"类成员的访问权限\"></a>类成员的访问权限</h2><a id=\"more\"></a>\n<table>\n<thead>\n<tr>\n<th>Modifier</th>\n<th>Class</th>\n<th>Package</th>\n<th>Subclass</th>\n<th>World</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>public</td>\n<td>√</td>\n<td>√</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>protect</td>\n<td>√</td>\n<td>√</td>\n<td>√</td>\n<td>x</td>\n</tr>\n<tr>\n<td>no modifier</td>\n<td>√</td>\n<td>√</td>\n<td>x</td>\n<td>x</td>\n</tr>\n<tr>\n<td>private</td>\n<td>√</td>\n<td>x</td>\n<td>x</td>\n<td>x</td>\n</tr>\n</tbody>\n</table>\n<p>没有修饰符的话就相当于package可见，如果子类不在同一个package则也不能访问相应的方法。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><blockquote>\n<p><a href=\"https://docs.oracle.com/javase/tutorial/java/javaOO/accesscontrol.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Controlling Access to Members of a Class</a><br><a href=\"http://blog.csdn.net/johnstrive/article/details/5880357\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JAVA修饰符类型</a></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h2 id=\"类成员的访问权限\"><a href=\"#类成员的访问权限\" class=\"headerlink\" title=\"类成员的访问权限\"></a>类成员的访问权限</h2>","more":"<table>\n<thead>\n<tr>\n<th>Modifier</th>\n<th>Class</th>\n<th>Package</th>\n<th>Subclass</th>\n<th>World</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>public</td>\n<td>√</td>\n<td>√</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>protect</td>\n<td>√</td>\n<td>√</td>\n<td>√</td>\n<td>x</td>\n</tr>\n<tr>\n<td>no modifier</td>\n<td>√</td>\n<td>√</td>\n<td>x</td>\n<td>x</td>\n</tr>\n<tr>\n<td>private</td>\n<td>√</td>\n<td>x</td>\n<td>x</td>\n<td>x</td>\n</tr>\n</tbody>\n</table>\n<p>没有修饰符的话就相当于package可见，如果子类不在同一个package则也不能访问相应的方法。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><blockquote>\n<p><a href=\"https://docs.oracle.com/javase/tutorial/java/javaOO/accesscontrol.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Controlling Access to Members of a Class</a><br><a href=\"http://blog.csdn.net/johnstrive/article/details/5880357\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JAVA修饰符类型</a></p>\n</blockquote>"},{"title":"在Intellij Idea中生成Javadoc","toc":true,"abbrlink":44687,"date":"2016-10-04T16:06:29.000Z","_content":"\n`Tools | Generate JavaDoc`, 写上输出路径即可。\n\n## 注意事项\n\n1. locale\n\n  简体中文写`zh_CN`\n\n2. 编码\n\n  在`Other Commandline arguments`中指定\n  ```\n  -encoding UTF-8 -charset UTF-8\n  ```\n\n## 参考链接\n\n1. [在 IntelliJ IDEA 中为自己设计的类库生成 JavaDoc](http://www.cnblogs.com/cyberniuniu/p/5021910.html)\n\n2. [Generate JavaDoc Dialog](https://www.jetbrains.com/help/idea/2016.2/generate-javadoc-dialog.html)\n\n3. [Generating JavaDoc Reference for a Project](https://www.jetbrains.com/help/idea/2016.2/generating-javadoc-reference-for-a-project.html)\n","source":"_posts/javadoc.md","raw":"---\ntitle: 在Intellij Idea中生成Javadoc\ntags: Javadoc\ncategory: idea\ntoc: true\nabbrlink: 44687\ndate: 2016-10-05 00:06:29\n---\n\n`Tools | Generate JavaDoc`, 写上输出路径即可。\n\n## 注意事项\n\n1. locale\n\n  简体中文写`zh_CN`\n\n2. 编码\n\n  在`Other Commandline arguments`中指定\n  ```\n  -encoding UTF-8 -charset UTF-8\n  ```\n\n## 参考链接\n\n1. [在 IntelliJ IDEA 中为自己设计的类库生成 JavaDoc](http://www.cnblogs.com/cyberniuniu/p/5021910.html)\n\n2. [Generate JavaDoc Dialog](https://www.jetbrains.com/help/idea/2016.2/generate-javadoc-dialog.html)\n\n3. [Generating JavaDoc Reference for a Project](https://www.jetbrains.com/help/idea/2016.2/generating-javadoc-reference-for-a-project.html)\n","slug":"javadoc","published":1,"updated":"2017-04-16T12:04:30.010Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9o0074jh4k6ry2a5yy","content":"<p><code>Tools | Generate JavaDoc</code>, 写上输出路径即可。</p>\n<h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><ol>\n<li><p>locale</p>\n<p>简体中文写<code>zh_CN</code></p>\n</li>\n<li><p>编码</p>\n<p>在<code>Other Commandline arguments</code>中指定</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-encoding UTF-8 -charset UTF-8</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><p><a href=\"http://www.cnblogs.com/cyberniuniu/p/5021910.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">在 IntelliJ IDEA 中为自己设计的类库生成 JavaDoc</a></p>\n</li>\n<li><p><a href=\"https://www.jetbrains.com/help/idea/2016.2/generate-javadoc-dialog.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Generate JavaDoc Dialog</a></p>\n</li>\n<li><p><a href=\"https://www.jetbrains.com/help/idea/2016.2/generating-javadoc-reference-for-a-project.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Generating JavaDoc Reference for a Project</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p><code>Tools | Generate JavaDoc</code>, 写上输出路径即可。</p>\n<h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><ol>\n<li><p>locale</p>\n<p>简体中文写<code>zh_CN</code></p>\n</li>\n<li><p>编码</p>\n<p>在<code>Other Commandline arguments</code>中指定</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-encoding UTF-8 -charset UTF-8</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><p><a href=\"http://www.cnblogs.com/cyberniuniu/p/5021910.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">在 IntelliJ IDEA 中为自己设计的类库生成 JavaDoc</a></p>\n</li>\n<li><p><a href=\"https://www.jetbrains.com/help/idea/2016.2/generate-javadoc-dialog.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Generate JavaDoc Dialog</a></p>\n</li>\n<li><p><a href=\"https://www.jetbrains.com/help/idea/2016.2/generating-javadoc-reference-for-a-project.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Generating JavaDoc Reference for a Project</a></p>\n</li>\n</ol>\n"},{"title":"使用greys来排查线上问题","toc":true,"date":"2017-11-12T10:10:12.000Z","_content":"\n\n## greys\n\ngreys的理念是将btrace常用的功能命令化，这样可以大大的节省排查问题的时间。\n\n### greys 安装\n\n推荐使用网络安装:\n\n```\ncurl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh|bash\n```\n\n安装后家目录下有如下的文件：\n\n```\n/home/qishengli/.greys\n└── lib\n    └── 1.7.6.4\n        ├── greys\n        │   ├── ga.sh\n        │   ├── greys-agent.jar\n        │   ├── greys-core.jar\n        │   ├── greys.sh\n        │   ├── gs.sh\n        │   └── install-local.sh\n        └── greys-1.7.6.4-bin.zip\n```\n\n\n>其中greys-core.jar为greys的程序主体，启动类、加载类都在这个jar包当中；\n>greys-agent.jar则为目标JVM的加载引导程序；\n>greys.sh为一个可执行脚本，为Greys的启动脚本。\n\n### greys常用功能\n\n启动脚本，\n\n```bash\nsudo -u tomcat -H ./greys.sh  3292\n```\n\n为了安全考虑，一般会限制tomcat启动用户的权限，这里`-u`指定了`tomcat`启动的用户， `3292`是tomcat的进程id。\n交互式shell，输入help即可看到所有支持的命令。\n\n```\nga?>help\n+----------+----------------------------------------------------------------------------------+\n|       sc | Search all the classes loaded by JVM                                             |\n+----------+----------------------------------------------------------------------------------+\n|       sm | Search the method of classes loaded by JVM                                       |\n+----------+----------------------------------------------------------------------------------+\n|  monitor | Monitor the execution of specified Class and its method                          |\n+----------+----------------------------------------------------------------------------------+\n|    watch | Display the details of specified class and method                                |\n+----------+----------------------------------------------------------------------------------+\n|       tt | Time Tunnel                                                                      |\n+----------+----------------------------------------------------------------------------------+\n|    trace | Display the detailed thread stack of specified class and method                  |\n+----------+----------------------------------------------------------------------------------+\n|       js | Enhanced JavaScript                                                              |\n+----------+----------------------------------------------------------------------------------+\n|   ptrace | Display the detailed thread path stack of specified class and method             |\n+----------+----------------------------------------------------------------------------------+\n|    stack | Display the stack trace of specified class and method                            |\n+----------+----------------------------------------------------------------------------------+\n|     quit | Quit Greys console                                                               |\n+----------+----------------------------------------------------------------------------------+\n|  session | Display current session information                                              |\n+----------+----------------------------------------------------------------------------------+\n|  version | Display Greys version                                                            |\n+----------+----------------------------------------------------------------------------------+\n|      jvm | Display the target JVM information                                               |\n+----------+----------------------------------------------------------------------------------+\n|    reset | Reset all the enhanced classes                                                   |\n+----------+----------------------------------------------------------------------------------+\n|      asm | Display class bytecode by asm format                                             |\n+----------+----------------------------------------------------------------------------------+\n| shutdown | Shut down Greys server and exit the console                                      |\n+----------+----------------------------------------------------------------------------------+\n|     help | Display Greys Help                                                               |\n+----------+----------------------------------------------------------------------------------+\n|      top | Display The Threads Of Top CPU TIME                                              |\n+----------+----------------------------------------------------------------------------------+\n```\n\nhelp后面可以跟具体的命令， 会显示命令的具体用法。\n\n```\nga?>help tt\n+---------+----------------------------------------------------------------------------------+\n|   USAGE | -[tlDi:x:w:s:pdEn:] class-pattern method-pattern condition-express               |\n|         | Time Tunnel                                                                      |\n+---------+----------------------------------------------------------------------------------+\n| OPTIONS |              [t] | Record the method invocation within time fragments            |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [l] | List all the time fragments                                   |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [D] | Delete all the time fragments                                 |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [i:] | Display the detailed information from specified time fragmen  |\n|         |                  | t                                                             |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [x:] | Expand level of object (0 by default)                         |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [w:] | watch-express, watch the time fragment by OGNL express, like  |\n|         |                  |  params[0], returnObj, throwExp and so on.                    |\n|         |                  |                                                               |\n|         |                  | FOR EXAMPLE                                                   |\n|         |                  |     params[0]                                                 |\n|         |                  |     params[0]+params[1]                                       |\n|         |                  |     returnObj                                                 |\n|         |                  |     throwExp                                                  |\n|         |                  |     target                                                    |\n|         |                  |     clazz                                                     |\n|         |                  |     method                                                    |\n|         |                  |                                                               |\n|         |                  | THE STRUCTURE                                                 |\n|         |                  |           target : the object                                 |\n|         |                  |            clazz : the object's class                         |\n|         |                  |           method : the constructor or method                  |\n|         |                  |     params[0..n] : the parameters of method                   |\n|         |                  |        returnObj : the returned object of method              |\n|         |                  |         throwExp : the throw exception of method              |\n|         |                  |         isReturn : the method ended by return                 |\n|         |                  |          isThrow : the method ended by throwing exception     |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [s:] | Search-expression, to search the time fragments by OGNL expr  |\n|         |                  | ess                                                           |\n|         |                  |                                                               |\n|         |                  | FOR EXAMPLE                                                   |\n|         |                  |      TRUE : 1==1                                              |\n|         |                  |      TRUE : true                                              |\n|         |                  |     FALSE : false                                             |\n|         |                  |      TRUE : params.length>=0                                  |\n|         |                  |     FALSE : 1==2                                              |\n|         |                  |                                                               |\n|         |                  | THE STRUCTURE                                                 |\n|         |                  |           target : the object                                 |\n|         |                  |            clazz : the object's class                         |\n|         |                  |           method : the constructor or method                  |\n|         |                  |     params[0..n] : the parameters of method                   |\n|         |                  |        returnObj : the returned object of method              |\n|         |                  |         throwExp : the throw exception of method              |\n|         |                  |         isReturn : the method ended by return                 |\n|         |                  |          isThrow : the method ended by throwing exception     |\n|         |                  |           #index : the index of time-fragment record          |\n|         |                  |       #processId : the process ID of time-fragment record     |\n|         |                  |            #cost : the cost time of time-fragment record      |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [p] | Replay the time fragment specified by index                   |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [d] | Delete time fragment specified by index                       |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [E] | Enable regular expression to match (wildcard matching by def  |\n|         |                  | ault)                                                         |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [n:] | Threshold of execution times                                  |\n|         | -----------------+-------------------------------------------------------------- |\n|         |    class-pattern | Path and classname of Pattern Matching                        |\n|         | -----------------+-------------------------------------------------------------- |\n|         |   method-pattern | Method of Pattern Matching                                    |\n|         | -----------------+-------------------------------------------------------------- |\n|         |  condition-expre | Conditional expression by OGNL                                |\n|         |               ss |                                                               |\n|         |                  | FOR EXAMPLE                                                   |\n|         |                  |      TRUE : 1==1                                              |\n|         |                  |      TRUE : true                                              |\n|         |                  |     FALSE : false                                             |\n|         |                  |      TRUE : params.length>=0                                  |\n|         |                  |     FALSE : 1==2                                              |\n|         |                  |                                                               |\n|         |                  | THE STRUCTURE                                                 |\n|         |                  |           target : the object                                 |\n|         |                  |            clazz : the object's class                         |\n|         |                  |           method : the constructor or method                  |\n|         |                  |     params[0..n] : the parameters of method                   |\n|         |                  |        returnObj : the returned object of method              |\n|         |                  |         throwExp : the throw exception of method              |\n|         |                  |         isReturn : the method ended by return                 |\n|         |                  |          isThrow : the method ended by throwing exception     |\n|         |                  |            #cost : the cost(ms) of method                     |\n+---------+----------------------------------------------------------------------------------+\n| EXAMPLE | tt -t *StringUtils isTop                                                         |\n|         | tt -t *StringUtils isTop params[0].length==1                                     |\n|         | tt -l                                                                            |\n|         | tt -D                                                                            |\n|         | tt -i 1000 -w params[0]                                                          |\n|         | tt -i 1000 -d                                                                    |\n|         | tt -i 1000                                                                       |\n+---------+----------------------------------------------------------------------------------+\n```\n\n#### top\n\ngreys的shell里集成的top功能，可以显示jstack中每个线程的cpu占比。\n\n没有greys的时候的做法可能是，先查看native的线程的cpu占用\n\n```\ntop -p 3292 -H\n```\n\n`-H`是显示到线程级别\n\n```\nTasks: 699 total,   0 running, 699 sleeping,   0 stopped,   0 zombie\nCpu(s):  8.0%us,  1.6%sy,  0.0%ni, 90.2%id,  0.0%wa,  0.0%hi,  0.2%si,  0.1%st\nMem:   8059648k total,  7801008k used,   258640k free,    33328k buffers\nSwap:  4194296k total,        0k used,  4194296k free,  2453588k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            \n 5620 tomcat    20   0 9446m 4.2g 6696 S  6.6 54.2  33:46.86 java                                                                               \n 5764 tomcat    20   0 9446m 4.2g 6696 S  5.0 54.2   1:05.94 java                                                                               \n 5787 tomcat    20   0 9446m 4.2g 6696 S  4.0 54.2  57:48.76 java                                                                               \n 5790 tomcat    20   0 9446m 4.2g 6696 S  2.3 54.2  40:31.71 java                                                                               \n 3523 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  68:48.18 java                                                                               \n 3982 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  21:15.22 java                                                                               \n 3385 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  54:10.76 java                                                                               \n 3413 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  29:12.64 java                                                     \n```\n\n由于jstack的输出是16进制的线程号，我们需要根据`PID`进行转换\n\n```\nprintf \"%x\\n\" 5620\n15f4\n```\n\n然后`jstack`去查找相应的java线程栈\n\n```\n\"http-8080-38\" daemon prio=10 tid=0x00007fbcf006e000 nid=0x15f4 in Object.wait() [0x00007fbcd28a1000]\n   java.lang.Thread.State: WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0x000000077b69e488> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at java.lang.Object.wait(Object.java:503)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)\n        - locked <0x000000077b69e488> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)\n        at java.lang.Thread.run(Thread.java:744)\n\n```\n\n费了一番功夫，黄花菜都凉了。\n\n也有将上面的步骤写成一个脚本的，快了许多。（驼厂内部散落着各种不同版本的slow_stack.sh）\n\n```\nThe stack of busy(13.6%) thread(3613/0xe1d) of java pid(3292) all times():\n\"http-8080-13\" daemon prio=10 tid=0x00007fbcf001b000 nid=0xe1d in Object.wait() [0x00007fbce7f7e000]\n   java.lang.Thread.State: WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0x0000000771e29738> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at java.lang.Object.wait(Object.java:503)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)\n        - locked <0x0000000771e29738> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)\n        at java.lang.Thread.run(Thread.java:744)\n```\n\n开源的版本也有， [awesome-scripts/java.md at master · superhj1987/awesome-scripts](https://github.com/superhj1987/awesome-scripts/blob/master/docs/java.md#beer-show-busy-java-threads)\n\n\ngreys中就可以直接使用top命令来查看，\n\n```\nga?>top -t 3 -d\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| ID    |  CPU%  | USR%          | STATE                | THREAD_NAME                                                                           |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| #131  | 04.14% | TIMED_WAITING | CachedClock Updater  | at : sun.misc.Unsafe.park(Native Method)                                              |\n|       |        |               | Thread               | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:349)           |\n|       |        |               |                      | at : qunar.tc.common.clock.CachedClock$1.run(CachedClock.java:22)                     |\n|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| #1282 | 03.51% | WAITING       | http-8080-176        | at : java.lang.Object.wait(Native Method)                                             |\n|       |        |               |                      | at : java.lang.Object.wait(Object.java:503)                                           |\n|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)        |\n|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)          |\n|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| #38   | 03.26% | TIMED_WAITING | thread-monitor-task  | at : sun.misc.Unsafe.park(Native Method)                                              |\n|       |        |               |                      | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)           |\n|       |        |               |                      | at : java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos |\n|       |        |               |                      |      (AbstractQueuedSynchronizer.java:2082)                                           |\n|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |\n|       |        |               |                      |      ThreadPoolExecutor.java:1090)                                                    |\n|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |\n|       |        |               |                      |      ThreadPoolExecutor.java:807)                                                     |\n|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)    |\n|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)  |\n|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)  |\n|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n```\n\n上面显示的就是top3占用cpu的线程\n\n#### monitor —— 监控方法的执行时间\n\n```\nga?>monitor -c2 com.domain.Bean   someMethod   \nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 103 ms.\n+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+\n| TIMESTAMP           | CLASS              | METHOD                     | TOTAL | SUCCESS | FAIL | FAIL-RATE | AVG-RT(ms) | MIN-RT(ms) | MAX-RT(ms) |\n+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+\n| 2017-11-12 17:09:18 | com.domain.Bean    | someMethod                 | 4     | 4       | 0    | 00.00%    | 13.25      | 11         | 17         |\n+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+\n\n```\n\n#### watch —— 全方位监控\n\nwatch可以监控方法的返回值，入参，还可以根据条件筛选（是否抛出异常，响应时间等）\n\n```\nga?>watch com.domain.Bean onMessage params[0]\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 92 ms.\n{\"messageId\":\"171112.171542.192.168.50.191.31779.22733\"}\n\n```\n\n#### tt（time tunel）和ptrace\n\n先说ptrace， 这个和trace差不多， 只是可以加上`-t`将调用存储起来，可以配合`tt`使用\n```\nga?>ptrace -t  -n 1 com.domain.Bean doSend\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:22) cost in 163 ms.\n`---+pTracing for : thread_name=\"http-8080-179\" thread_id=0x505;is_daemon=true;priority=5;process=1002;\n    `---[21,21ms]com.domain.Bean:doSend(); index=1001;\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n```\n\n`tt`:\n\n>时间隧道命令是我在使用watch命令进行问题排查的时候衍生出来的想法。\n>watch虽然很方便和灵活，但需要提前想清楚观察表达式的拼写，这对排查问题而言要求太高，因为很多时候我们并不清楚问题出自于何方，只能靠蛛丝马迹进行猜测.\n>这个时候如果能记录下当时方法调用的所有入参和返回值、抛出的异常会对整个问题的思考与判断非常有帮助。\n>于是乎，TimeTunnel命令就诞生了。\n\n列出所有时间片段或显示一个时间片段的内容:\n\n```\ntt -l\ntt -i 1001\n```\n\n内容：\n\n```\nga?>tt -l\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\nga?>tt -i 1001\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           INDEX | 1001                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      PROCESS-ID | 1002                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      GMT-CREATE | 2017-11-12 17:30:40                                                                                                                                    |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|        COST(ms) | 20                                                                                                                                                     |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          OBJECT | 0x55e9f734                                                                                                                                             |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           CLASS | com.domain.Bean                                                                                 |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          METHOD | doSend                                                                                                                                                 |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|       IS-RETURN | true                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|    IS-EXCEPTION | false                                                                                                                                                  |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[0] | 242996952                                                                                                                                              |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[1] | [CouponBase[id=1,amount=5]                                                                                |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[2] | VoucherSendTask[appName=catalysis,batchSeriesNum=catalysis-train_give_zhoubian-HOURROOM_NEWUSER-HOURROOM,transactionId=catalysis24299695225174650HOURR] |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      RETURN-OBJ | InventoryRecord[activityId=31,transactionId=catalysis24299695225174650HOURROOM242996952]                                                                |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           STACK | thread_name=\"http-8080-179\" thread_id=0x505;is_daemon=true;priority=5;                                                                                 |\n|                 |     @com.qunar.hotel.qta.open.promotion.service.impl.Bean.doSend(Bean.java:179)                                    |\n|                 |         at com.qunar.hotel.qta.open.promotion.service.impl.Bean.sendVoucherThenGetCouponId(Bean.java:191)          |\n|                 |         at com.qunar.hotel.qta.open.promotion.provider.controller.benefit.UserBenefitController.voucherSendThenGetCouponId(UserBenefitController.java: |\n|                 | 841)                                                                                                                                                   |\n|                 |         at sun.reflect.GeneratedMethodAccessor1923.invoke(null:-1)                                                                                     |\n|                 |         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                       |\n|                 |         at java.lang.reflect.Method.invoke(Method.java:606)                                                                                            |\n|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:214)                                       |\n|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:132)                             |\n|                 |         at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:104) |\n|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandleMethod(RequestMappingHandlerAdapter.java:748 |\n|                 | )                                                                                                                                                      |\n|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:689)    |\n|                 |         at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:83)                        |\n|                 |         at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:945)                                                    |\n|                 |         at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:876)                                                     |\n|                 |         at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:931)                                                  |\n|                 |         at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:833)                                                          |\n|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:637)                                                                                |\n|                 |         at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:807)                                                         |\n|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)                                                                                |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at com.alibaba.druid.support.http.WebStatFilter.doFilter(WebStatFilter.java:140)                                                               |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at com.qunar.hotel.qta.base.trace.HttpTraceFilter.doFilter(HttpTraceFilter.java:44)                                                            |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at qunar.ServletWatcher.doFilter(ServletWatcher.java:118)                                                                                      |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)                                    |\n|                 |         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:108)                                                 |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)                                                         |\n|                 |         at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)                                                         |\n|                 |         at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)                                                               |\n|                 |         at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)                                                               |\n|                 |         at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555)                                                                   |\n|                 |         at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)                                                           |\n|                 |         at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)                                                                 |\n|                 |         at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857)                                                                  |\n|                 |         at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)                                            |\n|                 |         at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)                                                                     |\n|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n```\n\n除了使用`ptrace`保存时间片段，也可以使用`tt`，\n\n```\nga?>tt -t  -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 110 ms.\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |         Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n```\n\n*同样的最好指定-n，避免高并发下造成太大影响*\n\n解决方法重载\n\ntt -t *Test print params[0].length==1\n\n通过制定参数个数的形式解决不同的方法签名，如果参数个数一样，你还可以这样写\n\ntt -t *Test print 'params[1].class == Integer.class'\n\n解决指定参数\n\ntt -t *Test print params[0].mobile==\"13989838402\"\n\n具体的可以参见参考文档里的说明。\n\n- `tt`的另外一个便利之处是可以对保存的时间片主动发起一次调用\n\n和dubbo的泛化调用一样，`tt`的这个方法也可以大大降低沟通的成本。\n\n```\nga?>ptrace -t  -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage \nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:2) cost in 126 ms.\n`---+pTracing for : thread_name=\"anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.<clinit>:33-thread-2\" thread_id=0x205;is_daemon=true;priority=5;process=1005;\n    `---[1,1ms]com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener:onMessage(); index=1004;\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |\n|          |            |                      |            |          |          |                 |                             er |                                |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n\nga?>tt -i 1004 -p\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           INDEX | 1004                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      PROCESS-ID | 1005                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      GMT-CREATE | 2017-11-12 17:43:15                                                                                                                                    |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|        COST(ms) | 1                                                                                                                                                      |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          OBJECT | 0x14b7937c                                                                                                                                             |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           CLASS | com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener                                                                      |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          METHOD | onMessage                                                                                                                                              |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|       IS-RETURN | true                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|    IS-EXCEPTION | false                                                                                                                                                  |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[0] | {\"messageId\":\"171112.174315.192.168.50.191.31779.22906\"}                                                                                               |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      RETURN-OBJ |                                                                                                                                                        |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           STACK | thread_name=\"anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.<clinit>:33-thread-2\" thread_id=0x205;is_daemon=tr |\n|                 | ue;priority=5;                                                                                                                                         |\n|                 |     @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:45)             |\n|                 |         at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)                                                             |\n|                 |         at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)                                                                  |\n|                 |         at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)                                                                     |\n|                 |         at java.util.concurrent.FutureTask.run(FutureTask.java:262)                                                                                    |\n|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)                                                             |\n|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)                                                             |\n|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\nTime fragment[1004] successfully replayed.\n```\n\n#### trace\n\n显示指定方法调用的栈，带时间消耗。简单的可以看下调用链上的耗时，进一步的话就需要更加专业的`JProfiler`等工具了\n\n```\nga?>trace -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 102 ms.\n`---+Tracing for : thread_name=\"http-8080-181\" thread_id=0x507;is_daemon=true;priority=5;\n    `---+[13,13ms]com.qunar.hotel.qta.open.promotion.service.impl.Bean:doSend()\n        +---[0,0ms]com.qunar.hotel.qta.coupon.api.bean.CouponUser:<init>(@175)\n        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getVoucherTypeId(@176)\n        +---[0,0ms]java.lang.StringBuilder:<init>(@176)\n        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getTransactionId(@176)\n        +---[0,0ms]java.lang.StringBuilder:append(@176)\n        +---[0,0ms]java.lang.StringBuilder:append(@176)\n        +---[0,0ms]java.lang.StringBuilder:toString(@176)\n        +---[12,12ms]com.qunar.hotel.qta.coupon.api.remote.ActivityWriteRemote:consume(@176)\n        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getAppName(@177)\n        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getBatchSeriesNum(@177)\n        +---[12,0ms]java.lang.Long:valueOf(@177)\n        +---[12,0ms]java.util.List:size(@177)\n        +---[13,0ms]java.lang.Integer:valueOf(@177)\n        `---[13,0ms]org.slf4j.Logger:info(@177)\n```\n\n最好也指定下`-n`\n\n#### stack\n\nstack可以产品指定方法调用的stack， 支持正则， 也支持各种条件表达式，具体可以`help stack`\n\n```\nga?>stack -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage \nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 111 ms.\nthread_name=\"anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.<clinit>:33-thread-6\" thread_id=0x20e;is_daemon=true;priority=5;\n    @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:-1)\n        at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)\n        at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)\n```\n\n*注意最好指定下-n参数，以免对线上系统造成较大的压力*\n\n\n#### 其他\n\n还有一些其他的用法，比如支持使用js编写自定义的脚本， 查看jvm的信息， 查看加载的类等等。\n\n\n### 安全性\n\n\n> （1） 哪些命令会导致性能问题\n\nGreys的大部分命令性能开销都非常低廉，当然前提是一次性操作的类不要太多。\n\n> （2） 是否能增强由BootstrapClassLoader所加载的类\n\n当然是可以的，但默认我封印了这个能力。主要是Greys自己也使用了大量BootstrapClassLoader所加载的类，如果处理不好极其容易造成故障。\n\n你可以通过隐藏命令options激活这个功能\n\n```\nga?>options unsafe true\n+--------+--------------+-------------+\n| NAME   | BEFORE-VALUE | AFTER-VALUE |\n+--------+--------------+-------------+\n| unsafe | false        | true        |\n+--------+--------------+-------------+\nAffect(row-cnt:1) cost in 2 ms.\n```\n接下来你可以尝试增强系统类了\n\n```\nga?>monitor -c 5 java.lang.String substring\nPress Ctrl+D or Ctrl+X to abort.\nAffect(class-cnt:1 , method-cnt:2) cost in 35 ms.\n+---------------------+------------------+-----------+-------+---------+------+------+-----------+\n| timestamp           | class            | method    | total | success | fail | rt   | fail-rate |\n+---------------------+------------------+-----------+-------+---------+------+------+-----------+\n| 2015-06-16 23:44:54 | java.lang.String | substring | 30    | 30      | 0    | 0.23 | 0.00%     |\n+---------------------+------------------+-----------+-------+---------+------+------+-----------+\n```\n但我话就放在这里，随意增强系统类。后果自负！\n\n### greys 退出\n\ngreys的数据是保存在内存中的， 有些记录的栈桢需要清理，因此推荐使用`shutdown`方法\n\n```\nga?>tt -l\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |\n|          |            |                      |            |          |          |                 |                             er |                                |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n```\n\n这些时间片默认是保存的，所以退出的时候需要清理下，不然对应用的gc都会有影响。\n\n```\nga?>shutdown\nGreys Server is shut down.\n```\n\ngreys 还提供了一个`reset`的命令，可以还原所有被增强过的类。\n\n>   reset : Reset all the enhanced classes\n\n\n\n## 参考\n\n1. [greys pdf · oldmanpushcart/greys-anatomy Wiki](https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf)\n\n2. [Grays Anatomy源码浅析--ClassLoader,Java,Method,DES,null,方法,INVOKING](http://www.bijishequ.com/detail/435931?p=29-55)\n\n3. [FAQ · oldmanpushcart/greys-anatomy Wiki](https://github.com/oldmanpushcart/greys-anatomy/wiki/FAQ)\n\n4. [java 线上调试工具 greys-anatomy 实践初探 | Kuzan](http://hongkaiwen.github.io/2017/07/22/java-%E7%BA%BF%E4%B8%8A%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7-greys-anatomy-%E5%AE%9E%E8%B7%B5%E5%88%9D%E6%8E%A2/index.html)\n\n5. [Btrace入门到熟练小工完全指南 | 江南白衣](http://calvin1978.blogcn.com/articles/btrace1.html)\n\n6. [线上服务 CPU 100%？一键定位 so easy！](http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&mid=2651478959&idx=2&sn=25bac2f47851c436f27c679e77e892ae&chksm=bd2537d08a52bec6d5987b98e885d5b466569a7ba621a5e93297a5490ebd2ea75a04c7b51d47&mpshare=1&scene=1&srcid=09056wNl5ibsbHVZNqBGAT8w#rd)\n\n7. [UserGuideCN · CSUG/HouseMD Wiki](https://github.com/CSUG/HouseMD/wiki/UserGuideCN)\n\n8. [superhj1987/awesome-scripts: useful scripts for Linux op](https://github.com/superhj1987/awesome-scripts)","source":"_posts/greys.md","raw":"title: 使用greys来排查线上问题\ntags: greys\ncategory: perf\ntoc: true\ndate: 2017-11-12 18:10:12\n---\n\n\n## greys\n\ngreys的理念是将btrace常用的功能命令化，这样可以大大的节省排查问题的时间。\n\n### greys 安装\n\n推荐使用网络安装:\n\n```\ncurl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh|bash\n```\n\n安装后家目录下有如下的文件：\n\n```\n/home/qishengli/.greys\n└── lib\n    └── 1.7.6.4\n        ├── greys\n        │   ├── ga.sh\n        │   ├── greys-agent.jar\n        │   ├── greys-core.jar\n        │   ├── greys.sh\n        │   ├── gs.sh\n        │   └── install-local.sh\n        └── greys-1.7.6.4-bin.zip\n```\n\n\n>其中greys-core.jar为greys的程序主体，启动类、加载类都在这个jar包当中；\n>greys-agent.jar则为目标JVM的加载引导程序；\n>greys.sh为一个可执行脚本，为Greys的启动脚本。\n\n### greys常用功能\n\n启动脚本，\n\n```bash\nsudo -u tomcat -H ./greys.sh  3292\n```\n\n为了安全考虑，一般会限制tomcat启动用户的权限，这里`-u`指定了`tomcat`启动的用户， `3292`是tomcat的进程id。\n交互式shell，输入help即可看到所有支持的命令。\n\n```\nga?>help\n+----------+----------------------------------------------------------------------------------+\n|       sc | Search all the classes loaded by JVM                                             |\n+----------+----------------------------------------------------------------------------------+\n|       sm | Search the method of classes loaded by JVM                                       |\n+----------+----------------------------------------------------------------------------------+\n|  monitor | Monitor the execution of specified Class and its method                          |\n+----------+----------------------------------------------------------------------------------+\n|    watch | Display the details of specified class and method                                |\n+----------+----------------------------------------------------------------------------------+\n|       tt | Time Tunnel                                                                      |\n+----------+----------------------------------------------------------------------------------+\n|    trace | Display the detailed thread stack of specified class and method                  |\n+----------+----------------------------------------------------------------------------------+\n|       js | Enhanced JavaScript                                                              |\n+----------+----------------------------------------------------------------------------------+\n|   ptrace | Display the detailed thread path stack of specified class and method             |\n+----------+----------------------------------------------------------------------------------+\n|    stack | Display the stack trace of specified class and method                            |\n+----------+----------------------------------------------------------------------------------+\n|     quit | Quit Greys console                                                               |\n+----------+----------------------------------------------------------------------------------+\n|  session | Display current session information                                              |\n+----------+----------------------------------------------------------------------------------+\n|  version | Display Greys version                                                            |\n+----------+----------------------------------------------------------------------------------+\n|      jvm | Display the target JVM information                                               |\n+----------+----------------------------------------------------------------------------------+\n|    reset | Reset all the enhanced classes                                                   |\n+----------+----------------------------------------------------------------------------------+\n|      asm | Display class bytecode by asm format                                             |\n+----------+----------------------------------------------------------------------------------+\n| shutdown | Shut down Greys server and exit the console                                      |\n+----------+----------------------------------------------------------------------------------+\n|     help | Display Greys Help                                                               |\n+----------+----------------------------------------------------------------------------------+\n|      top | Display The Threads Of Top CPU TIME                                              |\n+----------+----------------------------------------------------------------------------------+\n```\n\nhelp后面可以跟具体的命令， 会显示命令的具体用法。\n\n```\nga?>help tt\n+---------+----------------------------------------------------------------------------------+\n|   USAGE | -[tlDi:x:w:s:pdEn:] class-pattern method-pattern condition-express               |\n|         | Time Tunnel                                                                      |\n+---------+----------------------------------------------------------------------------------+\n| OPTIONS |              [t] | Record the method invocation within time fragments            |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [l] | List all the time fragments                                   |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [D] | Delete all the time fragments                                 |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [i:] | Display the detailed information from specified time fragmen  |\n|         |                  | t                                                             |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [x:] | Expand level of object (0 by default)                         |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [w:] | watch-express, watch the time fragment by OGNL express, like  |\n|         |                  |  params[0], returnObj, throwExp and so on.                    |\n|         |                  |                                                               |\n|         |                  | FOR EXAMPLE                                                   |\n|         |                  |     params[0]                                                 |\n|         |                  |     params[0]+params[1]                                       |\n|         |                  |     returnObj                                                 |\n|         |                  |     throwExp                                                  |\n|         |                  |     target                                                    |\n|         |                  |     clazz                                                     |\n|         |                  |     method                                                    |\n|         |                  |                                                               |\n|         |                  | THE STRUCTURE                                                 |\n|         |                  |           target : the object                                 |\n|         |                  |            clazz : the object's class                         |\n|         |                  |           method : the constructor or method                  |\n|         |                  |     params[0..n] : the parameters of method                   |\n|         |                  |        returnObj : the returned object of method              |\n|         |                  |         throwExp : the throw exception of method              |\n|         |                  |         isReturn : the method ended by return                 |\n|         |                  |          isThrow : the method ended by throwing exception     |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [s:] | Search-expression, to search the time fragments by OGNL expr  |\n|         |                  | ess                                                           |\n|         |                  |                                                               |\n|         |                  | FOR EXAMPLE                                                   |\n|         |                  |      TRUE : 1==1                                              |\n|         |                  |      TRUE : true                                              |\n|         |                  |     FALSE : false                                             |\n|         |                  |      TRUE : params.length>=0                                  |\n|         |                  |     FALSE : 1==2                                              |\n|         |                  |                                                               |\n|         |                  | THE STRUCTURE                                                 |\n|         |                  |           target : the object                                 |\n|         |                  |            clazz : the object's class                         |\n|         |                  |           method : the constructor or method                  |\n|         |                  |     params[0..n] : the parameters of method                   |\n|         |                  |        returnObj : the returned object of method              |\n|         |                  |         throwExp : the throw exception of method              |\n|         |                  |         isReturn : the method ended by return                 |\n|         |                  |          isThrow : the method ended by throwing exception     |\n|         |                  |           #index : the index of time-fragment record          |\n|         |                  |       #processId : the process ID of time-fragment record     |\n|         |                  |            #cost : the cost time of time-fragment record      |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [p] | Replay the time fragment specified by index                   |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [d] | Delete time fragment specified by index                       |\n|         | -----------------+-------------------------------------------------------------- |\n|         |              [E] | Enable regular expression to match (wildcard matching by def  |\n|         |                  | ault)                                                         |\n|         | -----------------+-------------------------------------------------------------- |\n|         |             [n:] | Threshold of execution times                                  |\n|         | -----------------+-------------------------------------------------------------- |\n|         |    class-pattern | Path and classname of Pattern Matching                        |\n|         | -----------------+-------------------------------------------------------------- |\n|         |   method-pattern | Method of Pattern Matching                                    |\n|         | -----------------+-------------------------------------------------------------- |\n|         |  condition-expre | Conditional expression by OGNL                                |\n|         |               ss |                                                               |\n|         |                  | FOR EXAMPLE                                                   |\n|         |                  |      TRUE : 1==1                                              |\n|         |                  |      TRUE : true                                              |\n|         |                  |     FALSE : false                                             |\n|         |                  |      TRUE : params.length>=0                                  |\n|         |                  |     FALSE : 1==2                                              |\n|         |                  |                                                               |\n|         |                  | THE STRUCTURE                                                 |\n|         |                  |           target : the object                                 |\n|         |                  |            clazz : the object's class                         |\n|         |                  |           method : the constructor or method                  |\n|         |                  |     params[0..n] : the parameters of method                   |\n|         |                  |        returnObj : the returned object of method              |\n|         |                  |         throwExp : the throw exception of method              |\n|         |                  |         isReturn : the method ended by return                 |\n|         |                  |          isThrow : the method ended by throwing exception     |\n|         |                  |            #cost : the cost(ms) of method                     |\n+---------+----------------------------------------------------------------------------------+\n| EXAMPLE | tt -t *StringUtils isTop                                                         |\n|         | tt -t *StringUtils isTop params[0].length==1                                     |\n|         | tt -l                                                                            |\n|         | tt -D                                                                            |\n|         | tt -i 1000 -w params[0]                                                          |\n|         | tt -i 1000 -d                                                                    |\n|         | tt -i 1000                                                                       |\n+---------+----------------------------------------------------------------------------------+\n```\n\n#### top\n\ngreys的shell里集成的top功能，可以显示jstack中每个线程的cpu占比。\n\n没有greys的时候的做法可能是，先查看native的线程的cpu占用\n\n```\ntop -p 3292 -H\n```\n\n`-H`是显示到线程级别\n\n```\nTasks: 699 total,   0 running, 699 sleeping,   0 stopped,   0 zombie\nCpu(s):  8.0%us,  1.6%sy,  0.0%ni, 90.2%id,  0.0%wa,  0.0%hi,  0.2%si,  0.1%st\nMem:   8059648k total,  7801008k used,   258640k free,    33328k buffers\nSwap:  4194296k total,        0k used,  4194296k free,  2453588k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            \n 5620 tomcat    20   0 9446m 4.2g 6696 S  6.6 54.2  33:46.86 java                                                                               \n 5764 tomcat    20   0 9446m 4.2g 6696 S  5.0 54.2   1:05.94 java                                                                               \n 5787 tomcat    20   0 9446m 4.2g 6696 S  4.0 54.2  57:48.76 java                                                                               \n 5790 tomcat    20   0 9446m 4.2g 6696 S  2.3 54.2  40:31.71 java                                                                               \n 3523 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  68:48.18 java                                                                               \n 3982 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  21:15.22 java                                                                               \n 3385 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  54:10.76 java                                                                               \n 3413 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  29:12.64 java                                                     \n```\n\n由于jstack的输出是16进制的线程号，我们需要根据`PID`进行转换\n\n```\nprintf \"%x\\n\" 5620\n15f4\n```\n\n然后`jstack`去查找相应的java线程栈\n\n```\n\"http-8080-38\" daemon prio=10 tid=0x00007fbcf006e000 nid=0x15f4 in Object.wait() [0x00007fbcd28a1000]\n   java.lang.Thread.State: WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0x000000077b69e488> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at java.lang.Object.wait(Object.java:503)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)\n        - locked <0x000000077b69e488> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)\n        at java.lang.Thread.run(Thread.java:744)\n\n```\n\n费了一番功夫，黄花菜都凉了。\n\n也有将上面的步骤写成一个脚本的，快了许多。（驼厂内部散落着各种不同版本的slow_stack.sh）\n\n```\nThe stack of busy(13.6%) thread(3613/0xe1d) of java pid(3292) all times():\n\"http-8080-13\" daemon prio=10 tid=0x00007fbcf001b000 nid=0xe1d in Object.wait() [0x00007fbce7f7e000]\n   java.lang.Thread.State: WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0x0000000771e29738> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at java.lang.Object.wait(Object.java:503)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)\n        - locked <0x0000000771e29738> (a org.apache.tomcat.util.net.JIoEndpoint$Worker)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)\n        at java.lang.Thread.run(Thread.java:744)\n```\n\n开源的版本也有， [awesome-scripts/java.md at master · superhj1987/awesome-scripts](https://github.com/superhj1987/awesome-scripts/blob/master/docs/java.md#beer-show-busy-java-threads)\n\n\ngreys中就可以直接使用top命令来查看，\n\n```\nga?>top -t 3 -d\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| ID    |  CPU%  | USR%          | STATE                | THREAD_NAME                                                                           |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| #131  | 04.14% | TIMED_WAITING | CachedClock Updater  | at : sun.misc.Unsafe.park(Native Method)                                              |\n|       |        |               | Thread               | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:349)           |\n|       |        |               |                      | at : qunar.tc.common.clock.CachedClock$1.run(CachedClock.java:22)                     |\n|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| #1282 | 03.51% | WAITING       | http-8080-176        | at : java.lang.Object.wait(Native Method)                                             |\n|       |        |               |                      | at : java.lang.Object.wait(Object.java:503)                                           |\n|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)        |\n|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)          |\n|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n| #38   | 03.26% | TIMED_WAITING | thread-monitor-task  | at : sun.misc.Unsafe.park(Native Method)                                              |\n|       |        |               |                      | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)           |\n|       |        |               |                      | at : java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos |\n|       |        |               |                      |      (AbstractQueuedSynchronizer.java:2082)                                           |\n|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |\n|       |        |               |                      |      ThreadPoolExecutor.java:1090)                                                    |\n|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |\n|       |        |               |                      |      ThreadPoolExecutor.java:807)                                                     |\n|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)    |\n|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)  |\n|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)  |\n|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |\n+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+\n```\n\n上面显示的就是top3占用cpu的线程\n\n#### monitor —— 监控方法的执行时间\n\n```\nga?>monitor -c2 com.domain.Bean   someMethod   \nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 103 ms.\n+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+\n| TIMESTAMP           | CLASS              | METHOD                     | TOTAL | SUCCESS | FAIL | FAIL-RATE | AVG-RT(ms) | MIN-RT(ms) | MAX-RT(ms) |\n+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+\n| 2017-11-12 17:09:18 | com.domain.Bean    | someMethod                 | 4     | 4       | 0    | 00.00%    | 13.25      | 11         | 17         |\n+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+\n\n```\n\n#### watch —— 全方位监控\n\nwatch可以监控方法的返回值，入参，还可以根据条件筛选（是否抛出异常，响应时间等）\n\n```\nga?>watch com.domain.Bean onMessage params[0]\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 92 ms.\n{\"messageId\":\"171112.171542.192.168.50.191.31779.22733\"}\n\n```\n\n#### tt（time tunel）和ptrace\n\n先说ptrace， 这个和trace差不多， 只是可以加上`-t`将调用存储起来，可以配合`tt`使用\n```\nga?>ptrace -t  -n 1 com.domain.Bean doSend\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:22) cost in 163 ms.\n`---+pTracing for : thread_name=\"http-8080-179\" thread_id=0x505;is_daemon=true;priority=5;process=1002;\n    `---[21,21ms]com.domain.Bean:doSend(); index=1001;\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n```\n\n`tt`:\n\n>时间隧道命令是我在使用watch命令进行问题排查的时候衍生出来的想法。\n>watch虽然很方便和灵活，但需要提前想清楚观察表达式的拼写，这对排查问题而言要求太高，因为很多时候我们并不清楚问题出自于何方，只能靠蛛丝马迹进行猜测.\n>这个时候如果能记录下当时方法调用的所有入参和返回值、抛出的异常会对整个问题的思考与判断非常有帮助。\n>于是乎，TimeTunnel命令就诞生了。\n\n列出所有时间片段或显示一个时间片段的内容:\n\n```\ntt -l\ntt -i 1001\n```\n\n内容：\n\n```\nga?>tt -l\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\nga?>tt -i 1001\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           INDEX | 1001                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      PROCESS-ID | 1002                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      GMT-CREATE | 2017-11-12 17:30:40                                                                                                                                    |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|        COST(ms) | 20                                                                                                                                                     |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          OBJECT | 0x55e9f734                                                                                                                                             |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           CLASS | com.domain.Bean                                                                                 |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          METHOD | doSend                                                                                                                                                 |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|       IS-RETURN | true                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|    IS-EXCEPTION | false                                                                                                                                                  |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[0] | 242996952                                                                                                                                              |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[1] | [CouponBase[id=1,amount=5]                                                                                |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[2] | VoucherSendTask[appName=catalysis,batchSeriesNum=catalysis-train_give_zhoubian-HOURROOM_NEWUSER-HOURROOM,transactionId=catalysis24299695225174650HOURR] |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      RETURN-OBJ | InventoryRecord[activityId=31,transactionId=catalysis24299695225174650HOURROOM242996952]                                                                |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           STACK | thread_name=\"http-8080-179\" thread_id=0x505;is_daemon=true;priority=5;                                                                                 |\n|                 |     @com.qunar.hotel.qta.open.promotion.service.impl.Bean.doSend(Bean.java:179)                                    |\n|                 |         at com.qunar.hotel.qta.open.promotion.service.impl.Bean.sendVoucherThenGetCouponId(Bean.java:191)          |\n|                 |         at com.qunar.hotel.qta.open.promotion.provider.controller.benefit.UserBenefitController.voucherSendThenGetCouponId(UserBenefitController.java: |\n|                 | 841)                                                                                                                                                   |\n|                 |         at sun.reflect.GeneratedMethodAccessor1923.invoke(null:-1)                                                                                     |\n|                 |         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                       |\n|                 |         at java.lang.reflect.Method.invoke(Method.java:606)                                                                                            |\n|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:214)                                       |\n|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:132)                             |\n|                 |         at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:104) |\n|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandleMethod(RequestMappingHandlerAdapter.java:748 |\n|                 | )                                                                                                                                                      |\n|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:689)    |\n|                 |         at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:83)                        |\n|                 |         at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:945)                                                    |\n|                 |         at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:876)                                                     |\n|                 |         at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:931)                                                  |\n|                 |         at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:833)                                                          |\n|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:637)                                                                                |\n|                 |         at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:807)                                                         |\n|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)                                                                                |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at com.alibaba.druid.support.http.WebStatFilter.doFilter(WebStatFilter.java:140)                                                               |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at com.qunar.hotel.qta.base.trace.HttpTraceFilter.doFilter(HttpTraceFilter.java:44)                                                            |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at qunar.ServletWatcher.doFilter(ServletWatcher.java:118)                                                                                      |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)                                    |\n|                 |         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:108)                                                 |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |\n|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |\n|                 |         at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)                                                         |\n|                 |         at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)                                                         |\n|                 |         at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)                                                               |\n|                 |         at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)                                                               |\n|                 |         at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555)                                                                   |\n|                 |         at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)                                                           |\n|                 |         at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)                                                                 |\n|                 |         at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857)                                                                  |\n|                 |         at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)                                            |\n|                 |         at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)                                                                     |\n|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n```\n\n除了使用`ptrace`保存时间片段，也可以使用`tt`，\n\n```\nga?>tt -t  -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 110 ms.\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |         Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n```\n\n*同样的最好指定-n，避免高并发下造成太大影响*\n\n解决方法重载\n\ntt -t *Test print params[0].length==1\n\n通过制定参数个数的形式解决不同的方法签名，如果参数个数一样，你还可以这样写\n\ntt -t *Test print 'params[1].class == Integer.class'\n\n解决指定参数\n\ntt -t *Test print params[0].mobile==\"13989838402\"\n\n具体的可以参见参考文档里的说明。\n\n- `tt`的另外一个便利之处是可以对保存的时间片主动发起一次调用\n\n和dubbo的泛化调用一样，`tt`的这个方法也可以大大降低沟通的成本。\n\n```\nga?>ptrace -t  -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage \nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:2) cost in 126 ms.\n`---+pTracing for : thread_name=\"anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.<clinit>:33-thread-2\" thread_id=0x205;is_daemon=true;priority=5;process=1005;\n    `---[1,1ms]com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener:onMessage(); index=1004;\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |\n|          |            |                      |            |          |          |                 |                             er |                                |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n\nga?>tt -i 1004 -p\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           INDEX | 1004                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      PROCESS-ID | 1005                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      GMT-CREATE | 2017-11-12 17:43:15                                                                                                                                    |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|        COST(ms) | 1                                                                                                                                                      |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          OBJECT | 0x14b7937c                                                                                                                                             |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           CLASS | com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener                                                                      |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|          METHOD | onMessage                                                                                                                                              |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|       IS-RETURN | true                                                                                                                                                   |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|    IS-EXCEPTION | false                                                                                                                                                  |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|   PARAMETERS[0] | {\"messageId\":\"171112.174315.192.168.50.191.31779.22906\"}                                                                                               |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|      RETURN-OBJ |                                                                                                                                                        |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           STACK | thread_name=\"anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.<clinit>:33-thread-2\" thread_id=0x205;is_daemon=tr |\n|                 | ue;priority=5;                                                                                                                                         |\n|                 |     @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:45)             |\n|                 |         at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)                                                             |\n|                 |         at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)                                                                  |\n|                 |         at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)                                                                     |\n|                 |         at java.util.concurrent.FutureTask.run(FutureTask.java:262)                                                                                    |\n|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)                                                             |\n|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)                                                             |\n|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\nTime fragment[1004] successfully replayed.\n```\n\n#### trace\n\n显示指定方法调用的栈，带时间消耗。简单的可以看下调用链上的耗时，进一步的话就需要更加专业的`JProfiler`等工具了\n\n```\nga?>trace -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend\nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 102 ms.\n`---+Tracing for : thread_name=\"http-8080-181\" thread_id=0x507;is_daemon=true;priority=5;\n    `---+[13,13ms]com.qunar.hotel.qta.open.promotion.service.impl.Bean:doSend()\n        +---[0,0ms]com.qunar.hotel.qta.coupon.api.bean.CouponUser:<init>(@175)\n        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getVoucherTypeId(@176)\n        +---[0,0ms]java.lang.StringBuilder:<init>(@176)\n        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getTransactionId(@176)\n        +---[0,0ms]java.lang.StringBuilder:append(@176)\n        +---[0,0ms]java.lang.StringBuilder:append(@176)\n        +---[0,0ms]java.lang.StringBuilder:toString(@176)\n        +---[12,12ms]com.qunar.hotel.qta.coupon.api.remote.ActivityWriteRemote:consume(@176)\n        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getAppName(@177)\n        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getBatchSeriesNum(@177)\n        +---[12,0ms]java.lang.Long:valueOf(@177)\n        +---[12,0ms]java.util.List:size(@177)\n        +---[13,0ms]java.lang.Integer:valueOf(@177)\n        `---[13,0ms]org.slf4j.Logger:info(@177)\n```\n\n最好也指定下`-n`\n\n#### stack\n\nstack可以产品指定方法调用的stack， 支持正则， 也支持各种条件表达式，具体可以`help stack`\n\n```\nga?>stack -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage \nPress Ctrl+D to abort.\nAffect(class-cnt:1 , method-cnt:1) cost in 111 ms.\nthread_name=\"anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.<clinit>:33-thread-6\" thread_id=0x20e;is_daemon=true;priority=5;\n    @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:-1)\n        at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)\n        at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)\n```\n\n*注意最好指定下-n参数，以免对线上系统造成较大的压力*\n\n\n#### 其他\n\n还有一些其他的用法，比如支持使用js编写自定义的脚本， 查看jvm的信息， 查看加载的类等等。\n\n\n### 安全性\n\n\n> （1） 哪些命令会导致性能问题\n\nGreys的大部分命令性能开销都非常低廉，当然前提是一次性操作的类不要太多。\n\n> （2） 是否能增强由BootstrapClassLoader所加载的类\n\n当然是可以的，但默认我封印了这个能力。主要是Greys自己也使用了大量BootstrapClassLoader所加载的类，如果处理不好极其容易造成故障。\n\n你可以通过隐藏命令options激活这个功能\n\n```\nga?>options unsafe true\n+--------+--------------+-------------+\n| NAME   | BEFORE-VALUE | AFTER-VALUE |\n+--------+--------------+-------------+\n| unsafe | false        | true        |\n+--------+--------------+-------------+\nAffect(row-cnt:1) cost in 2 ms.\n```\n接下来你可以尝试增强系统类了\n\n```\nga?>monitor -c 5 java.lang.String substring\nPress Ctrl+D or Ctrl+X to abort.\nAffect(class-cnt:1 , method-cnt:2) cost in 35 ms.\n+---------------------+------------------+-----------+-------+---------+------+------+-----------+\n| timestamp           | class            | method    | total | success | fail | rt   | fail-rate |\n+---------------------+------------------+-----------+-------+---------+------+------+-----------+\n| 2015-06-16 23:44:54 | java.lang.String | substring | 30    | 30      | 0    | 0.23 | 0.00%     |\n+---------------------+------------------+-----------+-------+---------+------+------+-----------+\n```\n但我话就放在这里，随意增强系统类。后果自负！\n\n### greys 退出\n\ngreys的数据是保存在内存中的， 有些记录的栈桢需要清理，因此推荐使用`shutdown`方法\n\n```\nga?>tt -l\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |\n|          |            |                      |            |          |          |                 |                             er |                                |\n+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+\n```\n\n这些时间片默认是保存的，所以退出的时候需要清理下，不然对应用的gc都会有影响。\n\n```\nga?>shutdown\nGreys Server is shut down.\n```\n\ngreys 还提供了一个`reset`的命令，可以还原所有被增强过的类。\n\n>   reset : Reset all the enhanced classes\n\n\n\n## 参考\n\n1. [greys pdf · oldmanpushcart/greys-anatomy Wiki](https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf)\n\n2. [Grays Anatomy源码浅析--ClassLoader,Java,Method,DES,null,方法,INVOKING](http://www.bijishequ.com/detail/435931?p=29-55)\n\n3. [FAQ · oldmanpushcart/greys-anatomy Wiki](https://github.com/oldmanpushcart/greys-anatomy/wiki/FAQ)\n\n4. [java 线上调试工具 greys-anatomy 实践初探 | Kuzan](http://hongkaiwen.github.io/2017/07/22/java-%E7%BA%BF%E4%B8%8A%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7-greys-anatomy-%E5%AE%9E%E8%B7%B5%E5%88%9D%E6%8E%A2/index.html)\n\n5. [Btrace入门到熟练小工完全指南 | 江南白衣](http://calvin1978.blogcn.com/articles/btrace1.html)\n\n6. [线上服务 CPU 100%？一键定位 so easy！](http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&mid=2651478959&idx=2&sn=25bac2f47851c436f27c679e77e892ae&chksm=bd2537d08a52bec6d5987b98e885d5b466569a7ba621a5e93297a5490ebd2ea75a04c7b51d47&mpshare=1&scene=1&srcid=09056wNl5ibsbHVZNqBGAT8w#rd)\n\n7. [UserGuideCN · CSUG/HouseMD Wiki](https://github.com/CSUG/HouseMD/wiki/UserGuideCN)\n\n8. [superhj1987/awesome-scripts: useful scripts for Linux op](https://github.com/superhj1987/awesome-scripts)","slug":"greys","published":1,"updated":"2018-04-01T14:48:20.265Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9q0078jh4kgx9fzxv7","content":"<h2 id=\"greys\"><a href=\"#greys\" class=\"headerlink\" title=\"greys\"></a>greys</h2><p>greys的理念是将btrace常用的功能命令化，这样可以大大的节省排查问题的时间。</p>\n<h3 id=\"greys-安装\"><a href=\"#greys-安装\" class=\"headerlink\" title=\"greys 安装\"></a>greys 安装</h3><p>推荐使用网络安装:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh|bash</span><br></pre></td></tr></table></figure>\n<p>安装后家目录下有如下的文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/home/qishengli/.greys</span><br><span class=\"line\">└── lib</span><br><span class=\"line\">    └── 1.7.6.4</span><br><span class=\"line\">        ├── greys</span><br><span class=\"line\">        │   ├── ga.sh</span><br><span class=\"line\">        │   ├── greys-agent.jar</span><br><span class=\"line\">        │   ├── greys-core.jar</span><br><span class=\"line\">        │   ├── greys.sh</span><br><span class=\"line\">        │   ├── gs.sh</span><br><span class=\"line\">        │   └── install-local.sh</span><br><span class=\"line\">        └── greys-1.7.6.4-bin.zip</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>其中greys-core.jar为greys的程序主体，启动类、加载类都在这个jar包当中；<br>greys-agent.jar则为目标JVM的加载引导程序；<br>greys.sh为一个可执行脚本，为Greys的启动脚本。</p>\n</blockquote>\n<h3 id=\"greys常用功能\"><a href=\"#greys常用功能\" class=\"headerlink\" title=\"greys常用功能\"></a>greys常用功能</h3><p>启动脚本，</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat -H ./greys.sh  3292</span><br></pre></td></tr></table></figure>\n<p>为了安全考虑，一般会限制tomcat启动用户的权限，这里<code>-u</code>指定了<code>tomcat</code>启动的用户， <code>3292</code>是tomcat的进程id。<br>交互式shell，输入help即可看到所有支持的命令。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;help</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       sc | Search all the classes loaded by JVM                                             |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       sm | Search the method of classes loaded by JVM                                       |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|  monitor | Monitor the execution of specified Class and its method                          |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    watch | Display the details of specified class and method                                |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       tt | Time Tunnel                                                                      |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    trace | Display the detailed thread stack of specified class and method                  |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       js | Enhanced JavaScript                                                              |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|   ptrace | Display the detailed thread path stack of specified class and method             |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    stack | Display the stack trace of specified class and method                            |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|     quit | Quit Greys console                                                               |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|  session | Display current session information                                              |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|  version | Display Greys version                                                            |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|      jvm | Display the target JVM information                                               |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    reset | Reset all the enhanced classes                                                   |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|      asm | Display class bytecode by asm format                                             |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">| shutdown | Shut down Greys server and exit the console                                      |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|     help | Display Greys Help                                                               |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|      top | Display The Threads Of Top CPU TIME                                              |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>help后面可以跟具体的命令， 会显示命令的具体用法。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;help tt</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|   USAGE | -[tlDi:x:w:s:pdEn:] class-pattern method-pattern condition-express               |</span><br><span class=\"line\">|         | Time Tunnel                                                                      |</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">| OPTIONS |              [t] | Record the method invocation within time fragments            |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [l] | List all the time fragments                                   |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [D] | Delete all the time fragments                                 |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [i:] | Display the detailed information from specified time fragmen  |</span><br><span class=\"line\">|         |                  | t                                                             |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [x:] | Expand level of object (0 by default)                         |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [w:] | watch-express, watch the time fragment by OGNL express, like  |</span><br><span class=\"line\">|         |                  |  params[0], returnObj, throwExp and so on.                    |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | FOR EXAMPLE                                                   |</span><br><span class=\"line\">|         |                  |     params[0]                                                 |</span><br><span class=\"line\">|         |                  |     params[0]+params[1]                                       |</span><br><span class=\"line\">|         |                  |     returnObj                                                 |</span><br><span class=\"line\">|         |                  |     throwExp                                                  |</span><br><span class=\"line\">|         |                  |     target                                                    |</span><br><span class=\"line\">|         |                  |     clazz                                                     |</span><br><span class=\"line\">|         |                  |     method                                                    |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | THE STRUCTURE                                                 |</span><br><span class=\"line\">|         |                  |           target : the object                                 |</span><br><span class=\"line\">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class=\"line\">|         |                  |           method : the constructor or method                  |</span><br><span class=\"line\">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class=\"line\">|         |                  |        returnObj : the returned object of method              |</span><br><span class=\"line\">|         |                  |         throwExp : the throw exception of method              |</span><br><span class=\"line\">|         |                  |         isReturn : the method ended by return                 |</span><br><span class=\"line\">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [s:] | Search-expression, to search the time fragments by OGNL expr  |</span><br><span class=\"line\">|         |                  | ess                                                           |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | FOR EXAMPLE                                                   |</span><br><span class=\"line\">|         |                  |      TRUE : 1==1                                              |</span><br><span class=\"line\">|         |                  |      TRUE : true                                              |</span><br><span class=\"line\">|         |                  |     FALSE : false                                             |</span><br><span class=\"line\">|         |                  |      TRUE : params.length&gt;=0                                  |</span><br><span class=\"line\">|         |                  |     FALSE : 1==2                                              |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | THE STRUCTURE                                                 |</span><br><span class=\"line\">|         |                  |           target : the object                                 |</span><br><span class=\"line\">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class=\"line\">|         |                  |           method : the constructor or method                  |</span><br><span class=\"line\">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class=\"line\">|         |                  |        returnObj : the returned object of method              |</span><br><span class=\"line\">|         |                  |         throwExp : the throw exception of method              |</span><br><span class=\"line\">|         |                  |         isReturn : the method ended by return                 |</span><br><span class=\"line\">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class=\"line\">|         |                  |           #index : the index of time-fragment record          |</span><br><span class=\"line\">|         |                  |       #processId : the process ID of time-fragment record     |</span><br><span class=\"line\">|         |                  |            #cost : the cost time of time-fragment record      |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [p] | Replay the time fragment specified by index                   |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [d] | Delete time fragment specified by index                       |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [E] | Enable regular expression to match (wildcard matching by def  |</span><br><span class=\"line\">|         |                  | ault)                                                         |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [n:] | Threshold of execution times                                  |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |    class-pattern | Path and classname of Pattern Matching                        |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |   method-pattern | Method of Pattern Matching                                    |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |  condition-expre | Conditional expression by OGNL                                |</span><br><span class=\"line\">|         |               ss |                                                               |</span><br><span class=\"line\">|         |                  | FOR EXAMPLE                                                   |</span><br><span class=\"line\">|         |                  |      TRUE : 1==1                                              |</span><br><span class=\"line\">|         |                  |      TRUE : true                                              |</span><br><span class=\"line\">|         |                  |     FALSE : false                                             |</span><br><span class=\"line\">|         |                  |      TRUE : params.length&gt;=0                                  |</span><br><span class=\"line\">|         |                  |     FALSE : 1==2                                              |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | THE STRUCTURE                                                 |</span><br><span class=\"line\">|         |                  |           target : the object                                 |</span><br><span class=\"line\">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class=\"line\">|         |                  |           method : the constructor or method                  |</span><br><span class=\"line\">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class=\"line\">|         |                  |        returnObj : the returned object of method              |</span><br><span class=\"line\">|         |                  |         throwExp : the throw exception of method              |</span><br><span class=\"line\">|         |                  |         isReturn : the method ended by return                 |</span><br><span class=\"line\">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class=\"line\">|         |                  |            #cost : the cost(ms) of method                     |</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">| EXAMPLE | tt -t *StringUtils isTop                                                         |</span><br><span class=\"line\">|         | tt -t *StringUtils isTop params[0].length==1                                     |</span><br><span class=\"line\">|         | tt -l                                                                            |</span><br><span class=\"line\">|         | tt -D                                                                            |</span><br><span class=\"line\">|         | tt -i 1000 -w params[0]                                                          |</span><br><span class=\"line\">|         | tt -i 1000 -d                                                                    |</span><br><span class=\"line\">|         | tt -i 1000                                                                       |</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<h4 id=\"top\"><a href=\"#top\" class=\"headerlink\" title=\"top\"></a>top</h4><p>greys的shell里集成的top功能，可以显示jstack中每个线程的cpu占比。</p>\n<p>没有greys的时候的做法可能是，先查看native的线程的cpu占用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">top -p 3292 -H</span><br></pre></td></tr></table></figure>\n<p><code>-H</code>是显示到线程级别</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Tasks: 699 total,   0 running, 699 sleeping,   0 stopped,   0 zombie</span><br><span class=\"line\">Cpu(s):  8.0%us,  1.6%sy,  0.0%ni, 90.2%id,  0.0%wa,  0.0%hi,  0.2%si,  0.1%st</span><br><span class=\"line\">Mem:   8059648k total,  7801008k used,   258640k free,    33328k buffers</span><br><span class=\"line\">Swap:  4194296k total,        0k used,  4194296k free,  2453588k cached</span><br><span class=\"line\"></span><br><span class=\"line\">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            </span><br><span class=\"line\"> 5620 tomcat    20   0 9446m 4.2g 6696 S  6.6 54.2  33:46.86 java                                                                               </span><br><span class=\"line\"> 5764 tomcat    20   0 9446m 4.2g 6696 S  5.0 54.2   1:05.94 java                                                                               </span><br><span class=\"line\"> 5787 tomcat    20   0 9446m 4.2g 6696 S  4.0 54.2  57:48.76 java                                                                               </span><br><span class=\"line\"> 5790 tomcat    20   0 9446m 4.2g 6696 S  2.3 54.2  40:31.71 java                                                                               </span><br><span class=\"line\"> 3523 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  68:48.18 java                                                                               </span><br><span class=\"line\"> 3982 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  21:15.22 java                                                                               </span><br><span class=\"line\"> 3385 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  54:10.76 java                                                                               </span><br><span class=\"line\"> 3413 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  29:12.64 java</span><br></pre></td></tr></table></figure>\n<p>由于jstack的输出是16进制的线程号，我们需要根据<code>PID</code>进行转换</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">printf &quot;%x\\n&quot; 5620</span><br><span class=\"line\">15f4</span><br></pre></td></tr></table></figure>\n<p>然后<code>jstack</code>去查找相应的java线程栈</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;http-8080-38&quot; daemon prio=10 tid=0x00007fbcf006e000 nid=0x15f4 in Object.wait() [0x00007fbcd28a1000]</span><br><span class=\"line\">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class=\"line\">        at java.lang.Object.wait(Native Method)</span><br><span class=\"line\">        - waiting on &lt;0x000000077b69e488&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at java.lang.Object.wait(Object.java:503)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)</span><br><span class=\"line\">        - locked &lt;0x000000077b69e488&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>\n<p>费了一番功夫，黄花菜都凉了。</p>\n<p>也有将上面的步骤写成一个脚本的，快了许多。（驼厂内部散落着各种不同版本的slow_stack.sh）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The stack of busy(13.6%) thread(3613/0xe1d) of java pid(3292) all times():</span><br><span class=\"line\">&quot;http-8080-13&quot; daemon prio=10 tid=0x00007fbcf001b000 nid=0xe1d in Object.wait() [0x00007fbce7f7e000]</span><br><span class=\"line\">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class=\"line\">        at java.lang.Object.wait(Native Method)</span><br><span class=\"line\">        - waiting on &lt;0x0000000771e29738&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at java.lang.Object.wait(Object.java:503)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)</span><br><span class=\"line\">        - locked &lt;0x0000000771e29738&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>\n<p>开源的版本也有， <a href=\"https://github.com/superhj1987/awesome-scripts/blob/master/docs/java.md#beer-show-busy-java-threads\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">awesome-scripts/java.md at master · superhj1987/awesome-scripts</a></p>\n<p>greys中就可以直接使用top命令来查看，</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;top -t 3 -d</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| ID    |  CPU%  | USR%          | STATE                | THREAD_NAME                                                                           |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| #131  | 04.14% | TIMED_WAITING | CachedClock Updater  | at : sun.misc.Unsafe.park(Native Method)                                              |</span><br><span class=\"line\">|       |        |               | Thread               | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:349)           |</span><br><span class=\"line\">|       |        |               |                      | at : qunar.tc.common.clock.CachedClock$1.run(CachedClock.java:22)                     |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| #1282 | 03.51% | WAITING       | http-8080-176        | at : java.lang.Object.wait(Native Method)                                             |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Object.wait(Object.java:503)                                           |</span><br><span class=\"line\">|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)        |</span><br><span class=\"line\">|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)          |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| #38   | 03.26% | TIMED_WAITING | thread-monitor-task  | at : sun.misc.Unsafe.park(Native Method)                                              |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)           |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos |</span><br><span class=\"line\">|       |        |               |                      |      (AbstractQueuedSynchronizer.java:2082)                                           |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |</span><br><span class=\"line\">|       |        |               |                      |      ThreadPoolExecutor.java:1090)                                                    |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |</span><br><span class=\"line\">|       |        |               |                      |      ThreadPoolExecutor.java:807)                                                     |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)    |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)  |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)  |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>上面显示的就是top3占用cpu的线程</p>\n<h4 id=\"monitor-——-监控方法的执行时间\"><a href=\"#monitor-——-监控方法的执行时间\" class=\"headerlink\" title=\"monitor —— 监控方法的执行时间\"></a>monitor —— 监控方法的执行时间</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;monitor -c2 com.domain.Bean   someMethod   </span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 103 ms.</span><br><span class=\"line\">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br><span class=\"line\">| TIMESTAMP           | CLASS              | METHOD                     | TOTAL | SUCCESS | FAIL | FAIL-RATE | AVG-RT(ms) | MIN-RT(ms) | MAX-RT(ms) |</span><br><span class=\"line\">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br><span class=\"line\">| 2017-11-12 17:09:18 | com.domain.Bean    | someMethod                 | 4     | 4       | 0    | 00.00%    | 13.25      | 11         | 17         |</span><br><span class=\"line\">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br></pre></td></tr></table></figure>\n<h4 id=\"watch-——-全方位监控\"><a href=\"#watch-——-全方位监控\" class=\"headerlink\" title=\"watch —— 全方位监控\"></a>watch —— 全方位监控</h4><p>watch可以监控方法的返回值，入参，还可以根据条件筛选（是否抛出异常，响应时间等）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;watch com.domain.Bean onMessage params[0]</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 92 ms.</span><br><span class=\"line\">&#123;&quot;messageId&quot;:&quot;171112.171542.192.168.50.191.31779.22733&quot;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"tt（time-tunel）和ptrace\"><a href=\"#tt（time-tunel）和ptrace\" class=\"headerlink\" title=\"tt（time tunel）和ptrace\"></a>tt（time tunel）和ptrace</h4><p>先说ptrace， 这个和trace差不多， 只是可以加上<code>-t</code>将调用存储起来，可以配合<code>tt</code>使用<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;ptrace -t  -n 1 com.domain.Bean doSend</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:22) cost in 163 ms.</span><br><span class=\"line\">`---+pTracing for : thread_name=&quot;http-8080-179&quot; thread_id=0x505;is_daemon=true;priority=5;process=1002;</span><br><span class=\"line\">    `---[21,21ms]com.domain.Bean:doSend(); index=1001;</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure></p>\n<p><code>tt</code>:</p>\n<blockquote>\n<p>时间隧道命令是我在使用watch命令进行问题排查的时候衍生出来的想法。<br>watch虽然很方便和灵活，但需要提前想清楚观察表达式的拼写，这对排查问题而言要求太高，因为很多时候我们并不清楚问题出自于何方，只能靠蛛丝马迹进行猜测.<br>这个时候如果能记录下当时方法调用的所有入参和返回值、抛出的异常会对整个问题的思考与判断非常有帮助。<br>于是乎，TimeTunnel命令就诞生了。</p>\n</blockquote>\n<p>列出所有时间片段或显示一个时间片段的内容:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tt -l</span><br><span class=\"line\">tt -i 1001</span><br></pre></td></tr></table></figure>\n<p>内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;tt -l</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">ga?&gt;tt -i 1001</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           INDEX | 1001                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      PROCESS-ID | 1002                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      GMT-CREATE | 2017-11-12 17:30:40                                                                                                                                    |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|        COST(ms) | 20                                                                                                                                                     |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          OBJECT | 0x55e9f734                                                                                                                                             |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           CLASS | com.domain.Bean                                                                                 |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          METHOD | doSend                                                                                                                                                 |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|       IS-RETURN | true                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|    IS-EXCEPTION | false                                                                                                                                                  |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[0] | 242996952                                                                                                                                              |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[1] | [CouponBase[id=1,amount=5]                                                                                |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[2] | VoucherSendTask[appName=catalysis,batchSeriesNum=catalysis-train_give_zhoubian-HOURROOM_NEWUSER-HOURROOM,transactionId=catalysis24299695225174650HOURR] |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      RETURN-OBJ | InventoryRecord[activityId=31,transactionId=catalysis24299695225174650HOURROOM242996952]                                                                |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           STACK | thread_name=&quot;http-8080-179&quot; thread_id=0x505;is_daemon=true;priority=5;                                                                                 |</span><br><span class=\"line\">|                 |     @com.qunar.hotel.qta.open.promotion.service.impl.Bean.doSend(Bean.java:179)                                    |</span><br><span class=\"line\">|                 |         at com.qunar.hotel.qta.open.promotion.service.impl.Bean.sendVoucherThenGetCouponId(Bean.java:191)          |</span><br><span class=\"line\">|                 |         at com.qunar.hotel.qta.open.promotion.provider.controller.benefit.UserBenefitController.voucherSendThenGetCouponId(UserBenefitController.java: |</span><br><span class=\"line\">|                 | 841)                                                                                                                                                   |</span><br><span class=\"line\">|                 |         at sun.reflect.GeneratedMethodAccessor1923.invoke(null:-1)                                                                                     |</span><br><span class=\"line\">|                 |         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                       |</span><br><span class=\"line\">|                 |         at java.lang.reflect.Method.invoke(Method.java:606)                                                                                            |</span><br><span class=\"line\">|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:214)                                       |</span><br><span class=\"line\">|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:132)                             |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:104) |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandleMethod(RequestMappingHandlerAdapter.java:748 |</span><br><span class=\"line\">|                 | )                                                                                                                                                      |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:689)    |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:83)                        |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:945)                                                    |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:876)                                                     |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:931)                                                  |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:833)                                                          |</span><br><span class=\"line\">|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:637)                                                                                |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:807)                                                         |</span><br><span class=\"line\">|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)                                                                                |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at com.alibaba.druid.support.http.WebStatFilter.doFilter(WebStatFilter.java:140)                                                               |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at com.qunar.hotel.qta.base.trace.HttpTraceFilter.doFilter(HttpTraceFilter.java:44)                                                            |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at qunar.ServletWatcher.doFilter(ServletWatcher.java:118)                                                                                      |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)                                    |</span><br><span class=\"line\">|                 |         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:108)                                                 |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)                                                         |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)                                                         |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)                                                               |</span><br><span class=\"line\">|                 |         at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)                                                               |</span><br><span class=\"line\">|                 |         at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555)                                                                   |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)                                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)                                                                 |</span><br><span class=\"line\">|                 |         at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857)                                                                  |</span><br><span class=\"line\">|                 |         at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)                                            |</span><br><span class=\"line\">|                 |         at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)                                                                     |</span><br><span class=\"line\">|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>除了使用<code>ptrace</code>保存时间片段，也可以使用<code>tt</code>，</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;tt -t  -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 110 ms.</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |         Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>\n<p><em>同样的最好指定-n，避免高并发下造成太大影响</em></p>\n<p>解决方法重载</p>\n<p>tt -t *Test print params[0].length==1</p>\n<p>通过制定参数个数的形式解决不同的方法签名，如果参数个数一样，你还可以这样写</p>\n<p>tt -t *Test print ‘params[1].class == Integer.class’</p>\n<p>解决指定参数</p>\n<p>tt -t *Test print params[0].mobile==”13989838402”</p>\n<p>具体的可以参见参考文档里的说明。</p>\n<ul>\n<li><code>tt</code>的另外一个便利之处是可以对保存的时间片主动发起一次调用</li>\n</ul>\n<p>和dubbo的泛化调用一样，<code>tt</code>的这个方法也可以大大降低沟通的成本。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;ptrace -t  -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage </span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:2) cost in 126 ms.</span><br><span class=\"line\">`---+pTracing for : thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-2&quot; thread_id=0x205;is_daemon=true;priority=5;process=1005;</span><br><span class=\"line\">    `---[1,1ms]com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener:onMessage(); index=1004;</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |</span><br><span class=\"line\">|          |            |                      |            |          |          |                 |                             er |                                |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">ga?&gt;tt -i 1004 -p</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           INDEX | 1004                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      PROCESS-ID | 1005                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      GMT-CREATE | 2017-11-12 17:43:15                                                                                                                                    |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|        COST(ms) | 1                                                                                                                                                      |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          OBJECT | 0x14b7937c                                                                                                                                             |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           CLASS | com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener                                                                      |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          METHOD | onMessage                                                                                                                                              |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|       IS-RETURN | true                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|    IS-EXCEPTION | false                                                                                                                                                  |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[0] | &#123;&quot;messageId&quot;:&quot;171112.174315.192.168.50.191.31779.22906&quot;&#125;                                                                                               |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      RETURN-OBJ |                                                                                                                                                        |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           STACK | thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-2&quot; thread_id=0x205;is_daemon=tr |</span><br><span class=\"line\">|                 | ue;priority=5;                                                                                                                                         |</span><br><span class=\"line\">|                 |     @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:45)             |</span><br><span class=\"line\">|                 |         at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)                                                             |</span><br><span class=\"line\">|                 |         at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)                                                                  |</span><br><span class=\"line\">|                 |         at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)                                                                     |</span><br><span class=\"line\">|                 |         at java.util.concurrent.FutureTask.run(FutureTask.java:262)                                                                                    |</span><br><span class=\"line\">|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)                                                             |</span><br><span class=\"line\">|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)                                                             |</span><br><span class=\"line\">|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">Time fragment[1004] successfully replayed.</span><br></pre></td></tr></table></figure>\n<h4 id=\"trace\"><a href=\"#trace\" class=\"headerlink\" title=\"trace\"></a>trace</h4><p>显示指定方法调用的栈，带时间消耗。简单的可以看下调用链上的耗时，进一步的话就需要更加专业的<code>JProfiler</code>等工具了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;trace -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 102 ms.</span><br><span class=\"line\">`---+Tracing for : thread_name=&quot;http-8080-181&quot; thread_id=0x507;is_daemon=true;priority=5;</span><br><span class=\"line\">    `---+[13,13ms]com.qunar.hotel.qta.open.promotion.service.impl.Bean:doSend()</span><br><span class=\"line\">        +---[0,0ms]com.qunar.hotel.qta.coupon.api.bean.CouponUser:&lt;init&gt;(@175)</span><br><span class=\"line\">        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getVoucherTypeId(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:&lt;init&gt;(@176)</span><br><span class=\"line\">        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getTransactionId(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:append(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:append(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:toString(@176)</span><br><span class=\"line\">        +---[12,12ms]com.qunar.hotel.qta.coupon.api.remote.ActivityWriteRemote:consume(@176)</span><br><span class=\"line\">        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getAppName(@177)</span><br><span class=\"line\">        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getBatchSeriesNum(@177)</span><br><span class=\"line\">        +---[12,0ms]java.lang.Long:valueOf(@177)</span><br><span class=\"line\">        +---[12,0ms]java.util.List:size(@177)</span><br><span class=\"line\">        +---[13,0ms]java.lang.Integer:valueOf(@177)</span><br><span class=\"line\">        `---[13,0ms]org.slf4j.Logger:info(@177)</span><br></pre></td></tr></table></figure>\n<p>最好也指定下<code>-n</code></p>\n<h4 id=\"stack\"><a href=\"#stack\" class=\"headerlink\" title=\"stack\"></a>stack</h4><p>stack可以产品指定方法调用的stack， 支持正则， 也支持各种条件表达式，具体可以<code>help stack</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;stack -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage </span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 111 ms.</span><br><span class=\"line\">thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-6&quot; thread_id=0x20e;is_daemon=true;priority=5;</span><br><span class=\"line\">    @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:-1)</span><br><span class=\"line\">        at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)</span><br><span class=\"line\">        at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)</span><br><span class=\"line\">        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)</span><br><span class=\"line\">        at java.util.concurrent.FutureTask.run(FutureTask.java:262)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>\n<p><em>注意最好指定下-n参数，以免对线上系统造成较大的压力</em></p>\n<h4 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h4><p>还有一些其他的用法，比如支持使用js编写自定义的脚本， 查看jvm的信息， 查看加载的类等等。</p>\n<h3 id=\"安全性\"><a href=\"#安全性\" class=\"headerlink\" title=\"安全性\"></a>安全性</h3><blockquote>\n<p>（1） 哪些命令会导致性能问题</p>\n</blockquote>\n<p>Greys的大部分命令性能开销都非常低廉，当然前提是一次性操作的类不要太多。</p>\n<blockquote>\n<p>（2） 是否能增强由BootstrapClassLoader所加载的类</p>\n</blockquote>\n<p>当然是可以的，但默认我封印了这个能力。主要是Greys自己也使用了大量BootstrapClassLoader所加载的类，如果处理不好极其容易造成故障。</p>\n<p>你可以通过隐藏命令options激活这个功能</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;options unsafe true</span><br><span class=\"line\">+--------+--------------+-------------+</span><br><span class=\"line\">| NAME   | BEFORE-VALUE | AFTER-VALUE |</span><br><span class=\"line\">+--------+--------------+-------------+</span><br><span class=\"line\">| unsafe | false        | true        |</span><br><span class=\"line\">+--------+--------------+-------------+</span><br><span class=\"line\">Affect(row-cnt:1) cost in 2 ms.</span><br></pre></td></tr></table></figure>\n<p>接下来你可以尝试增强系统类了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;monitor -c 5 java.lang.String substring</span><br><span class=\"line\">Press Ctrl+D or Ctrl+X to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:2) cost in 35 ms.</span><br><span class=\"line\">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br><span class=\"line\">| timestamp           | class            | method    | total | success | fail | rt   | fail-rate |</span><br><span class=\"line\">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br><span class=\"line\">| 2015-06-16 23:44:54 | java.lang.String | substring | 30    | 30      | 0    | 0.23 | 0.00%     |</span><br><span class=\"line\">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br></pre></td></tr></table></figure>\n<p>但我话就放在这里，随意增强系统类。后果自负！</p>\n<h3 id=\"greys-退出\"><a href=\"#greys-退出\" class=\"headerlink\" title=\"greys 退出\"></a>greys 退出</h3><p>greys的数据是保存在内存中的， 有些记录的栈桢需要清理，因此推荐使用<code>shutdown</code>方法</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;tt -l</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |</span><br><span class=\"line\">|          |            |                      |            |          |          |                 |                             er |                                |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>\n<p>这些时间片默认是保存的，所以退出的时候需要清理下，不然对应用的gc都会有影响。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;shutdown</span><br><span class=\"line\">Greys Server is shut down.</span><br></pre></td></tr></table></figure>\n<p>greys 还提供了一个<code>reset</code>的命令，可以还原所有被增强过的类。</p>\n<blockquote>\n<p>  reset : Reset all the enhanced classes</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">greys pdf · oldmanpushcart/greys-anatomy Wiki</a></p>\n</li>\n<li><p><a href=\"http://www.bijishequ.com/detail/435931?p=29-55\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Grays Anatomy源码浅析–ClassLoader,Java,Method,DES,null,方法,INVOKING</a></p>\n</li>\n<li><p><a href=\"https://github.com/oldmanpushcart/greys-anatomy/wiki/FAQ\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">FAQ · oldmanpushcart/greys-anatomy Wiki</a></p>\n</li>\n<li><p><a href=\"http://hongkaiwen.github.io/2017/07/22/java-%E7%BA%BF%E4%B8%8A%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7-greys-anatomy-%E5%AE%9E%E8%B7%B5%E5%88%9D%E6%8E%A2/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java 线上调试工具 greys-anatomy 实践初探 | Kuzan</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/btrace1.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Btrace入门到熟练小工完全指南 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651478959&amp;idx=2&amp;sn=25bac2f47851c436f27c679e77e892ae&amp;chksm=bd2537d08a52bec6d5987b98e885d5b466569a7ba621a5e93297a5490ebd2ea75a04c7b51d47&amp;mpshare=1&amp;scene=1&amp;srcid=09056wNl5ibsbHVZNqBGAT8w#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">线上服务 CPU 100%？一键定位 so easy！</a></p>\n</li>\n<li><p><a href=\"https://github.com/CSUG/HouseMD/wiki/UserGuideCN\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">UserGuideCN · CSUG/HouseMD Wiki</a></p>\n</li>\n<li><p><a href=\"https://github.com/superhj1987/awesome-scripts\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">superhj1987/awesome-scripts: useful scripts for Linux op</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"greys\"><a href=\"#greys\" class=\"headerlink\" title=\"greys\"></a>greys</h2><p>greys的理念是将btrace常用的功能命令化，这样可以大大的节省排查问题的时间。</p>\n<h3 id=\"greys-安装\"><a href=\"#greys-安装\" class=\"headerlink\" title=\"greys 安装\"></a>greys 安装</h3><p>推荐使用网络安装:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh|bash</span><br></pre></td></tr></table></figure>\n<p>安装后家目录下有如下的文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/home/qishengli/.greys</span><br><span class=\"line\">└── lib</span><br><span class=\"line\">    └── 1.7.6.4</span><br><span class=\"line\">        ├── greys</span><br><span class=\"line\">        │   ├── ga.sh</span><br><span class=\"line\">        │   ├── greys-agent.jar</span><br><span class=\"line\">        │   ├── greys-core.jar</span><br><span class=\"line\">        │   ├── greys.sh</span><br><span class=\"line\">        │   ├── gs.sh</span><br><span class=\"line\">        │   └── install-local.sh</span><br><span class=\"line\">        └── greys-1.7.6.4-bin.zip</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>其中greys-core.jar为greys的程序主体，启动类、加载类都在这个jar包当中；<br>greys-agent.jar则为目标JVM的加载引导程序；<br>greys.sh为一个可执行脚本，为Greys的启动脚本。</p>\n</blockquote>\n<h3 id=\"greys常用功能\"><a href=\"#greys常用功能\" class=\"headerlink\" title=\"greys常用功能\"></a>greys常用功能</h3><p>启动脚本，</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat -H ./greys.sh  3292</span><br></pre></td></tr></table></figure>\n<p>为了安全考虑，一般会限制tomcat启动用户的权限，这里<code>-u</code>指定了<code>tomcat</code>启动的用户， <code>3292</code>是tomcat的进程id。<br>交互式shell，输入help即可看到所有支持的命令。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;help</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       sc | Search all the classes loaded by JVM                                             |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       sm | Search the method of classes loaded by JVM                                       |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|  monitor | Monitor the execution of specified Class and its method                          |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    watch | Display the details of specified class and method                                |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       tt | Time Tunnel                                                                      |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    trace | Display the detailed thread stack of specified class and method                  |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|       js | Enhanced JavaScript                                                              |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|   ptrace | Display the detailed thread path stack of specified class and method             |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    stack | Display the stack trace of specified class and method                            |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|     quit | Quit Greys console                                                               |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|  session | Display current session information                                              |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|  version | Display Greys version                                                            |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|      jvm | Display the target JVM information                                               |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|    reset | Reset all the enhanced classes                                                   |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|      asm | Display class bytecode by asm format                                             |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">| shutdown | Shut down Greys server and exit the console                                      |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|     help | Display Greys Help                                                               |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|      top | Display The Threads Of Top CPU TIME                                              |</span><br><span class=\"line\">+----------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>help后面可以跟具体的命令， 会显示命令的具体用法。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;help tt</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">|   USAGE | -[tlDi:x:w:s:pdEn:] class-pattern method-pattern condition-express               |</span><br><span class=\"line\">|         | Time Tunnel                                                                      |</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">| OPTIONS |              [t] | Record the method invocation within time fragments            |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [l] | List all the time fragments                                   |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [D] | Delete all the time fragments                                 |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [i:] | Display the detailed information from specified time fragmen  |</span><br><span class=\"line\">|         |                  | t                                                             |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [x:] | Expand level of object (0 by default)                         |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [w:] | watch-express, watch the time fragment by OGNL express, like  |</span><br><span class=\"line\">|         |                  |  params[0], returnObj, throwExp and so on.                    |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | FOR EXAMPLE                                                   |</span><br><span class=\"line\">|         |                  |     params[0]                                                 |</span><br><span class=\"line\">|         |                  |     params[0]+params[1]                                       |</span><br><span class=\"line\">|         |                  |     returnObj                                                 |</span><br><span class=\"line\">|         |                  |     throwExp                                                  |</span><br><span class=\"line\">|         |                  |     target                                                    |</span><br><span class=\"line\">|         |                  |     clazz                                                     |</span><br><span class=\"line\">|         |                  |     method                                                    |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | THE STRUCTURE                                                 |</span><br><span class=\"line\">|         |                  |           target : the object                                 |</span><br><span class=\"line\">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class=\"line\">|         |                  |           method : the constructor or method                  |</span><br><span class=\"line\">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class=\"line\">|         |                  |        returnObj : the returned object of method              |</span><br><span class=\"line\">|         |                  |         throwExp : the throw exception of method              |</span><br><span class=\"line\">|         |                  |         isReturn : the method ended by return                 |</span><br><span class=\"line\">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [s:] | Search-expression, to search the time fragments by OGNL expr  |</span><br><span class=\"line\">|         |                  | ess                                                           |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | FOR EXAMPLE                                                   |</span><br><span class=\"line\">|         |                  |      TRUE : 1==1                                              |</span><br><span class=\"line\">|         |                  |      TRUE : true                                              |</span><br><span class=\"line\">|         |                  |     FALSE : false                                             |</span><br><span class=\"line\">|         |                  |      TRUE : params.length&gt;=0                                  |</span><br><span class=\"line\">|         |                  |     FALSE : 1==2                                              |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | THE STRUCTURE                                                 |</span><br><span class=\"line\">|         |                  |           target : the object                                 |</span><br><span class=\"line\">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class=\"line\">|         |                  |           method : the constructor or method                  |</span><br><span class=\"line\">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class=\"line\">|         |                  |        returnObj : the returned object of method              |</span><br><span class=\"line\">|         |                  |         throwExp : the throw exception of method              |</span><br><span class=\"line\">|         |                  |         isReturn : the method ended by return                 |</span><br><span class=\"line\">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class=\"line\">|         |                  |           #index : the index of time-fragment record          |</span><br><span class=\"line\">|         |                  |       #processId : the process ID of time-fragment record     |</span><br><span class=\"line\">|         |                  |            #cost : the cost time of time-fragment record      |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [p] | Replay the time fragment specified by index                   |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [d] | Delete time fragment specified by index                       |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |              [E] | Enable regular expression to match (wildcard matching by def  |</span><br><span class=\"line\">|         |                  | ault)                                                         |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |             [n:] | Threshold of execution times                                  |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |    class-pattern | Path and classname of Pattern Matching                        |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |   method-pattern | Method of Pattern Matching                                    |</span><br><span class=\"line\">|         | -----------------+-------------------------------------------------------------- |</span><br><span class=\"line\">|         |  condition-expre | Conditional expression by OGNL                                |</span><br><span class=\"line\">|         |               ss |                                                               |</span><br><span class=\"line\">|         |                  | FOR EXAMPLE                                                   |</span><br><span class=\"line\">|         |                  |      TRUE : 1==1                                              |</span><br><span class=\"line\">|         |                  |      TRUE : true                                              |</span><br><span class=\"line\">|         |                  |     FALSE : false                                             |</span><br><span class=\"line\">|         |                  |      TRUE : params.length&gt;=0                                  |</span><br><span class=\"line\">|         |                  |     FALSE : 1==2                                              |</span><br><span class=\"line\">|         |                  |                                                               |</span><br><span class=\"line\">|         |                  | THE STRUCTURE                                                 |</span><br><span class=\"line\">|         |                  |           target : the object                                 |</span><br><span class=\"line\">|         |                  |            clazz : the object&apos;s class                         |</span><br><span class=\"line\">|         |                  |           method : the constructor or method                  |</span><br><span class=\"line\">|         |                  |     params[0..n] : the parameters of method                   |</span><br><span class=\"line\">|         |                  |        returnObj : the returned object of method              |</span><br><span class=\"line\">|         |                  |         throwExp : the throw exception of method              |</span><br><span class=\"line\">|         |                  |         isReturn : the method ended by return                 |</span><br><span class=\"line\">|         |                  |          isThrow : the method ended by throwing exception     |</span><br><span class=\"line\">|         |                  |            #cost : the cost(ms) of method                     |</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br><span class=\"line\">| EXAMPLE | tt -t *StringUtils isTop                                                         |</span><br><span class=\"line\">|         | tt -t *StringUtils isTop params[0].length==1                                     |</span><br><span class=\"line\">|         | tt -l                                                                            |</span><br><span class=\"line\">|         | tt -D                                                                            |</span><br><span class=\"line\">|         | tt -i 1000 -w params[0]                                                          |</span><br><span class=\"line\">|         | tt -i 1000 -d                                                                    |</span><br><span class=\"line\">|         | tt -i 1000                                                                       |</span><br><span class=\"line\">+---------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<h4 id=\"top\"><a href=\"#top\" class=\"headerlink\" title=\"top\"></a>top</h4><p>greys的shell里集成的top功能，可以显示jstack中每个线程的cpu占比。</p>\n<p>没有greys的时候的做法可能是，先查看native的线程的cpu占用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">top -p 3292 -H</span><br></pre></td></tr></table></figure>\n<p><code>-H</code>是显示到线程级别</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Tasks: 699 total,   0 running, 699 sleeping,   0 stopped,   0 zombie</span><br><span class=\"line\">Cpu(s):  8.0%us,  1.6%sy,  0.0%ni, 90.2%id,  0.0%wa,  0.0%hi,  0.2%si,  0.1%st</span><br><span class=\"line\">Mem:   8059648k total,  7801008k used,   258640k free,    33328k buffers</span><br><span class=\"line\">Swap:  4194296k total,        0k used,  4194296k free,  2453588k cached</span><br><span class=\"line\"></span><br><span class=\"line\">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            </span><br><span class=\"line\"> 5620 tomcat    20   0 9446m 4.2g 6696 S  6.6 54.2  33:46.86 java                                                                               </span><br><span class=\"line\"> 5764 tomcat    20   0 9446m 4.2g 6696 S  5.0 54.2   1:05.94 java                                                                               </span><br><span class=\"line\"> 5787 tomcat    20   0 9446m 4.2g 6696 S  4.0 54.2  57:48.76 java                                                                               </span><br><span class=\"line\"> 5790 tomcat    20   0 9446m 4.2g 6696 S  2.3 54.2  40:31.71 java                                                                               </span><br><span class=\"line\"> 3523 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  68:48.18 java                                                                               </span><br><span class=\"line\"> 3982 tomcat    20   0 9446m 4.2g 6696 S  1.3 54.2  21:15.22 java                                                                               </span><br><span class=\"line\"> 3385 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  54:10.76 java                                                                               </span><br><span class=\"line\"> 3413 tomcat    20   0 9446m 4.2g 6696 S  1.0 54.2  29:12.64 java</span><br></pre></td></tr></table></figure>\n<p>由于jstack的输出是16进制的线程号，我们需要根据<code>PID</code>进行转换</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">printf &quot;%x\\n&quot; 5620</span><br><span class=\"line\">15f4</span><br></pre></td></tr></table></figure>\n<p>然后<code>jstack</code>去查找相应的java线程栈</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;http-8080-38&quot; daemon prio=10 tid=0x00007fbcf006e000 nid=0x15f4 in Object.wait() [0x00007fbcd28a1000]</span><br><span class=\"line\">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class=\"line\">        at java.lang.Object.wait(Native Method)</span><br><span class=\"line\">        - waiting on &lt;0x000000077b69e488&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at java.lang.Object.wait(Object.java:503)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)</span><br><span class=\"line\">        - locked &lt;0x000000077b69e488&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>\n<p>费了一番功夫，黄花菜都凉了。</p>\n<p>也有将上面的步骤写成一个脚本的，快了许多。（驼厂内部散落着各种不同版本的slow_stack.sh）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The stack of busy(13.6%) thread(3613/0xe1d) of java pid(3292) all times():</span><br><span class=\"line\">&quot;http-8080-13&quot; daemon prio=10 tid=0x00007fbcf001b000 nid=0xe1d in Object.wait() [0x00007fbce7f7e000]</span><br><span class=\"line\">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class=\"line\">        at java.lang.Object.wait(Native Method)</span><br><span class=\"line\">        - waiting on &lt;0x0000000771e29738&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at java.lang.Object.wait(Object.java:503)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)</span><br><span class=\"line\">        - locked &lt;0x0000000771e29738&gt; (a org.apache.tomcat.util.net.JIoEndpoint$Worker)</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>\n<p>开源的版本也有， <a href=\"https://github.com/superhj1987/awesome-scripts/blob/master/docs/java.md#beer-show-busy-java-threads\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">awesome-scripts/java.md at master · superhj1987/awesome-scripts</a></p>\n<p>greys中就可以直接使用top命令来查看，</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;top -t 3 -d</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| ID    |  CPU%  | USR%          | STATE                | THREAD_NAME                                                                           |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| #131  | 04.14% | TIMED_WAITING | CachedClock Updater  | at : sun.misc.Unsafe.park(Native Method)                                              |</span><br><span class=\"line\">|       |        |               | Thread               | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:349)           |</span><br><span class=\"line\">|       |        |               |                      | at : qunar.tc.common.clock.CachedClock$1.run(CachedClock.java:22)                     |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| #1282 | 03.51% | WAITING       | http-8080-176        | at : java.lang.Object.wait(Native Method)                                             |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Object.wait(Object.java:503)                                           |</span><br><span class=\"line\">|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:458)        |</span><br><span class=\"line\">|       |        |               |                      | at : org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:484)          |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br><span class=\"line\">| #38   | 03.26% | TIMED_WAITING | thread-monitor-task  | at : sun.misc.Unsafe.park(Native Method)                                              |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)           |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos |</span><br><span class=\"line\">|       |        |               |                      |      (AbstractQueuedSynchronizer.java:2082)                                           |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |</span><br><span class=\"line\">|       |        |               |                      |      ThreadPoolExecutor.java:1090)                                                    |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(Scheduled |</span><br><span class=\"line\">|       |        |               |                      |      ThreadPoolExecutor.java:807)                                                     |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)    |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)  |</span><br><span class=\"line\">|       |        |               |                      | at : java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)  |</span><br><span class=\"line\">|       |        |               |                      | at : java.lang.Thread.run(Thread.java:744)                                            |</span><br><span class=\"line\">+-------+--------+---------------+----------------------+---------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>上面显示的就是top3占用cpu的线程</p>\n<h4 id=\"monitor-——-监控方法的执行时间\"><a href=\"#monitor-——-监控方法的执行时间\" class=\"headerlink\" title=\"monitor —— 监控方法的执行时间\"></a>monitor —— 监控方法的执行时间</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;monitor -c2 com.domain.Bean   someMethod   </span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 103 ms.</span><br><span class=\"line\">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br><span class=\"line\">| TIMESTAMP           | CLASS              | METHOD                     | TOTAL | SUCCESS | FAIL | FAIL-RATE | AVG-RT(ms) | MIN-RT(ms) | MAX-RT(ms) |</span><br><span class=\"line\">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br><span class=\"line\">| 2017-11-12 17:09:18 | com.domain.Bean    | someMethod                 | 4     | 4       | 0    | 00.00%    | 13.25      | 11         | 17         |</span><br><span class=\"line\">+---------------------+--------------------+----------------------------+-------+---------+------+-----------+------------+------------+------------+</span><br></pre></td></tr></table></figure>\n<h4 id=\"watch-——-全方位监控\"><a href=\"#watch-——-全方位监控\" class=\"headerlink\" title=\"watch —— 全方位监控\"></a>watch —— 全方位监控</h4><p>watch可以监控方法的返回值，入参，还可以根据条件筛选（是否抛出异常，响应时间等）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;watch com.domain.Bean onMessage params[0]</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 92 ms.</span><br><span class=\"line\">&#123;&quot;messageId&quot;:&quot;171112.171542.192.168.50.191.31779.22733&quot;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"tt（time-tunel）和ptrace\"><a href=\"#tt（time-tunel）和ptrace\" class=\"headerlink\" title=\"tt（time tunel）和ptrace\"></a>tt（time tunel）和ptrace</h4><p>先说ptrace， 这个和trace差不多， 只是可以加上<code>-t</code>将调用存储起来，可以配合<code>tt</code>使用<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;ptrace -t  -n 1 com.domain.Bean doSend</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:22) cost in 163 ms.</span><br><span class=\"line\">`---+pTracing for : thread_name=&quot;http-8080-179&quot; thread_id=0x505;is_daemon=true;priority=5;process=1002;</span><br><span class=\"line\">    `---[21,21ms]com.domain.Bean:doSend(); index=1001;</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure></p>\n<p><code>tt</code>:</p>\n<blockquote>\n<p>时间隧道命令是我在使用watch命令进行问题排查的时候衍生出来的想法。<br>watch虽然很方便和灵活，但需要提前想清楚观察表达式的拼写，这对排查问题而言要求太高，因为很多时候我们并不清楚问题出自于何方，只能靠蛛丝马迹进行猜测.<br>这个时候如果能记录下当时方法调用的所有入参和返回值、抛出的异常会对整个问题的思考与判断非常有帮助。<br>于是乎，TimeTunnel命令就诞生了。</p>\n</blockquote>\n<p>列出所有时间片段或显示一个时间片段的内容:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tt -l</span><br><span class=\"line\">tt -i 1001</span><br></pre></td></tr></table></figure>\n<p>内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;tt -l</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">ga?&gt;tt -i 1001</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           INDEX | 1001                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      PROCESS-ID | 1002                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      GMT-CREATE | 2017-11-12 17:30:40                                                                                                                                    |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|        COST(ms) | 20                                                                                                                                                     |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          OBJECT | 0x55e9f734                                                                                                                                             |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           CLASS | com.domain.Bean                                                                                 |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          METHOD | doSend                                                                                                                                                 |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|       IS-RETURN | true                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|    IS-EXCEPTION | false                                                                                                                                                  |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[0] | 242996952                                                                                                                                              |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[1] | [CouponBase[id=1,amount=5]                                                                                |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[2] | VoucherSendTask[appName=catalysis,batchSeriesNum=catalysis-train_give_zhoubian-HOURROOM_NEWUSER-HOURROOM,transactionId=catalysis24299695225174650HOURR] |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      RETURN-OBJ | InventoryRecord[activityId=31,transactionId=catalysis24299695225174650HOURROOM242996952]                                                                |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           STACK | thread_name=&quot;http-8080-179&quot; thread_id=0x505;is_daemon=true;priority=5;                                                                                 |</span><br><span class=\"line\">|                 |     @com.qunar.hotel.qta.open.promotion.service.impl.Bean.doSend(Bean.java:179)                                    |</span><br><span class=\"line\">|                 |         at com.qunar.hotel.qta.open.promotion.service.impl.Bean.sendVoucherThenGetCouponId(Bean.java:191)          |</span><br><span class=\"line\">|                 |         at com.qunar.hotel.qta.open.promotion.provider.controller.benefit.UserBenefitController.voucherSendThenGetCouponId(UserBenefitController.java: |</span><br><span class=\"line\">|                 | 841)                                                                                                                                                   |</span><br><span class=\"line\">|                 |         at sun.reflect.GeneratedMethodAccessor1923.invoke(null:-1)                                                                                     |</span><br><span class=\"line\">|                 |         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                       |</span><br><span class=\"line\">|                 |         at java.lang.reflect.Method.invoke(Method.java:606)                                                                                            |</span><br><span class=\"line\">|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:214)                                       |</span><br><span class=\"line\">|                 |         at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:132)                             |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:104) |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandleMethod(RequestMappingHandlerAdapter.java:748 |</span><br><span class=\"line\">|                 | )                                                                                                                                                      |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:689)    |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:83)                        |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:945)                                                    |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:876)                                                     |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:931)                                                  |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:833)                                                          |</span><br><span class=\"line\">|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:637)                                                                                |</span><br><span class=\"line\">|                 |         at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:807)                                                         |</span><br><span class=\"line\">|                 |         at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)                                                                                |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at com.alibaba.druid.support.http.WebStatFilter.doFilter(WebStatFilter.java:140)                                                               |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at com.qunar.hotel.qta.base.trace.HttpTraceFilter.doFilter(HttpTraceFilter.java:44)                                                            |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at qunar.ServletWatcher.doFilter(ServletWatcher.java:118)                                                                                      |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)                                    |</span><br><span class=\"line\">|                 |         at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:108)                                                 |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)                                                   |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)                                                         |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)                                                         |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)                                                               |</span><br><span class=\"line\">|                 |         at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)                                                               |</span><br><span class=\"line\">|                 |         at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555)                                                                   |</span><br><span class=\"line\">|                 |         at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)                                                           |</span><br><span class=\"line\">|                 |         at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)                                                                 |</span><br><span class=\"line\">|                 |         at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857)                                                                  |</span><br><span class=\"line\">|                 |         at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)                                            |</span><br><span class=\"line\">|                 |         at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)                                                                     |</span><br><span class=\"line\">|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>除了使用<code>ptrace</code>保存时间片段，也可以使用<code>tt</code>，</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;tt -t  -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 110 ms.</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |         Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>\n<p><em>同样的最好指定-n，避免高并发下造成太大影响</em></p>\n<p>解决方法重载</p>\n<p>tt -t *Test print params[0].length==1</p>\n<p>通过制定参数个数的形式解决不同的方法签名，如果参数个数一样，你还可以这样写</p>\n<p>tt -t *Test print ‘params[1].class == Integer.class’</p>\n<p>解决指定参数</p>\n<p>tt -t *Test print params[0].mobile==”13989838402”</p>\n<p>具体的可以参见参考文档里的说明。</p>\n<ul>\n<li><code>tt</code>的另外一个便利之处是可以对保存的时间片主动发起一次调用</li>\n</ul>\n<p>和dubbo的泛化调用一样，<code>tt</code>的这个方法也可以大大降低沟通的成本。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;ptrace -t  -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage </span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:2) cost in 126 ms.</span><br><span class=\"line\">`---+pTracing for : thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-2&quot; thread_id=0x205;is_daemon=true;priority=5;process=1005;</span><br><span class=\"line\">    `---[1,1ms]com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener:onMessage(); index=1004;</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |</span><br><span class=\"line\">|          |            |                      |            |          |          |                 |                             er |                                |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">ga?&gt;tt -i 1004 -p</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           INDEX | 1004                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      PROCESS-ID | 1005                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      GMT-CREATE | 2017-11-12 17:43:15                                                                                                                                    |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|        COST(ms) | 1                                                                                                                                                      |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          OBJECT | 0x14b7937c                                                                                                                                             |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           CLASS | com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener                                                                      |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|          METHOD | onMessage                                                                                                                                              |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|       IS-RETURN | true                                                                                                                                                   |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|    IS-EXCEPTION | false                                                                                                                                                  |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|   PARAMETERS[0] | &#123;&quot;messageId&quot;:&quot;171112.174315.192.168.50.191.31779.22906&quot;&#125;                                                                                               |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|      RETURN-OBJ |                                                                                                                                                        |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">|           STACK | thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-2&quot; thread_id=0x205;is_daemon=tr |</span><br><span class=\"line\">|                 | ue;priority=5;                                                                                                                                         |</span><br><span class=\"line\">|                 |     @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:45)             |</span><br><span class=\"line\">|                 |         at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)                                                             |</span><br><span class=\"line\">|                 |         at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)                                                                  |</span><br><span class=\"line\">|                 |         at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)                                                                     |</span><br><span class=\"line\">|                 |         at java.util.concurrent.FutureTask.run(FutureTask.java:262)                                                                                    |</span><br><span class=\"line\">|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)                                                             |</span><br><span class=\"line\">|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)                                                             |</span><br><span class=\"line\">|                 |         at java.lang.Thread.run(Thread.java:744)                                                                                                       |</span><br><span class=\"line\">+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class=\"line\">Time fragment[1004] successfully replayed.</span><br></pre></td></tr></table></figure>\n<h4 id=\"trace\"><a href=\"#trace\" class=\"headerlink\" title=\"trace\"></a>trace</h4><p>显示指定方法调用的栈，带时间消耗。简单的可以看下调用链上的耗时，进一步的话就需要更加专业的<code>JProfiler</code>等工具了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;trace -n 1 com.qunar.hotel.qta.open.promotion.service.impl.Bean doSend</span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 102 ms.</span><br><span class=\"line\">`---+Tracing for : thread_name=&quot;http-8080-181&quot; thread_id=0x507;is_daemon=true;priority=5;</span><br><span class=\"line\">    `---+[13,13ms]com.qunar.hotel.qta.open.promotion.service.impl.Bean:doSend()</span><br><span class=\"line\">        +---[0,0ms]com.qunar.hotel.qta.coupon.api.bean.CouponUser:&lt;init&gt;(@175)</span><br><span class=\"line\">        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getVoucherTypeId(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:&lt;init&gt;(@176)</span><br><span class=\"line\">        +---[0,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getTransactionId(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:append(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:append(@176)</span><br><span class=\"line\">        +---[0,0ms]java.lang.StringBuilder:toString(@176)</span><br><span class=\"line\">        +---[12,12ms]com.qunar.hotel.qta.coupon.api.remote.ActivityWriteRemote:consume(@176)</span><br><span class=\"line\">        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getAppName(@177)</span><br><span class=\"line\">        +---[12,0ms]com.qunar.hotel.qta.open.promotion.bean.voucher.VoucherSendTask:getBatchSeriesNum(@177)</span><br><span class=\"line\">        +---[12,0ms]java.lang.Long:valueOf(@177)</span><br><span class=\"line\">        +---[12,0ms]java.util.List:size(@177)</span><br><span class=\"line\">        +---[13,0ms]java.lang.Integer:valueOf(@177)</span><br><span class=\"line\">        `---[13,0ms]org.slf4j.Logger:info(@177)</span><br></pre></td></tr></table></figure>\n<p>最好也指定下<code>-n</code></p>\n<h4 id=\"stack\"><a href=\"#stack\" class=\"headerlink\" title=\"stack\"></a>stack</h4><p>stack可以产品指定方法调用的stack， 支持正则， 也支持各种条件表达式，具体可以<code>help stack</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;stack -n 1  *com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener onMessage </span><br><span class=\"line\">Press Ctrl+D to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:1) cost in 111 ms.</span><br><span class=\"line\">thread_name=&quot;anon-com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.&lt;clinit&gt;:33-thread-6&quot; thread_id=0x20e;is_daemon=true;priority=5;</span><br><span class=\"line\">    @com.qunar.hotel.qta.open.promotion.flow.listener.BookingPromotionRollBackListener.onMessage(BookingPromotionRollBackListener.java:-1)</span><br><span class=\"line\">        at qunar.tc.qmq.consumer.handler.ConsumerMessage.process(ConsumerMessage.java:105)</span><br><span class=\"line\">        at qunar.tc.qmq.consumer.handler.MessageHandler$1.run(MessageHandler.java:57)</span><br><span class=\"line\">        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)</span><br><span class=\"line\">        at java.util.concurrent.FutureTask.run(FutureTask.java:262)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class=\"line\">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:744)</span><br></pre></td></tr></table></figure>\n<p><em>注意最好指定下-n参数，以免对线上系统造成较大的压力</em></p>\n<h4 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h4><p>还有一些其他的用法，比如支持使用js编写自定义的脚本， 查看jvm的信息， 查看加载的类等等。</p>\n<h3 id=\"安全性\"><a href=\"#安全性\" class=\"headerlink\" title=\"安全性\"></a>安全性</h3><blockquote>\n<p>（1） 哪些命令会导致性能问题</p>\n</blockquote>\n<p>Greys的大部分命令性能开销都非常低廉，当然前提是一次性操作的类不要太多。</p>\n<blockquote>\n<p>（2） 是否能增强由BootstrapClassLoader所加载的类</p>\n</blockquote>\n<p>当然是可以的，但默认我封印了这个能力。主要是Greys自己也使用了大量BootstrapClassLoader所加载的类，如果处理不好极其容易造成故障。</p>\n<p>你可以通过隐藏命令options激活这个功能</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;options unsafe true</span><br><span class=\"line\">+--------+--------------+-------------+</span><br><span class=\"line\">| NAME   | BEFORE-VALUE | AFTER-VALUE |</span><br><span class=\"line\">+--------+--------------+-------------+</span><br><span class=\"line\">| unsafe | false        | true        |</span><br><span class=\"line\">+--------+--------------+-------------+</span><br><span class=\"line\">Affect(row-cnt:1) cost in 2 ms.</span><br></pre></td></tr></table></figure>\n<p>接下来你可以尝试增强系统类了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;monitor -c 5 java.lang.String substring</span><br><span class=\"line\">Press Ctrl+D or Ctrl+X to abort.</span><br><span class=\"line\">Affect(class-cnt:1 , method-cnt:2) cost in 35 ms.</span><br><span class=\"line\">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br><span class=\"line\">| timestamp           | class            | method    | total | success | fail | rt   | fail-rate |</span><br><span class=\"line\">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br><span class=\"line\">| 2015-06-16 23:44:54 | java.lang.String | substring | 30    | 30      | 0    | 0.23 | 0.00%     |</span><br><span class=\"line\">+---------------------+------------------+-----------+-------+---------+------+------+-----------+</span><br></pre></td></tr></table></figure>\n<p>但我话就放在这里，随意增强系统类。后果自负！</p>\n<h3 id=\"greys-退出\"><a href=\"#greys-退出\" class=\"headerlink\" title=\"greys 退出\"></a>greys 退出</h3><p>greys的数据是保存在内存中的， 有些记录的栈桢需要清理，因此推荐使用<code>shutdown</code>方法</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;tt -l</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|    INDEX | PROCESS-ID |            TIMESTAMP |   COST(ms) |   IS-RET |   IS-EXP |          OBJECT |                          CLASS |                         METHOD |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1001 |       1002 |  2017-11-12 17:30:40 |         20 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1002 |       1003 |  2017-11-12 17:30:41 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1003 |       1004 |  2017-11-12 17:37:27 |         10 |     true |    false |      0x55e9f734 |                           Bean |                         doSend |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br><span class=\"line\">|     1004 |       1005 |  2017-11-12 17:43:15 |          2 |     true |    false |      0x14b7937c | BookingPromotionRollBackListen |                      onMessage |</span><br><span class=\"line\">|          |            |                      |            |          |          |                 |                             er |                                |</span><br><span class=\"line\">+----------+------------+----------------------+------------+----------+----------+-----------------+--------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>\n<p>这些时间片默认是保存的，所以退出的时候需要清理下，不然对应用的gc都会有影响。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ga?&gt;shutdown</span><br><span class=\"line\">Greys Server is shut down.</span><br></pre></td></tr></table></figure>\n<p>greys 还提供了一个<code>reset</code>的命令，可以还原所有被增强过的类。</p>\n<blockquote>\n<p>  reset : Reset all the enhanced classes</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">greys pdf · oldmanpushcart/greys-anatomy Wiki</a></p>\n</li>\n<li><p><a href=\"http://www.bijishequ.com/detail/435931?p=29-55\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Grays Anatomy源码浅析–ClassLoader,Java,Method,DES,null,方法,INVOKING</a></p>\n</li>\n<li><p><a href=\"https://github.com/oldmanpushcart/greys-anatomy/wiki/FAQ\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">FAQ · oldmanpushcart/greys-anatomy Wiki</a></p>\n</li>\n<li><p><a href=\"http://hongkaiwen.github.io/2017/07/22/java-%E7%BA%BF%E4%B8%8A%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7-greys-anatomy-%E5%AE%9E%E8%B7%B5%E5%88%9D%E6%8E%A2/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java 线上调试工具 greys-anatomy 实践初探 | Kuzan</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/btrace1.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Btrace入门到熟练小工完全指南 | 江南白衣</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651478959&amp;idx=2&amp;sn=25bac2f47851c436f27c679e77e892ae&amp;chksm=bd2537d08a52bec6d5987b98e885d5b466569a7ba621a5e93297a5490ebd2ea75a04c7b51d47&amp;mpshare=1&amp;scene=1&amp;srcid=09056wNl5ibsbHVZNqBGAT8w#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">线上服务 CPU 100%？一键定位 so easy！</a></p>\n</li>\n<li><p><a href=\"https://github.com/CSUG/HouseMD/wiki/UserGuideCN\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">UserGuideCN · CSUG/HouseMD Wiki</a></p>\n</li>\n<li><p><a href=\"https://github.com/superhj1987/awesome-scripts\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">superhj1987/awesome-scripts: useful scripts for Linux op</a></p>\n</li>\n</ol>\n"},{"title":"java8 Stream使用不当，导致文件没有关闭","toc":true,"date":"2017-11-04T12:24:31.000Z","_content":"\n\n## 现象\n\n线上巡查的时候，检查了线上机器的`tomcat`打开的文件列表，发现了一些问题。\n一般来说，tomcat打开的文件就是一些`jar`包，日志文件, 动态库，socket等。因此用下面的命令查看下tomcat打开的文件\n\n```bash\nlsof -p $pid | grep / | grep -v \".jar\" | grep -v \".so\"\n```\n结果如下:\n\n```\nCOMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF      NODE NAME\n\njava    25516 tomcat  cwd    DIR              252,2      4096    136416 /tmp/hsperfdata_tomcat\n\njava    25516 tomcat  rtd    DIR              252,2      4096         2 /\n\njava    25516 tomcat  mem    REG              252,2  99158576     19559 /usr/lib/locale/locale-archive\n\njava    25516 tomcat  mem    REG              252,2     32768    131740 /tmp/hsperfdata_tomcat/25516\n\njava    25516 tomcat    0r   CHR                1,3       0t0      3674 /dev/null\n\njava    25516 tomcat    1w   REG              252,7  16965016   1836324 /logs/catalina.out\n\njava    25516 tomcat    2w   REG              252,7  16965016   1836324 /logs/catalina.out\n\njava    25516 tomcat    3w   REG              252,7   7839644   1836499 /logs/gc-201710181632.log\n\njava    25516 tomcat   10w   REG              252,7   2741011   1835201 /logs/catalina.2017-10-18.log (deleted)\n\njava    25516 tomcat   11w   REG              252,7      1494   1835054 /logs/localhost.2017-10-18.log (deleted)\n\njava    25516 tomcat   40r   CHR                1,8       0t0      3678 /dev/random\n\njava    25516 tomcat   41r   CHR                1,9       0t0      3679 /dev/urandom\n\njava    25516 tomcat   42r   CHR                1,8       0t0      3678 /dev/random\n\njava    25516 tomcat   43r   CHR                1,8       0t0      3678 /dev/random\n\njava    25516 tomcat   44r   CHR                1,9       0t0      3679 /dev/urandom\n\njava    25516 tomcat   45r   CHR                1,9       0t0      3679 /dev/urandom\n\njava    25516 tomcat   52w   REG              252,7   7409504   1836890 /logs/access.2017-10-19.log\n\njava    25516 tomcat   65r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat   68r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat   72r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat   82r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  180r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  193r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat  197r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat  200r   REG              252,7  44315261   1836448 /logs/dubbo-access-provider.2017-10-19-13.log\n\njava    25516 tomcat  204r   REG              252,7 181402005   1836417 /logs/dubbo-access-consumer.2017-10-19-13.log\n\njava    25516 tomcat  224r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  363r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  365r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat  573r   CHR                1,8       0t0      3678 /dev/random\n```\n\n从文件列表中可以看出日志文件是一直打开的，这个是正常的，因为需要写入日志。\n但是还有一些其他的文件，不需要写入，也一直打开，而且有的打开了好几次，这个就看起来有问题了。\n\n\n翻代码， 发现这个文件是定时拉取的逻辑，每次从数据源拉一份文件到本地， 然后用java8的`Files.lines`和lambda进行处理。\n下面大概复现了相关的逻辑。\n\n## 复现\n\n```java\npackage com.air.collection.java8.stream.file;\n\nimport com.google.common.collect.Lists;\nimport com.google.common.io.Resources;\n\nimport java.io.IOException;\nimport java.net.URISyntaxException;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.List;\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ScheduledExecutorService;\nimport java.util.concurrent.TimeUnit;\n\nimport static java.util.stream.Collectors.toList;\n\n/**\n * @author qisheng.li\n * @email qisheng.li@qunar.com\n * @date 17-11-4 下午5:07\n */\npublic class FilesTest {\n\n    private static ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);\n\n    public static void main(String[] args) throws IOException, URISyntaxException, InterruptedException {\n        executor.scheduleAtFixedRate(FilesTest::reloadFile, 100, 1000, TimeUnit.MILLISECONDS);\n    }\n\n    public static void reloadFile() {\n        System.out.println(\"reload file\");\n        List<Integer> collect = Lists.newArrayList();\n        try {\n            collect = Files.lines(Paths.get(Resources.getResource(\"test.json\").toURI()))\n                    .map(String::length)\n                    .collect(toList());\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n            System.out.println(collect.get(0));\n        }\n}\n\n```\n\n查看进程打开的文件，可以发现有一堆的`test.json`\n\n```bash\njava    23757 qishengli 8822r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8823r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8824r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8825r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8826r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8827r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8828r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8829r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8830r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8831r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8832r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8833r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8834r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8835r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\n```\n\n完美复现！\n\n## 原因\n\n>Streams have a BaseStream.close() method and implement AutoCloseable, but nearly all stream instances do not actually need to be closed after use. \n\n一般来说，并不需要手动调用`Stream`的`close`方法， 只有背后是I/O相关的流才需要手动关闭。\n\n>Generally, only streams whose source is an IO channel (such as those returned by Files.lines(Path, Charset)) will require closing. Most streams are backed by collections, arrays, or generating functions, which require no special resource management. (If a stream does require closing, it can be declared as a resource in a try-with-resources statement.)\n\n查找到打开相应文件的代码，发现使用的正是java8的`Files.lines`方法，这个方法并不会自动的将文件关闭，所以就会看到，tomcat进程多次打开了同一个文件。\n\n`Files.lines`方法的函数说明如下：\n\n```java\n/**\n     * Read all lines from a file as a {@code Stream}. Unlike {@link\n     * #readAllLines(Path, Charset) readAllLines}, this method does not read\n     * all lines into a {@code List}, but instead populates lazily as the stream\n     * is consumed.\n     *\n     * <p> Bytes from the file are decoded into characters using the specified\n     * charset and the same line terminators as specified by {@code\n     * readAllLines} are supported.\n     *\n     * <p> After this method returns, then any subsequent I/O exception that\n     * occurs while reading from the file or when a malformed or unmappable byte\n     * sequence is read, is wrapped in an {@link UncheckedIOException} that will\n     * be thrown from the\n     * {@link java.util.stream.Stream} method that caused the read to take\n     * place. In case an {@code IOException} is thrown when closing the file,\n     * it is also wrapped as an {@code UncheckedIOException}.\n     *\n     * <p> The returned stream encapsulates a {@link Reader}.  If timely\n     * disposal of file system resources is required, the try-with-resources\n     * construct should be used to ensure that the stream's\n     * {@link Stream#close close} method is invoked after the stream operations\n     * are completed.\n     *\n     *\n     * @param   path\n     *          the path to the file\n     * @param   cs\n     *          the charset to use for decoding\n     *\n     * @return  the lines from the file as a {@code Stream}\n     *\n     * @throws  IOException\n     *          if an I/O error occurs opening the file\n     * @throws  SecurityException\n     *          In the case of the default provider, and a security manager is\n     *          installed, the {@link SecurityManager#checkRead(String) checkRead}\n     *          method is invoked to check read access to the file.\n     *\n     * @see     #readAllLines(Path, Charset)\n     * @see     #newBufferedReader(Path, Charset)\n     * @see     java.io.BufferedReader#lines()\n     * @since   1.8\n     */\n    public static Stream<String> lines(Path path, Charset cs) throws IOException {\n        BufferedReader br = Files.newBufferedReader(path, cs);\n        try {\n            return br.lines().onClose(asUncheckedRunnable(br));\n        } catch (Error|RuntimeException e) {\n            try {\n                br.close();\n            } catch (IOException ex) {\n                try {\n                    e.addSuppressed(ex);\n                } catch (Throwable ignore) {}\n            }\n            throw e;\n        }\n    }\n\n```\n\n重点看这几句， \n\n>The returned stream encapsulates a Reader.  If timely disposal of file system resources is required, the try-with-resources construct should be used to ensure that the stream's `Stream#close` method is invoked  after the stream operations are completed.\n\n如果需要及时地清理系统的资源， 可以使用java7中引入的`try-with-resources`, 来确保`Stream`的`close`方法在使用完后被调用。\n\n`Files.lines`是惰性的， 当你使用的时候才去读取， 所以需要手动的关闭流， `Files.readAllLines`这个方法则是一次把文件\n中的所有行读取到内存中去，并且会自动的关闭文件。\n\n`Files.readAllLines`的函数说明中就保证了底层的文件一定会被关闭。\n\n```java\n /**\n     * Read all lines from a file. This method ensures that the file is\n     * closed when all bytes have been read or an I/O error, or other runtime\n     * exception, is thrown. Bytes from the file are decoded into characters\n     * using the specified charset.\n     **/\n```\n\n## 解决方案\n\n使用java7中引入的`try-with-resoucres`, 实现了`AutoCloseable`接口的都会被自动的关闭\n\n```java\ntry ( Stream<String> stream = Files.lines(path, charset) ) {\n    // do something\n}\n```\n\n## 参考\n\n1. [Close Java 8 Stream - Stack Overflow](https://stackoverflow.com/questions/38698182/close-java-8-stream)\n\n2. [java - Do I have to close terminated, streamed query results in a try-with-resources-block? - Stack Overflow](https://stackoverflow.com/questions/37659872/do-i-have-to-close-terminated-streamed-query-results-in-a-try-with-resources-bl)\n\n3. [在你的代码之外，服务时延过长的三个追查方向(下) | 江南白衣](http://calvin1978.blogcn.com/articles/latency2.html)","source":"_posts/java8-file-stream.md","raw":"title: java8 Stream使用不当，导致文件没有关闭\ntags: java\ncategory: java\ntoc: true\ndate: 2017-11-04 20:24:31\n---\n\n\n## 现象\n\n线上巡查的时候，检查了线上机器的`tomcat`打开的文件列表，发现了一些问题。\n一般来说，tomcat打开的文件就是一些`jar`包，日志文件, 动态库，socket等。因此用下面的命令查看下tomcat打开的文件\n\n```bash\nlsof -p $pid | grep / | grep -v \".jar\" | grep -v \".so\"\n```\n结果如下:\n\n```\nCOMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF      NODE NAME\n\njava    25516 tomcat  cwd    DIR              252,2      4096    136416 /tmp/hsperfdata_tomcat\n\njava    25516 tomcat  rtd    DIR              252,2      4096         2 /\n\njava    25516 tomcat  mem    REG              252,2  99158576     19559 /usr/lib/locale/locale-archive\n\njava    25516 tomcat  mem    REG              252,2     32768    131740 /tmp/hsperfdata_tomcat/25516\n\njava    25516 tomcat    0r   CHR                1,3       0t0      3674 /dev/null\n\njava    25516 tomcat    1w   REG              252,7  16965016   1836324 /logs/catalina.out\n\njava    25516 tomcat    2w   REG              252,7  16965016   1836324 /logs/catalina.out\n\njava    25516 tomcat    3w   REG              252,7   7839644   1836499 /logs/gc-201710181632.log\n\njava    25516 tomcat   10w   REG              252,7   2741011   1835201 /logs/catalina.2017-10-18.log (deleted)\n\njava    25516 tomcat   11w   REG              252,7      1494   1835054 /logs/localhost.2017-10-18.log (deleted)\n\njava    25516 tomcat   40r   CHR                1,8       0t0      3678 /dev/random\n\njava    25516 tomcat   41r   CHR                1,9       0t0      3679 /dev/urandom\n\njava    25516 tomcat   42r   CHR                1,8       0t0      3678 /dev/random\n\njava    25516 tomcat   43r   CHR                1,8       0t0      3678 /dev/random\n\njava    25516 tomcat   44r   CHR                1,9       0t0      3679 /dev/urandom\n\njava    25516 tomcat   45r   CHR                1,9       0t0      3679 /dev/urandom\n\njava    25516 tomcat   52w   REG              252,7   7409504   1836890 /logs/access.2017-10-19.log\n\njava    25516 tomcat   65r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat   68r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat   72r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat   82r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  180r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  193r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat  197r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat  200r   REG              252,7  44315261   1836448 /logs/dubbo-access-provider.2017-10-19-13.log\n\njava    25516 tomcat  204r   REG              252,7 181402005   1836417 /logs/dubbo-access-consumer.2017-10-19-13.log\n\njava    25516 tomcat  224r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  363r   REG              252,7  67531699   1835818 /cache/file_cache/fileB\n\njava    25516 tomcat  365r   REG              252,7   5665798   1836099 /cache/file_cache/fileA\n\njava    25516 tomcat  573r   CHR                1,8       0t0      3678 /dev/random\n```\n\n从文件列表中可以看出日志文件是一直打开的，这个是正常的，因为需要写入日志。\n但是还有一些其他的文件，不需要写入，也一直打开，而且有的打开了好几次，这个就看起来有问题了。\n\n\n翻代码， 发现这个文件是定时拉取的逻辑，每次从数据源拉一份文件到本地， 然后用java8的`Files.lines`和lambda进行处理。\n下面大概复现了相关的逻辑。\n\n## 复现\n\n```java\npackage com.air.collection.java8.stream.file;\n\nimport com.google.common.collect.Lists;\nimport com.google.common.io.Resources;\n\nimport java.io.IOException;\nimport java.net.URISyntaxException;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.List;\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ScheduledExecutorService;\nimport java.util.concurrent.TimeUnit;\n\nimport static java.util.stream.Collectors.toList;\n\n/**\n * @author qisheng.li\n * @email qisheng.li@qunar.com\n * @date 17-11-4 下午5:07\n */\npublic class FilesTest {\n\n    private static ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);\n\n    public static void main(String[] args) throws IOException, URISyntaxException, InterruptedException {\n        executor.scheduleAtFixedRate(FilesTest::reloadFile, 100, 1000, TimeUnit.MILLISECONDS);\n    }\n\n    public static void reloadFile() {\n        System.out.println(\"reload file\");\n        List<Integer> collect = Lists.newArrayList();\n        try {\n            collect = Files.lines(Paths.get(Resources.getResource(\"test.json\").toURI()))\n                    .map(String::length)\n                    .collect(toList());\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n            System.out.println(collect.get(0));\n        }\n}\n\n```\n\n查看进程打开的文件，可以发现有一堆的`test.json`\n\n```bash\njava    23757 qishengli 8822r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8823r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8824r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8825r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8826r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8827r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8828r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8829r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8830r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8831r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8832r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8833r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8834r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\njava    23757 qishengli 8835r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json\n```\n\n完美复现！\n\n## 原因\n\n>Streams have a BaseStream.close() method and implement AutoCloseable, but nearly all stream instances do not actually need to be closed after use. \n\n一般来说，并不需要手动调用`Stream`的`close`方法， 只有背后是I/O相关的流才需要手动关闭。\n\n>Generally, only streams whose source is an IO channel (such as those returned by Files.lines(Path, Charset)) will require closing. Most streams are backed by collections, arrays, or generating functions, which require no special resource management. (If a stream does require closing, it can be declared as a resource in a try-with-resources statement.)\n\n查找到打开相应文件的代码，发现使用的正是java8的`Files.lines`方法，这个方法并不会自动的将文件关闭，所以就会看到，tomcat进程多次打开了同一个文件。\n\n`Files.lines`方法的函数说明如下：\n\n```java\n/**\n     * Read all lines from a file as a {@code Stream}. Unlike {@link\n     * #readAllLines(Path, Charset) readAllLines}, this method does not read\n     * all lines into a {@code List}, but instead populates lazily as the stream\n     * is consumed.\n     *\n     * <p> Bytes from the file are decoded into characters using the specified\n     * charset and the same line terminators as specified by {@code\n     * readAllLines} are supported.\n     *\n     * <p> After this method returns, then any subsequent I/O exception that\n     * occurs while reading from the file or when a malformed or unmappable byte\n     * sequence is read, is wrapped in an {@link UncheckedIOException} that will\n     * be thrown from the\n     * {@link java.util.stream.Stream} method that caused the read to take\n     * place. In case an {@code IOException} is thrown when closing the file,\n     * it is also wrapped as an {@code UncheckedIOException}.\n     *\n     * <p> The returned stream encapsulates a {@link Reader}.  If timely\n     * disposal of file system resources is required, the try-with-resources\n     * construct should be used to ensure that the stream's\n     * {@link Stream#close close} method is invoked after the stream operations\n     * are completed.\n     *\n     *\n     * @param   path\n     *          the path to the file\n     * @param   cs\n     *          the charset to use for decoding\n     *\n     * @return  the lines from the file as a {@code Stream}\n     *\n     * @throws  IOException\n     *          if an I/O error occurs opening the file\n     * @throws  SecurityException\n     *          In the case of the default provider, and a security manager is\n     *          installed, the {@link SecurityManager#checkRead(String) checkRead}\n     *          method is invoked to check read access to the file.\n     *\n     * @see     #readAllLines(Path, Charset)\n     * @see     #newBufferedReader(Path, Charset)\n     * @see     java.io.BufferedReader#lines()\n     * @since   1.8\n     */\n    public static Stream<String> lines(Path path, Charset cs) throws IOException {\n        BufferedReader br = Files.newBufferedReader(path, cs);\n        try {\n            return br.lines().onClose(asUncheckedRunnable(br));\n        } catch (Error|RuntimeException e) {\n            try {\n                br.close();\n            } catch (IOException ex) {\n                try {\n                    e.addSuppressed(ex);\n                } catch (Throwable ignore) {}\n            }\n            throw e;\n        }\n    }\n\n```\n\n重点看这几句， \n\n>The returned stream encapsulates a Reader.  If timely disposal of file system resources is required, the try-with-resources construct should be used to ensure that the stream's `Stream#close` method is invoked  after the stream operations are completed.\n\n如果需要及时地清理系统的资源， 可以使用java7中引入的`try-with-resources`, 来确保`Stream`的`close`方法在使用完后被调用。\n\n`Files.lines`是惰性的， 当你使用的时候才去读取， 所以需要手动的关闭流， `Files.readAllLines`这个方法则是一次把文件\n中的所有行读取到内存中去，并且会自动的关闭文件。\n\n`Files.readAllLines`的函数说明中就保证了底层的文件一定会被关闭。\n\n```java\n /**\n     * Read all lines from a file. This method ensures that the file is\n     * closed when all bytes have been read or an I/O error, or other runtime\n     * exception, is thrown. Bytes from the file are decoded into characters\n     * using the specified charset.\n     **/\n```\n\n## 解决方案\n\n使用java7中引入的`try-with-resoucres`, 实现了`AutoCloseable`接口的都会被自动的关闭\n\n```java\ntry ( Stream<String> stream = Files.lines(path, charset) ) {\n    // do something\n}\n```\n\n## 参考\n\n1. [Close Java 8 Stream - Stack Overflow](https://stackoverflow.com/questions/38698182/close-java-8-stream)\n\n2. [java - Do I have to close terminated, streamed query results in a try-with-resources-block? - Stack Overflow](https://stackoverflow.com/questions/37659872/do-i-have-to-close-terminated-streamed-query-results-in-a-try-with-resources-bl)\n\n3. [在你的代码之外，服务时延过长的三个追查方向(下) | 江南白衣](http://calvin1978.blogcn.com/articles/latency2.html)","slug":"java8-file-stream","published":1,"updated":"2017-11-18T10:03:15.451Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9r007bjh4knlhzxfcn","content":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>线上巡查的时候，检查了线上机器的<code>tomcat</code>打开的文件列表，发现了一些问题。<br>一般来说，tomcat打开的文件就是一些<code>jar</code>包，日志文件, 动态库，socket等。因此用下面的命令查看下tomcat打开的文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -p <span class=\"variable\">$pid</span> | grep / | grep -v <span class=\"string\">\".jar\"</span> | grep -v <span class=\"string\">\".so\"</span></span><br></pre></td></tr></table></figure>\n<p>结果如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF      NODE NAME</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  cwd    DIR              252,2      4096    136416 /tmp/hsperfdata_tomcat</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  rtd    DIR              252,2      4096         2 /</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  mem    REG              252,2  99158576     19559 /usr/lib/locale/locale-archive</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  mem    REG              252,2     32768    131740 /tmp/hsperfdata_tomcat/25516</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    0r   CHR                1,3       0t0      3674 /dev/null</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    1w   REG              252,7  16965016   1836324 /logs/catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    2w   REG              252,7  16965016   1836324 /logs/catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    3w   REG              252,7   7839644   1836499 /logs/gc-201710181632.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   10w   REG              252,7   2741011   1835201 /logs/catalina.2017-10-18.log (deleted)</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   11w   REG              252,7      1494   1835054 /logs/localhost.2017-10-18.log (deleted)</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   40r   CHR                1,8       0t0      3678 /dev/random</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   41r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   42r   CHR                1,8       0t0      3678 /dev/random</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   43r   CHR                1,8       0t0      3678 /dev/random</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   44r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   45r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   52w   REG              252,7   7409504   1836890 /logs/access.2017-10-19.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   65r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   68r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   72r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   82r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  180r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  193r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  197r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  200r   REG              252,7  44315261   1836448 /logs/dubbo-access-provider.2017-10-19-13.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  204r   REG              252,7 181402005   1836417 /logs/dubbo-access-consumer.2017-10-19-13.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  224r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  363r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  365r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  573r   CHR                1,8       0t0      3678 /dev/random</span><br></pre></td></tr></table></figure>\n<p>从文件列表中可以看出日志文件是一直打开的，这个是正常的，因为需要写入日志。<br>但是还有一些其他的文件，不需要写入，也一直打开，而且有的打开了好几次，这个就看起来有问题了。</p>\n<p>翻代码， 发现这个文件是定时拉取的逻辑，每次从数据源拉一份文件到本地， 然后用java8的<code>Files.lines</code>和lambda进行处理。<br>下面大概复现了相关的逻辑。</p>\n<h2 id=\"复现\"><a href=\"#复现\" class=\"headerlink\" title=\"复现\"></a>复现</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.air.collection.java8.stream.file;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.common.collect.Lists;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.common.io.Resources;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URISyntaxException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Files;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Paths;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.Executors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"keyword\">static</span> java.util.stream.Collectors.toList;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> qisheng.li</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@email</span> qisheng.li@qunar.com</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 17-11-4 下午5:07</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FilesTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, URISyntaxException, InterruptedException </span>&#123;</span><br><span class=\"line\">        executor.scheduleAtFixedRate(FilesTest::reloadFile, <span class=\"number\">100</span>, <span class=\"number\">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">reloadFile</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"reload file\"</span>);</span><br><span class=\"line\">        List&lt;Integer&gt; collect = Lists.newArrayList();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            collect = Files.lines(Paths.get(Resources.getResource(<span class=\"string\">\"test.json\"</span>).toURI()))</span><br><span class=\"line\">                    .map(String::length)</span><br><span class=\"line\">                    .collect(toList());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">            System.out.println(collect.get(<span class=\"number\">0</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>查看进程打开的文件，可以发现有一堆的<code>test.json</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java    23757 qishengli 8822r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8823r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8824r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8825r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8826r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8827r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8828r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8829r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8830r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8831r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8832r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8833r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8834r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8835r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br></pre></td></tr></table></figure>\n<p>完美复现！</p>\n<h2 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h2><blockquote>\n<p>Streams have a BaseStream.close() method and implement AutoCloseable, but nearly all stream instances do not actually need to be closed after use. </p>\n</blockquote>\n<p>一般来说，并不需要手动调用<code>Stream</code>的<code>close</code>方法， 只有背后是I/O相关的流才需要手动关闭。</p>\n<blockquote>\n<p>Generally, only streams whose source is an IO channel (such as those returned by Files.lines(Path, Charset)) will require closing. Most streams are backed by collections, arrays, or generating functions, which require no special resource management. (If a stream does require closing, it can be declared as a resource in a try-with-resources statement.)</p>\n</blockquote>\n<p>查找到打开相应文件的代码，发现使用的正是java8的<code>Files.lines</code>方法，这个方法并不会自动的将文件关闭，所以就会看到，tomcat进程多次打开了同一个文件。</p>\n<p><code>Files.lines</code>方法的函数说明如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Read all lines from a file as a &#123;<span class=\"doctag\">@code</span> Stream&#125;. Unlike &#123;<span class=\"doctag\">@link</span></span></span><br><span class=\"line\"><span class=\"comment\">     * #readAllLines(Path, Charset) readAllLines&#125;, this method does not read</span></span><br><span class=\"line\"><span class=\"comment\">     * all lines into a &#123;<span class=\"doctag\">@code</span> List&#125;, but instead populates lazily as the stream</span></span><br><span class=\"line\"><span class=\"comment\">     * is consumed.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt; Bytes from the file are decoded into characters using the specified</span></span><br><span class=\"line\"><span class=\"comment\">     * charset and the same line terminators as specified by &#123;<span class=\"doctag\">@code</span></span></span><br><span class=\"line\"><span class=\"comment\">     * readAllLines&#125; are supported.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt; After this method returns, then any subsequent I/O exception that</span></span><br><span class=\"line\"><span class=\"comment\">     * occurs while reading from the file or when a malformed or unmappable byte</span></span><br><span class=\"line\"><span class=\"comment\">     * sequence is read, is wrapped in an &#123;<span class=\"doctag\">@link</span> UncheckedIOException&#125; that will</span></span><br><span class=\"line\"><span class=\"comment\">     * be thrown from the</span></span><br><span class=\"line\"><span class=\"comment\">     * &#123;<span class=\"doctag\">@link</span> java.util.stream.Stream&#125; method that caused the read to take</span></span><br><span class=\"line\"><span class=\"comment\">     * place. In case an &#123;<span class=\"doctag\">@code</span> IOException&#125; is thrown when closing the file,</span></span><br><span class=\"line\"><span class=\"comment\">     * it is also wrapped as an &#123;<span class=\"doctag\">@code</span> UncheckedIOException&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt; The returned stream encapsulates a &#123;<span class=\"doctag\">@link</span> Reader&#125;.  If timely</span></span><br><span class=\"line\"><span class=\"comment\">     * disposal of file system resources is required, the try-with-resources</span></span><br><span class=\"line\"><span class=\"comment\">     * construct should be used to ensure that the stream's</span></span><br><span class=\"line\"><span class=\"comment\">     * &#123;<span class=\"doctag\">@link</span> Stream#close close&#125; method is invoked after the stream operations</span></span><br><span class=\"line\"><span class=\"comment\">     * are completed.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>   path</span></span><br><span class=\"line\"><span class=\"comment\">     *          the path to the file</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>   cs</span></span><br><span class=\"line\"><span class=\"comment\">     *          the charset to use for decoding</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>  the lines from the file as a &#123;<span class=\"doctag\">@code</span> Stream&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span>  IOException</span></span><br><span class=\"line\"><span class=\"comment\">     *          if an I/O error occurs opening the file</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span>  SecurityException</span></span><br><span class=\"line\"><span class=\"comment\">     *          In the case of the default provider, and a security manager is</span></span><br><span class=\"line\"><span class=\"comment\">     *          installed, the &#123;<span class=\"doctag\">@link</span> SecurityManager#checkRead(String) checkRead&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     *          method is invoked to check read access to the file.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span>     #readAllLines(Path, Charset)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span>     #newBufferedReader(Path, Charset)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span>     java.io.BufferedReader#lines()</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@since</span>   1.8</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Stream&lt;String&gt; <span class=\"title\">lines</span><span class=\"params\">(Path path, Charset cs)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        BufferedReader br = Files.newBufferedReader(path, cs);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> br.lines().onClose(asUncheckedRunnable(br));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Error|RuntimeException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                br.close();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    e.addSuppressed(ex);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable ignore) &#123;&#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>重点看这几句， </p>\n<blockquote>\n<p>The returned stream encapsulates a Reader.  If timely disposal of file system resources is required, the try-with-resources construct should be used to ensure that the stream’s <code>Stream#close</code> method is invoked  after the stream operations are completed.</p>\n</blockquote>\n<p>如果需要及时地清理系统的资源， 可以使用java7中引入的<code>try-with-resources</code>, 来确保<code>Stream</code>的<code>close</code>方法在使用完后被调用。</p>\n<p><code>Files.lines</code>是惰性的， 当你使用的时候才去读取， 所以需要手动的关闭流， <code>Files.readAllLines</code>这个方法则是一次把文件<br>中的所有行读取到内存中去，并且会自动的关闭文件。</p>\n<p><code>Files.readAllLines</code>的函数说明中就保证了底层的文件一定会被关闭。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Read all lines from a file. This method ensures that the file is</span></span><br><span class=\"line\"><span class=\"comment\">    * closed when all bytes have been read or an I/O error, or other runtime</span></span><br><span class=\"line\"><span class=\"comment\">    * exception, is thrown. Bytes from the file are decoded into characters</span></span><br><span class=\"line\"><span class=\"comment\">    * using the specified charset.</span></span><br><span class=\"line\"><span class=\"comment\">    **/</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>使用java7中引入的<code>try-with-resoucres</code>, 实现了<code>AutoCloseable</code>接口的都会被自动的关闭</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> ( Stream&lt;String&gt; stream = Files.lines(path, charset) ) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// do something</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://stackoverflow.com/questions/38698182/close-java-8-stream\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Close Java 8 Stream - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/37659872/do-i-have-to-close-terminated-streamed-query-results-in-a-try-with-resources-bl\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - Do I have to close terminated, streamed query results in a try-with-resources-block? - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/latency2.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">在你的代码之外，服务时延过长的三个追查方向(下) | 江南白衣</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>线上巡查的时候，检查了线上机器的<code>tomcat</code>打开的文件列表，发现了一些问题。<br>一般来说，tomcat打开的文件就是一些<code>jar</code>包，日志文件, 动态库，socket等。因此用下面的命令查看下tomcat打开的文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsof -p <span class=\"variable\">$pid</span> | grep / | grep -v <span class=\"string\">\".jar\"</span> | grep -v <span class=\"string\">\".so\"</span></span><br></pre></td></tr></table></figure>\n<p>结果如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF      NODE NAME</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  cwd    DIR              252,2      4096    136416 /tmp/hsperfdata_tomcat</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  rtd    DIR              252,2      4096         2 /</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  mem    REG              252,2  99158576     19559 /usr/lib/locale/locale-archive</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  mem    REG              252,2     32768    131740 /tmp/hsperfdata_tomcat/25516</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    0r   CHR                1,3       0t0      3674 /dev/null</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    1w   REG              252,7  16965016   1836324 /logs/catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    2w   REG              252,7  16965016   1836324 /logs/catalina.out</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat    3w   REG              252,7   7839644   1836499 /logs/gc-201710181632.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   10w   REG              252,7   2741011   1835201 /logs/catalina.2017-10-18.log (deleted)</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   11w   REG              252,7      1494   1835054 /logs/localhost.2017-10-18.log (deleted)</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   40r   CHR                1,8       0t0      3678 /dev/random</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   41r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   42r   CHR                1,8       0t0      3678 /dev/random</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   43r   CHR                1,8       0t0      3678 /dev/random</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   44r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   45r   CHR                1,9       0t0      3679 /dev/urandom</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   52w   REG              252,7   7409504   1836890 /logs/access.2017-10-19.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   65r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   68r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   72r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat   82r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  180r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  193r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  197r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  200r   REG              252,7  44315261   1836448 /logs/dubbo-access-provider.2017-10-19-13.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  204r   REG              252,7 181402005   1836417 /logs/dubbo-access-consumer.2017-10-19-13.log</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  224r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  363r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  365r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</span><br><span class=\"line\"></span><br><span class=\"line\">java    25516 tomcat  573r   CHR                1,8       0t0      3678 /dev/random</span><br></pre></td></tr></table></figure>\n<p>从文件列表中可以看出日志文件是一直打开的，这个是正常的，因为需要写入日志。<br>但是还有一些其他的文件，不需要写入，也一直打开，而且有的打开了好几次，这个就看起来有问题了。</p>\n<p>翻代码， 发现这个文件是定时拉取的逻辑，每次从数据源拉一份文件到本地， 然后用java8的<code>Files.lines</code>和lambda进行处理。<br>下面大概复现了相关的逻辑。</p>\n<h2 id=\"复现\"><a href=\"#复现\" class=\"headerlink\" title=\"复现\"></a>复现</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.air.collection.java8.stream.file;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.common.collect.Lists;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.common.io.Resources;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.URISyntaxException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Files;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Paths;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.Executors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"keyword\">static</span> java.util.stream.Collectors.toList;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> qisheng.li</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@email</span> qisheng.li@qunar.com</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 17-11-4 下午5:07</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FilesTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, URISyntaxException, InterruptedException </span>&#123;</span><br><span class=\"line\">        executor.scheduleAtFixedRate(FilesTest::reloadFile, <span class=\"number\">100</span>, <span class=\"number\">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">reloadFile</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"reload file\"</span>);</span><br><span class=\"line\">        List&lt;Integer&gt; collect = Lists.newArrayList();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            collect = Files.lines(Paths.get(Resources.getResource(<span class=\"string\">\"test.json\"</span>).toURI()))</span><br><span class=\"line\">                    .map(String::length)</span><br><span class=\"line\">                    .collect(toList());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">            System.out.println(collect.get(<span class=\"number\">0</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>查看进程打开的文件，可以发现有一堆的<code>test.json</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java    23757 qishengli 8822r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8823r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8824r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8825r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8826r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8827r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8828r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8829r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8830r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8831r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8832r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8833r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8834r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br><span class=\"line\">java    23757 qishengli 8835r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</span><br></pre></td></tr></table></figure>\n<p>完美复现！</p>\n<h2 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h2><blockquote>\n<p>Streams have a BaseStream.close() method and implement AutoCloseable, but nearly all stream instances do not actually need to be closed after use. </p>\n</blockquote>\n<p>一般来说，并不需要手动调用<code>Stream</code>的<code>close</code>方法， 只有背后是I/O相关的流才需要手动关闭。</p>\n<blockquote>\n<p>Generally, only streams whose source is an IO channel (such as those returned by Files.lines(Path, Charset)) will require closing. Most streams are backed by collections, arrays, or generating functions, which require no special resource management. (If a stream does require closing, it can be declared as a resource in a try-with-resources statement.)</p>\n</blockquote>\n<p>查找到打开相应文件的代码，发现使用的正是java8的<code>Files.lines</code>方法，这个方法并不会自动的将文件关闭，所以就会看到，tomcat进程多次打开了同一个文件。</p>\n<p><code>Files.lines</code>方法的函数说明如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Read all lines from a file as a &#123;<span class=\"doctag\">@code</span> Stream&#125;. Unlike &#123;<span class=\"doctag\">@link</span></span></span><br><span class=\"line\"><span class=\"comment\">     * #readAllLines(Path, Charset) readAllLines&#125;, this method does not read</span></span><br><span class=\"line\"><span class=\"comment\">     * all lines into a &#123;<span class=\"doctag\">@code</span> List&#125;, but instead populates lazily as the stream</span></span><br><span class=\"line\"><span class=\"comment\">     * is consumed.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt; Bytes from the file are decoded into characters using the specified</span></span><br><span class=\"line\"><span class=\"comment\">     * charset and the same line terminators as specified by &#123;<span class=\"doctag\">@code</span></span></span><br><span class=\"line\"><span class=\"comment\">     * readAllLines&#125; are supported.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt; After this method returns, then any subsequent I/O exception that</span></span><br><span class=\"line\"><span class=\"comment\">     * occurs while reading from the file or when a malformed or unmappable byte</span></span><br><span class=\"line\"><span class=\"comment\">     * sequence is read, is wrapped in an &#123;<span class=\"doctag\">@link</span> UncheckedIOException&#125; that will</span></span><br><span class=\"line\"><span class=\"comment\">     * be thrown from the</span></span><br><span class=\"line\"><span class=\"comment\">     * &#123;<span class=\"doctag\">@link</span> java.util.stream.Stream&#125; method that caused the read to take</span></span><br><span class=\"line\"><span class=\"comment\">     * place. In case an &#123;<span class=\"doctag\">@code</span> IOException&#125; is thrown when closing the file,</span></span><br><span class=\"line\"><span class=\"comment\">     * it is also wrapped as an &#123;<span class=\"doctag\">@code</span> UncheckedIOException&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;p&gt; The returned stream encapsulates a &#123;<span class=\"doctag\">@link</span> Reader&#125;.  If timely</span></span><br><span class=\"line\"><span class=\"comment\">     * disposal of file system resources is required, the try-with-resources</span></span><br><span class=\"line\"><span class=\"comment\">     * construct should be used to ensure that the stream's</span></span><br><span class=\"line\"><span class=\"comment\">     * &#123;<span class=\"doctag\">@link</span> Stream#close close&#125; method is invoked after the stream operations</span></span><br><span class=\"line\"><span class=\"comment\">     * are completed.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>   path</span></span><br><span class=\"line\"><span class=\"comment\">     *          the path to the file</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>   cs</span></span><br><span class=\"line\"><span class=\"comment\">     *          the charset to use for decoding</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>  the lines from the file as a &#123;<span class=\"doctag\">@code</span> Stream&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span>  IOException</span></span><br><span class=\"line\"><span class=\"comment\">     *          if an I/O error occurs opening the file</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span>  SecurityException</span></span><br><span class=\"line\"><span class=\"comment\">     *          In the case of the default provider, and a security manager is</span></span><br><span class=\"line\"><span class=\"comment\">     *          installed, the &#123;<span class=\"doctag\">@link</span> SecurityManager#checkRead(String) checkRead&#125;</span></span><br><span class=\"line\"><span class=\"comment\">     *          method is invoked to check read access to the file.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span>     #readAllLines(Path, Charset)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span>     #newBufferedReader(Path, Charset)</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span>     java.io.BufferedReader#lines()</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@since</span>   1.8</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Stream&lt;String&gt; <span class=\"title\">lines</span><span class=\"params\">(Path path, Charset cs)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        BufferedReader br = Files.newBufferedReader(path, cs);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> br.lines().onClose(asUncheckedRunnable(br));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Error|RuntimeException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                br.close();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    e.addSuppressed(ex);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable ignore) &#123;&#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>重点看这几句， </p>\n<blockquote>\n<p>The returned stream encapsulates a Reader.  If timely disposal of file system resources is required, the try-with-resources construct should be used to ensure that the stream’s <code>Stream#close</code> method is invoked  after the stream operations are completed.</p>\n</blockquote>\n<p>如果需要及时地清理系统的资源， 可以使用java7中引入的<code>try-with-resources</code>, 来确保<code>Stream</code>的<code>close</code>方法在使用完后被调用。</p>\n<p><code>Files.lines</code>是惰性的， 当你使用的时候才去读取， 所以需要手动的关闭流， <code>Files.readAllLines</code>这个方法则是一次把文件<br>中的所有行读取到内存中去，并且会自动的关闭文件。</p>\n<p><code>Files.readAllLines</code>的函数说明中就保证了底层的文件一定会被关闭。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Read all lines from a file. This method ensures that the file is</span></span><br><span class=\"line\"><span class=\"comment\">    * closed when all bytes have been read or an I/O error, or other runtime</span></span><br><span class=\"line\"><span class=\"comment\">    * exception, is thrown. Bytes from the file are decoded into characters</span></span><br><span class=\"line\"><span class=\"comment\">    * using the specified charset.</span></span><br><span class=\"line\"><span class=\"comment\">    **/</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>使用java7中引入的<code>try-with-resoucres</code>, 实现了<code>AutoCloseable</code>接口的都会被自动的关闭</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> ( Stream&lt;String&gt; stream = Files.lines(path, charset) ) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// do something</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://stackoverflow.com/questions/38698182/close-java-8-stream\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Close Java 8 Stream - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/37659872/do-i-have-to-close-terminated-streamed-query-results-in-a-try-with-resources-bl\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">java - Do I have to close terminated, streamed query results in a try-with-resources-block? - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://calvin1978.blogcn.com/articles/latency2.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">在你的代码之外，服务时延过长的三个追查方向(下) | 江南白衣</a></p>\n</li>\n</ol>\n"},{"title":"jinfo使用","toc":true,"date":"2017-11-26T15:02:14.000Z","_content":"\n\n## 查看最终生效的flag\n\n`sudo -u tomcat jinfo pid`\n\n```\nAttaching to process ID 30350, please wait...\nDebugger attached successfully.\nServer compiler detected.\nJVM version is 24.45-b08\n...\n...\nsun.cpu.endian = little\npackage.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.tomcat.,org.apache.jasper.,sun.beans.\nsun.cpu.isalist = \n\nVM Flags:\n\n-Djava.util.logging.config.file=/tomcat/www/application/conf/logging.properties -Xms6g -Xmx6g -Xmn4g -XX:PermSize=256m -XX:MaxPermSize=256M ... -Djava.io.tmpdir=/tomcat/www/application/temp\n\n```\n\n### java -XX:+PrintFlagsFinal\n\n使用`-version`可以查看java支持的开关\n\n```\njava -XX:+PrintFlagsFinal -version\n```\n\n输出如下：\n\n```\n➜  qsli.github.com (hexo|✚6…) java -XX:+PrintFlagsFinal -version\n[Global flags]\n    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   {product}\n    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  {product}\n    uintx AdaptiveSizePausePolicy                   = 0                                   {product}\n    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  {product}\n    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  {product}\n    ...\n    ...\n    ...\n    uintx YoungGenerationSizeSupplementDecay        = 8                                   {product}\n    uintx YoungPLABSize                             = 4096                                {product}\n     bool ZeroTLAB                                  = false                               {product}\n     intx hashCode                                  = 5                                   {product}\njava version \"1.8.0_112\"\nJava(TM) SE Runtime Environment (build 1.8.0_112-b15)\nJava HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)\n```\n\n但是`白衣大侠`说，`-version`的结果可能不准确，最好实际跑一下。\n\n>经常以类似下面的语句去查看参数，偷懒不起应用，用-version代替。有些参数设置后会影响其他参数，所以查看时也把它带上。\n\n```\njava -server -Xmx1024m -Xms1024m -XX:+UseConcMarkSweepGC -XX:+PrintFlagsFinal -version| grep ParallelGCThreads\n```\n\n## 动态打开jvm的开关\n\njinfo可以动态的改变jvm的flag， 而不必重启服务器。虽然只对一些特定的flag有效，但是有的时候也很有用。\n\n支持动态开启和关闭的的flag，可以通过下面的命令查看。\n\n`java -XX:+PrintFlagsFinal -version | grep managed`\n\n```\nqsli.github.com (hexo|✚6…) java -XX:+PrintFlagsInitial | grep manageable\n     intx CMSAbortablePrecleanWaitMillis            = 100                                 {manageable}\n     intx CMSTriggerInterval                        = -1                                  {manageable}\n     intx CMSWaitDuration                           = 2000                                {manageable}\n     bool HeapDumpAfterFullGC                       = false                               {manageable}\n     bool HeapDumpBeforeFullGC                      = false                               {manageable}\n     bool HeapDumpOnOutOfMemoryError                = false                               {manageable}\n    ccstr HeapDumpPath                              =                                     {manageable}\n    uintx MaxHeapFreeRatio                          = 70                                  {manageable}\n    uintx MinHeapFreeRatio                          = 40                                  {manageable}\n     bool PrintClassHistogram                       = false                               {manageable}\n     bool PrintClassHistogramAfterFullGC            = false                               {manageable}\n     bool PrintClassHistogramBeforeFullGC           = false                               {manageable}\n     bool PrintConcurrentLocks                      = false                               {manageable}\n     bool PrintGC                                   = false                               {manageable}\n     bool PrintGCDateStamps                         = false                               {manageable}\n     bool PrintGCDetails                            = false                               {manageable}\n     bool PrintGCID                                 = false                               {manageable}\n     bool PrintGCTimeStamps                         = false                               {manageable}\n```\n\n用`JConsole`打开，可以看到相应的`MXBean`节点:\n\n{%  asset_img   jinfo.png  %}\n\n使用代码也可以获取对应的值：\n\n```java\n/**\n * @author afei\n * @version 1.0.0\n * @since 2017年07月25日\n */\npublic class DiagnosticOptionsTest {\n\n    public static void main(String[] args) {\n        HotSpotDiagnostic mxBean = new HotSpotDiagnostic();\n        List<VMOption> diagnosticVMOptions = mxBean.getDiagnosticOptions();\n        for (VMOption vmOption:diagnosticVMOptions){\n            System.out.println(vmOption.getName() + \" = \" + vmOption.getValue());\n        }\n    }\n}\n```\n\n>代码拷贝自参考1\n\n然后就可以使用下面的命令，打开或者关闭相应的开关\n\n```\n -flag [+|-]name\n             enables or disables the given boolean command line flag.\n```\n\n比如：\n\n```bash\n  sudo -u tomcat jinfo -flag  -PrintGC `pgrep -f tomcat`\n  sudo -u tomcat jinfo -flag  +PrintGC `pgrep -f tomcat`\n```\n\n## 参考\n\n1. [jinfo命令详解 - 简书](http://www.jianshu.com/p/c321d0808a1b)\n\n2. [Java调优经验谈](http://mp.weixin.qq.com/s?__biz=MzU3NDAxMzU1Nw==&mid=2247484957&idx=3&sn=ee1e459b6e579555b7006cb69a6bb7f1&chksm=fd39af07ca4e2611707621a71dedfa7329668d741fa2b4bdc9835ef14583cf79adb378d8d6c6&mpshare=1&scene=1&srcid=1123RfpGGNhu1XF30IA20OFH#rd)\n\n3. [通过jinfo工具在full GC前后做heap dump - Script Ahead, Code Behind - ITeye博客](http://rednaxelafx.iteye.com/blog/1049240)\n\n4. [关键业务系统的JVM参数推荐(2016热冬版）](http://mp.weixin.qq.com/s?__biz=MzIzODYyNjkzNw==&mid=2247483687&idx=1&sn=41f24dac62c0ca65e4dfe32eae62f3f2&chksm=e9373031de40b927497e5b9aa5dacae6e0a5bac8c760e05ae1d983baf700f45fe8f6c1cfca41&mpshare=1&scene=1&srcid=0904E8auyJdEzKjyytGtjpVO#rd)","source":"_posts/jinfo.md","raw":"title: jinfo使用\ntags: jinfo\ncategory: java\ntoc: true\ndate: 2017-11-26 23:02:14\n---\n\n\n## 查看最终生效的flag\n\n`sudo -u tomcat jinfo pid`\n\n```\nAttaching to process ID 30350, please wait...\nDebugger attached successfully.\nServer compiler detected.\nJVM version is 24.45-b08\n...\n...\nsun.cpu.endian = little\npackage.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.tomcat.,org.apache.jasper.,sun.beans.\nsun.cpu.isalist = \n\nVM Flags:\n\n-Djava.util.logging.config.file=/tomcat/www/application/conf/logging.properties -Xms6g -Xmx6g -Xmn4g -XX:PermSize=256m -XX:MaxPermSize=256M ... -Djava.io.tmpdir=/tomcat/www/application/temp\n\n```\n\n### java -XX:+PrintFlagsFinal\n\n使用`-version`可以查看java支持的开关\n\n```\njava -XX:+PrintFlagsFinal -version\n```\n\n输出如下：\n\n```\n➜  qsli.github.com (hexo|✚6…) java -XX:+PrintFlagsFinal -version\n[Global flags]\n    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   {product}\n    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  {product}\n    uintx AdaptiveSizePausePolicy                   = 0                                   {product}\n    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  {product}\n    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  {product}\n    ...\n    ...\n    ...\n    uintx YoungGenerationSizeSupplementDecay        = 8                                   {product}\n    uintx YoungPLABSize                             = 4096                                {product}\n     bool ZeroTLAB                                  = false                               {product}\n     intx hashCode                                  = 5                                   {product}\njava version \"1.8.0_112\"\nJava(TM) SE Runtime Environment (build 1.8.0_112-b15)\nJava HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)\n```\n\n但是`白衣大侠`说，`-version`的结果可能不准确，最好实际跑一下。\n\n>经常以类似下面的语句去查看参数，偷懒不起应用，用-version代替。有些参数设置后会影响其他参数，所以查看时也把它带上。\n\n```\njava -server -Xmx1024m -Xms1024m -XX:+UseConcMarkSweepGC -XX:+PrintFlagsFinal -version| grep ParallelGCThreads\n```\n\n## 动态打开jvm的开关\n\njinfo可以动态的改变jvm的flag， 而不必重启服务器。虽然只对一些特定的flag有效，但是有的时候也很有用。\n\n支持动态开启和关闭的的flag，可以通过下面的命令查看。\n\n`java -XX:+PrintFlagsFinal -version | grep managed`\n\n```\nqsli.github.com (hexo|✚6…) java -XX:+PrintFlagsInitial | grep manageable\n     intx CMSAbortablePrecleanWaitMillis            = 100                                 {manageable}\n     intx CMSTriggerInterval                        = -1                                  {manageable}\n     intx CMSWaitDuration                           = 2000                                {manageable}\n     bool HeapDumpAfterFullGC                       = false                               {manageable}\n     bool HeapDumpBeforeFullGC                      = false                               {manageable}\n     bool HeapDumpOnOutOfMemoryError                = false                               {manageable}\n    ccstr HeapDumpPath                              =                                     {manageable}\n    uintx MaxHeapFreeRatio                          = 70                                  {manageable}\n    uintx MinHeapFreeRatio                          = 40                                  {manageable}\n     bool PrintClassHistogram                       = false                               {manageable}\n     bool PrintClassHistogramAfterFullGC            = false                               {manageable}\n     bool PrintClassHistogramBeforeFullGC           = false                               {manageable}\n     bool PrintConcurrentLocks                      = false                               {manageable}\n     bool PrintGC                                   = false                               {manageable}\n     bool PrintGCDateStamps                         = false                               {manageable}\n     bool PrintGCDetails                            = false                               {manageable}\n     bool PrintGCID                                 = false                               {manageable}\n     bool PrintGCTimeStamps                         = false                               {manageable}\n```\n\n用`JConsole`打开，可以看到相应的`MXBean`节点:\n\n{%  asset_img   jinfo.png  %}\n\n使用代码也可以获取对应的值：\n\n```java\n/**\n * @author afei\n * @version 1.0.0\n * @since 2017年07月25日\n */\npublic class DiagnosticOptionsTest {\n\n    public static void main(String[] args) {\n        HotSpotDiagnostic mxBean = new HotSpotDiagnostic();\n        List<VMOption> diagnosticVMOptions = mxBean.getDiagnosticOptions();\n        for (VMOption vmOption:diagnosticVMOptions){\n            System.out.println(vmOption.getName() + \" = \" + vmOption.getValue());\n        }\n    }\n}\n```\n\n>代码拷贝自参考1\n\n然后就可以使用下面的命令，打开或者关闭相应的开关\n\n```\n -flag [+|-]name\n             enables or disables the given boolean command line flag.\n```\n\n比如：\n\n```bash\n  sudo -u tomcat jinfo -flag  -PrintGC `pgrep -f tomcat`\n  sudo -u tomcat jinfo -flag  +PrintGC `pgrep -f tomcat`\n```\n\n## 参考\n\n1. [jinfo命令详解 - 简书](http://www.jianshu.com/p/c321d0808a1b)\n\n2. [Java调优经验谈](http://mp.weixin.qq.com/s?__biz=MzU3NDAxMzU1Nw==&mid=2247484957&idx=3&sn=ee1e459b6e579555b7006cb69a6bb7f1&chksm=fd39af07ca4e2611707621a71dedfa7329668d741fa2b4bdc9835ef14583cf79adb378d8d6c6&mpshare=1&scene=1&srcid=1123RfpGGNhu1XF30IA20OFH#rd)\n\n3. [通过jinfo工具在full GC前后做heap dump - Script Ahead, Code Behind - ITeye博客](http://rednaxelafx.iteye.com/blog/1049240)\n\n4. [关键业务系统的JVM参数推荐(2016热冬版）](http://mp.weixin.qq.com/s?__biz=MzIzODYyNjkzNw==&mid=2247483687&idx=1&sn=41f24dac62c0ca65e4dfe32eae62f3f2&chksm=e9373031de40b927497e5b9aa5dacae6e0a5bac8c760e05ae1d983baf700f45fe8f6c1cfca41&mpshare=1&scene=1&srcid=0904E8auyJdEzKjyytGtjpVO#rd)","slug":"jinfo","published":1,"updated":"2017-11-26T15:21:01.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9s007djh4kjd2ntuhp","content":"<h2 id=\"查看最终生效的flag\"><a href=\"#查看最终生效的flag\" class=\"headerlink\" title=\"查看最终生效的flag\"></a>查看最终生效的flag</h2><p><code>sudo -u tomcat jinfo pid</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Attaching to process ID 30350, please wait...</span><br><span class=\"line\">Debugger attached successfully.</span><br><span class=\"line\">Server compiler detected.</span><br><span class=\"line\">JVM version is 24.45-b08</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">sun.cpu.endian = little</span><br><span class=\"line\">package.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.tomcat.,org.apache.jasper.,sun.beans.</span><br><span class=\"line\">sun.cpu.isalist = </span><br><span class=\"line\"></span><br><span class=\"line\">VM Flags:</span><br><span class=\"line\"></span><br><span class=\"line\">-Djava.util.logging.config.file=/tomcat/www/application/conf/logging.properties -Xms6g -Xmx6g -Xmn4g -XX:PermSize=256m -XX:MaxPermSize=256M ... -Djava.io.tmpdir=/tomcat/www/application/temp</span><br></pre></td></tr></table></figure>\n<h3 id=\"java-XX-PrintFlagsFinal\"><a href=\"#java-XX-PrintFlagsFinal\" class=\"headerlink\" title=\"java -XX:+PrintFlagsFinal\"></a>java -XX:+PrintFlagsFinal</h3><p>使用<code>-version</code>可以查看java支持的开关</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -XX:+PrintFlagsFinal -version</span><br></pre></td></tr></table></figure>\n<p>输出如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  qsli.github.com (hexo|✚6…) java -XX:+PrintFlagsFinal -version</span><br><span class=\"line\">[Global flags]</span><br><span class=\"line\">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    uintx YoungGenerationSizeSupplementDecay        = 8                                   &#123;product&#125;</span><br><span class=\"line\">    uintx YoungPLABSize                             = 4096                                &#123;product&#125;</span><br><span class=\"line\">     bool ZeroTLAB                                  = false                               &#123;product&#125;</span><br><span class=\"line\">     intx hashCode                                  = 5                                   &#123;product&#125;</span><br><span class=\"line\">java version &quot;1.8.0_112&quot;</span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_112-b15)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)</span><br></pre></td></tr></table></figure>\n<p>但是<code>白衣大侠</code>说，<code>-version</code>的结果可能不准确，最好实际跑一下。</p>\n<blockquote>\n<p>经常以类似下面的语句去查看参数，偷懒不起应用，用-version代替。有些参数设置后会影响其他参数，所以查看时也把它带上。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -server -Xmx1024m -Xms1024m -XX:+UseConcMarkSweepGC -XX:+PrintFlagsFinal -version| grep ParallelGCThreads</span><br></pre></td></tr></table></figure>\n<h2 id=\"动态打开jvm的开关\"><a href=\"#动态打开jvm的开关\" class=\"headerlink\" title=\"动态打开jvm的开关\"></a>动态打开jvm的开关</h2><p>jinfo可以动态的改变jvm的flag， 而不必重启服务器。虽然只对一些特定的flag有效，但是有的时候也很有用。</p>\n<p>支持动态开启和关闭的的flag，可以通过下面的命令查看。</p>\n<p><code>java -XX:+PrintFlagsFinal -version | grep managed</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qsli.github.com (hexo|✚6…) java -XX:+PrintFlagsInitial | grep manageable</span><br><span class=\"line\">     intx CMSAbortablePrecleanWaitMillis            = 100                                 &#123;manageable&#125;</span><br><span class=\"line\">     intx CMSTriggerInterval                        = -1                                  &#123;manageable&#125;</span><br><span class=\"line\">     intx CMSWaitDuration                           = 2000                                &#123;manageable&#125;</span><br><span class=\"line\">     bool HeapDumpAfterFullGC                       = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool HeapDumpBeforeFullGC                      = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool HeapDumpOnOutOfMemoryError                = false                               &#123;manageable&#125;</span><br><span class=\"line\">    ccstr HeapDumpPath                              =                                     &#123;manageable&#125;</span><br><span class=\"line\">    uintx MaxHeapFreeRatio                          = 70                                  &#123;manageable&#125;</span><br><span class=\"line\">    uintx MinHeapFreeRatio                          = 40                                  &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintClassHistogram                       = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintClassHistogramAfterFullGC            = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintClassHistogramBeforeFullGC           = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintConcurrentLocks                      = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGC                                   = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCDateStamps                         = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCDetails                            = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCID                                 = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCTimeStamps                         = false                               &#123;manageable&#125;</span><br></pre></td></tr></table></figure>\n<p>用<code>JConsole</code>打开，可以看到相应的<code>MXBean</code>节点:</p>\n<img src=\"/2017/11/26/jinfo/jinfo.png\">\n<p>使用代码也可以获取对应的值：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> afei</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@version</span> 1.0.0</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> 2017年07月25日</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DiagnosticOptionsTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        HotSpotDiagnostic mxBean = <span class=\"keyword\">new</span> HotSpotDiagnostic();</span><br><span class=\"line\">        List&lt;VMOption&gt; diagnosticVMOptions = mxBean.getDiagnosticOptions();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (VMOption vmOption:diagnosticVMOptions)&#123;</span><br><span class=\"line\">            System.out.println(vmOption.getName() + <span class=\"string\">\" = \"</span> + vmOption.getValue());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>代码拷贝自参考1</p>\n</blockquote>\n<p>然后就可以使用下面的命令，打开或者关闭相应的开关</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-flag [+|-]name</span><br><span class=\"line\">            enables or disables the given boolean command line flag.</span><br></pre></td></tr></table></figure>\n<p>比如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat jinfo -flag  -PrintGC `pgrep -f tomcat`</span><br><span class=\"line\">sudo -u tomcat jinfo -flag  +PrintGC `pgrep -f tomcat`</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.jianshu.com/p/c321d0808a1b\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">jinfo命令详解 - 简书</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzU3NDAxMzU1Nw==&amp;mid=2247484957&amp;idx=3&amp;sn=ee1e459b6e579555b7006cb69a6bb7f1&amp;chksm=fd39af07ca4e2611707621a71dedfa7329668d741fa2b4bdc9835ef14583cf79adb378d8d6c6&amp;mpshare=1&amp;scene=1&amp;srcid=1123RfpGGNhu1XF30IA20OFH#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java调优经验谈</a></p>\n</li>\n<li><p><a href=\"http://rednaxelafx.iteye.com/blog/1049240\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">通过jinfo工具在full GC前后做heap dump - Script Ahead, Code Behind - ITeye博客</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzIzODYyNjkzNw==&amp;mid=2247483687&amp;idx=1&amp;sn=41f24dac62c0ca65e4dfe32eae62f3f2&amp;chksm=e9373031de40b927497e5b9aa5dacae6e0a5bac8c760e05ae1d983baf700f45fe8f6c1cfca41&amp;mpshare=1&amp;scene=1&amp;srcid=0904E8auyJdEzKjyytGtjpVO#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">关键业务系统的JVM参数推荐(2016热冬版）</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"查看最终生效的flag\"><a href=\"#查看最终生效的flag\" class=\"headerlink\" title=\"查看最终生效的flag\"></a>查看最终生效的flag</h2><p><code>sudo -u tomcat jinfo pid</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Attaching to process ID 30350, please wait...</span><br><span class=\"line\">Debugger attached successfully.</span><br><span class=\"line\">Server compiler detected.</span><br><span class=\"line\">JVM version is 24.45-b08</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">sun.cpu.endian = little</span><br><span class=\"line\">package.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.tomcat.,org.apache.jasper.,sun.beans.</span><br><span class=\"line\">sun.cpu.isalist = </span><br><span class=\"line\"></span><br><span class=\"line\">VM Flags:</span><br><span class=\"line\"></span><br><span class=\"line\">-Djava.util.logging.config.file=/tomcat/www/application/conf/logging.properties -Xms6g -Xmx6g -Xmn4g -XX:PermSize=256m -XX:MaxPermSize=256M ... -Djava.io.tmpdir=/tomcat/www/application/temp</span><br></pre></td></tr></table></figure>\n<h3 id=\"java-XX-PrintFlagsFinal\"><a href=\"#java-XX-PrintFlagsFinal\" class=\"headerlink\" title=\"java -XX:+PrintFlagsFinal\"></a>java -XX:+PrintFlagsFinal</h3><p>使用<code>-version</code>可以查看java支持的开关</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -XX:+PrintFlagsFinal -version</span><br></pre></td></tr></table></figure>\n<p>输出如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  qsli.github.com (hexo|✚6…) java -XX:+PrintFlagsFinal -version</span><br><span class=\"line\">[Global flags]</span><br><span class=\"line\">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class=\"line\">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    uintx YoungGenerationSizeSupplementDecay        = 8                                   &#123;product&#125;</span><br><span class=\"line\">    uintx YoungPLABSize                             = 4096                                &#123;product&#125;</span><br><span class=\"line\">     bool ZeroTLAB                                  = false                               &#123;product&#125;</span><br><span class=\"line\">     intx hashCode                                  = 5                                   &#123;product&#125;</span><br><span class=\"line\">java version &quot;1.8.0_112&quot;</span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_112-b15)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)</span><br></pre></td></tr></table></figure>\n<p>但是<code>白衣大侠</code>说，<code>-version</code>的结果可能不准确，最好实际跑一下。</p>\n<blockquote>\n<p>经常以类似下面的语句去查看参数，偷懒不起应用，用-version代替。有些参数设置后会影响其他参数，所以查看时也把它带上。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -server -Xmx1024m -Xms1024m -XX:+UseConcMarkSweepGC -XX:+PrintFlagsFinal -version| grep ParallelGCThreads</span><br></pre></td></tr></table></figure>\n<h2 id=\"动态打开jvm的开关\"><a href=\"#动态打开jvm的开关\" class=\"headerlink\" title=\"动态打开jvm的开关\"></a>动态打开jvm的开关</h2><p>jinfo可以动态的改变jvm的flag， 而不必重启服务器。虽然只对一些特定的flag有效，但是有的时候也很有用。</p>\n<p>支持动态开启和关闭的的flag，可以通过下面的命令查看。</p>\n<p><code>java -XX:+PrintFlagsFinal -version | grep managed</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qsli.github.com (hexo|✚6…) java -XX:+PrintFlagsInitial | grep manageable</span><br><span class=\"line\">     intx CMSAbortablePrecleanWaitMillis            = 100                                 &#123;manageable&#125;</span><br><span class=\"line\">     intx CMSTriggerInterval                        = -1                                  &#123;manageable&#125;</span><br><span class=\"line\">     intx CMSWaitDuration                           = 2000                                &#123;manageable&#125;</span><br><span class=\"line\">     bool HeapDumpAfterFullGC                       = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool HeapDumpBeforeFullGC                      = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool HeapDumpOnOutOfMemoryError                = false                               &#123;manageable&#125;</span><br><span class=\"line\">    ccstr HeapDumpPath                              =                                     &#123;manageable&#125;</span><br><span class=\"line\">    uintx MaxHeapFreeRatio                          = 70                                  &#123;manageable&#125;</span><br><span class=\"line\">    uintx MinHeapFreeRatio                          = 40                                  &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintClassHistogram                       = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintClassHistogramAfterFullGC            = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintClassHistogramBeforeFullGC           = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintConcurrentLocks                      = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGC                                   = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCDateStamps                         = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCDetails                            = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCID                                 = false                               &#123;manageable&#125;</span><br><span class=\"line\">     bool PrintGCTimeStamps                         = false                               &#123;manageable&#125;</span><br></pre></td></tr></table></figure>\n<p>用<code>JConsole</code>打开，可以看到相应的<code>MXBean</code>节点:</p>\n<img src=\"/2017/11/26/jinfo/jinfo.png\">\n<p>使用代码也可以获取对应的值：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> afei</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@version</span> 1.0.0</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> 2017年07月25日</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DiagnosticOptionsTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        HotSpotDiagnostic mxBean = <span class=\"keyword\">new</span> HotSpotDiagnostic();</span><br><span class=\"line\">        List&lt;VMOption&gt; diagnosticVMOptions = mxBean.getDiagnosticOptions();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (VMOption vmOption:diagnosticVMOptions)&#123;</span><br><span class=\"line\">            System.out.println(vmOption.getName() + <span class=\"string\">\" = \"</span> + vmOption.getValue());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>代码拷贝自参考1</p>\n</blockquote>\n<p>然后就可以使用下面的命令，打开或者关闭相应的开关</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-flag [+|-]name</span><br><span class=\"line\">            enables or disables the given boolean command line flag.</span><br></pre></td></tr></table></figure>\n<p>比如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat jinfo -flag  -PrintGC `pgrep -f tomcat`</span><br><span class=\"line\">sudo -u tomcat jinfo -flag  +PrintGC `pgrep -f tomcat`</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.jianshu.com/p/c321d0808a1b\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">jinfo命令详解 - 简书</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzU3NDAxMzU1Nw==&amp;mid=2247484957&amp;idx=3&amp;sn=ee1e459b6e579555b7006cb69a6bb7f1&amp;chksm=fd39af07ca4e2611707621a71dedfa7329668d741fa2b4bdc9835ef14583cf79adb378d8d6c6&amp;mpshare=1&amp;scene=1&amp;srcid=1123RfpGGNhu1XF30IA20OFH#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java调优经验谈</a></p>\n</li>\n<li><p><a href=\"http://rednaxelafx.iteye.com/blog/1049240\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">通过jinfo工具在full GC前后做heap dump - Script Ahead, Code Behind - ITeye博客</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzIzODYyNjkzNw==&amp;mid=2247483687&amp;idx=1&amp;sn=41f24dac62c0ca65e4dfe32eae62f3f2&amp;chksm=e9373031de40b927497e5b9aa5dacae6e0a5bac8c760e05ae1d983baf700f45fe8f6c1cfca41&amp;mpshare=1&amp;scene=1&amp;srcid=0904E8auyJdEzKjyytGtjpVO#rd\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">关键业务系统的JVM参数推荐(2016热冬版）</a></p>\n</li>\n</ol>\n"},{"title":"JS跨域原理","toc":true,"abbrlink":64763,"date":"2016-10-02T03:42:13.000Z","_content":"\n\n## 同源策略\n\n>同源策略限制了一个源（origin）中加载文本或脚本与来自其它源（origin）中资源的交互方式。\n\n例如在使用XMLHttpRequest 或 <img> 标签时则会受到同源策略的约束。交互通常分为三类：\n\n1. 通常允许进行跨域写操作（`Cross-origin writes`）。例如链接（links），重定向以及表单提交。特定少数的HTTP请求需要添加 preflight。\n\n2. 通常允许跨域资源嵌入（`Cross-origin embedding`）。\n3. 通常不允许跨域读操作（`Cross-origin reads`）。\n\n下表给出了相对`http://store.company.com/dir/page.html`同源检测的示例:\n\n|URL\t|结果|\t原因|\n|---|---|\n|http://store.company.com/dir2/other.html\t|成功|\t |\n|http://store.company.com/dir/inner/another.html\t|成功|\t |\n|https://store.company.com/secure.html\t|失败|\t协议不同|\n|http://store.company.com:81/dir/etc.html\t|失败|\t端口不同|\n|http://news.company.com/dir/other.html\t|失败|\t主机名不同|\n\n\n\n## ajax 跨域\n\n> 同源政策规定，AJAX请求只能发给同源的网址，否则就报错。\n\n请求其他域资源的时候，由于同源策略的限制一般会出现如下的错误：\n\n>XMLHttpRequest cannot load http://xxxxx. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'null' is therefore not allowed access. The response had HTTP status code 500.\n\n### JSONP\n\n`<script src=\"...\"></script>` 标签是支持跨域的，JSONP的原理就是使用这个标签。\n\n服务器会在传给浏览器前将JSON数据填充到回调函数中\n\n{% gist cc896797f4ef746e9cbc75b8f6ebc24f %}\n\n上述代码中`    return param + '(' + json.dumps(data) + ')'`是将返回的数据填充到回调函数中\n\n前端的代码如下：\n\n{% gist 8d90c2a0599818488a647177b4f196c2 %}\n\n使用了jQuery的ajax请求\n\n**但是JSONP的方式只支持get请求**\n\n### CORS (`Cross-Origin Resource Sharing`)\n\nCORS是一个W3C标准, 不仅支持GET方式还支持POST方式的跨域请求\n\n> 浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。\n\n请求的流程图如下：\n{%  asset_img   cors.png  %}\n\n\n\n\n详细原理参考阮一峰老师的[跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html)\n\n### Websocket\n\n>WebSocket是一种通信协议，使用ws://（非加密）和wss://（加密）作为协议前缀。该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。\n\n详细原理参考阮一峰老师的 [浏览器的同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)\n\n## 参考链接\n\n1. [跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html)\n\n2. [浏览器的同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)\n\n3. [浏览器同源政策及其规避方法](http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html)\n\n4. [ ajax 设置Access-Control-Allow-Origin实现跨域访问](http://blog.csdn.net/fdipzone/article/details/46390573)\n\n5. [使用CORS（译）](http://liuwanlin.info/corsxiang-jie/)\n","source":"_posts/jsonp.md","raw":"---\ntitle: JS跨域原理\ntags: ajax\ncategory: fe\ntoc: true\nabbrlink: 64763\ndate: 2016-10-02 11:42:13\n---\n\n\n## 同源策略\n\n>同源策略限制了一个源（origin）中加载文本或脚本与来自其它源（origin）中资源的交互方式。\n\n例如在使用XMLHttpRequest 或 <img> 标签时则会受到同源策略的约束。交互通常分为三类：\n\n1. 通常允许进行跨域写操作（`Cross-origin writes`）。例如链接（links），重定向以及表单提交。特定少数的HTTP请求需要添加 preflight。\n\n2. 通常允许跨域资源嵌入（`Cross-origin embedding`）。\n3. 通常不允许跨域读操作（`Cross-origin reads`）。\n\n下表给出了相对`http://store.company.com/dir/page.html`同源检测的示例:\n\n|URL\t|结果|\t原因|\n|---|---|\n|http://store.company.com/dir2/other.html\t|成功|\t |\n|http://store.company.com/dir/inner/another.html\t|成功|\t |\n|https://store.company.com/secure.html\t|失败|\t协议不同|\n|http://store.company.com:81/dir/etc.html\t|失败|\t端口不同|\n|http://news.company.com/dir/other.html\t|失败|\t主机名不同|\n\n\n\n## ajax 跨域\n\n> 同源政策规定，AJAX请求只能发给同源的网址，否则就报错。\n\n请求其他域资源的时候，由于同源策略的限制一般会出现如下的错误：\n\n>XMLHttpRequest cannot load http://xxxxx. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'null' is therefore not allowed access. The response had HTTP status code 500.\n\n### JSONP\n\n`<script src=\"...\"></script>` 标签是支持跨域的，JSONP的原理就是使用这个标签。\n\n服务器会在传给浏览器前将JSON数据填充到回调函数中\n\n{% gist cc896797f4ef746e9cbc75b8f6ebc24f %}\n\n上述代码中`    return param + '(' + json.dumps(data) + ')'`是将返回的数据填充到回调函数中\n\n前端的代码如下：\n\n{% gist 8d90c2a0599818488a647177b4f196c2 %}\n\n使用了jQuery的ajax请求\n\n**但是JSONP的方式只支持get请求**\n\n### CORS (`Cross-Origin Resource Sharing`)\n\nCORS是一个W3C标准, 不仅支持GET方式还支持POST方式的跨域请求\n\n> 浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。\n\n请求的流程图如下：\n{%  asset_img   cors.png  %}\n\n\n\n\n详细原理参考阮一峰老师的[跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html)\n\n### Websocket\n\n>WebSocket是一种通信协议，使用ws://（非加密）和wss://（加密）作为协议前缀。该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。\n\n详细原理参考阮一峰老师的 [浏览器的同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)\n\n## 参考链接\n\n1. [跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html)\n\n2. [浏览器的同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)\n\n3. [浏览器同源政策及其规避方法](http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html)\n\n4. [ ajax 设置Access-Control-Allow-Origin实现跨域访问](http://blog.csdn.net/fdipzone/article/details/46390573)\n\n5. [使用CORS（译）](http://liuwanlin.info/corsxiang-jie/)\n","slug":"jsonp","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9t007gjh4kf94awg4u","content":"<h2 id=\"同源策略\"><a href=\"#同源策略\" class=\"headerlink\" title=\"同源策略\"></a>同源策略</h2><blockquote>\n<p>同源策略限制了一个源（origin）中加载文本或脚本与来自其它源（origin）中资源的交互方式。</p>\n</blockquote>\n<p>例如在使用XMLHttpRequest 或 <img> 标签时则会受到同源策略的约束。交互通常分为三类：</p>\n<ol>\n<li><p>通常允许进行跨域写操作（<code>Cross-origin writes</code>）。例如链接（links），重定向以及表单提交。特定少数的HTTP请求需要添加 preflight。</p>\n</li>\n<li><p>通常允许跨域资源嵌入（<code>Cross-origin embedding</code>）。</p>\n</li>\n<li>通常不允许跨域读操作（<code>Cross-origin reads</code>）。</li>\n</ol>\n<p>下表给出了相对<code>http://store.company.com/dir/page.html</code>同源检测的示例:</p>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>结果</th>\n<th>原因</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"http://store.company.com/dir2/other.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://store.company.com/dir2/other.html</a></td>\n<td>成功</td>\n<td></td>\n</tr>\n<tr>\n<td><a href=\"http://store.company.com/dir/inner/another.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://store.company.com/dir/inner/another.html</a></td>\n<td>成功</td>\n<td></td>\n</tr>\n<tr>\n<td><a href=\"https://store.company.com/secure.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://store.company.com/secure.html</a></td>\n<td>失败</td>\n<td>协议不同</td>\n</tr>\n<tr>\n<td><a href=\"http://store.company.com:81/dir/etc.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://store.company.com:81/dir/etc.html</a></td>\n<td>失败</td>\n<td>端口不同</td>\n</tr>\n<tr>\n<td><a href=\"http://news.company.com/dir/other.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://news.company.com/dir/other.html</a></td>\n<td>失败</td>\n<td>主机名不同</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"ajax-跨域\"><a href=\"#ajax-跨域\" class=\"headerlink\" title=\"ajax 跨域\"></a>ajax 跨域</h2><blockquote>\n<p>同源政策规定，AJAX请求只能发给同源的网址，否则就报错。</p>\n</blockquote>\n<p>请求其他域资源的时候，由于同源策略的限制一般会出现如下的错误：</p>\n<blockquote>\n<p>XMLHttpRequest cannot load <a href=\"http://xxxxx\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://xxxxx</a>. No ‘Access-Control-Allow-Origin’ header is present on the requested resource. Origin ‘null’ is therefore not allowed access. The response had HTTP status code 500.</p>\n</blockquote>\n<h3 id=\"JSONP\"><a href=\"#JSONP\" class=\"headerlink\" title=\"JSONP\"></a>JSONP</h3><p><code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> 标签是支持跨域的，JSONP的原理就是使用这个标签。</p>\n<p>服务器会在传给浏览器前将JSON数据填充到回调函数中</p>\n<script src=\"//gist.github.com/cc896797f4ef746e9cbc75b8f6ebc24f.js\"></script>\n<p>上述代码中<code>return param + &#39;(&#39; + json.dumps(data) + &#39;)&#39;</code>是将返回的数据填充到回调函数中</p>\n<p>前端的代码如下：</p>\n<script src=\"//gist.github.com/8d90c2a0599818488a647177b4f196c2.js\"></script>\n<p>使用了jQuery的ajax请求</p>\n<p><strong>但是JSONP的方式只支持get请求</strong></p>\n<h3 id=\"CORS-Cross-Origin-Resource-Sharing\"><a href=\"#CORS-Cross-Origin-Resource-Sharing\" class=\"headerlink\" title=\"CORS (Cross-Origin Resource Sharing)\"></a>CORS (<code>Cross-Origin Resource Sharing</code>)</h3><p>CORS是一个W3C标准, 不仅支持GET方式还支持POST方式的跨域请求</p>\n<blockquote>\n<p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>\n</blockquote>\n<p>请求的流程图如下：<br><img src=\"/2016/10/02/jsonp/cors.png\"></p>\n<p>详细原理参考阮一峰老师的<a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">跨域资源共享 CORS 详解</a></p>\n<h3 id=\"Websocket\"><a href=\"#Websocket\" class=\"headerlink\" title=\"Websocket\"></a>Websocket</h3><blockquote>\n<p>WebSocket是一种通信协议，使用ws://（非加密）和wss://（加密）作为协议前缀。该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。</p>\n</blockquote>\n<p>详细原理参考阮一峰老师的 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">浏览器的同源策略</a></p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">跨域资源共享 CORS 详解</a></p>\n</li>\n<li><p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">浏览器的同源策略</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">浏览器同源政策及其规避方法</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/fdipzone/article/details/46390573\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"> ajax 设置Access-Control-Allow-Origin实现跨域访问</a></p>\n</li>\n<li><p><a href=\"http://liuwanlin.info/corsxiang-jie/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">使用CORS（译）</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"同源策略\"><a href=\"#同源策略\" class=\"headerlink\" title=\"同源策略\"></a>同源策略</h2><blockquote>\n<p>同源策略限制了一个源（origin）中加载文本或脚本与来自其它源（origin）中资源的交互方式。</p>\n</blockquote>\n<p>例如在使用XMLHttpRequest 或 <img> 标签时则会受到同源策略的约束。交互通常分为三类：</p>\n<ol>\n<li><p>通常允许进行跨域写操作（<code>Cross-origin writes</code>）。例如链接（links），重定向以及表单提交。特定少数的HTTP请求需要添加 preflight。</p>\n</li>\n<li><p>通常允许跨域资源嵌入（<code>Cross-origin embedding</code>）。</p>\n</li>\n<li>通常不允许跨域读操作（<code>Cross-origin reads</code>）。</li>\n</ol>\n<p>下表给出了相对<code>http://store.company.com/dir/page.html</code>同源检测的示例:</p>\n<table>\n<thead>\n<tr>\n<th>URL</th>\n<th>结果</th>\n<th>原因</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"http://store.company.com/dir2/other.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://store.company.com/dir2/other.html</a></td>\n<td>成功</td>\n<td></td>\n</tr>\n<tr>\n<td><a href=\"http://store.company.com/dir/inner/another.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://store.company.com/dir/inner/another.html</a></td>\n<td>成功</td>\n<td></td>\n</tr>\n<tr>\n<td><a href=\"https://store.company.com/secure.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://store.company.com/secure.html</a></td>\n<td>失败</td>\n<td>协议不同</td>\n</tr>\n<tr>\n<td><a href=\"http://store.company.com:81/dir/etc.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://store.company.com:81/dir/etc.html</a></td>\n<td>失败</td>\n<td>端口不同</td>\n</tr>\n<tr>\n<td><a href=\"http://news.company.com/dir/other.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://news.company.com/dir/other.html</a></td>\n<td>失败</td>\n<td>主机名不同</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"ajax-跨域\"><a href=\"#ajax-跨域\" class=\"headerlink\" title=\"ajax 跨域\"></a>ajax 跨域</h2><blockquote>\n<p>同源政策规定，AJAX请求只能发给同源的网址，否则就报错。</p>\n</blockquote>\n<p>请求其他域资源的时候，由于同源策略的限制一般会出现如下的错误：</p>\n<blockquote>\n<p>XMLHttpRequest cannot load <a href=\"http://xxxxx\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://xxxxx</a>. No ‘Access-Control-Allow-Origin’ header is present on the requested resource. Origin ‘null’ is therefore not allowed access. The response had HTTP status code 500.</p>\n</blockquote>\n<h3 id=\"JSONP\"><a href=\"#JSONP\" class=\"headerlink\" title=\"JSONP\"></a>JSONP</h3><p><code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> 标签是支持跨域的，JSONP的原理就是使用这个标签。</p>\n<p>服务器会在传给浏览器前将JSON数据填充到回调函数中</p>\n<script src=\"//gist.github.com/cc896797f4ef746e9cbc75b8f6ebc24f.js\"></script>\n<p>上述代码中<code>return param + &#39;(&#39; + json.dumps(data) + &#39;)&#39;</code>是将返回的数据填充到回调函数中</p>\n<p>前端的代码如下：</p>\n<script src=\"//gist.github.com/8d90c2a0599818488a647177b4f196c2.js\"></script>\n<p>使用了jQuery的ajax请求</p>\n<p><strong>但是JSONP的方式只支持get请求</strong></p>\n<h3 id=\"CORS-Cross-Origin-Resource-Sharing\"><a href=\"#CORS-Cross-Origin-Resource-Sharing\" class=\"headerlink\" title=\"CORS (Cross-Origin Resource Sharing)\"></a>CORS (<code>Cross-Origin Resource Sharing</code>)</h3><p>CORS是一个W3C标准, 不仅支持GET方式还支持POST方式的跨域请求</p>\n<blockquote>\n<p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>\n</blockquote>\n<p>请求的流程图如下：<br><img src=\"/2016/10/02/jsonp/cors.png\"></p>\n<p>详细原理参考阮一峰老师的<a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">跨域资源共享 CORS 详解</a></p>\n<h3 id=\"Websocket\"><a href=\"#Websocket\" class=\"headerlink\" title=\"Websocket\"></a>Websocket</h3><blockquote>\n<p>WebSocket是一种通信协议，使用ws://（非加密）和wss://（加密）作为协议前缀。该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。</p>\n</blockquote>\n<p>详细原理参考阮一峰老师的 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">浏览器的同源策略</a></p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">跨域资源共享 CORS 详解</a></p>\n</li>\n<li><p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">浏览器的同源策略</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">浏览器同源政策及其规避方法</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/fdipzone/article/details/46390573\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"> ajax 设置Access-Control-Allow-Origin实现跨域访问</a></p>\n</li>\n<li><p><a href=\"http://liuwanlin.info/corsxiang-jie/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">使用CORS（译）</a></p>\n</li>\n</ol>\n"},{"title":"jvm-flag","toc":true,"abbrlink":50307,"date":"2017-06-02T17:29:51.000Z","_content":"\njinfo\n\n-Xss\n\n\n","source":"_posts/jvm-flag.md","raw":"---\ntitle: jvm-flag\ntoc: true\ncategory: java\nabbrlink: 50307\ndate: 2017-06-03 01:29:51\ntags:\n---\n\njinfo\n\n-Xss\n\n\n","slug":"jvm-flag","published":1,"updated":"2017-08-13T14:17:13.142Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9u007jjh4kwbu3k4vw","content":"<p>jinfo</p>\n<p>-Xss</p>\n","site":{"data":{}},"excerpt":"","more":"<p>jinfo</p>\n<p>-Xss</p>\n"},{"title":"Tomcat日志中异常堆栈不完整","toc":true,"date":"2017-12-02T17:02:29.000Z","_content":"\n\n## 现象\n\ntomcat的异常日志会打印到`catalina.out`中，有的时候发现日志的堆栈并不完整， 只能看到部分的堆栈信息。\n\n```\njava.lang.Exception: NullPointerException | 2390852_pd2390852_prc2390852_sr2390852_ncb2390852_pm45090051_pd45090051_prc45090051_sr45090051_ncb45090051_pm36619638_pd36619638_prc36619638_sr36619638_ncb36619638_pm1122394_pd1122394_prc1122394_sr1122394_ncb1122394_pm\n        ...\n        ...\n        at sun.reflect.GeneratedMethodAccessor481.invoke(Unknown Source) ~[na:na]\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_60]\n        at java.lang.reflect.Method.invoke(Method.java:497) ~[na:1.8.0_60]\n        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:110) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invoke\njava.lang.NullPointerException: null\n[2016-12-05 11:29:27][h_hprice_breeze_p_161205.112927.10.90.5.48.6486.595359_1][ESC[31mWARN ESC[0;39m]logX -> desc = SHotel 状态无效, data = hotelId[\n```\n\n可以看到这个`NPE`只打印了，一个message， 内部的堆栈都没有了，这样就无法根据堆栈信息找到对应的代码的位置。\n\n## 原因\n\n### jvm的优化\n\n>HotSpot虚拟机的JIT优化，把多次打的堆栈给优化掉了，往上Grep应该能Grep到完整的堆栈。\n\n#### 解决方案\n\n这种被优化调的堆栈，第一次都是打出来完整的，因此可以向上翻翻，应该是能找到完整的现场的。\n\n频繁的打印异常的堆栈，对系统性能也有较大的影响，不过如果不是生产环境，可以在jvm的启动参数后面加上\n\n```\n-XX:-OmitStackTraceInFastThrow \n```\n将这种优化主动关闭\n\n### 日志打的太快\n\n其实打到tomcat的`catalina.out`的应该是有两个日志框架，一个是tomcat自己带的，一个是应用的。\n\ntomcat自己带了一个日志的框架 —— `juli`\n\n自己的应用中一般也会用一个日志的框架，比如 —— `logback`\n\n这样就存在同时写入`catalina.out`文件的可能，`juli`日志刚打了一半， 就被`logback`打的日志穿插了。\n这样本来两行相邻的日志，就会差的十万八千里。\n\n>Tomcat 的内部日志使用 JULI 组件，这是一个 Apache Commons 日志的重命名的打包分支，默认被硬编码，使用 java.util.logging 架构。\n>这能保证 Tomcat 内部日志与 Web 应用的日志保持独立，即使 Web 应用使用的是 Apache Commons Logging。\n\n正是这个独立性，导致了日志有可能是乱的。\ntomcat加载内部的日志组件的加载器是`System class loader`，\n应用的日志组件的类加载器是`webapp class loader`，因此即使用的是同一套日志体系，相互之间应该还是隔离的。\n\n\nlogback的官方文档也说明了：\n\n>By virtue of class loader separation provided by the container, \n>each web-application will load its own copy of LoggerContext which will pickup its own copy of logback.xml.\n\n\n## 参考\n\n1. [Hotspot caused exceptions to lose their stack traces in production – and the fix at JAW Speak](http://jawspeak.com/2010/05/26/hotspot-caused-exceptions-to-lose-their-stack-traces-in-production-and-the-fix/)\n\n2. [[译]生产环境中异常堆栈丢失的解决方案 | 戎码一生](http://rongmayisheng.com/post/%E8%AF%91%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88)\n\n3. [日志机制 - Tomcat 8 权威指南 - 极客学院Wiki](http://wiki.jikexueyuan.com/project/tomcat/logging.html)\n\n4. [Chapter 9: Logging separation](https://logback.qos.ch/manual/loggingSeparation.html)\n","source":"_posts/jvm-omit-fast-throw.md","raw":"title: Tomcat日志中异常堆栈不完整\ntags: tomcat\ncategory: tomcat\ntoc: true\ndate: 2017-12-03 01:02:29\n---\n\n\n## 现象\n\ntomcat的异常日志会打印到`catalina.out`中，有的时候发现日志的堆栈并不完整， 只能看到部分的堆栈信息。\n\n```\njava.lang.Exception: NullPointerException | 2390852_pd2390852_prc2390852_sr2390852_ncb2390852_pm45090051_pd45090051_prc45090051_sr45090051_ncb45090051_pm36619638_pd36619638_prc36619638_sr36619638_ncb36619638_pm1122394_pd1122394_prc1122394_sr1122394_ncb1122394_pm\n        ...\n        ...\n        at sun.reflect.GeneratedMethodAccessor481.invoke(Unknown Source) ~[na:na]\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_60]\n        at java.lang.reflect.Method.invoke(Method.java:497) ~[na:1.8.0_60]\n        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:110) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invoke\njava.lang.NullPointerException: null\n[2016-12-05 11:29:27][h_hprice_breeze_p_161205.112927.10.90.5.48.6486.595359_1][ESC[31mWARN ESC[0;39m]logX -> desc = SHotel 状态无效, data = hotelId[\n```\n\n可以看到这个`NPE`只打印了，一个message， 内部的堆栈都没有了，这样就无法根据堆栈信息找到对应的代码的位置。\n\n## 原因\n\n### jvm的优化\n\n>HotSpot虚拟机的JIT优化，把多次打的堆栈给优化掉了，往上Grep应该能Grep到完整的堆栈。\n\n#### 解决方案\n\n这种被优化调的堆栈，第一次都是打出来完整的，因此可以向上翻翻，应该是能找到完整的现场的。\n\n频繁的打印异常的堆栈，对系统性能也有较大的影响，不过如果不是生产环境，可以在jvm的启动参数后面加上\n\n```\n-XX:-OmitStackTraceInFastThrow \n```\n将这种优化主动关闭\n\n### 日志打的太快\n\n其实打到tomcat的`catalina.out`的应该是有两个日志框架，一个是tomcat自己带的，一个是应用的。\n\ntomcat自己带了一个日志的框架 —— `juli`\n\n自己的应用中一般也会用一个日志的框架，比如 —— `logback`\n\n这样就存在同时写入`catalina.out`文件的可能，`juli`日志刚打了一半， 就被`logback`打的日志穿插了。\n这样本来两行相邻的日志，就会差的十万八千里。\n\n>Tomcat 的内部日志使用 JULI 组件，这是一个 Apache Commons 日志的重命名的打包分支，默认被硬编码，使用 java.util.logging 架构。\n>这能保证 Tomcat 内部日志与 Web 应用的日志保持独立，即使 Web 应用使用的是 Apache Commons Logging。\n\n正是这个独立性，导致了日志有可能是乱的。\ntomcat加载内部的日志组件的加载器是`System class loader`，\n应用的日志组件的类加载器是`webapp class loader`，因此即使用的是同一套日志体系，相互之间应该还是隔离的。\n\n\nlogback的官方文档也说明了：\n\n>By virtue of class loader separation provided by the container, \n>each web-application will load its own copy of LoggerContext which will pickup its own copy of logback.xml.\n\n\n## 参考\n\n1. [Hotspot caused exceptions to lose their stack traces in production – and the fix at JAW Speak](http://jawspeak.com/2010/05/26/hotspot-caused-exceptions-to-lose-their-stack-traces-in-production-and-the-fix/)\n\n2. [[译]生产环境中异常堆栈丢失的解决方案 | 戎码一生](http://rongmayisheng.com/post/%E8%AF%91%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88)\n\n3. [日志机制 - Tomcat 8 权威指南 - 极客学院Wiki](http://wiki.jikexueyuan.com/project/tomcat/logging.html)\n\n4. [Chapter 9: Logging separation](https://logback.qos.ch/manual/loggingSeparation.html)\n","slug":"jvm-omit-fast-throw","published":1,"updated":"2017-12-02T17:02:29.402Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9v007mjh4k29gmqa6i","content":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>tomcat的异常日志会打印到<code>catalina.out</code>中，有的时候发现日志的堆栈并不完整， 只能看到部分的堆栈信息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java.lang.Exception: NullPointerException | 2390852_pd2390852_prc2390852_sr2390852_ncb2390852_pm45090051_pd45090051_prc45090051_sr45090051_ncb45090051_pm36619638_pd36619638_prc36619638_sr36619638_ncb36619638_pm1122394_pd1122394_prc1122394_sr1122394_ncb1122394_pm</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        at sun.reflect.GeneratedMethodAccessor481.invoke(Unknown Source) ~[na:na]</span><br><span class=\"line\">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_60]</span><br><span class=\"line\">        at java.lang.reflect.Method.invoke(Method.java:497) ~[na:1.8.0_60]</span><br><span class=\"line\">        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:110) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invoke</span><br><span class=\"line\">java.lang.NullPointerException: null</span><br><span class=\"line\">[2016-12-05 11:29:27][h_hprice_breeze_p_161205.112927.10.90.5.48.6486.595359_1][ESC[31mWARN ESC[0;39m]logX -&gt; desc = SHotel 状态无效, data = hotelId[</span><br></pre></td></tr></table></figure>\n<p>可以看到这个<code>NPE</code>只打印了，一个message， 内部的堆栈都没有了，这样就无法根据堆栈信息找到对应的代码的位置。</p>\n<h2 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h2><h3 id=\"jvm的优化\"><a href=\"#jvm的优化\" class=\"headerlink\" title=\"jvm的优化\"></a>jvm的优化</h3><blockquote>\n<p>HotSpot虚拟机的JIT优化，把多次打的堆栈给优化掉了，往上Grep应该能Grep到完整的堆栈。</p>\n</blockquote>\n<h4 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><p>这种被优化调的堆栈，第一次都是打出来完整的，因此可以向上翻翻，应该是能找到完整的现场的。</p>\n<p>频繁的打印异常的堆栈，对系统性能也有较大的影响，不过如果不是生产环境，可以在jvm的启动参数后面加上</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:-OmitStackTraceInFastThrow</span><br></pre></td></tr></table></figure>\n<p>将这种优化主动关闭</p>\n<h3 id=\"日志打的太快\"><a href=\"#日志打的太快\" class=\"headerlink\" title=\"日志打的太快\"></a>日志打的太快</h3><p>其实打到tomcat的<code>catalina.out</code>的应该是有两个日志框架，一个是tomcat自己带的，一个是应用的。</p>\n<p>tomcat自己带了一个日志的框架 —— <code>juli</code></p>\n<p>自己的应用中一般也会用一个日志的框架，比如 —— <code>logback</code></p>\n<p>这样就存在同时写入<code>catalina.out</code>文件的可能，<code>juli</code>日志刚打了一半， 就被<code>logback</code>打的日志穿插了。<br>这样本来两行相邻的日志，就会差的十万八千里。</p>\n<blockquote>\n<p>Tomcat 的内部日志使用 JULI 组件，这是一个 Apache Commons 日志的重命名的打包分支，默认被硬编码，使用 java.util.logging 架构。<br>这能保证 Tomcat 内部日志与 Web 应用的日志保持独立，即使 Web 应用使用的是 Apache Commons Logging。</p>\n</blockquote>\n<p>正是这个独立性，导致了日志有可能是乱的。<br>tomcat加载内部的日志组件的加载器是<code>System class loader</code>，<br>应用的日志组件的类加载器是<code>webapp class loader</code>，因此即使用的是同一套日志体系，相互之间应该还是隔离的。</p>\n<p>logback的官方文档也说明了：</p>\n<blockquote>\n<p>By virtue of class loader separation provided by the container,<br>each web-application will load its own copy of LoggerContext which will pickup its own copy of logback.xml.</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://jawspeak.com/2010/05/26/hotspot-caused-exceptions-to-lose-their-stack-traces-in-production-and-the-fix/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hotspot caused exceptions to lose their stack traces in production – and the fix at JAW Speak</a></p>\n</li>\n<li><p><a href=\"http://rongmayisheng.com/post/%E8%AF%91%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">[译]生产环境中异常堆栈丢失的解决方案 | 戎码一生</a></p>\n</li>\n<li><p><a href=\"http://wiki.jikexueyuan.com/project/tomcat/logging.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">日志机制 - Tomcat 8 权威指南 - 极客学院Wiki</a></p>\n</li>\n<li><p><a href=\"https://logback.qos.ch/manual/loggingSeparation.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Chapter 9: Logging separation</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h2><p>tomcat的异常日志会打印到<code>catalina.out</code>中，有的时候发现日志的堆栈并不完整， 只能看到部分的堆栈信息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java.lang.Exception: NullPointerException | 2390852_pd2390852_prc2390852_sr2390852_ncb2390852_pm45090051_pd45090051_prc45090051_sr45090051_ncb45090051_pm36619638_pd36619638_prc36619638_sr36619638_ncb36619638_pm1122394_pd1122394_prc1122394_sr1122394_ncb1122394_pm</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        at sun.reflect.GeneratedMethodAccessor481.invoke(Unknown Source) ~[na:na]</span><br><span class=\"line\">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_60]</span><br><span class=\"line\">        at java.lang.reflect.Method.invoke(Method.java:497) ~[na:1.8.0_60]</span><br><span class=\"line\">        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136) ~[spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:110) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invoke</span><br><span class=\"line\">java.lang.NullPointerException: null</span><br><span class=\"line\">[2016-12-05 11:29:27][h_hprice_breeze_p_161205.112927.10.90.5.48.6486.595359_1][ESC[31mWARN ESC[0;39m]logX -&gt; desc = SHotel 状态无效, data = hotelId[</span><br></pre></td></tr></table></figure>\n<p>可以看到这个<code>NPE</code>只打印了，一个message， 内部的堆栈都没有了，这样就无法根据堆栈信息找到对应的代码的位置。</p>\n<h2 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h2><h3 id=\"jvm的优化\"><a href=\"#jvm的优化\" class=\"headerlink\" title=\"jvm的优化\"></a>jvm的优化</h3><blockquote>\n<p>HotSpot虚拟机的JIT优化，把多次打的堆栈给优化掉了，往上Grep应该能Grep到完整的堆栈。</p>\n</blockquote>\n<h4 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><p>这种被优化调的堆栈，第一次都是打出来完整的，因此可以向上翻翻，应该是能找到完整的现场的。</p>\n<p>频繁的打印异常的堆栈，对系统性能也有较大的影响，不过如果不是生产环境，可以在jvm的启动参数后面加上</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-XX:-OmitStackTraceInFastThrow</span><br></pre></td></tr></table></figure>\n<p>将这种优化主动关闭</p>\n<h3 id=\"日志打的太快\"><a href=\"#日志打的太快\" class=\"headerlink\" title=\"日志打的太快\"></a>日志打的太快</h3><p>其实打到tomcat的<code>catalina.out</code>的应该是有两个日志框架，一个是tomcat自己带的，一个是应用的。</p>\n<p>tomcat自己带了一个日志的框架 —— <code>juli</code></p>\n<p>自己的应用中一般也会用一个日志的框架，比如 —— <code>logback</code></p>\n<p>这样就存在同时写入<code>catalina.out</code>文件的可能，<code>juli</code>日志刚打了一半， 就被<code>logback</code>打的日志穿插了。<br>这样本来两行相邻的日志，就会差的十万八千里。</p>\n<blockquote>\n<p>Tomcat 的内部日志使用 JULI 组件，这是一个 Apache Commons 日志的重命名的打包分支，默认被硬编码，使用 java.util.logging 架构。<br>这能保证 Tomcat 内部日志与 Web 应用的日志保持独立，即使 Web 应用使用的是 Apache Commons Logging。</p>\n</blockquote>\n<p>正是这个独立性，导致了日志有可能是乱的。<br>tomcat加载内部的日志组件的加载器是<code>System class loader</code>，<br>应用的日志组件的类加载器是<code>webapp class loader</code>，因此即使用的是同一套日志体系，相互之间应该还是隔离的。</p>\n<p>logback的官方文档也说明了：</p>\n<blockquote>\n<p>By virtue of class loader separation provided by the container,<br>each web-application will load its own copy of LoggerContext which will pickup its own copy of logback.xml.</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://jawspeak.com/2010/05/26/hotspot-caused-exceptions-to-lose-their-stack-traces-in-production-and-the-fix/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hotspot caused exceptions to lose their stack traces in production – and the fix at JAW Speak</a></p>\n</li>\n<li><p><a href=\"http://rongmayisheng.com/post/%E8%AF%91%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">[译]生产环境中异常堆栈丢失的解决方案 | 戎码一生</a></p>\n</li>\n<li><p><a href=\"http://wiki.jikexueyuan.com/project/tomcat/logging.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">日志机制 - Tomcat 8 权威指南 - 极客学院Wiki</a></p>\n</li>\n<li><p><a href=\"https://logback.qos.ch/manual/loggingSeparation.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Chapter 9: Logging separation</a></p>\n</li>\n</ol>\n"},{"title":"ThunderBird使用Markdown写邮件","toc":true,"abbrlink":16380,"date":"2017-01-02T08:10:15.000Z","_content":"\n\n# Thunderbird\n\n![](https://www.mozilla.org/media/img/thunderbird/landing/wordmark.3b0e03fa56f1.png)\n\n是Mozilla基金推出的免费、开源的邮件客户端，它支持linux、mac和windows。\n\n这个客户端看起来和火狐非常像，也支持插件扩展。\n\n# markdown here\n\nmarkdown here便是借助markdown的力量来编写邮件。他在Chrome、Firefox、Safari上都有插件。\n\nThunderbird中的插件：\n\n{% asset_img additional.jpg  插件 %}\n\n插件安装好之后，在编写gmail等支持富文本编辑器的时候就可以将markdown转换成相应的样式。\n\nmarkdown here也提供了Thunderbird的插件，在附加组件中安装重启后即可使用markdown来编辑，\n\n编写完成后，点击工具栏的图标即可进行转换。\n\n{% asset_img mail.jpg 编写邮件 %}\n\n转换的样式也可以在设置中自己定义。\n\n# 参考\n\n1.[Markdown小技巧集合 - 阳志平的网志](http://www.yangzhiping.com/tech/markdown-tips.html)\n\n2.[Markdown Here](http://markdown-here.com/)","source":"_posts/markdown-here.md","raw":"---\ntitle: ThunderBird使用Markdown写邮件\ntags: markdown-here\ncategory: markdown\ntoc: true\nabbrlink: 16380\ndate: 2017-01-02 16:10:15\n---\n\n\n# Thunderbird\n\n![](https://www.mozilla.org/media/img/thunderbird/landing/wordmark.3b0e03fa56f1.png)\n\n是Mozilla基金推出的免费、开源的邮件客户端，它支持linux、mac和windows。\n\n这个客户端看起来和火狐非常像，也支持插件扩展。\n\n# markdown here\n\nmarkdown here便是借助markdown的力量来编写邮件。他在Chrome、Firefox、Safari上都有插件。\n\nThunderbird中的插件：\n\n{% asset_img additional.jpg  插件 %}\n\n插件安装好之后，在编写gmail等支持富文本编辑器的时候就可以将markdown转换成相应的样式。\n\nmarkdown here也提供了Thunderbird的插件，在附加组件中安装重启后即可使用markdown来编辑，\n\n编写完成后，点击工具栏的图标即可进行转换。\n\n{% asset_img mail.jpg 编写邮件 %}\n\n转换的样式也可以在设置中自己定义。\n\n# 参考\n\n1.[Markdown小技巧集合 - 阳志平的网志](http://www.yangzhiping.com/tech/markdown-tips.html)\n\n2.[Markdown Here](http://markdown-here.com/)","slug":"markdown-here","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9w007qjh4kx4xj7f5h","content":"<h1 id=\"Thunderbird\"><a href=\"#Thunderbird\" class=\"headerlink\" title=\"Thunderbird\"></a>Thunderbird</h1><p><img src=\"https://www.mozilla.org/media/img/thunderbird/landing/wordmark.3b0e03fa56f1.png\" alt=\"\"></p>\n<p>是Mozilla基金推出的免费、开源的邮件客户端，它支持linux、mac和windows。</p>\n<p>这个客户端看起来和火狐非常像，也支持插件扩展。</p>\n<h1 id=\"markdown-here\"><a href=\"#markdown-here\" class=\"headerlink\" title=\"markdown here\"></a>markdown here</h1><p>markdown here便是借助markdown的力量来编写邮件。他在Chrome、Firefox、Safari上都有插件。</p>\n<p>Thunderbird中的插件：</p>\n<img src=\"/2017/01/02/markdown-here/additional.jpg\" title=\"插件\">\n<p>插件安装好之后，在编写gmail等支持富文本编辑器的时候就可以将markdown转换成相应的样式。</p>\n<p>markdown here也提供了Thunderbird的插件，在附加组件中安装重启后即可使用markdown来编辑，</p>\n<p>编写完成后，点击工具栏的图标即可进行转换。</p>\n<img src=\"/2017/01/02/markdown-here/mail.jpg\" title=\"编写邮件\">\n<p>转换的样式也可以在设置中自己定义。</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p>1.<a href=\"http://www.yangzhiping.com/tech/markdown-tips.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Markdown小技巧集合 - 阳志平的网志</a></p>\n<p>2.<a href=\"http://markdown-here.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Markdown Here</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Thunderbird\"><a href=\"#Thunderbird\" class=\"headerlink\" title=\"Thunderbird\"></a>Thunderbird</h1><p><img src=\"https://www.mozilla.org/media/img/thunderbird/landing/wordmark.3b0e03fa56f1.png\" alt=\"\"></p>\n<p>是Mozilla基金推出的免费、开源的邮件客户端，它支持linux、mac和windows。</p>\n<p>这个客户端看起来和火狐非常像，也支持插件扩展。</p>\n<h1 id=\"markdown-here\"><a href=\"#markdown-here\" class=\"headerlink\" title=\"markdown here\"></a>markdown here</h1><p>markdown here便是借助markdown的力量来编写邮件。他在Chrome、Firefox、Safari上都有插件。</p>\n<p>Thunderbird中的插件：</p>\n<img src=\"/2017/01/02/markdown-here/additional.jpg\" title=\"插件\">\n<p>插件安装好之后，在编写gmail等支持富文本编辑器的时候就可以将markdown转换成相应的样式。</p>\n<p>markdown here也提供了Thunderbird的插件，在附加组件中安装重启后即可使用markdown来编辑，</p>\n<p>编写完成后，点击工具栏的图标即可进行转换。</p>\n<img src=\"/2017/01/02/markdown-here/mail.jpg\" title=\"编写邮件\">\n<p>转换的样式也可以在设置中自己定义。</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p>1.<a href=\"http://www.yangzhiping.com/tech/markdown-tips.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Markdown小技巧集合 - 阳志平的网志</a></p>\n<p>2.<a href=\"http://markdown-here.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Markdown Here</a></p>\n"},{"title":"mysql中时间相关的问题","toc":true,"abbrlink":21227,"date":"2016-09-24T16:27:52.000Z","_content":"\n## 自动更新时间戳\n\n> TIMESTAMP and DATETIME columns can be automatically initializated and updated to the current date and time (that is, the current timestamp).\n\n> For any TIMESTAMP or DATETIME column in a table, you can assign the current timestamp as the default value, the auto-update value, or both:\n\n[mysql官方文档说明](http://dev.mysql.com/doc/refman/5.7/en/timestamp-initialization.html)\n\n代码示例：\n```\nCREATE TABLE t1 (\n  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  dt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n);\n```\n\n## 多个timestamp\n\nmysql中默认一张表中只能有一个timestamp类型的字段，如果有多个的话创建表的时候就会报错\n\n`Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON UPDATE clause  `\n\n在`5.6.4`之前有这个限制，在之后好像就没有这个限制了。参见<https://segmentfault.com/q/1010000000488523>\n","source":"_posts/mysql-time.md","raw":"---\ntitle: mysql中时间相关的问题\ntags: mysql\ncategory: base\ntoc: true\nabbrlink: 21227\ndate: 2016-09-25 00:27:52\n---\n\n## 自动更新时间戳\n\n> TIMESTAMP and DATETIME columns can be automatically initializated and updated to the current date and time (that is, the current timestamp).\n\n> For any TIMESTAMP or DATETIME column in a table, you can assign the current timestamp as the default value, the auto-update value, or both:\n\n[mysql官方文档说明](http://dev.mysql.com/doc/refman/5.7/en/timestamp-initialization.html)\n\n代码示例：\n```\nCREATE TABLE t1 (\n  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  dt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n);\n```\n\n## 多个timestamp\n\nmysql中默认一张表中只能有一个timestamp类型的字段，如果有多个的话创建表的时候就会报错\n\n`Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON UPDATE clause  `\n\n在`5.6.4`之前有这个限制，在之后好像就没有这个限制了。参见<https://segmentfault.com/q/1010000000488523>\n","slug":"mysql-time","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9x007sjh4kr5olxoq0","content":"<h2 id=\"自动更新时间戳\"><a href=\"#自动更新时间戳\" class=\"headerlink\" title=\"自动更新时间戳\"></a>自动更新时间戳</h2><blockquote>\n<p>TIMESTAMP and DATETIME columns can be automatically initializated and updated to the current date and time (that is, the current timestamp).</p>\n<p>For any TIMESTAMP or DATETIME column in a table, you can assign the current timestamp as the default value, the auto-update value, or both:</p>\n</blockquote>\n<p><a href=\"http://dev.mysql.com/doc/refman/5.7/en/timestamp-initialization.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">mysql官方文档说明</a></p>\n<p>代码示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE t1 (</span><br><span class=\"line\">  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class=\"line\">  dt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"多个timestamp\"><a href=\"#多个timestamp\" class=\"headerlink\" title=\"多个timestamp\"></a>多个timestamp</h2><p>mysql中默认一张表中只能有一个timestamp类型的字段，如果有多个的话创建表的时候就会报错</p>\n<p><code>Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON UPDATE clause</code></p>\n<p>在<code>5.6.4</code>之前有这个限制，在之后好像就没有这个限制了。参见<a href=\"https://segmentfault.com/q/1010000000488523\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://segmentfault.com/q/1010000000488523</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"自动更新时间戳\"><a href=\"#自动更新时间戳\" class=\"headerlink\" title=\"自动更新时间戳\"></a>自动更新时间戳</h2><blockquote>\n<p>TIMESTAMP and DATETIME columns can be automatically initializated and updated to the current date and time (that is, the current timestamp).</p>\n<p>For any TIMESTAMP or DATETIME column in a table, you can assign the current timestamp as the default value, the auto-update value, or both:</p>\n</blockquote>\n<p><a href=\"http://dev.mysql.com/doc/refman/5.7/en/timestamp-initialization.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">mysql官方文档说明</a></p>\n<p>代码示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE t1 (</span><br><span class=\"line\">  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class=\"line\">  dt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"多个timestamp\"><a href=\"#多个timestamp\" class=\"headerlink\" title=\"多个timestamp\"></a>多个timestamp</h2><p>mysql中默认一张表中只能有一个timestamp类型的字段，如果有多个的话创建表的时候就会报错</p>\n<p><code>Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON UPDATE clause</code></p>\n<p>在<code>5.6.4</code>之前有这个限制，在之后好像就没有这个限制了。参见<a href=\"https://segmentfault.com/q/1010000000488523\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://segmentfault.com/q/1010000000488523</a></p>\n"},{"title":"机器学习框架调研","toc":true,"abbrlink":55560,"date":"2015-11-03T15:55:34.000Z","_content":"\n# 机器学习框架调研\n## DMTK\n <img src=\"http://www.dmtk.io/img/pic1_V7.jpg\" width = \"150\" height = \"150\" alt=\"图片名称\" align=center />\n\n项目地址：[https://github.com/Microsoft/DMTK](https://github.com/Microsoft/DMTK)\n文档地址:[http://www.dmtk.io/document.html](http://www.dmtk.io/document.html)\n语言: CPP\n项目简介:\n Microsoft Distributed Machine Learning Tookit\n\n- DMTK分布式机器学习框架：\n>它由参数服务器和客户端软件开发包（SDK）两部分构成。参数服务器在原有基础上从性能和功能上都得到了进一步提升——支持存储混合数据结构模型、接受并聚合工作节点服务器的数据模型更新、控制模型同步逻辑等。客户端软件开发包（SDK）支持维护节点模型缓存（与全局模型服务器同步）、节点模型训练和模型通讯的流水线控制、以及片状调度大模型训练等。\n\n-  LightLDA：\n> LightLDA是一种全新的用于训练主题模型，计算复杂度与主题数目无关的高效算法。在其分布式实现中，我们做了大量的系统优化使得LightLDA能够在一个普通计算机集群上处理超大规模的数据和模型。例如，在一个由8台计算机组成的集群上，我们可以在具有2千亿训练样本（token）的数据集上训练具有1百万词汇表和1百万个话题（topic）的LDA模型（约1万亿个参数），这种规模的实验以往要在数千台计算机的集群上才能运行。\n\n- 分布式词向量：\n> 词向量技术近来被普遍地应用于计算词汇的语义表示，它可以用作很多自然语言处理任务的词特征。我们为两种计算词向量的算法提供了高效的分步式实现：\n> \t\t1. 一种是标准的word2vec算法\n> \t\t2. 另一种是可以对多义词计算多个词向量的新算法。\n\n<img src=\"http://www.msra.cn/zh-cn/research/release/images/dmtk-2.png\" width = \"500\" height = \"200\" alt=\"图片名称\" align=center />\n\n### Reference\n\n> [1] Tian, F., Dai, H., Bian, J., Gao, B., Zhang, R., Chen, E., & Liu, T. Y. (2014). [A probabilistic model for learning multi-prototype word embeddings](http://www.aclweb.org/anthology/C14-1016). In Proceedings of COLING (pp. 151-160).\n\n## TensorFlow\n\n\n\n![](http://tensorflow.org/images/tensors_flowing.gif   )\n\n文档地址: [http://tensorflow.org/get_started/index.html](http://tensorflow.org/get_started/index.html)\n项目地址： [http://tensorflow.org/](http://tensorflow.org/)\n语言: Python\n简介：\n>   1. TensorFlow是谷歌研发的第二代人工智能学习系统，而第一代的DistBelief比这个要早好多年。\n>   \n>   2. TensorFlow支持CNN、RNN和LSTM算法，这都是目前在Image，Speech和NLP最流行的深度神经网络模型。\n>   \n>   3. 此外，TensorFlow一大亮点是支持异构设备分布式计算，它能够在各个平台上自动运行模型，从电话、单个CPU / GPU到成百上千GPU卡组成的分布式系统。也就是说，任何基于梯度的机器学习算法都能够受益于TensorFlow的自动分化（auto-differentiation）。\n\n### 参考链接\n[http://news.zol.com.cn/551/5513527.html](http://news.zol.com.cn/551/5513527.html)\n[http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html](http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html)\n\n## Torch\n\n\n![](http://torch.ch/static/flow-hero-logo.png    )\n\n\n\n项目地址: [https://github.com/torch/torch7](https://github.com/torch/torch7)\n项目博客: [http://torch.ch/blog/](http://torch.ch/blog/)\nSlides: [https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf](https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf)\n语言: Lua\n项目简介:\n> Torch并没有跟随Python的潮流，它是基于Lua的。对于解释器没有必要像Matlab或者Python那样，Lua会给你神奇的控制台。Torch被Facebook人工智能研究实验室和位于伦敦的谷歌DeepMind大量使用。\n\n> Torch is a scientific computing framework with wide support for machine learning algorithms. It is > > easy to use and efficient, thanks to an easy and fast scripting language, LuaJIT, and an underlying > C/CUDA implementation.\n\n> A summary of core features:\n>\n>    - a powerful N-dimensional array\n>    - lots of routines for indexing, slicing, transposing, ...\n>    - amazing interface to C, via LuaJIT\n>    - linear algebra routines\n>    - neural network, and energy-based models\n>    - numeric optimization routines\n>    - Fast and efficient GPU support\n>    - Embeddable, with ports to iOS, Android and FPGA backends\n\n### 参考链接\n[2015深度学习回顾：ConvNet、Caffe、Torch及其他](http://www.chinacloud.cn/show.aspx?id=21212&cid=17)\n\n\n## GraphLab\n\n项目简介： [http://www.select.cs.cmu.edu/code/graphlab/](http://www.select.cs.cmu.edu/code/graphlab/)\n语言: Java/Python\n简介:\n> GraphLab是一个流行的图谱分析（Graph Analysis）和机器学习的开源项目，2013年该项目剥离出一个独立运作的商业公司GraphLab Inc\n> - HDFS。GraphLab 内置对HDFS 的支持，GraphLab 能够直接从HDFS中读数据或者将计算结果数据直接写入到HDFS 中。\n\n\n\n![](http://www.ctocio.com/wp-content/uploads/2014/10/graphlab-deeplearning-_thumb.png    )\n\n\n\n\n### 参考链接\n[GraphLab Create使深度学习更easy](http://planckscale.info/?p=226)\n[GraphLab:新的面向机器学习的并行框架](https://blog.inf.ed.ac.uk/graphprocs/2014/11/25/graphlab%E6%96%B0%E7%9A%84%E9%9D%A2%E5%90%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%B9%B6%E8%A1%8C%E6%A1%86%E6%9E%B6/)\n\n## Deeplearning4j\n项目文档: [http://deeplearning4j.org/](http://deeplearning4j.org/)\n项目地址: [https://github.com/deeplearning4j/deeplearning4j](https://github.com/deeplearning4j/deeplearning4j)\n语言: Java/Scala\n项目简介:\n> Deeplearning4j is the first commercial-grade, open-source, distributed deep-learning library written for Java and Scala. Integrated with Hadoop and Spark, DL4J is designed to be used in business environments, rather than as a research tool.\n>    - Versatile n-dimensional array class\n>    - GPU integration\n>    - Scalable on Hadoop, Spark and Akka + AWS et al\n\n\n\n![](http://deeplearning4j.org/img/schematic_overview.png    )\n\n\n\n\n### 参考链接\n[DL4J vs. Torch vs. Theano vs. Caffe](http://deeplearning4j.org/compare-dl4j-torch7-pylearn.html)\n\n\n\n## Caffe\n项目主页: [http://caffe.berkeleyvision.org/](http://caffe.berkeleyvision.org/)\n项目地址: [https://github.com/BVLC/caffe](https://github.com/BVLC/caffe)\nSlides: [https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211](https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211)\n项目简介:\n>The Caffe framework from UC Berkeley is designed to let researchers create and explore CNNs and other Deep Neural Networks (DNNs) easily, while delivering high speed needed for both experiments and industrial deployment [5]. Caffe provides state-of-the-art modeling for advancing and deploying deep learning in research and industry with support for a wide variety of architectures and efficient implementations of prediction and learning.\n\n\n\n\n![](http://d.hiphotos.baidu.com/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=520e49ddb51bb0519b29bb7a5713b1d1/5882b2b7d0a20cf4cad4bb2070094b36adaf998d.jpg    )\n\n\n\n\n\n![](http://img.ptcms.csdn.net/article/201507/08/559cebc9330f2_middle.jpg    )\n\n\n\n### 参考链接\n[Caffe: Convolutional Architecture for Fast Feature Embedding](http://ucb-icsi-vision-group.github.io/caffe-paper/caffe.pdf)\n\n[KDnuggets热门深度学习工具排行：Pylearn2 居首，Caffe第三](http://www.csdn.net/article/1970-01-01/2825166)\n\n\n## Theano\n项目主页: [http://deeplearning.net/software/theano/](http://deeplearning.net/software/theano/)\n项目地址: [https://github.com/Theano/Theano](https://github.com/Theano/Theano)\n\n## Pylearn2\n 文档地址: [http://deeplearning.net/software/pylearn2/](http://deeplearning.net/software/pylearn2/)\n 项目地址: [https://github.com/lisa-lab/pylearn2](https://github.com/lisa-lab/pylearn2)\n项目简介:\n\n>Pylearn2和Theano由同一个开发团队开发，Pylearn2是一个机器学习库，它把深度学习和人工智能研究许多常用的模型以及训练算法封装成一个单一的实验包，如随机梯度下降。\n","source":"_posts/machine_learning.md","raw":"---\ntitle: 机器学习框架调研\ntags: 机器学习\ncategory: 机器学习\ntoc: true\nabbrlink: 55560\ndate: 2015-11-03 23:55:34\n---\n\n# 机器学习框架调研\n## DMTK\n <img src=\"http://www.dmtk.io/img/pic1_V7.jpg\" width = \"150\" height = \"150\" alt=\"图片名称\" align=center />\n\n项目地址：[https://github.com/Microsoft/DMTK](https://github.com/Microsoft/DMTK)\n文档地址:[http://www.dmtk.io/document.html](http://www.dmtk.io/document.html)\n语言: CPP\n项目简介:\n Microsoft Distributed Machine Learning Tookit\n\n- DMTK分布式机器学习框架：\n>它由参数服务器和客户端软件开发包（SDK）两部分构成。参数服务器在原有基础上从性能和功能上都得到了进一步提升——支持存储混合数据结构模型、接受并聚合工作节点服务器的数据模型更新、控制模型同步逻辑等。客户端软件开发包（SDK）支持维护节点模型缓存（与全局模型服务器同步）、节点模型训练和模型通讯的流水线控制、以及片状调度大模型训练等。\n\n-  LightLDA：\n> LightLDA是一种全新的用于训练主题模型，计算复杂度与主题数目无关的高效算法。在其分布式实现中，我们做了大量的系统优化使得LightLDA能够在一个普通计算机集群上处理超大规模的数据和模型。例如，在一个由8台计算机组成的集群上，我们可以在具有2千亿训练样本（token）的数据集上训练具有1百万词汇表和1百万个话题（topic）的LDA模型（约1万亿个参数），这种规模的实验以往要在数千台计算机的集群上才能运行。\n\n- 分布式词向量：\n> 词向量技术近来被普遍地应用于计算词汇的语义表示，它可以用作很多自然语言处理任务的词特征。我们为两种计算词向量的算法提供了高效的分步式实现：\n> \t\t1. 一种是标准的word2vec算法\n> \t\t2. 另一种是可以对多义词计算多个词向量的新算法。\n\n<img src=\"http://www.msra.cn/zh-cn/research/release/images/dmtk-2.png\" width = \"500\" height = \"200\" alt=\"图片名称\" align=center />\n\n### Reference\n\n> [1] Tian, F., Dai, H., Bian, J., Gao, B., Zhang, R., Chen, E., & Liu, T. Y. (2014). [A probabilistic model for learning multi-prototype word embeddings](http://www.aclweb.org/anthology/C14-1016). In Proceedings of COLING (pp. 151-160).\n\n## TensorFlow\n\n\n\n![](http://tensorflow.org/images/tensors_flowing.gif   )\n\n文档地址: [http://tensorflow.org/get_started/index.html](http://tensorflow.org/get_started/index.html)\n项目地址： [http://tensorflow.org/](http://tensorflow.org/)\n语言: Python\n简介：\n>   1. TensorFlow是谷歌研发的第二代人工智能学习系统，而第一代的DistBelief比这个要早好多年。\n>   \n>   2. TensorFlow支持CNN、RNN和LSTM算法，这都是目前在Image，Speech和NLP最流行的深度神经网络模型。\n>   \n>   3. 此外，TensorFlow一大亮点是支持异构设备分布式计算，它能够在各个平台上自动运行模型，从电话、单个CPU / GPU到成百上千GPU卡组成的分布式系统。也就是说，任何基于梯度的机器学习算法都能够受益于TensorFlow的自动分化（auto-differentiation）。\n\n### 参考链接\n[http://news.zol.com.cn/551/5513527.html](http://news.zol.com.cn/551/5513527.html)\n[http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html](http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html)\n\n## Torch\n\n\n![](http://torch.ch/static/flow-hero-logo.png    )\n\n\n\n项目地址: [https://github.com/torch/torch7](https://github.com/torch/torch7)\n项目博客: [http://torch.ch/blog/](http://torch.ch/blog/)\nSlides: [https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf](https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf)\n语言: Lua\n项目简介:\n> Torch并没有跟随Python的潮流，它是基于Lua的。对于解释器没有必要像Matlab或者Python那样，Lua会给你神奇的控制台。Torch被Facebook人工智能研究实验室和位于伦敦的谷歌DeepMind大量使用。\n\n> Torch is a scientific computing framework with wide support for machine learning algorithms. It is > > easy to use and efficient, thanks to an easy and fast scripting language, LuaJIT, and an underlying > C/CUDA implementation.\n\n> A summary of core features:\n>\n>    - a powerful N-dimensional array\n>    - lots of routines for indexing, slicing, transposing, ...\n>    - amazing interface to C, via LuaJIT\n>    - linear algebra routines\n>    - neural network, and energy-based models\n>    - numeric optimization routines\n>    - Fast and efficient GPU support\n>    - Embeddable, with ports to iOS, Android and FPGA backends\n\n### 参考链接\n[2015深度学习回顾：ConvNet、Caffe、Torch及其他](http://www.chinacloud.cn/show.aspx?id=21212&cid=17)\n\n\n## GraphLab\n\n项目简介： [http://www.select.cs.cmu.edu/code/graphlab/](http://www.select.cs.cmu.edu/code/graphlab/)\n语言: Java/Python\n简介:\n> GraphLab是一个流行的图谱分析（Graph Analysis）和机器学习的开源项目，2013年该项目剥离出一个独立运作的商业公司GraphLab Inc\n> - HDFS。GraphLab 内置对HDFS 的支持，GraphLab 能够直接从HDFS中读数据或者将计算结果数据直接写入到HDFS 中。\n\n\n\n![](http://www.ctocio.com/wp-content/uploads/2014/10/graphlab-deeplearning-_thumb.png    )\n\n\n\n\n### 参考链接\n[GraphLab Create使深度学习更easy](http://planckscale.info/?p=226)\n[GraphLab:新的面向机器学习的并行框架](https://blog.inf.ed.ac.uk/graphprocs/2014/11/25/graphlab%E6%96%B0%E7%9A%84%E9%9D%A2%E5%90%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%B9%B6%E8%A1%8C%E6%A1%86%E6%9E%B6/)\n\n## Deeplearning4j\n项目文档: [http://deeplearning4j.org/](http://deeplearning4j.org/)\n项目地址: [https://github.com/deeplearning4j/deeplearning4j](https://github.com/deeplearning4j/deeplearning4j)\n语言: Java/Scala\n项目简介:\n> Deeplearning4j is the first commercial-grade, open-source, distributed deep-learning library written for Java and Scala. Integrated with Hadoop and Spark, DL4J is designed to be used in business environments, rather than as a research tool.\n>    - Versatile n-dimensional array class\n>    - GPU integration\n>    - Scalable on Hadoop, Spark and Akka + AWS et al\n\n\n\n![](http://deeplearning4j.org/img/schematic_overview.png    )\n\n\n\n\n### 参考链接\n[DL4J vs. Torch vs. Theano vs. Caffe](http://deeplearning4j.org/compare-dl4j-torch7-pylearn.html)\n\n\n\n## Caffe\n项目主页: [http://caffe.berkeleyvision.org/](http://caffe.berkeleyvision.org/)\n项目地址: [https://github.com/BVLC/caffe](https://github.com/BVLC/caffe)\nSlides: [https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211](https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211)\n项目简介:\n>The Caffe framework from UC Berkeley is designed to let researchers create and explore CNNs and other Deep Neural Networks (DNNs) easily, while delivering high speed needed for both experiments and industrial deployment [5]. Caffe provides state-of-the-art modeling for advancing and deploying deep learning in research and industry with support for a wide variety of architectures and efficient implementations of prediction and learning.\n\n\n\n\n![](http://d.hiphotos.baidu.com/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=520e49ddb51bb0519b29bb7a5713b1d1/5882b2b7d0a20cf4cad4bb2070094b36adaf998d.jpg    )\n\n\n\n\n\n![](http://img.ptcms.csdn.net/article/201507/08/559cebc9330f2_middle.jpg    )\n\n\n\n### 参考链接\n[Caffe: Convolutional Architecture for Fast Feature Embedding](http://ucb-icsi-vision-group.github.io/caffe-paper/caffe.pdf)\n\n[KDnuggets热门深度学习工具排行：Pylearn2 居首，Caffe第三](http://www.csdn.net/article/1970-01-01/2825166)\n\n\n## Theano\n项目主页: [http://deeplearning.net/software/theano/](http://deeplearning.net/software/theano/)\n项目地址: [https://github.com/Theano/Theano](https://github.com/Theano/Theano)\n\n## Pylearn2\n 文档地址: [http://deeplearning.net/software/pylearn2/](http://deeplearning.net/software/pylearn2/)\n 项目地址: [https://github.com/lisa-lab/pylearn2](https://github.com/lisa-lab/pylearn2)\n项目简介:\n\n>Pylearn2和Theano由同一个开发团队开发，Pylearn2是一个机器学习库，它把深度学习和人工智能研究许多常用的模型以及训练算法封装成一个单一的实验包，如随机梯度下降。\n","slug":"machine_learning","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsd9z007wjh4kdosu2qyo","content":"<h1 id=\"机器学习框架调研\"><a href=\"#机器学习框架调研\" class=\"headerlink\" title=\"机器学习框架调研\"></a>机器学习框架调研</h1><h2 id=\"DMTK\"><a href=\"#DMTK\" class=\"headerlink\" title=\"DMTK\"></a>DMTK</h2><p> <img src=\"http://www.dmtk.io/img/pic1_V7.jpg\" width=\"150\" height=\"150\" alt=\"图片名称\" align=\"center\"></p>\n<p>项目地址：<a href=\"https://github.com/Microsoft/DMTK\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/Microsoft/DMTK</a><br>文档地址:<a href=\"http://www.dmtk.io/document.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.dmtk.io/document.html</a><br>语言: CPP<br>项目简介:<br> Microsoft Distributed Machine Learning Tookit</p>\n<ul>\n<li><p>DMTK分布式机器学习框架：</p>\n<blockquote>\n<p>它由参数服务器和客户端软件开发包（SDK）两部分构成。参数服务器在原有基础上从性能和功能上都得到了进一步提升——支持存储混合数据结构模型、接受并聚合工作节点服务器的数据模型更新、控制模型同步逻辑等。客户端软件开发包（SDK）支持维护节点模型缓存（与全局模型服务器同步）、节点模型训练和模型通讯的流水线控制、以及片状调度大模型训练等。</p>\n</blockquote>\n</li>\n<li><p>LightLDA：</p>\n<blockquote>\n<p>LightLDA是一种全新的用于训练主题模型，计算复杂度与主题数目无关的高效算法。在其分布式实现中，我们做了大量的系统优化使得LightLDA能够在一个普通计算机集群上处理超大规模的数据和模型。例如，在一个由8台计算机组成的集群上，我们可以在具有2千亿训练样本（token）的数据集上训练具有1百万词汇表和1百万个话题（topic）的LDA模型（约1万亿个参数），这种规模的实验以往要在数千台计算机的集群上才能运行。</p>\n</blockquote>\n</li>\n<li><p>分布式词向量：</p>\n<blockquote>\n<p>词向量技术近来被普遍地应用于计算词汇的语义表示，它可以用作很多自然语言处理任务的词特征。我们为两种计算词向量的算法提供了高效的分步式实现：</p>\n<pre><code>1. 一种是标准的word2vec算法\n2. 另一种是可以对多义词计算多个词向量的新算法。\n</code></pre></blockquote>\n</li>\n</ul>\n<p><img src=\"http://www.msra.cn/zh-cn/research/release/images/dmtk-2.png\" width=\"500\" height=\"200\" alt=\"图片名称\" align=\"center\"></p>\n<h3 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h3><blockquote>\n<p>[1] Tian, F., Dai, H., Bian, J., Gao, B., Zhang, R., Chen, E., &amp; Liu, T. Y. (2014). <a href=\"http://www.aclweb.org/anthology/C14-1016\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">A probabilistic model for learning multi-prototype word embeddings</a>. In Proceedings of COLING (pp. 151-160).</p>\n</blockquote>\n<h2 id=\"TensorFlow\"><a href=\"#TensorFlow\" class=\"headerlink\" title=\"TensorFlow\"></a>TensorFlow</h2><p><img src=\"http://tensorflow.org/images/tensors_flowing.gif\" alt=\"\"></p>\n<p>文档地址: <a href=\"http://tensorflow.org/get_started/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://tensorflow.org/get_started/index.html</a><br>项目地址： <a href=\"http://tensorflow.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://tensorflow.org/</a><br>语言: Python<br>简介：</p>\n<blockquote>\n<ol>\n<li><p>TensorFlow是谷歌研发的第二代人工智能学习系统，而第一代的DistBelief比这个要早好多年。</p>\n</li>\n<li><p>TensorFlow支持CNN、RNN和LSTM算法，这都是目前在Image，Speech和NLP最流行的深度神经网络模型。</p>\n</li>\n<li><p>此外，TensorFlow一大亮点是支持异构设备分布式计算，它能够在各个平台上自动运行模型，从电话、单个CPU / GPU到成百上千GPU卡组成的分布式系统。也就是说，任何基于梯度的机器学习算法都能够受益于TensorFlow的自动分化（auto-differentiation）。</p>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://news.zol.com.cn/551/5513527.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://news.zol.com.cn/551/5513527.html</a><br><a href=\"http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html</a></p>\n<h2 id=\"Torch\"><a href=\"#Torch\" class=\"headerlink\" title=\"Torch\"></a>Torch</h2><p><img src=\"http://torch.ch/static/flow-hero-logo.png\" alt=\"\"></p>\n<p>项目地址: <a href=\"https://github.com/torch/torch7\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/torch/torch7</a><br>项目博客: <a href=\"http://torch.ch/blog/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://torch.ch/blog/</a><br>Slides: <a href=\"https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf</a><br>语言: Lua<br>项目简介:</p>\n<blockquote>\n<p>Torch并没有跟随Python的潮流，它是基于Lua的。对于解释器没有必要像Matlab或者Python那样，Lua会给你神奇的控制台。Torch被Facebook人工智能研究实验室和位于伦敦的谷歌DeepMind大量使用。</p>\n<p>Torch is a scientific computing framework with wide support for machine learning algorithms. It is &gt; &gt; easy to use and efficient, thanks to an easy and fast scripting language, LuaJIT, and an underlying &gt; C/CUDA implementation.</p>\n<p>A summary of core features:</p>\n<ul>\n<li>a powerful N-dimensional array</li>\n<li>lots of routines for indexing, slicing, transposing, …</li>\n<li>amazing interface to C, via LuaJIT</li>\n<li>linear algebra routines</li>\n<li>neural network, and energy-based models</li>\n<li>numeric optimization routines</li>\n<li>Fast and efficient GPU support</li>\n<li>Embeddable, with ports to iOS, Android and FPGA backends</li>\n</ul>\n</blockquote>\n<h3 id=\"参考链接-1\"><a href=\"#参考链接-1\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://www.chinacloud.cn/show.aspx?id=21212&amp;cid=17\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">2015深度学习回顾：ConvNet、Caffe、Torch及其他</a></p>\n<h2 id=\"GraphLab\"><a href=\"#GraphLab\" class=\"headerlink\" title=\"GraphLab\"></a>GraphLab</h2><p>项目简介： <a href=\"http://www.select.cs.cmu.edu/code/graphlab/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.select.cs.cmu.edu/code/graphlab/</a><br>语言: Java/Python<br>简介:</p>\n<blockquote>\n<p>GraphLab是一个流行的图谱分析（Graph Analysis）和机器学习的开源项目，2013年该项目剥离出一个独立运作的商业公司GraphLab Inc</p>\n<ul>\n<li>HDFS。GraphLab 内置对HDFS 的支持，GraphLab 能够直接从HDFS中读数据或者将计算结果数据直接写入到HDFS 中。</li>\n</ul>\n</blockquote>\n<p><img src=\"http://www.ctocio.com/wp-content/uploads/2014/10/graphlab-deeplearning-_thumb.png\" alt=\"\"></p>\n<h3 id=\"参考链接-2\"><a href=\"#参考链接-2\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://planckscale.info/?p=226\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">GraphLab Create使深度学习更easy</a><br><a href=\"https://blog.inf.ed.ac.uk/graphprocs/2014/11/25/graphlab%E6%96%B0%E7%9A%84%E9%9D%A2%E5%90%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%B9%B6%E8%A1%8C%E6%A1%86%E6%9E%B6/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">GraphLab:新的面向机器学习的并行框架</a></p>\n<h2 id=\"Deeplearning4j\"><a href=\"#Deeplearning4j\" class=\"headerlink\" title=\"Deeplearning4j\"></a>Deeplearning4j</h2><p>项目文档: <a href=\"http://deeplearning4j.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://deeplearning4j.org/</a><br>项目地址: <a href=\"https://github.com/deeplearning4j/deeplearning4j\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/deeplearning4j/deeplearning4j</a><br>语言: Java/Scala<br>项目简介:</p>\n<blockquote>\n<p>Deeplearning4j is the first commercial-grade, open-source, distributed deep-learning library written for Java and Scala. Integrated with Hadoop and Spark, DL4J is designed to be used in business environments, rather than as a research tool.</p>\n<ul>\n<li>Versatile n-dimensional array class</li>\n<li>GPU integration</li>\n<li>Scalable on Hadoop, Spark and Akka + AWS et al</li>\n</ul>\n</blockquote>\n<p><img src=\"http://deeplearning4j.org/img/schematic_overview.png\" alt=\"\"></p>\n<h3 id=\"参考链接-3\"><a href=\"#参考链接-3\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://deeplearning4j.org/compare-dl4j-torch7-pylearn.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">DL4J vs. Torch vs. Theano vs. Caffe</a></p>\n<h2 id=\"Caffe\"><a href=\"#Caffe\" class=\"headerlink\" title=\"Caffe\"></a>Caffe</h2><p>项目主页: <a href=\"http://caffe.berkeleyvision.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://caffe.berkeleyvision.org/</a><br>项目地址: <a href=\"https://github.com/BVLC/caffe\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/BVLC/caffe</a><br>Slides: <a href=\"https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211</a><br>项目简介:</p>\n<blockquote>\n<p>The Caffe framework from UC Berkeley is designed to let researchers create and explore CNNs and other Deep Neural Networks (DNNs) easily, while delivering high speed needed for both experiments and industrial deployment [5]. Caffe provides state-of-the-art modeling for advancing and deploying deep learning in research and industry with support for a wide variety of architectures and efficient implementations of prediction and learning.</p>\n</blockquote>\n<p><img src=\"http://d.hiphotos.baidu.com/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=520e49ddb51bb0519b29bb7a5713b1d1/5882b2b7d0a20cf4cad4bb2070094b36adaf998d.jpg\" alt=\"\"></p>\n<p><img src=\"http://img.ptcms.csdn.net/article/201507/08/559cebc9330f2_middle.jpg\" alt=\"\"></p>\n<h3 id=\"参考链接-4\"><a href=\"#参考链接-4\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://ucb-icsi-vision-group.github.io/caffe-paper/caffe.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Caffe: Convolutional Architecture for Fast Feature Embedding</a></p>\n<p><a href=\"http://www.csdn.net/article/1970-01-01/2825166\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">KDnuggets热门深度学习工具排行：Pylearn2 居首，Caffe第三</a></p>\n<h2 id=\"Theano\"><a href=\"#Theano\" class=\"headerlink\" title=\"Theano\"></a>Theano</h2><p>项目主页: <a href=\"http://deeplearning.net/software/theano/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://deeplearning.net/software/theano/</a><br>项目地址: <a href=\"https://github.com/Theano/Theano\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/Theano/Theano</a></p>\n<h2 id=\"Pylearn2\"><a href=\"#Pylearn2\" class=\"headerlink\" title=\"Pylearn2\"></a>Pylearn2</h2><p> 文档地址: <a href=\"http://deeplearning.net/software/pylearn2/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://deeplearning.net/software/pylearn2/</a><br> 项目地址: <a href=\"https://github.com/lisa-lab/pylearn2\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/lisa-lab/pylearn2</a><br>项目简介:</p>\n<blockquote>\n<p>Pylearn2和Theano由同一个开发团队开发，Pylearn2是一个机器学习库，它把深度学习和人工智能研究许多常用的模型以及训练算法封装成一个单一的实验包，如随机梯度下降。</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"机器学习框架调研\"><a href=\"#机器学习框架调研\" class=\"headerlink\" title=\"机器学习框架调研\"></a>机器学习框架调研</h1><h2 id=\"DMTK\"><a href=\"#DMTK\" class=\"headerlink\" title=\"DMTK\"></a>DMTK</h2><p> <img src=\"http://www.dmtk.io/img/pic1_V7.jpg\" width=\"150\" height=\"150\" alt=\"图片名称\" align=\"center\"></p>\n<p>项目地址：<a href=\"https://github.com/Microsoft/DMTK\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/Microsoft/DMTK</a><br>文档地址:<a href=\"http://www.dmtk.io/document.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.dmtk.io/document.html</a><br>语言: CPP<br>项目简介:<br> Microsoft Distributed Machine Learning Tookit</p>\n<ul>\n<li><p>DMTK分布式机器学习框架：</p>\n<blockquote>\n<p>它由参数服务器和客户端软件开发包（SDK）两部分构成。参数服务器在原有基础上从性能和功能上都得到了进一步提升——支持存储混合数据结构模型、接受并聚合工作节点服务器的数据模型更新、控制模型同步逻辑等。客户端软件开发包（SDK）支持维护节点模型缓存（与全局模型服务器同步）、节点模型训练和模型通讯的流水线控制、以及片状调度大模型训练等。</p>\n</blockquote>\n</li>\n<li><p>LightLDA：</p>\n<blockquote>\n<p>LightLDA是一种全新的用于训练主题模型，计算复杂度与主题数目无关的高效算法。在其分布式实现中，我们做了大量的系统优化使得LightLDA能够在一个普通计算机集群上处理超大规模的数据和模型。例如，在一个由8台计算机组成的集群上，我们可以在具有2千亿训练样本（token）的数据集上训练具有1百万词汇表和1百万个话题（topic）的LDA模型（约1万亿个参数），这种规模的实验以往要在数千台计算机的集群上才能运行。</p>\n</blockquote>\n</li>\n<li><p>分布式词向量：</p>\n<blockquote>\n<p>词向量技术近来被普遍地应用于计算词汇的语义表示，它可以用作很多自然语言处理任务的词特征。我们为两种计算词向量的算法提供了高效的分步式实现：</p>\n<pre><code>1. 一种是标准的word2vec算法\n2. 另一种是可以对多义词计算多个词向量的新算法。\n</code></pre></blockquote>\n</li>\n</ul>\n<p><img src=\"http://www.msra.cn/zh-cn/research/release/images/dmtk-2.png\" width=\"500\" height=\"200\" alt=\"图片名称\" align=\"center\"></p>\n<h3 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h3><blockquote>\n<p>[1] Tian, F., Dai, H., Bian, J., Gao, B., Zhang, R., Chen, E., &amp; Liu, T. Y. (2014). <a href=\"http://www.aclweb.org/anthology/C14-1016\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">A probabilistic model for learning multi-prototype word embeddings</a>. In Proceedings of COLING (pp. 151-160).</p>\n</blockquote>\n<h2 id=\"TensorFlow\"><a href=\"#TensorFlow\" class=\"headerlink\" title=\"TensorFlow\"></a>TensorFlow</h2><p><img src=\"http://tensorflow.org/images/tensors_flowing.gif\" alt=\"\"></p>\n<p>文档地址: <a href=\"http://tensorflow.org/get_started/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://tensorflow.org/get_started/index.html</a><br>项目地址： <a href=\"http://tensorflow.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://tensorflow.org/</a><br>语言: Python<br>简介：</p>\n<blockquote>\n<ol>\n<li><p>TensorFlow是谷歌研发的第二代人工智能学习系统，而第一代的DistBelief比这个要早好多年。</p>\n</li>\n<li><p>TensorFlow支持CNN、RNN和LSTM算法，这都是目前在Image，Speech和NLP最流行的深度神经网络模型。</p>\n</li>\n<li><p>此外，TensorFlow一大亮点是支持异构设备分布式计算，它能够在各个平台上自动运行模型，从电话、单个CPU / GPU到成百上千GPU卡组成的分布式系统。也就是说，任何基于梯度的机器学习算法都能够受益于TensorFlow的自动分化（auto-differentiation）。</p>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://news.zol.com.cn/551/5513527.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://news.zol.com.cn/551/5513527.html</a><br><a href=\"http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.leiphone.com/news/201511/Voza1pFNQB4bzKdR.html</a></p>\n<h2 id=\"Torch\"><a href=\"#Torch\" class=\"headerlink\" title=\"Torch\"></a>Torch</h2><p><img src=\"http://torch.ch/static/flow-hero-logo.png\" alt=\"\"></p>\n<p>项目地址: <a href=\"https://github.com/torch/torch7\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/torch/torch7</a><br>项目博客: <a href=\"http://torch.ch/blog/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://torch.ch/blog/</a><br>Slides: <a href=\"https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/soumith/cvpr2015/blob/master/cvpr-torch.pdf</a><br>语言: Lua<br>项目简介:</p>\n<blockquote>\n<p>Torch并没有跟随Python的潮流，它是基于Lua的。对于解释器没有必要像Matlab或者Python那样，Lua会给你神奇的控制台。Torch被Facebook人工智能研究实验室和位于伦敦的谷歌DeepMind大量使用。</p>\n<p>Torch is a scientific computing framework with wide support for machine learning algorithms. It is &gt; &gt; easy to use and efficient, thanks to an easy and fast scripting language, LuaJIT, and an underlying &gt; C/CUDA implementation.</p>\n<p>A summary of core features:</p>\n<ul>\n<li>a powerful N-dimensional array</li>\n<li>lots of routines for indexing, slicing, transposing, …</li>\n<li>amazing interface to C, via LuaJIT</li>\n<li>linear algebra routines</li>\n<li>neural network, and energy-based models</li>\n<li>numeric optimization routines</li>\n<li>Fast and efficient GPU support</li>\n<li>Embeddable, with ports to iOS, Android and FPGA backends</li>\n</ul>\n</blockquote>\n<h3 id=\"参考链接-1\"><a href=\"#参考链接-1\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://www.chinacloud.cn/show.aspx?id=21212&amp;cid=17\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">2015深度学习回顾：ConvNet、Caffe、Torch及其他</a></p>\n<h2 id=\"GraphLab\"><a href=\"#GraphLab\" class=\"headerlink\" title=\"GraphLab\"></a>GraphLab</h2><p>项目简介： <a href=\"http://www.select.cs.cmu.edu/code/graphlab/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://www.select.cs.cmu.edu/code/graphlab/</a><br>语言: Java/Python<br>简介:</p>\n<blockquote>\n<p>GraphLab是一个流行的图谱分析（Graph Analysis）和机器学习的开源项目，2013年该项目剥离出一个独立运作的商业公司GraphLab Inc</p>\n<ul>\n<li>HDFS。GraphLab 内置对HDFS 的支持，GraphLab 能够直接从HDFS中读数据或者将计算结果数据直接写入到HDFS 中。</li>\n</ul>\n</blockquote>\n<p><img src=\"http://www.ctocio.com/wp-content/uploads/2014/10/graphlab-deeplearning-_thumb.png\" alt=\"\"></p>\n<h3 id=\"参考链接-2\"><a href=\"#参考链接-2\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://planckscale.info/?p=226\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">GraphLab Create使深度学习更easy</a><br><a href=\"https://blog.inf.ed.ac.uk/graphprocs/2014/11/25/graphlab%E6%96%B0%E7%9A%84%E9%9D%A2%E5%90%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%B9%B6%E8%A1%8C%E6%A1%86%E6%9E%B6/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">GraphLab:新的面向机器学习的并行框架</a></p>\n<h2 id=\"Deeplearning4j\"><a href=\"#Deeplearning4j\" class=\"headerlink\" title=\"Deeplearning4j\"></a>Deeplearning4j</h2><p>项目文档: <a href=\"http://deeplearning4j.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://deeplearning4j.org/</a><br>项目地址: <a href=\"https://github.com/deeplearning4j/deeplearning4j\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/deeplearning4j/deeplearning4j</a><br>语言: Java/Scala<br>项目简介:</p>\n<blockquote>\n<p>Deeplearning4j is the first commercial-grade, open-source, distributed deep-learning library written for Java and Scala. Integrated with Hadoop and Spark, DL4J is designed to be used in business environments, rather than as a research tool.</p>\n<ul>\n<li>Versatile n-dimensional array class</li>\n<li>GPU integration</li>\n<li>Scalable on Hadoop, Spark and Akka + AWS et al</li>\n</ul>\n</blockquote>\n<p><img src=\"http://deeplearning4j.org/img/schematic_overview.png\" alt=\"\"></p>\n<h3 id=\"参考链接-3\"><a href=\"#参考链接-3\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://deeplearning4j.org/compare-dl4j-torch7-pylearn.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">DL4J vs. Torch vs. Theano vs. Caffe</a></p>\n<h2 id=\"Caffe\"><a href=\"#Caffe\" class=\"headerlink\" title=\"Caffe\"></a>Caffe</h2><p>项目主页: <a href=\"http://caffe.berkeleyvision.org/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://caffe.berkeleyvision.org/</a><br>项目地址: <a href=\"https://github.com/BVLC/caffe\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/BVLC/caffe</a><br>Slides: <a href=\"https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://docs.google.com/presentation/d/1UeKXVgRvvxg9OUdh_UiC5G71UMscNPlvArsWER41PsU/edit#slide=id.gc2fcdcce7_216_211</a><br>项目简介:</p>\n<blockquote>\n<p>The Caffe framework from UC Berkeley is designed to let researchers create and explore CNNs and other Deep Neural Networks (DNNs) easily, while delivering high speed needed for both experiments and industrial deployment [5]. Caffe provides state-of-the-art modeling for advancing and deploying deep learning in research and industry with support for a wide variety of architectures and efficient implementations of prediction and learning.</p>\n</blockquote>\n<p><img src=\"http://d.hiphotos.baidu.com/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=520e49ddb51bb0519b29bb7a5713b1d1/5882b2b7d0a20cf4cad4bb2070094b36adaf998d.jpg\" alt=\"\"></p>\n<p><img src=\"http://img.ptcms.csdn.net/article/201507/08/559cebc9330f2_middle.jpg\" alt=\"\"></p>\n<h3 id=\"参考链接-4\"><a href=\"#参考链接-4\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"http://ucb-icsi-vision-group.github.io/caffe-paper/caffe.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Caffe: Convolutional Architecture for Fast Feature Embedding</a></p>\n<p><a href=\"http://www.csdn.net/article/1970-01-01/2825166\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">KDnuggets热门深度学习工具排行：Pylearn2 居首，Caffe第三</a></p>\n<h2 id=\"Theano\"><a href=\"#Theano\" class=\"headerlink\" title=\"Theano\"></a>Theano</h2><p>项目主页: <a href=\"http://deeplearning.net/software/theano/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://deeplearning.net/software/theano/</a><br>项目地址: <a href=\"https://github.com/Theano/Theano\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/Theano/Theano</a></p>\n<h2 id=\"Pylearn2\"><a href=\"#Pylearn2\" class=\"headerlink\" title=\"Pylearn2\"></a>Pylearn2</h2><p> 文档地址: <a href=\"http://deeplearning.net/software/pylearn2/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://deeplearning.net/software/pylearn2/</a><br> 项目地址: <a href=\"https://github.com/lisa-lab/pylearn2\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://github.com/lisa-lab/pylearn2</a><br>项目简介:</p>\n<blockquote>\n<p>Pylearn2和Theano由同一个开发团队开发，Pylearn2是一个机器学习库，它把深度学习和人工智能研究许多常用的模型以及训练算法封装成一个单一的实验包，如随机梯度下降。</p>\n</blockquote>\n"},{"title":"Hexo中使用markdown来绘制脑图（mind map）","toc":true,"abbrlink":40574,"date":"2017-01-01T14:45:33.000Z","_content":"\n\n# 脑图是什么？\n\n脑图英文叫做`mind map`, 是一种帮助发散思维的工具。将读过的书、看过的源码等总结成脑图，等下次需要复习的时候\n\n顺着脑图去看，效率非常高。\n\n{% asset_img  sample.jpg %}\n\n## 用makrdown来画脑图\n\n`markdown`是一种非常方便的标记性语言，使用`markdown`记录可以忽略格式带来的困扰，让我们更加的专注于内容。\n\n脑图的结构也不复杂，就是一级一级的分支。使用markdown完全可以表达出来，关键是怎么渲染出来。\n\n## kityminder\n\n经多番查找，最终锁定了百度前端团队开源的——`kityminder`, [百度脑图](http://naotu.baidu.com/)也是使用这个构建的。\n\n`kityminder`分成了两部分，一部分是[kityminder-core](https://github.com/fex-team/kityminder-core),一个是[kityminder-editor](https://github.com/fex-team/kityminder-editor).\n\n\n{% asset_img relations.png %}\n\n### kityminder-core\n\nkityminder-core是百度脑图最核心部分的实现，主要包括了:\n\n- 包括脑图数据的可视化展示（Json 格式）\n\n- 包括简单的编辑功能（节点创建、编辑、删除）。更加强大编辑功能的 KityMinder 编辑器请移步 kityminder-editor\n\n- 不包含第三方格式（FreeMind、XMind、MindManager）的支持，可以加载 kityminder-protocol 来扩展第三方格式支持。\n\n- 不包含文件存储的支持，需要自行实现存储。可参照百度脑图中的开源的 fio + 百度网盘方案进行实现。\n\n### kityminder-editor\n\n> KityMinder Editor 是一款强大、简洁、体验优秀的脑图编辑工具，适合用于编辑树/图/网等结构的数据。\n\n> 编辑器由百度 FEX 基于 kityminder-core 搭建，并且在百度脑图中使用。\n\n## 让hexo支持kityminder\n\n这个主要是客户端渲染的。\n\n### 引入依赖\n\n引入`kityminder-core`的js和css，以及`kityminder-core`的依赖kity到相应的主题下面\n\n```\n//core压缩后的\nkityminder.core.min.js\n//kity的cdn地址\nhttps://cdn.rawgit.com/fex-team/kity/dev/dist/kity.min.js\n```\n\n### 为`mind map`找到一个标签\n\n渲染需要*数据*和*容器*节点。数据的标记应该越简单越好。\n\n查阅hexo的官方文档，发现了几个支持设置class属性的标签，以及raw标签。\n\n先来看看`raw`标签：\n\n```\n{% raw %}\ncontent\n{% endraw %}\n```\n\n`raw`标签里面是可以写html的，渲染的时候不会加以改变，但是写起了比较麻烦，失去了标记性语言简单的特性。\n\n`pull quote`标签：\n\n```\n{% pullquote [class] %}\ncontent\n{% endpullquote %}\n```\n\n`pull quote` 标签支持设置class属性，使用这个标签，然后设置一个我们自己的class，比如`mindmap`\n\n### 渲染数据\n\n```javascript\nsetTimeout(function() {\n        var minder = new kityminder.Minder({\n            renderTo: '.mindmap'\n        });\n        var markdownText = $('.mindmap').text().trim();\n        $('.mindmap p').each(function(index, element) {\n            element.style.display = 'none';\n        });\n        minder.importData('markdown', markdownText);\n        minder.disable();\n        minder.execCommand('hand');\n    },\n    3000\n)\n```\n\n使用markdown写mind map示例:\n\n```\n{% pullquote mindmap %}\n#主题\n##一级分支\n###二级分支\n##一级分支\n##一级分支\n###二级分支\n####三级分支\n{% endpullquote %}\n```\n\n渲染的效果\n\n{% pullquote mindmap %}\n#主题\n##一级分支\n###二级分支\n##一级分支\n##一级分支\n###二级分支\n####三级分支\n{% endpullquote %}\n\n# 参考\n\n1. [标签插件（Tag Plugins） | Hexo](https://hexo.io/zh-cn/docs/tag-plugins.html)","source":"_posts/markdown-mindmap.md","raw":"---\ntitle: Hexo中使用markdown来绘制脑图（mind map）\ntags: mindmap\ncategory: hexo\ntoc: true\nabbrlink: 40574\ndate: 2017-01-01 22:45:33\n---\n\n\n# 脑图是什么？\n\n脑图英文叫做`mind map`, 是一种帮助发散思维的工具。将读过的书、看过的源码等总结成脑图，等下次需要复习的时候\n\n顺着脑图去看，效率非常高。\n\n{% asset_img  sample.jpg %}\n\n## 用makrdown来画脑图\n\n`markdown`是一种非常方便的标记性语言，使用`markdown`记录可以忽略格式带来的困扰，让我们更加的专注于内容。\n\n脑图的结构也不复杂，就是一级一级的分支。使用markdown完全可以表达出来，关键是怎么渲染出来。\n\n## kityminder\n\n经多番查找，最终锁定了百度前端团队开源的——`kityminder`, [百度脑图](http://naotu.baidu.com/)也是使用这个构建的。\n\n`kityminder`分成了两部分，一部分是[kityminder-core](https://github.com/fex-team/kityminder-core),一个是[kityminder-editor](https://github.com/fex-team/kityminder-editor).\n\n\n{% asset_img relations.png %}\n\n### kityminder-core\n\nkityminder-core是百度脑图最核心部分的实现，主要包括了:\n\n- 包括脑图数据的可视化展示（Json 格式）\n\n- 包括简单的编辑功能（节点创建、编辑、删除）。更加强大编辑功能的 KityMinder 编辑器请移步 kityminder-editor\n\n- 不包含第三方格式（FreeMind、XMind、MindManager）的支持，可以加载 kityminder-protocol 来扩展第三方格式支持。\n\n- 不包含文件存储的支持，需要自行实现存储。可参照百度脑图中的开源的 fio + 百度网盘方案进行实现。\n\n### kityminder-editor\n\n> KityMinder Editor 是一款强大、简洁、体验优秀的脑图编辑工具，适合用于编辑树/图/网等结构的数据。\n\n> 编辑器由百度 FEX 基于 kityminder-core 搭建，并且在百度脑图中使用。\n\n## 让hexo支持kityminder\n\n这个主要是客户端渲染的。\n\n### 引入依赖\n\n引入`kityminder-core`的js和css，以及`kityminder-core`的依赖kity到相应的主题下面\n\n```\n//core压缩后的\nkityminder.core.min.js\n//kity的cdn地址\nhttps://cdn.rawgit.com/fex-team/kity/dev/dist/kity.min.js\n```\n\n### 为`mind map`找到一个标签\n\n渲染需要*数据*和*容器*节点。数据的标记应该越简单越好。\n\n查阅hexo的官方文档，发现了几个支持设置class属性的标签，以及raw标签。\n\n先来看看`raw`标签：\n\n```\n{% raw %}\ncontent\n{% endraw %}\n```\n\n`raw`标签里面是可以写html的，渲染的时候不会加以改变，但是写起了比较麻烦，失去了标记性语言简单的特性。\n\n`pull quote`标签：\n\n```\n{% pullquote [class] %}\ncontent\n{% endpullquote %}\n```\n\n`pull quote` 标签支持设置class属性，使用这个标签，然后设置一个我们自己的class，比如`mindmap`\n\n### 渲染数据\n\n```javascript\nsetTimeout(function() {\n        var minder = new kityminder.Minder({\n            renderTo: '.mindmap'\n        });\n        var markdownText = $('.mindmap').text().trim();\n        $('.mindmap p').each(function(index, element) {\n            element.style.display = 'none';\n        });\n        minder.importData('markdown', markdownText);\n        minder.disable();\n        minder.execCommand('hand');\n    },\n    3000\n)\n```\n\n使用markdown写mind map示例:\n\n```\n{% pullquote mindmap %}\n#主题\n##一级分支\n###二级分支\n##一级分支\n##一级分支\n###二级分支\n####三级分支\n{% endpullquote %}\n```\n\n渲染的效果\n\n{% pullquote mindmap %}\n#主题\n##一级分支\n###二级分支\n##一级分支\n##一级分支\n###二级分支\n####三级分支\n{% endpullquote %}\n\n# 参考\n\n1. [标签插件（Tag Plugins） | Hexo](https://hexo.io/zh-cn/docs/tag-plugins.html)","slug":"markdown-mindmap","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda0007zjh4kuxf1fqwp","content":"<h1 id=\"脑图是什么？\"><a href=\"#脑图是什么？\" class=\"headerlink\" title=\"脑图是什么？\"></a>脑图是什么？</h1><p>脑图英文叫做<code>mind map</code>, 是一种帮助发散思维的工具。将读过的书、看过的源码等总结成脑图，等下次需要复习的时候</p>\n<p>顺着脑图去看，效率非常高。</p>\n<img src=\"/2017/01/01/markdown-mindmap/sample.jpg\">\n<h2 id=\"用makrdown来画脑图\"><a href=\"#用makrdown来画脑图\" class=\"headerlink\" title=\"用makrdown来画脑图\"></a>用makrdown来画脑图</h2><p><code>markdown</code>是一种非常方便的标记性语言，使用<code>markdown</code>记录可以忽略格式带来的困扰，让我们更加的专注于内容。</p>\n<p>脑图的结构也不复杂，就是一级一级的分支。使用markdown完全可以表达出来，关键是怎么渲染出来。</p>\n<h2 id=\"kityminder\"><a href=\"#kityminder\" class=\"headerlink\" title=\"kityminder\"></a>kityminder</h2><p>经多番查找，最终锁定了百度前端团队开源的——<code>kityminder</code>, <a href=\"http://naotu.baidu.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">百度脑图</a>也是使用这个构建的。</p>\n<p><code>kityminder</code>分成了两部分，一部分是<a href=\"https://github.com/fex-team/kityminder-core\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">kityminder-core</a>,一个是<a href=\"https://github.com/fex-team/kityminder-editor\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">kityminder-editor</a>.</p>\n<img src=\"/2017/01/01/markdown-mindmap/relations.png\">\n<h3 id=\"kityminder-core\"><a href=\"#kityminder-core\" class=\"headerlink\" title=\"kityminder-core\"></a>kityminder-core</h3><p>kityminder-core是百度脑图最核心部分的实现，主要包括了:</p>\n<ul>\n<li><p>包括脑图数据的可视化展示（Json 格式）</p>\n</li>\n<li><p>包括简单的编辑功能（节点创建、编辑、删除）。更加强大编辑功能的 KityMinder 编辑器请移步 kityminder-editor</p>\n</li>\n<li><p>不包含第三方格式（FreeMind、XMind、MindManager）的支持，可以加载 kityminder-protocol 来扩展第三方格式支持。</p>\n</li>\n<li><p>不包含文件存储的支持，需要自行实现存储。可参照百度脑图中的开源的 fio + 百度网盘方案进行实现。</p>\n</li>\n</ul>\n<h3 id=\"kityminder-editor\"><a href=\"#kityminder-editor\" class=\"headerlink\" title=\"kityminder-editor\"></a>kityminder-editor</h3><blockquote>\n<p>KityMinder Editor 是一款强大、简洁、体验优秀的脑图编辑工具，适合用于编辑树/图/网等结构的数据。</p>\n<p>编辑器由百度 FEX 基于 kityminder-core 搭建，并且在百度脑图中使用。</p>\n</blockquote>\n<h2 id=\"让hexo支持kityminder\"><a href=\"#让hexo支持kityminder\" class=\"headerlink\" title=\"让hexo支持kityminder\"></a>让hexo支持kityminder</h2><p>这个主要是客户端渲染的。</p>\n<h3 id=\"引入依赖\"><a href=\"#引入依赖\" class=\"headerlink\" title=\"引入依赖\"></a>引入依赖</h3><p>引入<code>kityminder-core</code>的js和css，以及<code>kityminder-core</code>的依赖kity到相应的主题下面</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//core压缩后的</span><br><span class=\"line\">kityminder.core.min.js</span><br><span class=\"line\">//kity的cdn地址</span><br><span class=\"line\">https://cdn.rawgit.com/fex-team/kity/dev/dist/kity.min.js</span><br></pre></td></tr></table></figure>\n<h3 id=\"为mind-map找到一个标签\"><a href=\"#为mind-map找到一个标签\" class=\"headerlink\" title=\"为mind map找到一个标签\"></a>为<code>mind map</code>找到一个标签</h3><p>渲染需要<em>数据</em>和<em>容器</em>节点。数据的标记应该越简单越好。</p>\n<p>查阅hexo的官方文档，发现了几个支持设置class属性的标签，以及raw标签。</p>\n<p>先来看看<code>raw</code>标签：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% raw %&#125;</span><br><span class=\"line\">content</span><br><span class=\"line\">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>\n<p><code>raw</code>标签里面是可以写html的，渲染的时候不会加以改变，但是写起了比较麻烦，失去了标记性语言简单的特性。</p>\n<p><code>pull quote</code>标签：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% pullquote [class] %&#125;</span><br><span class=\"line\">content</span><br><span class=\"line\">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>\n<p><code>pull quote</code> 标签支持设置class属性，使用这个标签，然后设置一个我们自己的class，比如<code>mindmap</code></p>\n<h3 id=\"渲染数据\"><a href=\"#渲染数据\" class=\"headerlink\" title=\"渲染数据\"></a>渲染数据</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> minder = <span class=\"keyword\">new</span> kityminder.Minder(&#123;</span><br><span class=\"line\">            renderTo: <span class=\"string\">'.mindmap'</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">var</span> markdownText = $(<span class=\"string\">'.mindmap'</span>).text().trim();</span><br><span class=\"line\">        $(<span class=\"string\">'.mindmap p'</span>).each(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">index, element</span>) </span>&#123;</span><br><span class=\"line\">            element.style.display = <span class=\"string\">'none'</span>;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        minder.importData(<span class=\"string\">'markdown'</span>, markdownText);</span><br><span class=\"line\">        minder.disable();</span><br><span class=\"line\">        minder.execCommand(<span class=\"string\">'hand'</span>);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"number\">3000</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p>使用markdown写mind map示例:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% pullquote mindmap %&#125;</span><br><span class=\"line\">#主题</span><br><span class=\"line\">##一级分支</span><br><span class=\"line\">###二级分支</span><br><span class=\"line\">##一级分支</span><br><span class=\"line\">##一级分支</span><br><span class=\"line\">###二级分支</span><br><span class=\"line\">####三级分支</span><br><span class=\"line\">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>\n<p>渲染的效果</p>\n<blockquote class=\"pullquote mindmap\"><p>#主题</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>##一级分支</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>####三级分支</p>\n</blockquote>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><a href=\"https://hexo.io/zh-cn/docs/tag-plugins.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">标签插件（Tag Plugins） | Hexo</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"脑图是什么？\"><a href=\"#脑图是什么？\" class=\"headerlink\" title=\"脑图是什么？\"></a>脑图是什么？</h1><p>脑图英文叫做<code>mind map</code>, 是一种帮助发散思维的工具。将读过的书、看过的源码等总结成脑图，等下次需要复习的时候</p>\n<p>顺着脑图去看，效率非常高。</p>\n<img src=\"/2017/01/01/markdown-mindmap/sample.jpg\">\n<h2 id=\"用makrdown来画脑图\"><a href=\"#用makrdown来画脑图\" class=\"headerlink\" title=\"用makrdown来画脑图\"></a>用makrdown来画脑图</h2><p><code>markdown</code>是一种非常方便的标记性语言，使用<code>markdown</code>记录可以忽略格式带来的困扰，让我们更加的专注于内容。</p>\n<p>脑图的结构也不复杂，就是一级一级的分支。使用markdown完全可以表达出来，关键是怎么渲染出来。</p>\n<h2 id=\"kityminder\"><a href=\"#kityminder\" class=\"headerlink\" title=\"kityminder\"></a>kityminder</h2><p>经多番查找，最终锁定了百度前端团队开源的——<code>kityminder</code>, <a href=\"http://naotu.baidu.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">百度脑图</a>也是使用这个构建的。</p>\n<p><code>kityminder</code>分成了两部分，一部分是<a href=\"https://github.com/fex-team/kityminder-core\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">kityminder-core</a>,一个是<a href=\"https://github.com/fex-team/kityminder-editor\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">kityminder-editor</a>.</p>\n<img src=\"/2017/01/01/markdown-mindmap/relations.png\">\n<h3 id=\"kityminder-core\"><a href=\"#kityminder-core\" class=\"headerlink\" title=\"kityminder-core\"></a>kityminder-core</h3><p>kityminder-core是百度脑图最核心部分的实现，主要包括了:</p>\n<ul>\n<li><p>包括脑图数据的可视化展示（Json 格式）</p>\n</li>\n<li><p>包括简单的编辑功能（节点创建、编辑、删除）。更加强大编辑功能的 KityMinder 编辑器请移步 kityminder-editor</p>\n</li>\n<li><p>不包含第三方格式（FreeMind、XMind、MindManager）的支持，可以加载 kityminder-protocol 来扩展第三方格式支持。</p>\n</li>\n<li><p>不包含文件存储的支持，需要自行实现存储。可参照百度脑图中的开源的 fio + 百度网盘方案进行实现。</p>\n</li>\n</ul>\n<h3 id=\"kityminder-editor\"><a href=\"#kityminder-editor\" class=\"headerlink\" title=\"kityminder-editor\"></a>kityminder-editor</h3><blockquote>\n<p>KityMinder Editor 是一款强大、简洁、体验优秀的脑图编辑工具，适合用于编辑树/图/网等结构的数据。</p>\n<p>编辑器由百度 FEX 基于 kityminder-core 搭建，并且在百度脑图中使用。</p>\n</blockquote>\n<h2 id=\"让hexo支持kityminder\"><a href=\"#让hexo支持kityminder\" class=\"headerlink\" title=\"让hexo支持kityminder\"></a>让hexo支持kityminder</h2><p>这个主要是客户端渲染的。</p>\n<h3 id=\"引入依赖\"><a href=\"#引入依赖\" class=\"headerlink\" title=\"引入依赖\"></a>引入依赖</h3><p>引入<code>kityminder-core</code>的js和css，以及<code>kityminder-core</code>的依赖kity到相应的主题下面</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//core压缩后的</span><br><span class=\"line\">kityminder.core.min.js</span><br><span class=\"line\">//kity的cdn地址</span><br><span class=\"line\">https://cdn.rawgit.com/fex-team/kity/dev/dist/kity.min.js</span><br></pre></td></tr></table></figure>\n<h3 id=\"为mind-map找到一个标签\"><a href=\"#为mind-map找到一个标签\" class=\"headerlink\" title=\"为mind map找到一个标签\"></a>为<code>mind map</code>找到一个标签</h3><p>渲染需要<em>数据</em>和<em>容器</em>节点。数据的标记应该越简单越好。</p>\n<p>查阅hexo的官方文档，发现了几个支持设置class属性的标签，以及raw标签。</p>\n<p>先来看看<code>raw</code>标签：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% raw %&#125;</span><br><span class=\"line\">content</span><br><span class=\"line\">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>\n<p><code>raw</code>标签里面是可以写html的，渲染的时候不会加以改变，但是写起了比较麻烦，失去了标记性语言简单的特性。</p>\n<p><code>pull quote</code>标签：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% pullquote [class] %&#125;</span><br><span class=\"line\">content</span><br><span class=\"line\">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>\n<p><code>pull quote</code> 标签支持设置class属性，使用这个标签，然后设置一个我们自己的class，比如<code>mindmap</code></p>\n<h3 id=\"渲染数据\"><a href=\"#渲染数据\" class=\"headerlink\" title=\"渲染数据\"></a>渲染数据</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> minder = <span class=\"keyword\">new</span> kityminder.Minder(&#123;</span><br><span class=\"line\">            renderTo: <span class=\"string\">'.mindmap'</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">var</span> markdownText = $(<span class=\"string\">'.mindmap'</span>).text().trim();</span><br><span class=\"line\">        $(<span class=\"string\">'.mindmap p'</span>).each(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">index, element</span>) </span>&#123;</span><br><span class=\"line\">            element.style.display = <span class=\"string\">'none'</span>;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        minder.importData(<span class=\"string\">'markdown'</span>, markdownText);</span><br><span class=\"line\">        minder.disable();</span><br><span class=\"line\">        minder.execCommand(<span class=\"string\">'hand'</span>);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"number\">3000</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p>使用markdown写mind map示例:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% pullquote mindmap %&#125;</span><br><span class=\"line\">#主题</span><br><span class=\"line\">##一级分支</span><br><span class=\"line\">###二级分支</span><br><span class=\"line\">##一级分支</span><br><span class=\"line\">##一级分支</span><br><span class=\"line\">###二级分支</span><br><span class=\"line\">####三级分支</span><br><span class=\"line\">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>\n<p>渲染的效果</p>\n<blockquote class=\"pullquote mindmap\"><p>#主题</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>##一级分支</p>\n<p>##一级分支</p>\n<p>###二级分支</p>\n<p>####三级分支</p>\n</blockquote>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><a href=\"https://hexo.io/zh-cn/docs/tag-plugins.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">标签插件（Tag Plugins） | Hexo</a></li>\n</ol>\n"},{"title":"maven-scope","toc":true,"abbrlink":24920,"date":"2017-05-31T16:42:54.000Z","_content":"\n\n## scope 作用\n\n> Dependency scope is used to limit the transitivity of a dependency, and also to affect the classpath used for various build tasks.\n\n主要是限制依赖的传递性，比如有些jar包只会在测试的时候才会有效，部署的时候不会生效。\n\nscope的分类：\n\n\n| scope | 生效时机 | 举例 |\n|--|---------|--- |\n| compiled | 编译/测试/运行 | 默认 |\n| provided | 编译/测试 | servlet-api 由tomcat等容器提供 | \n| runtime | 运行 | 编译的时候只需要，JDBC API， 运行的时候必须要有JDBC驱动实现 |\n| test | 测试的时候才引入 | junit 只在测试的时候生效 |\n|system |编译/测试 | 必须显式的提供jar的本地文件系统路径 |\n|import | 只支持`dependencyManagement`元素下的type是pom的节点| only available in Maven 2.0.9 or later |\n\n### import scope\n\n使用方\n\n```xml\n   <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>com.air</groupId>\n                <artifactId>haha</artifactId>\n                <version>${com.air.haha.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n    </dependencyManagement>\n```\n\ncom.air.haha的声明\n\n```xml\n<project>\n <modelVersion>4.0.0</modelVersion>\n <groupId>com.air</groupId>\n <artifactId>haha</artifactId>\n <packaging>pom</packaging>\n <name>haha</name>\n <version>1.0</version>\n <dependencyManagement>\n   <dependencies>\n     <dependency>\n       <groupId>test</groupId>\n       <artifactId>a</artifactId>\n       <version>1.2</version>\n     </dependency>\n     <dependency>\n       <groupId>test</groupId>\n       <artifactId>b</artifactId>\n       <version>1.0</version>\n       <scope>compile</scope>\n     </dependency>\n   </dependencies>\n </dependencyManagement>\n</project>\n```\n\n使用方在使用的时候就可以不用指定，haha中包含的依赖的版本，默认就会使用haha中声明的版本。这样在升级的时候，可以保证依赖一同的升级。\n\n## 参考\n\n1. [Maven – Introduction to the Dependency Mechanism](https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html)\n\n2. 《Maven权威指南》—— 9.4 （项目依赖）\n\n","source":"_posts/maven-scope.md","raw":"title: maven-scope\ntags: maven\ncategory: java\ntoc: true\nabbrlink: 24920\ndate: 2017-06-01 00:42:54\n---\n\n\n## scope 作用\n\n> Dependency scope is used to limit the transitivity of a dependency, and also to affect the classpath used for various build tasks.\n\n主要是限制依赖的传递性，比如有些jar包只会在测试的时候才会有效，部署的时候不会生效。\n\nscope的分类：\n\n\n| scope | 生效时机 | 举例 |\n|--|---------|--- |\n| compiled | 编译/测试/运行 | 默认 |\n| provided | 编译/测试 | servlet-api 由tomcat等容器提供 | \n| runtime | 运行 | 编译的时候只需要，JDBC API， 运行的时候必须要有JDBC驱动实现 |\n| test | 测试的时候才引入 | junit 只在测试的时候生效 |\n|system |编译/测试 | 必须显式的提供jar的本地文件系统路径 |\n|import | 只支持`dependencyManagement`元素下的type是pom的节点| only available in Maven 2.0.9 or later |\n\n### import scope\n\n使用方\n\n```xml\n   <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>com.air</groupId>\n                <artifactId>haha</artifactId>\n                <version>${com.air.haha.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n    </dependencyManagement>\n```\n\ncom.air.haha的声明\n\n```xml\n<project>\n <modelVersion>4.0.0</modelVersion>\n <groupId>com.air</groupId>\n <artifactId>haha</artifactId>\n <packaging>pom</packaging>\n <name>haha</name>\n <version>1.0</version>\n <dependencyManagement>\n   <dependencies>\n     <dependency>\n       <groupId>test</groupId>\n       <artifactId>a</artifactId>\n       <version>1.2</version>\n     </dependency>\n     <dependency>\n       <groupId>test</groupId>\n       <artifactId>b</artifactId>\n       <version>1.0</version>\n       <scope>compile</scope>\n     </dependency>\n   </dependencies>\n </dependencyManagement>\n</project>\n```\n\n使用方在使用的时候就可以不用指定，haha中包含的依赖的版本，默认就会使用haha中声明的版本。这样在升级的时候，可以保证依赖一同的升级。\n\n## 参考\n\n1. [Maven – Introduction to the Dependency Mechanism](https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html)\n\n2. 《Maven权威指南》—— 9.4 （项目依赖）\n\n","slug":"maven-scope","published":1,"updated":"2017-05-31T16:42:54.077Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda10082jh4kraxes900","content":"<h2 id=\"scope-作用\"><a href=\"#scope-作用\" class=\"headerlink\" title=\"scope 作用\"></a>scope 作用</h2><blockquote>\n<p>Dependency scope is used to limit the transitivity of a dependency, and also to affect the classpath used for various build tasks.</p>\n</blockquote>\n<p>主要是限制依赖的传递性，比如有些jar包只会在测试的时候才会有效，部署的时候不会生效。</p>\n<p>scope的分类：</p>\n<table>\n<thead>\n<tr>\n<th>scope</th>\n<th>生效时机</th>\n<th>举例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>compiled</td>\n<td>编译/测试/运行</td>\n<td>默认</td>\n</tr>\n<tr>\n<td>provided</td>\n<td>编译/测试</td>\n<td>servlet-api 由tomcat等容器提供</td>\n</tr>\n<tr>\n<td>runtime</td>\n<td>运行</td>\n<td>编译的时候只需要，JDBC API， 运行的时候必须要有JDBC驱动实现</td>\n</tr>\n<tr>\n<td>test</td>\n<td>测试的时候才引入</td>\n<td>junit 只在测试的时候生效</td>\n</tr>\n<tr>\n<td>system</td>\n<td>编译/测试</td>\n<td>必须显式的提供jar的本地文件系统路径</td>\n</tr>\n<tr>\n<td>import</td>\n<td>只支持<code>dependencyManagement</code>元素下的type是pom的节点</td>\n<td>only available in Maven 2.0.9 or later</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"import-scope\"><a href=\"#import-scope\" class=\"headerlink\" title=\"import scope\"></a>import scope</h3><p>使用方</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.air<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>haha<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;com.air.haha.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>import<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>com.air.haha的声明</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.air<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>haha<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">packaging</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">packaging</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>haha<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>a<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>b<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>compile<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>使用方在使用的时候就可以不用指定，haha中包含的依赖的版本，默认就会使用haha中声明的版本。这样在升级的时候，可以保证依赖一同的升级。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maven – Introduction to the Dependency Mechanism</a></p>\n</li>\n<li><p>《Maven权威指南》—— 9.4 （项目依赖）</p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"scope-作用\"><a href=\"#scope-作用\" class=\"headerlink\" title=\"scope 作用\"></a>scope 作用</h2><blockquote>\n<p>Dependency scope is used to limit the transitivity of a dependency, and also to affect the classpath used for various build tasks.</p>\n</blockquote>\n<p>主要是限制依赖的传递性，比如有些jar包只会在测试的时候才会有效，部署的时候不会生效。</p>\n<p>scope的分类：</p>\n<table>\n<thead>\n<tr>\n<th>scope</th>\n<th>生效时机</th>\n<th>举例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>compiled</td>\n<td>编译/测试/运行</td>\n<td>默认</td>\n</tr>\n<tr>\n<td>provided</td>\n<td>编译/测试</td>\n<td>servlet-api 由tomcat等容器提供</td>\n</tr>\n<tr>\n<td>runtime</td>\n<td>运行</td>\n<td>编译的时候只需要，JDBC API， 运行的时候必须要有JDBC驱动实现</td>\n</tr>\n<tr>\n<td>test</td>\n<td>测试的时候才引入</td>\n<td>junit 只在测试的时候生效</td>\n</tr>\n<tr>\n<td>system</td>\n<td>编译/测试</td>\n<td>必须显式的提供jar的本地文件系统路径</td>\n</tr>\n<tr>\n<td>import</td>\n<td>只支持<code>dependencyManagement</code>元素下的type是pom的节点</td>\n<td>only available in Maven 2.0.9 or later</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"import-scope\"><a href=\"#import-scope\" class=\"headerlink\" title=\"import scope\"></a>import scope</h3><p>使用方</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.air<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>haha<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;com.air.haha.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>import<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>com.air.haha的声明</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.air<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>haha<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">packaging</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">packaging</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>haha<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>a<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>b<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>compile<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>使用方在使用的时候就可以不用指定，haha中包含的依赖的版本，默认就会使用haha中声明的版本。这样在升级的时候，可以保证依赖一同的升级。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maven – Introduction to the Dependency Mechanism</a></p>\n</li>\n<li><p>《Maven权威指南》—— 9.4 （项目依赖）</p>\n</li>\n</ol>\n"},{"title":"netcat(nc) —— 使用小结","toc":true,"abbrlink":1919,"date":"2016-12-18T03:29:28.000Z","_content":"\n\nnc的全称是netcat，提供了许多关于网络操作的功能，号称网络工具中的瑞士军刀。\n\nnc也有windows的移植版本：[](https://eternallybored.org/misc/netcat/)\n\n>   Netcat is a featured networking utility which reads and writes data across network connections, using the TCP/IP protocol.\nIt is designed to be a reliable \"back-end\" tool that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and exploration tool, since it can create almost any kind of connection you would need and has several interesting built-in capabilities.\n\n## 常见用途\n### nc 传输文件：\n\n- 传送文件\n\n发送端：`nc -l 6666 < file`\n接收端: `nc host 6666 | pv -L 30m > wrapper`\n\n其中pv是一个限流的工具。\n\n- 压缩传输一个文件夹\n\n`tar zcvf folder.tar.gz folder | nc -l 6666`\n\n\n## 参考链接\n\n1. [The GNU Netcat](http://netcat.sourceforge.net/)\n2. [Linux Netcat 命令——网络工具中的瑞士军刀](https://www.oschina.net/translate/linux-netcat-command)","source":"_posts/nc.md","raw":"---\ntitle: netcat(nc) —— 使用小结\ntags: netcat\ncategory: shell\ntoc: true\nabbrlink: 1919\ndate: 2016-12-18 11:29:28\n---\n\n\nnc的全称是netcat，提供了许多关于网络操作的功能，号称网络工具中的瑞士军刀。\n\nnc也有windows的移植版本：[](https://eternallybored.org/misc/netcat/)\n\n>   Netcat is a featured networking utility which reads and writes data across network connections, using the TCP/IP protocol.\nIt is designed to be a reliable \"back-end\" tool that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and exploration tool, since it can create almost any kind of connection you would need and has several interesting built-in capabilities.\n\n## 常见用途\n### nc 传输文件：\n\n- 传送文件\n\n发送端：`nc -l 6666 < file`\n接收端: `nc host 6666 | pv -L 30m > wrapper`\n\n其中pv是一个限流的工具。\n\n- 压缩传输一个文件夹\n\n`tar zcvf folder.tar.gz folder | nc -l 6666`\n\n\n## 参考链接\n\n1. [The GNU Netcat](http://netcat.sourceforge.net/)\n2. [Linux Netcat 命令——网络工具中的瑞士军刀](https://www.oschina.net/translate/linux-netcat-command)","slug":"nc","published":1,"updated":"2017-04-16T12:03:23.393Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda20086jh4k0a3ayv9p","content":"<p>nc的全称是netcat，提供了许多关于网络操作的功能，号称网络工具中的瑞士军刀。</p>\n<p>nc也有windows的移植版本：<a href=\"https://eternallybored.org/misc/netcat/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"></a></p>\n<blockquote>\n<p>  Netcat is a featured networking utility which reads and writes data across network connections, using the TCP/IP protocol.<br>It is designed to be a reliable “back-end” tool that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and exploration tool, since it can create almost any kind of connection you would need and has several interesting built-in capabilities.</p>\n</blockquote>\n<h2 id=\"常见用途\"><a href=\"#常见用途\" class=\"headerlink\" title=\"常见用途\"></a>常见用途</h2><h3 id=\"nc-传输文件：\"><a href=\"#nc-传输文件：\" class=\"headerlink\" title=\"nc 传输文件：\"></a>nc 传输文件：</h3><ul>\n<li>传送文件</li>\n</ul>\n<p>发送端：<code>nc -l 6666 &lt; file</code><br>接收端: <code>nc host 6666 | pv -L 30m &gt; wrapper</code></p>\n<p>其中pv是一个限流的工具。</p>\n<ul>\n<li>压缩传输一个文件夹</li>\n</ul>\n<p><code>tar zcvf folder.tar.gz folder | nc -l 6666</code></p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><a href=\"http://netcat.sourceforge.net/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The GNU Netcat</a></li>\n<li><a href=\"https://www.oschina.net/translate/linux-netcat-command\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux Netcat 命令——网络工具中的瑞士军刀</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>nc的全称是netcat，提供了许多关于网络操作的功能，号称网络工具中的瑞士军刀。</p>\n<p>nc也有windows的移植版本：<a href=\"https://eternallybored.org/misc/netcat/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"></a></p>\n<blockquote>\n<p>  Netcat is a featured networking utility which reads and writes data across network connections, using the TCP/IP protocol.<br>It is designed to be a reliable “back-end” tool that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and exploration tool, since it can create almost any kind of connection you would need and has several interesting built-in capabilities.</p>\n</blockquote>\n<h2 id=\"常见用途\"><a href=\"#常见用途\" class=\"headerlink\" title=\"常见用途\"></a>常见用途</h2><h3 id=\"nc-传输文件：\"><a href=\"#nc-传输文件：\" class=\"headerlink\" title=\"nc 传输文件：\"></a>nc 传输文件：</h3><ul>\n<li>传送文件</li>\n</ul>\n<p>发送端：<code>nc -l 6666 &lt; file</code><br>接收端: <code>nc host 6666 | pv -L 30m &gt; wrapper</code></p>\n<p>其中pv是一个限流的工具。</p>\n<ul>\n<li>压缩传输一个文件夹</li>\n</ul>\n<p><code>tar zcvf folder.tar.gz folder | nc -l 6666</code></p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><ol>\n<li><a href=\"http://netcat.sourceforge.net/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The GNU Netcat</a></li>\n<li><a href=\"https://www.oschina.net/translate/linux-netcat-command\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux Netcat 命令——网络工具中的瑞士军刀</a></li>\n</ol>\n"},{"title":"数据库分页","toc":true,"abbrlink":9818,"date":"2016-09-29T16:19:07.000Z","_content":"\n## 逻辑分页\n\n就是将所有的结果集拿出来，然后在程序中进行截取，由于所有的数据都是在内存中的，占用内存比较大\n\n## 物理分页\n\n物理分页是指基于数据库提供的类似 `limit offset,rows`这样的语法。\n\n但是，比如`limit 10000,20`,  就会读取10020条数据，但是只会返回后面20条数据。\n\n## 手工计算\n\n如果id是有序的，可以做一个简单的转换，比如使用  `where id between 10000 and 10020`, 这样的效率就会相对的高些\n\n## 附件\n [PPC2009_mysql_pagination.pdf](PPC2009_mysql_pagination.pdf)\n","source":"_posts/pagination.md","raw":"---\ntitle: 数据库分页\ntags: mysql\ncategory: base\ntoc: true\nabbrlink: 9818\ndate: 2016-09-30 00:19:07\n---\n\n## 逻辑分页\n\n就是将所有的结果集拿出来，然后在程序中进行截取，由于所有的数据都是在内存中的，占用内存比较大\n\n## 物理分页\n\n物理分页是指基于数据库提供的类似 `limit offset,rows`这样的语法。\n\n但是，比如`limit 10000,20`,  就会读取10020条数据，但是只会返回后面20条数据。\n\n## 手工计算\n\n如果id是有序的，可以做一个简单的转换，比如使用  `where id between 10000 and 10020`, 这样的效率就会相对的高些\n\n## 附件\n [PPC2009_mysql_pagination.pdf](PPC2009_mysql_pagination.pdf)\n","slug":"pagination","published":1,"updated":"2017-04-16T12:03:23.397Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda4008ajh4k1sffayxq","content":"<h2 id=\"逻辑分页\"><a href=\"#逻辑分页\" class=\"headerlink\" title=\"逻辑分页\"></a>逻辑分页</h2><p>就是将所有的结果集拿出来，然后在程序中进行截取，由于所有的数据都是在内存中的，占用内存比较大</p>\n<h2 id=\"物理分页\"><a href=\"#物理分页\" class=\"headerlink\" title=\"物理分页\"></a>物理分页</h2><p>物理分页是指基于数据库提供的类似 <code>limit offset,rows</code>这样的语法。</p>\n<p>但是，比如<code>limit 10000,20</code>,  就会读取10020条数据，但是只会返回后面20条数据。</p>\n<h2 id=\"手工计算\"><a href=\"#手工计算\" class=\"headerlink\" title=\"手工计算\"></a>手工计算</h2><p>如果id是有序的，可以做一个简单的转换，比如使用  <code>where id between 10000 and 10020</code>, 这样的效率就会相对的高些</p>\n<h2 id=\"附件\"><a href=\"#附件\" class=\"headerlink\" title=\"附件\"></a>附件</h2><p> <a href=\"PPC2009_mysql_pagination.pdf\">PPC2009_mysql_pagination.pdf</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"逻辑分页\"><a href=\"#逻辑分页\" class=\"headerlink\" title=\"逻辑分页\"></a>逻辑分页</h2><p>就是将所有的结果集拿出来，然后在程序中进行截取，由于所有的数据都是在内存中的，占用内存比较大</p>\n<h2 id=\"物理分页\"><a href=\"#物理分页\" class=\"headerlink\" title=\"物理分页\"></a>物理分页</h2><p>物理分页是指基于数据库提供的类似 <code>limit offset,rows</code>这样的语法。</p>\n<p>但是，比如<code>limit 10000,20</code>,  就会读取10020条数据，但是只会返回后面20条数据。</p>\n<h2 id=\"手工计算\"><a href=\"#手工计算\" class=\"headerlink\" title=\"手工计算\"></a>手工计算</h2><p>如果id是有序的，可以做一个简单的转换，比如使用  <code>where id between 10000 and 10020</code>, 这样的效率就会相对的高些</p>\n<h2 id=\"附件\"><a href=\"#附件\" class=\"headerlink\" title=\"附件\"></a>附件</h2><p> <a href=\"PPC2009_mysql_pagination.pdf\">PPC2009_mysql_pagination.pdf</a></p>\n"},{"title":"pip使用","toc":true,"abbrlink":9555,"date":"2017-01-08T10:30:03.000Z","_content":"\n\n## 使用\n\n### 安装\n\n下载安装文件, [](https://bootstrap.pypa.io/get-pip.py)\n\n```bash\npython get-pip.py\n```\n\n### 从列表文件安装\n\n导出文件列表(一般配合virtualenv适应)\n\n```bash\n$ pip freeze                               \nbackports-abc==0.4                         \nbackports.shutil-get-terminal-size==1.0.0  \nbackports.ssl-match-hostname==3.5.0.1      \nbeautifulsoup4==4.5.1                      \nbs4==0.0.1                                 \n...\n```\n可以重定向到一个文件中，一般叫做requirements.txt\n\n然后安装的时候，可以使用下面的命令\n\n```bash\npip install -r requirements.txt\n```\n\n\n### 安装VCS上的软件\n\n> pip currently supports cloning over git, git+http, git+https, git+ssh, git+git and git+file:\n\n```\n[-e] git://git.myproject.org/MyProject#egg=MyProject\n[-e] git+http://git.myproject.org/MyProject#egg=MyProject\n[-e] git+https://git.myproject.org/MyProject#egg=MyProject\n[-e] git+ssh://git.myproject.org/MyProject#egg=MyProject\n[-e] git+git://git.myproject.org/MyProject#egg=MyProject\n[-e] git+file://git.myproject.org/MyProject#egg=MyProject\n-e git+git@git.myproject.org:MyProject#egg=MyProject\n```\n\n## 参考\n\n1. [pip install — pip 9.0.1 documentation](https://pip.pypa.io/en/stable/reference/pip_install/#vcs-support)\n\n2. [Django | requirement.txt 生成 - 黑月亮 - SegmentFault](https://segmentfault.com/a/1190000003050954)","source":"_posts/pip.md","raw":"---\ntitle: pip使用\ntags: pip\ncategory: python\ntoc: true\nabbrlink: 9555\ndate: 2017-01-08 18:30:03\n---\n\n\n## 使用\n\n### 安装\n\n下载安装文件, [](https://bootstrap.pypa.io/get-pip.py)\n\n```bash\npython get-pip.py\n```\n\n### 从列表文件安装\n\n导出文件列表(一般配合virtualenv适应)\n\n```bash\n$ pip freeze                               \nbackports-abc==0.4                         \nbackports.shutil-get-terminal-size==1.0.0  \nbackports.ssl-match-hostname==3.5.0.1      \nbeautifulsoup4==4.5.1                      \nbs4==0.0.1                                 \n...\n```\n可以重定向到一个文件中，一般叫做requirements.txt\n\n然后安装的时候，可以使用下面的命令\n\n```bash\npip install -r requirements.txt\n```\n\n\n### 安装VCS上的软件\n\n> pip currently supports cloning over git, git+http, git+https, git+ssh, git+git and git+file:\n\n```\n[-e] git://git.myproject.org/MyProject#egg=MyProject\n[-e] git+http://git.myproject.org/MyProject#egg=MyProject\n[-e] git+https://git.myproject.org/MyProject#egg=MyProject\n[-e] git+ssh://git.myproject.org/MyProject#egg=MyProject\n[-e] git+git://git.myproject.org/MyProject#egg=MyProject\n[-e] git+file://git.myproject.org/MyProject#egg=MyProject\n-e git+git@git.myproject.org:MyProject#egg=MyProject\n```\n\n## 参考\n\n1. [pip install — pip 9.0.1 documentation](https://pip.pypa.io/en/stable/reference/pip_install/#vcs-support)\n\n2. [Django | requirement.txt 生成 - 黑月亮 - SegmentFault](https://segmentfault.com/a/1190000003050954)","slug":"pip","published":1,"updated":"2017-04-16T12:03:23.397Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda5008djh4kchvuvjqh","content":"<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>下载安装文件, <a href=\"https://bootstrap.pypa.io/get-pip.py\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"></a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python get-pip.py</span><br></pre></td></tr></table></figure>\n<h3 id=\"从列表文件安装\"><a href=\"#从列表文件安装\" class=\"headerlink\" title=\"从列表文件安装\"></a>从列表文件安装</h3><p>导出文件列表(一般配合virtualenv适应)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip freeze                               </span><br><span class=\"line\">backports-abc==0.4                         </span><br><span class=\"line\">backports.shutil-get-terminal-size==1.0.0  </span><br><span class=\"line\">backports.ssl-match-hostname==3.5.0.1      </span><br><span class=\"line\">beautifulsoup4==4.5.1                      </span><br><span class=\"line\">bs4==0.0.1                                 </span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>可以重定向到一个文件中，一般叫做requirements.txt</p>\n<p>然后安装的时候，可以使用下面的命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装VCS上的软件\"><a href=\"#安装VCS上的软件\" class=\"headerlink\" title=\"安装VCS上的软件\"></a>安装VCS上的软件</h3><blockquote>\n<p>pip currently supports cloning over git, git+http, git+https, git+ssh, git+git and git+file:</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[-e] git://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+http://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+https://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+ssh://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+git://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+file://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">-e git+git@git.myproject.org:MyProject#egg=MyProject</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://pip.pypa.io/en/stable/reference/pip_install/#vcs-support\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">pip install — pip 9.0.1 documentation</a></p>\n</li>\n<li><p><a href=\"https://segmentfault.com/a/1190000003050954\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Django | requirement.txt 生成 - 黑月亮 - SegmentFault</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>下载安装文件, <a href=\"https://bootstrap.pypa.io/get-pip.py\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"></a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python get-pip.py</span><br></pre></td></tr></table></figure>\n<h3 id=\"从列表文件安装\"><a href=\"#从列表文件安装\" class=\"headerlink\" title=\"从列表文件安装\"></a>从列表文件安装</h3><p>导出文件列表(一般配合virtualenv适应)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip freeze                               </span><br><span class=\"line\">backports-abc==0.4                         </span><br><span class=\"line\">backports.shutil-get-terminal-size==1.0.0  </span><br><span class=\"line\">backports.ssl-match-hostname==3.5.0.1      </span><br><span class=\"line\">beautifulsoup4==4.5.1                      </span><br><span class=\"line\">bs4==0.0.1                                 </span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>可以重定向到一个文件中，一般叫做requirements.txt</p>\n<p>然后安装的时候，可以使用下面的命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装VCS上的软件\"><a href=\"#安装VCS上的软件\" class=\"headerlink\" title=\"安装VCS上的软件\"></a>安装VCS上的软件</h3><blockquote>\n<p>pip currently supports cloning over git, git+http, git+https, git+ssh, git+git and git+file:</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[-e] git://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+http://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+https://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+ssh://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+git://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">[-e] git+file://git.myproject.org/MyProject#egg=MyProject</span><br><span class=\"line\">-e git+git@git.myproject.org:MyProject#egg=MyProject</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://pip.pypa.io/en/stable/reference/pip_install/#vcs-support\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">pip install — pip 9.0.1 documentation</a></p>\n</li>\n<li><p><a href=\"https://segmentfault.com/a/1190000003050954\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Django | requirement.txt 生成 - 黑月亮 - SegmentFault</a></p>\n</li>\n</ol>\n"},{"title":"线上问题排查简介","toc":true,"_content":"\n## CPU\n\n### 线程切换\n\n### slow stack\n\n\n\n## memory\n\n### off heap memory\n\n### pmap\n\n### swap 使用\n\n\n## greys-an\n\n### 接口响应慢\n\n## core dump\n\n### jstack\n\n### pstack\n\n## heap dump \n\n### mat\n\n堆内存过大，如何分析\n\n## GC\n\njstat\n\n频率， 每次young gc 留存\n\nthreshold 监控\n\n\n\n## 其他\n\n监控， 日志， P98\n\n秒级 平均\n\nstrace perf\n\n\n\n## 参考\n\n1. [使用 Eclipse Memory Analyzer 进行堆转储文件分析](https://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html)\n\n2. <<Java性能优化权威指南>>\n\n3.","source":"_drafts/problem-tuning.md","raw":"title: 线上问题排查简介\ntoc: true\ntags: tuning\ncategory: java\n---\n\n## CPU\n\n### 线程切换\n\n### slow stack\n\n\n\n## memory\n\n### off heap memory\n\n### pmap\n\n### swap 使用\n\n\n## greys-an\n\n### 接口响应慢\n\n## core dump\n\n### jstack\n\n### pstack\n\n## heap dump \n\n### mat\n\n堆内存过大，如何分析\n\n## GC\n\njstat\n\n频率， 每次young gc 留存\n\nthreshold 监控\n\n\n\n## 其他\n\n监控， 日志， P98\n\n秒级 平均\n\nstrace perf\n\n\n\n## 参考\n\n1. [使用 Eclipse Memory Analyzer 进行堆转储文件分析](https://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html)\n\n2. <<Java性能优化权威指南>>\n\n3.","slug":"problem-tuning","published":0,"date":"2018-03-15T00:42:03.233Z","updated":"2017-11-12T06:58:41.513Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda6008gjh4kz4farbe9","content":"<h2 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h2><h3 id=\"线程切换\"><a href=\"#线程切换\" class=\"headerlink\" title=\"线程切换\"></a>线程切换</h3><h3 id=\"slow-stack\"><a href=\"#slow-stack\" class=\"headerlink\" title=\"slow stack\"></a>slow stack</h3><h2 id=\"memory\"><a href=\"#memory\" class=\"headerlink\" title=\"memory\"></a>memory</h2><h3 id=\"off-heap-memory\"><a href=\"#off-heap-memory\" class=\"headerlink\" title=\"off heap memory\"></a>off heap memory</h3><h3 id=\"pmap\"><a href=\"#pmap\" class=\"headerlink\" title=\"pmap\"></a>pmap</h3><h3 id=\"swap-使用\"><a href=\"#swap-使用\" class=\"headerlink\" title=\"swap 使用\"></a>swap 使用</h3><h2 id=\"greys-an\"><a href=\"#greys-an\" class=\"headerlink\" title=\"greys-an\"></a>greys-an</h2><h3 id=\"接口响应慢\"><a href=\"#接口响应慢\" class=\"headerlink\" title=\"接口响应慢\"></a>接口响应慢</h3><h2 id=\"core-dump\"><a href=\"#core-dump\" class=\"headerlink\" title=\"core dump\"></a>core dump</h2><h3 id=\"jstack\"><a href=\"#jstack\" class=\"headerlink\" title=\"jstack\"></a>jstack</h3><h3 id=\"pstack\"><a href=\"#pstack\" class=\"headerlink\" title=\"pstack\"></a>pstack</h3><h2 id=\"heap-dump\"><a href=\"#heap-dump\" class=\"headerlink\" title=\"heap dump\"></a>heap dump</h2><h3 id=\"mat\"><a href=\"#mat\" class=\"headerlink\" title=\"mat\"></a>mat</h3><p>堆内存过大，如何分析</p>\n<h2 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h2><p>jstat</p>\n<p>频率， 每次young gc 留存</p>\n<p>threshold 监控</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>监控， 日志， P98</p>\n<p>秒级 平均</p>\n<p>strace perf</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">使用 Eclipse Memory Analyzer 进行堆转储文件分析</a></p>\n</li>\n<li><p>&lt;<java性能优化权威指南>&gt;</java性能优化权威指南></p>\n</li>\n</ol>\n<p>3.</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h2><h3 id=\"线程切换\"><a href=\"#线程切换\" class=\"headerlink\" title=\"线程切换\"></a>线程切换</h3><h3 id=\"slow-stack\"><a href=\"#slow-stack\" class=\"headerlink\" title=\"slow stack\"></a>slow stack</h3><h2 id=\"memory\"><a href=\"#memory\" class=\"headerlink\" title=\"memory\"></a>memory</h2><h3 id=\"off-heap-memory\"><a href=\"#off-heap-memory\" class=\"headerlink\" title=\"off heap memory\"></a>off heap memory</h3><h3 id=\"pmap\"><a href=\"#pmap\" class=\"headerlink\" title=\"pmap\"></a>pmap</h3><h3 id=\"swap-使用\"><a href=\"#swap-使用\" class=\"headerlink\" title=\"swap 使用\"></a>swap 使用</h3><h2 id=\"greys-an\"><a href=\"#greys-an\" class=\"headerlink\" title=\"greys-an\"></a>greys-an</h2><h3 id=\"接口响应慢\"><a href=\"#接口响应慢\" class=\"headerlink\" title=\"接口响应慢\"></a>接口响应慢</h3><h2 id=\"core-dump\"><a href=\"#core-dump\" class=\"headerlink\" title=\"core dump\"></a>core dump</h2><h3 id=\"jstack\"><a href=\"#jstack\" class=\"headerlink\" title=\"jstack\"></a>jstack</h3><h3 id=\"pstack\"><a href=\"#pstack\" class=\"headerlink\" title=\"pstack\"></a>pstack</h3><h2 id=\"heap-dump\"><a href=\"#heap-dump\" class=\"headerlink\" title=\"heap dump\"></a>heap dump</h2><h3 id=\"mat\"><a href=\"#mat\" class=\"headerlink\" title=\"mat\"></a>mat</h3><p>堆内存过大，如何分析</p>\n<h2 id=\"GC\"><a href=\"#GC\" class=\"headerlink\" title=\"GC\"></a>GC</h2><p>jstat</p>\n<p>频率， 每次young gc 留存</p>\n<p>threshold 监控</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>监控， 日志， P98</p>\n<p>秒级 平均</p>\n<p>strace perf</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">使用 Eclipse Memory Analyzer 进行堆转储文件分析</a></p>\n</li>\n<li><p>&lt;<java性能优化权威指南>&gt;</java性能优化权威指南></p>\n</li>\n</ol>\n<p>3.</p>\n"},{"title":"python 小技巧","toc":true,"abbrlink":49451,"date":"2016-12-18T03:57:35.000Z","_content":"\n\n## 开启一个简单的HTTP Server\n\n- 命令：\n\n`python -m SimpleHTTPServer port`\n\n`-m` 是指后面跟的是python的一个Modlue\n\n`port` 默认是`8080`，可以自行指定。\n\n- 作用：\n\n1. 可以当一个简单的httpserver，做测试用\n\n2. 可以简单的传输一些小文件（大文件性能不好，经常中断）,大文件的传输可以用nc\n\n见： {% post_link nc %}\n\n## 简单的cig server\n\n- 命令：\n`python -m CGIHTTPServer port`\n\n- 作用:\n\n可以开启一个简单的cgi服务器，支持python作为cgi的语言，cgi的脚本须放置在root目录下的`cgi-bin`\n\n## 格式化 json数据\n\n- 命令:\n\n`curl http://my_url/ | python -m json.tool`\n\n- 作用:\n\n在返回大量json数据时，在命令行里可以用这个工具进行格式化。\n\nchrome浏览器中的`JsonView`插件可以做到同样的事情[chrome商店链接](https://chrome.google.com/webstore/detail/json-viewer/aimiinbnnkboelefkjlenlgimcabobli?utm_source=chrome-ntp-icon)\n\n- 缺陷：\n\npython 2.x 中是使用ASCII码作为默认编码的，因此json中如果带有中文就只是16进制的表示，可以修改`json.tool`的源代码。\n\n参见[json处理小技巧](http://axiaoxin.com/article/77/)\n\n> Python也有命令行里面格式化显示json的模块json.tool\n\n> cat data.json\n{\"爱\": \"我\", \"中\": \"华\"}\n> cat data.json| python -m json.tool\n{\n    \"\\u4e2d\": \"\\u534e\",\n    \"\\u7231\": \"\\u6211\"\n}\n好像有什么不对劲？因为json.tool在实现的时候ensure_ascii为True，让我们用Python来自己实现一个更好的Unix filter。\n\n`filter.py`\n\n```python\n    import json\n    import fileinput\n    for l in fileinput.input():\n        print(json.dumps(json.loads(l), ensure_ascii=False).encode('utf-8'))\n```\n只需要写上面那 4 行代码，就可以这样使用它：\n\n> python filter.py data.json\n{\"爱\": \"我\", \"中\": \"华\"}\n> cat data.json| python filter.py\n{\"爱\": \"我\", \"中\": \"华\"}\n\n## 编码问题\n\npython 2.x 默认使用的编码是ascii编码，中文总是出问题。\n\n遇到乱码问题，一般使用如下的步骤即可解决:\n\n1. python文件自身的编码\n\n>     Python will default to ASCII as standard encoding if no other\n    encoding hints are given.\n\n    To define a source code encoding, a magic comment must\n    be placed into the source files either as first or second\n    line in the file, such as:\n\n          # coding=<encoding name>\n\n    or (using formats recognized by popular editors)\n\n          #!/usr/bin/python\n          # -*- coding: <encoding name> -*-\n\n在文件头加上默认编码即可：\n\n```python\n          #!/usr/local/bin/python\n          # coding: utf-8\n          import os, sys\n          ...\n```\n\n2. 重新设置系统模块的编码\n\n```python\nimport sys\nsys.setdefaultencoding('utf-8')\n```\n\n3. 使用Unicode\n\n`s = u'中文'` \n\n## to be continued\n\n\n# 参考\n\n1. [Defining Python Source Code Encodings](https://www.python.org/dev/peps/pep-0263/)","source":"_posts/python-util.md","raw":"---\ntitle: python 小技巧\ntags: python-util\ncategory: python\ntoc: true\nabbrlink: 49451\ndate: 2016-12-18 11:57:35\n---\n\n\n## 开启一个简单的HTTP Server\n\n- 命令：\n\n`python -m SimpleHTTPServer port`\n\n`-m` 是指后面跟的是python的一个Modlue\n\n`port` 默认是`8080`，可以自行指定。\n\n- 作用：\n\n1. 可以当一个简单的httpserver，做测试用\n\n2. 可以简单的传输一些小文件（大文件性能不好，经常中断）,大文件的传输可以用nc\n\n见： {% post_link nc %}\n\n## 简单的cig server\n\n- 命令：\n`python -m CGIHTTPServer port`\n\n- 作用:\n\n可以开启一个简单的cgi服务器，支持python作为cgi的语言，cgi的脚本须放置在root目录下的`cgi-bin`\n\n## 格式化 json数据\n\n- 命令:\n\n`curl http://my_url/ | python -m json.tool`\n\n- 作用:\n\n在返回大量json数据时，在命令行里可以用这个工具进行格式化。\n\nchrome浏览器中的`JsonView`插件可以做到同样的事情[chrome商店链接](https://chrome.google.com/webstore/detail/json-viewer/aimiinbnnkboelefkjlenlgimcabobli?utm_source=chrome-ntp-icon)\n\n- 缺陷：\n\npython 2.x 中是使用ASCII码作为默认编码的，因此json中如果带有中文就只是16进制的表示，可以修改`json.tool`的源代码。\n\n参见[json处理小技巧](http://axiaoxin.com/article/77/)\n\n> Python也有命令行里面格式化显示json的模块json.tool\n\n> cat data.json\n{\"爱\": \"我\", \"中\": \"华\"}\n> cat data.json| python -m json.tool\n{\n    \"\\u4e2d\": \"\\u534e\",\n    \"\\u7231\": \"\\u6211\"\n}\n好像有什么不对劲？因为json.tool在实现的时候ensure_ascii为True，让我们用Python来自己实现一个更好的Unix filter。\n\n`filter.py`\n\n```python\n    import json\n    import fileinput\n    for l in fileinput.input():\n        print(json.dumps(json.loads(l), ensure_ascii=False).encode('utf-8'))\n```\n只需要写上面那 4 行代码，就可以这样使用它：\n\n> python filter.py data.json\n{\"爱\": \"我\", \"中\": \"华\"}\n> cat data.json| python filter.py\n{\"爱\": \"我\", \"中\": \"华\"}\n\n## 编码问题\n\npython 2.x 默认使用的编码是ascii编码，中文总是出问题。\n\n遇到乱码问题，一般使用如下的步骤即可解决:\n\n1. python文件自身的编码\n\n>     Python will default to ASCII as standard encoding if no other\n    encoding hints are given.\n\n    To define a source code encoding, a magic comment must\n    be placed into the source files either as first or second\n    line in the file, such as:\n\n          # coding=<encoding name>\n\n    or (using formats recognized by popular editors)\n\n          #!/usr/bin/python\n          # -*- coding: <encoding name> -*-\n\n在文件头加上默认编码即可：\n\n```python\n          #!/usr/local/bin/python\n          # coding: utf-8\n          import os, sys\n          ...\n```\n\n2. 重新设置系统模块的编码\n\n```python\nimport sys\nsys.setdefaultencoding('utf-8')\n```\n\n3. 使用Unicode\n\n`s = u'中文'` \n\n## to be continued\n\n\n# 参考\n\n1. [Defining Python Source Code Encodings](https://www.python.org/dev/peps/pep-0263/)","slug":"python-util","published":1,"updated":"2017-04-16T12:03:23.397Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda8008jjh4k998dnkm4","content":"<h2 id=\"开启一个简单的HTTP-Server\"><a href=\"#开启一个简单的HTTP-Server\" class=\"headerlink\" title=\"开启一个简单的HTTP Server\"></a>开启一个简单的HTTP Server</h2><ul>\n<li>命令：</li>\n</ul>\n<p><code>python -m SimpleHTTPServer port</code></p>\n<p><code>-m</code> 是指后面跟的是python的一个Modlue</p>\n<p><code>port</code> 默认是<code>8080</code>，可以自行指定。</p>\n<ul>\n<li>作用：</li>\n</ul>\n<ol>\n<li><p>可以当一个简单的httpserver，做测试用</p>\n</li>\n<li><p>可以简单的传输一些小文件（大文件性能不好，经常中断）,大文件的传输可以用nc</p>\n</li>\n</ol>\n<p>见： <a href=\"/2016/12/18/nc/\" title=\"netcat(nc) —— 使用小结\">netcat(nc) —— 使用小结</a></p>\n<h2 id=\"简单的cig-server\"><a href=\"#简单的cig-server\" class=\"headerlink\" title=\"简单的cig server\"></a>简单的cig server</h2><ul>\n<li><p>命令：<br><code>python -m CGIHTTPServer port</code></p>\n</li>\n<li><p>作用:</p>\n</li>\n</ul>\n<p>可以开启一个简单的cgi服务器，支持python作为cgi的语言，cgi的脚本须放置在root目录下的<code>cgi-bin</code></p>\n<h2 id=\"格式化-json数据\"><a href=\"#格式化-json数据\" class=\"headerlink\" title=\"格式化 json数据\"></a>格式化 json数据</h2><ul>\n<li>命令:</li>\n</ul>\n<p><code>curl http://my_url/ | python -m json.tool</code></p>\n<ul>\n<li>作用:</li>\n</ul>\n<p>在返回大量json数据时，在命令行里可以用这个工具进行格式化。</p>\n<p>chrome浏览器中的<code>JsonView</code>插件可以做到同样的事情<a href=\"https://chrome.google.com/webstore/detail/json-viewer/aimiinbnnkboelefkjlenlgimcabobli?utm_source=chrome-ntp-icon\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">chrome商店链接</a></p>\n<ul>\n<li>缺陷：</li>\n</ul>\n<p>python 2.x 中是使用ASCII码作为默认编码的，因此json中如果带有中文就只是16进制的表示，可以修改<code>json.tool</code>的源代码。</p>\n<p>参见<a href=\"http://axiaoxin.com/article/77/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">json处理小技巧</a></p>\n<blockquote>\n<p>Python也有命令行里面格式化显示json的模块json.tool</p>\n<p>cat data.json<br>{“爱”: “我”, “中”: “华”}<br>cat data.json| python -m json.tool<br>{<br>    “\\u4e2d”: “\\u534e”,<br>    “\\u7231”: “\\u6211”<br>}<br>好像有什么不对劲？因为json.tool在实现的时候ensure_ascii为True，让我们用Python来自己实现一个更好的Unix filter。</p>\n</blockquote>\n<p><code>filter.py</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">import</span> fileinput</span><br><span class=\"line\"><span class=\"keyword\">for</span> l <span class=\"keyword\">in</span> fileinput.input():</span><br><span class=\"line\">    print(json.dumps(json.loads(l), ensure_ascii=<span class=\"keyword\">False</span>).encode(<span class=\"string\">'utf-8'</span>))</span><br></pre></td></tr></table></figure>\n<p>只需要写上面那 4 行代码，就可以这样使用它：</p>\n<blockquote>\n<p>python filter.py data.json<br>{“爱”: “我”, “中”: “华”}<br>cat data.json| python filter.py<br>{“爱”: “我”, “中”: “华”}</p>\n</blockquote>\n<h2 id=\"编码问题\"><a href=\"#编码问题\" class=\"headerlink\" title=\"编码问题\"></a>编码问题</h2><p>python 2.x 默认使用的编码是ascii编码，中文总是出问题。</p>\n<p>遇到乱码问题，一般使用如下的步骤即可解决:</p>\n<ol>\n<li>python文件自身的编码</li>\n</ol>\n<blockquote>\n<pre><code>Python will default to ASCII as standard encoding if no other\nencoding hints are given.\n</code></pre></blockquote>\n<pre><code>To define a source code encoding, a magic comment must\nbe placed into the source files either as first or second\nline in the file, such as:\n\n      # coding=&lt;encoding name&gt;\n\nor (using formats recognized by popular editors)\n\n      #!/usr/bin/python\n      # -*- coding: &lt;encoding name&gt; -*-\n</code></pre><p>在文件头加上默认编码即可：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/local/bin/python</span></span><br><span class=\"line\"><span class=\"comment\"># coding: utf-8</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> os, sys</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<ol>\n<li>重新设置系统模块的编码</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\">sys.setdefaultencoding(<span class=\"string\">'utf-8'</span>)</span><br></pre></td></tr></table></figure>\n<ol>\n<li>使用Unicode</li>\n</ol>\n<p><code>s = u&#39;中文&#39;</code> </p>\n<h2 id=\"to-be-continued\"><a href=\"#to-be-continued\" class=\"headerlink\" title=\"to be continued\"></a>to be continued</h2><h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><a href=\"https://www.python.org/dev/peps/pep-0263/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Defining Python Source Code Encodings</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"开启一个简单的HTTP-Server\"><a href=\"#开启一个简单的HTTP-Server\" class=\"headerlink\" title=\"开启一个简单的HTTP Server\"></a>开启一个简单的HTTP Server</h2><ul>\n<li>命令：</li>\n</ul>\n<p><code>python -m SimpleHTTPServer port</code></p>\n<p><code>-m</code> 是指后面跟的是python的一个Modlue</p>\n<p><code>port</code> 默认是<code>8080</code>，可以自行指定。</p>\n<ul>\n<li>作用：</li>\n</ul>\n<ol>\n<li><p>可以当一个简单的httpserver，做测试用</p>\n</li>\n<li><p>可以简单的传输一些小文件（大文件性能不好，经常中断）,大文件的传输可以用nc</p>\n</li>\n</ol>\n<p>见： <a href=\"/2016/12/18/nc/\" title=\"netcat(nc) —— 使用小结\">netcat(nc) —— 使用小结</a></p>\n<h2 id=\"简单的cig-server\"><a href=\"#简单的cig-server\" class=\"headerlink\" title=\"简单的cig server\"></a>简单的cig server</h2><ul>\n<li><p>命令：<br><code>python -m CGIHTTPServer port</code></p>\n</li>\n<li><p>作用:</p>\n</li>\n</ul>\n<p>可以开启一个简单的cgi服务器，支持python作为cgi的语言，cgi的脚本须放置在root目录下的<code>cgi-bin</code></p>\n<h2 id=\"格式化-json数据\"><a href=\"#格式化-json数据\" class=\"headerlink\" title=\"格式化 json数据\"></a>格式化 json数据</h2><ul>\n<li>命令:</li>\n</ul>\n<p><code>curl http://my_url/ | python -m json.tool</code></p>\n<ul>\n<li>作用:</li>\n</ul>\n<p>在返回大量json数据时，在命令行里可以用这个工具进行格式化。</p>\n<p>chrome浏览器中的<code>JsonView</code>插件可以做到同样的事情<a href=\"https://chrome.google.com/webstore/detail/json-viewer/aimiinbnnkboelefkjlenlgimcabobli?utm_source=chrome-ntp-icon\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">chrome商店链接</a></p>\n<ul>\n<li>缺陷：</li>\n</ul>\n<p>python 2.x 中是使用ASCII码作为默认编码的，因此json中如果带有中文就只是16进制的表示，可以修改<code>json.tool</code>的源代码。</p>\n<p>参见<a href=\"http://axiaoxin.com/article/77/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">json处理小技巧</a></p>\n<blockquote>\n<p>Python也有命令行里面格式化显示json的模块json.tool</p>\n<p>cat data.json<br>{“爱”: “我”, “中”: “华”}<br>cat data.json| python -m json.tool<br>{<br>    “\\u4e2d”: “\\u534e”,<br>    “\\u7231”: “\\u6211”<br>}<br>好像有什么不对劲？因为json.tool在实现的时候ensure_ascii为True，让我们用Python来自己实现一个更好的Unix filter。</p>\n</blockquote>\n<p><code>filter.py</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">import</span> fileinput</span><br><span class=\"line\"><span class=\"keyword\">for</span> l <span class=\"keyword\">in</span> fileinput.input():</span><br><span class=\"line\">    print(json.dumps(json.loads(l), ensure_ascii=<span class=\"keyword\">False</span>).encode(<span class=\"string\">'utf-8'</span>))</span><br></pre></td></tr></table></figure>\n<p>只需要写上面那 4 行代码，就可以这样使用它：</p>\n<blockquote>\n<p>python filter.py data.json<br>{“爱”: “我”, “中”: “华”}<br>cat data.json| python filter.py<br>{“爱”: “我”, “中”: “华”}</p>\n</blockquote>\n<h2 id=\"编码问题\"><a href=\"#编码问题\" class=\"headerlink\" title=\"编码问题\"></a>编码问题</h2><p>python 2.x 默认使用的编码是ascii编码，中文总是出问题。</p>\n<p>遇到乱码问题，一般使用如下的步骤即可解决:</p>\n<ol>\n<li>python文件自身的编码</li>\n</ol>\n<blockquote>\n<pre><code>Python will default to ASCII as standard encoding if no other\nencoding hints are given.\n</code></pre></blockquote>\n<pre><code>To define a source code encoding, a magic comment must\nbe placed into the source files either as first or second\nline in the file, such as:\n\n      # coding=&lt;encoding name&gt;\n\nor (using formats recognized by popular editors)\n\n      #!/usr/bin/python\n      # -*- coding: &lt;encoding name&gt; -*-\n</code></pre><p>在文件头加上默认编码即可：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/local/bin/python</span></span><br><span class=\"line\"><span class=\"comment\"># coding: utf-8</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> os, sys</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<ol>\n<li>重新设置系统模块的编码</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\">sys.setdefaultencoding(<span class=\"string\">'utf-8'</span>)</span><br></pre></td></tr></table></figure>\n<ol>\n<li>使用Unicode</li>\n</ol>\n<p><code>s = u&#39;中文&#39;</code> </p>\n<h2 id=\"to-be-continued\"><a href=\"#to-be-continued\" class=\"headerlink\" title=\"to be continued\"></a>to be continued</h2><h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><a href=\"https://www.python.org/dev/peps/pep-0263/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Defining Python Source Code Encodings</a></li>\n</ol>\n"},{"title":"Postgre数据库简介","toc":true,"abbrlink":49390,"date":"2016-09-27T05:15:07.000Z","_content":"\n\n![](https://www.postgresql.org/media/img/layout/hdr_left.png   )\n\n\n\n\n## 简介\n\n>PostgreSQL是自由的对象-关系型数据库服务器（数据库管理系统）\n\n> <https://zh.wikipedia.org/wiki/PostgreSQL>\n\n\n发展流程:\n\n{%  asset_img   history.jpg  %}\n\n\n\n\n> PostgreSQL 的前身是 BSD 的始于 1977 年的 Ingres 项目，82年，项目领导人Michael Stonebraker 将其商业化。85年正式更名为Postgres。\n\n> 92年两名伯克利的研究生在做研究生课题的时候，用SQL92替换了原有的Postquel作为查询语言，并将其更名为Postgres95。\n\n> 96年，一群黑客们接手了Postgres95，开始修改及稳定它的代码，并与同年8月发布了第一个开源版本，将其更名为PostgreSQL。\n\nPG支持的数据类型非常丰富，他支持任意精度的数值类型，无限长度的文本类型，同时具有一些nosql的特性，也可以存储hash表（hstore），ltree树状结构，支持jsonb、xml、array的存储和操作。同时PG提供了对IP地址和地理信息的良好支持。\n\nPG支持的语言非常多，各种脚本语言，例如：Lua、Perl、Python、Ruby等，也支持各种编译语言，如c、c++和JAVA等，对统计语言R也有良好的支持。\n\n架构图：\n\n{%  asset_img   arch.jpg  %}\n\n\n\n> 图片来自\n> <https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94>\n\nPostgreSQL采用的是C/S结构，一个客户端对应一个服务器端的守护进程(开销会略大)\n\n## 安装\n\n参考官网：<https://www.postgresql.org/download/>\n\n也可以参考阮一峰老师的这篇 [PostgreSQL新手入门](http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html)\n\n## 使用\n\n[PostgreSQL 9.5.3 中文在线手册](http://www.postgres.cn/docs/9.5/)\n\n[离线中文手册](https://github.com/postgres-cn/pgdoc-cn/releases)\n\n### psql --  PostgreSQL的交互式终端的使用\n\n详细请参见 [psql](http://www.postgres.cn/docs/9.5/app-psql.html)\n\n登录到数据库，类似mysql\n``` shell\npsql -U dbuser -d exampledb -h 127.0.0.1 -p 5432\n```\n>-U指定用户，-d指定数据库，-h指定服务器，-p指定端口。\n\n|命令 |作用|\n|-----|----|\n| \\h|查看SQL命令的解释，比如\\h select。|\n| \\?|查看psql命令列表。|\n| \\l|列出所有数据库。|\n| \\c [database_name]：| 连接其他数据库。|\n| \\d| 列出当前数据库的所有表格。|\n| \\d [table_name]：| 列出某一张表格的结构。|\n|\\di               | 查看索引|\n| \\du| 列出所有用户。|\n| \\e| 打开文本编辑器。|\n|\\\\! pwd|显示当前工作目录|\n|\\q |退出交互shell|\n| \\conninfo| 列出当前数据库和连接的信息。|\n\n``` shell\n\nexampledb=> \\d\n             关联列表             \n架构模式 |   名称   |  类型  | 拥有者\n----------+----------+--------+--------\npublic   | user_tbl | 数据表 | dbuser\n(1 行记录)\n\nexampledb=> \\l\n                                                      数据库列表\n 名称    |  拥有者  | 字元编码 |            校对规则            |             Ctype              |       存取权限\n-----------+----------+----------+--------------------------------+--------------------------------+-----------------------\nexampledb | dbuser   | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =Tc/dbuser           +\n         |          |          |                                |                                | dbuser=CTc/dbuser\npostgres  | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 |\ntemplate0 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +\n         |          |          |                                |                                | postgres=CTc/postgres\ntemplate1 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +\n         |          |          |                                |                                | postgres=CTc/postgres\n(4 行记录)\n\nexampledb=> \\du\n                           角色列表\n角色名称 |                    属性                    | 成员属于\n----------+--------------------------------------------+----------\ndbuser   |                                            | {}\npostgres | 超级用户, 建立角色, 建立 DB, 复制, 绕过RLS | {}\n\n\nexampledb=> \\dt\n             关联列表\n架构模式 |   名称   |  类型  | 拥有者\n----------+----------+--------+--------\npublic   | user_tbl | 数据表 | dbuser\n(1 行记录)\n\nexampledb=> \\d user_tbl;\n         数据表 \"public.user_tbl\"\n  栏位     |         类型          | 修饰词\n-------------+-----------------------+--------\nname        | character varying(20) |\nsignup_date | date                  |\n\n```\n## 参考文章\n\n1. [Uber的底层存储从Postgres换成MySQL之后](http://www.infoq.com/cn/articles/underlying-storage-of-uber-change-from-mysql-to-postgres)\n\n2. [PostgreSQL数据库的特点](http://database.51cto.com/art/200511/10875.htm)\n\n3. [PostgreSQL新手入门_阮一峰](http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html)\n\n4. [PostgreSQL简介及发展历程](http://book.51cto.com/art/201201/313178.htm)\n\n5. [数据库对比_wiki](https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94)\n\n6. [postgres-cn/pgdoc-cn](https://github.com/postgres-cn/pgdoc-cn)\n\n7. [postgresql 查看数据库,表,索引,表空间以及大小](http://blog.51yip.com/pgsql/1525.html)\n","source":"_posts/postgre.md","raw":"---\ntitle: Postgre数据库简介\ntags: postgresql\ncategory: base\ntoc: true\nabbrlink: 49390\ndate: 2016-09-27 13:15:07\n---\n\n\n![](https://www.postgresql.org/media/img/layout/hdr_left.png   )\n\n\n\n\n## 简介\n\n>PostgreSQL是自由的对象-关系型数据库服务器（数据库管理系统）\n\n> <https://zh.wikipedia.org/wiki/PostgreSQL>\n\n\n发展流程:\n\n{%  asset_img   history.jpg  %}\n\n\n\n\n> PostgreSQL 的前身是 BSD 的始于 1977 年的 Ingres 项目，82年，项目领导人Michael Stonebraker 将其商业化。85年正式更名为Postgres。\n\n> 92年两名伯克利的研究生在做研究生课题的时候，用SQL92替换了原有的Postquel作为查询语言，并将其更名为Postgres95。\n\n> 96年，一群黑客们接手了Postgres95，开始修改及稳定它的代码，并与同年8月发布了第一个开源版本，将其更名为PostgreSQL。\n\nPG支持的数据类型非常丰富，他支持任意精度的数值类型，无限长度的文本类型，同时具有一些nosql的特性，也可以存储hash表（hstore），ltree树状结构，支持jsonb、xml、array的存储和操作。同时PG提供了对IP地址和地理信息的良好支持。\n\nPG支持的语言非常多，各种脚本语言，例如：Lua、Perl、Python、Ruby等，也支持各种编译语言，如c、c++和JAVA等，对统计语言R也有良好的支持。\n\n架构图：\n\n{%  asset_img   arch.jpg  %}\n\n\n\n> 图片来自\n> <https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94>\n\nPostgreSQL采用的是C/S结构，一个客户端对应一个服务器端的守护进程(开销会略大)\n\n## 安装\n\n参考官网：<https://www.postgresql.org/download/>\n\n也可以参考阮一峰老师的这篇 [PostgreSQL新手入门](http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html)\n\n## 使用\n\n[PostgreSQL 9.5.3 中文在线手册](http://www.postgres.cn/docs/9.5/)\n\n[离线中文手册](https://github.com/postgres-cn/pgdoc-cn/releases)\n\n### psql --  PostgreSQL的交互式终端的使用\n\n详细请参见 [psql](http://www.postgres.cn/docs/9.5/app-psql.html)\n\n登录到数据库，类似mysql\n``` shell\npsql -U dbuser -d exampledb -h 127.0.0.1 -p 5432\n```\n>-U指定用户，-d指定数据库，-h指定服务器，-p指定端口。\n\n|命令 |作用|\n|-----|----|\n| \\h|查看SQL命令的解释，比如\\h select。|\n| \\?|查看psql命令列表。|\n| \\l|列出所有数据库。|\n| \\c [database_name]：| 连接其他数据库。|\n| \\d| 列出当前数据库的所有表格。|\n| \\d [table_name]：| 列出某一张表格的结构。|\n|\\di               | 查看索引|\n| \\du| 列出所有用户。|\n| \\e| 打开文本编辑器。|\n|\\\\! pwd|显示当前工作目录|\n|\\q |退出交互shell|\n| \\conninfo| 列出当前数据库和连接的信息。|\n\n``` shell\n\nexampledb=> \\d\n             关联列表             \n架构模式 |   名称   |  类型  | 拥有者\n----------+----------+--------+--------\npublic   | user_tbl | 数据表 | dbuser\n(1 行记录)\n\nexampledb=> \\l\n                                                      数据库列表\n 名称    |  拥有者  | 字元编码 |            校对规则            |             Ctype              |       存取权限\n-----------+----------+----------+--------------------------------+--------------------------------+-----------------------\nexampledb | dbuser   | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =Tc/dbuser           +\n         |          |          |                                |                                | dbuser=CTc/dbuser\npostgres  | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 |\ntemplate0 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +\n         |          |          |                                |                                | postgres=CTc/postgres\ntemplate1 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +\n         |          |          |                                |                                | postgres=CTc/postgres\n(4 行记录)\n\nexampledb=> \\du\n                           角色列表\n角色名称 |                    属性                    | 成员属于\n----------+--------------------------------------------+----------\ndbuser   |                                            | {}\npostgres | 超级用户, 建立角色, 建立 DB, 复制, 绕过RLS | {}\n\n\nexampledb=> \\dt\n             关联列表\n架构模式 |   名称   |  类型  | 拥有者\n----------+----------+--------+--------\npublic   | user_tbl | 数据表 | dbuser\n(1 行记录)\n\nexampledb=> \\d user_tbl;\n         数据表 \"public.user_tbl\"\n  栏位     |         类型          | 修饰词\n-------------+-----------------------+--------\nname        | character varying(20) |\nsignup_date | date                  |\n\n```\n## 参考文章\n\n1. [Uber的底层存储从Postgres换成MySQL之后](http://www.infoq.com/cn/articles/underlying-storage-of-uber-change-from-mysql-to-postgres)\n\n2. [PostgreSQL数据库的特点](http://database.51cto.com/art/200511/10875.htm)\n\n3. [PostgreSQL新手入门_阮一峰](http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html)\n\n4. [PostgreSQL简介及发展历程](http://book.51cto.com/art/201201/313178.htm)\n\n5. [数据库对比_wiki](https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94)\n\n6. [postgres-cn/pgdoc-cn](https://github.com/postgres-cn/pgdoc-cn)\n\n7. [postgresql 查看数据库,表,索引,表空间以及大小](http://blog.51yip.com/pgsql/1525.html)\n","slug":"postgre","published":1,"updated":"2017-04-16T12:03:23.401Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsda9008ljh4kaa5sl0hv","content":"<p><img src=\"https://www.postgresql.org/media/img/layout/hdr_left.png\" alt=\"\"></p>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><blockquote>\n<p>PostgreSQL是自由的对象-关系型数据库服务器（数据库管理系统）</p>\n<p><a href=\"https://zh.wikipedia.org/wiki/PostgreSQL\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://zh.wikipedia.org/wiki/PostgreSQL</a></p>\n</blockquote>\n<p>发展流程:</p>\n<img src=\"/2016/09/27/postgre/history.jpg\">\n<blockquote>\n<p>PostgreSQL 的前身是 BSD 的始于 1977 年的 Ingres 项目，82年，项目领导人Michael Stonebraker 将其商业化。85年正式更名为Postgres。</p>\n<p>92年两名伯克利的研究生在做研究生课题的时候，用SQL92替换了原有的Postquel作为查询语言，并将其更名为Postgres95。</p>\n<p>96年，一群黑客们接手了Postgres95，开始修改及稳定它的代码，并与同年8月发布了第一个开源版本，将其更名为PostgreSQL。</p>\n</blockquote>\n<p>PG支持的数据类型非常丰富，他支持任意精度的数值类型，无限长度的文本类型，同时具有一些nosql的特性，也可以存储hash表（hstore），ltree树状结构，支持jsonb、xml、array的存储和操作。同时PG提供了对IP地址和地理信息的良好支持。</p>\n<p>PG支持的语言非常多，各种脚本语言，例如：Lua、Perl、Python、Ruby等，也支持各种编译语言，如c、c++和JAVA等，对统计语言R也有良好的支持。</p>\n<p>架构图：</p>\n<img src=\"/2016/09/27/postgre/arch.jpg\">\n<blockquote>\n<p>图片来自<br><a href=\"https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94</a></p>\n</blockquote>\n<p>PostgreSQL采用的是C/S结构，一个客户端对应一个服务器端的守护进程(开销会略大)</p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>参考官网：<a href=\"https://www.postgresql.org/download/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://www.postgresql.org/download/</a></p>\n<p>也可以参考阮一峰老师的这篇 <a href=\"http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL新手入门</a></p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p><a href=\"http://www.postgres.cn/docs/9.5/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL 9.5.3 中文在线手册</a></p>\n<p><a href=\"https://github.com/postgres-cn/pgdoc-cn/releases\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">离线中文手册</a></p>\n<h3 id=\"psql-–-PostgreSQL的交互式终端的使用\"><a href=\"#psql-–-PostgreSQL的交互式终端的使用\" class=\"headerlink\" title=\"psql –  PostgreSQL的交互式终端的使用\"></a>psql –  PostgreSQL的交互式终端的使用</h3><p>详细请参见 <a href=\"http://www.postgres.cn/docs/9.5/app-psql.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">psql</a></p>\n<p>登录到数据库，类似mysql<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psql -U dbuser -d exampledb -h 127.0.0.1 -p 5432</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>-U指定用户，-d指定数据库，-h指定服务器，-p指定端口。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>\\h</td>\n<td>查看SQL命令的解释，比如\\h select。</td>\n</tr>\n<tr>\n<td>\\?</td>\n<td>查看psql命令列表。</td>\n</tr>\n<tr>\n<td>\\l</td>\n<td>列出所有数据库。</td>\n</tr>\n<tr>\n<td>\\c [database_name]：</td>\n<td>连接其他数据库。</td>\n</tr>\n<tr>\n<td>\\d</td>\n<td>列出当前数据库的所有表格。</td>\n</tr>\n<tr>\n<td>\\d [table_name]：</td>\n<td>列出某一张表格的结构。</td>\n</tr>\n<tr>\n<td>\\di</td>\n<td>查看索引</td>\n</tr>\n<tr>\n<td>\\du</td>\n<td>列出所有用户。</td>\n</tr>\n<tr>\n<td>\\e</td>\n<td>打开文本编辑器。</td>\n</tr>\n<tr>\n<td>\\! pwd</td>\n<td>显示当前工作目录</td>\n</tr>\n<tr>\n<td>\\q</td>\n<td>退出交互shell</td>\n</tr>\n<tr>\n<td>\\conninfo</td>\n<td>列出当前数据库和连接的信息。</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\d</span><br><span class=\"line\">             关联列表             </span><br><span class=\"line\">架构模式 |   名称   |  类型  | 拥有者</span><br><span class=\"line\">----------+----------+--------+--------</span><br><span class=\"line\">public   | user_tbl | 数据表 | dbuser</span><br><span class=\"line\">(1 行记录)</span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\l</span><br><span class=\"line\">                                                      数据库列表</span><br><span class=\"line\"> 名称    |  拥有者  | 字元编码 |            校对规则            |             Ctype              |       存取权限</span><br><span class=\"line\">-----------+----------+----------+--------------------------------+--------------------------------+-----------------------</span><br><span class=\"line\">exampledb | dbuser   | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =Tc/dbuser           +</span><br><span class=\"line\">         |          |          |                                |                                | dbuser=CTc/dbuser</span><br><span class=\"line\">postgres  | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 |</span><br><span class=\"line\">template0 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +</span><br><span class=\"line\">         |          |          |                                |                                | postgres=CTc/postgres</span><br><span class=\"line\">template1 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +</span><br><span class=\"line\">         |          |          |                                |                                | postgres=CTc/postgres</span><br><span class=\"line\">(4 行记录)</span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\du</span><br><span class=\"line\">                           角色列表</span><br><span class=\"line\">角色名称 |                    属性                    | 成员属于</span><br><span class=\"line\">----------+--------------------------------------------+----------</span><br><span class=\"line\">dbuser   |                                            | &#123;&#125;</span><br><span class=\"line\">postgres | 超级用户, 建立角色, 建立 DB, 复制, 绕过RLS | &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\dt</span><br><span class=\"line\">             关联列表</span><br><span class=\"line\">架构模式 |   名称   |  类型  | 拥有者</span><br><span class=\"line\">----------+----------+--------+--------</span><br><span class=\"line\">public   | user_tbl | 数据表 | dbuser</span><br><span class=\"line\">(1 行记录)</span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\d user_tbl;</span><br><span class=\"line\">         数据表 \"public.user_tbl\"</span><br><span class=\"line\">  栏位     |         类型          | 修饰词</span><br><span class=\"line\">-------------+-----------------------+--------</span><br><span class=\"line\">name        | character varying(20) |</span><br><span class=\"line\">signup_date | date                  |</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><ol>\n<li><p><a href=\"http://www.infoq.com/cn/articles/underlying-storage-of-uber-change-from-mysql-to-postgres\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Uber的底层存储从Postgres换成MySQL之后</a></p>\n</li>\n<li><p><a href=\"http://database.51cto.com/art/200511/10875.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL数据库的特点</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL新手入门_阮一峰</a></p>\n</li>\n<li><p><a href=\"http://book.51cto.com/art/201201/313178.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL简介及发展历程</a></p>\n</li>\n<li><p><a href=\"https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">数据库对比_wiki</a></p>\n</li>\n<li><p><a href=\"https://github.com/postgres-cn/pgdoc-cn\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">postgres-cn/pgdoc-cn</a></p>\n</li>\n<li><p><a href=\"http://blog.51yip.com/pgsql/1525.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">postgresql 查看数据库,表,索引,表空间以及大小</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"https://www.postgresql.org/media/img/layout/hdr_left.png\" alt=\"\"></p>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><blockquote>\n<p>PostgreSQL是自由的对象-关系型数据库服务器（数据库管理系统）</p>\n<p><a href=\"https://zh.wikipedia.org/wiki/PostgreSQL\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://zh.wikipedia.org/wiki/PostgreSQL</a></p>\n</blockquote>\n<p>发展流程:</p>\n<img src=\"/2016/09/27/postgre/history.jpg\">\n<blockquote>\n<p>PostgreSQL 的前身是 BSD 的始于 1977 年的 Ingres 项目，82年，项目领导人Michael Stonebraker 将其商业化。85年正式更名为Postgres。</p>\n<p>92年两名伯克利的研究生在做研究生课题的时候，用SQL92替换了原有的Postquel作为查询语言，并将其更名为Postgres95。</p>\n<p>96年，一群黑客们接手了Postgres95，开始修改及稳定它的代码，并与同年8月发布了第一个开源版本，将其更名为PostgreSQL。</p>\n</blockquote>\n<p>PG支持的数据类型非常丰富，他支持任意精度的数值类型，无限长度的文本类型，同时具有一些nosql的特性，也可以存储hash表（hstore），ltree树状结构，支持jsonb、xml、array的存储和操作。同时PG提供了对IP地址和地理信息的良好支持。</p>\n<p>PG支持的语言非常多，各种脚本语言，例如：Lua、Perl、Python、Ruby等，也支持各种编译语言，如c、c++和JAVA等，对统计语言R也有良好的支持。</p>\n<p>架构图：</p>\n<img src=\"/2016/09/27/postgre/arch.jpg\">\n<blockquote>\n<p>图片来自<br><a href=\"https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94</a></p>\n</blockquote>\n<p>PostgreSQL采用的是C/S结构，一个客户端对应一个服务器端的守护进程(开销会略大)</p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>参考官网：<a href=\"https://www.postgresql.org/download/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">https://www.postgresql.org/download/</a></p>\n<p>也可以参考阮一峰老师的这篇 <a href=\"http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL新手入门</a></p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p><a href=\"http://www.postgres.cn/docs/9.5/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL 9.5.3 中文在线手册</a></p>\n<p><a href=\"https://github.com/postgres-cn/pgdoc-cn/releases\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">离线中文手册</a></p>\n<h3 id=\"psql-–-PostgreSQL的交互式终端的使用\"><a href=\"#psql-–-PostgreSQL的交互式终端的使用\" class=\"headerlink\" title=\"psql –  PostgreSQL的交互式终端的使用\"></a>psql –  PostgreSQL的交互式终端的使用</h3><p>详细请参见 <a href=\"http://www.postgres.cn/docs/9.5/app-psql.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">psql</a></p>\n<p>登录到数据库，类似mysql<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psql -U dbuser -d exampledb -h 127.0.0.1 -p 5432</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>-U指定用户，-d指定数据库，-h指定服务器，-p指定端口。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>\\h</td>\n<td>查看SQL命令的解释，比如\\h select。</td>\n</tr>\n<tr>\n<td>\\?</td>\n<td>查看psql命令列表。</td>\n</tr>\n<tr>\n<td>\\l</td>\n<td>列出所有数据库。</td>\n</tr>\n<tr>\n<td>\\c [database_name]：</td>\n<td>连接其他数据库。</td>\n</tr>\n<tr>\n<td>\\d</td>\n<td>列出当前数据库的所有表格。</td>\n</tr>\n<tr>\n<td>\\d [table_name]：</td>\n<td>列出某一张表格的结构。</td>\n</tr>\n<tr>\n<td>\\di</td>\n<td>查看索引</td>\n</tr>\n<tr>\n<td>\\du</td>\n<td>列出所有用户。</td>\n</tr>\n<tr>\n<td>\\e</td>\n<td>打开文本编辑器。</td>\n</tr>\n<tr>\n<td>\\! pwd</td>\n<td>显示当前工作目录</td>\n</tr>\n<tr>\n<td>\\q</td>\n<td>退出交互shell</td>\n</tr>\n<tr>\n<td>\\conninfo</td>\n<td>列出当前数据库和连接的信息。</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\d</span><br><span class=\"line\">             关联列表             </span><br><span class=\"line\">架构模式 |   名称   |  类型  | 拥有者</span><br><span class=\"line\">----------+----------+--------+--------</span><br><span class=\"line\">public   | user_tbl | 数据表 | dbuser</span><br><span class=\"line\">(1 行记录)</span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\l</span><br><span class=\"line\">                                                      数据库列表</span><br><span class=\"line\"> 名称    |  拥有者  | 字元编码 |            校对规则            |             Ctype              |       存取权限</span><br><span class=\"line\">-----------+----------+----------+--------------------------------+--------------------------------+-----------------------</span><br><span class=\"line\">exampledb | dbuser   | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =Tc/dbuser           +</span><br><span class=\"line\">         |          |          |                                |                                | dbuser=CTc/dbuser</span><br><span class=\"line\">postgres  | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 |</span><br><span class=\"line\">template0 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +</span><br><span class=\"line\">         |          |          |                                |                                | postgres=CTc/postgres</span><br><span class=\"line\">template1 | postgres | UTF8     | Chinese (Simplified)_China.936 | Chinese (Simplified)_China.936 | =c/postgres          +</span><br><span class=\"line\">         |          |          |                                |                                | postgres=CTc/postgres</span><br><span class=\"line\">(4 行记录)</span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\du</span><br><span class=\"line\">                           角色列表</span><br><span class=\"line\">角色名称 |                    属性                    | 成员属于</span><br><span class=\"line\">----------+--------------------------------------------+----------</span><br><span class=\"line\">dbuser   |                                            | &#123;&#125;</span><br><span class=\"line\">postgres | 超级用户, 建立角色, 建立 DB, 复制, 绕过RLS | &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\dt</span><br><span class=\"line\">             关联列表</span><br><span class=\"line\">架构模式 |   名称   |  类型  | 拥有者</span><br><span class=\"line\">----------+----------+--------+--------</span><br><span class=\"line\">public   | user_tbl | 数据表 | dbuser</span><br><span class=\"line\">(1 行记录)</span><br><span class=\"line\"></span><br><span class=\"line\">exampledb=&gt; \\d user_tbl;</span><br><span class=\"line\">         数据表 \"public.user_tbl\"</span><br><span class=\"line\">  栏位     |         类型          | 修饰词</span><br><span class=\"line\">-------------+-----------------------+--------</span><br><span class=\"line\">name        | character varying(20) |</span><br><span class=\"line\">signup_date | date                  |</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><ol>\n<li><p><a href=\"http://www.infoq.com/cn/articles/underlying-storage-of-uber-change-from-mysql-to-postgres\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Uber的底层存储从Postgres换成MySQL之后</a></p>\n</li>\n<li><p><a href=\"http://database.51cto.com/art/200511/10875.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL数据库的特点</a></p>\n</li>\n<li><p><a href=\"http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL新手入门_阮一峰</a></p>\n</li>\n<li><p><a href=\"http://book.51cto.com/art/201201/313178.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PostgreSQL简介及发展历程</a></p>\n</li>\n<li><p><a href=\"https://wiki.postgresql.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">数据库对比_wiki</a></p>\n</li>\n<li><p><a href=\"https://github.com/postgres-cn/pgdoc-cn\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">postgres-cn/pgdoc-cn</a></p>\n</li>\n<li><p><a href=\"http://blog.51yip.com/pgsql/1525.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">postgresql 查看数据库,表,索引,表空间以及大小</a></p>\n</li>\n</ol>\n"},{"title":"正则总结","toc":true,"abbrlink":6146,"date":"2016-12-14T15:48:12.000Z","_content":"\n\n# 测试\n\n推荐使用`RegexBudy`\n\n\n![](https://www.regexbuddy.com/img/icon.png)\n\n\n\n\n界面如下:\n\n\n![](https://www.regexbuddy.com/screens/regexbuddy.png)\n\n\n\n\n推荐python的 `VerbalExpressions` [PythonVerbalExpressions ](https://github.com/VerbalExpressions/PythonVerbalExpressions)\n\n# 使用心得\n\n## 匹配多个单词\n\n`\\b`可以匹配一个单词的开头或者结尾\n\n匹配单个单词： `\\bfoo\\b` 可以匹配单个单测 foo\n\n匹配多个单词： `\\b(foo|bar)\\b` 可以匹配foo 或者 bar\n\n## 匹配开头和结尾\n\n`^`可以匹配字符串的开头\n\n`$`可以匹配字符串的结尾\n\n## 零宽断言\n\n| 分类  | 代码/语法   |说明|\n|------|---|------------------|\n| 捕获 | (exp)   |匹配exp,并捕获文本到自动命名的组里|\n| |(?<name>exp)    | 匹配exp,并捕获文本到名称为name的组里，也可以写成(?'name'exp)|\n| |(?:exp) |匹配exp,不捕获匹配的文本，也不给此分组分配组号|\n| 零宽断言  |  (?=exp) 匹配exp前面的位置|\n| |(?<=exp)    |匹配exp后面的位置|\n| |(?!exp) |匹配后面跟的不是exp的位置|\n| |(?<!exp)    |匹配前面不是exp的位置|\n| 注释  (?#comment) |这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读|\n\n\n### 先行断言\n\n语法格式\n\n\n`[a-z]*(?=ing)`\n\n可匹配 cooking singing 中的cook 与 sing\n\n### 后发断言\n\n语法格式\n\n`(?<=abc)[a-z]*`\n\n\n可匹配 abcdefg 中的defg\n\n### 负向零宽断言\n\n语法格式\n\n`(?!exp)`\n\n断言此位置的后面不能匹配表达式`exp`\n\n`\\b\\w*q(?!u)\\w*\\b` 匹配q后面不出现u（可以以q结尾）\n\n# 参考\n\n1. [RegexBuddy官网](https://www.regexbuddy.com/)\n\n2. [正则表达式30分钟入门教程](https://luke0922.gitbooks.io/learnregularexpressionin30minutes/content/)\n\n3. [正则表达式怎样匹配多个单词](http://www.biliyu.com/article/1321.html)\n\n","source":"_posts/re.md","raw":"---\ntitle: 正则总结\ntags: re\ncategory: base\ntoc: true\nabbrlink: 6146\ndate: 2016-12-14 23:48:12\n---\n\n\n# 测试\n\n推荐使用`RegexBudy`\n\n\n![](https://www.regexbuddy.com/img/icon.png)\n\n\n\n\n界面如下:\n\n\n![](https://www.regexbuddy.com/screens/regexbuddy.png)\n\n\n\n\n推荐python的 `VerbalExpressions` [PythonVerbalExpressions ](https://github.com/VerbalExpressions/PythonVerbalExpressions)\n\n# 使用心得\n\n## 匹配多个单词\n\n`\\b`可以匹配一个单词的开头或者结尾\n\n匹配单个单词： `\\bfoo\\b` 可以匹配单个单测 foo\n\n匹配多个单词： `\\b(foo|bar)\\b` 可以匹配foo 或者 bar\n\n## 匹配开头和结尾\n\n`^`可以匹配字符串的开头\n\n`$`可以匹配字符串的结尾\n\n## 零宽断言\n\n| 分类  | 代码/语法   |说明|\n|------|---|------------------|\n| 捕获 | (exp)   |匹配exp,并捕获文本到自动命名的组里|\n| |(?<name>exp)    | 匹配exp,并捕获文本到名称为name的组里，也可以写成(?'name'exp)|\n| |(?:exp) |匹配exp,不捕获匹配的文本，也不给此分组分配组号|\n| 零宽断言  |  (?=exp) 匹配exp前面的位置|\n| |(?<=exp)    |匹配exp后面的位置|\n| |(?!exp) |匹配后面跟的不是exp的位置|\n| |(?<!exp)    |匹配前面不是exp的位置|\n| 注释  (?#comment) |这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读|\n\n\n### 先行断言\n\n语法格式\n\n\n`[a-z]*(?=ing)`\n\n可匹配 cooking singing 中的cook 与 sing\n\n### 后发断言\n\n语法格式\n\n`(?<=abc)[a-z]*`\n\n\n可匹配 abcdefg 中的defg\n\n### 负向零宽断言\n\n语法格式\n\n`(?!exp)`\n\n断言此位置的后面不能匹配表达式`exp`\n\n`\\b\\w*q(?!u)\\w*\\b` 匹配q后面不出现u（可以以q结尾）\n\n# 参考\n\n1. [RegexBuddy官网](https://www.regexbuddy.com/)\n\n2. [正则表达式30分钟入门教程](https://luke0922.gitbooks.io/learnregularexpressionin30minutes/content/)\n\n3. [正则表达式怎样匹配多个单词](http://www.biliyu.com/article/1321.html)\n\n","slug":"re","published":1,"updated":"2017-04-16T12:03:23.405Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdaa008pjh4kii3gusr5","content":"<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><p>推荐使用<code>RegexBudy</code></p>\n<p><img src=\"https://www.regexbuddy.com/img/icon.png\" alt=\"\"></p>\n<p>界面如下:</p>\n<p><img src=\"https://www.regexbuddy.com/screens/regexbuddy.png\" alt=\"\"></p>\n<p>推荐python的 <code>VerbalExpressions</code> <a href=\"https://github.com/VerbalExpressions/PythonVerbalExpressions\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PythonVerbalExpressions </a></p>\n<h1 id=\"使用心得\"><a href=\"#使用心得\" class=\"headerlink\" title=\"使用心得\"></a>使用心得</h1><h2 id=\"匹配多个单词\"><a href=\"#匹配多个单词\" class=\"headerlink\" title=\"匹配多个单词\"></a>匹配多个单词</h2><p><code>\\b</code>可以匹配一个单词的开头或者结尾</p>\n<p>匹配单个单词： <code>\\bfoo\\b</code> 可以匹配单个单测 foo</p>\n<p>匹配多个单词： <code>\\b(foo|bar)\\b</code> 可以匹配foo 或者 bar</p>\n<h2 id=\"匹配开头和结尾\"><a href=\"#匹配开头和结尾\" class=\"headerlink\" title=\"匹配开头和结尾\"></a>匹配开头和结尾</h2><p><code>^</code>可以匹配字符串的开头</p>\n<p><code>$</code>可以匹配字符串的结尾</p>\n<h2 id=\"零宽断言\"><a href=\"#零宽断言\" class=\"headerlink\" title=\"零宽断言\"></a>零宽断言</h2><table>\n<thead>\n<tr>\n<th>分类</th>\n<th>代码/语法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>捕获</td>\n<td>(exp)</td>\n<td>匹配exp,并捕获文本到自动命名的组里</td>\n</tr>\n<tr>\n<td></td>\n<td>(?<name>exp)</name></td>\n<td>匹配exp,并捕获文本到名称为name的组里，也可以写成(?’name’exp)</td>\n</tr>\n<tr>\n<td></td>\n<td>(?:exp)</td>\n<td>匹配exp,不捕获匹配的文本，也不给此分组分配组号</td>\n</tr>\n<tr>\n<td>零宽断言</td>\n<td>(?=exp) 匹配exp前面的位置</td>\n</tr>\n<tr>\n<td></td>\n<td>(?&lt;=exp)</td>\n<td>匹配exp后面的位置</td>\n</tr>\n<tr>\n<td></td>\n<td>(?!exp)</td>\n<td>匹配后面跟的不是exp的位置</td>\n</tr>\n<tr>\n<td></td>\n<td>(?&lt;!exp)</td>\n<td>匹配前面不是exp的位置</td>\n</tr>\n<tr>\n<td>注释  (?#comment)</td>\n<td>这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"先行断言\"><a href=\"#先行断言\" class=\"headerlink\" title=\"先行断言\"></a>先行断言</h3><p>语法格式</p>\n<p><code>[a-z]*(?=ing)</code></p>\n<p>可匹配 cooking singing 中的cook 与 sing</p>\n<h3 id=\"后发断言\"><a href=\"#后发断言\" class=\"headerlink\" title=\"后发断言\"></a>后发断言</h3><p>语法格式</p>\n<p><code>(?&lt;=abc)[a-z]*</code></p>\n<p>可匹配 abcdefg 中的defg</p>\n<h3 id=\"负向零宽断言\"><a href=\"#负向零宽断言\" class=\"headerlink\" title=\"负向零宽断言\"></a>负向零宽断言</h3><p>语法格式</p>\n<p><code>(?!exp)</code></p>\n<p>断言此位置的后面不能匹配表达式<code>exp</code></p>\n<p><code>\\b\\w*q(?!u)\\w*\\b</code> 匹配q后面不出现u（可以以q结尾）</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"https://www.regexbuddy.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">RegexBuddy官网</a></p>\n</li>\n<li><p><a href=\"https://luke0922.gitbooks.io/learnregularexpressionin30minutes/content/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">正则表达式30分钟入门教程</a></p>\n</li>\n<li><p><a href=\"http://www.biliyu.com/article/1321.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">正则表达式怎样匹配多个单词</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><p>推荐使用<code>RegexBudy</code></p>\n<p><img src=\"https://www.regexbuddy.com/img/icon.png\" alt=\"\"></p>\n<p>界面如下:</p>\n<p><img src=\"https://www.regexbuddy.com/screens/regexbuddy.png\" alt=\"\"></p>\n<p>推荐python的 <code>VerbalExpressions</code> <a href=\"https://github.com/VerbalExpressions/PythonVerbalExpressions\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">PythonVerbalExpressions </a></p>\n<h1 id=\"使用心得\"><a href=\"#使用心得\" class=\"headerlink\" title=\"使用心得\"></a>使用心得</h1><h2 id=\"匹配多个单词\"><a href=\"#匹配多个单词\" class=\"headerlink\" title=\"匹配多个单词\"></a>匹配多个单词</h2><p><code>\\b</code>可以匹配一个单词的开头或者结尾</p>\n<p>匹配单个单词： <code>\\bfoo\\b</code> 可以匹配单个单测 foo</p>\n<p>匹配多个单词： <code>\\b(foo|bar)\\b</code> 可以匹配foo 或者 bar</p>\n<h2 id=\"匹配开头和结尾\"><a href=\"#匹配开头和结尾\" class=\"headerlink\" title=\"匹配开头和结尾\"></a>匹配开头和结尾</h2><p><code>^</code>可以匹配字符串的开头</p>\n<p><code>$</code>可以匹配字符串的结尾</p>\n<h2 id=\"零宽断言\"><a href=\"#零宽断言\" class=\"headerlink\" title=\"零宽断言\"></a>零宽断言</h2><table>\n<thead>\n<tr>\n<th>分类</th>\n<th>代码/语法</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>捕获</td>\n<td>(exp)</td>\n<td>匹配exp,并捕获文本到自动命名的组里</td>\n</tr>\n<tr>\n<td></td>\n<td>(?<name>exp)</name></td>\n<td>匹配exp,并捕获文本到名称为name的组里，也可以写成(?’name’exp)</td>\n</tr>\n<tr>\n<td></td>\n<td>(?:exp)</td>\n<td>匹配exp,不捕获匹配的文本，也不给此分组分配组号</td>\n</tr>\n<tr>\n<td>零宽断言</td>\n<td>(?=exp) 匹配exp前面的位置</td>\n</tr>\n<tr>\n<td></td>\n<td>(?&lt;=exp)</td>\n<td>匹配exp后面的位置</td>\n</tr>\n<tr>\n<td></td>\n<td>(?!exp)</td>\n<td>匹配后面跟的不是exp的位置</td>\n</tr>\n<tr>\n<td></td>\n<td>(?&lt;!exp)</td>\n<td>匹配前面不是exp的位置</td>\n</tr>\n<tr>\n<td>注释  (?#comment)</td>\n<td>这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"先行断言\"><a href=\"#先行断言\" class=\"headerlink\" title=\"先行断言\"></a>先行断言</h3><p>语法格式</p>\n<p><code>[a-z]*(?=ing)</code></p>\n<p>可匹配 cooking singing 中的cook 与 sing</p>\n<h3 id=\"后发断言\"><a href=\"#后发断言\" class=\"headerlink\" title=\"后发断言\"></a>后发断言</h3><p>语法格式</p>\n<p><code>(?&lt;=abc)[a-z]*</code></p>\n<p>可匹配 abcdefg 中的defg</p>\n<h3 id=\"负向零宽断言\"><a href=\"#负向零宽断言\" class=\"headerlink\" title=\"负向零宽断言\"></a>负向零宽断言</h3><p>语法格式</p>\n<p><code>(?!exp)</code></p>\n<p>断言此位置的后面不能匹配表达式<code>exp</code></p>\n<p><code>\\b\\w*q(?!u)\\w*\\b</code> 匹配q后面不出现u（可以以q结尾）</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"https://www.regexbuddy.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">RegexBuddy官网</a></p>\n</li>\n<li><p><a href=\"https://luke0922.gitbooks.io/learnregularexpressionin30minutes/content/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">正则表达式30分钟入门教程</a></p>\n</li>\n<li><p><a href=\"http://www.biliyu.com/article/1321.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">正则表达式怎样匹配多个单词</a></p>\n</li>\n</ol>\n"},{"title":"异步Servlet及Spring对其的支持","toc":true,"abbrlink":58929,"date":"2017-02-27T17:47:22.000Z","_content":"\n\n## 测试\n\n限定 tomcat的连接池个数为50，并发为200（>> 线程池大小），时异步具有很大的优势。\n\n如果并发量小于线程池大小，异步的反倒比同步的时间长了很久。\n\n```xml\n<Connector port=\"8080\" protocol=\"HTTP/1.1\"\n            maxThreads=\"50\"\n            connectionTimeout=\"20000\"\n            redirectPort=\"8443\" URIEncoding=\"UTF-8\"/>\n```\n\n完整的测试代码地址： [](https://github.com/qsLI/Java_Tutorial/blob/master/web/src/main/java/com/air/async/AsyncRequestProcessor.java)\n\n### async ab测试\n\n```\n$ ab -n 10000 -c 200 http://localhost:8080/async\nThis is ApacheBench, Version 2.3 <$Revision: 655654 $>\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nLicensed to The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking localhost (be patient)\nCompleted 1000 requests\nCompleted 2000 requests\nCompleted 3000 requests\nCompleted 4000 requests\nCompleted 5000 requests\nCompleted 6000 requests\nCompleted 7000 requests\nCompleted 8000 requests\nCompleted 9000 requests\nCompleted 10000 requests\nFinished 10000 requests\n\n\nServer Software:        Apache-Coyote/1.1\nServer Hostname:        localhost\nServer Port:            8080\n\nDocument Path:          /async\nDocument Length:        40 bytes\n\nConcurrency Level:      200\nTime taken for tests:   1000.284 seconds\nComplete requests:      10000\nFailed requests:        47\n   (Connect: 0, Receive: 0, Length: 47, Exceptions: 0)\nWrite errors:           0\nNon-2xx responses:      47\nTotal transferred:      1530740 bytes\nHTML transferred:       506980 bytes\nRequests per second:    10.00 [#/sec] (mean)\nTime per request:       20005.686 [ms] (mean)\nTime per request:       100.028 [ms] (mean, across all concurrent requests)\nTransfer rate:          1.49 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0    0   5.0      0     501\nProcessing:     2 19810 1683.3  20001   20560\nWaiting:        1 19810 1683.4  20000   20558\nTotal:          2 19811 1683.0  20001   20560\n\nPercentage of the requests served within a certain time (ms)\n  50%  20001\n  66%  20001\n  75%  20002\n  80%  20002\n  90%  20004\n  95%  20009\n  98%  20020\n  99%  20035\n 100%  20560 (longest request)\n```\n\n测试过程中出的异常：\n\n```\n一月 21, 2017 1:05:32 上午 org.apache.catalina.core.StandardWrapperValve invoke\n严重: Servlet.service() for servlet [com.air.async.AsyncServlet] in context with path [] threw exception\njava.util.concurrent.RejectedExecutionException: Task com.air.async.AsyncRequestProcessor@3caec762 rejected from java.util.concurrent.ThreadPoolExecutor@64db0f23[Running, pool size = 100, active threads = 100, queued tasks = 100, completed tasks = 9726]\n  at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)\n  at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)\n  at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)\n  at com.air.async.AsyncServlet.doGet(AsyncServlet.java:25)\n  at javax.servlet.http.HttpServlet.service(HttpServlet.java:621)\n  at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n  at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)\n  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)\n  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n  at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n  at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n  at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n  at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n  at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n  at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)\n  at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n  at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n  at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)\n  at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)\n  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2430)\n  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2419)\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n  at java.lang.Thread.run(Thread.java:745)\n```\n\n有47个失败的case，是队列满了，然后丢掉了请求。\n\n### sync ab测试\n\n```\n$ ab -n 10000 -c 200 http://localhost:8080/hello\nThis is ApacheBench, Version 2.3 <$Revision: 655654 $>\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nLicensed to The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking localhost (be patient)\nCompleted 1000 requests\nCompleted 2000 requests\nCompleted 3000 requests\nCompleted 4000 requests\nCompleted 5000 requests\nCompleted 6000 requests\nCompleted 7000 requests\nCompleted 8000 requests\nCompleted 9000 requests\nCompleted 10000 requests\nFinished 10000 requests\n\n\nServer Software:        Apache-Coyote/1.1\nServer Hostname:        localhost\nServer Port:            8080\n\nDocument Path:          /hello\nDocument Length:        12 bytes\n\nConcurrency Level:      200\nTime taken for tests:   2002.151 seconds\nComplete requests:      10000\nFailed requests:        0\nWrite errors:           0\nTotal transferred:      1340000 bytes\nHTML transferred:       120000 bytes\nRequests per second:    4.99 [#/sec] (mean)\nTime per request:       40043.028 [ms] (mean)\nTime per request:       200.215 [ms] (mean, across all concurrent requests)\nTransfer rate:          0.65 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0    0   0.4      0       8\nProcessing: 10002 39740 2686.3  40005   50319\nWaiting:    10002 39740 2686.4  40004   50319\nTotal:      10002 39741 2686.3  40005   50319\n\nPercentage of the requests served within a certain time (ms)\n  50%  40005\n  66%  40009\n  75%  40014\n  80%  40022\n  90%  40122\n  95%  40316\n  98%  40449\n  99%  40483\n 100%  50319 (longest request)\n```\n\n### 结论\n\n异步的servle在高并发的情况下可以使用较少的连接线程实现较大的吞吐。\n\n## 实现\n\n```java\n /**\n     * Puts this request into asynchronous mode, and initializes its\n     * {@link AsyncContext} with the original (unwrapped) ServletRequest\n     * and ServletResponse objects.\n     *\n     * <p>Calling this method will cause committal of the associated\n     * response to be delayed until {@link AsyncContext#complete} is\n     * called on the returned {@link AsyncContext}, or the asynchronous\n     * operation has timed out.\n     *\n     * <p>Calling {@link AsyncContext#hasOriginalRequestAndResponse()} on\n     * the returned AsyncContext will return <code>true</code>. Any filters\n     * invoked in the <i>outbound</i> direction after this request was put\n     * into asynchronous mode may use this as an indication that any request\n     * and/or response wrappers that they added during their <i>inbound</i>\n     * invocation need not stay around for the duration of the asynchronous\n     * operation, and therefore any of their associated resources may be\n     * released.\n     *\n     * <p>This method clears the list of {@link AsyncListener} instances\n     * (if any) that were registered with the AsyncContext returned by the\n     * previous call to one of the startAsync methods, after calling each\n     * AsyncListener at its {@link AsyncListener#onStartAsync onStartAsync}\n     * method.\n     *\n     * <p>Subsequent invocations of this method, or its overloaded \n     * variant, will return the same AsyncContext instance, reinitialized\n     * as appropriate.\n     *\n     * @return the (re)initialized AsyncContext\n     * \n     * @throws IllegalStateException if this request is within the scope of\n     * a filter or servlet that does not support asynchronous operations\n     * (that is, {@link #isAsyncSupported} returns false),\n     * or if this method is called again without any asynchronous dispatch\n     * (resulting from one of the {@link AsyncContext#dispatch} methods),\n     * is called outside the scope of any such dispatch, or is called again\n     * within the scope of the same dispatch, or if the response has\n     * already been closed\n     *\n     * @see AsyncContext#dispatch()\n     * @since Servlet 3.0\n     */\n        public AsyncContext startAsync() throws IllegalStateException;\n```\n\n//挖坑，待填\n\n## Spring 对异步Servlet的支持\n\nweb.xml中需要的配置：\n\n```xml\n    <!--spring encoding filter-->\n    <filter>\n        <filter-name>CharacterEncodingFilter</filter-name>\n        <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>\n        <init-param>\n            <param-name>encoding</param-name>\n            <param-value>utf-8</param-value>\n        </init-param>\n        <async-supported>true</async-supported>\n    </filter>\n\n        <!--servlet-->\n    <servlet>\n        <servlet-name>dispatcherServlet</servlet-name>\n        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>\n        <init-param>\n            <param-name>contextConfigLocation</param-name>\n            <param-value>\n                classpath:spring/mvc/mvc-app.xml\n            </param-value>\n        </init-param>\n        <load-on-startup>1</load-on-startup>\n        <async-supported>true</async-supported>\n    </servlet>\n```\n\n如果有filter的话也必须配置上异步的支持\n\n### Callable 方式\n\n```java\n    @RequestMapping(\"/async\")\n    @PostMapping\n    public Callable<String> asyncProcess() {\n        return new Callable<String>() {\n            @Override\n            public String call() throws Exception {\n                return \"index\";\n            }\n        };\n    }\n```\n\n这种方式返回一个`Callable`，Spring在线程池中执行`Callable`并获取到结果然后进行后续的处理。\n\nTaskExecutor 自定义线程池：\n\n```xml\n  <!-- ================================== -->  \n  <!-- 0. Set up task executor for async  -->\n  <!-- ================================== -->\n  <mvc:annotation-driven> \n    <mvc:async-support default-timeout=\"30000\" task-executor=\"taskExecutor\"/>\n  </mvc:annotation-driven>\n  <!-- modify the parameters of thread pool -->\n  <bean id=\"taskExecutor\" class=\"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor\">\n    <property name=\"corePoolSize\" value=\"5\"/>\n    <property name=\"maxPoolSize\" value=\"50\"/>\n    <property name=\"queueCapacity\" value=\"10\"/>\n    <property name=\"keepAliveSeconds\" value=\"120\"/>\n  </bean>\n```\n\n\n\n### DeferredResult 方式\n\n```java\n @RequestMapping(\"/asyncV2\")\n    public DeferredResult<String> aysncProcess2() {\n        final DeferredResult<String> stringDeferredResult = new DeferredResult<>();\n        MoreExecutors.directExecutor().execute(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    Thread.sleep(30000);\n                    stringDeferredResult.setResult(\"index\");\n                } catch (InterruptedException e) {\n                    stringDeferredResult.setErrorResult(\"error\");\n                }\n            }\n        });\n        return stringDeferredResult;\n    }\n```\n\n这种方式返回的是`DeferredResult`，计算的逻辑可以在业务线程池中计算，当计算完成后，\n\n直接向`DeferredResult`中set数据即可，会触发后续的处理，并返回给客户端。\n\n### 实现细节\n\n`RequestMappingHandlerAdapter`\n\n```java\n/**\n   * Invoke the {@link RequestMapping} handler method preparing a {@link ModelAndView}\n   * if view resolution is required.\n   * @since 4.2\n   * @see #createInvocableHandlerMethod(HandlerMethod)\n   */\n  protected ModelAndView invokeHandlerMethod(HttpServletRequest request,\n      HttpServletResponse response, HandlerMethod handlerMethod) throws Exception {\n\n    ServletWebRequest webRequest = new ServletWebRequest(request, response);\n    try {\n      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);\n      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);\n\n      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);\n      invocableMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);\n      invocableMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers);\n      invocableMethod.setDataBinderFactory(binderFactory);\n      invocableMethod.setParameterNameDiscoverer(this.parameterNameDiscoverer);\n\n      ModelAndViewContainer mavContainer = new ModelAndViewContainer();\n      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));\n      modelFactory.initModel(webRequest, mavContainer, invocableMethod);\n      mavContainer.setIgnoreDefaultModelOnRedirect(this.ignoreDefaultModelOnRedirect);\n\n      //创建异步请求\n      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);\n      asyncWebRequest.setTimeout(this.asyncRequestTimeout);\n\n      //下面的代码设置了Callable执行的线程池，以及拦截器还有DeferredResult的拦截器\n      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n      asyncManager.setTaskExecutor(this.taskExecutor);\n      asyncManager.setAsyncWebRequest(asyncWebRequest);\n      asyncManager.registerCallableInterceptors(this.callableInterceptors);\n      asyncManager.registerDeferredResultInterceptors(this.deferredResultInterceptors);\n\n      if (asyncManager.hasConcurrentResult()) {\n        Object result = asyncManager.getConcurrentResult();\n        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0];\n        asyncManager.clearConcurrentResult();\n        if (logger.isDebugEnabled()) {\n          logger.debug(\"Found concurrent result value [\" + result + \"]\");\n        }\n        invocableMethod = invocableMethod.wrapConcurrentResult(result);\n      }\n\n      invocableMethod.invokeAndHandle(webRequest, mavContainer);\n      if (asyncManager.isConcurrentHandlingStarted()) {\n        return null;\n      }\n\n      return getModelAndView(mavContainer, modelFactory, webRequest);\n    }\n    finally {\n      webRequest.requestCompleted();\n    }\n  }\n```\n\n#### Callable 的处理\n\n`Callable`的处理是在`CallableMethodReturnValueHandler`中的，这个接口最终继承了`HandlerMethodReturnValueHandler`, 也就是对Controller方法返回值的后处理。\n\n```java\npublic class CallableMethodReturnValueHandler implements AsyncHandlerMethodReturnValueHandler {\n  //省略...\n  @Override\n  public void handleReturnValue(Object returnValue, MethodParameter returnType,\n      ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {\n\n    if (returnValue == null) {\n      mavContainer.setRequestHandled(true);\n      return;\n    }\n\n    Callable<?> callable = (Callable<?>) returnValue;\n    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);\n  }\n}\n```\n\n最终是调用了`WebAsyncManager`的`startCallableProcessing`进行处理\n\n`WebAsyncManager`中的关键代码：\n\n```java\npublic void startCallableProcessing(Callable<?> callable, Object... processingContext) throws Exception {\n    Assert.notNull(callable, \"Callable must not be null\");\n    startCallableProcessing(new WebAsyncTask(callable), processingContext);\n  }\n\n  public void startCallableProcessing(final WebAsyncTask<?> webAsyncTask, Object... processingContext) throws Exception {\n    Assert.notNull(webAsyncTask, \"WebAsyncTask must not be null\");\n    Assert.state(this.asyncWebRequest != null, \"AsyncWebRequest must not be null\");\n\n    //超时\n    Long timeout = webAsyncTask.getTimeout();\n    if (timeout != null) {\n      this.asyncWebRequest.setTimeout(timeout);\n    }\n    //线程池\n    AsyncTaskExecutor executor = webAsyncTask.getExecutor();\n    if (executor != null) {\n      this.taskExecutor = executor;\n    }\n    //拦截器\n    List<CallableProcessingInterceptor> interceptors = new ArrayList<CallableProcessingInterceptor>();\n    interceptors.add(webAsyncTask.getInterceptor());\n    interceptors.addAll(this.callableInterceptors.values());\n    interceptors.add(timeoutCallableInterceptor);\n\n    final Callable<?> callable = webAsyncTask.getCallable();\n    final CallableInterceptorChain interceptorChain = new CallableInterceptorChain(interceptors);\n\n    //超时处理\n    this.asyncWebRequest.addTimeoutHandler(new Runnable() {\n      @Override\n      public void run() {\n        logger.debug(\"Processing timeout\");\n        Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);\n        if (result != CallableProcessingInterceptor.RESULT_NONE) {\n          setConcurrentResultAndDispatch(result);\n        }\n      }\n    });\n\n    //成功的回调，会触发拦截器的拦截\n    this.asyncWebRequest.addCompletionHandler(new Runnable() {\n      @Override\n      public void run() {\n        interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);\n      }\n    });\n\n    //拦截\n    interceptorChain.applyBeforeConcurrentHandling(this.asyncWebRequest, callable);\n    startAsyncProcessing(processingContext);\n    try {\n      this.taskExecutor.submit(new Runnable() {\n        @Override\n        public void run() {\n          Object result = null;\n          try {\n            //拦截\n            interceptorChain.applyPreProcess(asyncWebRequest, callable);\n            result = callable.call();\n          }\n          catch (Throwable ex) {\n            result = ex;\n          }\n          finally {\n            //拦截\n            result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);\n          }\n          setConcurrentResultAndDispatch(result);\n        }\n      });\n    }\n    catch (RejectedExecutionException ex) {\n      Object result = interceptorChain.applyPostProcess(this.asyncWebRequest, callable, ex);\n      setConcurrentResultAndDispatch(result);\n      throw ex;\n    }\n  }\n```\n\n#### DeferredResult 的处理\n\nDeferredResult的返回时机就是有数据的时候，顺藤摸瓜:\n\n```java\npublic boolean setResult(T result) {\n    return setResultInternal(result);\n  }\n\n  private boolean setResultInternal(Object result) {\n    // Immediate expiration check outside of the result lock\n    if (isSetOrExpired()) {\n      return false;\n    }\n    DeferredResultHandler resultHandlerToUse;\n    synchronized (this) {\n      // Got the lock in the meantime: double-check expiration status\n      if (isSetOrExpired()) {\n        return false;\n      }\n      // At this point, we got a new result to process\n      this.result = result;\n      resultHandlerToUse = this.resultHandler;\n      if (resultHandlerToUse == null) {\n        // No result handler set yet -> let the setResultHandler implementation\n        // pick up the result object and invoke the result handler for it.\n        return true;\n      }\n      // Result handler available -> let's clear the stored reference since\n      // we don't need it anymore.\n      this.resultHandler = null;\n    }\n    // If we get here, we need to process an existing result object immediately.\n    // The decision is made within the result lock; just the handle call outside\n    // of it, avoiding any deadlock potential with Servlet container locks.\n    resultHandlerToUse.handleResult(result);\n    return true;\n  }\n```\n\n`DeferredResultHandler`是什么鬼？我们new的时候没有设置啊？？其实这个也是由`HandlerMethodReturnValueHandler`来实现的，有个对应的`DeferredResultMethodReturnValueHandler`\n\n```java\n  @Override\n  public void handleReturnValue(Object returnValue, MethodParameter returnType,\n      ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {\n\n    if (returnValue == null) {\n      mavContainer.setRequestHandled(true);\n      return;\n    }\n\n    DeferredResultAdapter adapter = getAdapterFor(returnValue.getClass());\n    Assert.notNull(adapter);\n    DeferredResult<?> result = adapter.adaptToDeferredResult(returnValue);\n    WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer);\n  }\n```\n\n最终还是到了`WebAsyncManager`的处理方法中，和`Callable`的处理类似，不一一深入。\n\n值得一提的是，正是在这个`startDeferredResultProcessing`中塞入了一个`DeferredResultHandler`\n\n```java\ntry {\n      interceptorChain.applyPreProcess(this.asyncWebRequest, deferredResult);\n      deferredResult.setResultHandler(new DeferredResultHandler() {\n        @Override\n        public void handleResult(Object result) {\n          result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);\n          setConcurrentResultAndDispatch(result);\n        }\n      });\n    }\n    catch (Throwable ex) {\n      setConcurrentResultAndDispatch(ex);\n    }\n```\n\n因为我们是异步执行的，所以虽然handler的注入在后面，其实影响也不大，而且`setResult`中也做了判断。\n\n\n## 参考\n\n1. [Async Servlet Feature of Servlet 3 - JournalDev](http://www.journaldev.com/2008/async-servlet-feature-of-servlet-3)\n\n2. [17.12 Asynchronous Processing - Java Platform, Enterprise Edition: The Java EE Tutorial (Release 7)](https://docs.oracle.com/javaee/7/tutorial/servlets012.htm)\n\n3. [ab - Apache HTTP server benchmarking tool - Apache HTTP Server Version 2.4](https://httpd.apache.org/docs/2.4/programs/ab.html)\n\n4. [系统吞吐量（TPS）、用户并发量、性能测试概念和公式](http://www.ha97.com/5095.html)\n\n5. [servlet3新特性——异步请求处理 | 晓的技术博客](https://lanjingling.github.io/2016/01/20/servlet3-new-furture/)\n\n6. [解决java.util.concurrent.RejectedExecutionException - 小一的专栏 - 博客频道 - CSDN.NET](http://blog.csdn.net/wzy_1988/article/details/38922449)\n\n7. [Springmvc异步支持报错- - Lai18.com IT技术文章收藏夹](http://www.lai18.com/content/2483896.html)\n\n8. [Asynchronous Spring MVC – Hello World Example | Code Breeze !](http://shengwangi.blogspot.hk/2015/09/asynchronous-spring-mvc-hello-world.html)","source":"_posts/servlet-async.md","raw":"---\ntitle: 异步Servlet及Spring对其的支持\ntags: servlet\ncategory: spring\ntoc: true\nabbrlink: 58929\ndate: 2017-02-28 01:47:22\n---\n\n\n## 测试\n\n限定 tomcat的连接池个数为50，并发为200（>> 线程池大小），时异步具有很大的优势。\n\n如果并发量小于线程池大小，异步的反倒比同步的时间长了很久。\n\n```xml\n<Connector port=\"8080\" protocol=\"HTTP/1.1\"\n            maxThreads=\"50\"\n            connectionTimeout=\"20000\"\n            redirectPort=\"8443\" URIEncoding=\"UTF-8\"/>\n```\n\n完整的测试代码地址： [](https://github.com/qsLI/Java_Tutorial/blob/master/web/src/main/java/com/air/async/AsyncRequestProcessor.java)\n\n### async ab测试\n\n```\n$ ab -n 10000 -c 200 http://localhost:8080/async\nThis is ApacheBench, Version 2.3 <$Revision: 655654 $>\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nLicensed to The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking localhost (be patient)\nCompleted 1000 requests\nCompleted 2000 requests\nCompleted 3000 requests\nCompleted 4000 requests\nCompleted 5000 requests\nCompleted 6000 requests\nCompleted 7000 requests\nCompleted 8000 requests\nCompleted 9000 requests\nCompleted 10000 requests\nFinished 10000 requests\n\n\nServer Software:        Apache-Coyote/1.1\nServer Hostname:        localhost\nServer Port:            8080\n\nDocument Path:          /async\nDocument Length:        40 bytes\n\nConcurrency Level:      200\nTime taken for tests:   1000.284 seconds\nComplete requests:      10000\nFailed requests:        47\n   (Connect: 0, Receive: 0, Length: 47, Exceptions: 0)\nWrite errors:           0\nNon-2xx responses:      47\nTotal transferred:      1530740 bytes\nHTML transferred:       506980 bytes\nRequests per second:    10.00 [#/sec] (mean)\nTime per request:       20005.686 [ms] (mean)\nTime per request:       100.028 [ms] (mean, across all concurrent requests)\nTransfer rate:          1.49 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0    0   5.0      0     501\nProcessing:     2 19810 1683.3  20001   20560\nWaiting:        1 19810 1683.4  20000   20558\nTotal:          2 19811 1683.0  20001   20560\n\nPercentage of the requests served within a certain time (ms)\n  50%  20001\n  66%  20001\n  75%  20002\n  80%  20002\n  90%  20004\n  95%  20009\n  98%  20020\n  99%  20035\n 100%  20560 (longest request)\n```\n\n测试过程中出的异常：\n\n```\n一月 21, 2017 1:05:32 上午 org.apache.catalina.core.StandardWrapperValve invoke\n严重: Servlet.service() for servlet [com.air.async.AsyncServlet] in context with path [] threw exception\njava.util.concurrent.RejectedExecutionException: Task com.air.async.AsyncRequestProcessor@3caec762 rejected from java.util.concurrent.ThreadPoolExecutor@64db0f23[Running, pool size = 100, active threads = 100, queued tasks = 100, completed tasks = 9726]\n  at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)\n  at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)\n  at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)\n  at com.air.async.AsyncServlet.doGet(AsyncServlet.java:25)\n  at javax.servlet.http.HttpServlet.service(HttpServlet.java:621)\n  at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n  at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)\n  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)\n  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n  at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n  at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n  at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n  at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n  at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n  at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)\n  at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n  at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n  at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)\n  at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)\n  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2430)\n  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2419)\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n  at java.lang.Thread.run(Thread.java:745)\n```\n\n有47个失败的case，是队列满了，然后丢掉了请求。\n\n### sync ab测试\n\n```\n$ ab -n 10000 -c 200 http://localhost:8080/hello\nThis is ApacheBench, Version 2.3 <$Revision: 655654 $>\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nLicensed to The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking localhost (be patient)\nCompleted 1000 requests\nCompleted 2000 requests\nCompleted 3000 requests\nCompleted 4000 requests\nCompleted 5000 requests\nCompleted 6000 requests\nCompleted 7000 requests\nCompleted 8000 requests\nCompleted 9000 requests\nCompleted 10000 requests\nFinished 10000 requests\n\n\nServer Software:        Apache-Coyote/1.1\nServer Hostname:        localhost\nServer Port:            8080\n\nDocument Path:          /hello\nDocument Length:        12 bytes\n\nConcurrency Level:      200\nTime taken for tests:   2002.151 seconds\nComplete requests:      10000\nFailed requests:        0\nWrite errors:           0\nTotal transferred:      1340000 bytes\nHTML transferred:       120000 bytes\nRequests per second:    4.99 [#/sec] (mean)\nTime per request:       40043.028 [ms] (mean)\nTime per request:       200.215 [ms] (mean, across all concurrent requests)\nTransfer rate:          0.65 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0    0   0.4      0       8\nProcessing: 10002 39740 2686.3  40005   50319\nWaiting:    10002 39740 2686.4  40004   50319\nTotal:      10002 39741 2686.3  40005   50319\n\nPercentage of the requests served within a certain time (ms)\n  50%  40005\n  66%  40009\n  75%  40014\n  80%  40022\n  90%  40122\n  95%  40316\n  98%  40449\n  99%  40483\n 100%  50319 (longest request)\n```\n\n### 结论\n\n异步的servle在高并发的情况下可以使用较少的连接线程实现较大的吞吐。\n\n## 实现\n\n```java\n /**\n     * Puts this request into asynchronous mode, and initializes its\n     * {@link AsyncContext} with the original (unwrapped) ServletRequest\n     * and ServletResponse objects.\n     *\n     * <p>Calling this method will cause committal of the associated\n     * response to be delayed until {@link AsyncContext#complete} is\n     * called on the returned {@link AsyncContext}, or the asynchronous\n     * operation has timed out.\n     *\n     * <p>Calling {@link AsyncContext#hasOriginalRequestAndResponse()} on\n     * the returned AsyncContext will return <code>true</code>. Any filters\n     * invoked in the <i>outbound</i> direction after this request was put\n     * into asynchronous mode may use this as an indication that any request\n     * and/or response wrappers that they added during their <i>inbound</i>\n     * invocation need not stay around for the duration of the asynchronous\n     * operation, and therefore any of their associated resources may be\n     * released.\n     *\n     * <p>This method clears the list of {@link AsyncListener} instances\n     * (if any) that were registered with the AsyncContext returned by the\n     * previous call to one of the startAsync methods, after calling each\n     * AsyncListener at its {@link AsyncListener#onStartAsync onStartAsync}\n     * method.\n     *\n     * <p>Subsequent invocations of this method, or its overloaded \n     * variant, will return the same AsyncContext instance, reinitialized\n     * as appropriate.\n     *\n     * @return the (re)initialized AsyncContext\n     * \n     * @throws IllegalStateException if this request is within the scope of\n     * a filter or servlet that does not support asynchronous operations\n     * (that is, {@link #isAsyncSupported} returns false),\n     * or if this method is called again without any asynchronous dispatch\n     * (resulting from one of the {@link AsyncContext#dispatch} methods),\n     * is called outside the scope of any such dispatch, or is called again\n     * within the scope of the same dispatch, or if the response has\n     * already been closed\n     *\n     * @see AsyncContext#dispatch()\n     * @since Servlet 3.0\n     */\n        public AsyncContext startAsync() throws IllegalStateException;\n```\n\n//挖坑，待填\n\n## Spring 对异步Servlet的支持\n\nweb.xml中需要的配置：\n\n```xml\n    <!--spring encoding filter-->\n    <filter>\n        <filter-name>CharacterEncodingFilter</filter-name>\n        <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>\n        <init-param>\n            <param-name>encoding</param-name>\n            <param-value>utf-8</param-value>\n        </init-param>\n        <async-supported>true</async-supported>\n    </filter>\n\n        <!--servlet-->\n    <servlet>\n        <servlet-name>dispatcherServlet</servlet-name>\n        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>\n        <init-param>\n            <param-name>contextConfigLocation</param-name>\n            <param-value>\n                classpath:spring/mvc/mvc-app.xml\n            </param-value>\n        </init-param>\n        <load-on-startup>1</load-on-startup>\n        <async-supported>true</async-supported>\n    </servlet>\n```\n\n如果有filter的话也必须配置上异步的支持\n\n### Callable 方式\n\n```java\n    @RequestMapping(\"/async\")\n    @PostMapping\n    public Callable<String> asyncProcess() {\n        return new Callable<String>() {\n            @Override\n            public String call() throws Exception {\n                return \"index\";\n            }\n        };\n    }\n```\n\n这种方式返回一个`Callable`，Spring在线程池中执行`Callable`并获取到结果然后进行后续的处理。\n\nTaskExecutor 自定义线程池：\n\n```xml\n  <!-- ================================== -->  \n  <!-- 0. Set up task executor for async  -->\n  <!-- ================================== -->\n  <mvc:annotation-driven> \n    <mvc:async-support default-timeout=\"30000\" task-executor=\"taskExecutor\"/>\n  </mvc:annotation-driven>\n  <!-- modify the parameters of thread pool -->\n  <bean id=\"taskExecutor\" class=\"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor\">\n    <property name=\"corePoolSize\" value=\"5\"/>\n    <property name=\"maxPoolSize\" value=\"50\"/>\n    <property name=\"queueCapacity\" value=\"10\"/>\n    <property name=\"keepAliveSeconds\" value=\"120\"/>\n  </bean>\n```\n\n\n\n### DeferredResult 方式\n\n```java\n @RequestMapping(\"/asyncV2\")\n    public DeferredResult<String> aysncProcess2() {\n        final DeferredResult<String> stringDeferredResult = new DeferredResult<>();\n        MoreExecutors.directExecutor().execute(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    Thread.sleep(30000);\n                    stringDeferredResult.setResult(\"index\");\n                } catch (InterruptedException e) {\n                    stringDeferredResult.setErrorResult(\"error\");\n                }\n            }\n        });\n        return stringDeferredResult;\n    }\n```\n\n这种方式返回的是`DeferredResult`，计算的逻辑可以在业务线程池中计算，当计算完成后，\n\n直接向`DeferredResult`中set数据即可，会触发后续的处理，并返回给客户端。\n\n### 实现细节\n\n`RequestMappingHandlerAdapter`\n\n```java\n/**\n   * Invoke the {@link RequestMapping} handler method preparing a {@link ModelAndView}\n   * if view resolution is required.\n   * @since 4.2\n   * @see #createInvocableHandlerMethod(HandlerMethod)\n   */\n  protected ModelAndView invokeHandlerMethod(HttpServletRequest request,\n      HttpServletResponse response, HandlerMethod handlerMethod) throws Exception {\n\n    ServletWebRequest webRequest = new ServletWebRequest(request, response);\n    try {\n      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);\n      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);\n\n      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);\n      invocableMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);\n      invocableMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers);\n      invocableMethod.setDataBinderFactory(binderFactory);\n      invocableMethod.setParameterNameDiscoverer(this.parameterNameDiscoverer);\n\n      ModelAndViewContainer mavContainer = new ModelAndViewContainer();\n      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));\n      modelFactory.initModel(webRequest, mavContainer, invocableMethod);\n      mavContainer.setIgnoreDefaultModelOnRedirect(this.ignoreDefaultModelOnRedirect);\n\n      //创建异步请求\n      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);\n      asyncWebRequest.setTimeout(this.asyncRequestTimeout);\n\n      //下面的代码设置了Callable执行的线程池，以及拦截器还有DeferredResult的拦截器\n      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n      asyncManager.setTaskExecutor(this.taskExecutor);\n      asyncManager.setAsyncWebRequest(asyncWebRequest);\n      asyncManager.registerCallableInterceptors(this.callableInterceptors);\n      asyncManager.registerDeferredResultInterceptors(this.deferredResultInterceptors);\n\n      if (asyncManager.hasConcurrentResult()) {\n        Object result = asyncManager.getConcurrentResult();\n        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0];\n        asyncManager.clearConcurrentResult();\n        if (logger.isDebugEnabled()) {\n          logger.debug(\"Found concurrent result value [\" + result + \"]\");\n        }\n        invocableMethod = invocableMethod.wrapConcurrentResult(result);\n      }\n\n      invocableMethod.invokeAndHandle(webRequest, mavContainer);\n      if (asyncManager.isConcurrentHandlingStarted()) {\n        return null;\n      }\n\n      return getModelAndView(mavContainer, modelFactory, webRequest);\n    }\n    finally {\n      webRequest.requestCompleted();\n    }\n  }\n```\n\n#### Callable 的处理\n\n`Callable`的处理是在`CallableMethodReturnValueHandler`中的，这个接口最终继承了`HandlerMethodReturnValueHandler`, 也就是对Controller方法返回值的后处理。\n\n```java\npublic class CallableMethodReturnValueHandler implements AsyncHandlerMethodReturnValueHandler {\n  //省略...\n  @Override\n  public void handleReturnValue(Object returnValue, MethodParameter returnType,\n      ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {\n\n    if (returnValue == null) {\n      mavContainer.setRequestHandled(true);\n      return;\n    }\n\n    Callable<?> callable = (Callable<?>) returnValue;\n    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);\n  }\n}\n```\n\n最终是调用了`WebAsyncManager`的`startCallableProcessing`进行处理\n\n`WebAsyncManager`中的关键代码：\n\n```java\npublic void startCallableProcessing(Callable<?> callable, Object... processingContext) throws Exception {\n    Assert.notNull(callable, \"Callable must not be null\");\n    startCallableProcessing(new WebAsyncTask(callable), processingContext);\n  }\n\n  public void startCallableProcessing(final WebAsyncTask<?> webAsyncTask, Object... processingContext) throws Exception {\n    Assert.notNull(webAsyncTask, \"WebAsyncTask must not be null\");\n    Assert.state(this.asyncWebRequest != null, \"AsyncWebRequest must not be null\");\n\n    //超时\n    Long timeout = webAsyncTask.getTimeout();\n    if (timeout != null) {\n      this.asyncWebRequest.setTimeout(timeout);\n    }\n    //线程池\n    AsyncTaskExecutor executor = webAsyncTask.getExecutor();\n    if (executor != null) {\n      this.taskExecutor = executor;\n    }\n    //拦截器\n    List<CallableProcessingInterceptor> interceptors = new ArrayList<CallableProcessingInterceptor>();\n    interceptors.add(webAsyncTask.getInterceptor());\n    interceptors.addAll(this.callableInterceptors.values());\n    interceptors.add(timeoutCallableInterceptor);\n\n    final Callable<?> callable = webAsyncTask.getCallable();\n    final CallableInterceptorChain interceptorChain = new CallableInterceptorChain(interceptors);\n\n    //超时处理\n    this.asyncWebRequest.addTimeoutHandler(new Runnable() {\n      @Override\n      public void run() {\n        logger.debug(\"Processing timeout\");\n        Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);\n        if (result != CallableProcessingInterceptor.RESULT_NONE) {\n          setConcurrentResultAndDispatch(result);\n        }\n      }\n    });\n\n    //成功的回调，会触发拦截器的拦截\n    this.asyncWebRequest.addCompletionHandler(new Runnable() {\n      @Override\n      public void run() {\n        interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);\n      }\n    });\n\n    //拦截\n    interceptorChain.applyBeforeConcurrentHandling(this.asyncWebRequest, callable);\n    startAsyncProcessing(processingContext);\n    try {\n      this.taskExecutor.submit(new Runnable() {\n        @Override\n        public void run() {\n          Object result = null;\n          try {\n            //拦截\n            interceptorChain.applyPreProcess(asyncWebRequest, callable);\n            result = callable.call();\n          }\n          catch (Throwable ex) {\n            result = ex;\n          }\n          finally {\n            //拦截\n            result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);\n          }\n          setConcurrentResultAndDispatch(result);\n        }\n      });\n    }\n    catch (RejectedExecutionException ex) {\n      Object result = interceptorChain.applyPostProcess(this.asyncWebRequest, callable, ex);\n      setConcurrentResultAndDispatch(result);\n      throw ex;\n    }\n  }\n```\n\n#### DeferredResult 的处理\n\nDeferredResult的返回时机就是有数据的时候，顺藤摸瓜:\n\n```java\npublic boolean setResult(T result) {\n    return setResultInternal(result);\n  }\n\n  private boolean setResultInternal(Object result) {\n    // Immediate expiration check outside of the result lock\n    if (isSetOrExpired()) {\n      return false;\n    }\n    DeferredResultHandler resultHandlerToUse;\n    synchronized (this) {\n      // Got the lock in the meantime: double-check expiration status\n      if (isSetOrExpired()) {\n        return false;\n      }\n      // At this point, we got a new result to process\n      this.result = result;\n      resultHandlerToUse = this.resultHandler;\n      if (resultHandlerToUse == null) {\n        // No result handler set yet -> let the setResultHandler implementation\n        // pick up the result object and invoke the result handler for it.\n        return true;\n      }\n      // Result handler available -> let's clear the stored reference since\n      // we don't need it anymore.\n      this.resultHandler = null;\n    }\n    // If we get here, we need to process an existing result object immediately.\n    // The decision is made within the result lock; just the handle call outside\n    // of it, avoiding any deadlock potential with Servlet container locks.\n    resultHandlerToUse.handleResult(result);\n    return true;\n  }\n```\n\n`DeferredResultHandler`是什么鬼？我们new的时候没有设置啊？？其实这个也是由`HandlerMethodReturnValueHandler`来实现的，有个对应的`DeferredResultMethodReturnValueHandler`\n\n```java\n  @Override\n  public void handleReturnValue(Object returnValue, MethodParameter returnType,\n      ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {\n\n    if (returnValue == null) {\n      mavContainer.setRequestHandled(true);\n      return;\n    }\n\n    DeferredResultAdapter adapter = getAdapterFor(returnValue.getClass());\n    Assert.notNull(adapter);\n    DeferredResult<?> result = adapter.adaptToDeferredResult(returnValue);\n    WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer);\n  }\n```\n\n最终还是到了`WebAsyncManager`的处理方法中，和`Callable`的处理类似，不一一深入。\n\n值得一提的是，正是在这个`startDeferredResultProcessing`中塞入了一个`DeferredResultHandler`\n\n```java\ntry {\n      interceptorChain.applyPreProcess(this.asyncWebRequest, deferredResult);\n      deferredResult.setResultHandler(new DeferredResultHandler() {\n        @Override\n        public void handleResult(Object result) {\n          result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);\n          setConcurrentResultAndDispatch(result);\n        }\n      });\n    }\n    catch (Throwable ex) {\n      setConcurrentResultAndDispatch(ex);\n    }\n```\n\n因为我们是异步执行的，所以虽然handler的注入在后面，其实影响也不大，而且`setResult`中也做了判断。\n\n\n## 参考\n\n1. [Async Servlet Feature of Servlet 3 - JournalDev](http://www.journaldev.com/2008/async-servlet-feature-of-servlet-3)\n\n2. [17.12 Asynchronous Processing - Java Platform, Enterprise Edition: The Java EE Tutorial (Release 7)](https://docs.oracle.com/javaee/7/tutorial/servlets012.htm)\n\n3. [ab - Apache HTTP server benchmarking tool - Apache HTTP Server Version 2.4](https://httpd.apache.org/docs/2.4/programs/ab.html)\n\n4. [系统吞吐量（TPS）、用户并发量、性能测试概念和公式](http://www.ha97.com/5095.html)\n\n5. [servlet3新特性——异步请求处理 | 晓的技术博客](https://lanjingling.github.io/2016/01/20/servlet3-new-furture/)\n\n6. [解决java.util.concurrent.RejectedExecutionException - 小一的专栏 - 博客频道 - CSDN.NET](http://blog.csdn.net/wzy_1988/article/details/38922449)\n\n7. [Springmvc异步支持报错- - Lai18.com IT技术文章收藏夹](http://www.lai18.com/content/2483896.html)\n\n8. [Asynchronous Spring MVC – Hello World Example | Code Breeze !](http://shengwangi.blogspot.hk/2015/09/asynchronous-spring-mvc-hello-world.html)","slug":"servlet-async","published":1,"updated":"2017-04-16T12:04:30.014Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdab008rjh4kzn676omy","content":"<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>限定 tomcat的连接池个数为50，并发为200（&gt;&gt; 线程池大小），时异步具有很大的优势。</p>\n<p>如果并发量小于线程池大小，异步的反倒比同步的时间长了很久。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> <span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">maxThreads</span>=<span class=\"string\">\"50\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> <span class=\"attr\">URIEncoding</span>=<span class=\"string\">\"UTF-8\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>完整的测试代码地址： <a href=\"https://github.com/qsLI/Java_Tutorial/blob/master/web/src/main/java/com/air/async/AsyncRequestProcessor.java\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"></a></p>\n<h3 id=\"async-ab测试\"><a href=\"#async-ab测试\" class=\"headerlink\" title=\"async ab测试\"></a>async ab测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ab -n 10000 -c 200 http://localhost:8080/async</span><br><span class=\"line\">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class=\"line\">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=\"line\">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=\"line\"></span><br><span class=\"line\">Benchmarking localhost (be patient)</span><br><span class=\"line\">Completed 1000 requests</span><br><span class=\"line\">Completed 2000 requests</span><br><span class=\"line\">Completed 3000 requests</span><br><span class=\"line\">Completed 4000 requests</span><br><span class=\"line\">Completed 5000 requests</span><br><span class=\"line\">Completed 6000 requests</span><br><span class=\"line\">Completed 7000 requests</span><br><span class=\"line\">Completed 8000 requests</span><br><span class=\"line\">Completed 9000 requests</span><br><span class=\"line\">Completed 10000 requests</span><br><span class=\"line\">Finished 10000 requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Server Software:        Apache-Coyote/1.1</span><br><span class=\"line\">Server Hostname:        localhost</span><br><span class=\"line\">Server Port:            8080</span><br><span class=\"line\"></span><br><span class=\"line\">Document Path:          /async</span><br><span class=\"line\">Document Length:        40 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Concurrency Level:      200</span><br><span class=\"line\">Time taken for tests:   1000.284 seconds</span><br><span class=\"line\">Complete requests:      10000</span><br><span class=\"line\">Failed requests:        47</span><br><span class=\"line\">   (Connect: 0, Receive: 0, Length: 47, Exceptions: 0)</span><br><span class=\"line\">Write errors:           0</span><br><span class=\"line\">Non-2xx responses:      47</span><br><span class=\"line\">Total transferred:      1530740 bytes</span><br><span class=\"line\">HTML transferred:       506980 bytes</span><br><span class=\"line\">Requests per second:    10.00 [#/sec] (mean)</span><br><span class=\"line\">Time per request:       20005.686 [ms] (mean)</span><br><span class=\"line\">Time per request:       100.028 [ms] (mean, across all concurrent requests)</span><br><span class=\"line\">Transfer rate:          1.49 [Kbytes/sec] received</span><br><span class=\"line\"></span><br><span class=\"line\">Connection Times (ms)</span><br><span class=\"line\">              min  mean[+/-sd] median   max</span><br><span class=\"line\">Connect:        0    0   5.0      0     501</span><br><span class=\"line\">Processing:     2 19810 1683.3  20001   20560</span><br><span class=\"line\">Waiting:        1 19810 1683.4  20000   20558</span><br><span class=\"line\">Total:          2 19811 1683.0  20001   20560</span><br><span class=\"line\"></span><br><span class=\"line\">Percentage of the requests served within a certain time (ms)</span><br><span class=\"line\">  50%  20001</span><br><span class=\"line\">  66%  20001</span><br><span class=\"line\">  75%  20002</span><br><span class=\"line\">  80%  20002</span><br><span class=\"line\">  90%  20004</span><br><span class=\"line\">  95%  20009</span><br><span class=\"line\">  98%  20020</span><br><span class=\"line\">  99%  20035</span><br><span class=\"line\"> 100%  20560 (longest request)</span><br></pre></td></tr></table></figure>\n<p>测试过程中出的异常：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一月 21, 2017 1:05:32 上午 org.apache.catalina.core.StandardWrapperValve invoke</span><br><span class=\"line\">严重: Servlet.service() for servlet [com.air.async.AsyncServlet] in context with path [] threw exception</span><br><span class=\"line\">java.util.concurrent.RejectedExecutionException: Task com.air.async.AsyncRequestProcessor@3caec762 rejected from java.util.concurrent.ThreadPoolExecutor@64db0f23[Running, pool size = 100, active threads = 100, queued tasks = 100, completed tasks = 9726]</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)</span><br><span class=\"line\">  at com.air.async.AsyncServlet.doGet(AsyncServlet.java:25)</span><br><span class=\"line\">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:621)</span><br><span class=\"line\">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class=\"line\">  at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)</span><br><span class=\"line\">  at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)</span><br><span class=\"line\">  at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)</span><br><span class=\"line\">  at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)</span><br><span class=\"line\">  at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)</span><br><span class=\"line\">  at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)</span><br><span class=\"line\">  at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)</span><br><span class=\"line\">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2430)</span><br><span class=\"line\">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2419)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class=\"line\">  at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>\n<p>有47个失败的case，是队列满了，然后丢掉了请求。</p>\n<h3 id=\"sync-ab测试\"><a href=\"#sync-ab测试\" class=\"headerlink\" title=\"sync ab测试\"></a>sync ab测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ab -n 10000 -c 200 http://localhost:8080/hello</span><br><span class=\"line\">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class=\"line\">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=\"line\">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=\"line\"></span><br><span class=\"line\">Benchmarking localhost (be patient)</span><br><span class=\"line\">Completed 1000 requests</span><br><span class=\"line\">Completed 2000 requests</span><br><span class=\"line\">Completed 3000 requests</span><br><span class=\"line\">Completed 4000 requests</span><br><span class=\"line\">Completed 5000 requests</span><br><span class=\"line\">Completed 6000 requests</span><br><span class=\"line\">Completed 7000 requests</span><br><span class=\"line\">Completed 8000 requests</span><br><span class=\"line\">Completed 9000 requests</span><br><span class=\"line\">Completed 10000 requests</span><br><span class=\"line\">Finished 10000 requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Server Software:        Apache-Coyote/1.1</span><br><span class=\"line\">Server Hostname:        localhost</span><br><span class=\"line\">Server Port:            8080</span><br><span class=\"line\"></span><br><span class=\"line\">Document Path:          /hello</span><br><span class=\"line\">Document Length:        12 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Concurrency Level:      200</span><br><span class=\"line\">Time taken for tests:   2002.151 seconds</span><br><span class=\"line\">Complete requests:      10000</span><br><span class=\"line\">Failed requests:        0</span><br><span class=\"line\">Write errors:           0</span><br><span class=\"line\">Total transferred:      1340000 bytes</span><br><span class=\"line\">HTML transferred:       120000 bytes</span><br><span class=\"line\">Requests per second:    4.99 [#/sec] (mean)</span><br><span class=\"line\">Time per request:       40043.028 [ms] (mean)</span><br><span class=\"line\">Time per request:       200.215 [ms] (mean, across all concurrent requests)</span><br><span class=\"line\">Transfer rate:          0.65 [Kbytes/sec] received</span><br><span class=\"line\"></span><br><span class=\"line\">Connection Times (ms)</span><br><span class=\"line\">              min  mean[+/-sd] median   max</span><br><span class=\"line\">Connect:        0    0   0.4      0       8</span><br><span class=\"line\">Processing: 10002 39740 2686.3  40005   50319</span><br><span class=\"line\">Waiting:    10002 39740 2686.4  40004   50319</span><br><span class=\"line\">Total:      10002 39741 2686.3  40005   50319</span><br><span class=\"line\"></span><br><span class=\"line\">Percentage of the requests served within a certain time (ms)</span><br><span class=\"line\">  50%  40005</span><br><span class=\"line\">  66%  40009</span><br><span class=\"line\">  75%  40014</span><br><span class=\"line\">  80%  40022</span><br><span class=\"line\">  90%  40122</span><br><span class=\"line\">  95%  40316</span><br><span class=\"line\">  98%  40449</span><br><span class=\"line\">  99%  40483</span><br><span class=\"line\"> 100%  50319 (longest request)</span><br></pre></td></tr></table></figure>\n<h3 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h3><p>异步的servle在高并发的情况下可以使用较少的连接线程实现较大的吞吐。</p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Puts this request into asynchronous mode, and initializes its</span></span><br><span class=\"line\"><span class=\"comment\">    * &#123;<span class=\"doctag\">@link</span> AsyncContext&#125; with the original (unwrapped) ServletRequest</span></span><br><span class=\"line\"><span class=\"comment\">    * and ServletResponse objects.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;Calling this method will cause committal of the associated</span></span><br><span class=\"line\"><span class=\"comment\">    * response to be delayed until &#123;<span class=\"doctag\">@link</span> AsyncContext#complete&#125; is</span></span><br><span class=\"line\"><span class=\"comment\">    * called on the returned &#123;<span class=\"doctag\">@link</span> AsyncContext&#125;, or the asynchronous</span></span><br><span class=\"line\"><span class=\"comment\">    * operation has timed out.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;Calling &#123;<span class=\"doctag\">@link</span> AsyncContext#hasOriginalRequestAndResponse()&#125; on</span></span><br><span class=\"line\"><span class=\"comment\">    * the returned AsyncContext will return &lt;code&gt;true&lt;/code&gt;. Any filters</span></span><br><span class=\"line\"><span class=\"comment\">    * invoked in the &lt;i&gt;outbound&lt;/i&gt; direction after this request was put</span></span><br><span class=\"line\"><span class=\"comment\">    * into asynchronous mode may use this as an indication that any request</span></span><br><span class=\"line\"><span class=\"comment\">    * and/or response wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * invocation need not stay around for the duration of the asynchronous</span></span><br><span class=\"line\"><span class=\"comment\">    * operation, and therefore any of their associated resources may be</span></span><br><span class=\"line\"><span class=\"comment\">    * released.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;This method clears the list of &#123;<span class=\"doctag\">@link</span> AsyncListener&#125; instances</span></span><br><span class=\"line\"><span class=\"comment\">    * (if any) that were registered with the AsyncContext returned by the</span></span><br><span class=\"line\"><span class=\"comment\">    * previous call to one of the startAsync methods, after calling each</span></span><br><span class=\"line\"><span class=\"comment\">    * AsyncListener at its &#123;<span class=\"doctag\">@link</span> AsyncListener#onStartAsync onStartAsync&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    * method.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;Subsequent invocations of this method, or its overloaded </span></span><br><span class=\"line\"><span class=\"comment\">    * variant, will return the same AsyncContext instance, reinitialized</span></span><br><span class=\"line\"><span class=\"comment\">    * as appropriate.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@return</span> the (re)initialized AsyncContext</span></span><br><span class=\"line\"><span class=\"comment\">    * </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span> IllegalStateException if this request is within the scope of</span></span><br><span class=\"line\"><span class=\"comment\">    * a filter or servlet that does not support asynchronous operations</span></span><br><span class=\"line\"><span class=\"comment\">    * (that is, &#123;<span class=\"doctag\">@link</span> #isAsyncSupported&#125; returns false),</span></span><br><span class=\"line\"><span class=\"comment\">    * or if this method is called again without any asynchronous dispatch</span></span><br><span class=\"line\"><span class=\"comment\">    * (resulting from one of the &#123;<span class=\"doctag\">@link</span> AsyncContext#dispatch&#125; methods),</span></span><br><span class=\"line\"><span class=\"comment\">    * is called outside the scope of any such dispatch, or is called again</span></span><br><span class=\"line\"><span class=\"comment\">    * within the scope of the same dispatch, or if the response has</span></span><br><span class=\"line\"><span class=\"comment\">    * already been closed</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@see</span> AsyncContext#dispatch()</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@since</span> Servlet 3.0</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">       <span class=\"function\"><span class=\"keyword\">public</span> AsyncContext <span class=\"title\">startAsync</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure>\n<p>//挖坑，待填</p>\n<h2 id=\"Spring-对异步Servlet的支持\"><a href=\"#Spring-对异步Servlet的支持\" class=\"headerlink\" title=\"Spring 对异步Servlet的支持\"></a>Spring 对异步Servlet的支持</h2><p>web.xml中需要的配置：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--spring encoding filter--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>encoding<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>utf-8<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">async-supported</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">async-supported</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--servlet--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>dispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">            classpath:spring/mvc/mvc-app.xml</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">async-supported</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">async-supported</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>如果有filter的话也必须配置上异步的支持</p>\n<h3 id=\"Callable-方式\"><a href=\"#Callable-方式\" class=\"headerlink\" title=\"Callable 方式\"></a>Callable 方式</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/async\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@PostMapping</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Callable&lt;String&gt; <span class=\"title\">asyncProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Callable&lt;String&gt;() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">\"index\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这种方式返回一个<code>Callable</code>，Spring在线程池中执行<code>Callable</code>并获取到结果然后进行后续的处理。</p>\n<p>TaskExecutor 自定义线程池：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- ================================== --&gt;</span>  </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 0. Set up task executor for async  --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- ================================== --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mvc:async-support</span> <span class=\"attr\">default-timeout</span>=<span class=\"string\">\"30000\"</span> <span class=\"attr\">task-executor</span>=<span class=\"string\">\"taskExecutor\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- modify the parameters of thread pool --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"taskExecutor\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"corePoolSize\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"5\"</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"maxPoolSize\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"50\"</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"queueCapacity\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"10\"</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"keepAliveSeconds\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"120\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"DeferredResult-方式\"><a href=\"#DeferredResult-方式\" class=\"headerlink\" title=\"DeferredResult 方式\"></a>DeferredResult 方式</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/asyncV2\"</span>)</span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> DeferredResult&lt;String&gt; <span class=\"title\">aysncProcess2</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">final</span> DeferredResult&lt;String&gt; stringDeferredResult = <span class=\"keyword\">new</span> DeferredResult&lt;&gt;();</span><br><span class=\"line\">       MoreExecutors.directExecutor().execute(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">           <span class=\"meta\">@Override</span></span><br><span class=\"line\">           <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">               <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                   Thread.sleep(<span class=\"number\">30000</span>);</span><br><span class=\"line\">                   stringDeferredResult.setResult(<span class=\"string\">\"index\"</span>);</span><br><span class=\"line\">               &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                   stringDeferredResult.setErrorResult(<span class=\"string\">\"error\"</span>);</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;);</span><br><span class=\"line\">       <span class=\"keyword\">return</span> stringDeferredResult;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>这种方式返回的是<code>DeferredResult</code>，计算的逻辑可以在业务线程池中计算，当计算完成后，</p>\n<p>直接向<code>DeferredResult</code>中set数据即可，会触发后续的处理，并返回给客户端。</p>\n<h3 id=\"实现细节\"><a href=\"#实现细节\" class=\"headerlink\" title=\"实现细节\"></a>实现细节</h3><p><code>RequestMappingHandlerAdapter</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Invoke the &#123;<span class=\"doctag\">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class=\"doctag\">@link</span> ModelAndView&#125;</span></span><br><span class=\"line\"><span class=\"comment\">   * if view resolution is required.</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@since</span> 4.2</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@see</span> #createInvocableHandlerMethod(HandlerMethod)</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">invokeHandlerMethod</span><span class=\"params\">(HttpServletRequest request,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ServletWebRequest webRequest = <span class=\"keyword\">new</span> ServletWebRequest(request, response);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class=\"line\">      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class=\"line\"></span><br><span class=\"line\">      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);</span><br><span class=\"line\">      invocableMethod.setHandlerMethodArgumentResolvers(<span class=\"keyword\">this</span>.argumentResolvers);</span><br><span class=\"line\">      invocableMethod.setHandlerMethodReturnValueHandlers(<span class=\"keyword\">this</span>.returnValueHandlers);</span><br><span class=\"line\">      invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class=\"line\">      invocableMethod.setParameterNameDiscoverer(<span class=\"keyword\">this</span>.parameterNameDiscoverer);</span><br><span class=\"line\"></span><br><span class=\"line\">      ModelAndViewContainer mavContainer = <span class=\"keyword\">new</span> ModelAndViewContainer();</span><br><span class=\"line\">      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class=\"line\">      modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class=\"line\">      mavContainer.setIgnoreDefaultModelOnRedirect(<span class=\"keyword\">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//创建异步请求</span></span><br><span class=\"line\">      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class=\"line\">      asyncWebRequest.setTimeout(<span class=\"keyword\">this</span>.asyncRequestTimeout);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//下面的代码设置了Callable执行的线程池，以及拦截器还有DeferredResult的拦截器</span></span><br><span class=\"line\">      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\">      asyncManager.setTaskExecutor(<span class=\"keyword\">this</span>.taskExecutor);</span><br><span class=\"line\">      asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class=\"line\">      asyncManager.registerCallableInterceptors(<span class=\"keyword\">this</span>.callableInterceptors);</span><br><span class=\"line\">      asyncManager.registerDeferredResultInterceptors(<span class=\"keyword\">this</span>.deferredResultInterceptors);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class=\"line\">        Object result = asyncManager.getConcurrentResult();</span><br><span class=\"line\">        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class=\"number\">0</span>];</span><br><span class=\"line\">        asyncManager.clearConcurrentResult();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">          logger.debug(<span class=\"string\">\"Found concurrent result value [\"</span> + result + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">      webRequest.requestCompleted();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Callable-的处理\"><a href=\"#Callable-的处理\" class=\"headerlink\" title=\"Callable 的处理\"></a>Callable 的处理</h4><p><code>Callable</code>的处理是在<code>CallableMethodReturnValueHandler</code>中的，这个接口最终继承了<code>HandlerMethodReturnValueHandler</code>, 也就是对Controller方法返回值的后处理。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CallableMethodReturnValueHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">AsyncHandlerMethodReturnValueHandler</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//省略...</span></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleReturnValue</span><span class=\"params\">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">      ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (returnValue == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      mavContainer.setRequestHandled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Callable&lt;?&gt; callable = (Callable&lt;?&gt;) returnValue;</span><br><span class=\"line\">    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终是调用了<code>WebAsyncManager</code>的<code>startCallableProcessing</code>进行处理</p>\n<p><code>WebAsyncManager</code>中的关键代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startCallableProcessing</span><span class=\"params\">(Callable&lt;?&gt; callable, Object... processingContext)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    Assert.notNull(callable, <span class=\"string\">\"Callable must not be null\"</span>);</span><br><span class=\"line\">    startCallableProcessing(<span class=\"keyword\">new</span> WebAsyncTask(callable), processingContext);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startCallableProcessing</span><span class=\"params\">(<span class=\"keyword\">final</span> WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    Assert.notNull(webAsyncTask, <span class=\"string\">\"WebAsyncTask must not be null\"</span>);</span><br><span class=\"line\">    Assert.state(<span class=\"keyword\">this</span>.asyncWebRequest != <span class=\"keyword\">null</span>, <span class=\"string\">\"AsyncWebRequest must not be null\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//超时</span></span><br><span class=\"line\">    Long timeout = webAsyncTask.getTimeout();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//线程池</span></span><br><span class=\"line\">    AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (executor != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.taskExecutor = executor;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//拦截器</span></span><br><span class=\"line\">    List&lt;CallableProcessingInterceptor&gt; interceptors = <span class=\"keyword\">new</span> ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class=\"line\">    interceptors.add(webAsyncTask.getInterceptor());</span><br><span class=\"line\">    interceptors.addAll(<span class=\"keyword\">this</span>.callableInterceptors.values());</span><br><span class=\"line\">    interceptors.add(timeoutCallableInterceptor);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> CallableInterceptorChain interceptorChain = <span class=\"keyword\">new</span> CallableInterceptorChain(interceptors);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//超时处理</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.asyncWebRequest.addTimeoutHandler(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        logger.debug(<span class=\"string\">\"Processing timeout\"</span>);</span><br><span class=\"line\">        Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class=\"line\">          setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//成功的回调，会触发拦截器的拦截</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.asyncWebRequest.addCompletionHandler(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//拦截</span></span><br><span class=\"line\">    interceptorChain.applyBeforeConcurrentHandling(<span class=\"keyword\">this</span>.asyncWebRequest, callable);</span><br><span class=\"line\">    startAsyncProcessing(processingContext);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.taskExecutor.submit(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">          Object result = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//拦截</span></span><br><span class=\"line\">            interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class=\"line\">            result = callable.call();</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">            result = ex;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//拦截</span></span><br><span class=\"line\">            result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class=\"line\">      Object result = interceptorChain.applyPostProcess(<span class=\"keyword\">this</span>.asyncWebRequest, callable, ex);</span><br><span class=\"line\">      setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">      <span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"DeferredResult-的处理\"><a href=\"#DeferredResult-的处理\" class=\"headerlink\" title=\"DeferredResult 的处理\"></a>DeferredResult 的处理</h4><p>DeferredResult的返回时机就是有数据的时候，顺藤摸瓜:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">setResult</span><span class=\"params\">(T result)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> setResultInternal(result);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">setResultInternal</span><span class=\"params\">(Object result)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Immediate expiration check outside of the result lock</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isSetOrExpired()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    DeferredResultHandler resultHandlerToUse;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Got the lock in the meantime: double-check expiration status</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (isSetOrExpired()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">// At this point, we got a new result to process</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.result = result;</span><br><span class=\"line\">      resultHandlerToUse = <span class=\"keyword\">this</span>.resultHandler;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (resultHandlerToUse == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// No result handler set yet -&gt; let the setResultHandler implementation</span></span><br><span class=\"line\">        <span class=\"comment\">// pick up the result object and invoke the result handler for it.</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">// Result handler available -&gt; let's clear the stored reference since</span></span><br><span class=\"line\">      <span class=\"comment\">// we don't need it anymore.</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.resultHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// If we get here, we need to process an existing result object immediately.</span></span><br><span class=\"line\">    <span class=\"comment\">// The decision is made within the result lock; just the handle call outside</span></span><br><span class=\"line\">    <span class=\"comment\">// of it, avoiding any deadlock potential with Servlet container locks.</span></span><br><span class=\"line\">    resultHandlerToUse.handleResult(result);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p><code>DeferredResultHandler</code>是什么鬼？我们new的时候没有设置啊？？其实这个也是由<code>HandlerMethodReturnValueHandler</code>来实现的，有个对应的<code>DeferredResultMethodReturnValueHandler</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleReturnValue</span><span class=\"params\">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (returnValue == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    mavContainer.setRequestHandled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  DeferredResultAdapter adapter = getAdapterFor(returnValue.getClass());</span><br><span class=\"line\">  Assert.notNull(adapter);</span><br><span class=\"line\">  DeferredResult&lt;?&gt; result = adapter.adaptToDeferredResult(returnValue);</span><br><span class=\"line\">  WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终还是到了<code>WebAsyncManager</code>的处理方法中，和<code>Callable</code>的处理类似，不一一深入。</p>\n<p>值得一提的是，正是在这个<code>startDeferredResultProcessing</code>中塞入了一个<code>DeferredResultHandler</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      interceptorChain.applyPreProcess(<span class=\"keyword\">this</span>.asyncWebRequest, deferredResult);</span><br><span class=\"line\">      deferredResult.setResultHandler(<span class=\"keyword\">new</span> DeferredResultHandler() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleResult</span><span class=\"params\">(Object result)</span> </span>&#123;</span><br><span class=\"line\">          result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);</span><br><span class=\"line\">          setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">      setConcurrentResultAndDispatch(ex);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>因为我们是异步执行的，所以虽然handler的注入在后面，其实影响也不大，而且<code>setResult</code>中也做了判断。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.journaldev.com/2008/async-servlet-feature-of-servlet-3\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Async Servlet Feature of Servlet 3 - JournalDev</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javaee/7/tutorial/servlets012.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">17.12 Asynchronous Processing - Java Platform, Enterprise Edition: The Java EE Tutorial (Release 7)</a></p>\n</li>\n<li><p><a href=\"https://httpd.apache.org/docs/2.4/programs/ab.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">ab - Apache HTTP server benchmarking tool - Apache HTTP Server Version 2.4</a></p>\n</li>\n<li><p><a href=\"http://www.ha97.com/5095.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">系统吞吐量（TPS）、用户并发量、性能测试概念和公式</a></p>\n</li>\n<li><p><a href=\"https://lanjingling.github.io/2016/01/20/servlet3-new-furture/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">servlet3新特性——异步请求处理 | 晓的技术博客</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/wzy_1988/article/details/38922449\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">解决java.util.concurrent.RejectedExecutionException - 小一的专栏 - 博客频道 - CSDN.NET</a></p>\n</li>\n<li><p><a href=\"http://www.lai18.com/content/2483896.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Springmvc异步支持报错- - Lai18.com IT技术文章收藏夹</a></p>\n</li>\n<li><p><a href=\"http://shengwangi.blogspot.hk/2015/09/asynchronous-spring-mvc-hello-world.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Asynchronous Spring MVC – Hello World Example | Code Breeze !</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>限定 tomcat的连接池个数为50，并发为200（&gt;&gt; 线程池大小），时异步具有很大的优势。</p>\n<p>如果并发量小于线程池大小，异步的反倒比同步的时间长了很久。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> <span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">maxThreads</span>=<span class=\"string\">\"50\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> <span class=\"attr\">URIEncoding</span>=<span class=\"string\">\"UTF-8\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>完整的测试代码地址： <a href=\"https://github.com/qsLI/Java_Tutorial/blob/master/web/src/main/java/com/air/async/AsyncRequestProcessor.java\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\"></a></p>\n<h3 id=\"async-ab测试\"><a href=\"#async-ab测试\" class=\"headerlink\" title=\"async ab测试\"></a>async ab测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ab -n 10000 -c 200 http://localhost:8080/async</span><br><span class=\"line\">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class=\"line\">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=\"line\">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=\"line\"></span><br><span class=\"line\">Benchmarking localhost (be patient)</span><br><span class=\"line\">Completed 1000 requests</span><br><span class=\"line\">Completed 2000 requests</span><br><span class=\"line\">Completed 3000 requests</span><br><span class=\"line\">Completed 4000 requests</span><br><span class=\"line\">Completed 5000 requests</span><br><span class=\"line\">Completed 6000 requests</span><br><span class=\"line\">Completed 7000 requests</span><br><span class=\"line\">Completed 8000 requests</span><br><span class=\"line\">Completed 9000 requests</span><br><span class=\"line\">Completed 10000 requests</span><br><span class=\"line\">Finished 10000 requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Server Software:        Apache-Coyote/1.1</span><br><span class=\"line\">Server Hostname:        localhost</span><br><span class=\"line\">Server Port:            8080</span><br><span class=\"line\"></span><br><span class=\"line\">Document Path:          /async</span><br><span class=\"line\">Document Length:        40 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Concurrency Level:      200</span><br><span class=\"line\">Time taken for tests:   1000.284 seconds</span><br><span class=\"line\">Complete requests:      10000</span><br><span class=\"line\">Failed requests:        47</span><br><span class=\"line\">   (Connect: 0, Receive: 0, Length: 47, Exceptions: 0)</span><br><span class=\"line\">Write errors:           0</span><br><span class=\"line\">Non-2xx responses:      47</span><br><span class=\"line\">Total transferred:      1530740 bytes</span><br><span class=\"line\">HTML transferred:       506980 bytes</span><br><span class=\"line\">Requests per second:    10.00 [#/sec] (mean)</span><br><span class=\"line\">Time per request:       20005.686 [ms] (mean)</span><br><span class=\"line\">Time per request:       100.028 [ms] (mean, across all concurrent requests)</span><br><span class=\"line\">Transfer rate:          1.49 [Kbytes/sec] received</span><br><span class=\"line\"></span><br><span class=\"line\">Connection Times (ms)</span><br><span class=\"line\">              min  mean[+/-sd] median   max</span><br><span class=\"line\">Connect:        0    0   5.0      0     501</span><br><span class=\"line\">Processing:     2 19810 1683.3  20001   20560</span><br><span class=\"line\">Waiting:        1 19810 1683.4  20000   20558</span><br><span class=\"line\">Total:          2 19811 1683.0  20001   20560</span><br><span class=\"line\"></span><br><span class=\"line\">Percentage of the requests served within a certain time (ms)</span><br><span class=\"line\">  50%  20001</span><br><span class=\"line\">  66%  20001</span><br><span class=\"line\">  75%  20002</span><br><span class=\"line\">  80%  20002</span><br><span class=\"line\">  90%  20004</span><br><span class=\"line\">  95%  20009</span><br><span class=\"line\">  98%  20020</span><br><span class=\"line\">  99%  20035</span><br><span class=\"line\"> 100%  20560 (longest request)</span><br></pre></td></tr></table></figure>\n<p>测试过程中出的异常：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一月 21, 2017 1:05:32 上午 org.apache.catalina.core.StandardWrapperValve invoke</span><br><span class=\"line\">严重: Servlet.service() for servlet [com.air.async.AsyncServlet] in context with path [] threw exception</span><br><span class=\"line\">java.util.concurrent.RejectedExecutionException: Task com.air.async.AsyncRequestProcessor@3caec762 rejected from java.util.concurrent.ThreadPoolExecutor@64db0f23[Running, pool size = 100, active threads = 100, queued tasks = 100, completed tasks = 9726]</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)</span><br><span class=\"line\">  at com.air.async.AsyncServlet.doGet(AsyncServlet.java:25)</span><br><span class=\"line\">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:621)</span><br><span class=\"line\">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class=\"line\">  at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)</span><br><span class=\"line\">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)</span><br><span class=\"line\">  at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)</span><br><span class=\"line\">  at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)</span><br><span class=\"line\">  at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)</span><br><span class=\"line\">  at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)</span><br><span class=\"line\">  at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)</span><br><span class=\"line\">  at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)</span><br><span class=\"line\">  at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)</span><br><span class=\"line\">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2430)</span><br><span class=\"line\">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2419)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class=\"line\">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class=\"line\">  at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>\n<p>有47个失败的case，是队列满了，然后丢掉了请求。</p>\n<h3 id=\"sync-ab测试\"><a href=\"#sync-ab测试\" class=\"headerlink\" title=\"sync ab测试\"></a>sync ab测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ab -n 10000 -c 200 http://localhost:8080/hello</span><br><span class=\"line\">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class=\"line\">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=\"line\">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=\"line\"></span><br><span class=\"line\">Benchmarking localhost (be patient)</span><br><span class=\"line\">Completed 1000 requests</span><br><span class=\"line\">Completed 2000 requests</span><br><span class=\"line\">Completed 3000 requests</span><br><span class=\"line\">Completed 4000 requests</span><br><span class=\"line\">Completed 5000 requests</span><br><span class=\"line\">Completed 6000 requests</span><br><span class=\"line\">Completed 7000 requests</span><br><span class=\"line\">Completed 8000 requests</span><br><span class=\"line\">Completed 9000 requests</span><br><span class=\"line\">Completed 10000 requests</span><br><span class=\"line\">Finished 10000 requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Server Software:        Apache-Coyote/1.1</span><br><span class=\"line\">Server Hostname:        localhost</span><br><span class=\"line\">Server Port:            8080</span><br><span class=\"line\"></span><br><span class=\"line\">Document Path:          /hello</span><br><span class=\"line\">Document Length:        12 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Concurrency Level:      200</span><br><span class=\"line\">Time taken for tests:   2002.151 seconds</span><br><span class=\"line\">Complete requests:      10000</span><br><span class=\"line\">Failed requests:        0</span><br><span class=\"line\">Write errors:           0</span><br><span class=\"line\">Total transferred:      1340000 bytes</span><br><span class=\"line\">HTML transferred:       120000 bytes</span><br><span class=\"line\">Requests per second:    4.99 [#/sec] (mean)</span><br><span class=\"line\">Time per request:       40043.028 [ms] (mean)</span><br><span class=\"line\">Time per request:       200.215 [ms] (mean, across all concurrent requests)</span><br><span class=\"line\">Transfer rate:          0.65 [Kbytes/sec] received</span><br><span class=\"line\"></span><br><span class=\"line\">Connection Times (ms)</span><br><span class=\"line\">              min  mean[+/-sd] median   max</span><br><span class=\"line\">Connect:        0    0   0.4      0       8</span><br><span class=\"line\">Processing: 10002 39740 2686.3  40005   50319</span><br><span class=\"line\">Waiting:    10002 39740 2686.4  40004   50319</span><br><span class=\"line\">Total:      10002 39741 2686.3  40005   50319</span><br><span class=\"line\"></span><br><span class=\"line\">Percentage of the requests served within a certain time (ms)</span><br><span class=\"line\">  50%  40005</span><br><span class=\"line\">  66%  40009</span><br><span class=\"line\">  75%  40014</span><br><span class=\"line\">  80%  40022</span><br><span class=\"line\">  90%  40122</span><br><span class=\"line\">  95%  40316</span><br><span class=\"line\">  98%  40449</span><br><span class=\"line\">  99%  40483</span><br><span class=\"line\"> 100%  50319 (longest request)</span><br></pre></td></tr></table></figure>\n<h3 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h3><p>异步的servle在高并发的情况下可以使用较少的连接线程实现较大的吞吐。</p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Puts this request into asynchronous mode, and initializes its</span></span><br><span class=\"line\"><span class=\"comment\">    * &#123;<span class=\"doctag\">@link</span> AsyncContext&#125; with the original (unwrapped) ServletRequest</span></span><br><span class=\"line\"><span class=\"comment\">    * and ServletResponse objects.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;Calling this method will cause committal of the associated</span></span><br><span class=\"line\"><span class=\"comment\">    * response to be delayed until &#123;<span class=\"doctag\">@link</span> AsyncContext#complete&#125; is</span></span><br><span class=\"line\"><span class=\"comment\">    * called on the returned &#123;<span class=\"doctag\">@link</span> AsyncContext&#125;, or the asynchronous</span></span><br><span class=\"line\"><span class=\"comment\">    * operation has timed out.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;Calling &#123;<span class=\"doctag\">@link</span> AsyncContext#hasOriginalRequestAndResponse()&#125; on</span></span><br><span class=\"line\"><span class=\"comment\">    * the returned AsyncContext will return &lt;code&gt;true&lt;/code&gt;. Any filters</span></span><br><span class=\"line\"><span class=\"comment\">    * invoked in the &lt;i&gt;outbound&lt;/i&gt; direction after this request was put</span></span><br><span class=\"line\"><span class=\"comment\">    * into asynchronous mode may use this as an indication that any request</span></span><br><span class=\"line\"><span class=\"comment\">    * and/or response wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * invocation need not stay around for the duration of the asynchronous</span></span><br><span class=\"line\"><span class=\"comment\">    * operation, and therefore any of their associated resources may be</span></span><br><span class=\"line\"><span class=\"comment\">    * released.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;This method clears the list of &#123;<span class=\"doctag\">@link</span> AsyncListener&#125; instances</span></span><br><span class=\"line\"><span class=\"comment\">    * (if any) that were registered with the AsyncContext returned by the</span></span><br><span class=\"line\"><span class=\"comment\">    * previous call to one of the startAsync methods, after calling each</span></span><br><span class=\"line\"><span class=\"comment\">    * AsyncListener at its &#123;<span class=\"doctag\">@link</span> AsyncListener#onStartAsync onStartAsync&#125;</span></span><br><span class=\"line\"><span class=\"comment\">    * method.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;p&gt;Subsequent invocations of this method, or its overloaded </span></span><br><span class=\"line\"><span class=\"comment\">    * variant, will return the same AsyncContext instance, reinitialized</span></span><br><span class=\"line\"><span class=\"comment\">    * as appropriate.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@return</span> the (re)initialized AsyncContext</span></span><br><span class=\"line\"><span class=\"comment\">    * </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@throws</span> IllegalStateException if this request is within the scope of</span></span><br><span class=\"line\"><span class=\"comment\">    * a filter or servlet that does not support asynchronous operations</span></span><br><span class=\"line\"><span class=\"comment\">    * (that is, &#123;<span class=\"doctag\">@link</span> #isAsyncSupported&#125; returns false),</span></span><br><span class=\"line\"><span class=\"comment\">    * or if this method is called again without any asynchronous dispatch</span></span><br><span class=\"line\"><span class=\"comment\">    * (resulting from one of the &#123;<span class=\"doctag\">@link</span> AsyncContext#dispatch&#125; methods),</span></span><br><span class=\"line\"><span class=\"comment\">    * is called outside the scope of any such dispatch, or is called again</span></span><br><span class=\"line\"><span class=\"comment\">    * within the scope of the same dispatch, or if the response has</span></span><br><span class=\"line\"><span class=\"comment\">    * already been closed</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@see</span> AsyncContext#dispatch()</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@since</span> Servlet 3.0</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">       <span class=\"function\"><span class=\"keyword\">public</span> AsyncContext <span class=\"title\">startAsync</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure>\n<p>//挖坑，待填</p>\n<h2 id=\"Spring-对异步Servlet的支持\"><a href=\"#Spring-对异步Servlet的支持\" class=\"headerlink\" title=\"Spring 对异步Servlet的支持\"></a>Spring 对异步Servlet的支持</h2><p>web.xml中需要的配置：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--spring encoding filter--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>encoding<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>utf-8<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">async-supported</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">async-supported</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--servlet--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>dispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">            classpath:spring/mvc/mvc-app.xml</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">async-supported</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">async-supported</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>如果有filter的话也必须配置上异步的支持</p>\n<h3 id=\"Callable-方式\"><a href=\"#Callable-方式\" class=\"headerlink\" title=\"Callable 方式\"></a>Callable 方式</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/async\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@PostMapping</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Callable&lt;String&gt; <span class=\"title\">asyncProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Callable&lt;String&gt;() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">\"index\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这种方式返回一个<code>Callable</code>，Spring在线程池中执行<code>Callable</code>并获取到结果然后进行后续的处理。</p>\n<p>TaskExecutor 自定义线程池：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- ================================== --&gt;</span>  </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 0. Set up task executor for async  --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- ================================== --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span>&gt;</span> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mvc:async-support</span> <span class=\"attr\">default-timeout</span>=<span class=\"string\">\"30000\"</span> <span class=\"attr\">task-executor</span>=<span class=\"string\">\"taskExecutor\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- modify the parameters of thread pool --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"taskExecutor\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"corePoolSize\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"5\"</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"maxPoolSize\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"50\"</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"queueCapacity\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"10\"</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"keepAliveSeconds\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"120\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"DeferredResult-方式\"><a href=\"#DeferredResult-方式\" class=\"headerlink\" title=\"DeferredResult 方式\"></a>DeferredResult 方式</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/asyncV2\"</span>)</span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> DeferredResult&lt;String&gt; <span class=\"title\">aysncProcess2</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">final</span> DeferredResult&lt;String&gt; stringDeferredResult = <span class=\"keyword\">new</span> DeferredResult&lt;&gt;();</span><br><span class=\"line\">       MoreExecutors.directExecutor().execute(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">           <span class=\"meta\">@Override</span></span><br><span class=\"line\">           <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">               <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                   Thread.sleep(<span class=\"number\">30000</span>);</span><br><span class=\"line\">                   stringDeferredResult.setResult(<span class=\"string\">\"index\"</span>);</span><br><span class=\"line\">               &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                   stringDeferredResult.setErrorResult(<span class=\"string\">\"error\"</span>);</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;);</span><br><span class=\"line\">       <span class=\"keyword\">return</span> stringDeferredResult;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>这种方式返回的是<code>DeferredResult</code>，计算的逻辑可以在业务线程池中计算，当计算完成后，</p>\n<p>直接向<code>DeferredResult</code>中set数据即可，会触发后续的处理，并返回给客户端。</p>\n<h3 id=\"实现细节\"><a href=\"#实现细节\" class=\"headerlink\" title=\"实现细节\"></a>实现细节</h3><p><code>RequestMappingHandlerAdapter</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Invoke the &#123;<span class=\"doctag\">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class=\"doctag\">@link</span> ModelAndView&#125;</span></span><br><span class=\"line\"><span class=\"comment\">   * if view resolution is required.</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@since</span> 4.2</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@see</span> #createInvocableHandlerMethod(HandlerMethod)</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">protected</span> ModelAndView <span class=\"title\">invokeHandlerMethod</span><span class=\"params\">(HttpServletRequest request,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ServletWebRequest webRequest = <span class=\"keyword\">new</span> ServletWebRequest(request, response);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class=\"line\">      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class=\"line\"></span><br><span class=\"line\">      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);</span><br><span class=\"line\">      invocableMethod.setHandlerMethodArgumentResolvers(<span class=\"keyword\">this</span>.argumentResolvers);</span><br><span class=\"line\">      invocableMethod.setHandlerMethodReturnValueHandlers(<span class=\"keyword\">this</span>.returnValueHandlers);</span><br><span class=\"line\">      invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class=\"line\">      invocableMethod.setParameterNameDiscoverer(<span class=\"keyword\">this</span>.parameterNameDiscoverer);</span><br><span class=\"line\"></span><br><span class=\"line\">      ModelAndViewContainer mavContainer = <span class=\"keyword\">new</span> ModelAndViewContainer();</span><br><span class=\"line\">      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class=\"line\">      modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class=\"line\">      mavContainer.setIgnoreDefaultModelOnRedirect(<span class=\"keyword\">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//创建异步请求</span></span><br><span class=\"line\">      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class=\"line\">      asyncWebRequest.setTimeout(<span class=\"keyword\">this</span>.asyncRequestTimeout);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//下面的代码设置了Callable执行的线程池，以及拦截器还有DeferredResult的拦截器</span></span><br><span class=\"line\">      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\">      asyncManager.setTaskExecutor(<span class=\"keyword\">this</span>.taskExecutor);</span><br><span class=\"line\">      asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class=\"line\">      asyncManager.registerCallableInterceptors(<span class=\"keyword\">this</span>.callableInterceptors);</span><br><span class=\"line\">      asyncManager.registerDeferredResultInterceptors(<span class=\"keyword\">this</span>.deferredResultInterceptors);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class=\"line\">        Object result = asyncManager.getConcurrentResult();</span><br><span class=\"line\">        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class=\"number\">0</span>];</span><br><span class=\"line\">        asyncManager.clearConcurrentResult();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">          logger.debug(<span class=\"string\">\"Found concurrent result value [\"</span> + result + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">      webRequest.requestCompleted();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Callable-的处理\"><a href=\"#Callable-的处理\" class=\"headerlink\" title=\"Callable 的处理\"></a>Callable 的处理</h4><p><code>Callable</code>的处理是在<code>CallableMethodReturnValueHandler</code>中的，这个接口最终继承了<code>HandlerMethodReturnValueHandler</code>, 也就是对Controller方法返回值的后处理。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CallableMethodReturnValueHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">AsyncHandlerMethodReturnValueHandler</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//省略...</span></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleReturnValue</span><span class=\"params\">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">      ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (returnValue == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      mavContainer.setRequestHandled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Callable&lt;?&gt; callable = (Callable&lt;?&gt;) returnValue;</span><br><span class=\"line\">    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终是调用了<code>WebAsyncManager</code>的<code>startCallableProcessing</code>进行处理</p>\n<p><code>WebAsyncManager</code>中的关键代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startCallableProcessing</span><span class=\"params\">(Callable&lt;?&gt; callable, Object... processingContext)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    Assert.notNull(callable, <span class=\"string\">\"Callable must not be null\"</span>);</span><br><span class=\"line\">    startCallableProcessing(<span class=\"keyword\">new</span> WebAsyncTask(callable), processingContext);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startCallableProcessing</span><span class=\"params\">(<span class=\"keyword\">final</span> WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    Assert.notNull(webAsyncTask, <span class=\"string\">\"WebAsyncTask must not be null\"</span>);</span><br><span class=\"line\">    Assert.state(<span class=\"keyword\">this</span>.asyncWebRequest != <span class=\"keyword\">null</span>, <span class=\"string\">\"AsyncWebRequest must not be null\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//超时</span></span><br><span class=\"line\">    Long timeout = webAsyncTask.getTimeout();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//线程池</span></span><br><span class=\"line\">    AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (executor != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.taskExecutor = executor;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//拦截器</span></span><br><span class=\"line\">    List&lt;CallableProcessingInterceptor&gt; interceptors = <span class=\"keyword\">new</span> ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class=\"line\">    interceptors.add(webAsyncTask.getInterceptor());</span><br><span class=\"line\">    interceptors.addAll(<span class=\"keyword\">this</span>.callableInterceptors.values());</span><br><span class=\"line\">    interceptors.add(timeoutCallableInterceptor);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class=\"line\">    <span class=\"keyword\">final</span> CallableInterceptorChain interceptorChain = <span class=\"keyword\">new</span> CallableInterceptorChain(interceptors);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//超时处理</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.asyncWebRequest.addTimeoutHandler(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        logger.debug(<span class=\"string\">\"Processing timeout\"</span>);</span><br><span class=\"line\">        Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class=\"line\">          setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//成功的回调，会触发拦截器的拦截</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.asyncWebRequest.addCompletionHandler(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//拦截</span></span><br><span class=\"line\">    interceptorChain.applyBeforeConcurrentHandling(<span class=\"keyword\">this</span>.asyncWebRequest, callable);</span><br><span class=\"line\">    startAsyncProcessing(processingContext);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.taskExecutor.submit(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">          Object result = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//拦截</span></span><br><span class=\"line\">            interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class=\"line\">            result = callable.call();</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">            result = ex;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//拦截</span></span><br><span class=\"line\">            result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class=\"line\">      Object result = interceptorChain.applyPostProcess(<span class=\"keyword\">this</span>.asyncWebRequest, callable, ex);</span><br><span class=\"line\">      setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">      <span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"DeferredResult-的处理\"><a href=\"#DeferredResult-的处理\" class=\"headerlink\" title=\"DeferredResult 的处理\"></a>DeferredResult 的处理</h4><p>DeferredResult的返回时机就是有数据的时候，顺藤摸瓜:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">setResult</span><span class=\"params\">(T result)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> setResultInternal(result);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">setResultInternal</span><span class=\"params\">(Object result)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Immediate expiration check outside of the result lock</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isSetOrExpired()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    DeferredResultHandler resultHandlerToUse;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Got the lock in the meantime: double-check expiration status</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (isSetOrExpired()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">// At this point, we got a new result to process</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.result = result;</span><br><span class=\"line\">      resultHandlerToUse = <span class=\"keyword\">this</span>.resultHandler;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (resultHandlerToUse == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// No result handler set yet -&gt; let the setResultHandler implementation</span></span><br><span class=\"line\">        <span class=\"comment\">// pick up the result object and invoke the result handler for it.</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"comment\">// Result handler available -&gt; let's clear the stored reference since</span></span><br><span class=\"line\">      <span class=\"comment\">// we don't need it anymore.</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.resultHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// If we get here, we need to process an existing result object immediately.</span></span><br><span class=\"line\">    <span class=\"comment\">// The decision is made within the result lock; just the handle call outside</span></span><br><span class=\"line\">    <span class=\"comment\">// of it, avoiding any deadlock potential with Servlet container locks.</span></span><br><span class=\"line\">    resultHandlerToUse.handleResult(result);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p><code>DeferredResultHandler</code>是什么鬼？我们new的时候没有设置啊？？其实这个也是由<code>HandlerMethodReturnValueHandler</code>来实现的，有个对应的<code>DeferredResultMethodReturnValueHandler</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleReturnValue</span><span class=\"params\">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (returnValue == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    mavContainer.setRequestHandled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  DeferredResultAdapter adapter = getAdapterFor(returnValue.getClass());</span><br><span class=\"line\">  Assert.notNull(adapter);</span><br><span class=\"line\">  DeferredResult&lt;?&gt; result = adapter.adaptToDeferredResult(returnValue);</span><br><span class=\"line\">  WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终还是到了<code>WebAsyncManager</code>的处理方法中，和<code>Callable</code>的处理类似，不一一深入。</p>\n<p>值得一提的是，正是在这个<code>startDeferredResultProcessing</code>中塞入了一个<code>DeferredResultHandler</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      interceptorChain.applyPreProcess(<span class=\"keyword\">this</span>.asyncWebRequest, deferredResult);</span><br><span class=\"line\">      deferredResult.setResultHandler(<span class=\"keyword\">new</span> DeferredResultHandler() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleResult</span><span class=\"params\">(Object result)</span> </span>&#123;</span><br><span class=\"line\">          result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);</span><br><span class=\"line\">          setConcurrentResultAndDispatch(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">      setConcurrentResultAndDispatch(ex);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>因为我们是异步执行的，所以虽然handler的注入在后面，其实影响也不大，而且<code>setResult</code>中也做了判断。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.journaldev.com/2008/async-servlet-feature-of-servlet-3\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Async Servlet Feature of Servlet 3 - JournalDev</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javaee/7/tutorial/servlets012.htm\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">17.12 Asynchronous Processing - Java Platform, Enterprise Edition: The Java EE Tutorial (Release 7)</a></p>\n</li>\n<li><p><a href=\"https://httpd.apache.org/docs/2.4/programs/ab.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">ab - Apache HTTP server benchmarking tool - Apache HTTP Server Version 2.4</a></p>\n</li>\n<li><p><a href=\"http://www.ha97.com/5095.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">系统吞吐量（TPS）、用户并发量、性能测试概念和公式</a></p>\n</li>\n<li><p><a href=\"https://lanjingling.github.io/2016/01/20/servlet3-new-furture/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">servlet3新特性——异步请求处理 | 晓的技术博客</a></p>\n</li>\n<li><p><a href=\"http://blog.csdn.net/wzy_1988/article/details/38922449\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">解决java.util.concurrent.RejectedExecutionException - 小一的专栏 - 博客频道 - CSDN.NET</a></p>\n</li>\n<li><p><a href=\"http://www.lai18.com/content/2483896.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Springmvc异步支持报错- - Lai18.com IT技术文章收藏夹</a></p>\n</li>\n<li><p><a href=\"http://shengwangi.blogspot.hk/2015/09/asynchronous-spring-mvc-hello-world.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Asynchronous Spring MVC – Hello World Example | Code Breeze !</a></p>\n</li>\n</ol>\n"},{"title":"linux 下使用 shadowsocks","toc":true,"abbrlink":43024,"date":"2015-10-09T11:44:14.000Z","_content":"## 安装shadowsocks\nshadowsocks 是使用 python 编写的，用 python 的包管理软件 pip 安装即可\n1.首先安装 pip\n``` bash\n  $ apt-get install python-pip\n```\n2.安装 shadowsocks\n``` bash\n  $ pip install shadowsocks\n```\n\n## shadowsocks 使用\nshadowsocks 分为两部分，一个 server 名字叫 ssserver ，一个 client 名字叫 sslocal\n默认都安装在  /usr/local/bin/ 目录下\n\n### **server 端**\nserver端主要搭建在自己购买的vps上面\n如下代码可使其在后台运行：\n``` bash\n  $ sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start\n```\n具体可参见 [shadowsocks wiki](https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E)\n\n### **client 端**\nclient 端是运行在需要科学上网的机器上的\n``` bash\n  $ sslocal -s server_ip -p 443 -l 1080 -k \"passwd\" -t 600 -m aes-256-cfb &\n```\n& 是为了让其在后台运行\n查看后台运行的程序 \n``` bash\n $ jobs -l\n```\n``` bash\n[1]-  3918 Running                 hexo s &\n[2]+  4110 Stopped                 ping www.baidu.com\n```\n将后台的程序提到前端  %1   %后面的数字代表了要提到前台的任务\n``` bash\n$ %2\nping www.baidu.com\n64 bytes from 180.97.33.107: icmp_req=3 ttl=52 time=14.2 ms\n64 bytes from 180.97.33.107: icmp_req=4 ttl=52 time=12.7 ms\n```\n上述命令将 Ctrl + Z 挂起的任务，提到前台去了\nCtrl + C 是终止程序\nCtrl + Z 是挂起到后台\n\n至于浏览器端的代理插件，将代理地址配置成 127.0.0.1 端口 1080 （要与前面设置的端口一致）\n配置相应的代理规则即可科学上网\n\n至于开机自动启动，可以自己摸索\n\n\n\n\n\n","source":"_posts/shadowsocks.md","raw":"---\ntitle: linux 下使用 shadowsocks\ntags: shadowsocks\ncategory: linux\ntoc: true\nabbrlink: 43024\ndate: 2015-10-09 19:44:14\n---\n## 安装shadowsocks\nshadowsocks 是使用 python 编写的，用 python 的包管理软件 pip 安装即可\n1.首先安装 pip\n``` bash\n  $ apt-get install python-pip\n```\n2.安装 shadowsocks\n``` bash\n  $ pip install shadowsocks\n```\n\n## shadowsocks 使用\nshadowsocks 分为两部分，一个 server 名字叫 ssserver ，一个 client 名字叫 sslocal\n默认都安装在  /usr/local/bin/ 目录下\n\n### **server 端**\nserver端主要搭建在自己购买的vps上面\n如下代码可使其在后台运行：\n``` bash\n  $ sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start\n```\n具体可参见 [shadowsocks wiki](https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E)\n\n### **client 端**\nclient 端是运行在需要科学上网的机器上的\n``` bash\n  $ sslocal -s server_ip -p 443 -l 1080 -k \"passwd\" -t 600 -m aes-256-cfb &\n```\n& 是为了让其在后台运行\n查看后台运行的程序 \n``` bash\n $ jobs -l\n```\n``` bash\n[1]-  3918 Running                 hexo s &\n[2]+  4110 Stopped                 ping www.baidu.com\n```\n将后台的程序提到前端  %1   %后面的数字代表了要提到前台的任务\n``` bash\n$ %2\nping www.baidu.com\n64 bytes from 180.97.33.107: icmp_req=3 ttl=52 time=14.2 ms\n64 bytes from 180.97.33.107: icmp_req=4 ttl=52 time=12.7 ms\n```\n上述命令将 Ctrl + Z 挂起的任务，提到前台去了\nCtrl + C 是终止程序\nCtrl + Z 是挂起到后台\n\n至于浏览器端的代理插件，将代理地址配置成 127.0.0.1 端口 1080 （要与前面设置的端口一致）\n配置相应的代理规则即可科学上网\n\n至于开机自动启动，可以自己摸索\n\n\n\n\n\n","slug":"shadowsocks","published":1,"updated":"2017-04-16T12:03:23.405Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdad008ujh4k4xijr4rx","content":"<h2 id=\"安装shadowsocks\"><a href=\"#安装shadowsocks\" class=\"headerlink\" title=\"安装shadowsocks\"></a>安装shadowsocks</h2><p>shadowsocks 是使用 python 编写的，用 python 的包管理软件 pip 安装即可<br>1.首先安装 pip<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ apt-get install python-pip</span><br></pre></td></tr></table></figure></p>\n<p>2.安装 shadowsocks<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip install shadowsocks</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"shadowsocks-使用\"><a href=\"#shadowsocks-使用\" class=\"headerlink\" title=\"shadowsocks 使用\"></a>shadowsocks 使用</h2><p>shadowsocks 分为两部分，一个 server 名字叫 ssserver ，一个 client 名字叫 sslocal<br>默认都安装在  /usr/local/bin/ 目录下</p>\n<h3 id=\"server-端\"><a href=\"#server-端\" class=\"headerlink\" title=\"server 端\"></a><strong>server 端</strong></h3><p>server端主要搭建在自己购买的vps上面<br>如下代码可使其在后台运行：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start</span><br></pre></td></tr></table></figure></p>\n<p>具体可参见 <a href=\"https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">shadowsocks wiki</a></p>\n<h3 id=\"client-端\"><a href=\"#client-端\" class=\"headerlink\" title=\"client 端\"></a><strong>client 端</strong></h3><p>client 端是运行在需要科学上网的机器上的<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sslocal -s server_ip -p 443 -l 1080 -k <span class=\"string\">\"passwd\"</span> -t 600 -m aes-256-cfb &amp;</span><br></pre></td></tr></table></figure></p>\n<p>&amp; 是为了让其在后台运行<br>查看后台运行的程序<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">jobs</span> -l</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[1]-  3918 Running                 hexo s &amp;</span><br><span class=\"line\">[2]+  4110 Stopped                 ping www.baidu.com</span><br></pre></td></tr></table></figure>\n<p>将后台的程序提到前端  %1   %后面的数字代表了要提到前台的任务<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ %2</span><br><span class=\"line\">ping www.baidu.com</span><br><span class=\"line\">64 bytes from 180.97.33.107: icmp_req=3 ttl=52 time=14.2 ms</span><br><span class=\"line\">64 bytes from 180.97.33.107: icmp_req=4 ttl=52 time=12.7 ms</span><br></pre></td></tr></table></figure></p>\n<p>上述命令将 Ctrl + Z 挂起的任务，提到前台去了<br>Ctrl + C 是终止程序<br>Ctrl + Z 是挂起到后台</p>\n<p>至于浏览器端的代理插件，将代理地址配置成 127.0.0.1 端口 1080 （要与前面设置的端口一致）<br>配置相应的代理规则即可科学上网</p>\n<p>至于开机自动启动，可以自己摸索</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"安装shadowsocks\"><a href=\"#安装shadowsocks\" class=\"headerlink\" title=\"安装shadowsocks\"></a>安装shadowsocks</h2><p>shadowsocks 是使用 python 编写的，用 python 的包管理软件 pip 安装即可<br>1.首先安装 pip<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ apt-get install python-pip</span><br></pre></td></tr></table></figure></p>\n<p>2.安装 shadowsocks<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pip install shadowsocks</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"shadowsocks-使用\"><a href=\"#shadowsocks-使用\" class=\"headerlink\" title=\"shadowsocks 使用\"></a>shadowsocks 使用</h2><p>shadowsocks 分为两部分，一个 server 名字叫 ssserver ，一个 client 名字叫 sslocal<br>默认都安装在  /usr/local/bin/ 目录下</p>\n<h3 id=\"server-端\"><a href=\"#server-端\" class=\"headerlink\" title=\"server 端\"></a><strong>server 端</strong></h3><p>server端主要搭建在自己购买的vps上面<br>如下代码可使其在后台运行：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start</span><br></pre></td></tr></table></figure></p>\n<p>具体可参见 <a href=\"https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">shadowsocks wiki</a></p>\n<h3 id=\"client-端\"><a href=\"#client-端\" class=\"headerlink\" title=\"client 端\"></a><strong>client 端</strong></h3><p>client 端是运行在需要科学上网的机器上的<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sslocal -s server_ip -p 443 -l 1080 -k <span class=\"string\">\"passwd\"</span> -t 600 -m aes-256-cfb &amp;</span><br></pre></td></tr></table></figure></p>\n<p>&amp; 是为了让其在后台运行<br>查看后台运行的程序<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">jobs</span> -l</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[1]-  3918 Running                 hexo s &amp;</span><br><span class=\"line\">[2]+  4110 Stopped                 ping www.baidu.com</span><br></pre></td></tr></table></figure>\n<p>将后台的程序提到前端  %1   %后面的数字代表了要提到前台的任务<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ %2</span><br><span class=\"line\">ping www.baidu.com</span><br><span class=\"line\">64 bytes from 180.97.33.107: icmp_req=3 ttl=52 time=14.2 ms</span><br><span class=\"line\">64 bytes from 180.97.33.107: icmp_req=4 ttl=52 time=12.7 ms</span><br></pre></td></tr></table></figure></p>\n<p>上述命令将 Ctrl + Z 挂起的任务，提到前台去了<br>Ctrl + C 是终止程序<br>Ctrl + Z 是挂起到后台</p>\n<p>至于浏览器端的代理插件，将代理地址配置成 127.0.0.1 端口 1080 （要与前面设置的端口一致）<br>配置相应的代理规则即可科学上网</p>\n<p>至于开机自动启动，可以自己摸索</p>\n"},{"title":"shell命令长度限制","toc":true,"abbrlink":52389,"date":"2017-02-05T17:08:23.000Z","_content":"\n\n## 两个命令\n\n### ARG_MAX\n\n>The limit for the length of a command line is not imposed by the shell, but by the operating system. This limit is usually in the range of hundred kilobytes. POSIX denotes this limit ARG_MAX and on POSIX conformant systems you can query it with\n\n```bash\n$ getconf ARG_MAX    # Get argument limit in bytes\n```\n在我的cygwin上的结果:\n\n```\n➜  getconf ARG_MAX\n32000\n```\n\n\n### xargs --show-limits\n\n我的Cygwin上的结果\n\n```\n➜   xargs --show-limits\n您的环境变量占有 7787 个字节\n此系统的参数长度 POSIX 上限: 22165\n所有系统中所允许的最小参数长度 POSIX 上限: 4096\n我们实际能用的最大命令长度: 14378\n我们实际能用的命令缓冲区的大小: 22165\nMaximum parallelism (--max-procs must be no greater): 2147483647\n\nxargs 中的命令现在将继续执行，并且它会尝试读取输入并运行命令；如果您不想它发生，请按下“文件结束”按键(ctrl-D)。\n警告: echo 将至少运行一次。如果您不想它发生，请按下中断按键。(ctrl-C)\n```\n\n## 绕过限制\n\n使用脚本编写。\n\n## 参考\n\n1. [shell - Bash command line and input limit - Stack Overflow](http://stackoverflow.com/questions/19354870/bash-command-line-and-input-limit)\n\n2. [Maximum length of command line argument that can be passed to SQL*Plus (from Linux C Shell)? - Stack Overflow](http://stackoverflow.com/questions/6846263/maximum-length-of-command-line-argument-that-can-be-passed-to-sqlplus-from-lin)","source":"_posts/shell-input-limit.md","raw":"---\ntitle: shell命令长度限制\ntags: limit\ncategory: shell\ntoc: true\nabbrlink: 52389\ndate: 2017-02-06 01:08:23\n---\n\n\n## 两个命令\n\n### ARG_MAX\n\n>The limit for the length of a command line is not imposed by the shell, but by the operating system. This limit is usually in the range of hundred kilobytes. POSIX denotes this limit ARG_MAX and on POSIX conformant systems you can query it with\n\n```bash\n$ getconf ARG_MAX    # Get argument limit in bytes\n```\n在我的cygwin上的结果:\n\n```\n➜  getconf ARG_MAX\n32000\n```\n\n\n### xargs --show-limits\n\n我的Cygwin上的结果\n\n```\n➜   xargs --show-limits\n您的环境变量占有 7787 个字节\n此系统的参数长度 POSIX 上限: 22165\n所有系统中所允许的最小参数长度 POSIX 上限: 4096\n我们实际能用的最大命令长度: 14378\n我们实际能用的命令缓冲区的大小: 22165\nMaximum parallelism (--max-procs must be no greater): 2147483647\n\nxargs 中的命令现在将继续执行，并且它会尝试读取输入并运行命令；如果您不想它发生，请按下“文件结束”按键(ctrl-D)。\n警告: echo 将至少运行一次。如果您不想它发生，请按下中断按键。(ctrl-C)\n```\n\n## 绕过限制\n\n使用脚本编写。\n\n## 参考\n\n1. [shell - Bash command line and input limit - Stack Overflow](http://stackoverflow.com/questions/19354870/bash-command-line-and-input-limit)\n\n2. [Maximum length of command line argument that can be passed to SQL*Plus (from Linux C Shell)? - Stack Overflow](http://stackoverflow.com/questions/6846263/maximum-length-of-command-line-argument-that-can-be-passed-to-sqlplus-from-lin)","slug":"shell-input-limit","published":1,"updated":"2017-04-16T12:04:30.014Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdae008xjh4kb7zysbhs","content":"<h2 id=\"两个命令\"><a href=\"#两个命令\" class=\"headerlink\" title=\"两个命令\"></a>两个命令</h2><h3 id=\"ARG-MAX\"><a href=\"#ARG-MAX\" class=\"headerlink\" title=\"ARG_MAX\"></a>ARG_MAX</h3><blockquote>\n<p>The limit for the length of a command line is not imposed by the shell, but by the operating system. This limit is usually in the range of hundred kilobytes. POSIX denotes this limit ARG_MAX and on POSIX conformant systems you can query it with</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ getconf ARG_MAX    <span class=\"comment\"># Get argument limit in bytes</span></span><br></pre></td></tr></table></figure>\n<p>在我的cygwin上的结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  getconf ARG_MAX</span><br><span class=\"line\">32000</span><br></pre></td></tr></table></figure>\n<h3 id=\"xargs-–show-limits\"><a href=\"#xargs-–show-limits\" class=\"headerlink\" title=\"xargs –show-limits\"></a>xargs –show-limits</h3><p>我的Cygwin上的结果</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜   xargs --show-limits</span><br><span class=\"line\">您的环境变量占有 7787 个字节</span><br><span class=\"line\">此系统的参数长度 POSIX 上限: 22165</span><br><span class=\"line\">所有系统中所允许的最小参数长度 POSIX 上限: 4096</span><br><span class=\"line\">我们实际能用的最大命令长度: 14378</span><br><span class=\"line\">我们实际能用的命令缓冲区的大小: 22165</span><br><span class=\"line\">Maximum parallelism (--max-procs must be no greater): 2147483647</span><br><span class=\"line\"></span><br><span class=\"line\">xargs 中的命令现在将继续执行，并且它会尝试读取输入并运行命令；如果您不想它发生，请按下“文件结束”按键(ctrl-D)。</span><br><span class=\"line\">警告: echo 将至少运行一次。如果您不想它发生，请按下中断按键。(ctrl-C)</span><br></pre></td></tr></table></figure>\n<h2 id=\"绕过限制\"><a href=\"#绕过限制\" class=\"headerlink\" title=\"绕过限制\"></a>绕过限制</h2><p>使用脚本编写。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://stackoverflow.com/questions/19354870/bash-command-line-and-input-limit\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">shell - Bash command line and input limit - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://stackoverflow.com/questions/6846263/maximum-length-of-command-line-argument-that-can-be-passed-to-sqlplus-from-lin\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maximum length of command line argument that can be passed to SQL*Plus (from Linux C Shell)? - Stack Overflow</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"两个命令\"><a href=\"#两个命令\" class=\"headerlink\" title=\"两个命令\"></a>两个命令</h2><h3 id=\"ARG-MAX\"><a href=\"#ARG-MAX\" class=\"headerlink\" title=\"ARG_MAX\"></a>ARG_MAX</h3><blockquote>\n<p>The limit for the length of a command line is not imposed by the shell, but by the operating system. This limit is usually in the range of hundred kilobytes. POSIX denotes this limit ARG_MAX and on POSIX conformant systems you can query it with</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ getconf ARG_MAX    <span class=\"comment\"># Get argument limit in bytes</span></span><br></pre></td></tr></table></figure>\n<p>在我的cygwin上的结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  getconf ARG_MAX</span><br><span class=\"line\">32000</span><br></pre></td></tr></table></figure>\n<h3 id=\"xargs-–show-limits\"><a href=\"#xargs-–show-limits\" class=\"headerlink\" title=\"xargs –show-limits\"></a>xargs –show-limits</h3><p>我的Cygwin上的结果</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜   xargs --show-limits</span><br><span class=\"line\">您的环境变量占有 7787 个字节</span><br><span class=\"line\">此系统的参数长度 POSIX 上限: 22165</span><br><span class=\"line\">所有系统中所允许的最小参数长度 POSIX 上限: 4096</span><br><span class=\"line\">我们实际能用的最大命令长度: 14378</span><br><span class=\"line\">我们实际能用的命令缓冲区的大小: 22165</span><br><span class=\"line\">Maximum parallelism (--max-procs must be no greater): 2147483647</span><br><span class=\"line\"></span><br><span class=\"line\">xargs 中的命令现在将继续执行，并且它会尝试读取输入并运行命令；如果您不想它发生，请按下“文件结束”按键(ctrl-D)。</span><br><span class=\"line\">警告: echo 将至少运行一次。如果您不想它发生，请按下中断按键。(ctrl-C)</span><br></pre></td></tr></table></figure>\n<h2 id=\"绕过限制\"><a href=\"#绕过限制\" class=\"headerlink\" title=\"绕过限制\"></a>绕过限制</h2><p>使用脚本编写。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://stackoverflow.com/questions/19354870/bash-command-line-and-input-limit\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">shell - Bash command line and input limit - Stack Overflow</a></p>\n</li>\n<li><p><a href=\"http://stackoverflow.com/questions/6846263/maximum-length-of-command-line-argument-that-can-be-passed-to-sqlplus-from-lin\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Maximum length of command line argument that can be passed to SQL*Plus (from Linux C Shell)? - Stack Overflow</a></p>\n</li>\n</ol>\n"},{"title":"将其他日志框架桥接到slf4j","toc":true,"date":"2018-05-05T08:14:59.000Z","_content":"\n\n## SLF4J\n\njava世界的日志框架太多了, `Jakarta Commons Logging (JCL)`,  java.util.logging (jul), Log4j, Logback等等. 其中 log4j和logback是同一个作者写的, 这个作者为了统一日志的API, 又创作了SLF4J, SLF4J采用门面模式定义了日志操作的API, 但是并没有提供实现, \n具体的实现由用户引入的jar包决定, 比如Log4j或者Logback等.\n\n为了能让之前的项目, 比如一个比较古老的项目使用了 JCL, 也能使用`SLF4J`带来的好处(接口和实现分离), 就出现了桥接的需求.\n\n ![](https://www.slf4j.org/images/legacy.png)\n\n 一旦桥接到了`SLF4J`, 底层的日志实现就可以随便选了.\n\n\n ## 使用\n\n 这里拿`JCL`为例, 介绍下如何使用桥接包.\n\n1. exclude掉`JCL`对应的jar包\n2. 引入`jcl-over-slf4j`\n\n比如拿`spring mvc`为例, 他内部使用的是`JCL`作为日志实现, 我们需要做的就是:\n\n```xml\n        <!--exclude-->\n        <dependency>\n            <groupId>org.springframework</groupId>\n            <artifactId>spring-webmvc</artifactId>\n            <version>${spring.version}</version>\n            <exclusions>\n                <exclusion>\n                    <groupId>commons-logging</groupId>\n                    <artifactId>commons-logging</artifactId>\n                </exclusion>\n            </exclusions>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-api</artifactId>\n            <version>${sl4j.version}</version>\n        </dependency>\n\n        <!-- https://mvnrepository.com/artifact/org.slf4j/jcl-over-slf4j -->\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>jcl-over-slf4j</artifactId>\n            <version>1.7.25</version>\n        </dependency>     \n```\n\n## 实现原理\n\n桥接的实现原理就是不引入`JCL`等之前包的实现, 在桥接的jar包中实现一套相同的api.\n\n```\n➜  jcl-over-slf4j-1.7.25-sources  tree\n.\n├── META-INF\n│   ├── MANIFEST.MF\n│   └── services\n│       └── org.apache.commons.logging.LogFactory\n└── org\n    └── apache\n        └── commons\n            └── logging\n                ├── impl\n                │   ├── NoOpLog.java\n                │   ├── package.html\n                │   ├── SimpleLog.java\n                │   ├── SLF4JLocationAwareLog.java\n                │   ├── SLF4JLogFactory.java\n                │   └── SLF4JLog.java\n                ├── LogConfigurationException.java\n                ├── LogFactory.java\n                ├── Log.java\n                └── package.html\n```\n\n在`LogFactory`中使用的是`SLF4JLogFactory`来获取`Logger`, 最终用到的是`slf4j-api`中定义的方法.\n\n```java\n// org.apache.commons.logging.LogFactory\nstatic LogFactory logFactory = new SLF4JLogFactory();\n\n// org.apache.commons.logging.impl.SLF4JLogFactory#getInstance(java.lang.String)\n public Log getInstance(String name) throws LogConfigurationException {\n        Log instance = loggerMap.get(name);\n        if (instance != null) {\n            return instance;\n        } else {\n            Log newInstance;\n            Logger slf4jLogger = LoggerFactory.getLogger(name);\n            if (slf4jLogger instanceof LocationAwareLogger) {\n                newInstance = new SLF4JLocationAwareLog((LocationAwareLogger) slf4jLogger);\n            } else {\n                newInstance = new SLF4JLog(slf4jLogger);\n            }\n            Log oldInstance = loggerMap.putIfAbsent(name, newInstance);\n            return oldInstance == null ? newInstance : oldInstance;\n        }\n    }\n```\n \n## 参考\n\n- [Log4j Bridge](https://www.slf4j.org/legacy.html)\n- [Java 日志框架解析(上) - 历史演进](https://zhuanlan.zhihu.com/p/24272450)\n- [Java 日志框架解析(下) - 最佳实践](https://zhuanlan.zhihu.com/p/24275518)\n- [日志工具现状调研 | 网易乐得技术团队](http://tech.lede.com/2017/02/06/rd/server/log4jSearch/index.html)\n","source":"_posts/slf4j-bridge.md","raw":"title: 将其他日志框架桥接到slf4j\ntags: logback\ncategory: java\ntoc: true\ndate: 2018-05-05 16:14:59\n---\n\n\n## SLF4J\n\njava世界的日志框架太多了, `Jakarta Commons Logging (JCL)`,  java.util.logging (jul), Log4j, Logback等等. 其中 log4j和logback是同一个作者写的, 这个作者为了统一日志的API, 又创作了SLF4J, SLF4J采用门面模式定义了日志操作的API, 但是并没有提供实现, \n具体的实现由用户引入的jar包决定, 比如Log4j或者Logback等.\n\n为了能让之前的项目, 比如一个比较古老的项目使用了 JCL, 也能使用`SLF4J`带来的好处(接口和实现分离), 就出现了桥接的需求.\n\n ![](https://www.slf4j.org/images/legacy.png)\n\n 一旦桥接到了`SLF4J`, 底层的日志实现就可以随便选了.\n\n\n ## 使用\n\n 这里拿`JCL`为例, 介绍下如何使用桥接包.\n\n1. exclude掉`JCL`对应的jar包\n2. 引入`jcl-over-slf4j`\n\n比如拿`spring mvc`为例, 他内部使用的是`JCL`作为日志实现, 我们需要做的就是:\n\n```xml\n        <!--exclude-->\n        <dependency>\n            <groupId>org.springframework</groupId>\n            <artifactId>spring-webmvc</artifactId>\n            <version>${spring.version}</version>\n            <exclusions>\n                <exclusion>\n                    <groupId>commons-logging</groupId>\n                    <artifactId>commons-logging</artifactId>\n                </exclusion>\n            </exclusions>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-api</artifactId>\n            <version>${sl4j.version}</version>\n        </dependency>\n\n        <!-- https://mvnrepository.com/artifact/org.slf4j/jcl-over-slf4j -->\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>jcl-over-slf4j</artifactId>\n            <version>1.7.25</version>\n        </dependency>     \n```\n\n## 实现原理\n\n桥接的实现原理就是不引入`JCL`等之前包的实现, 在桥接的jar包中实现一套相同的api.\n\n```\n➜  jcl-over-slf4j-1.7.25-sources  tree\n.\n├── META-INF\n│   ├── MANIFEST.MF\n│   └── services\n│       └── org.apache.commons.logging.LogFactory\n└── org\n    └── apache\n        └── commons\n            └── logging\n                ├── impl\n                │   ├── NoOpLog.java\n                │   ├── package.html\n                │   ├── SimpleLog.java\n                │   ├── SLF4JLocationAwareLog.java\n                │   ├── SLF4JLogFactory.java\n                │   └── SLF4JLog.java\n                ├── LogConfigurationException.java\n                ├── LogFactory.java\n                ├── Log.java\n                └── package.html\n```\n\n在`LogFactory`中使用的是`SLF4JLogFactory`来获取`Logger`, 最终用到的是`slf4j-api`中定义的方法.\n\n```java\n// org.apache.commons.logging.LogFactory\nstatic LogFactory logFactory = new SLF4JLogFactory();\n\n// org.apache.commons.logging.impl.SLF4JLogFactory#getInstance(java.lang.String)\n public Log getInstance(String name) throws LogConfigurationException {\n        Log instance = loggerMap.get(name);\n        if (instance != null) {\n            return instance;\n        } else {\n            Log newInstance;\n            Logger slf4jLogger = LoggerFactory.getLogger(name);\n            if (slf4jLogger instanceof LocationAwareLogger) {\n                newInstance = new SLF4JLocationAwareLog((LocationAwareLogger) slf4jLogger);\n            } else {\n                newInstance = new SLF4JLog(slf4jLogger);\n            }\n            Log oldInstance = loggerMap.putIfAbsent(name, newInstance);\n            return oldInstance == null ? newInstance : oldInstance;\n        }\n    }\n```\n \n## 参考\n\n- [Log4j Bridge](https://www.slf4j.org/legacy.html)\n- [Java 日志框架解析(上) - 历史演进](https://zhuanlan.zhihu.com/p/24272450)\n- [Java 日志框架解析(下) - 最佳实践](https://zhuanlan.zhihu.com/p/24275518)\n- [日志工具现状调研 | 网易乐得技术团队](http://tech.lede.com/2017/02/06/rd/server/log4jSearch/index.html)\n","slug":"slf4j-bridge","published":1,"updated":"2018-05-05T08:14:59.812Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdaf0090jh4ksujtbip8","content":"<h2 id=\"SLF4J\"><a href=\"#SLF4J\" class=\"headerlink\" title=\"SLF4J\"></a>SLF4J</h2><p>java世界的日志框架太多了, <code>Jakarta Commons Logging (JCL)</code>,  java.util.logging (jul), Log4j, Logback等等. 其中 log4j和logback是同一个作者写的, 这个作者为了统一日志的API, 又创作了SLF4J, SLF4J采用门面模式定义了日志操作的API, 但是并没有提供实现,<br>具体的实现由用户引入的jar包决定, 比如Log4j或者Logback等.</p>\n<p>为了能让之前的项目, 比如一个比较古老的项目使用了 JCL, 也能使用<code>SLF4J</code>带来的好处(接口和实现分离), 就出现了桥接的需求.</p>\n<p> <img src=\"https://www.slf4j.org/images/legacy.png\" alt=\"\"></p>\n<p> 一旦桥接到了<code>SLF4J</code>, 底层的日志实现就可以随便选了.</p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p> 这里拿<code>JCL</code>为例, 介绍下如何使用桥接包.</p>\n<ol>\n<li>exclude掉<code>JCL</code>对应的jar包</li>\n<li>引入<code>jcl-over-slf4j</code></li>\n</ol>\n<p>比如拿<code>spring mvc</code>为例, 他内部使用的是<code>JCL</code>作为日志实现, 我们需要做的就是:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--exclude--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-webmvc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;spring.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;sl4j.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/jcl-over-slf4j --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jcl-over-slf4j<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"实现原理\"><a href=\"#实现原理\" class=\"headerlink\" title=\"实现原理\"></a>实现原理</h2><p>桥接的实现原理就是不引入<code>JCL</code>等之前包的实现, 在桥接的jar包中实现一套相同的api.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  jcl-over-slf4j-1.7.25-sources  tree</span><br><span class=\"line\">.</span><br><span class=\"line\">├── META-INF</span><br><span class=\"line\">│   ├── MANIFEST.MF</span><br><span class=\"line\">│   └── services</span><br><span class=\"line\">│       └── org.apache.commons.logging.LogFactory</span><br><span class=\"line\">└── org</span><br><span class=\"line\">    └── apache</span><br><span class=\"line\">        └── commons</span><br><span class=\"line\">            └── logging</span><br><span class=\"line\">                ├── impl</span><br><span class=\"line\">                │   ├── NoOpLog.java</span><br><span class=\"line\">                │   ├── package.html</span><br><span class=\"line\">                │   ├── SimpleLog.java</span><br><span class=\"line\">                │   ├── SLF4JLocationAwareLog.java</span><br><span class=\"line\">                │   ├── SLF4JLogFactory.java</span><br><span class=\"line\">                │   └── SLF4JLog.java</span><br><span class=\"line\">                ├── LogConfigurationException.java</span><br><span class=\"line\">                ├── LogFactory.java</span><br><span class=\"line\">                ├── Log.java</span><br><span class=\"line\">                └── package.html</span><br></pre></td></tr></table></figure>\n<p>在<code>LogFactory</code>中使用的是<code>SLF4JLogFactory</code>来获取<code>Logger</code>, 最终用到的是<code>slf4j-api</code>中定义的方法.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// org.apache.commons.logging.LogFactory</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> LogFactory logFactory = <span class=\"keyword\">new</span> SLF4JLogFactory();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// org.apache.commons.logging.impl.SLF4JLogFactory#getInstance(java.lang.String)</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">public</span> Log <span class=\"title\">getInstance</span><span class=\"params\">(String name)</span> <span class=\"keyword\">throws</span> LogConfigurationException </span>&#123;</span><br><span class=\"line\">        Log instance = loggerMap.get(name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (instance != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> instance;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Log newInstance;</span><br><span class=\"line\">            Logger slf4jLogger = LoggerFactory.getLogger(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (slf4jLogger <span class=\"keyword\">instanceof</span> LocationAwareLogger) &#123;</span><br><span class=\"line\">                newInstance = <span class=\"keyword\">new</span> SLF4JLocationAwareLog((LocationAwareLogger) slf4jLogger);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                newInstance = <span class=\"keyword\">new</span> SLF4JLog(slf4jLogger);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            Log oldInstance = loggerMap.putIfAbsent(name, newInstance);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldInstance == <span class=\"keyword\">null</span> ? newInstance : oldInstance;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://www.slf4j.org/legacy.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Log4j Bridge</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/24272450\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java 日志框架解析(上) - 历史演进</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/24275518\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java 日志框架解析(下) - 最佳实践</a></li>\n<li><a href=\"http://tech.lede.com/2017/02/06/rd/server/log4jSearch/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">日志工具现状调研 | 网易乐得技术团队</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"SLF4J\"><a href=\"#SLF4J\" class=\"headerlink\" title=\"SLF4J\"></a>SLF4J</h2><p>java世界的日志框架太多了, <code>Jakarta Commons Logging (JCL)</code>,  java.util.logging (jul), Log4j, Logback等等. 其中 log4j和logback是同一个作者写的, 这个作者为了统一日志的API, 又创作了SLF4J, SLF4J采用门面模式定义了日志操作的API, 但是并没有提供实现,<br>具体的实现由用户引入的jar包决定, 比如Log4j或者Logback等.</p>\n<p>为了能让之前的项目, 比如一个比较古老的项目使用了 JCL, 也能使用<code>SLF4J</code>带来的好处(接口和实现分离), 就出现了桥接的需求.</p>\n<p> <img src=\"https://www.slf4j.org/images/legacy.png\" alt=\"\"></p>\n<p> 一旦桥接到了<code>SLF4J</code>, 底层的日志实现就可以随便选了.</p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p> 这里拿<code>JCL</code>为例, 介绍下如何使用桥接包.</p>\n<ol>\n<li>exclude掉<code>JCL</code>对应的jar包</li>\n<li>引入<code>jcl-over-slf4j</code></li>\n</ol>\n<p>比如拿<code>spring mvc</code>为例, 他内部使用的是<code>JCL</code>作为日志实现, 我们需要做的就是:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--exclude--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-webmvc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;spring.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;sl4j.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/jcl-over-slf4j --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jcl-over-slf4j<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"实现原理\"><a href=\"#实现原理\" class=\"headerlink\" title=\"实现原理\"></a>实现原理</h2><p>桥接的实现原理就是不引入<code>JCL</code>等之前包的实现, 在桥接的jar包中实现一套相同的api.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  jcl-over-slf4j-1.7.25-sources  tree</span><br><span class=\"line\">.</span><br><span class=\"line\">├── META-INF</span><br><span class=\"line\">│   ├── MANIFEST.MF</span><br><span class=\"line\">│   └── services</span><br><span class=\"line\">│       └── org.apache.commons.logging.LogFactory</span><br><span class=\"line\">└── org</span><br><span class=\"line\">    └── apache</span><br><span class=\"line\">        └── commons</span><br><span class=\"line\">            └── logging</span><br><span class=\"line\">                ├── impl</span><br><span class=\"line\">                │   ├── NoOpLog.java</span><br><span class=\"line\">                │   ├── package.html</span><br><span class=\"line\">                │   ├── SimpleLog.java</span><br><span class=\"line\">                │   ├── SLF4JLocationAwareLog.java</span><br><span class=\"line\">                │   ├── SLF4JLogFactory.java</span><br><span class=\"line\">                │   └── SLF4JLog.java</span><br><span class=\"line\">                ├── LogConfigurationException.java</span><br><span class=\"line\">                ├── LogFactory.java</span><br><span class=\"line\">                ├── Log.java</span><br><span class=\"line\">                └── package.html</span><br></pre></td></tr></table></figure>\n<p>在<code>LogFactory</code>中使用的是<code>SLF4JLogFactory</code>来获取<code>Logger</code>, 最终用到的是<code>slf4j-api</code>中定义的方法.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// org.apache.commons.logging.LogFactory</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> LogFactory logFactory = <span class=\"keyword\">new</span> SLF4JLogFactory();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// org.apache.commons.logging.impl.SLF4JLogFactory#getInstance(java.lang.String)</span></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">public</span> Log <span class=\"title\">getInstance</span><span class=\"params\">(String name)</span> <span class=\"keyword\">throws</span> LogConfigurationException </span>&#123;</span><br><span class=\"line\">        Log instance = loggerMap.get(name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (instance != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> instance;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Log newInstance;</span><br><span class=\"line\">            Logger slf4jLogger = LoggerFactory.getLogger(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (slf4jLogger <span class=\"keyword\">instanceof</span> LocationAwareLogger) &#123;</span><br><span class=\"line\">                newInstance = <span class=\"keyword\">new</span> SLF4JLocationAwareLog((LocationAwareLogger) slf4jLogger);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                newInstance = <span class=\"keyword\">new</span> SLF4JLog(slf4jLogger);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            Log oldInstance = loggerMap.putIfAbsent(name, newInstance);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> oldInstance == <span class=\"keyword\">null</span> ? newInstance : oldInstance;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://www.slf4j.org/legacy.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Log4j Bridge</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/24272450\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java 日志框架解析(上) - 历史演进</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/24275518\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java 日志框架解析(下) - 最佳实践</a></li>\n<li><a href=\"http://tech.lede.com/2017/02/06/rd/server/log4jSearch/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">日志工具现状调研 | 网易乐得技术团队</a></li>\n</ul>\n"},{"title":"Spring占位符（property-placeholder），源码阅读","toc":true,"abbrlink":3536,"date":"2016-10-30T16:22:23.000Z","_content":"\n\n##  `<context:property-placeholder location='xxx' />`的解析过程\n\n### schema\n\n在idea中`ctrl` + `b`或者，`ctrl` + 鼠标左键点击即可打开schema具体的位置\n\n{%  asset_img   location.jpg  %}\n\n\n\n\n`sping.handlers`中内容如下:\n\n```xml\nhttp\\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler\nhttp\\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler\nhttp\\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler\nhttp\\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler\nhttp\\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler\n```\n`spring.schemas`中的内容如下：\n\n```xml\nhttp\\://www.springframework.org/schema/context/spring-context-2.5.xsd=org/springframework/context/config/spring-context-2.5.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-3.0.xsd=org/springframework/context/config/spring-context-3.0.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-3.1.xsd=org/springframework/context/config/spring-context-3.1.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-3.2.xsd=org/springframework/context/config/spring-context-3.2.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-4.0.xsd=org/springframework/context/config/spring-context-4.0.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-4.1.xsd=org/springframework/context/config/spring-context-4.1.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-4.2.xsd=org/springframework/context/config/spring-context-4.2.xsd\nhttp\\://www.springframework.org/schema/context/spring-context.xsd=org/springframework/context/config/spring-context-4.2.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-2.0.xsd=org/springframework/ejb/config/spring-jee-2.0.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-2.5.xsd=org/springframework/ejb/config/spring-jee-2.5.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-3.0.xsd=org/springframework/ejb/config/spring-jee-3.0.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-3.1.xsd=org/springframework/ejb/config/spring-jee-3.1.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-3.2.xsd=org/springframework/ejb/config/spring-jee-3.2.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-4.0.xsd=org/springframework/ejb/config/spring-jee-4.0.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-4.1.xsd=org/springframework/ejb/config/spring-jee-4.1.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-4.2.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-2.0.xsd=org/springframework/scripting/config/spring-lang-2.0.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-2.5.xsd=org/springframework/scripting/config/spring-lang-2.5.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-3.0.xsd=org/springframework/scripting/config/spring-lang-3.0.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-3.1.xsd=org/springframework/scripting/config/spring-lang-3.1.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-3.2.xsd=org/springframework/scripting/config/spring-lang-3.2.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-4.0.xsd=org/springframework/scripting/config/spring-lang-4.0.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-4.1.xsd=org/springframework/scripting/config/spring-lang-4.1.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-4.2.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-3.0.xsd=org/springframework/scheduling/config/spring-task-3.0.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-3.1.xsd=org/springframework/scheduling/config/spring-task-3.1.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-3.2.xsd=org/springframework/scheduling/config/spring-task-3.2.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-4.0.xsd=org/springframework/scheduling/config/spring-task-4.0.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-4.1.xsd=org/springframework/scheduling/config/spring-task-4.1.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-4.2.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd\nhttp\\://www.springframework.org/schema/task/spring-task.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-3.1.xsd=org/springframework/cache/config/spring-cache-3.1.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-3.2.xsd=org/springframework/cache/config/spring-cache-3.2.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-4.0.xsd=org/springframework/cache/config/spring-cache-4.0.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-4.1.xsd=org/springframework/cache/config/spring-cache-4.1.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-4.2.xsd=org/springframework/cache/config/spring-cache-4.2.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache.xsd=org/springframework/cache/config/spring-cache-4.2.xsd\n```\n### NamespaceHandlerSupport\n\n从`handler`中我们可以找出`context`标签的处理类是`org.springframework.context.config.ContextNamespaceHandler`,内容如下：\n\n```java\npublic class ContextNamespaceHandler extends NamespaceHandlerSupport {\n\n\t@Override\n\tpublic void init() {\n\t\tregisterBeanDefinitionParser(\"property-placeholder\", new PropertyPlaceholderBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"property-override\", new PropertyOverrideBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"annotation-config\", new AnnotationConfigBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"component-scan\", new ComponentScanBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"load-time-weaver\", new LoadTimeWeaverBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"spring-configured\", new SpringConfiguredBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-export\", new MBeanExportBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-server\", new MBeanServerBeanDefinitionParser());\n\t}\n}\n```\n顺藤摸瓜就能找到`property-placeholder`的处理类是`PropertyPlaceholderBeanDefinitionParser`\n\n### PropertyPlaceholderBeanDefinitionParser\n\n继承关系：\n\n{%  asset_img   hierarchy.jpg  %}\n\n\n\n\n```java\nclass PropertyPlaceholderBeanDefinitionParser extends AbstractPropertyLoadingBeanDefinitionParser {\n\n\tprivate static final String SYSTEM_PROPERTIES_MODE_ATTRIBUTE = \"system-properties-mode\";\n\n\tprivate static final String SYSTEM_PROPERTIES_MODE_DEFAULT = \"ENVIRONMENT\";\n\n\n\t@Override\n\tprotected Class<?> getBeanClass(Element element) {\n\t\t// As of Spring 3.1, the default value of system-properties-mode has changed from\n\t\t// 'FALLBACK' to 'ENVIRONMENT'. This latter value indicates that resolution of\n\t\t// placeholders against system properties is a function of the Environment and\n\t\t// its current set of PropertySources.\n\t\tif (SYSTEM_PROPERTIES_MODE_DEFAULT.equals(element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE))) {\n\t\t\treturn PropertySourcesPlaceholderConfigurer.class;\n\t\t}\n\n\t\t// The user has explicitly specified a value for system-properties-mode: revert to\n\t\t// PropertyPlaceholderConfigurer to ensure backward compatibility with 3.0 and earlier.\n\t\treturn PropertyPlaceholderConfigurer.class;\n\t}\n\n\t@Override\n\tprotected void doParse(Element element, BeanDefinitionBuilder builder) {\n\t\tsuper.doParse(element, builder);\n\n\t\tbuilder.addPropertyValue(\"ignoreUnresolvablePlaceholders\",\n\t\t\t\tBoolean.valueOf(element.getAttribute(\"ignore-unresolvable\")));\n\n\t\tString systemPropertiesModeName = element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE);\n\t\tif (StringUtils.hasLength(systemPropertiesModeName) &&\n\t\t\t\t!systemPropertiesModeName.equals(SYSTEM_PROPERTIES_MODE_DEFAULT)) {\n\t\t\tbuilder.addPropertyValue(\"systemPropertiesModeName\", \"SYSTEM_PROPERTIES_MODE_\" + systemPropertiesModeName);\n\t\t}\n\n\t\tif (element.hasAttribute(\"value-separator\")) {    \n\t\t\tbuilder.addPropertyValue(\"valueSeparator\", element.getAttribute(\"value-separator\"));\n\t\t}\n\n\t\tif (element.hasAttribute(\"null-value\")) {\n\t\t\tbuilder.addPropertyValue(\"nullValue\", element.getAttribute(\"null-value\"));\n\t\t}\n\t}\n\n}\n```\n在`getBeanClass`中，根据标签中的`system-properties-mode`属性来返回不同的类，来指明要实例化的类。\n\n再来看上述的`parse`方法，首先就是调用父类的`doParse`方法，然后就是解析标签中的相应属性，放到`BeanDefinitionBuilder`中，剩下的工作就交给spring这个框架来完成了。\n\n#### `system-properties-mode`\n\n决定解析placeholder的顺序。这个属性的取值如下：\n\n>\t**\"ENVIRONMENT\"** indicates placeholders should be resolved against the current Environment and against any local properties;\n\n>\t**\"NEVER\"** indicates placeholders should be resolved only against local properties and never against system properties;\n\n>\t**\"FALLBACK\"** indicates placeholders should be resolved against any local properties and then against system properties;\n\n>\t**\"OVERRIDE\"** indicates placeholders should be resolved first against system properties and then against any local properties;\n\n这个属性的默认值是`ENVIRONMENT`,也就是先从环境变量中解析，然后才从我们定义的properties文件中解析，如果环境中的变量名和配置文件中的变量名冲突，\n\n就会使用环境变量中的。\n\n>所以配置文件中的变量名最好带一个前缀，如`jdbc.username=`, 笔者在Ubuntu下就遇到过不带前缀的`username`和系统的'username'冲突的情况\n\n#### `ignore-unresolvable`\n\n>\tSpecifies if failure to find the property value to replace a key should be ignored.\n\tDefault is \"false\", meaning that this placeholder configurer will raise an exception\n\tif it cannot resolve a key. Set to \"true\" to allow the configurer to pass on the key\n\tto any others in the context that have not yet visited the key in question.\n\n这个属性很关键，他决定遇到无法解析的变量时是否抛出异常，默认是`fale`（抛出异常）,在有多个配置文件的时候应该设置为`true`。\n\n#### `value-separator`\n\nplaceHolder默认值得分隔符，默认是`:`\n\n> The separating character between the placeholder variable and the associated \tdefault value: by default, a ':' symbol.\n\n#### `null-value`\n\n>\tA value that should be treated as 'null' when resolved as a placeholder value:\n\te.g. \"\" (empty String) or \"null\". By default, no such null value is defined.\n\n**这些属性都可以在相应的`xsd`schema中找到。**\n\n\n### AbstractPropertyLoadingBeanDefinitionParser\n\n这是上面的那个解析类的父类。\n\n```java\nabstract class AbstractPropertyLoadingBeanDefinitionParser extends AbstractSingleBeanDefinitionParser {\n\n\t@Override\n\tprotected boolean shouldGenerateId() {\n\t\treturn true;\n\t}\n\n\t@Override\n\tprotected void doParse(Element element, BeanDefinitionBuilder builder) {\n\t\tString location = element.getAttribute(\"location\");\n\t\tif (StringUtils.hasLength(location)) {\n\t\t\tString[] locations = StringUtils.commaDelimitedListToStringArray(location);\n\t\t\tbuilder.addPropertyValue(\"locations\", locations);\n\t\t}\n\n\t\tString propertiesRef = element.getAttribute(\"properties-ref\");\n\t\tif (StringUtils.hasLength(propertiesRef)) {\n\t\t\tbuilder.addPropertyReference(\"properties\", propertiesRef);\n\t\t}\n\n\t\tString fileEncoding = element.getAttribute(\"file-encoding\");\n\t\tif (StringUtils.hasLength(fileEncoding)) {\n\t\t\tbuilder.addPropertyValue(\"fileEncoding\", fileEncoding);\n\t\t}\n\n\t\tString order = element.getAttribute(\"order\");\n\t\tif (StringUtils.hasLength(order)) {\n\t\t\tbuilder.addPropertyValue(\"order\", Integer.valueOf(order));\n\t\t}\n\n\t\tbuilder.addPropertyValue(\"ignoreResourceNotFound\",\n\t\t\t\tBoolean.valueOf(element.getAttribute(\"ignore-resource-not-found\")));\n\n\t\tbuilder.addPropertyValue(\"localOverride\",\n\t\t\t\tBoolean.valueOf(element.getAttribute(\"local-override\")));\n\n\t\tbuilder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n\t}\n\n}\n\n```\n\n#### shouldGenerateId\n\n```java\n/**\n * Should an ID be generated instead of read from the passed in {@link Element}?\n * <p>Disabled by default; subclasses can override this to enable ID generation.\n * Note that this flag is about <i>always</i> generating an ID; the parser\n * won't even check for an \"id\" attribute in this case.\n * @return whether the parser should always generate an id\n */\nprotected boolean shouldGenerateId() {\n  return false;\n}\n```\n\n#### doParse\n\n这个方法负责解析配置文件的location、file-encoding等通用的属性，并放置到`builder`中。\n\n## Spring 调用handler的过程\n\nspring将特定的标签的解析委托给我们自己定义的handler的过程主要是在`DefaultBeanDefinitionDocumentReader`中\n```java\n/**\n\t * Parse the elements at the root level in the document:\n\t * \"import\", \"alias\", \"bean\".\n\t * @param root the DOM root element of the document\n\t */\n\tprotected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) {\n\t\tif (delegate.isDefaultNamespace(root)) {\n\t\t\tNodeList nl = root.getChildNodes();\n\t\t\tfor (int i = 0; i < nl.getLength(); i++) {\n\t\t\t\tNode node = nl.item(i);\n\t\t\t\tif (node instanceof Element) {\n\t\t\t\t\tElement ele = (Element) node;\n\t\t\t\t\tif (delegate.isDefaultNamespace(ele)) {\n\t\t\t\t\t\tparseDefaultElement(ele, delegate);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdelegate.parseCustomElement(ele);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tdelegate.parseCustomElement(root);\n\t\t}\n\t}\n```\n`context`不是默认命名空间的标签，所以走`parseCustomElement`分支。\n\n走到`BeanDefinitionParserDelegate`的`parseCustomElement`方法中\n```java\npublic BeanDefinition parseCustomElement(Element ele) {\n\t\treturn parseCustomElement(ele, null);\n\t}\n\n\tpublic BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd) {\n\t\tString namespaceUri = getNamespaceURI(ele);\n\t\tNamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);\n\t\tif (handler == null) {\n\t\t\terror(\"Unable to locate Spring NamespaceHandler for XML schema namespace [\" + namespaceUri + \"]\", ele);\n\t\t\treturn null;\n\t\t}\n\t\treturn handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));\n\t}\n```\n\n这里从`NamespaceHandlerResolver`中根据`namespaceUri`获取到对应的`NamespaceHandler`,然后调用`handler`的`parse`\n方法进行解析，返回一个`BeanDefinition`，然后就注册到spring中了。\n\n这里的handler就是前面我们看到的实现了`NamespaceHandlerSupport `的那个`ContextNamespaceHandler`,`NamespaceHandlerSupport `继承自`NamespaceHandler`,它的parse 方法如下：\n\n```java\n/**\n\t * Parses the supplied {@link Element} by delegating to the {@link BeanDefinitionParser} that is\n\t * registered for that {@link Element}.\n\t */\n\t@Override\n\tpublic BeanDefinition parse(Element element, ParserContext parserContext) {\n\t\treturn findParserForElement(element, parserContext).parse(element, parserContext);\n\t}\n\n\t/**\n\t * Locates the {@link BeanDefinitionParser} from the register implementations using\n\t * the local name of the supplied {@link Element}.\n\t */\n\tprivate BeanDefinitionParser findParserForElement(Element element, ParserContext parserContext) {\n\t\tString localName = parserContext.getDelegate().getLocalName(element);\n\t\tBeanDefinitionParser parser = this.parsers.get(localName);\n\t\tif (parser == null) {\n\t\t\tparserContext.getReaderContext().fatal(\n\t\t\t\t\t\"Cannot locate BeanDefinitionParser for element [\" + localName + \"]\", element);\n\t\t}\n\t\treturn parser;\n\t}\n\n```\n就是从在`init()`方法中注册的`Parser`,根据对应的标签前缀，获取到parser，对xml元素进行解析。\n\n\n## 生效过程\n\n生效过程是在`BeanFactoryPostProcessor`被调用的过程中生效的, 继承关系\n\n{%  asset_img   post-processors.jpg  %}\n\n\n\n\n可以看到里面有两个熟悉的类——`PropertySourcesPlaceholderConfigurer`和`PropertyPlaceholderConfigurer`，正是`PropertyPlaceholderBeanDefinitionParser.getBeanClass`返回的两种类型, 也就是说他们两个是`BeanFactoryPostProcessor`.\n\n\n### PropertySourcesPlaceholderConfigurer\n```java\n/**\n\t * {@inheritDoc}\n\t * <p>Processing occurs by replacing ${...} placeholders in bean definitions by resolving each\n\t * against this configurer's set of {@link PropertySources}, which includes:\n\t * <ul>\n\t * <li>all {@linkplain org.springframework.core.env.ConfigurableEnvironment#getPropertySources\n\t * environment property sources}, if an {@code Environment} {@linkplain #setEnvironment is present}\n\t * <li>{@linkplain #mergeProperties merged local properties}, if {@linkplain #setLocation any}\n\t * {@linkplain #setLocations have} {@linkplain #setProperties been}\n\t * {@linkplain #setPropertiesArray specified}\n\t * <li>any property sources set by calling {@link #setPropertySources}\n\t * </ul>\n\t * <p>If {@link #setPropertySources} is called, <strong>environment and local properties will be\n\t * ignored</strong>. This method is designed to give the user fine-grained control over property\n\t * sources, and once set, the configurer makes no assumptions about adding additional sources.\n\t */\n\t@Override\n\tpublic void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {\n\t\tif (this.propertySources == null) {\n\t\t\tthis.propertySources = new MutablePropertySources();\n\t\t\tif (this.environment != null) {\n\t\t\t\tthis.propertySources.addLast(\n\t\t\t\t\tnew PropertySource<Environment>(ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME, this.environment) {\n\t\t\t\t\t\t@Override\n\t\t\t\t\t\tpublic String getProperty(String key) {\n\t\t\t\t\t\t\treturn this.source.getProperty(key);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tPropertySource<?> localPropertySource =\n\t\t\t\t\t\tnew PropertiesPropertySource(LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME, mergeProperties());\n\t\t\t\tif (this.localOverride) {\n\t\t\t\t\tthis.propertySources.addFirst(localPropertySource);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.propertySources.addLast(localPropertySource);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch (IOException ex) {\n\t\t\t\tthrow new BeanInitializationException(\"Could not load properties\", ex);\n\t\t\t}\n\t\t}\n\n\t\tprocessProperties(beanFactory, new PropertySourcesPropertyResolver(this.propertySources));\n\t\tthis.appliedPropertySources = this.propertySources;\n\t}\n\n```\n\n注意上述的`localOverride`变量，它决定了是否用本地的替换系统的，主要是用加载的顺序呢控制的\n\n```java\n/**\n* <p>Any local properties (e.g. those added via {@link #setProperties}, {@link #setLocations}\n* et al.) are added as a {@code PropertySource}. Search precedence of local properties is\n* based on the value of the {@link #setLocalOverride localOverride} property, which is by\n* default {@code false} meaning that local properties are to be searched last, after all\n* environment property sources.\n*/\n```\n获取到所有的属性列表后，处理属性就交给了`processProperties`这个方法.\n\n```java\n/**\n\t * Visit each bean definition in the given bean factory and attempt to replace ${...} property\n\t * placeholders with values from the given properties.\n\t */\n\tprotected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess,\n\t\t\tfinal ConfigurablePropertyResolver propertyResolver) throws BeansException {\n\n\t\tpropertyResolver.setPlaceholderPrefix(this.placeholderPrefix);\n\t\tpropertyResolver.setPlaceholderSuffix(this.placeholderSuffix);\n\t\tpropertyResolver.setValueSeparator(this.valueSeparator);\n\n\t\tStringValueResolver valueResolver = new StringValueResolver() {\n\t\t\t@Override\n\t\t\tpublic String resolveStringValue(String strVal) {\n\t\t\t\tString resolved = ignoreUnresolvablePlaceholders ?\n\t\t\t\t\t\tpropertyResolver.resolvePlaceholders(strVal) :\n\t\t\t\t\t\tpropertyResolver.resolveRequiredPlaceholders(strVal);\n\t\t\t\treturn (resolved.equals(nullValue) ? null : resolved);\n\t\t\t}\n\t\t};\n\n\t\tdoProcessProperties(beanFactoryToProcess, valueResolver);\n\t}\n```\n\n先设置propertyResolver的prefix（默认是${}）和suffix(默认是})，以及默认值得分隔符(默认是:).\n\n然后创建了一个StringValueResolver, 这里根据`ignoreUnresolvablePlaceholders`的值来进行不同的解析，\n\n这个值默认是false, 但是可以在标签中配置。\n\n```xml\n<xsd:attribute name=\"ignore-unresolvable\" type=\"xsd:boolean\" default=\"false\">\n\t\t\t<xsd:annotation>\n\t\t\t\t<xsd:documentation><![CDATA[\n\tSpecifies if failure to find the property value to replace a key should be ignored.\n\tDefault is \"false\", meaning that this placeholder configurer will raise an exception\n\tif it cannot resolve a key. Set to \"true\" to allow the configurer to pass on the key\n\tto any others in the context that have not yet visited the key in question.\n\t\t\t\t]]></xsd:documentation>\n\t\t\t</xsd:annotation>\n\t\t</xsd:attribute>\n```\n\n`false`就以为者遇到无法解析的值就会直接抛出异常\n\n接下来看看`doProcessProperties`\n\n```java\nprotected void doProcessProperties(ConfigurableListableBeanFactory beanFactoryToProcess,\n\t\tStringValueResolver valueResolver) {\n\n\tBeanDefinitionVisitor visitor = new BeanDefinitionVisitor(valueResolver);\n\n\tString[] beanNames = beanFactoryToProcess.getBeanDefinitionNames();\n\tfor (String curName : beanNames) {\n\t\t// Check that we're not parsing our own bean definition,\n\t\t// to avoid failing on unresolvable placeholders in properties file locations.\n\t\tif (!(curName.equals(this.beanName) && beanFactoryToProcess.equals(this.beanFactory))) {\n\t\t\tBeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName);\n\t\t\ttry {\n\t\t\t\tvisitor.visitBeanDefinition(bd);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tthrow new BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex);\n\t\t\t}\n\t\t}\n\t}\n\n\t// New in Spring 2.5: resolve placeholders in alias target names and aliases as well.\n\tbeanFactoryToProcess.resolveAliases(valueResolver);\n\n\t// New in Spring 3.0: resolve placeholders in embedded values such as annotation attributes.\n\tbeanFactoryToProcess.addEmbeddedValueResolver(valueResolver);\n}\n```\n这里采用的是visitor模式，查看`BeanDefinitionVisitor#visitBeanDefinition`\n\n```java\n/**\n\t * Traverse the given BeanDefinition object and the MutablePropertyValues\n\t * and ConstructorArgumentValues contained in them.\n\t * @param beanDefinition the BeanDefinition object to traverse\n\t * @see #resolveStringValue(String)\n\t */\n\tpublic void visitBeanDefinition(BeanDefinition beanDefinition) {\n\t\tvisitParentName(beanDefinition);\n\t\tvisitBeanClassName(beanDefinition);\n\t\tvisitFactoryBeanName(beanDefinition);\n\t\tvisitFactoryMethodName(beanDefinition);\n\t\tvisitScope(beanDefinition);\n\t\tvisitPropertyValues(beanDefinition.getPropertyValues());\n\t\tConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues();\n\t\tvisitIndexedArgumentValues(cas.getIndexedArgumentValues());\n\t\tvisitGenericArgumentValues(cas.getGenericArgumentValues());\n\t}\n```\n以其中的`visitParentName`为例：\n```java\nprotected void visitParentName(BeanDefinition beanDefinition) {\n\tString parentName = beanDefinition.getParentName();\n\tif (parentName != null) {\n\t\tString resolvedName = resolveStringValue(parentName);\n\t\tif (!parentName.equals(resolvedName)) {\n\t\t\tbeanDefinition.setParentName(resolvedName);\n\t\t}\n\t}\n}\n\n```\n就是先获取`parentName`，然后替换相应的属性之后的`resolvedName`,如果和原来的不一样就设置`resolvedName`\n\n为新的parentName\n\n```java\n/**\n * Resolve the given String value, for example parsing placeholders.\n * @param strVal the original String value\n * @return the resolved String value\n */\nprotected String resolveStringValue(String strVal) {\n\tif (this.valueResolver == null) {\n\t\tthrow new IllegalStateException(\"No StringValueResolver specified - pass a resolver \" +\n\t\t\t\t\"object into the constructor or override the 'resolveStringValue' method\");\n\t}\n\tString resolvedValue = this.valueResolver.resolveStringValue(strVal);\n\t// Return original String if not modified.\n\treturn (strVal.equals(resolvedValue) ? strVal : resolvedValue);\n}\n```\n\n顺藤摸瓜,看看`valueResolver`,就是之前的`StringValueResolver`\n\n这是一个接口只有一个方法\n\n```java\npublic interface StringValueResolver {\n\n\t/**\n\t * Resolve the given String value, for example parsing placeholders.\n\t * @param strVal the original String value\n\t * @return the resolved String value\n\t */\n\tString resolveStringValue(String strVal);\n\n}\n```\n\n之前传入的其实就是对应`ConfigurablePropertyResolver`的两个方法, 之前传入的是它的子类\n\n`PropertySourcesPropertyResolver`\n\n```java\n@Override\n\tpublic String resolvePlaceholders(String text) {\n\t\tif (this.nonStrictHelper == null) {\n\t\t\tthis.nonStrictHelper = createPlaceholderHelper(true);\n\t\t}\n\t\treturn doResolvePlaceholders(text, this.nonStrictHelper);\n\t}\n\n\t@Override\n\tpublic String resolveRequiredPlaceholders(String text) throws IllegalArgumentException {\n\t\tif (this.strictHelper == null) {\n\t\t\tthis.strictHelper = createPlaceholderHelper(false);\n\t\t}\n\t\treturn doResolvePlaceholders(text, this.strictHelper);\n\t}\n```\n\n调用的是内部方法:\n\n```java\nprivate String doResolvePlaceholders(String text, PropertyPlaceholderHelper helper) {\n\treturn helper.replacePlaceholders(text, new PropertyPlaceholderHelper.PlaceholderResolver() {\n\t\t@Override\n\t\tpublic String resolvePlaceholder(String placeholderName) {\n\t\t\treturn getPropertyAsRawString(placeholderName);\n\t\t}\n\t});\n}\n\n```\n\n最终调用功能的是`PropertyPlaceholderHelper`的replacePlaceholders方法，\n\n这个helper在构造是通过 `createPlaceholderHelper`方法构建的，他接受一个bool类型的参数\n\n```java\nprivate PropertyPlaceholderHelper createPlaceholderHelper(boolean ignoreUnresolvablePlaceholders) {\n\treturn new PropertyPlaceholderHelper(this.placeholderPrefix, this.placeholderSuffix,\n\t\t\tthis.valueSeparator, ignoreUnresolvablePlaceholders);\n}\n```\n\n这个bool值就是表示是否要ignore掉不能解析的属性。\n\n```java\n/**\n\t * Creates a new {@code PropertyPlaceholderHelper} that uses the supplied prefix and suffix.\n\t * @param placeholderPrefix the prefix that denotes the start of a placeholder\n\t * @param placeholderSuffix the suffix that denotes the end of a placeholder\n\t * @param valueSeparator the separating character between the placeholder variable\n\t * and the associated default value, if any\n\t * @param ignoreUnresolvablePlaceholders indicates whether unresolvable placeholders should\n\t * be ignored ({@code true}) or cause an exception ({@code false})\n\t */\n```\n接着追\n\n```java\n/**\n * Replaces all placeholders of format {@code ${name}} with the value returned\n * from the supplied {@link PlaceholderResolver}.\n * @param value the value containing the placeholders to be replaced\n * @param placeholderResolver the {@code PlaceholderResolver} to use for replacement\n * @return the supplied value with placeholders replaced inline\n */\npublic String replacePlaceholders(String value, PlaceholderResolver placeholderResolver) {\n\tAssert.notNull(value, \"'value' must not be null\");\n\treturn parseStringValue(value, placeholderResolver, new HashSet<String>());\n}\n\nprotected String parseStringValue(\n\t\t\tString strVal, PlaceholderResolver placeholderResolver, Set<String> visitedPlaceholders) {\n\n\t\tStringBuilder result = new StringBuilder(strVal);\n\n\t\tint startIndex = strVal.indexOf(this.placeholderPrefix);\n\t\twhile (startIndex != -1) {\n\t\t\tint endIndex = findPlaceholderEndIndex(result, startIndex);\n\t\t\tif (endIndex != -1) {\n\t\t\t\tString placeholder = result.substring(startIndex + this.placeholderPrefix.length(), endIndex);\n\t\t\t\tString originalPlaceholder = placeholder;\n\t\t\t\tif (!visitedPlaceholders.add(originalPlaceholder)) {\n\t\t\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\t\t\"Circular placeholder reference '\" + originalPlaceholder + \"' in property definitions\");\n\t\t\t\t}\n\t\t\t\t// Recursive invocation, parsing placeholders contained in the placeholder key.\n\t\t\t\tplaceholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);\n\t\t\t\t// Now obtain the value for the fully resolved key...\n\t\t\t\tString propVal = placeholderResolver.resolvePlaceholder(placeholder);\n\t\t\t\tif (propVal == null && this.valueSeparator != null) {\n\t\t\t\t\tint separatorIndex = placeholder.indexOf(this.valueSeparator);\n\t\t\t\t\tif (separatorIndex != -1) {\n\t\t\t\t\t\tString actualPlaceholder = placeholder.substring(0, separatorIndex);\n\t\t\t\t\t\tString defaultValue = placeholder.substring(separatorIndex + this.valueSeparator.length());\n\t\t\t\t\t\tpropVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);\n\t\t\t\t\t\tif (propVal == null) {\n\t\t\t\t\t\t\tpropVal = defaultValue;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (propVal != null) {\n\t\t\t\t\t// Recursive invocation, parsing placeholders contained in the\n\t\t\t\t\t// previously resolved placeholder value.\n\t\t\t\t\tpropVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);\n\t\t\t\t\tresult.replace(startIndex, endIndex + this.placeholderSuffix.length(), propVal);\n\t\t\t\t\tif (logger.isTraceEnabled()) {\n\t\t\t\t\t\tlogger.trace(\"Resolved placeholder '\" + placeholder + \"'\");\n\t\t\t\t\t}\n\t\t\t\t\tstartIndex = result.indexOf(this.placeholderPrefix, startIndex + propVal.length());\n\t\t\t\t}\n\t\t\t\telse if (this.ignoreUnresolvablePlaceholders) {\n\t\t\t\t\t// Proceed with unprocessed value.\n\t\t\t\t\tstartIndex = result.indexOf(this.placeholderPrefix, endIndex + this.placeholderSuffix.length());\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthrow new IllegalArgumentException(\"Could not resolve placeholder '\" +\n\t\t\t\t\t\t\tplaceholder + \"'\" + \" in string value \\\"\" + strVal + \"\\\"\");\n\t\t\t\t}\n\t\t\t\tvisitedPlaceholders.remove(originalPlaceholder);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstartIndex = -1;\n\t\t\t}\n\t\t}\n\n\t\treturn result.toString();\n\t}\n\n```\n\n实际解析的代码都在这里：\n\n1. 取出placeHolder的名称.\n2. 判断有没有循环引用的情况.\n3. 递归替换，获取对应的值.\n4. 如果值为空，解析默认值.\n\n\n### PropertyPlaceholderConfigurer\n\n应该和上面的类似，抽时间补。\n","source":"_posts/property-placeholder.md","raw":"---\ntitle: Spring占位符（property-placeholder），源码阅读\ntags: placeholder\ncategory: spring\ntoc: true\nabbrlink: 3536\ndate: 2016-10-31 00:22:23\n---\n\n\n##  `<context:property-placeholder location='xxx' />`的解析过程\n\n### schema\n\n在idea中`ctrl` + `b`或者，`ctrl` + 鼠标左键点击即可打开schema具体的位置\n\n{%  asset_img   location.jpg  %}\n\n\n\n\n`sping.handlers`中内容如下:\n\n```xml\nhttp\\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler\nhttp\\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler\nhttp\\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler\nhttp\\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler\nhttp\\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler\n```\n`spring.schemas`中的内容如下：\n\n```xml\nhttp\\://www.springframework.org/schema/context/spring-context-2.5.xsd=org/springframework/context/config/spring-context-2.5.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-3.0.xsd=org/springframework/context/config/spring-context-3.0.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-3.1.xsd=org/springframework/context/config/spring-context-3.1.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-3.2.xsd=org/springframework/context/config/spring-context-3.2.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-4.0.xsd=org/springframework/context/config/spring-context-4.0.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-4.1.xsd=org/springframework/context/config/spring-context-4.1.xsd\nhttp\\://www.springframework.org/schema/context/spring-context-4.2.xsd=org/springframework/context/config/spring-context-4.2.xsd\nhttp\\://www.springframework.org/schema/context/spring-context.xsd=org/springframework/context/config/spring-context-4.2.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-2.0.xsd=org/springframework/ejb/config/spring-jee-2.0.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-2.5.xsd=org/springframework/ejb/config/spring-jee-2.5.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-3.0.xsd=org/springframework/ejb/config/spring-jee-3.0.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-3.1.xsd=org/springframework/ejb/config/spring-jee-3.1.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-3.2.xsd=org/springframework/ejb/config/spring-jee-3.2.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-4.0.xsd=org/springframework/ejb/config/spring-jee-4.0.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-4.1.xsd=org/springframework/ejb/config/spring-jee-4.1.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee-4.2.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd\nhttp\\://www.springframework.org/schema/jee/spring-jee.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-2.0.xsd=org/springframework/scripting/config/spring-lang-2.0.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-2.5.xsd=org/springframework/scripting/config/spring-lang-2.5.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-3.0.xsd=org/springframework/scripting/config/spring-lang-3.0.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-3.1.xsd=org/springframework/scripting/config/spring-lang-3.1.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-3.2.xsd=org/springframework/scripting/config/spring-lang-3.2.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-4.0.xsd=org/springframework/scripting/config/spring-lang-4.0.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-4.1.xsd=org/springframework/scripting/config/spring-lang-4.1.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang-4.2.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd\nhttp\\://www.springframework.org/schema/lang/spring-lang.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-3.0.xsd=org/springframework/scheduling/config/spring-task-3.0.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-3.1.xsd=org/springframework/scheduling/config/spring-task-3.1.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-3.2.xsd=org/springframework/scheduling/config/spring-task-3.2.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-4.0.xsd=org/springframework/scheduling/config/spring-task-4.0.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-4.1.xsd=org/springframework/scheduling/config/spring-task-4.1.xsd\nhttp\\://www.springframework.org/schema/task/spring-task-4.2.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd\nhttp\\://www.springframework.org/schema/task/spring-task.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-3.1.xsd=org/springframework/cache/config/spring-cache-3.1.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-3.2.xsd=org/springframework/cache/config/spring-cache-3.2.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-4.0.xsd=org/springframework/cache/config/spring-cache-4.0.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-4.1.xsd=org/springframework/cache/config/spring-cache-4.1.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache-4.2.xsd=org/springframework/cache/config/spring-cache-4.2.xsd\nhttp\\://www.springframework.org/schema/cache/spring-cache.xsd=org/springframework/cache/config/spring-cache-4.2.xsd\n```\n### NamespaceHandlerSupport\n\n从`handler`中我们可以找出`context`标签的处理类是`org.springframework.context.config.ContextNamespaceHandler`,内容如下：\n\n```java\npublic class ContextNamespaceHandler extends NamespaceHandlerSupport {\n\n\t@Override\n\tpublic void init() {\n\t\tregisterBeanDefinitionParser(\"property-placeholder\", new PropertyPlaceholderBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"property-override\", new PropertyOverrideBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"annotation-config\", new AnnotationConfigBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"component-scan\", new ComponentScanBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"load-time-weaver\", new LoadTimeWeaverBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"spring-configured\", new SpringConfiguredBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-export\", new MBeanExportBeanDefinitionParser());\n\t\tregisterBeanDefinitionParser(\"mbean-server\", new MBeanServerBeanDefinitionParser());\n\t}\n}\n```\n顺藤摸瓜就能找到`property-placeholder`的处理类是`PropertyPlaceholderBeanDefinitionParser`\n\n### PropertyPlaceholderBeanDefinitionParser\n\n继承关系：\n\n{%  asset_img   hierarchy.jpg  %}\n\n\n\n\n```java\nclass PropertyPlaceholderBeanDefinitionParser extends AbstractPropertyLoadingBeanDefinitionParser {\n\n\tprivate static final String SYSTEM_PROPERTIES_MODE_ATTRIBUTE = \"system-properties-mode\";\n\n\tprivate static final String SYSTEM_PROPERTIES_MODE_DEFAULT = \"ENVIRONMENT\";\n\n\n\t@Override\n\tprotected Class<?> getBeanClass(Element element) {\n\t\t// As of Spring 3.1, the default value of system-properties-mode has changed from\n\t\t// 'FALLBACK' to 'ENVIRONMENT'. This latter value indicates that resolution of\n\t\t// placeholders against system properties is a function of the Environment and\n\t\t// its current set of PropertySources.\n\t\tif (SYSTEM_PROPERTIES_MODE_DEFAULT.equals(element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE))) {\n\t\t\treturn PropertySourcesPlaceholderConfigurer.class;\n\t\t}\n\n\t\t// The user has explicitly specified a value for system-properties-mode: revert to\n\t\t// PropertyPlaceholderConfigurer to ensure backward compatibility with 3.0 and earlier.\n\t\treturn PropertyPlaceholderConfigurer.class;\n\t}\n\n\t@Override\n\tprotected void doParse(Element element, BeanDefinitionBuilder builder) {\n\t\tsuper.doParse(element, builder);\n\n\t\tbuilder.addPropertyValue(\"ignoreUnresolvablePlaceholders\",\n\t\t\t\tBoolean.valueOf(element.getAttribute(\"ignore-unresolvable\")));\n\n\t\tString systemPropertiesModeName = element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE);\n\t\tif (StringUtils.hasLength(systemPropertiesModeName) &&\n\t\t\t\t!systemPropertiesModeName.equals(SYSTEM_PROPERTIES_MODE_DEFAULT)) {\n\t\t\tbuilder.addPropertyValue(\"systemPropertiesModeName\", \"SYSTEM_PROPERTIES_MODE_\" + systemPropertiesModeName);\n\t\t}\n\n\t\tif (element.hasAttribute(\"value-separator\")) {    \n\t\t\tbuilder.addPropertyValue(\"valueSeparator\", element.getAttribute(\"value-separator\"));\n\t\t}\n\n\t\tif (element.hasAttribute(\"null-value\")) {\n\t\t\tbuilder.addPropertyValue(\"nullValue\", element.getAttribute(\"null-value\"));\n\t\t}\n\t}\n\n}\n```\n在`getBeanClass`中，根据标签中的`system-properties-mode`属性来返回不同的类，来指明要实例化的类。\n\n再来看上述的`parse`方法，首先就是调用父类的`doParse`方法，然后就是解析标签中的相应属性，放到`BeanDefinitionBuilder`中，剩下的工作就交给spring这个框架来完成了。\n\n#### `system-properties-mode`\n\n决定解析placeholder的顺序。这个属性的取值如下：\n\n>\t**\"ENVIRONMENT\"** indicates placeholders should be resolved against the current Environment and against any local properties;\n\n>\t**\"NEVER\"** indicates placeholders should be resolved only against local properties and never against system properties;\n\n>\t**\"FALLBACK\"** indicates placeholders should be resolved against any local properties and then against system properties;\n\n>\t**\"OVERRIDE\"** indicates placeholders should be resolved first against system properties and then against any local properties;\n\n这个属性的默认值是`ENVIRONMENT`,也就是先从环境变量中解析，然后才从我们定义的properties文件中解析，如果环境中的变量名和配置文件中的变量名冲突，\n\n就会使用环境变量中的。\n\n>所以配置文件中的变量名最好带一个前缀，如`jdbc.username=`, 笔者在Ubuntu下就遇到过不带前缀的`username`和系统的'username'冲突的情况\n\n#### `ignore-unresolvable`\n\n>\tSpecifies if failure to find the property value to replace a key should be ignored.\n\tDefault is \"false\", meaning that this placeholder configurer will raise an exception\n\tif it cannot resolve a key. Set to \"true\" to allow the configurer to pass on the key\n\tto any others in the context that have not yet visited the key in question.\n\n这个属性很关键，他决定遇到无法解析的变量时是否抛出异常，默认是`fale`（抛出异常）,在有多个配置文件的时候应该设置为`true`。\n\n#### `value-separator`\n\nplaceHolder默认值得分隔符，默认是`:`\n\n> The separating character between the placeholder variable and the associated \tdefault value: by default, a ':' symbol.\n\n#### `null-value`\n\n>\tA value that should be treated as 'null' when resolved as a placeholder value:\n\te.g. \"\" (empty String) or \"null\". By default, no such null value is defined.\n\n**这些属性都可以在相应的`xsd`schema中找到。**\n\n\n### AbstractPropertyLoadingBeanDefinitionParser\n\n这是上面的那个解析类的父类。\n\n```java\nabstract class AbstractPropertyLoadingBeanDefinitionParser extends AbstractSingleBeanDefinitionParser {\n\n\t@Override\n\tprotected boolean shouldGenerateId() {\n\t\treturn true;\n\t}\n\n\t@Override\n\tprotected void doParse(Element element, BeanDefinitionBuilder builder) {\n\t\tString location = element.getAttribute(\"location\");\n\t\tif (StringUtils.hasLength(location)) {\n\t\t\tString[] locations = StringUtils.commaDelimitedListToStringArray(location);\n\t\t\tbuilder.addPropertyValue(\"locations\", locations);\n\t\t}\n\n\t\tString propertiesRef = element.getAttribute(\"properties-ref\");\n\t\tif (StringUtils.hasLength(propertiesRef)) {\n\t\t\tbuilder.addPropertyReference(\"properties\", propertiesRef);\n\t\t}\n\n\t\tString fileEncoding = element.getAttribute(\"file-encoding\");\n\t\tif (StringUtils.hasLength(fileEncoding)) {\n\t\t\tbuilder.addPropertyValue(\"fileEncoding\", fileEncoding);\n\t\t}\n\n\t\tString order = element.getAttribute(\"order\");\n\t\tif (StringUtils.hasLength(order)) {\n\t\t\tbuilder.addPropertyValue(\"order\", Integer.valueOf(order));\n\t\t}\n\n\t\tbuilder.addPropertyValue(\"ignoreResourceNotFound\",\n\t\t\t\tBoolean.valueOf(element.getAttribute(\"ignore-resource-not-found\")));\n\n\t\tbuilder.addPropertyValue(\"localOverride\",\n\t\t\t\tBoolean.valueOf(element.getAttribute(\"local-override\")));\n\n\t\tbuilder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n\t}\n\n}\n\n```\n\n#### shouldGenerateId\n\n```java\n/**\n * Should an ID be generated instead of read from the passed in {@link Element}?\n * <p>Disabled by default; subclasses can override this to enable ID generation.\n * Note that this flag is about <i>always</i> generating an ID; the parser\n * won't even check for an \"id\" attribute in this case.\n * @return whether the parser should always generate an id\n */\nprotected boolean shouldGenerateId() {\n  return false;\n}\n```\n\n#### doParse\n\n这个方法负责解析配置文件的location、file-encoding等通用的属性，并放置到`builder`中。\n\n## Spring 调用handler的过程\n\nspring将特定的标签的解析委托给我们自己定义的handler的过程主要是在`DefaultBeanDefinitionDocumentReader`中\n```java\n/**\n\t * Parse the elements at the root level in the document:\n\t * \"import\", \"alias\", \"bean\".\n\t * @param root the DOM root element of the document\n\t */\n\tprotected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) {\n\t\tif (delegate.isDefaultNamespace(root)) {\n\t\t\tNodeList nl = root.getChildNodes();\n\t\t\tfor (int i = 0; i < nl.getLength(); i++) {\n\t\t\t\tNode node = nl.item(i);\n\t\t\t\tif (node instanceof Element) {\n\t\t\t\t\tElement ele = (Element) node;\n\t\t\t\t\tif (delegate.isDefaultNamespace(ele)) {\n\t\t\t\t\t\tparseDefaultElement(ele, delegate);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdelegate.parseCustomElement(ele);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tdelegate.parseCustomElement(root);\n\t\t}\n\t}\n```\n`context`不是默认命名空间的标签，所以走`parseCustomElement`分支。\n\n走到`BeanDefinitionParserDelegate`的`parseCustomElement`方法中\n```java\npublic BeanDefinition parseCustomElement(Element ele) {\n\t\treturn parseCustomElement(ele, null);\n\t}\n\n\tpublic BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd) {\n\t\tString namespaceUri = getNamespaceURI(ele);\n\t\tNamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);\n\t\tif (handler == null) {\n\t\t\terror(\"Unable to locate Spring NamespaceHandler for XML schema namespace [\" + namespaceUri + \"]\", ele);\n\t\t\treturn null;\n\t\t}\n\t\treturn handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));\n\t}\n```\n\n这里从`NamespaceHandlerResolver`中根据`namespaceUri`获取到对应的`NamespaceHandler`,然后调用`handler`的`parse`\n方法进行解析，返回一个`BeanDefinition`，然后就注册到spring中了。\n\n这里的handler就是前面我们看到的实现了`NamespaceHandlerSupport `的那个`ContextNamespaceHandler`,`NamespaceHandlerSupport `继承自`NamespaceHandler`,它的parse 方法如下：\n\n```java\n/**\n\t * Parses the supplied {@link Element} by delegating to the {@link BeanDefinitionParser} that is\n\t * registered for that {@link Element}.\n\t */\n\t@Override\n\tpublic BeanDefinition parse(Element element, ParserContext parserContext) {\n\t\treturn findParserForElement(element, parserContext).parse(element, parserContext);\n\t}\n\n\t/**\n\t * Locates the {@link BeanDefinitionParser} from the register implementations using\n\t * the local name of the supplied {@link Element}.\n\t */\n\tprivate BeanDefinitionParser findParserForElement(Element element, ParserContext parserContext) {\n\t\tString localName = parserContext.getDelegate().getLocalName(element);\n\t\tBeanDefinitionParser parser = this.parsers.get(localName);\n\t\tif (parser == null) {\n\t\t\tparserContext.getReaderContext().fatal(\n\t\t\t\t\t\"Cannot locate BeanDefinitionParser for element [\" + localName + \"]\", element);\n\t\t}\n\t\treturn parser;\n\t}\n\n```\n就是从在`init()`方法中注册的`Parser`,根据对应的标签前缀，获取到parser，对xml元素进行解析。\n\n\n## 生效过程\n\n生效过程是在`BeanFactoryPostProcessor`被调用的过程中生效的, 继承关系\n\n{%  asset_img   post-processors.jpg  %}\n\n\n\n\n可以看到里面有两个熟悉的类——`PropertySourcesPlaceholderConfigurer`和`PropertyPlaceholderConfigurer`，正是`PropertyPlaceholderBeanDefinitionParser.getBeanClass`返回的两种类型, 也就是说他们两个是`BeanFactoryPostProcessor`.\n\n\n### PropertySourcesPlaceholderConfigurer\n```java\n/**\n\t * {@inheritDoc}\n\t * <p>Processing occurs by replacing ${...} placeholders in bean definitions by resolving each\n\t * against this configurer's set of {@link PropertySources}, which includes:\n\t * <ul>\n\t * <li>all {@linkplain org.springframework.core.env.ConfigurableEnvironment#getPropertySources\n\t * environment property sources}, if an {@code Environment} {@linkplain #setEnvironment is present}\n\t * <li>{@linkplain #mergeProperties merged local properties}, if {@linkplain #setLocation any}\n\t * {@linkplain #setLocations have} {@linkplain #setProperties been}\n\t * {@linkplain #setPropertiesArray specified}\n\t * <li>any property sources set by calling {@link #setPropertySources}\n\t * </ul>\n\t * <p>If {@link #setPropertySources} is called, <strong>environment and local properties will be\n\t * ignored</strong>. This method is designed to give the user fine-grained control over property\n\t * sources, and once set, the configurer makes no assumptions about adding additional sources.\n\t */\n\t@Override\n\tpublic void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {\n\t\tif (this.propertySources == null) {\n\t\t\tthis.propertySources = new MutablePropertySources();\n\t\t\tif (this.environment != null) {\n\t\t\t\tthis.propertySources.addLast(\n\t\t\t\t\tnew PropertySource<Environment>(ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME, this.environment) {\n\t\t\t\t\t\t@Override\n\t\t\t\t\t\tpublic String getProperty(String key) {\n\t\t\t\t\t\t\treturn this.source.getProperty(key);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tPropertySource<?> localPropertySource =\n\t\t\t\t\t\tnew PropertiesPropertySource(LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME, mergeProperties());\n\t\t\t\tif (this.localOverride) {\n\t\t\t\t\tthis.propertySources.addFirst(localPropertySource);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.propertySources.addLast(localPropertySource);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch (IOException ex) {\n\t\t\t\tthrow new BeanInitializationException(\"Could not load properties\", ex);\n\t\t\t}\n\t\t}\n\n\t\tprocessProperties(beanFactory, new PropertySourcesPropertyResolver(this.propertySources));\n\t\tthis.appliedPropertySources = this.propertySources;\n\t}\n\n```\n\n注意上述的`localOverride`变量，它决定了是否用本地的替换系统的，主要是用加载的顺序呢控制的\n\n```java\n/**\n* <p>Any local properties (e.g. those added via {@link #setProperties}, {@link #setLocations}\n* et al.) are added as a {@code PropertySource}. Search precedence of local properties is\n* based on the value of the {@link #setLocalOverride localOverride} property, which is by\n* default {@code false} meaning that local properties are to be searched last, after all\n* environment property sources.\n*/\n```\n获取到所有的属性列表后，处理属性就交给了`processProperties`这个方法.\n\n```java\n/**\n\t * Visit each bean definition in the given bean factory and attempt to replace ${...} property\n\t * placeholders with values from the given properties.\n\t */\n\tprotected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess,\n\t\t\tfinal ConfigurablePropertyResolver propertyResolver) throws BeansException {\n\n\t\tpropertyResolver.setPlaceholderPrefix(this.placeholderPrefix);\n\t\tpropertyResolver.setPlaceholderSuffix(this.placeholderSuffix);\n\t\tpropertyResolver.setValueSeparator(this.valueSeparator);\n\n\t\tStringValueResolver valueResolver = new StringValueResolver() {\n\t\t\t@Override\n\t\t\tpublic String resolveStringValue(String strVal) {\n\t\t\t\tString resolved = ignoreUnresolvablePlaceholders ?\n\t\t\t\t\t\tpropertyResolver.resolvePlaceholders(strVal) :\n\t\t\t\t\t\tpropertyResolver.resolveRequiredPlaceholders(strVal);\n\t\t\t\treturn (resolved.equals(nullValue) ? null : resolved);\n\t\t\t}\n\t\t};\n\n\t\tdoProcessProperties(beanFactoryToProcess, valueResolver);\n\t}\n```\n\n先设置propertyResolver的prefix（默认是${}）和suffix(默认是})，以及默认值得分隔符(默认是:).\n\n然后创建了一个StringValueResolver, 这里根据`ignoreUnresolvablePlaceholders`的值来进行不同的解析，\n\n这个值默认是false, 但是可以在标签中配置。\n\n```xml\n<xsd:attribute name=\"ignore-unresolvable\" type=\"xsd:boolean\" default=\"false\">\n\t\t\t<xsd:annotation>\n\t\t\t\t<xsd:documentation><![CDATA[\n\tSpecifies if failure to find the property value to replace a key should be ignored.\n\tDefault is \"false\", meaning that this placeholder configurer will raise an exception\n\tif it cannot resolve a key. Set to \"true\" to allow the configurer to pass on the key\n\tto any others in the context that have not yet visited the key in question.\n\t\t\t\t]]></xsd:documentation>\n\t\t\t</xsd:annotation>\n\t\t</xsd:attribute>\n```\n\n`false`就以为者遇到无法解析的值就会直接抛出异常\n\n接下来看看`doProcessProperties`\n\n```java\nprotected void doProcessProperties(ConfigurableListableBeanFactory beanFactoryToProcess,\n\t\tStringValueResolver valueResolver) {\n\n\tBeanDefinitionVisitor visitor = new BeanDefinitionVisitor(valueResolver);\n\n\tString[] beanNames = beanFactoryToProcess.getBeanDefinitionNames();\n\tfor (String curName : beanNames) {\n\t\t// Check that we're not parsing our own bean definition,\n\t\t// to avoid failing on unresolvable placeholders in properties file locations.\n\t\tif (!(curName.equals(this.beanName) && beanFactoryToProcess.equals(this.beanFactory))) {\n\t\t\tBeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName);\n\t\t\ttry {\n\t\t\t\tvisitor.visitBeanDefinition(bd);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tthrow new BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex);\n\t\t\t}\n\t\t}\n\t}\n\n\t// New in Spring 2.5: resolve placeholders in alias target names and aliases as well.\n\tbeanFactoryToProcess.resolveAliases(valueResolver);\n\n\t// New in Spring 3.0: resolve placeholders in embedded values such as annotation attributes.\n\tbeanFactoryToProcess.addEmbeddedValueResolver(valueResolver);\n}\n```\n这里采用的是visitor模式，查看`BeanDefinitionVisitor#visitBeanDefinition`\n\n```java\n/**\n\t * Traverse the given BeanDefinition object and the MutablePropertyValues\n\t * and ConstructorArgumentValues contained in them.\n\t * @param beanDefinition the BeanDefinition object to traverse\n\t * @see #resolveStringValue(String)\n\t */\n\tpublic void visitBeanDefinition(BeanDefinition beanDefinition) {\n\t\tvisitParentName(beanDefinition);\n\t\tvisitBeanClassName(beanDefinition);\n\t\tvisitFactoryBeanName(beanDefinition);\n\t\tvisitFactoryMethodName(beanDefinition);\n\t\tvisitScope(beanDefinition);\n\t\tvisitPropertyValues(beanDefinition.getPropertyValues());\n\t\tConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues();\n\t\tvisitIndexedArgumentValues(cas.getIndexedArgumentValues());\n\t\tvisitGenericArgumentValues(cas.getGenericArgumentValues());\n\t}\n```\n以其中的`visitParentName`为例：\n```java\nprotected void visitParentName(BeanDefinition beanDefinition) {\n\tString parentName = beanDefinition.getParentName();\n\tif (parentName != null) {\n\t\tString resolvedName = resolveStringValue(parentName);\n\t\tif (!parentName.equals(resolvedName)) {\n\t\t\tbeanDefinition.setParentName(resolvedName);\n\t\t}\n\t}\n}\n\n```\n就是先获取`parentName`，然后替换相应的属性之后的`resolvedName`,如果和原来的不一样就设置`resolvedName`\n\n为新的parentName\n\n```java\n/**\n * Resolve the given String value, for example parsing placeholders.\n * @param strVal the original String value\n * @return the resolved String value\n */\nprotected String resolveStringValue(String strVal) {\n\tif (this.valueResolver == null) {\n\t\tthrow new IllegalStateException(\"No StringValueResolver specified - pass a resolver \" +\n\t\t\t\t\"object into the constructor or override the 'resolveStringValue' method\");\n\t}\n\tString resolvedValue = this.valueResolver.resolveStringValue(strVal);\n\t// Return original String if not modified.\n\treturn (strVal.equals(resolvedValue) ? strVal : resolvedValue);\n}\n```\n\n顺藤摸瓜,看看`valueResolver`,就是之前的`StringValueResolver`\n\n这是一个接口只有一个方法\n\n```java\npublic interface StringValueResolver {\n\n\t/**\n\t * Resolve the given String value, for example parsing placeholders.\n\t * @param strVal the original String value\n\t * @return the resolved String value\n\t */\n\tString resolveStringValue(String strVal);\n\n}\n```\n\n之前传入的其实就是对应`ConfigurablePropertyResolver`的两个方法, 之前传入的是它的子类\n\n`PropertySourcesPropertyResolver`\n\n```java\n@Override\n\tpublic String resolvePlaceholders(String text) {\n\t\tif (this.nonStrictHelper == null) {\n\t\t\tthis.nonStrictHelper = createPlaceholderHelper(true);\n\t\t}\n\t\treturn doResolvePlaceholders(text, this.nonStrictHelper);\n\t}\n\n\t@Override\n\tpublic String resolveRequiredPlaceholders(String text) throws IllegalArgumentException {\n\t\tif (this.strictHelper == null) {\n\t\t\tthis.strictHelper = createPlaceholderHelper(false);\n\t\t}\n\t\treturn doResolvePlaceholders(text, this.strictHelper);\n\t}\n```\n\n调用的是内部方法:\n\n```java\nprivate String doResolvePlaceholders(String text, PropertyPlaceholderHelper helper) {\n\treturn helper.replacePlaceholders(text, new PropertyPlaceholderHelper.PlaceholderResolver() {\n\t\t@Override\n\t\tpublic String resolvePlaceholder(String placeholderName) {\n\t\t\treturn getPropertyAsRawString(placeholderName);\n\t\t}\n\t});\n}\n\n```\n\n最终调用功能的是`PropertyPlaceholderHelper`的replacePlaceholders方法，\n\n这个helper在构造是通过 `createPlaceholderHelper`方法构建的，他接受一个bool类型的参数\n\n```java\nprivate PropertyPlaceholderHelper createPlaceholderHelper(boolean ignoreUnresolvablePlaceholders) {\n\treturn new PropertyPlaceholderHelper(this.placeholderPrefix, this.placeholderSuffix,\n\t\t\tthis.valueSeparator, ignoreUnresolvablePlaceholders);\n}\n```\n\n这个bool值就是表示是否要ignore掉不能解析的属性。\n\n```java\n/**\n\t * Creates a new {@code PropertyPlaceholderHelper} that uses the supplied prefix and suffix.\n\t * @param placeholderPrefix the prefix that denotes the start of a placeholder\n\t * @param placeholderSuffix the suffix that denotes the end of a placeholder\n\t * @param valueSeparator the separating character between the placeholder variable\n\t * and the associated default value, if any\n\t * @param ignoreUnresolvablePlaceholders indicates whether unresolvable placeholders should\n\t * be ignored ({@code true}) or cause an exception ({@code false})\n\t */\n```\n接着追\n\n```java\n/**\n * Replaces all placeholders of format {@code ${name}} with the value returned\n * from the supplied {@link PlaceholderResolver}.\n * @param value the value containing the placeholders to be replaced\n * @param placeholderResolver the {@code PlaceholderResolver} to use for replacement\n * @return the supplied value with placeholders replaced inline\n */\npublic String replacePlaceholders(String value, PlaceholderResolver placeholderResolver) {\n\tAssert.notNull(value, \"'value' must not be null\");\n\treturn parseStringValue(value, placeholderResolver, new HashSet<String>());\n}\n\nprotected String parseStringValue(\n\t\t\tString strVal, PlaceholderResolver placeholderResolver, Set<String> visitedPlaceholders) {\n\n\t\tStringBuilder result = new StringBuilder(strVal);\n\n\t\tint startIndex = strVal.indexOf(this.placeholderPrefix);\n\t\twhile (startIndex != -1) {\n\t\t\tint endIndex = findPlaceholderEndIndex(result, startIndex);\n\t\t\tif (endIndex != -1) {\n\t\t\t\tString placeholder = result.substring(startIndex + this.placeholderPrefix.length(), endIndex);\n\t\t\t\tString originalPlaceholder = placeholder;\n\t\t\t\tif (!visitedPlaceholders.add(originalPlaceholder)) {\n\t\t\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\t\t\"Circular placeholder reference '\" + originalPlaceholder + \"' in property definitions\");\n\t\t\t\t}\n\t\t\t\t// Recursive invocation, parsing placeholders contained in the placeholder key.\n\t\t\t\tplaceholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);\n\t\t\t\t// Now obtain the value for the fully resolved key...\n\t\t\t\tString propVal = placeholderResolver.resolvePlaceholder(placeholder);\n\t\t\t\tif (propVal == null && this.valueSeparator != null) {\n\t\t\t\t\tint separatorIndex = placeholder.indexOf(this.valueSeparator);\n\t\t\t\t\tif (separatorIndex != -1) {\n\t\t\t\t\t\tString actualPlaceholder = placeholder.substring(0, separatorIndex);\n\t\t\t\t\t\tString defaultValue = placeholder.substring(separatorIndex + this.valueSeparator.length());\n\t\t\t\t\t\tpropVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);\n\t\t\t\t\t\tif (propVal == null) {\n\t\t\t\t\t\t\tpropVal = defaultValue;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (propVal != null) {\n\t\t\t\t\t// Recursive invocation, parsing placeholders contained in the\n\t\t\t\t\t// previously resolved placeholder value.\n\t\t\t\t\tpropVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);\n\t\t\t\t\tresult.replace(startIndex, endIndex + this.placeholderSuffix.length(), propVal);\n\t\t\t\t\tif (logger.isTraceEnabled()) {\n\t\t\t\t\t\tlogger.trace(\"Resolved placeholder '\" + placeholder + \"'\");\n\t\t\t\t\t}\n\t\t\t\t\tstartIndex = result.indexOf(this.placeholderPrefix, startIndex + propVal.length());\n\t\t\t\t}\n\t\t\t\telse if (this.ignoreUnresolvablePlaceholders) {\n\t\t\t\t\t// Proceed with unprocessed value.\n\t\t\t\t\tstartIndex = result.indexOf(this.placeholderPrefix, endIndex + this.placeholderSuffix.length());\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthrow new IllegalArgumentException(\"Could not resolve placeholder '\" +\n\t\t\t\t\t\t\tplaceholder + \"'\" + \" in string value \\\"\" + strVal + \"\\\"\");\n\t\t\t\t}\n\t\t\t\tvisitedPlaceholders.remove(originalPlaceholder);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstartIndex = -1;\n\t\t\t}\n\t\t}\n\n\t\treturn result.toString();\n\t}\n\n```\n\n实际解析的代码都在这里：\n\n1. 取出placeHolder的名称.\n2. 判断有没有循环引用的情况.\n3. 递归替换，获取对应的值.\n4. 如果值为空，解析默认值.\n\n\n### PropertyPlaceholderConfigurer\n\n应该和上面的类似，抽时间补。\n","slug":"property-placeholder","published":1,"updated":"2017-04-16T12:03:23.405Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdag0093jh4kys41esyj","content":"<h2 id=\"lt-context-property-placeholder-location-39-xxx-39-gt-的解析过程\"><a href=\"#lt-context-property-placeholder-location-39-xxx-39-gt-的解析过程\" class=\"headerlink\" title=\"&lt;context:property-placeholder location=&#39;xxx&#39; /&gt;的解析过程\"></a><code>&lt;context:property-placeholder location=&#39;xxx&#39; /&gt;</code>的解析过程</h2><h3 id=\"schema\"><a href=\"#schema\" class=\"headerlink\" title=\"schema\"></a>schema</h3><p>在idea中<code>ctrl</code> + <code>b</code>或者，<code>ctrl</code> + 鼠标左键点击即可打开schema具体的位置</p>\n<img src=\"/2016/10/31/property-placeholder/location.jpg\">\n<p><code>sping.handlers</code>中内容如下:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler</span><br></pre></td></tr></table></figure>\n<p><code>spring.schemas</code>中的内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-2.5.xsd=org/springframework/context/config/spring-context-2.5.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-3.0.xsd=org/springframework/context/config/spring-context-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-3.1.xsd=org/springframework/context/config/spring-context-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-3.2.xsd=org/springframework/context/config/spring-context-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-4.0.xsd=org/springframework/context/config/spring-context-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-4.1.xsd=org/springframework/context/config/spring-context-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-4.2.xsd=org/springframework/context/config/spring-context-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context.xsd=org/springframework/context/config/spring-context-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-2.0.xsd=org/springframework/ejb/config/spring-jee-2.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-2.5.xsd=org/springframework/ejb/config/spring-jee-2.5.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-3.0.xsd=org/springframework/ejb/config/spring-jee-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-3.1.xsd=org/springframework/ejb/config/spring-jee-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-3.2.xsd=org/springframework/ejb/config/spring-jee-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-4.0.xsd=org/springframework/ejb/config/spring-jee-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-4.1.xsd=org/springframework/ejb/config/spring-jee-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-4.2.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-2.0.xsd=org/springframework/scripting/config/spring-lang-2.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-2.5.xsd=org/springframework/scripting/config/spring-lang-2.5.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-3.0.xsd=org/springframework/scripting/config/spring-lang-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-3.1.xsd=org/springframework/scripting/config/spring-lang-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-3.2.xsd=org/springframework/scripting/config/spring-lang-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-4.0.xsd=org/springframework/scripting/config/spring-lang-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-4.1.xsd=org/springframework/scripting/config/spring-lang-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-4.2.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-3.0.xsd=org/springframework/scheduling/config/spring-task-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-3.1.xsd=org/springframework/scheduling/config/spring-task-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-3.2.xsd=org/springframework/scheduling/config/spring-task-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-4.0.xsd=org/springframework/scheduling/config/spring-task-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-4.1.xsd=org/springframework/scheduling/config/spring-task-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-4.2.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-3.1.xsd=org/springframework/cache/config/spring-cache-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-3.2.xsd=org/springframework/cache/config/spring-cache-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-4.0.xsd=org/springframework/cache/config/spring-cache-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-4.1.xsd=org/springframework/cache/config/spring-cache-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-4.2.xsd=org/springframework/cache/config/spring-cache-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache.xsd=org/springframework/cache/config/spring-cache-4.2.xsd</span><br></pre></td></tr></table></figure>\n<h3 id=\"NamespaceHandlerSupport\"><a href=\"#NamespaceHandlerSupport\" class=\"headerlink\" title=\"NamespaceHandlerSupport\"></a>NamespaceHandlerSupport</h3><p>从<code>handler</code>中我们可以找出<code>context</code>标签的处理类是<code>org.springframework.context.config.ContextNamespaceHandler</code>,内容如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ContextNamespaceHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"property-placeholder\"</span>, <span class=\"keyword\">new</span> PropertyPlaceholderBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"property-override\"</span>, <span class=\"keyword\">new</span> PropertyOverrideBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"annotation-config\"</span>, <span class=\"keyword\">new</span> AnnotationConfigBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"component-scan\"</span>, <span class=\"keyword\">new</span> ComponentScanBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"load-time-weaver\"</span>, <span class=\"keyword\">new</span> LoadTimeWeaverBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"spring-configured\"</span>, <span class=\"keyword\">new</span> SpringConfiguredBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"mbean-export\"</span>, <span class=\"keyword\">new</span> MBeanExportBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"mbean-server\"</span>, <span class=\"keyword\">new</span> MBeanServerBeanDefinitionParser());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>顺藤摸瓜就能找到<code>property-placeholder</code>的处理类是<code>PropertyPlaceholderBeanDefinitionParser</code></p>\n<h3 id=\"PropertyPlaceholderBeanDefinitionParser\"><a href=\"#PropertyPlaceholderBeanDefinitionParser\" class=\"headerlink\" title=\"PropertyPlaceholderBeanDefinitionParser\"></a>PropertyPlaceholderBeanDefinitionParser</h3><p>继承关系：</p>\n<img src=\"/2016/10/31/property-placeholder/hierarchy.jpg\">\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PropertyPlaceholderBeanDefinitionParser</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractPropertyLoadingBeanDefinitionParser</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SYSTEM_PROPERTIES_MODE_ATTRIBUTE = <span class=\"string\">\"system-properties-mode\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SYSTEM_PROPERTIES_MODE_DEFAULT = <span class=\"string\">\"ENVIRONMENT\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// As of Spring 3.1, the default value of system-properties-mode has changed from</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 'FALLBACK' to 'ENVIRONMENT'. This latter value indicates that resolution of</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// placeholders against system properties is a function of the Environment and</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// its current set of PropertySources.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (SYSTEM_PROPERTIES_MODE_DEFAULT.equals(element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE))) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> PropertySourcesPlaceholderConfigurer.class;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// The user has explicitly specified a value for system-properties-mode: revert to</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// PropertyPlaceholderConfigurer to ensure backward compatibility with 3.0 and earlier.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> PropertyPlaceholderConfigurer.class;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doParse</span><span class=\"params\">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">super</span>.doParse(element, builder);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.addPropertyValue(<span class=\"string\">\"ignoreUnresolvablePlaceholders\"</span>,</span><br><span class=\"line\">\t\t\t\tBoolean.valueOf(element.getAttribute(<span class=\"string\">\"ignore-unresolvable\"</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString systemPropertiesModeName = element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(systemPropertiesModeName) &amp;&amp;</span><br><span class=\"line\">\t\t\t\t!systemPropertiesModeName.equals(SYSTEM_PROPERTIES_MODE_DEFAULT)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"systemPropertiesModeName\"</span>, <span class=\"string\">\"SYSTEM_PROPERTIES_MODE_\"</span> + systemPropertiesModeName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (element.hasAttribute(<span class=\"string\">\"value-separator\"</span>)) &#123;    </span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"valueSeparator\"</span>, element.getAttribute(<span class=\"string\">\"value-separator\"</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (element.hasAttribute(<span class=\"string\">\"null-value\"</span>)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"nullValue\"</span>, element.getAttribute(<span class=\"string\">\"null-value\"</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在<code>getBeanClass</code>中，根据标签中的<code>system-properties-mode</code>属性来返回不同的类，来指明要实例化的类。</p>\n<p>再来看上述的<code>parse</code>方法，首先就是调用父类的<code>doParse</code>方法，然后就是解析标签中的相应属性，放到<code>BeanDefinitionBuilder</code>中，剩下的工作就交给spring这个框架来完成了。</p>\n<h4 id=\"system-properties-mode\"><a href=\"#system-properties-mode\" class=\"headerlink\" title=\"system-properties-mode\"></a><code>system-properties-mode</code></h4><p>决定解析placeholder的顺序。这个属性的取值如下：</p>\n<blockquote>\n<p>   <strong>“ENVIRONMENT”</strong> indicates placeholders should be resolved against the current Environment and against any local properties;</p>\n<p>   <strong>“NEVER”</strong> indicates placeholders should be resolved only against local properties and never against system properties;</p>\n<p>   <strong>“FALLBACK”</strong> indicates placeholders should be resolved against any local properties and then against system properties;</p>\n<p>   <strong>“OVERRIDE”</strong> indicates placeholders should be resolved first against system properties and then against any local properties;</p>\n</blockquote>\n<p>这个属性的默认值是<code>ENVIRONMENT</code>,也就是先从环境变量中解析，然后才从我们定义的properties文件中解析，如果环境中的变量名和配置文件中的变量名冲突，</p>\n<p>就会使用环境变量中的。</p>\n<blockquote>\n<p>所以配置文件中的变量名最好带一个前缀，如<code>jdbc.username=</code>, 笔者在Ubuntu下就遇到过不带前缀的<code>username</code>和系统的’username’冲突的情况</p>\n</blockquote>\n<h4 id=\"ignore-unresolvable\"><a href=\"#ignore-unresolvable\" class=\"headerlink\" title=\"ignore-unresolvable\"></a><code>ignore-unresolvable</code></h4><blockquote>\n<p>   Specifies if failure to find the property value to replace a key should be ignored.<br>    Default is “false”, meaning that this placeholder configurer will raise an exception<br>    if it cannot resolve a key. Set to “true” to allow the configurer to pass on the key<br>    to any others in the context that have not yet visited the key in question.</p>\n</blockquote>\n<p>这个属性很关键，他决定遇到无法解析的变量时是否抛出异常，默认是<code>fale</code>（抛出异常）,在有多个配置文件的时候应该设置为<code>true</code>。</p>\n<h4 id=\"value-separator\"><a href=\"#value-separator\" class=\"headerlink\" title=\"value-separator\"></a><code>value-separator</code></h4><p>placeHolder默认值得分隔符，默认是<code>:</code></p>\n<blockquote>\n<p>The separating character between the placeholder variable and the associated     default value: by default, a ‘:’ symbol.</p>\n</blockquote>\n<h4 id=\"null-value\"><a href=\"#null-value\" class=\"headerlink\" title=\"null-value\"></a><code>null-value</code></h4><blockquote>\n<p>   A value that should be treated as ‘null’ when resolved as a placeholder value:<br>    e.g. “” (empty String) or “null”. By default, no such null value is defined.</p>\n</blockquote>\n<p><strong>这些属性都可以在相应的<code>xsd</code>schema中找到。</strong></p>\n<h3 id=\"AbstractPropertyLoadingBeanDefinitionParser\"><a href=\"#AbstractPropertyLoadingBeanDefinitionParser\" class=\"headerlink\" title=\"AbstractPropertyLoadingBeanDefinitionParser\"></a>AbstractPropertyLoadingBeanDefinitionParser</h3><p>这是上面的那个解析类的父类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractPropertyLoadingBeanDefinitionParser</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">shouldGenerateId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doParse</span><span class=\"params\">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class=\"line\">\t\tString location = element.getAttribute(<span class=\"string\">\"location\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(location)) &#123;</span><br><span class=\"line\">\t\t\tString[] locations = StringUtils.commaDelimitedListToStringArray(location);</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"locations\"</span>, locations);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString propertiesRef = element.getAttribute(<span class=\"string\">\"properties-ref\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(propertiesRef)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyReference(<span class=\"string\">\"properties\"</span>, propertiesRef);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString fileEncoding = element.getAttribute(<span class=\"string\">\"file-encoding\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(fileEncoding)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"fileEncoding\"</span>, fileEncoding);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString order = element.getAttribute(<span class=\"string\">\"order\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(order)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"order\"</span>, Integer.valueOf(order));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.addPropertyValue(<span class=\"string\">\"ignoreResourceNotFound\"</span>,</span><br><span class=\"line\">\t\t\t\tBoolean.valueOf(element.getAttribute(<span class=\"string\">\"ignore-resource-not-found\"</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.addPropertyValue(<span class=\"string\">\"localOverride\"</span>,</span><br><span class=\"line\">\t\t\t\tBoolean.valueOf(element.getAttribute(<span class=\"string\">\"local-override\"</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"shouldGenerateId\"><a href=\"#shouldGenerateId\" class=\"headerlink\" title=\"shouldGenerateId\"></a>shouldGenerateId</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Should an ID be generated instead of read from the passed in &#123;<span class=\"doctag\">@link</span> Element&#125;?</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;Disabled by default; subclasses can override this to enable ID generation.</span></span><br><span class=\"line\"><span class=\"comment\"> * Note that this flag is about &lt;i&gt;always&lt;/i&gt; generating an ID; the parser</span></span><br><span class=\"line\"><span class=\"comment\"> * won't even check for an \"id\" attribute in this case.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> whether the parser should always generate an id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">shouldGenerateId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"doParse\"><a href=\"#doParse\" class=\"headerlink\" title=\"doParse\"></a>doParse</h4><p>这个方法负责解析配置文件的location、file-encoding等通用的属性，并放置到<code>builder</code>中。</p>\n<h2 id=\"Spring-调用handler的过程\"><a href=\"#Spring-调用handler的过程\" class=\"headerlink\" title=\"Spring 调用handler的过程\"></a>Spring 调用handler的过程</h2><p>spring将特定的标签的解析委托给我们自己定义的handler的过程主要是在<code>DefaultBeanDefinitionDocumentReader</code>中<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Parse the elements at the root level in the document:</span></span><br><span class=\"line\"><span class=\"comment\">\t * \"import\", \"alias\", \"bean\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> root the DOM root element of the document</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">parseBeanDefinitions</span><span class=\"params\">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class=\"line\">\t\t\tNodeList nl = root.getChildNodes();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class=\"line\">\t\t\t\tNode node = nl.item(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> Element) &#123;</span><br><span class=\"line\">\t\t\t\t\tElement ele = (Element) node;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tparseDefaultElement(ele, delegate);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\tdelegate.parseCustomElement(ele);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tdelegate.parseCustomElement(root);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>context</code>不是默认命名空间的标签，所以走<code>parseCustomElement</code>分支。</p>\n<p>走到<code>BeanDefinitionParserDelegate</code>的<code>parseCustomElement</code>方法中<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> BeanDefinition <span class=\"title\">parseCustomElement</span><span class=\"params\">(Element ele)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> parseCustomElement(ele, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> BeanDefinition <span class=\"title\">parseCustomElement</span><span class=\"params\">(Element ele, BeanDefinition containingBd)</span> </span>&#123;</span><br><span class=\"line\">\t\tString namespaceUri = getNamespaceURI(ele);</span><br><span class=\"line\">\t\tNamespaceHandler handler = <span class=\"keyword\">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (handler == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\terror(<span class=\"string\">\"Unable to locate Spring NamespaceHandler for XML schema namespace [\"</span> + namespaceUri + <span class=\"string\">\"]\"</span>, ele);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> handler.parse(ele, <span class=\"keyword\">new</span> ParserContext(<span class=\"keyword\">this</span>.readerContext, <span class=\"keyword\">this</span>, containingBd));</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这里从<code>NamespaceHandlerResolver</code>中根据<code>namespaceUri</code>获取到对应的<code>NamespaceHandler</code>,然后调用<code>handler</code>的<code>parse</code><br>方法进行解析，返回一个<code>BeanDefinition</code>，然后就注册到spring中了。</p>\n<p>这里的handler就是前面我们看到的实现了<code>NamespaceHandlerSupport</code>的那个<code>ContextNamespaceHandler</code>,<code>NamespaceHandlerSupport</code>继承自<code>NamespaceHandler</code>,它的parse 方法如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Parses the supplied &#123;<span class=\"doctag\">@link</span> Element&#125; by delegating to the &#123;<span class=\"doctag\">@link</span> BeanDefinitionParser&#125; that is</span></span><br><span class=\"line\"><span class=\"comment\">\t * registered for that &#123;<span class=\"doctag\">@link</span> Element&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> BeanDefinition <span class=\"title\">parse</span><span class=\"params\">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> findParserForElement(element, parserContext).parse(element, parserContext);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Locates the &#123;<span class=\"doctag\">@link</span> BeanDefinitionParser&#125; from the register implementations using</span></span><br><span class=\"line\"><span class=\"comment\">\t * the local name of the supplied &#123;<span class=\"doctag\">@link</span> Element&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> BeanDefinitionParser <span class=\"title\">findParserForElement</span><span class=\"params\">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class=\"line\">\t\tString localName = parserContext.getDelegate().getLocalName(element);</span><br><span class=\"line\">\t\tBeanDefinitionParser parser = <span class=\"keyword\">this</span>.parsers.get(localName);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (parser == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\tparserContext.getReaderContext().fatal(</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">\"Cannot locate BeanDefinitionParser for element [\"</span> + localName + <span class=\"string\">\"]\"</span>, element);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> parser;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>就是从在<code>init()</code>方法中注册的<code>Parser</code>,根据对应的标签前缀，获取到parser，对xml元素进行解析。</p>\n<h2 id=\"生效过程\"><a href=\"#生效过程\" class=\"headerlink\" title=\"生效过程\"></a>生效过程</h2><p>生效过程是在<code>BeanFactoryPostProcessor</code>被调用的过程中生效的, 继承关系</p>\n<img src=\"/2016/10/31/property-placeholder/post-processors.jpg\">\n<p>可以看到里面有两个熟悉的类——<code>PropertySourcesPlaceholderConfigurer</code>和<code>PropertyPlaceholderConfigurer</code>，正是<code>PropertyPlaceholderBeanDefinitionParser.getBeanClass</code>返回的两种类型, 也就是说他们两个是<code>BeanFactoryPostProcessor</code>.</p>\n<h3 id=\"PropertySourcesPlaceholderConfigurer\"><a href=\"#PropertySourcesPlaceholderConfigurer\" class=\"headerlink\" title=\"PropertySourcesPlaceholderConfigurer\"></a>PropertySourcesPlaceholderConfigurer</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@inheritDoc</span>&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Processing occurs by replacing $&#123;...&#125; placeholders in bean definitions by resolving each</span></span><br><span class=\"line\"><span class=\"comment\">\t * against this configurer's set of &#123;<span class=\"doctag\">@link</span> PropertySources&#125;, which includes:</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;all &#123;<span class=\"doctag\">@linkplain</span> org.springframework.core.env.ConfigurableEnvironment#getPropertySources</span></span><br><span class=\"line\"><span class=\"comment\">\t * environment property sources&#125;, if an &#123;<span class=\"doctag\">@code</span> Environment&#125; &#123;<span class=\"doctag\">@linkplain</span> #setEnvironment is present&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;&#123;<span class=\"doctag\">@linkplain</span> #mergeProperties merged local properties&#125;, if &#123;<span class=\"doctag\">@linkplain</span> #setLocation any&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@linkplain</span> #setLocations have&#125; &#123;<span class=\"doctag\">@linkplain</span> #setProperties been&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@linkplain</span> #setPropertiesArray specified&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;any property sources set by calling &#123;<span class=\"doctag\">@link</span> #setPropertySources&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;/ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;If &#123;<span class=\"doctag\">@link</span> #setPropertySources&#125; is called, &lt;strong&gt;environment and local properties will be</span></span><br><span class=\"line\"><span class=\"comment\">\t * ignored&lt;/strong&gt;. This method is designed to give the user fine-grained control over property</span></span><br><span class=\"line\"><span class=\"comment\">\t * sources, and once set, the configurer makes no assumptions about adding additional sources.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">postProcessBeanFactory</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactory)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.propertySources == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.propertySources = <span class=\"keyword\">new</span> MutablePropertySources();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.environment != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.propertySources.addLast(</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">new</span> PropertySource&lt;Environment&gt;(ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME, <span class=\"keyword\">this</span>.environment) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getProperty</span><span class=\"params\">(String key)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.source.getProperty(key);</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tPropertySource&lt;?&gt; localPropertySource =</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">new</span> PropertiesPropertySource(LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME, mergeProperties());</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.localOverride) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">this</span>.propertySources.addFirst(localPropertySource);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">this</span>.propertySources.addLast(localPropertySource);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BeanInitializationException(<span class=\"string\">\"Could not load properties\"</span>, ex);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tprocessProperties(beanFactory, <span class=\"keyword\">new</span> PropertySourcesPropertyResolver(<span class=\"keyword\">this</span>.propertySources));</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.appliedPropertySources = <span class=\"keyword\">this</span>.propertySources;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>注意上述的<code>localOverride</code>变量，它决定了是否用本地的替换系统的，主要是用加载的顺序呢控制的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* &lt;p&gt;Any local properties (e.g. those added via &#123;<span class=\"doctag\">@link</span> #setProperties&#125;, &#123;<span class=\"doctag\">@link</span> #setLocations&#125;</span></span><br><span class=\"line\"><span class=\"comment\">* et al.) are added as a &#123;<span class=\"doctag\">@code</span> PropertySource&#125;. Search precedence of local properties is</span></span><br><span class=\"line\"><span class=\"comment\">* based on the value of the &#123;<span class=\"doctag\">@link</span> #setLocalOverride localOverride&#125; property, which is by</span></span><br><span class=\"line\"><span class=\"comment\">* default &#123;<span class=\"doctag\">@code</span> false&#125; meaning that local properties are to be searched last, after all</span></span><br><span class=\"line\"><span class=\"comment\">* environment property sources.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>获取到所有的属性列表后，处理属性就交给了<code>processProperties</code>这个方法.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Visit each bean definition in the given bean factory and attempt to replace $&#123;...&#125; property</span></span><br><span class=\"line\"><span class=\"comment\">\t * placeholders with values from the given properties.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">processProperties</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t<span class=\"keyword\">final</span> ConfigurablePropertyResolver propertyResolver)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpropertyResolver.setPlaceholderPrefix(<span class=\"keyword\">this</span>.placeholderPrefix);</span><br><span class=\"line\">\t\tpropertyResolver.setPlaceholderSuffix(<span class=\"keyword\">this</span>.placeholderSuffix);</span><br><span class=\"line\">\t\tpropertyResolver.setValueSeparator(<span class=\"keyword\">this</span>.valueSeparator);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tStringValueResolver valueResolver = <span class=\"keyword\">new</span> StringValueResolver() &#123;</span><br><span class=\"line\">\t\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolveStringValue</span><span class=\"params\">(String strVal)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t\tString resolved = ignoreUnresolvablePlaceholders ?</span><br><span class=\"line\">\t\t\t\t\t\tpropertyResolver.resolvePlaceholders(strVal) :</span><br><span class=\"line\">\t\t\t\t\t\tpropertyResolver.resolveRequiredPlaceholders(strVal);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> (resolved.equals(nullValue) ? <span class=\"keyword\">null</span> : resolved);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tdoProcessProperties(beanFactoryToProcess, valueResolver);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>先设置propertyResolver的prefix（默认是${}）和suffix(默认是})，以及默认值得分隔符(默认是:).</p>\n<p>然后创建了一个StringValueResolver, 这里根据<code>ignoreUnresolvablePlaceholders</code>的值来进行不同的解析，</p>\n<p>这个值默认是false, 但是可以在标签中配置。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ignore-unresolvable\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:boolean\"</span> <span class=\"attr\">default</span>=<span class=\"string\">\"false\"</span>&gt;</span></span><br><span class=\"line\">\t\t\t<span class=\"tag\">&lt;<span class=\"name\">xsd:annotation</span>&gt;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"tag\">&lt;<span class=\"name\">xsd:documentation</span>&gt;</span>&lt;![CDATA[</span><br><span class=\"line\">\tSpecifies if failure to find the property value to replace a key should be ignored.</span><br><span class=\"line\">\tDefault is \"false\", meaning that this placeholder configurer will raise an exception</span><br><span class=\"line\">\tif it cannot resolve a key. Set to \"true\" to allow the configurer to pass on the key</span><br><span class=\"line\">\tto any others in the context that have not yet visited the key in question.</span><br><span class=\"line\">\t\t\t\t]]&gt;<span class=\"tag\">&lt;/<span class=\"name\">xsd:documentation</span>&gt;</span></span><br><span class=\"line\">\t\t\t<span class=\"tag\">&lt;/<span class=\"name\">xsd:annotation</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;/<span class=\"name\">xsd:attribute</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p><code>false</code>就以为者遇到无法解析的值就会直接抛出异常</p>\n<p>接下来看看<code>doProcessProperties</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doProcessProperties</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\tStringValueResolver valueResolver)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tBeanDefinitionVisitor visitor = <span class=\"keyword\">new</span> BeanDefinitionVisitor(valueResolver);</span><br><span class=\"line\"></span><br><span class=\"line\">\tString[] beanNames = beanFactoryToProcess.getBeanDefinitionNames();</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (String curName : beanNames) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Check that we're not parsing our own bean definition,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// to avoid failing on unresolvable placeholders in properties file locations.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!(curName.equals(<span class=\"keyword\">this</span>.beanName) &amp;&amp; beanFactoryToProcess.equals(<span class=\"keyword\">this</span>.beanFactory))) &#123;</span><br><span class=\"line\">\t\t\tBeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tvisitor.visitBeanDefinition(bd);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// New in Spring 2.5: resolve placeholders in alias target names and aliases as well.</span></span><br><span class=\"line\">\tbeanFactoryToProcess.resolveAliases(valueResolver);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// New in Spring 3.0: resolve placeholders in embedded values such as annotation attributes.</span></span><br><span class=\"line\">\tbeanFactoryToProcess.addEmbeddedValueResolver(valueResolver);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里采用的是visitor模式，查看<code>BeanDefinitionVisitor#visitBeanDefinition</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Traverse the given BeanDefinition object and the MutablePropertyValues</span></span><br><span class=\"line\"><span class=\"comment\">\t * and ConstructorArgumentValues contained in them.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> beanDefinition the BeanDefinition object to traverse</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #resolveStringValue(String)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">visitBeanDefinition</span><span class=\"params\">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class=\"line\">\t\tvisitParentName(beanDefinition);</span><br><span class=\"line\">\t\tvisitBeanClassName(beanDefinition);</span><br><span class=\"line\">\t\tvisitFactoryBeanName(beanDefinition);</span><br><span class=\"line\">\t\tvisitFactoryMethodName(beanDefinition);</span><br><span class=\"line\">\t\tvisitScope(beanDefinition);</span><br><span class=\"line\">\t\tvisitPropertyValues(beanDefinition.getPropertyValues());</span><br><span class=\"line\">\t\tConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues();</span><br><span class=\"line\">\t\tvisitIndexedArgumentValues(cas.getIndexedArgumentValues());</span><br><span class=\"line\">\t\tvisitGenericArgumentValues(cas.getGenericArgumentValues());</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>以其中的<code>visitParentName</code>为例：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">visitParentName</span><span class=\"params\">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class=\"line\">\tString parentName = beanDefinition.getParentName();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (parentName != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\tString resolvedName = resolveStringValue(parentName);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!parentName.equals(resolvedName)) &#123;</span><br><span class=\"line\">\t\t\tbeanDefinition.setParentName(resolvedName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>就是先获取<code>parentName</code>，然后替换相应的属性之后的<code>resolvedName</code>,如果和原来的不一样就设置<code>resolvedName</code></p>\n<p>为新的parentName</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Resolve the given String value, for example parsing placeholders.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> strVal the original String value</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the resolved String value</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> String <span class=\"title\">resolveStringValue</span><span class=\"params\">(String strVal)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.valueResolver == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"No StringValueResolver specified - pass a resolver \"</span> +</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">\"object into the constructor or override the 'resolveStringValue' method\"</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tString resolvedValue = <span class=\"keyword\">this</span>.valueResolver.resolveStringValue(strVal);</span><br><span class=\"line\">\t<span class=\"comment\">// Return original String if not modified.</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (strVal.equals(resolvedValue) ? strVal : resolvedValue);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>顺藤摸瓜,看看<code>valueResolver</code>,就是之前的<code>StringValueResolver</code></p>\n<p>这是一个接口只有一个方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StringValueResolver</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Resolve the given String value, for example parsing placeholders.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> strVal the original String value</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the resolved String value</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">String <span class=\"title\">resolveStringValue</span><span class=\"params\">(String strVal)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>之前传入的其实就是对应<code>ConfigurablePropertyResolver</code>的两个方法, 之前传入的是它的子类</p>\n<p><code>PropertySourcesPropertyResolver</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolvePlaceholders</span><span class=\"params\">(String text)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.nonStrictHelper == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.nonStrictHelper = createPlaceholderHelper(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> doResolvePlaceholders(text, <span class=\"keyword\">this</span>.nonStrictHelper);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolveRequiredPlaceholders</span><span class=\"params\">(String text)</span> <span class=\"keyword\">throws</span> IllegalArgumentException </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.strictHelper == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.strictHelper = createPlaceholderHelper(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> doResolvePlaceholders(text, <span class=\"keyword\">this</span>.strictHelper);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>调用的是内部方法:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">doResolvePlaceholders</span><span class=\"params\">(String text, PropertyPlaceholderHelper helper)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> helper.replacePlaceholders(text, <span class=\"keyword\">new</span> PropertyPlaceholderHelper.PlaceholderResolver() &#123;</span><br><span class=\"line\">\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolvePlaceholder</span><span class=\"params\">(String placeholderName)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> getPropertyAsRawString(placeholderName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终调用功能的是<code>PropertyPlaceholderHelper</code>的replacePlaceholders方法，</p>\n<p>这个helper在构造是通过 <code>createPlaceholderHelper</code>方法构建的，他接受一个bool类型的参数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> PropertyPlaceholderHelper <span class=\"title\">createPlaceholderHelper</span><span class=\"params\">(<span class=\"keyword\">boolean</span> ignoreUnresolvablePlaceholders)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PropertyPlaceholderHelper(<span class=\"keyword\">this</span>.placeholderPrefix, <span class=\"keyword\">this</span>.placeholderSuffix,</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.valueSeparator, ignoreUnresolvablePlaceholders);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这个bool值就是表示是否要ignore掉不能解析的属性。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Creates a new &#123;<span class=\"doctag\">@code</span> PropertyPlaceholderHelper&#125; that uses the supplied prefix and suffix.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> placeholderPrefix the prefix that denotes the start of a placeholder</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> placeholderSuffix the suffix that denotes the end of a placeholder</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> valueSeparator the separating character between the placeholder variable</span></span><br><span class=\"line\"><span class=\"comment\">\t * and the associated default value, if any</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> ignoreUnresolvablePlaceholders indicates whether unresolvable placeholders should</span></span><br><span class=\"line\"><span class=\"comment\">\t * be ignored (&#123;<span class=\"doctag\">@code</span> true&#125;) or cause an exception (&#123;<span class=\"doctag\">@code</span> false&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br></pre></td></tr></table></figure>\n<p>接着追</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Replaces all placeholders of format &#123;<span class=\"doctag\">@code</span> $&#123;name&#125;&#125; with the value returned</span></span><br><span class=\"line\"><span class=\"comment\"> * from the supplied &#123;<span class=\"doctag\">@link</span> PlaceholderResolver&#125;.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> value the value containing the placeholders to be replaced</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> placeholderResolver the &#123;<span class=\"doctag\">@code</span> PlaceholderResolver&#125; to use for replacement</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the supplied value with placeholders replaced inline</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">replacePlaceholders</span><span class=\"params\">(String value, PlaceholderResolver placeholderResolver)</span> </span>&#123;</span><br><span class=\"line\">\tAssert.notNull(value, <span class=\"string\">\"'value' must not be null\"</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> parseStringValue(value, placeholderResolver, <span class=\"keyword\">new</span> HashSet&lt;String&gt;());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> String <span class=\"title\">parseStringValue</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tString strVal, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tStringBuilder result = <span class=\"keyword\">new</span> StringBuilder(strVal);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">int</span> startIndex = strVal.indexOf(<span class=\"keyword\">this</span>.placeholderPrefix);</span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> (startIndex != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">int</span> endIndex = findPlaceholderEndIndex(result, startIndex);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (endIndex != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t\tString placeholder = result.substring(startIndex + <span class=\"keyword\">this</span>.placeholderPrefix.length(), endIndex);</span><br><span class=\"line\">\t\t\t\tString originalPlaceholder = placeholder;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!visitedPlaceholders.add(originalPlaceholder)) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"string\">\"Circular placeholder reference '\"</span> + originalPlaceholder + <span class=\"string\">\"' in property definitions\"</span>);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Recursive invocation, parsing placeholders contained in the placeholder key.</span></span><br><span class=\"line\">\t\t\t\tplaceholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Now obtain the value for the fully resolved key...</span></span><br><span class=\"line\">\t\t\t\tString propVal = placeholderResolver.resolvePlaceholder(placeholder);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (propVal == <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.valueSeparator != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">int</span> separatorIndex = placeholder.indexOf(<span class=\"keyword\">this</span>.valueSeparator);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (separatorIndex != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tString actualPlaceholder = placeholder.substring(<span class=\"number\">0</span>, separatorIndex);</span><br><span class=\"line\">\t\t\t\t\t\tString defaultValue = placeholder.substring(separatorIndex + <span class=\"keyword\">this</span>.valueSeparator.length());</span><br><span class=\"line\">\t\t\t\t\t\tpropVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> (propVal == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tpropVal = defaultValue;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (propVal != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Recursive invocation, parsing placeholders contained in the</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// previously resolved placeholder value.</span></span><br><span class=\"line\">\t\t\t\t\tpropVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);</span><br><span class=\"line\">\t\t\t\t\tresult.replace(startIndex, endIndex + <span class=\"keyword\">this</span>.placeholderSuffix.length(), propVal);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogger.trace(<span class=\"string\">\"Resolved placeholder '\"</span> + placeholder + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tstartIndex = result.indexOf(<span class=\"keyword\">this</span>.placeholderPrefix, startIndex + propVal.length());</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.ignoreUnresolvablePlaceholders) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Proceed with unprocessed value.</span></span><br><span class=\"line\">\t\t\t\t\tstartIndex = result.indexOf(<span class=\"keyword\">this</span>.placeholderPrefix, endIndex + <span class=\"keyword\">this</span>.placeholderSuffix.length());</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"Could not resolve placeholder '\"</span> +</span><br><span class=\"line\">\t\t\t\t\t\t\tplaceholder + <span class=\"string\">\"'\"</span> + <span class=\"string\">\" in string value \\\"\"</span> + strVal + <span class=\"string\">\"\\\"\"</span>);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tvisitedPlaceholders.remove(originalPlaceholder);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tstartIndex = -<span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> result.toString();</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>实际解析的代码都在这里：</p>\n<ol>\n<li>取出placeHolder的名称.</li>\n<li>判断有没有循环引用的情况.</li>\n<li>递归替换，获取对应的值.</li>\n<li>如果值为空，解析默认值.</li>\n</ol>\n<h3 id=\"PropertyPlaceholderConfigurer\"><a href=\"#PropertyPlaceholderConfigurer\" class=\"headerlink\" title=\"PropertyPlaceholderConfigurer\"></a>PropertyPlaceholderConfigurer</h3><p>应该和上面的类似，抽时间补。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"lt-context-property-placeholder-location-39-xxx-39-gt-的解析过程\"><a href=\"#lt-context-property-placeholder-location-39-xxx-39-gt-的解析过程\" class=\"headerlink\" title=\"&lt;context:property-placeholder location=&#39;xxx&#39; /&gt;的解析过程\"></a><code>&lt;context:property-placeholder location=&#39;xxx&#39; /&gt;</code>的解析过程</h2><h3 id=\"schema\"><a href=\"#schema\" class=\"headerlink\" title=\"schema\"></a>schema</h3><p>在idea中<code>ctrl</code> + <code>b</code>或者，<code>ctrl</code> + 鼠标左键点击即可打开schema具体的位置</p>\n<img src=\"/2016/10/31/property-placeholder/location.jpg\">\n<p><code>sping.handlers</code>中内容如下:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler</span><br></pre></td></tr></table></figure>\n<p><code>spring.schemas</code>中的内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-2.5.xsd=org/springframework/context/config/spring-context-2.5.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-3.0.xsd=org/springframework/context/config/spring-context-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-3.1.xsd=org/springframework/context/config/spring-context-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-3.2.xsd=org/springframework/context/config/spring-context-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-4.0.xsd=org/springframework/context/config/spring-context-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-4.1.xsd=org/springframework/context/config/spring-context-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context-4.2.xsd=org/springframework/context/config/spring-context-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/context/spring-context.xsd=org/springframework/context/config/spring-context-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-2.0.xsd=org/springframework/ejb/config/spring-jee-2.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-2.5.xsd=org/springframework/ejb/config/spring-jee-2.5.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-3.0.xsd=org/springframework/ejb/config/spring-jee-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-3.1.xsd=org/springframework/ejb/config/spring-jee-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-3.2.xsd=org/springframework/ejb/config/spring-jee-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-4.0.xsd=org/springframework/ejb/config/spring-jee-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-4.1.xsd=org/springframework/ejb/config/spring-jee-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee-4.2.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/jee/spring-jee.xsd=org/springframework/ejb/config/spring-jee-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-2.0.xsd=org/springframework/scripting/config/spring-lang-2.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-2.5.xsd=org/springframework/scripting/config/spring-lang-2.5.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-3.0.xsd=org/springframework/scripting/config/spring-lang-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-3.1.xsd=org/springframework/scripting/config/spring-lang-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-3.2.xsd=org/springframework/scripting/config/spring-lang-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-4.0.xsd=org/springframework/scripting/config/spring-lang-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-4.1.xsd=org/springframework/scripting/config/spring-lang-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang-4.2.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/lang/spring-lang.xsd=org/springframework/scripting/config/spring-lang-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-3.0.xsd=org/springframework/scheduling/config/spring-task-3.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-3.1.xsd=org/springframework/scheduling/config/spring-task-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-3.2.xsd=org/springframework/scheduling/config/spring-task-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-4.0.xsd=org/springframework/scheduling/config/spring-task-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-4.1.xsd=org/springframework/scheduling/config/spring-task-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task-4.2.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/task/spring-task.xsd=org/springframework/scheduling/config/spring-task-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-3.1.xsd=org/springframework/cache/config/spring-cache-3.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-3.2.xsd=org/springframework/cache/config/spring-cache-3.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-4.0.xsd=org/springframework/cache/config/spring-cache-4.0.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-4.1.xsd=org/springframework/cache/config/spring-cache-4.1.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache-4.2.xsd=org/springframework/cache/config/spring-cache-4.2.xsd</span><br><span class=\"line\">http\\://www.springframework.org/schema/cache/spring-cache.xsd=org/springframework/cache/config/spring-cache-4.2.xsd</span><br></pre></td></tr></table></figure>\n<h3 id=\"NamespaceHandlerSupport\"><a href=\"#NamespaceHandlerSupport\" class=\"headerlink\" title=\"NamespaceHandlerSupport\"></a>NamespaceHandlerSupport</h3><p>从<code>handler</code>中我们可以找出<code>context</code>标签的处理类是<code>org.springframework.context.config.ContextNamespaceHandler</code>,内容如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ContextNamespaceHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"property-placeholder\"</span>, <span class=\"keyword\">new</span> PropertyPlaceholderBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"property-override\"</span>, <span class=\"keyword\">new</span> PropertyOverrideBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"annotation-config\"</span>, <span class=\"keyword\">new</span> AnnotationConfigBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"component-scan\"</span>, <span class=\"keyword\">new</span> ComponentScanBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"load-time-weaver\"</span>, <span class=\"keyword\">new</span> LoadTimeWeaverBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"spring-configured\"</span>, <span class=\"keyword\">new</span> SpringConfiguredBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"mbean-export\"</span>, <span class=\"keyword\">new</span> MBeanExportBeanDefinitionParser());</span><br><span class=\"line\">\t\tregisterBeanDefinitionParser(<span class=\"string\">\"mbean-server\"</span>, <span class=\"keyword\">new</span> MBeanServerBeanDefinitionParser());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>顺藤摸瓜就能找到<code>property-placeholder</code>的处理类是<code>PropertyPlaceholderBeanDefinitionParser</code></p>\n<h3 id=\"PropertyPlaceholderBeanDefinitionParser\"><a href=\"#PropertyPlaceholderBeanDefinitionParser\" class=\"headerlink\" title=\"PropertyPlaceholderBeanDefinitionParser\"></a>PropertyPlaceholderBeanDefinitionParser</h3><p>继承关系：</p>\n<img src=\"/2016/10/31/property-placeholder/hierarchy.jpg\">\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PropertyPlaceholderBeanDefinitionParser</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractPropertyLoadingBeanDefinitionParser</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SYSTEM_PROPERTIES_MODE_ATTRIBUTE = <span class=\"string\">\"system-properties-mode\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SYSTEM_PROPERTIES_MODE_DEFAULT = <span class=\"string\">\"ENVIRONMENT\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// As of Spring 3.1, the default value of system-properties-mode has changed from</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 'FALLBACK' to 'ENVIRONMENT'. This latter value indicates that resolution of</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// placeholders against system properties is a function of the Environment and</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// its current set of PropertySources.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (SYSTEM_PROPERTIES_MODE_DEFAULT.equals(element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE))) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> PropertySourcesPlaceholderConfigurer.class;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// The user has explicitly specified a value for system-properties-mode: revert to</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// PropertyPlaceholderConfigurer to ensure backward compatibility with 3.0 and earlier.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> PropertyPlaceholderConfigurer.class;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doParse</span><span class=\"params\">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">super</span>.doParse(element, builder);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.addPropertyValue(<span class=\"string\">\"ignoreUnresolvablePlaceholders\"</span>,</span><br><span class=\"line\">\t\t\t\tBoolean.valueOf(element.getAttribute(<span class=\"string\">\"ignore-unresolvable\"</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString systemPropertiesModeName = element.getAttribute(SYSTEM_PROPERTIES_MODE_ATTRIBUTE);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(systemPropertiesModeName) &amp;&amp;</span><br><span class=\"line\">\t\t\t\t!systemPropertiesModeName.equals(SYSTEM_PROPERTIES_MODE_DEFAULT)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"systemPropertiesModeName\"</span>, <span class=\"string\">\"SYSTEM_PROPERTIES_MODE_\"</span> + systemPropertiesModeName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (element.hasAttribute(<span class=\"string\">\"value-separator\"</span>)) &#123;    </span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"valueSeparator\"</span>, element.getAttribute(<span class=\"string\">\"value-separator\"</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (element.hasAttribute(<span class=\"string\">\"null-value\"</span>)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"nullValue\"</span>, element.getAttribute(<span class=\"string\">\"null-value\"</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在<code>getBeanClass</code>中，根据标签中的<code>system-properties-mode</code>属性来返回不同的类，来指明要实例化的类。</p>\n<p>再来看上述的<code>parse</code>方法，首先就是调用父类的<code>doParse</code>方法，然后就是解析标签中的相应属性，放到<code>BeanDefinitionBuilder</code>中，剩下的工作就交给spring这个框架来完成了。</p>\n<h4 id=\"system-properties-mode\"><a href=\"#system-properties-mode\" class=\"headerlink\" title=\"system-properties-mode\"></a><code>system-properties-mode</code></h4><p>决定解析placeholder的顺序。这个属性的取值如下：</p>\n<blockquote>\n<p>   <strong>“ENVIRONMENT”</strong> indicates placeholders should be resolved against the current Environment and against any local properties;</p>\n<p>   <strong>“NEVER”</strong> indicates placeholders should be resolved only against local properties and never against system properties;</p>\n<p>   <strong>“FALLBACK”</strong> indicates placeholders should be resolved against any local properties and then against system properties;</p>\n<p>   <strong>“OVERRIDE”</strong> indicates placeholders should be resolved first against system properties and then against any local properties;</p>\n</blockquote>\n<p>这个属性的默认值是<code>ENVIRONMENT</code>,也就是先从环境变量中解析，然后才从我们定义的properties文件中解析，如果环境中的变量名和配置文件中的变量名冲突，</p>\n<p>就会使用环境变量中的。</p>\n<blockquote>\n<p>所以配置文件中的变量名最好带一个前缀，如<code>jdbc.username=</code>, 笔者在Ubuntu下就遇到过不带前缀的<code>username</code>和系统的’username’冲突的情况</p>\n</blockquote>\n<h4 id=\"ignore-unresolvable\"><a href=\"#ignore-unresolvable\" class=\"headerlink\" title=\"ignore-unresolvable\"></a><code>ignore-unresolvable</code></h4><blockquote>\n<p>   Specifies if failure to find the property value to replace a key should be ignored.<br>    Default is “false”, meaning that this placeholder configurer will raise an exception<br>    if it cannot resolve a key. Set to “true” to allow the configurer to pass on the key<br>    to any others in the context that have not yet visited the key in question.</p>\n</blockquote>\n<p>这个属性很关键，他决定遇到无法解析的变量时是否抛出异常，默认是<code>fale</code>（抛出异常）,在有多个配置文件的时候应该设置为<code>true</code>。</p>\n<h4 id=\"value-separator\"><a href=\"#value-separator\" class=\"headerlink\" title=\"value-separator\"></a><code>value-separator</code></h4><p>placeHolder默认值得分隔符，默认是<code>:</code></p>\n<blockquote>\n<p>The separating character between the placeholder variable and the associated     default value: by default, a ‘:’ symbol.</p>\n</blockquote>\n<h4 id=\"null-value\"><a href=\"#null-value\" class=\"headerlink\" title=\"null-value\"></a><code>null-value</code></h4><blockquote>\n<p>   A value that should be treated as ‘null’ when resolved as a placeholder value:<br>    e.g. “” (empty String) or “null”. By default, no such null value is defined.</p>\n</blockquote>\n<p><strong>这些属性都可以在相应的<code>xsd</code>schema中找到。</strong></p>\n<h3 id=\"AbstractPropertyLoadingBeanDefinitionParser\"><a href=\"#AbstractPropertyLoadingBeanDefinitionParser\" class=\"headerlink\" title=\"AbstractPropertyLoadingBeanDefinitionParser\"></a>AbstractPropertyLoadingBeanDefinitionParser</h3><p>这是上面的那个解析类的父类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractPropertyLoadingBeanDefinitionParser</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">shouldGenerateId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doParse</span><span class=\"params\">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class=\"line\">\t\tString location = element.getAttribute(<span class=\"string\">\"location\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(location)) &#123;</span><br><span class=\"line\">\t\t\tString[] locations = StringUtils.commaDelimitedListToStringArray(location);</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"locations\"</span>, locations);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString propertiesRef = element.getAttribute(<span class=\"string\">\"properties-ref\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(propertiesRef)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyReference(<span class=\"string\">\"properties\"</span>, propertiesRef);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString fileEncoding = element.getAttribute(<span class=\"string\">\"file-encoding\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(fileEncoding)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"fileEncoding\"</span>, fileEncoding);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tString order = element.getAttribute(<span class=\"string\">\"order\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (StringUtils.hasLength(order)) &#123;</span><br><span class=\"line\">\t\t\tbuilder.addPropertyValue(<span class=\"string\">\"order\"</span>, Integer.valueOf(order));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.addPropertyValue(<span class=\"string\">\"ignoreResourceNotFound\"</span>,</span><br><span class=\"line\">\t\t\t\tBoolean.valueOf(element.getAttribute(<span class=\"string\">\"ignore-resource-not-found\"</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.addPropertyValue(<span class=\"string\">\"localOverride\"</span>,</span><br><span class=\"line\">\t\t\t\tBoolean.valueOf(element.getAttribute(<span class=\"string\">\"local-override\"</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbuilder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"shouldGenerateId\"><a href=\"#shouldGenerateId\" class=\"headerlink\" title=\"shouldGenerateId\"></a>shouldGenerateId</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Should an ID be generated instead of read from the passed in &#123;<span class=\"doctag\">@link</span> Element&#125;?</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;Disabled by default; subclasses can override this to enable ID generation.</span></span><br><span class=\"line\"><span class=\"comment\"> * Note that this flag is about &lt;i&gt;always&lt;/i&gt; generating an ID; the parser</span></span><br><span class=\"line\"><span class=\"comment\"> * won't even check for an \"id\" attribute in this case.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> whether the parser should always generate an id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">shouldGenerateId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"doParse\"><a href=\"#doParse\" class=\"headerlink\" title=\"doParse\"></a>doParse</h4><p>这个方法负责解析配置文件的location、file-encoding等通用的属性，并放置到<code>builder</code>中。</p>\n<h2 id=\"Spring-调用handler的过程\"><a href=\"#Spring-调用handler的过程\" class=\"headerlink\" title=\"Spring 调用handler的过程\"></a>Spring 调用handler的过程</h2><p>spring将特定的标签的解析委托给我们自己定义的handler的过程主要是在<code>DefaultBeanDefinitionDocumentReader</code>中<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Parse the elements at the root level in the document:</span></span><br><span class=\"line\"><span class=\"comment\">\t * \"import\", \"alias\", \"bean\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> root the DOM root element of the document</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">parseBeanDefinitions</span><span class=\"params\">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class=\"line\">\t\t\tNodeList nl = root.getChildNodes();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class=\"line\">\t\t\t\tNode node = nl.item(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (node <span class=\"keyword\">instanceof</span> Element) &#123;</span><br><span class=\"line\">\t\t\t\t\tElement ele = (Element) node;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tparseDefaultElement(ele, delegate);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\tdelegate.parseCustomElement(ele);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tdelegate.parseCustomElement(root);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>context</code>不是默认命名空间的标签，所以走<code>parseCustomElement</code>分支。</p>\n<p>走到<code>BeanDefinitionParserDelegate</code>的<code>parseCustomElement</code>方法中<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> BeanDefinition <span class=\"title\">parseCustomElement</span><span class=\"params\">(Element ele)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> parseCustomElement(ele, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> BeanDefinition <span class=\"title\">parseCustomElement</span><span class=\"params\">(Element ele, BeanDefinition containingBd)</span> </span>&#123;</span><br><span class=\"line\">\t\tString namespaceUri = getNamespaceURI(ele);</span><br><span class=\"line\">\t\tNamespaceHandler handler = <span class=\"keyword\">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (handler == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\terror(<span class=\"string\">\"Unable to locate Spring NamespaceHandler for XML schema namespace [\"</span> + namespaceUri + <span class=\"string\">\"]\"</span>, ele);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> handler.parse(ele, <span class=\"keyword\">new</span> ParserContext(<span class=\"keyword\">this</span>.readerContext, <span class=\"keyword\">this</span>, containingBd));</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这里从<code>NamespaceHandlerResolver</code>中根据<code>namespaceUri</code>获取到对应的<code>NamespaceHandler</code>,然后调用<code>handler</code>的<code>parse</code><br>方法进行解析，返回一个<code>BeanDefinition</code>，然后就注册到spring中了。</p>\n<p>这里的handler就是前面我们看到的实现了<code>NamespaceHandlerSupport</code>的那个<code>ContextNamespaceHandler</code>,<code>NamespaceHandlerSupport</code>继承自<code>NamespaceHandler</code>,它的parse 方法如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Parses the supplied &#123;<span class=\"doctag\">@link</span> Element&#125; by delegating to the &#123;<span class=\"doctag\">@link</span> BeanDefinitionParser&#125; that is</span></span><br><span class=\"line\"><span class=\"comment\">\t * registered for that &#123;<span class=\"doctag\">@link</span> Element&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> BeanDefinition <span class=\"title\">parse</span><span class=\"params\">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> findParserForElement(element, parserContext).parse(element, parserContext);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Locates the &#123;<span class=\"doctag\">@link</span> BeanDefinitionParser&#125; from the register implementations using</span></span><br><span class=\"line\"><span class=\"comment\">\t * the local name of the supplied &#123;<span class=\"doctag\">@link</span> Element&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> BeanDefinitionParser <span class=\"title\">findParserForElement</span><span class=\"params\">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class=\"line\">\t\tString localName = parserContext.getDelegate().getLocalName(element);</span><br><span class=\"line\">\t\tBeanDefinitionParser parser = <span class=\"keyword\">this</span>.parsers.get(localName);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (parser == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\tparserContext.getReaderContext().fatal(</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">\"Cannot locate BeanDefinitionParser for element [\"</span> + localName + <span class=\"string\">\"]\"</span>, element);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> parser;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>就是从在<code>init()</code>方法中注册的<code>Parser</code>,根据对应的标签前缀，获取到parser，对xml元素进行解析。</p>\n<h2 id=\"生效过程\"><a href=\"#生效过程\" class=\"headerlink\" title=\"生效过程\"></a>生效过程</h2><p>生效过程是在<code>BeanFactoryPostProcessor</code>被调用的过程中生效的, 继承关系</p>\n<img src=\"/2016/10/31/property-placeholder/post-processors.jpg\">\n<p>可以看到里面有两个熟悉的类——<code>PropertySourcesPlaceholderConfigurer</code>和<code>PropertyPlaceholderConfigurer</code>，正是<code>PropertyPlaceholderBeanDefinitionParser.getBeanClass</code>返回的两种类型, 也就是说他们两个是<code>BeanFactoryPostProcessor</code>.</p>\n<h3 id=\"PropertySourcesPlaceholderConfigurer\"><a href=\"#PropertySourcesPlaceholderConfigurer\" class=\"headerlink\" title=\"PropertySourcesPlaceholderConfigurer\"></a>PropertySourcesPlaceholderConfigurer</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@inheritDoc</span>&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Processing occurs by replacing $&#123;...&#125; placeholders in bean definitions by resolving each</span></span><br><span class=\"line\"><span class=\"comment\">\t * against this configurer's set of &#123;<span class=\"doctag\">@link</span> PropertySources&#125;, which includes:</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;all &#123;<span class=\"doctag\">@linkplain</span> org.springframework.core.env.ConfigurableEnvironment#getPropertySources</span></span><br><span class=\"line\"><span class=\"comment\">\t * environment property sources&#125;, if an &#123;<span class=\"doctag\">@code</span> Environment&#125; &#123;<span class=\"doctag\">@linkplain</span> #setEnvironment is present&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;&#123;<span class=\"doctag\">@linkplain</span> #mergeProperties merged local properties&#125;, if &#123;<span class=\"doctag\">@linkplain</span> #setLocation any&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@linkplain</span> #setLocations have&#125; &#123;<span class=\"doctag\">@linkplain</span> #setProperties been&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@linkplain</span> #setPropertiesArray specified&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;any property sources set by calling &#123;<span class=\"doctag\">@link</span> #setPropertySources&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;/ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;If &#123;<span class=\"doctag\">@link</span> #setPropertySources&#125; is called, &lt;strong&gt;environment and local properties will be</span></span><br><span class=\"line\"><span class=\"comment\">\t * ignored&lt;/strong&gt;. This method is designed to give the user fine-grained control over property</span></span><br><span class=\"line\"><span class=\"comment\">\t * sources, and once set, the configurer makes no assumptions about adding additional sources.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">postProcessBeanFactory</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactory)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.propertySources == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.propertySources = <span class=\"keyword\">new</span> MutablePropertySources();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.environment != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.propertySources.addLast(</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">new</span> PropertySource&lt;Environment&gt;(ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME, <span class=\"keyword\">this</span>.environment) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getProperty</span><span class=\"params\">(String key)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.source.getProperty(key);</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tPropertySource&lt;?&gt; localPropertySource =</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">new</span> PropertiesPropertySource(LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME, mergeProperties());</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.localOverride) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">this</span>.propertySources.addFirst(localPropertySource);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">this</span>.propertySources.addLast(localPropertySource);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BeanInitializationException(<span class=\"string\">\"Could not load properties\"</span>, ex);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tprocessProperties(beanFactory, <span class=\"keyword\">new</span> PropertySourcesPropertyResolver(<span class=\"keyword\">this</span>.propertySources));</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.appliedPropertySources = <span class=\"keyword\">this</span>.propertySources;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>注意上述的<code>localOverride</code>变量，它决定了是否用本地的替换系统的，主要是用加载的顺序呢控制的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* &lt;p&gt;Any local properties (e.g. those added via &#123;<span class=\"doctag\">@link</span> #setProperties&#125;, &#123;<span class=\"doctag\">@link</span> #setLocations&#125;</span></span><br><span class=\"line\"><span class=\"comment\">* et al.) are added as a &#123;<span class=\"doctag\">@code</span> PropertySource&#125;. Search precedence of local properties is</span></span><br><span class=\"line\"><span class=\"comment\">* based on the value of the &#123;<span class=\"doctag\">@link</span> #setLocalOverride localOverride&#125; property, which is by</span></span><br><span class=\"line\"><span class=\"comment\">* default &#123;<span class=\"doctag\">@code</span> false&#125; meaning that local properties are to be searched last, after all</span></span><br><span class=\"line\"><span class=\"comment\">* environment property sources.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>获取到所有的属性列表后，处理属性就交给了<code>processProperties</code>这个方法.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Visit each bean definition in the given bean factory and attempt to replace $&#123;...&#125; property</span></span><br><span class=\"line\"><span class=\"comment\">\t * placeholders with values from the given properties.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">processProperties</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t<span class=\"keyword\">final</span> ConfigurablePropertyResolver propertyResolver)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpropertyResolver.setPlaceholderPrefix(<span class=\"keyword\">this</span>.placeholderPrefix);</span><br><span class=\"line\">\t\tpropertyResolver.setPlaceholderSuffix(<span class=\"keyword\">this</span>.placeholderSuffix);</span><br><span class=\"line\">\t\tpropertyResolver.setValueSeparator(<span class=\"keyword\">this</span>.valueSeparator);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tStringValueResolver valueResolver = <span class=\"keyword\">new</span> StringValueResolver() &#123;</span><br><span class=\"line\">\t\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolveStringValue</span><span class=\"params\">(String strVal)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t\tString resolved = ignoreUnresolvablePlaceholders ?</span><br><span class=\"line\">\t\t\t\t\t\tpropertyResolver.resolvePlaceholders(strVal) :</span><br><span class=\"line\">\t\t\t\t\t\tpropertyResolver.resolveRequiredPlaceholders(strVal);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> (resolved.equals(nullValue) ? <span class=\"keyword\">null</span> : resolved);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tdoProcessProperties(beanFactoryToProcess, valueResolver);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>先设置propertyResolver的prefix（默认是${}）和suffix(默认是})，以及默认值得分隔符(默认是:).</p>\n<p>然后创建了一个StringValueResolver, 这里根据<code>ignoreUnresolvablePlaceholders</code>的值来进行不同的解析，</p>\n<p>这个值默认是false, 但是可以在标签中配置。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xsd:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ignore-unresolvable\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:boolean\"</span> <span class=\"attr\">default</span>=<span class=\"string\">\"false\"</span>&gt;</span></span><br><span class=\"line\">\t\t\t<span class=\"tag\">&lt;<span class=\"name\">xsd:annotation</span>&gt;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"tag\">&lt;<span class=\"name\">xsd:documentation</span>&gt;</span>&lt;![CDATA[</span><br><span class=\"line\">\tSpecifies if failure to find the property value to replace a key should be ignored.</span><br><span class=\"line\">\tDefault is \"false\", meaning that this placeholder configurer will raise an exception</span><br><span class=\"line\">\tif it cannot resolve a key. Set to \"true\" to allow the configurer to pass on the key</span><br><span class=\"line\">\tto any others in the context that have not yet visited the key in question.</span><br><span class=\"line\">\t\t\t\t]]&gt;<span class=\"tag\">&lt;/<span class=\"name\">xsd:documentation</span>&gt;</span></span><br><span class=\"line\">\t\t\t<span class=\"tag\">&lt;/<span class=\"name\">xsd:annotation</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;/<span class=\"name\">xsd:attribute</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p><code>false</code>就以为者遇到无法解析的值就会直接抛出异常</p>\n<p>接下来看看<code>doProcessProperties</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doProcessProperties</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactoryToProcess,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\tStringValueResolver valueResolver)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tBeanDefinitionVisitor visitor = <span class=\"keyword\">new</span> BeanDefinitionVisitor(valueResolver);</span><br><span class=\"line\"></span><br><span class=\"line\">\tString[] beanNames = beanFactoryToProcess.getBeanDefinitionNames();</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (String curName : beanNames) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Check that we're not parsing our own bean definition,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// to avoid failing on unresolvable placeholders in properties file locations.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!(curName.equals(<span class=\"keyword\">this</span>.beanName) &amp;&amp; beanFactoryToProcess.equals(<span class=\"keyword\">this</span>.beanFactory))) &#123;</span><br><span class=\"line\">\t\t\tBeanDefinition bd = beanFactoryToProcess.getBeanDefinition(curName);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tvisitor.visitBeanDefinition(bd);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BeanDefinitionStoreException(bd.getResourceDescription(), curName, ex.getMessage(), ex);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// New in Spring 2.5: resolve placeholders in alias target names and aliases as well.</span></span><br><span class=\"line\">\tbeanFactoryToProcess.resolveAliases(valueResolver);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// New in Spring 3.0: resolve placeholders in embedded values such as annotation attributes.</span></span><br><span class=\"line\">\tbeanFactoryToProcess.addEmbeddedValueResolver(valueResolver);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里采用的是visitor模式，查看<code>BeanDefinitionVisitor#visitBeanDefinition</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Traverse the given BeanDefinition object and the MutablePropertyValues</span></span><br><span class=\"line\"><span class=\"comment\">\t * and ConstructorArgumentValues contained in them.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> beanDefinition the BeanDefinition object to traverse</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #resolveStringValue(String)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">visitBeanDefinition</span><span class=\"params\">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class=\"line\">\t\tvisitParentName(beanDefinition);</span><br><span class=\"line\">\t\tvisitBeanClassName(beanDefinition);</span><br><span class=\"line\">\t\tvisitFactoryBeanName(beanDefinition);</span><br><span class=\"line\">\t\tvisitFactoryMethodName(beanDefinition);</span><br><span class=\"line\">\t\tvisitScope(beanDefinition);</span><br><span class=\"line\">\t\tvisitPropertyValues(beanDefinition.getPropertyValues());</span><br><span class=\"line\">\t\tConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues();</span><br><span class=\"line\">\t\tvisitIndexedArgumentValues(cas.getIndexedArgumentValues());</span><br><span class=\"line\">\t\tvisitGenericArgumentValues(cas.getGenericArgumentValues());</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>以其中的<code>visitParentName</code>为例：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">visitParentName</span><span class=\"params\">(BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class=\"line\">\tString parentName = beanDefinition.getParentName();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (parentName != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\tString resolvedName = resolveStringValue(parentName);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!parentName.equals(resolvedName)) &#123;</span><br><span class=\"line\">\t\t\tbeanDefinition.setParentName(resolvedName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>就是先获取<code>parentName</code>，然后替换相应的属性之后的<code>resolvedName</code>,如果和原来的不一样就设置<code>resolvedName</code></p>\n<p>为新的parentName</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Resolve the given String value, for example parsing placeholders.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> strVal the original String value</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the resolved String value</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> String <span class=\"title\">resolveStringValue</span><span class=\"params\">(String strVal)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.valueResolver == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"No StringValueResolver specified - pass a resolver \"</span> +</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">\"object into the constructor or override the 'resolveStringValue' method\"</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tString resolvedValue = <span class=\"keyword\">this</span>.valueResolver.resolveStringValue(strVal);</span><br><span class=\"line\">\t<span class=\"comment\">// Return original String if not modified.</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (strVal.equals(resolvedValue) ? strVal : resolvedValue);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>顺藤摸瓜,看看<code>valueResolver</code>,就是之前的<code>StringValueResolver</code></p>\n<p>这是一个接口只有一个方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StringValueResolver</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Resolve the given String value, for example parsing placeholders.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> strVal the original String value</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the resolved String value</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">String <span class=\"title\">resolveStringValue</span><span class=\"params\">(String strVal)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>之前传入的其实就是对应<code>ConfigurablePropertyResolver</code>的两个方法, 之前传入的是它的子类</p>\n<p><code>PropertySourcesPropertyResolver</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolvePlaceholders</span><span class=\"params\">(String text)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.nonStrictHelper == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.nonStrictHelper = createPlaceholderHelper(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> doResolvePlaceholders(text, <span class=\"keyword\">this</span>.nonStrictHelper);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolveRequiredPlaceholders</span><span class=\"params\">(String text)</span> <span class=\"keyword\">throws</span> IllegalArgumentException </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.strictHelper == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.strictHelper = createPlaceholderHelper(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> doResolvePlaceholders(text, <span class=\"keyword\">this</span>.strictHelper);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>调用的是内部方法:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">doResolvePlaceholders</span><span class=\"params\">(String text, PropertyPlaceholderHelper helper)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> helper.replacePlaceholders(text, <span class=\"keyword\">new</span> PropertyPlaceholderHelper.PlaceholderResolver() &#123;</span><br><span class=\"line\">\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resolvePlaceholder</span><span class=\"params\">(String placeholderName)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> getPropertyAsRawString(placeholderName);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终调用功能的是<code>PropertyPlaceholderHelper</code>的replacePlaceholders方法，</p>\n<p>这个helper在构造是通过 <code>createPlaceholderHelper</code>方法构建的，他接受一个bool类型的参数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> PropertyPlaceholderHelper <span class=\"title\">createPlaceholderHelper</span><span class=\"params\">(<span class=\"keyword\">boolean</span> ignoreUnresolvablePlaceholders)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PropertyPlaceholderHelper(<span class=\"keyword\">this</span>.placeholderPrefix, <span class=\"keyword\">this</span>.placeholderSuffix,</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.valueSeparator, ignoreUnresolvablePlaceholders);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这个bool值就是表示是否要ignore掉不能解析的属性。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Creates a new &#123;<span class=\"doctag\">@code</span> PropertyPlaceholderHelper&#125; that uses the supplied prefix and suffix.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> placeholderPrefix the prefix that denotes the start of a placeholder</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> placeholderSuffix the suffix that denotes the end of a placeholder</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> valueSeparator the separating character between the placeholder variable</span></span><br><span class=\"line\"><span class=\"comment\">\t * and the associated default value, if any</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> ignoreUnresolvablePlaceholders indicates whether unresolvable placeholders should</span></span><br><span class=\"line\"><span class=\"comment\">\t * be ignored (&#123;<span class=\"doctag\">@code</span> true&#125;) or cause an exception (&#123;<span class=\"doctag\">@code</span> false&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br></pre></td></tr></table></figure>\n<p>接着追</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Replaces all placeholders of format &#123;<span class=\"doctag\">@code</span> $&#123;name&#125;&#125; with the value returned</span></span><br><span class=\"line\"><span class=\"comment\"> * from the supplied &#123;<span class=\"doctag\">@link</span> PlaceholderResolver&#125;.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> value the value containing the placeholders to be replaced</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> placeholderResolver the &#123;<span class=\"doctag\">@code</span> PlaceholderResolver&#125; to use for replacement</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the supplied value with placeholders replaced inline</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">replacePlaceholders</span><span class=\"params\">(String value, PlaceholderResolver placeholderResolver)</span> </span>&#123;</span><br><span class=\"line\">\tAssert.notNull(value, <span class=\"string\">\"'value' must not be null\"</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> parseStringValue(value, placeholderResolver, <span class=\"keyword\">new</span> HashSet&lt;String&gt;());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> String <span class=\"title\">parseStringValue</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tString strVal, PlaceholderResolver placeholderResolver, Set&lt;String&gt; visitedPlaceholders)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tStringBuilder result = <span class=\"keyword\">new</span> StringBuilder(strVal);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">int</span> startIndex = strVal.indexOf(<span class=\"keyword\">this</span>.placeholderPrefix);</span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> (startIndex != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">int</span> endIndex = findPlaceholderEndIndex(result, startIndex);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (endIndex != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t\tString placeholder = result.substring(startIndex + <span class=\"keyword\">this</span>.placeholderPrefix.length(), endIndex);</span><br><span class=\"line\">\t\t\t\tString originalPlaceholder = placeholder;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!visitedPlaceholders.add(originalPlaceholder)) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"string\">\"Circular placeholder reference '\"</span> + originalPlaceholder + <span class=\"string\">\"' in property definitions\"</span>);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Recursive invocation, parsing placeholders contained in the placeholder key.</span></span><br><span class=\"line\">\t\t\t\tplaceholder = parseStringValue(placeholder, placeholderResolver, visitedPlaceholders);</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Now obtain the value for the fully resolved key...</span></span><br><span class=\"line\">\t\t\t\tString propVal = placeholderResolver.resolvePlaceholder(placeholder);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (propVal == <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.valueSeparator != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">int</span> separatorIndex = placeholder.indexOf(<span class=\"keyword\">this</span>.valueSeparator);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (separatorIndex != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tString actualPlaceholder = placeholder.substring(<span class=\"number\">0</span>, separatorIndex);</span><br><span class=\"line\">\t\t\t\t\t\tString defaultValue = placeholder.substring(separatorIndex + <span class=\"keyword\">this</span>.valueSeparator.length());</span><br><span class=\"line\">\t\t\t\t\t\tpropVal = placeholderResolver.resolvePlaceholder(actualPlaceholder);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> (propVal == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tpropVal = defaultValue;</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (propVal != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Recursive invocation, parsing placeholders contained in the</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// previously resolved placeholder value.</span></span><br><span class=\"line\">\t\t\t\t\tpropVal = parseStringValue(propVal, placeholderResolver, visitedPlaceholders);</span><br><span class=\"line\">\t\t\t\t\tresult.replace(startIndex, endIndex + <span class=\"keyword\">this</span>.placeholderSuffix.length(), propVal);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogger.trace(<span class=\"string\">\"Resolved placeholder '\"</span> + placeholder + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tstartIndex = result.indexOf(<span class=\"keyword\">this</span>.placeholderPrefix, startIndex + propVal.length());</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.ignoreUnresolvablePlaceholders) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Proceed with unprocessed value.</span></span><br><span class=\"line\">\t\t\t\t\tstartIndex = result.indexOf(<span class=\"keyword\">this</span>.placeholderPrefix, endIndex + <span class=\"keyword\">this</span>.placeholderSuffix.length());</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">\"Could not resolve placeholder '\"</span> +</span><br><span class=\"line\">\t\t\t\t\t\t\tplaceholder + <span class=\"string\">\"'\"</span> + <span class=\"string\">\" in string value \\\"\"</span> + strVal + <span class=\"string\">\"\\\"\"</span>);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tvisitedPlaceholders.remove(originalPlaceholder);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tstartIndex = -<span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> result.toString();</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>实际解析的代码都在这里：</p>\n<ol>\n<li>取出placeHolder的名称.</li>\n<li>判断有没有循环引用的情况.</li>\n<li>递归替换，获取对应的值.</li>\n<li>如果值为空，解析默认值.</li>\n</ol>\n<h3 id=\"PropertyPlaceholderConfigurer\"><a href=\"#PropertyPlaceholderConfigurer\" class=\"headerlink\" title=\"PropertyPlaceholderConfigurer\"></a>PropertyPlaceholderConfigurer</h3><p>应该和上面的类似，抽时间补。</p>\n"},{"title":"Java SPI 总结","toc":true,"abbrlink":41105,"date":"2016-12-17T13:39:32.000Z","_content":"\n\n## SPI ABC\n\nSPI 代表`Service Provider Interfaces`, 是一种服务提供发现的机制。JDK中为其提供了`ServiceLoader`用来加载接口对应的实现。\n\n## 使用约定\n\n{%  asset_img  usage.jpg  使用约定  %}\n\n\n\n\n```\n\n└── src\n├── com\n│   └── ivanzhang\n│       └── spi\n│           ├── HelloInterface.java\n│           ├── impl\n│           │   ├── ImageHello.java\n│           │   └── TextHello.java\n│           └── SPIMain.java\n└── META-INF\n    └── services\n        └── com.ivanzhang.spi.HelloInterface\n\n```\n\n## 使用例子\n\n- common-logging\n\n> common-logging，apache最早提供的日志的门面接口。只有接口，没有实现。具体方案由各提供商实现，发现日志提供商是通过扫描 META-INF/services/org.apache.commons.logging.LogFactory配置文件，通过读取该文件的内容找到日志提工商实现类。只要我们的日志实现里包含了这个文件，并在文件里制定 LogFactory工厂接口的实现类即可。\n\n- jdbc\n\n> jdbc4.0以前，开发还需要基于Class.forName(\"xxx\")的方式来装载驱动，jdbc4也基于spi的机制来发现驱动提供商了，可以通过META-INF/services/java.sql.Driver文件里指定实现类的方式来暴露驱动提供者。\n\n*其他用途：*\n\n* Java Database Connectivity\n* Java Cryptography Extension\n* Java Naming and Directory Interface\n* Java API for XML Processing\n* Java Business Integration\n* Java Sound\n* Java Image I/O\n* Java File Systems\n\n## 参考\n\n1. [Java的SPI机制与简单示例](http://www.solinx.co/archives/142)\n\n2. [Java SPI机制简介 - oschina](https://my.oschina.net/u/1034176/blog/659445)\n\n3. [Java SPI机制简介 - 技术宅](http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/)\n\n4. [Introduction to the Service Provider Interfaces](https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html)\n\n5. [谈java SPI机制、spring-mvc启动及servlet3.0](http://www.jianshu.com/p/bd36c023ddf0)\n\n6. [Service Provider Interface](https://en.wikipedia.org/wiki/Service_provider_interface)\n\n7. [Replaceable Components and the Service Provider Interface ](http://resources.sei.cmu.edu/asset_files/TechnicalNote/2002_004_001_13958.pdf)","source":"_posts/spi.md","raw":"---\ntitle: Java SPI 总结\ntags: spi\ncategory: java\ntoc: true\nabbrlink: 41105\ndate: 2016-12-17 21:39:32\n---\n\n\n## SPI ABC\n\nSPI 代表`Service Provider Interfaces`, 是一种服务提供发现的机制。JDK中为其提供了`ServiceLoader`用来加载接口对应的实现。\n\n## 使用约定\n\n{%  asset_img  usage.jpg  使用约定  %}\n\n\n\n\n```\n\n└── src\n├── com\n│   └── ivanzhang\n│       └── spi\n│           ├── HelloInterface.java\n│           ├── impl\n│           │   ├── ImageHello.java\n│           │   └── TextHello.java\n│           └── SPIMain.java\n└── META-INF\n    └── services\n        └── com.ivanzhang.spi.HelloInterface\n\n```\n\n## 使用例子\n\n- common-logging\n\n> common-logging，apache最早提供的日志的门面接口。只有接口，没有实现。具体方案由各提供商实现，发现日志提供商是通过扫描 META-INF/services/org.apache.commons.logging.LogFactory配置文件，通过读取该文件的内容找到日志提工商实现类。只要我们的日志实现里包含了这个文件，并在文件里制定 LogFactory工厂接口的实现类即可。\n\n- jdbc\n\n> jdbc4.0以前，开发还需要基于Class.forName(\"xxx\")的方式来装载驱动，jdbc4也基于spi的机制来发现驱动提供商了，可以通过META-INF/services/java.sql.Driver文件里指定实现类的方式来暴露驱动提供者。\n\n*其他用途：*\n\n* Java Database Connectivity\n* Java Cryptography Extension\n* Java Naming and Directory Interface\n* Java API for XML Processing\n* Java Business Integration\n* Java Sound\n* Java Image I/O\n* Java File Systems\n\n## 参考\n\n1. [Java的SPI机制与简单示例](http://www.solinx.co/archives/142)\n\n2. [Java SPI机制简介 - oschina](https://my.oschina.net/u/1034176/blog/659445)\n\n3. [Java SPI机制简介 - 技术宅](http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/)\n\n4. [Introduction to the Service Provider Interfaces](https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html)\n\n5. [谈java SPI机制、spring-mvc启动及servlet3.0](http://www.jianshu.com/p/bd36c023ddf0)\n\n6. [Service Provider Interface](https://en.wikipedia.org/wiki/Service_provider_interface)\n\n7. [Replaceable Components and the Service Provider Interface ](http://resources.sei.cmu.edu/asset_files/TechnicalNote/2002_004_001_13958.pdf)","slug":"spi","published":1,"updated":"2017-04-16T12:03:23.405Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdai0097jh4k3jm4qk8v","content":"<h2 id=\"SPI-ABC\"><a href=\"#SPI-ABC\" class=\"headerlink\" title=\"SPI ABC\"></a>SPI ABC</h2><p>SPI 代表<code>Service Provider Interfaces</code>, 是一种服务提供发现的机制。JDK中为其提供了<code>ServiceLoader</code>用来加载接口对应的实现。</p>\n<h2 id=\"使用约定\"><a href=\"#使用约定\" class=\"headerlink\" title=\"使用约定\"></a>使用约定</h2><img src=\"/2016/12/17/spi/usage.jpg\" title=\"使用约定\">\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">└── src</span><br><span class=\"line\">├── com</span><br><span class=\"line\">│   └── ivanzhang</span><br><span class=\"line\">│       └── spi</span><br><span class=\"line\">│           ├── HelloInterface.java</span><br><span class=\"line\">│           ├── impl</span><br><span class=\"line\">│           │   ├── ImageHello.java</span><br><span class=\"line\">│           │   └── TextHello.java</span><br><span class=\"line\">│           └── SPIMain.java</span><br><span class=\"line\">└── META-INF</span><br><span class=\"line\">    └── services</span><br><span class=\"line\">        └── com.ivanzhang.spi.HelloInterface</span><br></pre></td></tr></table></figure>\n<h2 id=\"使用例子\"><a href=\"#使用例子\" class=\"headerlink\" title=\"使用例子\"></a>使用例子</h2><ul>\n<li>common-logging</li>\n</ul>\n<blockquote>\n<p>common-logging，apache最早提供的日志的门面接口。只有接口，没有实现。具体方案由各提供商实现，发现日志提供商是通过扫描 META-INF/services/org.apache.commons.logging.LogFactory配置文件，通过读取该文件的内容找到日志提工商实现类。只要我们的日志实现里包含了这个文件，并在文件里制定 LogFactory工厂接口的实现类即可。</p>\n</blockquote>\n<ul>\n<li>jdbc</li>\n</ul>\n<blockquote>\n<p>jdbc4.0以前，开发还需要基于Class.forName(“xxx”)的方式来装载驱动，jdbc4也基于spi的机制来发现驱动提供商了，可以通过META-INF/services/java.sql.Driver文件里指定实现类的方式来暴露驱动提供者。</p>\n</blockquote>\n<p><em>其他用途：</em></p>\n<ul>\n<li>Java Database Connectivity</li>\n<li>Java Cryptography Extension</li>\n<li>Java Naming and Directory Interface</li>\n<li>Java API for XML Processing</li>\n<li>Java Business Integration</li>\n<li>Java Sound</li>\n<li>Java Image I/O</li>\n<li>Java File Systems</li>\n</ul>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.solinx.co/archives/142\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java的SPI机制与简单示例</a></p>\n</li>\n<li><p><a href=\"https://my.oschina.net/u/1034176/blog/659445\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SPI机制简介 - oschina</a></p>\n</li>\n<li><p><a href=\"http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SPI机制简介 - 技术宅</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Introduction to the Service Provider Interfaces</a></p>\n</li>\n<li><p><a href=\"http://www.jianshu.com/p/bd36c023ddf0\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">谈java SPI机制、spring-mvc启动及servlet3.0</a></p>\n</li>\n<li><p><a href=\"https://en.wikipedia.org/wiki/Service_provider_interface\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Service Provider Interface</a></p>\n</li>\n<li><p><a href=\"http://resources.sei.cmu.edu/asset_files/TechnicalNote/2002_004_001_13958.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Replaceable Components and the Service Provider Interface </a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"SPI-ABC\"><a href=\"#SPI-ABC\" class=\"headerlink\" title=\"SPI ABC\"></a>SPI ABC</h2><p>SPI 代表<code>Service Provider Interfaces</code>, 是一种服务提供发现的机制。JDK中为其提供了<code>ServiceLoader</code>用来加载接口对应的实现。</p>\n<h2 id=\"使用约定\"><a href=\"#使用约定\" class=\"headerlink\" title=\"使用约定\"></a>使用约定</h2><img src=\"/2016/12/17/spi/usage.jpg\" title=\"使用约定\">\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">└── src</span><br><span class=\"line\">├── com</span><br><span class=\"line\">│   └── ivanzhang</span><br><span class=\"line\">│       └── spi</span><br><span class=\"line\">│           ├── HelloInterface.java</span><br><span class=\"line\">│           ├── impl</span><br><span class=\"line\">│           │   ├── ImageHello.java</span><br><span class=\"line\">│           │   └── TextHello.java</span><br><span class=\"line\">│           └── SPIMain.java</span><br><span class=\"line\">└── META-INF</span><br><span class=\"line\">    └── services</span><br><span class=\"line\">        └── com.ivanzhang.spi.HelloInterface</span><br></pre></td></tr></table></figure>\n<h2 id=\"使用例子\"><a href=\"#使用例子\" class=\"headerlink\" title=\"使用例子\"></a>使用例子</h2><ul>\n<li>common-logging</li>\n</ul>\n<blockquote>\n<p>common-logging，apache最早提供的日志的门面接口。只有接口，没有实现。具体方案由各提供商实现，发现日志提供商是通过扫描 META-INF/services/org.apache.commons.logging.LogFactory配置文件，通过读取该文件的内容找到日志提工商实现类。只要我们的日志实现里包含了这个文件，并在文件里制定 LogFactory工厂接口的实现类即可。</p>\n</blockquote>\n<ul>\n<li>jdbc</li>\n</ul>\n<blockquote>\n<p>jdbc4.0以前，开发还需要基于Class.forName(“xxx”)的方式来装载驱动，jdbc4也基于spi的机制来发现驱动提供商了，可以通过META-INF/services/java.sql.Driver文件里指定实现类的方式来暴露驱动提供者。</p>\n</blockquote>\n<p><em>其他用途：</em></p>\n<ul>\n<li>Java Database Connectivity</li>\n<li>Java Cryptography Extension</li>\n<li>Java Naming and Directory Interface</li>\n<li>Java API for XML Processing</li>\n<li>Java Business Integration</li>\n<li>Java Sound</li>\n<li>Java Image I/O</li>\n<li>Java File Systems</li>\n</ul>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://www.solinx.co/archives/142\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java的SPI机制与简单示例</a></p>\n</li>\n<li><p><a href=\"https://my.oschina.net/u/1034176/blog/659445\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SPI机制简介 - oschina</a></p>\n</li>\n<li><p><a href=\"http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Java SPI机制简介 - 技术宅</a></p>\n</li>\n<li><p><a href=\"https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Introduction to the Service Provider Interfaces</a></p>\n</li>\n<li><p><a href=\"http://www.jianshu.com/p/bd36c023ddf0\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">谈java SPI机制、spring-mvc启动及servlet3.0</a></p>\n</li>\n<li><p><a href=\"https://en.wikipedia.org/wiki/Service_provider_interface\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Service Provider Interface</a></p>\n</li>\n<li><p><a href=\"http://resources.sei.cmu.edu/asset_files/TechnicalNote/2002_004_001_13958.pdf\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Replaceable Components and the Service Provider Interface </a></p>\n</li>\n</ol>\n"},{"title":"spring 采用Mock的方式进行单元测试","toc":true,"abbrlink":15023,"date":"2016-09-25T15:44:53.000Z","_content":"\n## Spring & Mockito\n\n在Spring中，采用完全mock的方式进行单元测试，借助Mockito框架\n\n{% gist 3ad39c82972ed66de3d5934f1cdcedaa %}\n","source":"_posts/spring-mockMvc.md","raw":"---\ntitle: spring 采用Mock的方式进行单元测试\ntags: spring mvc\ncategory: spring\ntoc: true\nabbrlink: 15023\ndate: 2016-09-25 23:44:53\n---\n\n## Spring & Mockito\n\n在Spring中，采用完全mock的方式进行单元测试，借助Mockito框架\n\n{% gist 3ad39c82972ed66de3d5934f1cdcedaa %}\n","slug":"spring-mockMvc","published":1,"updated":"2017-04-16T12:03:23.405Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdaj009ajh4kv39oznl5","content":"<h2 id=\"Spring-amp-Mockito\"><a href=\"#Spring-amp-Mockito\" class=\"headerlink\" title=\"Spring &amp; Mockito\"></a>Spring &amp; Mockito</h2><p>在Spring中，采用完全mock的方式进行单元测试，借助Mockito框架</p>\n<script src=\"//gist.github.com/3ad39c82972ed66de3d5934f1cdcedaa.js\"></script>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Spring-amp-Mockito\"><a href=\"#Spring-amp-Mockito\" class=\"headerlink\" title=\"Spring &amp; Mockito\"></a>Spring &amp; Mockito</h2><p>在Spring中，采用完全mock的方式进行单元测试，借助Mockito框架</p>\n<script src=\"//gist.github.com/3ad39c82972ed66de3d5934f1cdcedaa.js\"></script>\n"},{"title":"ssh免密码登录设置","toc":true,"abbrlink":14062,"date":"2015-10-08T08:00:08.000Z","_content":"\n## 应用场景\n  现有A和B两台机器，我们要实现A在ssh登录到B的时候不用输入密码，B->A的过程类似\n## 具体过程\n  1. 在**A机器**上，生成 ssh 公钥密钥对\n\t``` bash\n\t$ ssh-keygen -t rsa\n\t```\n  2.  生成的文件存在 ~/.ssh/目录下，windows存在C\\Users\\your_name\\.ssh\\ 目录下\n\tid_rsa是私钥，id_rsa.pub是公钥\n\n  3.  将A中生成的公钥加入到**B机器**的 authorized_keys 这个文件中，默认目录linux下是~/.ssh/ ，没有的话可以自己新建\n\t拷贝的过程可以使用以下命令\n\t``` bash\n\t$ ssh-copy-id -i 公钥文件路径 -p ssh端口  user@server\n\t```\n\t>ssh-copy-id  -  install  your  public  key in a remote machine's autho‐rized_keys. \n\t>If the  -i  option  is  given  then  the  identity  file  (defaults  to ~/.ssh/id_rsa.pub) is used,\n\t>regardless of whether there are any keys in your ssh-agent.\n\n此时A机器 ssh 登录B机器是不需要密码的\n\n\n\n","source":"_posts/ssh-passwd-free.md","raw":"---\ntitle: ssh免密码登录设置\ntags: ssh\ncategory: linux\ntoc: true\nabbrlink: 14062\ndate: 2015-10-08 16:00:08\n---\n\n## 应用场景\n  现有A和B两台机器，我们要实现A在ssh登录到B的时候不用输入密码，B->A的过程类似\n## 具体过程\n  1. 在**A机器**上，生成 ssh 公钥密钥对\n\t``` bash\n\t$ ssh-keygen -t rsa\n\t```\n  2.  生成的文件存在 ~/.ssh/目录下，windows存在C\\Users\\your_name\\.ssh\\ 目录下\n\tid_rsa是私钥，id_rsa.pub是公钥\n\n  3.  将A中生成的公钥加入到**B机器**的 authorized_keys 这个文件中，默认目录linux下是~/.ssh/ ，没有的话可以自己新建\n\t拷贝的过程可以使用以下命令\n\t``` bash\n\t$ ssh-copy-id -i 公钥文件路径 -p ssh端口  user@server\n\t```\n\t>ssh-copy-id  -  install  your  public  key in a remote machine's autho‐rized_keys. \n\t>If the  -i  option  is  given  then  the  identity  file  (defaults  to ~/.ssh/id_rsa.pub) is used,\n\t>regardless of whether there are any keys in your ssh-agent.\n\n此时A机器 ssh 登录B机器是不需要密码的\n\n\n\n","slug":"ssh-passwd-free","published":1,"updated":"2017-04-16T12:03:23.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdak009cjh4kxvhd09ha","content":"<h2 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h2><p>  现有A和B两台机器，我们要实现A在ssh登录到B的时候不用输入密码，B-&gt;A的过程类似</p>\n<h2 id=\"具体过程\"><a href=\"#具体过程\" class=\"headerlink\" title=\"具体过程\"></a>具体过程</h2><ol>\n<li><p>在<strong>A机器</strong>上，生成 ssh 公钥密钥对</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>生成的文件存在 ~/.ssh/目录下，windows存在C\\Users\\your_name.ssh\\ 目录下<br>id_rsa是私钥，id_rsa.pub是公钥</p>\n</li>\n<li><p>将A中生成的公钥加入到<strong>B机器</strong>的 authorized_keys 这个文件中，默认目录linux下是~/.ssh/ ，没有的话可以自己新建<br>拷贝的过程可以使用以下命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-copy-id -i 公钥文件路径 -p ssh端口  user@server</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ssh-copy-id  -  install  your  public  key in a remote machine’s autho‐rized_keys.<br>If the  -i  option  is  given  then  the  identity  file  (defaults  to ~/.ssh/id_rsa.pub) is used,<br>regardless of whether there are any keys in your ssh-agent.</p>\n</blockquote>\n</li>\n</ol>\n<p>此时A机器 ssh 登录B机器是不需要密码的</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h2><p>  现有A和B两台机器，我们要实现A在ssh登录到B的时候不用输入密码，B-&gt;A的过程类似</p>\n<h2 id=\"具体过程\"><a href=\"#具体过程\" class=\"headerlink\" title=\"具体过程\"></a>具体过程</h2><ol>\n<li><p>在<strong>A机器</strong>上，生成 ssh 公钥密钥对</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>生成的文件存在 ~/.ssh/目录下，windows存在C\\Users\\your_name.ssh\\ 目录下<br>id_rsa是私钥，id_rsa.pub是公钥</p>\n</li>\n<li><p>将A中生成的公钥加入到<strong>B机器</strong>的 authorized_keys 这个文件中，默认目录linux下是~/.ssh/ ，没有的话可以自己新建<br>拷贝的过程可以使用以下命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-copy-id -i 公钥文件路径 -p ssh端口  user@server</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ssh-copy-id  -  install  your  public  key in a remote machine’s autho‐rized_keys.<br>If the  -i  option  is  given  then  the  identity  file  (defaults  to ~/.ssh/id_rsa.pub) is used,<br>regardless of whether there are any keys in your ssh-agent.</p>\n</blockquote>\n</li>\n</ol>\n<p>此时A机器 ssh 登录B机器是不需要密码的</p>\n"},{"title":"Spring Mvc源码剖析(二)","toc":true,"date":"2018-05-06T09:16:48.000Z","_content":"\n\n\n启动流程的分析见: {% post_link spring-mvc %}\n\n{%  asset_img   spring-mvc.png  %}\n\n## 源码版本\n\n>4.3.6.RELEASE\n\n## HandlerExecutionChain\n\n*request -> executionchain*\n\n// RequestMappingHandlerMapping\n遍历已有的`HandlerMapping`, 找到第一个能处理的`HandlerMapping`\n\n```java\nprotected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {\n\t\tfor (HandlerMapping hm : this.handlerMappings) {\n\t\t\tif (logger.isTraceEnabled()) {\n\t\t\t\tlogger.trace(\n\t\t\t\t\t\t\"Testing handler map [\" + hm + \"] in DispatcherServlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t\tHandlerExecutionChain handler = hm.getHandler(request);\n\t\t\tif (handler != null) {\n\t\t\t\treturn handler;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n```\n\nhandlerMappings的值默认是:\n\n```\nthis.handlerMappings = {ArrayList@5980}  size = 2\n 0 = {RequestMappingHandlerMapping@5997} \n 1 = {BeanNameUrlHandlerMapping@6002} \n```\n\norg.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler\n\nexecutionchain就是interceptor和实际处理方法的结合体\n\n\n### 映射关系\n\n*url -> HandlerMethod*\n\norg.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal\n\n`HandlerMethod`是具体的controller对应的方法.\n\n```\nmappingLookup = {LinkedHashMap@6069}  size = 4\n 0 = {LinkedHashMap$Entry@6077} \"{[/async]}\" -> \"public java.util.concurrent.Callable<java.lang.String> com.air.mvc.AsyncController.asyncProcess()\"\n 1 = {LinkedHashMap$Entry@6078} \"{[/asyncV2]}\" -> \"public org.springframework.web.context.request.async.DeferredResult<java.lang.String> com.air.mvc.AsyncController.aysncProcess2()\"\n 2 = {LinkedHashMap$Entry@6079} \"{[/mvc/echo]}\" -> \"private java.lang.String com.air.mvc.SampleController.echo(javax.servlet.http.HttpServletRequest)\"\n 3 = {LinkedHashMap$Entry@6080} \"{[/mvc/test]}\" -> \"private java.lang.String com.air.mvc.SampleController.echo(java.lang.String)\"\n```\n\n\n### interceptor\n\n*url -> interceptors*\n\n```java\n//  /mvc/test\nString lookupPath = this.urlPathHelper.getLookupPathForRequest(request);\n\t\tfor (HandlerInterceptor interceptor : this.adaptedInterceptors) {\n\t\t\tif (interceptor instanceof MappedInterceptor) {\n\t\t\t\tMappedInterceptor mappedInterceptor = (MappedInterceptor) interceptor;\n\t\t\t\tif (mappedInterceptor.matches(lookupPath, this.pathMatcher)) {\n\t\t\t\t\tchain.addInterceptor(mappedInterceptor.getInterceptor());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tchain.addInterceptor(interceptor);\n\t\t\t}\n\t\t}\n```\n\n\n## HandlerAdapter\n\n*HandlerMethod -> HandlerAdapter*\n\n// RequestMappingHandlerAdapter\norg.springframework.web.servlet.DispatcherServlet#getHandlerAdapter\n\n遍历所有的`HandlerAdapters`, 找到第一个能处理的`HandlerAdapter`\n\n```java\nprotected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException {\n\t\tfor (HandlerAdapter ha : this.handlerAdapters) {\n\t\t\tif (logger.isTraceEnabled()) {\n\t\t\t\tlogger.trace(\"Testing handler adapter [\" + ha + \"]\");\n\t\t\t}\n\t\t\tif (ha.supports(handler)) {\n\t\t\t\treturn ha;\n\t\t\t}\n\t\t}\n\t\tthrow new ServletException(\"No adapter for handler [\" + handler +\n\t\t\t\t\"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler\");\n\t}\n```\n默认的`HandlerAdapters`\n\n```\nthis.handlerAdapters = {ArrayList@5983}  size = 3\n 0 = {RequestMappingHandlerAdapter@4845} \n 1 = {HttpRequestHandlerAdapter@6268} \n 2 = {SimpleControllerHandlerAdapter@6269} \n```\n\n涉及到的请求处理:\n\n    a. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod\n        调用对应的controller方法\n\n    b. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#getModelAndView\n        返回模型和视图\n\n## ServletInvocableHandlerMethod\n\n*HandlerMethod -> ServletInvocableHandlerMethod*\n\norg.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle\n\n   a. InvocableHandlerMethod#invokeForRequest\n\n        1. 解析传递的参数, 必要时进行转换(resolver负责映射输入的参数名称和controller方法对应的参数, dataBinder负责类型转换和校验)\n        2. 反射调用对应的方法\n\n    b. returnValueHandlers#handleReturnValue\n        从所有的handler中找到第一个支持对应返回值类型的处理返回值, 可能涉及`HttpMessageConverter`\n\n### argumentResolvers\n\n```\nthis.argumentResolvers = {HandlerMethodArgumentResolverComposite@4853} \n logger = {SLF4JLocationAwareLog@6533} \n argumentResolvers = {LinkedList@6534}  size = 26\n  0 = {RequestParamMethodArgumentResolver@5292} \n  1 = {RequestParamMapMethodArgumentResolver@6541} \n  2 = {PathVariableMethodArgumentResolver@6542} \n  3 = {PathVariableMapMethodArgumentResolver@6543} \n  4 = {MatrixVariableMethodArgumentResolver@6544} \n  5 = {MatrixVariableMapMethodArgumentResolver@6545} \n  6 = {ServletModelAttributeMethodProcessor@6546} \n  7 = {RequestResponseBodyMethodProcessor@6547} \n  8 = {RequestPartMethodArgumentResolver@6548} \n  9 = {RequestHeaderMethodArgumentResolver@6549} \n  10 = {RequestHeaderMapMethodArgumentResolver@6550} \n  11 = {ServletCookieValueMethodArgumentResolver@6551} \n  12 = {ExpressionValueMethodArgumentResolver@6552} \n  13 = {SessionAttributeMethodArgumentResolver@6553} \n  14 = {RequestAttributeMethodArgumentResolver@6554} \n  15 = {ServletRequestMethodArgumentResolver@6555} \n  16 = {ServletResponseMethodArgumentResolver@6556} \n  17 = {HttpEntityMethodProcessor@6557} \n  18 = {RedirectAttributesMethodArgumentResolver@6558} \n  19 = {ModelMethodProcessor@6559} \n  20 = {MapMethodProcessor@6560} \n  21 = {ErrorsMethodArgumentResolver@6561} \n  22 = {SessionStatusMethodArgumentResolver@6562} \n  23 = {UriComponentsBuilderMethodArgumentResolver@6563} \n  24 = {RequestParamMethodArgumentResolver@6564} \n  25 = {ServletModelAttributeMethodProcessor@6565} \n argumentResolverCache = {ConcurrentHashMap@6535}  size = 1\n  0 = {ConcurrentHashMap$MapEntry@6538} \"method 'echo' parameter 0\" -> \n   key = {HandlerMethod$HandlerMethodParameter@5293} \"method 'echo' parameter 0\"\n   value = {RequestParamMethodArgumentResolver@5292} \n```\n\n\n### returnValueHandlers\n\n```\nthis.returnValueHandlers = {HandlerMethodReturnValueHandlerComposite@4855} \n logger = {SLF4JLocationAwareLog@6567} \n returnValueHandlers = {ArrayList@6568}  size = 15\n  0 = {ModelAndViewMethodReturnValueHandler@6570} \n  1 = {ModelMethodProcessor@6571} \n  2 = {ViewMethodReturnValueHandler@6572} \n  3 = {ResponseBodyEmitterReturnValueHandler@6573} \n  4 = {StreamingResponseBodyReturnValueHandler@6574} \n  5 = {HttpEntityMethodProcessor@6575} \n  6 = {HttpHeadersReturnValueHandler@6576} \n  7 = {CallableMethodReturnValueHandler@6577} \n  8 = {DeferredResultMethodReturnValueHandler@6578} \n  9 = {AsyncTaskMethodReturnValueHandler@6579} \n  10 = {ModelAttributeMethodProcessor@6580} \n  11 = {RequestResponseBodyMethodProcessor@6581} \n  12 = {ViewNameMethodReturnValueHandler@6582} \n  13 = {MapMethodProcessor@6583} \n  14 = {ModelAttributeMethodProcessor@6584} \n```\n\n### binderFactory\n\n```\nbinderFactory = {ServletRequestDataBinderFactory@6498} \n binderMethods = {ArrayList@6585}  size = 0\n initializer = {ConfigurableWebBindingInitializer@4859} \n  autoGrowNestedPaths = true\n  directFieldAccess = false\n  messageCodesResolver = null\n  bindingErrorProcessor = null\n  validator = null\n  conversionService = {DefaultFormattingConversionService@6586} \"ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -> java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccess\"\n   embeddedValueResolver = {EmbeddedValueResolver@6003} \n   cachedPrinters = {ConcurrentHashMap@6588}  size = 0\n   cachedParsers = {ConcurrentHashMap@6589}  size = 0\n   converters = {GenericConversionService$Converters@6590} \"ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -> java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccess\"\n    globalConverters = {LinkedHashSet@6593}  size = 0\n    converters = {LinkedHashMap@6594}  size = 118\n     0 = {LinkedHashMap$Entry@6597} \"java.lang.Number -> java.lang.Number\" -> \"java.lang.Number -> java.lang.Number : org.springframework.core.convert.support.NumberToNumberConverterFactory@76561efa\"\n     1 = {LinkedHashMap$Entry@6598} \"java.lang.String -> java.lang.Number\" -> \"java.lang.String -> java.lang.Number : org.springframework.core.convert.support.StringToNumberConverterFactory@1bf7855e\"\n     2 = {LinkedHashMap$Entry@6599} \"java.lang.Number -> java.lang.String\" -> \"java.lang.Number -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@3932e255\"\n     3 = {LinkedHashMap$Entry@6600} \"java.lang.String -> java.lang.Character\" -> \"java.lang.String -> java.lang.Character : org.springframework.core.convert.support.StringToCharacterConverter@55a6b63f\"\n     4 = {LinkedHashMap$Entry@6601} \"java.lang.Character -> java.lang.String\" -> \"java.lang.Character -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@1341d3bf\"\n     5 = {LinkedHashMap$Entry@6602} \"java.lang.Number -> java.lang.Character\" -> \"java.lang.Number -> java.lang.Character : org.springframework.core.convert.support.NumberToCharacterConverter@34bb79fc\"\n     6 = {LinkedHashMap$Entry@6603} \"java.lang.Character -> java.lang.Number\" -> \"java.lang.Character -> java.lang.Number : org.springframework.core.convert.support.CharacterToNumberFactory@1ab51574\"\n     7 = {LinkedHashMap$Entry@6604} \"java.lang.String -> java.lang.Boolean\" -> \"java.lang.String -> java.lang.Boolean : org.springframework.core.convert.support.StringToBooleanConverter@7ac24f53\"\n     8 = {LinkedHashMap$Entry@6605} \"java.lang.Boolean -> java.lang.String\" -> \"java.lang.Boolean -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@6703b79f\"\n     9 = {LinkedHashMap$Entry@6606} \"java.lang.String -> java.lang.Enum\" -> \"java.lang.String -> java.lang.Enum : org.springframework.core.convert.support.StringToEnumConverterFactory@898561a\"\n     10 = {LinkedHashMap$Entry@6607} \"java.lang.Enum -> java.lang.String\" -> \"java.lang.Enum -> java.lang.String : org.springframework.core.convert.support.EnumToStringConverter@3a34ecc8\"\n     11 = {LinkedHashMap$Entry@6608} \"java.lang.Integer -> java.lang.Enum\" -> \"java.lang.Integer -> java.lang.Enum : org.springframework.core.convert.support.IntegerToEnumConverterFactory@52e4840a\"\n     12 = {LinkedHashMap$Entry@6609} \"java.lang.Enum -> java.lang.Integer\" -> \"java.lang.Enum -> java.lang.Integer : org.springframework.core.convert.support.EnumToIntegerConverter@28217e86\"\n     13 = {LinkedHashMap$Entry@6610} \"java.lang.String -> java.util.Locale\" -> \"java.lang.String -> java.util.Locale : org.springframework.core.convert.support.StringToLocaleConverter@6243d51e\"\n     14 = {LinkedHashMap$Entry@6611} \"java.util.Locale -> java.lang.String\" -> \"java.util.Locale -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@7f8c2732\"\n     15 = {LinkedHashMap$Entry@6612} \"java.lang.String -> java.nio.charset.Charset\" -> \"java.lang.String -> java.nio.charset.Charset : org.springframework.core.convert.support.StringToCharsetConverter@93e281d\"\n     16 = {LinkedHashMap$Entry@6613} \"java.nio.charset.Charset -> java.lang.String\" -> \"java.nio.charset.Charset -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@2ac8a2f2\"\n     17 = {LinkedHashMap$Entry@6614} \"java.lang.String -> java.util.Currency\" -> \"java.lang.String -> java.util.Currency : org.springframework.core.convert.support.StringToCurrencyConverter@565f7990\"\n     18 = {LinkedHashMap$Entry@6615} \"java.util.Currency -> java.lang.String\" -> \"java.util.Currency -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@487461de\"\n     19 = {LinkedHashMap$Entry@6616} \"java.lang.String -> java.util.Properties\" -> \"java.lang.String -> java.util.Properties : org.springframework.core.convert.support.StringToPropertiesConverter@3072d60d\"\n     20 = {LinkedHashMap$Entry@6617} \"java.util.Properties -> java.lang.String\" -> \"java.util.Properties -> java.lang.String : org.springframework.core.convert.support.PropertiesToStringConverter@5f423dc3\"\n     21 = {LinkedHashMap$Entry@6618} \"java.lang.String -> java.util.UUID\" -> \"java.lang.String -> java.util.UUID : org.springframework.core.convert.support.StringToUUIDConverter@72fc4c42\"\n     22 = {LinkedHashMap$Entry@6619} \"java.util.UUID -> java.lang.String\" -> \"java.util.UUID -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@196db952\"\n     23 = {LinkedHashMap$Entry@6620} \"[Ljava.lang.Object; -> java.util.Collection\" -> \"org.springframework.core.convert.support.ArrayToCollectionConverter@3f09c6cc\"\n     24 = {LinkedHashMap$Entry@6621} \"java.util.Collection -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.CollectionToArrayConverter@716b58cb\"\n     25 = {LinkedHashMap$Entry@6622} \"[Ljava.lang.Object; -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.ArrayToArrayConverter@61e594f8\"\n     26 = {LinkedHashMap$Entry@6623} \"java.util.Collection -> java.util.Collection\" -> \"org.springframework.core.convert.support.CollectionToCollectionConverter@153616bf\"\n     27 = {LinkedHashMap$Entry@6624} \"java.util.Map -> java.util.Map\" -> \"org.springframework.core.convert.support.MapToMapConverter@64f88d73\"\n     28 = {LinkedHashMap$Entry@6625} \"[Ljava.lang.Object; -> java.lang.String\" -> \"org.springframework.core.convert.support.ArrayToStringConverter@4f7e3c27\"\n     29 = {LinkedHashMap$Entry@6626} \"java.lang.String -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.StringToArrayConverter@2713364\"\n     30 = {LinkedHashMap$Entry@6627} \"[Ljava.lang.Object; -> java.lang.Object\" -> \"org.springframework.core.convert.support.ArrayToObjectConverter@27574e7b\"\n     31 = {LinkedHashMap$Entry@6628} \"java.lang.Object -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.ObjectToArrayConverter@7e4ccf7\"\n     32 = {LinkedHashMap$Entry@6629} \"java.util.Collection -> java.lang.String\" -> \"org.springframework.core.convert.support.CollectionToStringConverter@39455728\"\n     33 = {LinkedHashMap$Entry@6630} \"java.lang.String -> java.util.Collection\" -> \"org.springframework.core.convert.support.StringToCollectionConverter@32a4a977\"\n     34 = {LinkedHashMap$Entry@6631} \"java.util.Collection -> java.lang.Object\" -> \"org.springframework.core.convert.support.CollectionToObjectConverter@2f1d1dce\"\n     35 = {LinkedHashMap$Entry@6632} \"java.lang.Object -> java.util.Collection\" -> \"org.springframework.core.convert.support.ObjectToCollectionConverter@ebfffae\"\n     36 = {LinkedHashMap$Entry@6633} \"[Ljava.lang.Object; -> java.util.stream.Stream\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     37 = {LinkedHashMap$Entry@6634} \"java.util.Collection -> java.util.stream.Stream\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     38 = {LinkedHashMap$Entry@6635} \"java.util.stream.Stream -> java.util.Collection\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     39 = {LinkedHashMap$Entry@6636} \"java.util.stream.Stream -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     40 = {LinkedHashMap$Entry@6637} \"java.nio.ByteBuffer -> [B\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     41 = {LinkedHashMap$Entry@6638} \"java.nio.ByteBuffer -> java.lang.Object\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     42 = {LinkedHashMap$Entry@6639} \"java.lang.Object -> java.nio.ByteBuffer\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     43 = {LinkedHashMap$Entry@6640} \"[B -> java.nio.ByteBuffer\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     44 = {LinkedHashMap$Entry@6641} \"java.lang.String -> java.util.TimeZone\" -> \"java.lang.String -> java.util.TimeZone : org.springframework.core.convert.support.StringToTimeZoneConverter@4d1c677c\"\n     45 = {LinkedHashMap$Entry@6642} \"java.time.ZoneId -> java.util.TimeZone\" -> \"java.time.ZoneId -> java.util.TimeZone : org.springframework.core.convert.support.ZoneIdToTimeZoneConverter@3c2fb3fe\"\n     46 = {LinkedHashMap$Entry@6643} \"java.time.ZonedDateTime -> java.util.Calendar\" -> \"java.time.ZonedDateTime -> java.util.Calendar : org.springframework.core.convert.support.ZonedDateTimeToCalendarConverter@2148eb08\"\n     47 = {LinkedHashMap$Entry@6644} \"java.lang.Object -> java.lang.Object\" -> \"org.springframework.core.convert.support.IdToEntityConverter@6c69ab13,org.springframework.core.convert.support.ObjectToObjectConverter@42600665\"\n     48 = {LinkedHashMap$Entry@6645} \"java.lang.Object -> java.lang.String\" -> \"org.springframework.core.convert.support.FallbackObjectToStringConverter@311fd94\"\n     49 = {LinkedHashMap$Entry@6646} \"java.lang.Object -> java.util.Optional\" -> \"org.springframework.core.convert.support.ObjectToOptionalConverter@65e75655\"\n     50 = {LinkedHashMap$Entry@6647} \"java.lang.Integer -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Integer -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     51 = {LinkedHashMap$Entry@6648} \"java.lang.String -> java.lang.Integer\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Integer: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     52 = {LinkedHashMap$Entry@6649} \"java.lang.Float -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Float -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     53 = {LinkedHashMap$Entry@6650} \"java.lang.String -> java.lang.Float\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Float: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     54 = {LinkedHashMap$Entry@6651} \"java.math.BigInteger -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.math.BigInteger -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     55 = {LinkedHashMap$Entry@6652} \"java.lang.String -> java.math.BigInteger\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.math.BigInteger: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     56 = {LinkedHashMap$Entry@6653} \"java.lang.Byte -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Byte -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     57 = {LinkedHashMap$Entry@6654} \"java.lang.String -> java.lang.Byte\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Byte: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     58 = {LinkedHashMap$Entry@6655} \"java.lang.Double -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Double -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     59 = {LinkedHashMap$Entry@6656} \"java.lang.String -> java.lang.Double\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Double: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     60 = {LinkedHashMap$Entry@6657} \"java.lang.Short -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Short -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     61 = {LinkedHashMap$Entry@6658} \"java.lang.String -> java.lang.Short\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Short: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     62 = {LinkedHashMap$Entry@6659} \"java.lang.Long -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.lang.Long -> java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     63 = {LinkedHashMap$Entry@6660} \"java.lang.String -> java.lang.Long\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.lang.Long: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Long: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     64 = {LinkedHashMap$Entry@6661} \"java.math.BigDecimal -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.math.BigDecimal -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     65 = {LinkedHashMap$Entry@6662} \"java.lang.String -> java.math.BigDecimal\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.math.BigDecimal: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     66 = {LinkedHashMap$Entry@6663} \"java.util.Date -> java.lang.Long\" -> \"java.util.Date -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@a178d09,java.util.Date -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@551d27e0\"\n     67 = {LinkedHashMap$Entry@6664} \"java.util.Date -> java.util.Calendar\" -> \"java.util.Date -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@2bd20c9a,java.util.Date -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@1c6b5a31\"\n     68 = {LinkedHashMap$Entry@6665} \"java.util.Calendar -> java.util.Date\" -> \"java.util.Calendar -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@2aa2f370,java.util.Calendar -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@163cf3e3\"\n     69 = {LinkedHashMap$Entry@6666} \"java.util.Calendar -> java.lang.Long\" -> \"java.util.Calendar -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@2db18b62,java.util.Calendar -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@6bcdf637\"\n     70 = {LinkedHashMap$Entry@6667} \"java.lang.Long -> java.util.Date\" -> \"java.lang.Long -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@56c9b14d,java.lang.Long -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@271bf39c\"\n     71 = {LinkedHashMap$Entry@6668} \"java.lang.Long -> java.util.Calendar\" -> \"java.lang.Long -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@6d08686,java.lang.Long -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@2a8b425\"\n     72 = {LinkedHashMap$Entry@6669} \"java.time.LocalDateTime -> java.time.LocalDate\" -> \"java.time.LocalDateTime -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalDateConverter@19f02ee4\"\n     73 = {LinkedHashMap$Entry@6670} \"java.time.LocalDateTime -> java.time.LocalTime\" -> \"java.time.LocalDateTime -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalTimeConverter@618fb955\"\n     74 = {LinkedHashMap$Entry@6671} \"java.time.ZonedDateTime -> java.time.LocalDate\" -> \"java.time.ZonedDateTime -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateConverter@63e9f754\"\n     75 = {LinkedHashMap$Entry@6672} \"java.time.ZonedDateTime -> java.time.LocalTime\" -> \"java.time.ZonedDateTime -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalTimeConverter@24a76e90\"\n     76 = {LinkedHashMap$Entry@6673} \"java.time.ZonedDateTime -> java.time.LocalDateTime\" -> \"java.time.ZonedDateTime -> java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateTimeConverter@3cb8e3ee\"\n     77 = {LinkedHashMap$Entry@6674} \"java.time.ZonedDateTime -> java.time.OffsetDateTime\" -> \"java.time.ZonedDateTime -> java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToOffsetDateTimeConverter@2061a03d\"\n     78 = {LinkedHashMap$Entry@6675} \"java.time.ZonedDateTime -> java.time.Instant\" -> \"java.time.ZonedDateTime -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToInstantConverter@c1ea032\"\n     79 = {LinkedHashMap$Entry@6676} \"java.time.OffsetDateTime -> java.time.LocalDate\" -> \"java.time.OffsetDateTime -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateConverter@13d29ccf\"\n     80 = {LinkedHashMap$Entry@6677} \"java.time.OffsetDateTime -> java.time.LocalTime\" -> \"java.time.OffsetDateTime -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalTimeConverter@680eaac8\"\n     81 = {LinkedHashMap$Entry@6678} \"java.time.OffsetDateTime -> java.time.LocalDateTime\" -> \"java.time.OffsetDateTime -> java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateTimeConverter@45438fbc\"\n     82 = {LinkedHashMap$Entry@6679} \"java.time.OffsetDateTime -> java.time.ZonedDateTime\" -> \"java.time.OffsetDateTime -> java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToZonedDateTimeConverter@3ca5a816\"\n     83 = {LinkedHashMap$Entry@6680} \"java.time.OffsetDateTime -> java.time.Instant\" -> \"java.time.OffsetDateTime -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToInstantConverter@3b166fa9\"\n     84 = {LinkedHashMap$Entry@6681} \"java.util.Calendar -> java.time.ZonedDateTime\" -> \"java.util.Calendar -> java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToZonedDateTimeConverter@2653dae9\"\n     85 = {LinkedHashMap$Entry@6682} \"java.util.Calendar -> java.time.OffsetDateTime\" -> \"java.util.Calendar -> java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToOffsetDateTimeConverter@7f348ff0\"\n     86 = {LinkedHashMap$Entry@6683} \"java.util.Calendar -> java.time.LocalDate\" -> \"java.util.Calendar -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateConverter@6e407d18\"\n     87 = {LinkedHashMap$Entry@6684} \"java.util.Calendar -> java.time.LocalTime\" -> \"java.util.Calendar -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalTimeConverter@66a32c5e\"\n     88 = {LinkedHashMap$Entry@6685} \"java.util.Calendar -> java.time.LocalDateTime\" -> \"java.util.Calendar -> java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateTimeConverter@5e9f36f1\"\n     89 = {LinkedHashMap$Entry@6686} \"java.util.Calendar -> java.time.Instant\" -> \"java.util.Calendar -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToInstantConverter@50f69dd\"\n     90 = {LinkedHashMap$Entry@6687} \"java.lang.Long -> java.time.Instant\" -> \"java.lang.Long -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$LongToInstantConverter@684a7cd9\"\n     91 = {LinkedHashMap$Entry@6688} \"java.time.Instant -> java.lang.Long\" -> \"java.time.Instant -> java.lang.Long : org.springframework.format.datetime.standard.DateTimeConverters$InstantToLongConverter@17f47c52\"\n     92 = {LinkedHashMap$Entry@6689} \"java.time.LocalDate -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\"\n     93 = {LinkedHashMap$Entry@6690} \"java.lang.String -> java.time.LocalDate\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.LocalDate: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.LocalDate: org.springframework.format.datetime.standard.TemporalAccessorParser@75d32f15\"\n     94 = {LinkedHashMap$Entry@6691} \"java.time.LocalTime -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.LocalTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41f1db11\"\n     95 = {LinkedHashMap$Entry@6692} \"java.lang.String -> java.time.LocalTime\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.LocalTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.LocalTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2ea20f2c\"\n     96 = {LinkedHashMap$Entry@6693} \"java.time.LocalDateTime -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41fc9576\"\n     97 = {LinkedHashMap$Entry@6694} \"java.lang.String -> java.time.LocalDateTime\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.LocalDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2dbba1db\"\n     98 = {LinkedHashMap$Entry@6695} \"java.time.ZonedDateTime -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.ZonedDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@625dde2e\"\n     99 = {LinkedHashMap$Entry@6696} \"java.lang.String -> java.time.ZonedDateTime\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.ZonedDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@5cb87626\"\n   converterCache = {ConcurrentReferenceHashMap@6591}  size = 1\n    0 = {ConcurrentReferenceHashMap$Entry@7099} \"ConverterCacheKey [sourceType = java.lang.String, targetType = @org.springframework.web.bind.annotation.RequestParam java.lang.String]\" -> \"NO_OP\"\n  propertyEditorRegistrars = null\n```\n\n### parameterNameDiscoverer\n\n```\nthis.parameterNameDiscoverer = {DefaultParameterNameDiscoverer@4866} \n parameterNameDiscoverers = {LinkedList@7309}  size = 2\n  0 = {StandardReflectionParameterNameDiscoverer@7311} \n  1 = {LocalVariableTableParameterNameDiscoverer@7312} \n```\n\n\n容器的启动过程以及一次请求的详细处理过程: [启动日志](springmvc.log)","source":"_posts/spring-mvc-2.md","raw":"title: Spring Mvc源码剖析(二)\ntags: spring mvc\ncategory: spring\ntoc: true\ndate: 2018-05-06 17:16:48\n---\n\n\n\n启动流程的分析见: {% post_link spring-mvc %}\n\n{%  asset_img   spring-mvc.png  %}\n\n## 源码版本\n\n>4.3.6.RELEASE\n\n## HandlerExecutionChain\n\n*request -> executionchain*\n\n// RequestMappingHandlerMapping\n遍历已有的`HandlerMapping`, 找到第一个能处理的`HandlerMapping`\n\n```java\nprotected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {\n\t\tfor (HandlerMapping hm : this.handlerMappings) {\n\t\t\tif (logger.isTraceEnabled()) {\n\t\t\t\tlogger.trace(\n\t\t\t\t\t\t\"Testing handler map [\" + hm + \"] in DispatcherServlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t\tHandlerExecutionChain handler = hm.getHandler(request);\n\t\t\tif (handler != null) {\n\t\t\t\treturn handler;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n```\n\nhandlerMappings的值默认是:\n\n```\nthis.handlerMappings = {ArrayList@5980}  size = 2\n 0 = {RequestMappingHandlerMapping@5997} \n 1 = {BeanNameUrlHandlerMapping@6002} \n```\n\norg.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler\n\nexecutionchain就是interceptor和实际处理方法的结合体\n\n\n### 映射关系\n\n*url -> HandlerMethod*\n\norg.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal\n\n`HandlerMethod`是具体的controller对应的方法.\n\n```\nmappingLookup = {LinkedHashMap@6069}  size = 4\n 0 = {LinkedHashMap$Entry@6077} \"{[/async]}\" -> \"public java.util.concurrent.Callable<java.lang.String> com.air.mvc.AsyncController.asyncProcess()\"\n 1 = {LinkedHashMap$Entry@6078} \"{[/asyncV2]}\" -> \"public org.springframework.web.context.request.async.DeferredResult<java.lang.String> com.air.mvc.AsyncController.aysncProcess2()\"\n 2 = {LinkedHashMap$Entry@6079} \"{[/mvc/echo]}\" -> \"private java.lang.String com.air.mvc.SampleController.echo(javax.servlet.http.HttpServletRequest)\"\n 3 = {LinkedHashMap$Entry@6080} \"{[/mvc/test]}\" -> \"private java.lang.String com.air.mvc.SampleController.echo(java.lang.String)\"\n```\n\n\n### interceptor\n\n*url -> interceptors*\n\n```java\n//  /mvc/test\nString lookupPath = this.urlPathHelper.getLookupPathForRequest(request);\n\t\tfor (HandlerInterceptor interceptor : this.adaptedInterceptors) {\n\t\t\tif (interceptor instanceof MappedInterceptor) {\n\t\t\t\tMappedInterceptor mappedInterceptor = (MappedInterceptor) interceptor;\n\t\t\t\tif (mappedInterceptor.matches(lookupPath, this.pathMatcher)) {\n\t\t\t\t\tchain.addInterceptor(mappedInterceptor.getInterceptor());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tchain.addInterceptor(interceptor);\n\t\t\t}\n\t\t}\n```\n\n\n## HandlerAdapter\n\n*HandlerMethod -> HandlerAdapter*\n\n// RequestMappingHandlerAdapter\norg.springframework.web.servlet.DispatcherServlet#getHandlerAdapter\n\n遍历所有的`HandlerAdapters`, 找到第一个能处理的`HandlerAdapter`\n\n```java\nprotected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException {\n\t\tfor (HandlerAdapter ha : this.handlerAdapters) {\n\t\t\tif (logger.isTraceEnabled()) {\n\t\t\t\tlogger.trace(\"Testing handler adapter [\" + ha + \"]\");\n\t\t\t}\n\t\t\tif (ha.supports(handler)) {\n\t\t\t\treturn ha;\n\t\t\t}\n\t\t}\n\t\tthrow new ServletException(\"No adapter for handler [\" + handler +\n\t\t\t\t\"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler\");\n\t}\n```\n默认的`HandlerAdapters`\n\n```\nthis.handlerAdapters = {ArrayList@5983}  size = 3\n 0 = {RequestMappingHandlerAdapter@4845} \n 1 = {HttpRequestHandlerAdapter@6268} \n 2 = {SimpleControllerHandlerAdapter@6269} \n```\n\n涉及到的请求处理:\n\n    a. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod\n        调用对应的controller方法\n\n    b. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#getModelAndView\n        返回模型和视图\n\n## ServletInvocableHandlerMethod\n\n*HandlerMethod -> ServletInvocableHandlerMethod*\n\norg.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle\n\n   a. InvocableHandlerMethod#invokeForRequest\n\n        1. 解析传递的参数, 必要时进行转换(resolver负责映射输入的参数名称和controller方法对应的参数, dataBinder负责类型转换和校验)\n        2. 反射调用对应的方法\n\n    b. returnValueHandlers#handleReturnValue\n        从所有的handler中找到第一个支持对应返回值类型的处理返回值, 可能涉及`HttpMessageConverter`\n\n### argumentResolvers\n\n```\nthis.argumentResolvers = {HandlerMethodArgumentResolverComposite@4853} \n logger = {SLF4JLocationAwareLog@6533} \n argumentResolvers = {LinkedList@6534}  size = 26\n  0 = {RequestParamMethodArgumentResolver@5292} \n  1 = {RequestParamMapMethodArgumentResolver@6541} \n  2 = {PathVariableMethodArgumentResolver@6542} \n  3 = {PathVariableMapMethodArgumentResolver@6543} \n  4 = {MatrixVariableMethodArgumentResolver@6544} \n  5 = {MatrixVariableMapMethodArgumentResolver@6545} \n  6 = {ServletModelAttributeMethodProcessor@6546} \n  7 = {RequestResponseBodyMethodProcessor@6547} \n  8 = {RequestPartMethodArgumentResolver@6548} \n  9 = {RequestHeaderMethodArgumentResolver@6549} \n  10 = {RequestHeaderMapMethodArgumentResolver@6550} \n  11 = {ServletCookieValueMethodArgumentResolver@6551} \n  12 = {ExpressionValueMethodArgumentResolver@6552} \n  13 = {SessionAttributeMethodArgumentResolver@6553} \n  14 = {RequestAttributeMethodArgumentResolver@6554} \n  15 = {ServletRequestMethodArgumentResolver@6555} \n  16 = {ServletResponseMethodArgumentResolver@6556} \n  17 = {HttpEntityMethodProcessor@6557} \n  18 = {RedirectAttributesMethodArgumentResolver@6558} \n  19 = {ModelMethodProcessor@6559} \n  20 = {MapMethodProcessor@6560} \n  21 = {ErrorsMethodArgumentResolver@6561} \n  22 = {SessionStatusMethodArgumentResolver@6562} \n  23 = {UriComponentsBuilderMethodArgumentResolver@6563} \n  24 = {RequestParamMethodArgumentResolver@6564} \n  25 = {ServletModelAttributeMethodProcessor@6565} \n argumentResolverCache = {ConcurrentHashMap@6535}  size = 1\n  0 = {ConcurrentHashMap$MapEntry@6538} \"method 'echo' parameter 0\" -> \n   key = {HandlerMethod$HandlerMethodParameter@5293} \"method 'echo' parameter 0\"\n   value = {RequestParamMethodArgumentResolver@5292} \n```\n\n\n### returnValueHandlers\n\n```\nthis.returnValueHandlers = {HandlerMethodReturnValueHandlerComposite@4855} \n logger = {SLF4JLocationAwareLog@6567} \n returnValueHandlers = {ArrayList@6568}  size = 15\n  0 = {ModelAndViewMethodReturnValueHandler@6570} \n  1 = {ModelMethodProcessor@6571} \n  2 = {ViewMethodReturnValueHandler@6572} \n  3 = {ResponseBodyEmitterReturnValueHandler@6573} \n  4 = {StreamingResponseBodyReturnValueHandler@6574} \n  5 = {HttpEntityMethodProcessor@6575} \n  6 = {HttpHeadersReturnValueHandler@6576} \n  7 = {CallableMethodReturnValueHandler@6577} \n  8 = {DeferredResultMethodReturnValueHandler@6578} \n  9 = {AsyncTaskMethodReturnValueHandler@6579} \n  10 = {ModelAttributeMethodProcessor@6580} \n  11 = {RequestResponseBodyMethodProcessor@6581} \n  12 = {ViewNameMethodReturnValueHandler@6582} \n  13 = {MapMethodProcessor@6583} \n  14 = {ModelAttributeMethodProcessor@6584} \n```\n\n### binderFactory\n\n```\nbinderFactory = {ServletRequestDataBinderFactory@6498} \n binderMethods = {ArrayList@6585}  size = 0\n initializer = {ConfigurableWebBindingInitializer@4859} \n  autoGrowNestedPaths = true\n  directFieldAccess = false\n  messageCodesResolver = null\n  bindingErrorProcessor = null\n  validator = null\n  conversionService = {DefaultFormattingConversionService@6586} \"ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -> java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccess\"\n   embeddedValueResolver = {EmbeddedValueResolver@6003} \n   cachedPrinters = {ConcurrentHashMap@6588}  size = 0\n   cachedParsers = {ConcurrentHashMap@6589}  size = 0\n   converters = {GenericConversionService$Converters@6590} \"ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -> java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccess\"\n    globalConverters = {LinkedHashSet@6593}  size = 0\n    converters = {LinkedHashMap@6594}  size = 118\n     0 = {LinkedHashMap$Entry@6597} \"java.lang.Number -> java.lang.Number\" -> \"java.lang.Number -> java.lang.Number : org.springframework.core.convert.support.NumberToNumberConverterFactory@76561efa\"\n     1 = {LinkedHashMap$Entry@6598} \"java.lang.String -> java.lang.Number\" -> \"java.lang.String -> java.lang.Number : org.springframework.core.convert.support.StringToNumberConverterFactory@1bf7855e\"\n     2 = {LinkedHashMap$Entry@6599} \"java.lang.Number -> java.lang.String\" -> \"java.lang.Number -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@3932e255\"\n     3 = {LinkedHashMap$Entry@6600} \"java.lang.String -> java.lang.Character\" -> \"java.lang.String -> java.lang.Character : org.springframework.core.convert.support.StringToCharacterConverter@55a6b63f\"\n     4 = {LinkedHashMap$Entry@6601} \"java.lang.Character -> java.lang.String\" -> \"java.lang.Character -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@1341d3bf\"\n     5 = {LinkedHashMap$Entry@6602} \"java.lang.Number -> java.lang.Character\" -> \"java.lang.Number -> java.lang.Character : org.springframework.core.convert.support.NumberToCharacterConverter@34bb79fc\"\n     6 = {LinkedHashMap$Entry@6603} \"java.lang.Character -> java.lang.Number\" -> \"java.lang.Character -> java.lang.Number : org.springframework.core.convert.support.CharacterToNumberFactory@1ab51574\"\n     7 = {LinkedHashMap$Entry@6604} \"java.lang.String -> java.lang.Boolean\" -> \"java.lang.String -> java.lang.Boolean : org.springframework.core.convert.support.StringToBooleanConverter@7ac24f53\"\n     8 = {LinkedHashMap$Entry@6605} \"java.lang.Boolean -> java.lang.String\" -> \"java.lang.Boolean -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@6703b79f\"\n     9 = {LinkedHashMap$Entry@6606} \"java.lang.String -> java.lang.Enum\" -> \"java.lang.String -> java.lang.Enum : org.springframework.core.convert.support.StringToEnumConverterFactory@898561a\"\n     10 = {LinkedHashMap$Entry@6607} \"java.lang.Enum -> java.lang.String\" -> \"java.lang.Enum -> java.lang.String : org.springframework.core.convert.support.EnumToStringConverter@3a34ecc8\"\n     11 = {LinkedHashMap$Entry@6608} \"java.lang.Integer -> java.lang.Enum\" -> \"java.lang.Integer -> java.lang.Enum : org.springframework.core.convert.support.IntegerToEnumConverterFactory@52e4840a\"\n     12 = {LinkedHashMap$Entry@6609} \"java.lang.Enum -> java.lang.Integer\" -> \"java.lang.Enum -> java.lang.Integer : org.springframework.core.convert.support.EnumToIntegerConverter@28217e86\"\n     13 = {LinkedHashMap$Entry@6610} \"java.lang.String -> java.util.Locale\" -> \"java.lang.String -> java.util.Locale : org.springframework.core.convert.support.StringToLocaleConverter@6243d51e\"\n     14 = {LinkedHashMap$Entry@6611} \"java.util.Locale -> java.lang.String\" -> \"java.util.Locale -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@7f8c2732\"\n     15 = {LinkedHashMap$Entry@6612} \"java.lang.String -> java.nio.charset.Charset\" -> \"java.lang.String -> java.nio.charset.Charset : org.springframework.core.convert.support.StringToCharsetConverter@93e281d\"\n     16 = {LinkedHashMap$Entry@6613} \"java.nio.charset.Charset -> java.lang.String\" -> \"java.nio.charset.Charset -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@2ac8a2f2\"\n     17 = {LinkedHashMap$Entry@6614} \"java.lang.String -> java.util.Currency\" -> \"java.lang.String -> java.util.Currency : org.springframework.core.convert.support.StringToCurrencyConverter@565f7990\"\n     18 = {LinkedHashMap$Entry@6615} \"java.util.Currency -> java.lang.String\" -> \"java.util.Currency -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@487461de\"\n     19 = {LinkedHashMap$Entry@6616} \"java.lang.String -> java.util.Properties\" -> \"java.lang.String -> java.util.Properties : org.springframework.core.convert.support.StringToPropertiesConverter@3072d60d\"\n     20 = {LinkedHashMap$Entry@6617} \"java.util.Properties -> java.lang.String\" -> \"java.util.Properties -> java.lang.String : org.springframework.core.convert.support.PropertiesToStringConverter@5f423dc3\"\n     21 = {LinkedHashMap$Entry@6618} \"java.lang.String -> java.util.UUID\" -> \"java.lang.String -> java.util.UUID : org.springframework.core.convert.support.StringToUUIDConverter@72fc4c42\"\n     22 = {LinkedHashMap$Entry@6619} \"java.util.UUID -> java.lang.String\" -> \"java.util.UUID -> java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@196db952\"\n     23 = {LinkedHashMap$Entry@6620} \"[Ljava.lang.Object; -> java.util.Collection\" -> \"org.springframework.core.convert.support.ArrayToCollectionConverter@3f09c6cc\"\n     24 = {LinkedHashMap$Entry@6621} \"java.util.Collection -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.CollectionToArrayConverter@716b58cb\"\n     25 = {LinkedHashMap$Entry@6622} \"[Ljava.lang.Object; -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.ArrayToArrayConverter@61e594f8\"\n     26 = {LinkedHashMap$Entry@6623} \"java.util.Collection -> java.util.Collection\" -> \"org.springframework.core.convert.support.CollectionToCollectionConverter@153616bf\"\n     27 = {LinkedHashMap$Entry@6624} \"java.util.Map -> java.util.Map\" -> \"org.springframework.core.convert.support.MapToMapConverter@64f88d73\"\n     28 = {LinkedHashMap$Entry@6625} \"[Ljava.lang.Object; -> java.lang.String\" -> \"org.springframework.core.convert.support.ArrayToStringConverter@4f7e3c27\"\n     29 = {LinkedHashMap$Entry@6626} \"java.lang.String -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.StringToArrayConverter@2713364\"\n     30 = {LinkedHashMap$Entry@6627} \"[Ljava.lang.Object; -> java.lang.Object\" -> \"org.springframework.core.convert.support.ArrayToObjectConverter@27574e7b\"\n     31 = {LinkedHashMap$Entry@6628} \"java.lang.Object -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.ObjectToArrayConverter@7e4ccf7\"\n     32 = {LinkedHashMap$Entry@6629} \"java.util.Collection -> java.lang.String\" -> \"org.springframework.core.convert.support.CollectionToStringConverter@39455728\"\n     33 = {LinkedHashMap$Entry@6630} \"java.lang.String -> java.util.Collection\" -> \"org.springframework.core.convert.support.StringToCollectionConverter@32a4a977\"\n     34 = {LinkedHashMap$Entry@6631} \"java.util.Collection -> java.lang.Object\" -> \"org.springframework.core.convert.support.CollectionToObjectConverter@2f1d1dce\"\n     35 = {LinkedHashMap$Entry@6632} \"java.lang.Object -> java.util.Collection\" -> \"org.springframework.core.convert.support.ObjectToCollectionConverter@ebfffae\"\n     36 = {LinkedHashMap$Entry@6633} \"[Ljava.lang.Object; -> java.util.stream.Stream\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     37 = {LinkedHashMap$Entry@6634} \"java.util.Collection -> java.util.stream.Stream\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     38 = {LinkedHashMap$Entry@6635} \"java.util.stream.Stream -> java.util.Collection\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     39 = {LinkedHashMap$Entry@6636} \"java.util.stream.Stream -> [Ljava.lang.Object;\" -> \"org.springframework.core.convert.support.StreamConverter@1d500546\"\n     40 = {LinkedHashMap$Entry@6637} \"java.nio.ByteBuffer -> [B\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     41 = {LinkedHashMap$Entry@6638} \"java.nio.ByteBuffer -> java.lang.Object\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     42 = {LinkedHashMap$Entry@6639} \"java.lang.Object -> java.nio.ByteBuffer\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     43 = {LinkedHashMap$Entry@6640} \"[B -> java.nio.ByteBuffer\" -> \"org.springframework.core.convert.support.ByteBufferConverter@aa8e88a\"\n     44 = {LinkedHashMap$Entry@6641} \"java.lang.String -> java.util.TimeZone\" -> \"java.lang.String -> java.util.TimeZone : org.springframework.core.convert.support.StringToTimeZoneConverter@4d1c677c\"\n     45 = {LinkedHashMap$Entry@6642} \"java.time.ZoneId -> java.util.TimeZone\" -> \"java.time.ZoneId -> java.util.TimeZone : org.springframework.core.convert.support.ZoneIdToTimeZoneConverter@3c2fb3fe\"\n     46 = {LinkedHashMap$Entry@6643} \"java.time.ZonedDateTime -> java.util.Calendar\" -> \"java.time.ZonedDateTime -> java.util.Calendar : org.springframework.core.convert.support.ZonedDateTimeToCalendarConverter@2148eb08\"\n     47 = {LinkedHashMap$Entry@6644} \"java.lang.Object -> java.lang.Object\" -> \"org.springframework.core.convert.support.IdToEntityConverter@6c69ab13,org.springframework.core.convert.support.ObjectToObjectConverter@42600665\"\n     48 = {LinkedHashMap$Entry@6645} \"java.lang.Object -> java.lang.String\" -> \"org.springframework.core.convert.support.FallbackObjectToStringConverter@311fd94\"\n     49 = {LinkedHashMap$Entry@6646} \"java.lang.Object -> java.util.Optional\" -> \"org.springframework.core.convert.support.ObjectToOptionalConverter@65e75655\"\n     50 = {LinkedHashMap$Entry@6647} \"java.lang.Integer -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Integer -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     51 = {LinkedHashMap$Entry@6648} \"java.lang.String -> java.lang.Integer\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Integer: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     52 = {LinkedHashMap$Entry@6649} \"java.lang.Float -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Float -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     53 = {LinkedHashMap$Entry@6650} \"java.lang.String -> java.lang.Float\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Float: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     54 = {LinkedHashMap$Entry@6651} \"java.math.BigInteger -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.math.BigInteger -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     55 = {LinkedHashMap$Entry@6652} \"java.lang.String -> java.math.BigInteger\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.math.BigInteger: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     56 = {LinkedHashMap$Entry@6653} \"java.lang.Byte -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Byte -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     57 = {LinkedHashMap$Entry@6654} \"java.lang.String -> java.lang.Byte\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Byte: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     58 = {LinkedHashMap$Entry@6655} \"java.lang.Double -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Double -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     59 = {LinkedHashMap$Entry@6656} \"java.lang.String -> java.lang.Double\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Double: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     60 = {LinkedHashMap$Entry@6657} \"java.lang.Short -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.lang.Short -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     61 = {LinkedHashMap$Entry@6658} \"java.lang.String -> java.lang.Short\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Short: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     62 = {LinkedHashMap$Entry@6659} \"java.lang.Long -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.lang.Long -> java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     63 = {LinkedHashMap$Entry@6660} \"java.lang.String -> java.lang.Long\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.lang.Long: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,java.lang.String -> @org.springframework.format.annotation.NumberFormat java.lang.Long: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     64 = {LinkedHashMap$Entry@6661} \"java.math.BigDecimal -> java.lang.String\" -> \"@org.springframework.format.annotation.NumberFormat java.math.BigDecimal -> java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     65 = {LinkedHashMap$Entry@6662} \"java.lang.String -> java.math.BigDecimal\" -> \"java.lang.String -> @org.springframework.format.annotation.NumberFormat java.math.BigDecimal: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\"\n     66 = {LinkedHashMap$Entry@6663} \"java.util.Date -> java.lang.Long\" -> \"java.util.Date -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@a178d09,java.util.Date -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@551d27e0\"\n     67 = {LinkedHashMap$Entry@6664} \"java.util.Date -> java.util.Calendar\" -> \"java.util.Date -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@2bd20c9a,java.util.Date -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@1c6b5a31\"\n     68 = {LinkedHashMap$Entry@6665} \"java.util.Calendar -> java.util.Date\" -> \"java.util.Calendar -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@2aa2f370,java.util.Calendar -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@163cf3e3\"\n     69 = {LinkedHashMap$Entry@6666} \"java.util.Calendar -> java.lang.Long\" -> \"java.util.Calendar -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@2db18b62,java.util.Calendar -> java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@6bcdf637\"\n     70 = {LinkedHashMap$Entry@6667} \"java.lang.Long -> java.util.Date\" -> \"java.lang.Long -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@56c9b14d,java.lang.Long -> java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@271bf39c\"\n     71 = {LinkedHashMap$Entry@6668} \"java.lang.Long -> java.util.Calendar\" -> \"java.lang.Long -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@6d08686,java.lang.Long -> java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@2a8b425\"\n     72 = {LinkedHashMap$Entry@6669} \"java.time.LocalDateTime -> java.time.LocalDate\" -> \"java.time.LocalDateTime -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalDateConverter@19f02ee4\"\n     73 = {LinkedHashMap$Entry@6670} \"java.time.LocalDateTime -> java.time.LocalTime\" -> \"java.time.LocalDateTime -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalTimeConverter@618fb955\"\n     74 = {LinkedHashMap$Entry@6671} \"java.time.ZonedDateTime -> java.time.LocalDate\" -> \"java.time.ZonedDateTime -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateConverter@63e9f754\"\n     75 = {LinkedHashMap$Entry@6672} \"java.time.ZonedDateTime -> java.time.LocalTime\" -> \"java.time.ZonedDateTime -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalTimeConverter@24a76e90\"\n     76 = {LinkedHashMap$Entry@6673} \"java.time.ZonedDateTime -> java.time.LocalDateTime\" -> \"java.time.ZonedDateTime -> java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateTimeConverter@3cb8e3ee\"\n     77 = {LinkedHashMap$Entry@6674} \"java.time.ZonedDateTime -> java.time.OffsetDateTime\" -> \"java.time.ZonedDateTime -> java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToOffsetDateTimeConverter@2061a03d\"\n     78 = {LinkedHashMap$Entry@6675} \"java.time.ZonedDateTime -> java.time.Instant\" -> \"java.time.ZonedDateTime -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToInstantConverter@c1ea032\"\n     79 = {LinkedHashMap$Entry@6676} \"java.time.OffsetDateTime -> java.time.LocalDate\" -> \"java.time.OffsetDateTime -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateConverter@13d29ccf\"\n     80 = {LinkedHashMap$Entry@6677} \"java.time.OffsetDateTime -> java.time.LocalTime\" -> \"java.time.OffsetDateTime -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalTimeConverter@680eaac8\"\n     81 = {LinkedHashMap$Entry@6678} \"java.time.OffsetDateTime -> java.time.LocalDateTime\" -> \"java.time.OffsetDateTime -> java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateTimeConverter@45438fbc\"\n     82 = {LinkedHashMap$Entry@6679} \"java.time.OffsetDateTime -> java.time.ZonedDateTime\" -> \"java.time.OffsetDateTime -> java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToZonedDateTimeConverter@3ca5a816\"\n     83 = {LinkedHashMap$Entry@6680} \"java.time.OffsetDateTime -> java.time.Instant\" -> \"java.time.OffsetDateTime -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToInstantConverter@3b166fa9\"\n     84 = {LinkedHashMap$Entry@6681} \"java.util.Calendar -> java.time.ZonedDateTime\" -> \"java.util.Calendar -> java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToZonedDateTimeConverter@2653dae9\"\n     85 = {LinkedHashMap$Entry@6682} \"java.util.Calendar -> java.time.OffsetDateTime\" -> \"java.util.Calendar -> java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToOffsetDateTimeConverter@7f348ff0\"\n     86 = {LinkedHashMap$Entry@6683} \"java.util.Calendar -> java.time.LocalDate\" -> \"java.util.Calendar -> java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateConverter@6e407d18\"\n     87 = {LinkedHashMap$Entry@6684} \"java.util.Calendar -> java.time.LocalTime\" -> \"java.util.Calendar -> java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalTimeConverter@66a32c5e\"\n     88 = {LinkedHashMap$Entry@6685} \"java.util.Calendar -> java.time.LocalDateTime\" -> \"java.util.Calendar -> java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateTimeConverter@5e9f36f1\"\n     89 = {LinkedHashMap$Entry@6686} \"java.util.Calendar -> java.time.Instant\" -> \"java.util.Calendar -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToInstantConverter@50f69dd\"\n     90 = {LinkedHashMap$Entry@6687} \"java.lang.Long -> java.time.Instant\" -> \"java.lang.Long -> java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$LongToInstantConverter@684a7cd9\"\n     91 = {LinkedHashMap$Entry@6688} \"java.time.Instant -> java.lang.Long\" -> \"java.time.Instant -> java.lang.Long : org.springframework.format.datetime.standard.DateTimeConverters$InstantToLongConverter@17f47c52\"\n     92 = {LinkedHashMap$Entry@6689} \"java.time.LocalDate -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\"\n     93 = {LinkedHashMap$Entry@6690} \"java.lang.String -> java.time.LocalDate\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.LocalDate: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.LocalDate: org.springframework.format.datetime.standard.TemporalAccessorParser@75d32f15\"\n     94 = {LinkedHashMap$Entry@6691} \"java.time.LocalTime -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.LocalTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41f1db11\"\n     95 = {LinkedHashMap$Entry@6692} \"java.lang.String -> java.time.LocalTime\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.LocalTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.LocalTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2ea20f2c\"\n     96 = {LinkedHashMap$Entry@6693} \"java.time.LocalDateTime -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41fc9576\"\n     97 = {LinkedHashMap$Entry@6694} \"java.lang.String -> java.time.LocalDateTime\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.LocalDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2dbba1db\"\n     98 = {LinkedHashMap$Entry@6695} \"java.time.ZonedDateTime -> java.lang.String\" -> \"@org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime -> java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.ZonedDateTime -> java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@625dde2e\"\n     99 = {LinkedHashMap$Entry@6696} \"java.lang.String -> java.time.ZonedDateTime\" -> \"java.lang.String -> @org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -> java.time.ZonedDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@5cb87626\"\n   converterCache = {ConcurrentReferenceHashMap@6591}  size = 1\n    0 = {ConcurrentReferenceHashMap$Entry@7099} \"ConverterCacheKey [sourceType = java.lang.String, targetType = @org.springframework.web.bind.annotation.RequestParam java.lang.String]\" -> \"NO_OP\"\n  propertyEditorRegistrars = null\n```\n\n### parameterNameDiscoverer\n\n```\nthis.parameterNameDiscoverer = {DefaultParameterNameDiscoverer@4866} \n parameterNameDiscoverers = {LinkedList@7309}  size = 2\n  0 = {StandardReflectionParameterNameDiscoverer@7311} \n  1 = {LocalVariableTableParameterNameDiscoverer@7312} \n```\n\n\n容器的启动过程以及一次请求的详细处理过程: [启动日志](springmvc.log)","slug":"spring-mvc-2","published":1,"updated":"2018-05-06T09:16:48.729Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdal009gjh4k2iqew9zl","content":"<p>启动流程的分析见: <a href=\"/2016/10/02/spring-mvc/\" title=\"Spring Mvc源码剖析(一)\">Spring Mvc源码剖析(一)</a></p>\n<img src=\"/2018/05/06/spring-mvc-2/spring-mvc.png\">\n<h2 id=\"源码版本\"><a href=\"#源码版本\" class=\"headerlink\" title=\"源码版本\"></a>源码版本</h2><blockquote>\n<p>4.3.6.RELEASE</p>\n</blockquote>\n<h2 id=\"HandlerExecutionChain\"><a href=\"#HandlerExecutionChain\" class=\"headerlink\" title=\"HandlerExecutionChain\"></a>HandlerExecutionChain</h2><p><em>request -&gt; executionchain</em></p>\n<p>// RequestMappingHandlerMapping<br>遍历已有的<code>HandlerMapping</code>, 找到第一个能处理的<code>HandlerMapping</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> HandlerExecutionChain <span class=\"title\">getHandler</span><span class=\"params\">(HttpServletRequest request)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (HandlerMapping hm : <span class=\"keyword\">this</span>.handlerMappings) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.trace(</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"Testing handler map [\"</span> + hm + <span class=\"string\">\"] in DispatcherServlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tHandlerExecutionChain handler = hm.getHandler(request);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (handler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> handler;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>handlerMappings的值默认是:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.handlerMappings = &#123;ArrayList@5980&#125;  size = 2</span><br><span class=\"line\"> 0 = &#123;RequestMappingHandlerMapping@5997&#125; </span><br><span class=\"line\"> 1 = &#123;BeanNameUrlHandlerMapping@6002&#125;</span><br></pre></td></tr></table></figure>\n<p>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler</p>\n<p>executionchain就是interceptor和实际处理方法的结合体</p>\n<h3 id=\"映射关系\"><a href=\"#映射关系\" class=\"headerlink\" title=\"映射关系\"></a>映射关系</h3><p><em>url -&gt; HandlerMethod</em></p>\n<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal</p>\n<p><code>HandlerMethod</code>是具体的controller对应的方法.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mappingLookup = &#123;LinkedHashMap@6069&#125;  size = 4</span><br><span class=\"line\"> 0 = &#123;LinkedHashMap$Entry@6077&#125; &quot;&#123;[/async]&#125;&quot; -&gt; &quot;public java.util.concurrent.Callable&lt;java.lang.String&gt; com.air.mvc.AsyncController.asyncProcess()&quot;</span><br><span class=\"line\"> 1 = &#123;LinkedHashMap$Entry@6078&#125; &quot;&#123;[/asyncV2]&#125;&quot; -&gt; &quot;public org.springframework.web.context.request.async.DeferredResult&lt;java.lang.String&gt; com.air.mvc.AsyncController.aysncProcess2()&quot;</span><br><span class=\"line\"> 2 = &#123;LinkedHashMap$Entry@6079&#125; &quot;&#123;[/mvc/echo]&#125;&quot; -&gt; &quot;private java.lang.String com.air.mvc.SampleController.echo(javax.servlet.http.HttpServletRequest)&quot;</span><br><span class=\"line\"> 3 = &#123;LinkedHashMap$Entry@6080&#125; &quot;&#123;[/mvc/test]&#125;&quot; -&gt; &quot;private java.lang.String com.air.mvc.SampleController.echo(java.lang.String)&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"interceptor\"><a href=\"#interceptor\" class=\"headerlink\" title=\"interceptor\"></a>interceptor</h3><p><em>url -&gt; interceptors</em></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /mvc/test</span></span><br><span class=\"line\">String lookupPath = <span class=\"keyword\">this</span>.urlPathHelper.getLookupPathForRequest(request);</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (HandlerInterceptor interceptor : <span class=\"keyword\">this</span>.adaptedInterceptors) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (interceptor <span class=\"keyword\">instanceof</span> MappedInterceptor) &#123;</span><br><span class=\"line\">\t\t\t\tMappedInterceptor mappedInterceptor = (MappedInterceptor) interceptor;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (mappedInterceptor.matches(lookupPath, <span class=\"keyword\">this</span>.pathMatcher)) &#123;</span><br><span class=\"line\">\t\t\t\t\tchain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tchain.addInterceptor(interceptor);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"HandlerAdapter\"><a href=\"#HandlerAdapter\" class=\"headerlink\" title=\"HandlerAdapter\"></a>HandlerAdapter</h2><p><em>HandlerMethod -&gt; HandlerAdapter</em></p>\n<p>// RequestMappingHandlerAdapter<br>org.springframework.web.servlet.DispatcherServlet#getHandlerAdapter</p>\n<p>遍历所有的<code>HandlerAdapters</code>, 找到第一个能处理的<code>HandlerAdapter</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> HandlerAdapter <span class=\"title\">getHandlerAdapter</span><span class=\"params\">(Object handler)</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (HandlerAdapter ha : <span class=\"keyword\">this</span>.handlerAdapters) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.trace(<span class=\"string\">\"Testing handler adapter [\"</span> + ha + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (ha.supports(handler)) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ha;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"No adapter for handler [\"</span> + handler +</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">\"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler\"</span>);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>默认的<code>HandlerAdapters</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.handlerAdapters = &#123;ArrayList@5983&#125;  size = 3</span><br><span class=\"line\"> 0 = &#123;RequestMappingHandlerAdapter@4845&#125; </span><br><span class=\"line\"> 1 = &#123;HttpRequestHandlerAdapter@6268&#125; </span><br><span class=\"line\"> 2 = &#123;SimpleControllerHandlerAdapter@6269&#125;</span><br></pre></td></tr></table></figure>\n<p>涉及到的请求处理:</p>\n<pre><code>a. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod\n    调用对应的controller方法\n\nb. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#getModelAndView\n    返回模型和视图\n</code></pre><h2 id=\"ServletInvocableHandlerMethod\"><a href=\"#ServletInvocableHandlerMethod\" class=\"headerlink\" title=\"ServletInvocableHandlerMethod\"></a>ServletInvocableHandlerMethod</h2><p><em>HandlerMethod -&gt; ServletInvocableHandlerMethod</em></p>\n<p>org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle</p>\n<p>   a. InvocableHandlerMethod#invokeForRequest</p>\n<pre><code>    1. 解析传递的参数, 必要时进行转换(resolver负责映射输入的参数名称和controller方法对应的参数, dataBinder负责类型转换和校验)\n    2. 反射调用对应的方法\n\nb. returnValueHandlers#handleReturnValue\n    从所有的handler中找到第一个支持对应返回值类型的处理返回值, 可能涉及`HttpMessageConverter`\n</code></pre><h3 id=\"argumentResolvers\"><a href=\"#argumentResolvers\" class=\"headerlink\" title=\"argumentResolvers\"></a>argumentResolvers</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.argumentResolvers = &#123;HandlerMethodArgumentResolverComposite@4853&#125; </span><br><span class=\"line\"> logger = &#123;SLF4JLocationAwareLog@6533&#125; </span><br><span class=\"line\"> argumentResolvers = &#123;LinkedList@6534&#125;  size = 26</span><br><span class=\"line\">  0 = &#123;RequestParamMethodArgumentResolver@5292&#125; </span><br><span class=\"line\">  1 = &#123;RequestParamMapMethodArgumentResolver@6541&#125; </span><br><span class=\"line\">  2 = &#123;PathVariableMethodArgumentResolver@6542&#125; </span><br><span class=\"line\">  3 = &#123;PathVariableMapMethodArgumentResolver@6543&#125; </span><br><span class=\"line\">  4 = &#123;MatrixVariableMethodArgumentResolver@6544&#125; </span><br><span class=\"line\">  5 = &#123;MatrixVariableMapMethodArgumentResolver@6545&#125; </span><br><span class=\"line\">  6 = &#123;ServletModelAttributeMethodProcessor@6546&#125; </span><br><span class=\"line\">  7 = &#123;RequestResponseBodyMethodProcessor@6547&#125; </span><br><span class=\"line\">  8 = &#123;RequestPartMethodArgumentResolver@6548&#125; </span><br><span class=\"line\">  9 = &#123;RequestHeaderMethodArgumentResolver@6549&#125; </span><br><span class=\"line\">  10 = &#123;RequestHeaderMapMethodArgumentResolver@6550&#125; </span><br><span class=\"line\">  11 = &#123;ServletCookieValueMethodArgumentResolver@6551&#125; </span><br><span class=\"line\">  12 = &#123;ExpressionValueMethodArgumentResolver@6552&#125; </span><br><span class=\"line\">  13 = &#123;SessionAttributeMethodArgumentResolver@6553&#125; </span><br><span class=\"line\">  14 = &#123;RequestAttributeMethodArgumentResolver@6554&#125; </span><br><span class=\"line\">  15 = &#123;ServletRequestMethodArgumentResolver@6555&#125; </span><br><span class=\"line\">  16 = &#123;ServletResponseMethodArgumentResolver@6556&#125; </span><br><span class=\"line\">  17 = &#123;HttpEntityMethodProcessor@6557&#125; </span><br><span class=\"line\">  18 = &#123;RedirectAttributesMethodArgumentResolver@6558&#125; </span><br><span class=\"line\">  19 = &#123;ModelMethodProcessor@6559&#125; </span><br><span class=\"line\">  20 = &#123;MapMethodProcessor@6560&#125; </span><br><span class=\"line\">  21 = &#123;ErrorsMethodArgumentResolver@6561&#125; </span><br><span class=\"line\">  22 = &#123;SessionStatusMethodArgumentResolver@6562&#125; </span><br><span class=\"line\">  23 = &#123;UriComponentsBuilderMethodArgumentResolver@6563&#125; </span><br><span class=\"line\">  24 = &#123;RequestParamMethodArgumentResolver@6564&#125; </span><br><span class=\"line\">  25 = &#123;ServletModelAttributeMethodProcessor@6565&#125; </span><br><span class=\"line\"> argumentResolverCache = &#123;ConcurrentHashMap@6535&#125;  size = 1</span><br><span class=\"line\">  0 = &#123;ConcurrentHashMap$MapEntry@6538&#125; &quot;method &apos;echo&apos; parameter 0&quot; -&gt; </span><br><span class=\"line\">   key = &#123;HandlerMethod$HandlerMethodParameter@5293&#125; &quot;method &apos;echo&apos; parameter 0&quot;</span><br><span class=\"line\">   value = &#123;RequestParamMethodArgumentResolver@5292&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"returnValueHandlers\"><a href=\"#returnValueHandlers\" class=\"headerlink\" title=\"returnValueHandlers\"></a>returnValueHandlers</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.returnValueHandlers = &#123;HandlerMethodReturnValueHandlerComposite@4855&#125; </span><br><span class=\"line\"> logger = &#123;SLF4JLocationAwareLog@6567&#125; </span><br><span class=\"line\"> returnValueHandlers = &#123;ArrayList@6568&#125;  size = 15</span><br><span class=\"line\">  0 = &#123;ModelAndViewMethodReturnValueHandler@6570&#125; </span><br><span class=\"line\">  1 = &#123;ModelMethodProcessor@6571&#125; </span><br><span class=\"line\">  2 = &#123;ViewMethodReturnValueHandler@6572&#125; </span><br><span class=\"line\">  3 = &#123;ResponseBodyEmitterReturnValueHandler@6573&#125; </span><br><span class=\"line\">  4 = &#123;StreamingResponseBodyReturnValueHandler@6574&#125; </span><br><span class=\"line\">  5 = &#123;HttpEntityMethodProcessor@6575&#125; </span><br><span class=\"line\">  6 = &#123;HttpHeadersReturnValueHandler@6576&#125; </span><br><span class=\"line\">  7 = &#123;CallableMethodReturnValueHandler@6577&#125; </span><br><span class=\"line\">  8 = &#123;DeferredResultMethodReturnValueHandler@6578&#125; </span><br><span class=\"line\">  9 = &#123;AsyncTaskMethodReturnValueHandler@6579&#125; </span><br><span class=\"line\">  10 = &#123;ModelAttributeMethodProcessor@6580&#125; </span><br><span class=\"line\">  11 = &#123;RequestResponseBodyMethodProcessor@6581&#125; </span><br><span class=\"line\">  12 = &#123;ViewNameMethodReturnValueHandler@6582&#125; </span><br><span class=\"line\">  13 = &#123;MapMethodProcessor@6583&#125; </span><br><span class=\"line\">  14 = &#123;ModelAttributeMethodProcessor@6584&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"binderFactory\"><a href=\"#binderFactory\" class=\"headerlink\" title=\"binderFactory\"></a>binderFactory</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binderFactory = &#123;ServletRequestDataBinderFactory@6498&#125; </span><br><span class=\"line\"> binderMethods = &#123;ArrayList@6585&#125;  size = 0</span><br><span class=\"line\"> initializer = &#123;ConfigurableWebBindingInitializer@4859&#125; </span><br><span class=\"line\">  autoGrowNestedPaths = true</span><br><span class=\"line\">  directFieldAccess = false</span><br><span class=\"line\">  messageCodesResolver = null</span><br><span class=\"line\">  bindingErrorProcessor = null</span><br><span class=\"line\">  validator = null</span><br><span class=\"line\">  conversionService = &#123;DefaultFormattingConversionService@6586&#125; &quot;ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccess&quot;</span><br><span class=\"line\">   embeddedValueResolver = &#123;EmbeddedValueResolver@6003&#125; </span><br><span class=\"line\">   cachedPrinters = &#123;ConcurrentHashMap@6588&#125;  size = 0</span><br><span class=\"line\">   cachedParsers = &#123;ConcurrentHashMap@6589&#125;  size = 0</span><br><span class=\"line\">   converters = &#123;GenericConversionService$Converters@6590&#125; &quot;ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccess&quot;</span><br><span class=\"line\">    globalConverters = &#123;LinkedHashSet@6593&#125;  size = 0</span><br><span class=\"line\">    converters = &#123;LinkedHashMap@6594&#125;  size = 118</span><br><span class=\"line\">     0 = &#123;LinkedHashMap$Entry@6597&#125; &quot;java.lang.Number -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.Number : org.springframework.core.convert.support.NumberToNumberConverterFactory@76561efa&quot;</span><br><span class=\"line\">     1 = &#123;LinkedHashMap$Entry@6598&#125; &quot;java.lang.String -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Number : org.springframework.core.convert.support.StringToNumberConverterFactory@1bf7855e&quot;</span><br><span class=\"line\">     2 = &#123;LinkedHashMap$Entry@6599&#125; &quot;java.lang.Number -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@3932e255&quot;</span><br><span class=\"line\">     3 = &#123;LinkedHashMap$Entry@6600&#125; &quot;java.lang.String -&gt; java.lang.Character&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Character : org.springframework.core.convert.support.StringToCharacterConverter@55a6b63f&quot;</span><br><span class=\"line\">     4 = &#123;LinkedHashMap$Entry@6601&#125; &quot;java.lang.Character -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Character -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@1341d3bf&quot;</span><br><span class=\"line\">     5 = &#123;LinkedHashMap$Entry@6602&#125; &quot;java.lang.Number -&gt; java.lang.Character&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.Character : org.springframework.core.convert.support.NumberToCharacterConverter@34bb79fc&quot;</span><br><span class=\"line\">     6 = &#123;LinkedHashMap$Entry@6603&#125; &quot;java.lang.Character -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.Character -&gt; java.lang.Number : org.springframework.core.convert.support.CharacterToNumberFactory@1ab51574&quot;</span><br><span class=\"line\">     7 = &#123;LinkedHashMap$Entry@6604&#125; &quot;java.lang.String -&gt; java.lang.Boolean&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Boolean : org.springframework.core.convert.support.StringToBooleanConverter@7ac24f53&quot;</span><br><span class=\"line\">     8 = &#123;LinkedHashMap$Entry@6605&#125; &quot;java.lang.Boolean -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Boolean -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@6703b79f&quot;</span><br><span class=\"line\">     9 = &#123;LinkedHashMap$Entry@6606&#125; &quot;java.lang.String -&gt; java.lang.Enum&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Enum : org.springframework.core.convert.support.StringToEnumConverterFactory@898561a&quot;</span><br><span class=\"line\">     10 = &#123;LinkedHashMap$Entry@6607&#125; &quot;java.lang.Enum -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Enum -&gt; java.lang.String : org.springframework.core.convert.support.EnumToStringConverter@3a34ecc8&quot;</span><br><span class=\"line\">     11 = &#123;LinkedHashMap$Entry@6608&#125; &quot;java.lang.Integer -&gt; java.lang.Enum&quot; -&gt; &quot;java.lang.Integer -&gt; java.lang.Enum : org.springframework.core.convert.support.IntegerToEnumConverterFactory@52e4840a&quot;</span><br><span class=\"line\">     12 = &#123;LinkedHashMap$Entry@6609&#125; &quot;java.lang.Enum -&gt; java.lang.Integer&quot; -&gt; &quot;java.lang.Enum -&gt; java.lang.Integer : org.springframework.core.convert.support.EnumToIntegerConverter@28217e86&quot;</span><br><span class=\"line\">     13 = &#123;LinkedHashMap$Entry@6610&#125; &quot;java.lang.String -&gt; java.util.Locale&quot; -&gt; &quot;java.lang.String -&gt; java.util.Locale : org.springframework.core.convert.support.StringToLocaleConverter@6243d51e&quot;</span><br><span class=\"line\">     14 = &#123;LinkedHashMap$Entry@6611&#125; &quot;java.util.Locale -&gt; java.lang.String&quot; -&gt; &quot;java.util.Locale -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@7f8c2732&quot;</span><br><span class=\"line\">     15 = &#123;LinkedHashMap$Entry@6612&#125; &quot;java.lang.String -&gt; java.nio.charset.Charset&quot; -&gt; &quot;java.lang.String -&gt; java.nio.charset.Charset : org.springframework.core.convert.support.StringToCharsetConverter@93e281d&quot;</span><br><span class=\"line\">     16 = &#123;LinkedHashMap$Entry@6613&#125; &quot;java.nio.charset.Charset -&gt; java.lang.String&quot; -&gt; &quot;java.nio.charset.Charset -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@2ac8a2f2&quot;</span><br><span class=\"line\">     17 = &#123;LinkedHashMap$Entry@6614&#125; &quot;java.lang.String -&gt; java.util.Currency&quot; -&gt; &quot;java.lang.String -&gt; java.util.Currency : org.springframework.core.convert.support.StringToCurrencyConverter@565f7990&quot;</span><br><span class=\"line\">     18 = &#123;LinkedHashMap$Entry@6615&#125; &quot;java.util.Currency -&gt; java.lang.String&quot; -&gt; &quot;java.util.Currency -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@487461de&quot;</span><br><span class=\"line\">     19 = &#123;LinkedHashMap$Entry@6616&#125; &quot;java.lang.String -&gt; java.util.Properties&quot; -&gt; &quot;java.lang.String -&gt; java.util.Properties : org.springframework.core.convert.support.StringToPropertiesConverter@3072d60d&quot;</span><br><span class=\"line\">     20 = &#123;LinkedHashMap$Entry@6617&#125; &quot;java.util.Properties -&gt; java.lang.String&quot; -&gt; &quot;java.util.Properties -&gt; java.lang.String : org.springframework.core.convert.support.PropertiesToStringConverter@5f423dc3&quot;</span><br><span class=\"line\">     21 = &#123;LinkedHashMap$Entry@6618&#125; &quot;java.lang.String -&gt; java.util.UUID&quot; -&gt; &quot;java.lang.String -&gt; java.util.UUID : org.springframework.core.convert.support.StringToUUIDConverter@72fc4c42&quot;</span><br><span class=\"line\">     22 = &#123;LinkedHashMap$Entry@6619&#125; &quot;java.util.UUID -&gt; java.lang.String&quot; -&gt; &quot;java.util.UUID -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@196db952&quot;</span><br><span class=\"line\">     23 = &#123;LinkedHashMap$Entry@6620&#125; &quot;[Ljava.lang.Object; -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToCollectionConverter@3f09c6cc&quot;</span><br><span class=\"line\">     24 = &#123;LinkedHashMap$Entry@6621&#125; &quot;java.util.Collection -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToArrayConverter@716b58cb&quot;</span><br><span class=\"line\">     25 = &#123;LinkedHashMap$Entry@6622&#125; &quot;[Ljava.lang.Object; -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToArrayConverter@61e594f8&quot;</span><br><span class=\"line\">     26 = &#123;LinkedHashMap$Entry@6623&#125; &quot;java.util.Collection -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToCollectionConverter@153616bf&quot;</span><br><span class=\"line\">     27 = &#123;LinkedHashMap$Entry@6624&#125; &quot;java.util.Map -&gt; java.util.Map&quot; -&gt; &quot;org.springframework.core.convert.support.MapToMapConverter@64f88d73&quot;</span><br><span class=\"line\">     28 = &#123;LinkedHashMap$Entry@6625&#125; &quot;[Ljava.lang.Object; -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToStringConverter@4f7e3c27&quot;</span><br><span class=\"line\">     29 = &#123;LinkedHashMap$Entry@6626&#125; &quot;java.lang.String -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.StringToArrayConverter@2713364&quot;</span><br><span class=\"line\">     30 = &#123;LinkedHashMap$Entry@6627&#125; &quot;[Ljava.lang.Object; -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToObjectConverter@27574e7b&quot;</span><br><span class=\"line\">     31 = &#123;LinkedHashMap$Entry@6628&#125; &quot;java.lang.Object -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToArrayConverter@7e4ccf7&quot;</span><br><span class=\"line\">     32 = &#123;LinkedHashMap$Entry@6629&#125; &quot;java.util.Collection -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToStringConverter@39455728&quot;</span><br><span class=\"line\">     33 = &#123;LinkedHashMap$Entry@6630&#125; &quot;java.lang.String -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.StringToCollectionConverter@32a4a977&quot;</span><br><span class=\"line\">     34 = &#123;LinkedHashMap$Entry@6631&#125; &quot;java.util.Collection -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToObjectConverter@2f1d1dce&quot;</span><br><span class=\"line\">     35 = &#123;LinkedHashMap$Entry@6632&#125; &quot;java.lang.Object -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToCollectionConverter@ebfffae&quot;</span><br><span class=\"line\">     36 = &#123;LinkedHashMap$Entry@6633&#125; &quot;[Ljava.lang.Object; -&gt; java.util.stream.Stream&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     37 = &#123;LinkedHashMap$Entry@6634&#125; &quot;java.util.Collection -&gt; java.util.stream.Stream&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     38 = &#123;LinkedHashMap$Entry@6635&#125; &quot;java.util.stream.Stream -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     39 = &#123;LinkedHashMap$Entry@6636&#125; &quot;java.util.stream.Stream -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     40 = &#123;LinkedHashMap$Entry@6637&#125; &quot;java.nio.ByteBuffer -&gt; [B&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     41 = &#123;LinkedHashMap$Entry@6638&#125; &quot;java.nio.ByteBuffer -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     42 = &#123;LinkedHashMap$Entry@6639&#125; &quot;java.lang.Object -&gt; java.nio.ByteBuffer&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     43 = &#123;LinkedHashMap$Entry@6640&#125; &quot;[B -&gt; java.nio.ByteBuffer&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     44 = &#123;LinkedHashMap$Entry@6641&#125; &quot;java.lang.String -&gt; java.util.TimeZone&quot; -&gt; &quot;java.lang.String -&gt; java.util.TimeZone : org.springframework.core.convert.support.StringToTimeZoneConverter@4d1c677c&quot;</span><br><span class=\"line\">     45 = &#123;LinkedHashMap$Entry@6642&#125; &quot;java.time.ZoneId -&gt; java.util.TimeZone&quot; -&gt; &quot;java.time.ZoneId -&gt; java.util.TimeZone : org.springframework.core.convert.support.ZoneIdToTimeZoneConverter@3c2fb3fe&quot;</span><br><span class=\"line\">     46 = &#123;LinkedHashMap$Entry@6643&#125; &quot;java.time.ZonedDateTime -&gt; java.util.Calendar&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.util.Calendar : org.springframework.core.convert.support.ZonedDateTimeToCalendarConverter@2148eb08&quot;</span><br><span class=\"line\">     47 = &#123;LinkedHashMap$Entry@6644&#125; &quot;java.lang.Object -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.IdToEntityConverter@6c69ab13,org.springframework.core.convert.support.ObjectToObjectConverter@42600665&quot;</span><br><span class=\"line\">     48 = &#123;LinkedHashMap$Entry@6645&#125; &quot;java.lang.Object -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.FallbackObjectToStringConverter@311fd94&quot;</span><br><span class=\"line\">     49 = &#123;LinkedHashMap$Entry@6646&#125; &quot;java.lang.Object -&gt; java.util.Optional&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToOptionalConverter@65e75655&quot;</span><br><span class=\"line\">     50 = &#123;LinkedHashMap$Entry@6647&#125; &quot;java.lang.Integer -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Integer -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     51 = &#123;LinkedHashMap$Entry@6648&#125; &quot;java.lang.String -&gt; java.lang.Integer&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Integer: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     52 = &#123;LinkedHashMap$Entry@6649&#125; &quot;java.lang.Float -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Float -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     53 = &#123;LinkedHashMap$Entry@6650&#125; &quot;java.lang.String -&gt; java.lang.Float&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Float: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     54 = &#123;LinkedHashMap$Entry@6651&#125; &quot;java.math.BigInteger -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.math.BigInteger -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     55 = &#123;LinkedHashMap$Entry@6652&#125; &quot;java.lang.String -&gt; java.math.BigInteger&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.math.BigInteger: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     56 = &#123;LinkedHashMap$Entry@6653&#125; &quot;java.lang.Byte -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Byte -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     57 = &#123;LinkedHashMap$Entry@6654&#125; &quot;java.lang.String -&gt; java.lang.Byte&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Byte: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     58 = &#123;LinkedHashMap$Entry@6655&#125; &quot;java.lang.Double -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Double -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     59 = &#123;LinkedHashMap$Entry@6656&#125; &quot;java.lang.String -&gt; java.lang.Double&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Double: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     60 = &#123;LinkedHashMap$Entry@6657&#125; &quot;java.lang.Short -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Short -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     61 = &#123;LinkedHashMap$Entry@6658&#125; &quot;java.lang.String -&gt; java.lang.Short&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Short: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     62 = &#123;LinkedHashMap$Entry@6659&#125; &quot;java.lang.Long -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     63 = &#123;LinkedHashMap$Entry@6660&#125; &quot;java.lang.String -&gt; java.lang.Long&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.lang.Long: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Long: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     64 = &#123;LinkedHashMap$Entry@6661&#125; &quot;java.math.BigDecimal -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.math.BigDecimal -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     65 = &#123;LinkedHashMap$Entry@6662&#125; &quot;java.lang.String -&gt; java.math.BigDecimal&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.math.BigDecimal: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     66 = &#123;LinkedHashMap$Entry@6663&#125; &quot;java.util.Date -&gt; java.lang.Long&quot; -&gt; &quot;java.util.Date -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@a178d09,java.util.Date -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@551d27e0&quot;</span><br><span class=\"line\">     67 = &#123;LinkedHashMap$Entry@6664&#125; &quot;java.util.Date -&gt; java.util.Calendar&quot; -&gt; &quot;java.util.Date -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@2bd20c9a,java.util.Date -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@1c6b5a31&quot;</span><br><span class=\"line\">     68 = &#123;LinkedHashMap$Entry@6665&#125; &quot;java.util.Calendar -&gt; java.util.Date&quot; -&gt; &quot;java.util.Calendar -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@2aa2f370,java.util.Calendar -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@163cf3e3&quot;</span><br><span class=\"line\">     69 = &#123;LinkedHashMap$Entry@6666&#125; &quot;java.util.Calendar -&gt; java.lang.Long&quot; -&gt; &quot;java.util.Calendar -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@2db18b62,java.util.Calendar -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@6bcdf637&quot;</span><br><span class=\"line\">     70 = &#123;LinkedHashMap$Entry@6667&#125; &quot;java.lang.Long -&gt; java.util.Date&quot; -&gt; &quot;java.lang.Long -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@56c9b14d,java.lang.Long -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@271bf39c&quot;</span><br><span class=\"line\">     71 = &#123;LinkedHashMap$Entry@6668&#125; &quot;java.lang.Long -&gt; java.util.Calendar&quot; -&gt; &quot;java.lang.Long -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@6d08686,java.lang.Long -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@2a8b425&quot;</span><br><span class=\"line\">     72 = &#123;LinkedHashMap$Entry@6669&#125; &quot;java.time.LocalDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.LocalDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalDateConverter@19f02ee4&quot;</span><br><span class=\"line\">     73 = &#123;LinkedHashMap$Entry@6670&#125; &quot;java.time.LocalDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.LocalDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalTimeConverter@618fb955&quot;</span><br><span class=\"line\">     74 = &#123;LinkedHashMap$Entry@6671&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateConverter@63e9f754&quot;</span><br><span class=\"line\">     75 = &#123;LinkedHashMap$Entry@6672&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalTimeConverter@24a76e90&quot;</span><br><span class=\"line\">     76 = &#123;LinkedHashMap$Entry@6673&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateTimeConverter@3cb8e3ee&quot;</span><br><span class=\"line\">     77 = &#123;LinkedHashMap$Entry@6674&#125; &quot;java.time.ZonedDateTime -&gt; java.time.OffsetDateTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToOffsetDateTimeConverter@2061a03d&quot;</span><br><span class=\"line\">     78 = &#123;LinkedHashMap$Entry@6675&#125; &quot;java.time.ZonedDateTime -&gt; java.time.Instant&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToInstantConverter@c1ea032&quot;</span><br><span class=\"line\">     79 = &#123;LinkedHashMap$Entry@6676&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateConverter@13d29ccf&quot;</span><br><span class=\"line\">     80 = &#123;LinkedHashMap$Entry@6677&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalTimeConverter@680eaac8&quot;</span><br><span class=\"line\">     81 = &#123;LinkedHashMap$Entry@6678&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateTimeConverter@45438fbc&quot;</span><br><span class=\"line\">     82 = &#123;LinkedHashMap$Entry@6679&#125; &quot;java.time.OffsetDateTime -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToZonedDateTimeConverter@3ca5a816&quot;</span><br><span class=\"line\">     83 = &#123;LinkedHashMap$Entry@6680&#125; &quot;java.time.OffsetDateTime -&gt; java.time.Instant&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToInstantConverter@3b166fa9&quot;</span><br><span class=\"line\">     84 = &#123;LinkedHashMap$Entry@6681&#125; &quot;java.util.Calendar -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToZonedDateTimeConverter@2653dae9&quot;</span><br><span class=\"line\">     85 = &#123;LinkedHashMap$Entry@6682&#125; &quot;java.util.Calendar -&gt; java.time.OffsetDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToOffsetDateTimeConverter@7f348ff0&quot;</span><br><span class=\"line\">     86 = &#123;LinkedHashMap$Entry@6683&#125; &quot;java.util.Calendar -&gt; java.time.LocalDate&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateConverter@6e407d18&quot;</span><br><span class=\"line\">     87 = &#123;LinkedHashMap$Entry@6684&#125; &quot;java.util.Calendar -&gt; java.time.LocalTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalTimeConverter@66a32c5e&quot;</span><br><span class=\"line\">     88 = &#123;LinkedHashMap$Entry@6685&#125; &quot;java.util.Calendar -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateTimeConverter@5e9f36f1&quot;</span><br><span class=\"line\">     89 = &#123;LinkedHashMap$Entry@6686&#125; &quot;java.util.Calendar -&gt; java.time.Instant&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToInstantConverter@50f69dd&quot;</span><br><span class=\"line\">     90 = &#123;LinkedHashMap$Entry@6687&#125; &quot;java.lang.Long -&gt; java.time.Instant&quot; -&gt; &quot;java.lang.Long -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$LongToInstantConverter@684a7cd9&quot;</span><br><span class=\"line\">     91 = &#123;LinkedHashMap$Entry@6688&#125; &quot;java.time.Instant -&gt; java.lang.Long&quot; -&gt; &quot;java.time.Instant -&gt; java.lang.Long : org.springframework.format.datetime.standard.DateTimeConverters$InstantToLongConverter@17f47c52&quot;</span><br><span class=\"line\">     92 = &#123;LinkedHashMap$Entry@6689&#125; &quot;java.time.LocalDate -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0&quot;</span><br><span class=\"line\">     93 = &#123;LinkedHashMap$Entry@6690&#125; &quot;java.lang.String -&gt; java.time.LocalDate&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalDate: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalDate: org.springframework.format.datetime.standard.TemporalAccessorParser@75d32f15&quot;</span><br><span class=\"line\">     94 = &#123;LinkedHashMap$Entry@6691&#125; &quot;java.time.LocalTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41f1db11&quot;</span><br><span class=\"line\">     95 = &#123;LinkedHashMap$Entry@6692&#125; &quot;java.lang.String -&gt; java.time.LocalTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2ea20f2c&quot;</span><br><span class=\"line\">     96 = &#123;LinkedHashMap$Entry@6693&#125; &quot;java.time.LocalDateTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41fc9576&quot;</span><br><span class=\"line\">     97 = &#123;LinkedHashMap$Entry@6694&#125; &quot;java.lang.String -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2dbba1db&quot;</span><br><span class=\"line\">     98 = &#123;LinkedHashMap$Entry@6695&#125; &quot;java.time.ZonedDateTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.ZonedDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@625dde2e&quot;</span><br><span class=\"line\">     99 = &#123;LinkedHashMap$Entry@6696&#125; &quot;java.lang.String -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.ZonedDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@5cb87626&quot;</span><br><span class=\"line\">   converterCache = &#123;ConcurrentReferenceHashMap@6591&#125;  size = 1</span><br><span class=\"line\">    0 = &#123;ConcurrentReferenceHashMap$Entry@7099&#125; &quot;ConverterCacheKey [sourceType = java.lang.String, targetType = @org.springframework.web.bind.annotation.RequestParam java.lang.String]&quot; -&gt; &quot;NO_OP&quot;</span><br><span class=\"line\">  propertyEditorRegistrars = null</span><br></pre></td></tr></table></figure>\n<h3 id=\"parameterNameDiscoverer\"><a href=\"#parameterNameDiscoverer\" class=\"headerlink\" title=\"parameterNameDiscoverer\"></a>parameterNameDiscoverer</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.parameterNameDiscoverer = &#123;DefaultParameterNameDiscoverer@4866&#125; </span><br><span class=\"line\"> parameterNameDiscoverers = &#123;LinkedList@7309&#125;  size = 2</span><br><span class=\"line\">  0 = &#123;StandardReflectionParameterNameDiscoverer@7311&#125; </span><br><span class=\"line\">  1 = &#123;LocalVariableTableParameterNameDiscoverer@7312&#125;</span><br></pre></td></tr></table></figure>\n<p>容器的启动过程以及一次请求的详细处理过程: <a href=\"springmvc.log\">启动日志</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>启动流程的分析见: <a href=\"/2016/10/02/spring-mvc/\" title=\"Spring Mvc源码剖析(一)\">Spring Mvc源码剖析(一)</a></p>\n<img src=\"/2018/05/06/spring-mvc-2/spring-mvc.png\">\n<h2 id=\"源码版本\"><a href=\"#源码版本\" class=\"headerlink\" title=\"源码版本\"></a>源码版本</h2><blockquote>\n<p>4.3.6.RELEASE</p>\n</blockquote>\n<h2 id=\"HandlerExecutionChain\"><a href=\"#HandlerExecutionChain\" class=\"headerlink\" title=\"HandlerExecutionChain\"></a>HandlerExecutionChain</h2><p><em>request -&gt; executionchain</em></p>\n<p>// RequestMappingHandlerMapping<br>遍历已有的<code>HandlerMapping</code>, 找到第一个能处理的<code>HandlerMapping</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> HandlerExecutionChain <span class=\"title\">getHandler</span><span class=\"params\">(HttpServletRequest request)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (HandlerMapping hm : <span class=\"keyword\">this</span>.handlerMappings) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.trace(</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"Testing handler map [\"</span> + hm + <span class=\"string\">\"] in DispatcherServlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tHandlerExecutionChain handler = hm.getHandler(request);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (handler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> handler;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>handlerMappings的值默认是:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.handlerMappings = &#123;ArrayList@5980&#125;  size = 2</span><br><span class=\"line\"> 0 = &#123;RequestMappingHandlerMapping@5997&#125; </span><br><span class=\"line\"> 1 = &#123;BeanNameUrlHandlerMapping@6002&#125;</span><br></pre></td></tr></table></figure>\n<p>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler</p>\n<p>executionchain就是interceptor和实际处理方法的结合体</p>\n<h3 id=\"映射关系\"><a href=\"#映射关系\" class=\"headerlink\" title=\"映射关系\"></a>映射关系</h3><p><em>url -&gt; HandlerMethod</em></p>\n<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal</p>\n<p><code>HandlerMethod</code>是具体的controller对应的方法.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mappingLookup = &#123;LinkedHashMap@6069&#125;  size = 4</span><br><span class=\"line\"> 0 = &#123;LinkedHashMap$Entry@6077&#125; &quot;&#123;[/async]&#125;&quot; -&gt; &quot;public java.util.concurrent.Callable&lt;java.lang.String&gt; com.air.mvc.AsyncController.asyncProcess()&quot;</span><br><span class=\"line\"> 1 = &#123;LinkedHashMap$Entry@6078&#125; &quot;&#123;[/asyncV2]&#125;&quot; -&gt; &quot;public org.springframework.web.context.request.async.DeferredResult&lt;java.lang.String&gt; com.air.mvc.AsyncController.aysncProcess2()&quot;</span><br><span class=\"line\"> 2 = &#123;LinkedHashMap$Entry@6079&#125; &quot;&#123;[/mvc/echo]&#125;&quot; -&gt; &quot;private java.lang.String com.air.mvc.SampleController.echo(javax.servlet.http.HttpServletRequest)&quot;</span><br><span class=\"line\"> 3 = &#123;LinkedHashMap$Entry@6080&#125; &quot;&#123;[/mvc/test]&#125;&quot; -&gt; &quot;private java.lang.String com.air.mvc.SampleController.echo(java.lang.String)&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"interceptor\"><a href=\"#interceptor\" class=\"headerlink\" title=\"interceptor\"></a>interceptor</h3><p><em>url -&gt; interceptors</em></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  /mvc/test</span></span><br><span class=\"line\">String lookupPath = <span class=\"keyword\">this</span>.urlPathHelper.getLookupPathForRequest(request);</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (HandlerInterceptor interceptor : <span class=\"keyword\">this</span>.adaptedInterceptors) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (interceptor <span class=\"keyword\">instanceof</span> MappedInterceptor) &#123;</span><br><span class=\"line\">\t\t\t\tMappedInterceptor mappedInterceptor = (MappedInterceptor) interceptor;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (mappedInterceptor.matches(lookupPath, <span class=\"keyword\">this</span>.pathMatcher)) &#123;</span><br><span class=\"line\">\t\t\t\t\tchain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tchain.addInterceptor(interceptor);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"HandlerAdapter\"><a href=\"#HandlerAdapter\" class=\"headerlink\" title=\"HandlerAdapter\"></a>HandlerAdapter</h2><p><em>HandlerMethod -&gt; HandlerAdapter</em></p>\n<p>// RequestMappingHandlerAdapter<br>org.springframework.web.servlet.DispatcherServlet#getHandlerAdapter</p>\n<p>遍历所有的<code>HandlerAdapters</code>, 找到第一个能处理的<code>HandlerAdapter</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> HandlerAdapter <span class=\"title\">getHandlerAdapter</span><span class=\"params\">(Object handler)</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (HandlerAdapter ha : <span class=\"keyword\">this</span>.handlerAdapters) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.trace(<span class=\"string\">\"Testing handler adapter [\"</span> + ha + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (ha.supports(handler)) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ha;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"No adapter for handler [\"</span> + handler +</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">\"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler\"</span>);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>默认的<code>HandlerAdapters</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.handlerAdapters = &#123;ArrayList@5983&#125;  size = 3</span><br><span class=\"line\"> 0 = &#123;RequestMappingHandlerAdapter@4845&#125; </span><br><span class=\"line\"> 1 = &#123;HttpRequestHandlerAdapter@6268&#125; </span><br><span class=\"line\"> 2 = &#123;SimpleControllerHandlerAdapter@6269&#125;</span><br></pre></td></tr></table></figure>\n<p>涉及到的请求处理:</p>\n<pre><code>a. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod\n    调用对应的controller方法\n\nb. org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#getModelAndView\n    返回模型和视图\n</code></pre><h2 id=\"ServletInvocableHandlerMethod\"><a href=\"#ServletInvocableHandlerMethod\" class=\"headerlink\" title=\"ServletInvocableHandlerMethod\"></a>ServletInvocableHandlerMethod</h2><p><em>HandlerMethod -&gt; ServletInvocableHandlerMethod</em></p>\n<p>org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle</p>\n<p>   a. InvocableHandlerMethod#invokeForRequest</p>\n<pre><code>    1. 解析传递的参数, 必要时进行转换(resolver负责映射输入的参数名称和controller方法对应的参数, dataBinder负责类型转换和校验)\n    2. 反射调用对应的方法\n\nb. returnValueHandlers#handleReturnValue\n    从所有的handler中找到第一个支持对应返回值类型的处理返回值, 可能涉及`HttpMessageConverter`\n</code></pre><h3 id=\"argumentResolvers\"><a href=\"#argumentResolvers\" class=\"headerlink\" title=\"argumentResolvers\"></a>argumentResolvers</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.argumentResolvers = &#123;HandlerMethodArgumentResolverComposite@4853&#125; </span><br><span class=\"line\"> logger = &#123;SLF4JLocationAwareLog@6533&#125; </span><br><span class=\"line\"> argumentResolvers = &#123;LinkedList@6534&#125;  size = 26</span><br><span class=\"line\">  0 = &#123;RequestParamMethodArgumentResolver@5292&#125; </span><br><span class=\"line\">  1 = &#123;RequestParamMapMethodArgumentResolver@6541&#125; </span><br><span class=\"line\">  2 = &#123;PathVariableMethodArgumentResolver@6542&#125; </span><br><span class=\"line\">  3 = &#123;PathVariableMapMethodArgumentResolver@6543&#125; </span><br><span class=\"line\">  4 = &#123;MatrixVariableMethodArgumentResolver@6544&#125; </span><br><span class=\"line\">  5 = &#123;MatrixVariableMapMethodArgumentResolver@6545&#125; </span><br><span class=\"line\">  6 = &#123;ServletModelAttributeMethodProcessor@6546&#125; </span><br><span class=\"line\">  7 = &#123;RequestResponseBodyMethodProcessor@6547&#125; </span><br><span class=\"line\">  8 = &#123;RequestPartMethodArgumentResolver@6548&#125; </span><br><span class=\"line\">  9 = &#123;RequestHeaderMethodArgumentResolver@6549&#125; </span><br><span class=\"line\">  10 = &#123;RequestHeaderMapMethodArgumentResolver@6550&#125; </span><br><span class=\"line\">  11 = &#123;ServletCookieValueMethodArgumentResolver@6551&#125; </span><br><span class=\"line\">  12 = &#123;ExpressionValueMethodArgumentResolver@6552&#125; </span><br><span class=\"line\">  13 = &#123;SessionAttributeMethodArgumentResolver@6553&#125; </span><br><span class=\"line\">  14 = &#123;RequestAttributeMethodArgumentResolver@6554&#125; </span><br><span class=\"line\">  15 = &#123;ServletRequestMethodArgumentResolver@6555&#125; </span><br><span class=\"line\">  16 = &#123;ServletResponseMethodArgumentResolver@6556&#125; </span><br><span class=\"line\">  17 = &#123;HttpEntityMethodProcessor@6557&#125; </span><br><span class=\"line\">  18 = &#123;RedirectAttributesMethodArgumentResolver@6558&#125; </span><br><span class=\"line\">  19 = &#123;ModelMethodProcessor@6559&#125; </span><br><span class=\"line\">  20 = &#123;MapMethodProcessor@6560&#125; </span><br><span class=\"line\">  21 = &#123;ErrorsMethodArgumentResolver@6561&#125; </span><br><span class=\"line\">  22 = &#123;SessionStatusMethodArgumentResolver@6562&#125; </span><br><span class=\"line\">  23 = &#123;UriComponentsBuilderMethodArgumentResolver@6563&#125; </span><br><span class=\"line\">  24 = &#123;RequestParamMethodArgumentResolver@6564&#125; </span><br><span class=\"line\">  25 = &#123;ServletModelAttributeMethodProcessor@6565&#125; </span><br><span class=\"line\"> argumentResolverCache = &#123;ConcurrentHashMap@6535&#125;  size = 1</span><br><span class=\"line\">  0 = &#123;ConcurrentHashMap$MapEntry@6538&#125; &quot;method &apos;echo&apos; parameter 0&quot; -&gt; </span><br><span class=\"line\">   key = &#123;HandlerMethod$HandlerMethodParameter@5293&#125; &quot;method &apos;echo&apos; parameter 0&quot;</span><br><span class=\"line\">   value = &#123;RequestParamMethodArgumentResolver@5292&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"returnValueHandlers\"><a href=\"#returnValueHandlers\" class=\"headerlink\" title=\"returnValueHandlers\"></a>returnValueHandlers</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.returnValueHandlers = &#123;HandlerMethodReturnValueHandlerComposite@4855&#125; </span><br><span class=\"line\"> logger = &#123;SLF4JLocationAwareLog@6567&#125; </span><br><span class=\"line\"> returnValueHandlers = &#123;ArrayList@6568&#125;  size = 15</span><br><span class=\"line\">  0 = &#123;ModelAndViewMethodReturnValueHandler@6570&#125; </span><br><span class=\"line\">  1 = &#123;ModelMethodProcessor@6571&#125; </span><br><span class=\"line\">  2 = &#123;ViewMethodReturnValueHandler@6572&#125; </span><br><span class=\"line\">  3 = &#123;ResponseBodyEmitterReturnValueHandler@6573&#125; </span><br><span class=\"line\">  4 = &#123;StreamingResponseBodyReturnValueHandler@6574&#125; </span><br><span class=\"line\">  5 = &#123;HttpEntityMethodProcessor@6575&#125; </span><br><span class=\"line\">  6 = &#123;HttpHeadersReturnValueHandler@6576&#125; </span><br><span class=\"line\">  7 = &#123;CallableMethodReturnValueHandler@6577&#125; </span><br><span class=\"line\">  8 = &#123;DeferredResultMethodReturnValueHandler@6578&#125; </span><br><span class=\"line\">  9 = &#123;AsyncTaskMethodReturnValueHandler@6579&#125; </span><br><span class=\"line\">  10 = &#123;ModelAttributeMethodProcessor@6580&#125; </span><br><span class=\"line\">  11 = &#123;RequestResponseBodyMethodProcessor@6581&#125; </span><br><span class=\"line\">  12 = &#123;ViewNameMethodReturnValueHandler@6582&#125; </span><br><span class=\"line\">  13 = &#123;MapMethodProcessor@6583&#125; </span><br><span class=\"line\">  14 = &#123;ModelAttributeMethodProcessor@6584&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"binderFactory\"><a href=\"#binderFactory\" class=\"headerlink\" title=\"binderFactory\"></a>binderFactory</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binderFactory = &#123;ServletRequestDataBinderFactory@6498&#125; </span><br><span class=\"line\"> binderMethods = &#123;ArrayList@6585&#125;  size = 0</span><br><span class=\"line\"> initializer = &#123;ConfigurableWebBindingInitializer@4859&#125; </span><br><span class=\"line\">  autoGrowNestedPaths = true</span><br><span class=\"line\">  directFieldAccess = false</span><br><span class=\"line\">  messageCodesResolver = null</span><br><span class=\"line\">  bindingErrorProcessor = null</span><br><span class=\"line\">  validator = null</span><br><span class=\"line\">  conversionService = &#123;DefaultFormattingConversionService@6586&#125; &quot;ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccess&quot;</span><br><span class=\"line\">   embeddedValueResolver = &#123;EmbeddedValueResolver@6003&#125; </span><br><span class=\"line\">   cachedPrinters = &#123;ConcurrentHashMap@6588&#125;  size = 0</span><br><span class=\"line\">   cachedParsers = &#123;ConcurrentHashMap@6589&#125;  size = 0</span><br><span class=\"line\">   converters = &#123;GenericConversionService$Converters@6590&#125; &quot;ConversionService converters =\\n\\t@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0\\n\\t@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccess&quot;</span><br><span class=\"line\">    globalConverters = &#123;LinkedHashSet@6593&#125;  size = 0</span><br><span class=\"line\">    converters = &#123;LinkedHashMap@6594&#125;  size = 118</span><br><span class=\"line\">     0 = &#123;LinkedHashMap$Entry@6597&#125; &quot;java.lang.Number -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.Number : org.springframework.core.convert.support.NumberToNumberConverterFactory@76561efa&quot;</span><br><span class=\"line\">     1 = &#123;LinkedHashMap$Entry@6598&#125; &quot;java.lang.String -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Number : org.springframework.core.convert.support.StringToNumberConverterFactory@1bf7855e&quot;</span><br><span class=\"line\">     2 = &#123;LinkedHashMap$Entry@6599&#125; &quot;java.lang.Number -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@3932e255&quot;</span><br><span class=\"line\">     3 = &#123;LinkedHashMap$Entry@6600&#125; &quot;java.lang.String -&gt; java.lang.Character&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Character : org.springframework.core.convert.support.StringToCharacterConverter@55a6b63f&quot;</span><br><span class=\"line\">     4 = &#123;LinkedHashMap$Entry@6601&#125; &quot;java.lang.Character -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Character -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@1341d3bf&quot;</span><br><span class=\"line\">     5 = &#123;LinkedHashMap$Entry@6602&#125; &quot;java.lang.Number -&gt; java.lang.Character&quot; -&gt; &quot;java.lang.Number -&gt; java.lang.Character : org.springframework.core.convert.support.NumberToCharacterConverter@34bb79fc&quot;</span><br><span class=\"line\">     6 = &#123;LinkedHashMap$Entry@6603&#125; &quot;java.lang.Character -&gt; java.lang.Number&quot; -&gt; &quot;java.lang.Character -&gt; java.lang.Number : org.springframework.core.convert.support.CharacterToNumberFactory@1ab51574&quot;</span><br><span class=\"line\">     7 = &#123;LinkedHashMap$Entry@6604&#125; &quot;java.lang.String -&gt; java.lang.Boolean&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Boolean : org.springframework.core.convert.support.StringToBooleanConverter@7ac24f53&quot;</span><br><span class=\"line\">     8 = &#123;LinkedHashMap$Entry@6605&#125; &quot;java.lang.Boolean -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Boolean -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@6703b79f&quot;</span><br><span class=\"line\">     9 = &#123;LinkedHashMap$Entry@6606&#125; &quot;java.lang.String -&gt; java.lang.Enum&quot; -&gt; &quot;java.lang.String -&gt; java.lang.Enum : org.springframework.core.convert.support.StringToEnumConverterFactory@898561a&quot;</span><br><span class=\"line\">     10 = &#123;LinkedHashMap$Entry@6607&#125; &quot;java.lang.Enum -&gt; java.lang.String&quot; -&gt; &quot;java.lang.Enum -&gt; java.lang.String : org.springframework.core.convert.support.EnumToStringConverter@3a34ecc8&quot;</span><br><span class=\"line\">     11 = &#123;LinkedHashMap$Entry@6608&#125; &quot;java.lang.Integer -&gt; java.lang.Enum&quot; -&gt; &quot;java.lang.Integer -&gt; java.lang.Enum : org.springframework.core.convert.support.IntegerToEnumConverterFactory@52e4840a&quot;</span><br><span class=\"line\">     12 = &#123;LinkedHashMap$Entry@6609&#125; &quot;java.lang.Enum -&gt; java.lang.Integer&quot; -&gt; &quot;java.lang.Enum -&gt; java.lang.Integer : org.springframework.core.convert.support.EnumToIntegerConverter@28217e86&quot;</span><br><span class=\"line\">     13 = &#123;LinkedHashMap$Entry@6610&#125; &quot;java.lang.String -&gt; java.util.Locale&quot; -&gt; &quot;java.lang.String -&gt; java.util.Locale : org.springframework.core.convert.support.StringToLocaleConverter@6243d51e&quot;</span><br><span class=\"line\">     14 = &#123;LinkedHashMap$Entry@6611&#125; &quot;java.util.Locale -&gt; java.lang.String&quot; -&gt; &quot;java.util.Locale -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@7f8c2732&quot;</span><br><span class=\"line\">     15 = &#123;LinkedHashMap$Entry@6612&#125; &quot;java.lang.String -&gt; java.nio.charset.Charset&quot; -&gt; &quot;java.lang.String -&gt; java.nio.charset.Charset : org.springframework.core.convert.support.StringToCharsetConverter@93e281d&quot;</span><br><span class=\"line\">     16 = &#123;LinkedHashMap$Entry@6613&#125; &quot;java.nio.charset.Charset -&gt; java.lang.String&quot; -&gt; &quot;java.nio.charset.Charset -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@2ac8a2f2&quot;</span><br><span class=\"line\">     17 = &#123;LinkedHashMap$Entry@6614&#125; &quot;java.lang.String -&gt; java.util.Currency&quot; -&gt; &quot;java.lang.String -&gt; java.util.Currency : org.springframework.core.convert.support.StringToCurrencyConverter@565f7990&quot;</span><br><span class=\"line\">     18 = &#123;LinkedHashMap$Entry@6615&#125; &quot;java.util.Currency -&gt; java.lang.String&quot; -&gt; &quot;java.util.Currency -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@487461de&quot;</span><br><span class=\"line\">     19 = &#123;LinkedHashMap$Entry@6616&#125; &quot;java.lang.String -&gt; java.util.Properties&quot; -&gt; &quot;java.lang.String -&gt; java.util.Properties : org.springframework.core.convert.support.StringToPropertiesConverter@3072d60d&quot;</span><br><span class=\"line\">     20 = &#123;LinkedHashMap$Entry@6617&#125; &quot;java.util.Properties -&gt; java.lang.String&quot; -&gt; &quot;java.util.Properties -&gt; java.lang.String : org.springframework.core.convert.support.PropertiesToStringConverter@5f423dc3&quot;</span><br><span class=\"line\">     21 = &#123;LinkedHashMap$Entry@6618&#125; &quot;java.lang.String -&gt; java.util.UUID&quot; -&gt; &quot;java.lang.String -&gt; java.util.UUID : org.springframework.core.convert.support.StringToUUIDConverter@72fc4c42&quot;</span><br><span class=\"line\">     22 = &#123;LinkedHashMap$Entry@6619&#125; &quot;java.util.UUID -&gt; java.lang.String&quot; -&gt; &quot;java.util.UUID -&gt; java.lang.String : org.springframework.core.convert.support.ObjectToStringConverter@196db952&quot;</span><br><span class=\"line\">     23 = &#123;LinkedHashMap$Entry@6620&#125; &quot;[Ljava.lang.Object; -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToCollectionConverter@3f09c6cc&quot;</span><br><span class=\"line\">     24 = &#123;LinkedHashMap$Entry@6621&#125; &quot;java.util.Collection -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToArrayConverter@716b58cb&quot;</span><br><span class=\"line\">     25 = &#123;LinkedHashMap$Entry@6622&#125; &quot;[Ljava.lang.Object; -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToArrayConverter@61e594f8&quot;</span><br><span class=\"line\">     26 = &#123;LinkedHashMap$Entry@6623&#125; &quot;java.util.Collection -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToCollectionConverter@153616bf&quot;</span><br><span class=\"line\">     27 = &#123;LinkedHashMap$Entry@6624&#125; &quot;java.util.Map -&gt; java.util.Map&quot; -&gt; &quot;org.springframework.core.convert.support.MapToMapConverter@64f88d73&quot;</span><br><span class=\"line\">     28 = &#123;LinkedHashMap$Entry@6625&#125; &quot;[Ljava.lang.Object; -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToStringConverter@4f7e3c27&quot;</span><br><span class=\"line\">     29 = &#123;LinkedHashMap$Entry@6626&#125; &quot;java.lang.String -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.StringToArrayConverter@2713364&quot;</span><br><span class=\"line\">     30 = &#123;LinkedHashMap$Entry@6627&#125; &quot;[Ljava.lang.Object; -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.ArrayToObjectConverter@27574e7b&quot;</span><br><span class=\"line\">     31 = &#123;LinkedHashMap$Entry@6628&#125; &quot;java.lang.Object -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToArrayConverter@7e4ccf7&quot;</span><br><span class=\"line\">     32 = &#123;LinkedHashMap$Entry@6629&#125; &quot;java.util.Collection -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToStringConverter@39455728&quot;</span><br><span class=\"line\">     33 = &#123;LinkedHashMap$Entry@6630&#125; &quot;java.lang.String -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.StringToCollectionConverter@32a4a977&quot;</span><br><span class=\"line\">     34 = &#123;LinkedHashMap$Entry@6631&#125; &quot;java.util.Collection -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.CollectionToObjectConverter@2f1d1dce&quot;</span><br><span class=\"line\">     35 = &#123;LinkedHashMap$Entry@6632&#125; &quot;java.lang.Object -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToCollectionConverter@ebfffae&quot;</span><br><span class=\"line\">     36 = &#123;LinkedHashMap$Entry@6633&#125; &quot;[Ljava.lang.Object; -&gt; java.util.stream.Stream&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     37 = &#123;LinkedHashMap$Entry@6634&#125; &quot;java.util.Collection -&gt; java.util.stream.Stream&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     38 = &#123;LinkedHashMap$Entry@6635&#125; &quot;java.util.stream.Stream -&gt; java.util.Collection&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     39 = &#123;LinkedHashMap$Entry@6636&#125; &quot;java.util.stream.Stream -&gt; [Ljava.lang.Object;&quot; -&gt; &quot;org.springframework.core.convert.support.StreamConverter@1d500546&quot;</span><br><span class=\"line\">     40 = &#123;LinkedHashMap$Entry@6637&#125; &quot;java.nio.ByteBuffer -&gt; [B&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     41 = &#123;LinkedHashMap$Entry@6638&#125; &quot;java.nio.ByteBuffer -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     42 = &#123;LinkedHashMap$Entry@6639&#125; &quot;java.lang.Object -&gt; java.nio.ByteBuffer&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     43 = &#123;LinkedHashMap$Entry@6640&#125; &quot;[B -&gt; java.nio.ByteBuffer&quot; -&gt; &quot;org.springframework.core.convert.support.ByteBufferConverter@aa8e88a&quot;</span><br><span class=\"line\">     44 = &#123;LinkedHashMap$Entry@6641&#125; &quot;java.lang.String -&gt; java.util.TimeZone&quot; -&gt; &quot;java.lang.String -&gt; java.util.TimeZone : org.springframework.core.convert.support.StringToTimeZoneConverter@4d1c677c&quot;</span><br><span class=\"line\">     45 = &#123;LinkedHashMap$Entry@6642&#125; &quot;java.time.ZoneId -&gt; java.util.TimeZone&quot; -&gt; &quot;java.time.ZoneId -&gt; java.util.TimeZone : org.springframework.core.convert.support.ZoneIdToTimeZoneConverter@3c2fb3fe&quot;</span><br><span class=\"line\">     46 = &#123;LinkedHashMap$Entry@6643&#125; &quot;java.time.ZonedDateTime -&gt; java.util.Calendar&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.util.Calendar : org.springframework.core.convert.support.ZonedDateTimeToCalendarConverter@2148eb08&quot;</span><br><span class=\"line\">     47 = &#123;LinkedHashMap$Entry@6644&#125; &quot;java.lang.Object -&gt; java.lang.Object&quot; -&gt; &quot;org.springframework.core.convert.support.IdToEntityConverter@6c69ab13,org.springframework.core.convert.support.ObjectToObjectConverter@42600665&quot;</span><br><span class=\"line\">     48 = &#123;LinkedHashMap$Entry@6645&#125; &quot;java.lang.Object -&gt; java.lang.String&quot; -&gt; &quot;org.springframework.core.convert.support.FallbackObjectToStringConverter@311fd94&quot;</span><br><span class=\"line\">     49 = &#123;LinkedHashMap$Entry@6646&#125; &quot;java.lang.Object -&gt; java.util.Optional&quot; -&gt; &quot;org.springframework.core.convert.support.ObjectToOptionalConverter@65e75655&quot;</span><br><span class=\"line\">     50 = &#123;LinkedHashMap$Entry@6647&#125; &quot;java.lang.Integer -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Integer -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     51 = &#123;LinkedHashMap$Entry@6648&#125; &quot;java.lang.String -&gt; java.lang.Integer&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Integer: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     52 = &#123;LinkedHashMap$Entry@6649&#125; &quot;java.lang.Float -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Float -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     53 = &#123;LinkedHashMap$Entry@6650&#125; &quot;java.lang.String -&gt; java.lang.Float&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Float: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     54 = &#123;LinkedHashMap$Entry@6651&#125; &quot;java.math.BigInteger -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.math.BigInteger -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     55 = &#123;LinkedHashMap$Entry@6652&#125; &quot;java.lang.String -&gt; java.math.BigInteger&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.math.BigInteger: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     56 = &#123;LinkedHashMap$Entry@6653&#125; &quot;java.lang.Byte -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Byte -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     57 = &#123;LinkedHashMap$Entry@6654&#125; &quot;java.lang.String -&gt; java.lang.Byte&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Byte: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     58 = &#123;LinkedHashMap$Entry@6655&#125; &quot;java.lang.Double -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Double -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     59 = &#123;LinkedHashMap$Entry@6656&#125; &quot;java.lang.String -&gt; java.lang.Double&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Double: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     60 = &#123;LinkedHashMap$Entry@6657&#125; &quot;java.lang.Short -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.lang.Short -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     61 = &#123;LinkedHashMap$Entry@6658&#125; &quot;java.lang.String -&gt; java.lang.Short&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Short: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     62 = &#123;LinkedHashMap$Entry@6659&#125; &quot;java.lang.Long -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,@org.springframework.format.annotation.NumberFormat java.lang.Long -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     63 = &#123;LinkedHashMap$Entry@6660&#125; &quot;java.lang.String -&gt; java.lang.Long&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.lang.Long: org.springframework.format.datetime.DateTimeFormatAnnotationFormatterFactory@6e62d1c,java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.lang.Long: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     64 = &#123;LinkedHashMap$Entry@6661&#125; &quot;java.math.BigDecimal -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.NumberFormat java.math.BigDecimal -&gt; java.lang.String: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     65 = &#123;LinkedHashMap$Entry@6662&#125; &quot;java.lang.String -&gt; java.math.BigDecimal&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.NumberFormat java.math.BigDecimal: org.springframework.format.number.NumberFormatAnnotationFormatterFactory@44f758c9&quot;</span><br><span class=\"line\">     66 = &#123;LinkedHashMap$Entry@6663&#125; &quot;java.util.Date -&gt; java.lang.Long&quot; -&gt; &quot;java.util.Date -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@a178d09,java.util.Date -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$DateToLongConverter@551d27e0&quot;</span><br><span class=\"line\">     67 = &#123;LinkedHashMap$Entry@6664&#125; &quot;java.util.Date -&gt; java.util.Calendar&quot; -&gt; &quot;java.util.Date -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@2bd20c9a,java.util.Date -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$DateToCalendarConverter@1c6b5a31&quot;</span><br><span class=\"line\">     68 = &#123;LinkedHashMap$Entry@6665&#125; &quot;java.util.Calendar -&gt; java.util.Date&quot; -&gt; &quot;java.util.Calendar -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@2aa2f370,java.util.Calendar -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToDateConverter@163cf3e3&quot;</span><br><span class=\"line\">     69 = &#123;LinkedHashMap$Entry@6666&#125; &quot;java.util.Calendar -&gt; java.lang.Long&quot; -&gt; &quot;java.util.Calendar -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@2db18b62,java.util.Calendar -&gt; java.lang.Long : org.springframework.format.datetime.DateFormatterRegistrar$CalendarToLongConverter@6bcdf637&quot;</span><br><span class=\"line\">     70 = &#123;LinkedHashMap$Entry@6667&#125; &quot;java.lang.Long -&gt; java.util.Date&quot; -&gt; &quot;java.lang.Long -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@56c9b14d,java.lang.Long -&gt; java.util.Date : org.springframework.format.datetime.DateFormatterRegistrar$LongToDateConverter@271bf39c&quot;</span><br><span class=\"line\">     71 = &#123;LinkedHashMap$Entry@6668&#125; &quot;java.lang.Long -&gt; java.util.Calendar&quot; -&gt; &quot;java.lang.Long -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@6d08686,java.lang.Long -&gt; java.util.Calendar : org.springframework.format.datetime.DateFormatterRegistrar$LongToCalendarConverter@2a8b425&quot;</span><br><span class=\"line\">     72 = &#123;LinkedHashMap$Entry@6669&#125; &quot;java.time.LocalDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.LocalDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalDateConverter@19f02ee4&quot;</span><br><span class=\"line\">     73 = &#123;LinkedHashMap$Entry@6670&#125; &quot;java.time.LocalDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.LocalDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$LocalDateTimeToLocalTimeConverter@618fb955&quot;</span><br><span class=\"line\">     74 = &#123;LinkedHashMap$Entry@6671&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateConverter@63e9f754&quot;</span><br><span class=\"line\">     75 = &#123;LinkedHashMap$Entry@6672&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalTimeConverter@24a76e90&quot;</span><br><span class=\"line\">     76 = &#123;LinkedHashMap$Entry@6673&#125; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToLocalDateTimeConverter@3cb8e3ee&quot;</span><br><span class=\"line\">     77 = &#123;LinkedHashMap$Entry@6674&#125; &quot;java.time.ZonedDateTime -&gt; java.time.OffsetDateTime&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToOffsetDateTimeConverter@2061a03d&quot;</span><br><span class=\"line\">     78 = &#123;LinkedHashMap$Entry@6675&#125; &quot;java.time.ZonedDateTime -&gt; java.time.Instant&quot; -&gt; &quot;java.time.ZonedDateTime -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$ZonedDateTimeToInstantConverter@c1ea032&quot;</span><br><span class=\"line\">     79 = &#123;LinkedHashMap$Entry@6676&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDate&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateConverter@13d29ccf&quot;</span><br><span class=\"line\">     80 = &#123;LinkedHashMap$Entry@6677&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalTimeConverter@680eaac8&quot;</span><br><span class=\"line\">     81 = &#123;LinkedHashMap$Entry@6678&#125; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToLocalDateTimeConverter@45438fbc&quot;</span><br><span class=\"line\">     82 = &#123;LinkedHashMap$Entry@6679&#125; &quot;java.time.OffsetDateTime -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToZonedDateTimeConverter@3ca5a816&quot;</span><br><span class=\"line\">     83 = &#123;LinkedHashMap$Entry@6680&#125; &quot;java.time.OffsetDateTime -&gt; java.time.Instant&quot; -&gt; &quot;java.time.OffsetDateTime -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$OffsetDateTimeToInstantConverter@3b166fa9&quot;</span><br><span class=\"line\">     84 = &#123;LinkedHashMap$Entry@6681&#125; &quot;java.util.Calendar -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.ZonedDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToZonedDateTimeConverter@2653dae9&quot;</span><br><span class=\"line\">     85 = &#123;LinkedHashMap$Entry@6682&#125; &quot;java.util.Calendar -&gt; java.time.OffsetDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.OffsetDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToOffsetDateTimeConverter@7f348ff0&quot;</span><br><span class=\"line\">     86 = &#123;LinkedHashMap$Entry@6683&#125; &quot;java.util.Calendar -&gt; java.time.LocalDate&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalDate : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateConverter@6e407d18&quot;</span><br><span class=\"line\">     87 = &#123;LinkedHashMap$Entry@6684&#125; &quot;java.util.Calendar -&gt; java.time.LocalTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalTimeConverter@66a32c5e&quot;</span><br><span class=\"line\">     88 = &#123;LinkedHashMap$Entry@6685&#125; &quot;java.util.Calendar -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.LocalDateTime : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToLocalDateTimeConverter@5e9f36f1&quot;</span><br><span class=\"line\">     89 = &#123;LinkedHashMap$Entry@6686&#125; &quot;java.util.Calendar -&gt; java.time.Instant&quot; -&gt; &quot;java.util.Calendar -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$CalendarToInstantConverter@50f69dd&quot;</span><br><span class=\"line\">     90 = &#123;LinkedHashMap$Entry@6687&#125; &quot;java.lang.Long -&gt; java.time.Instant&quot; -&gt; &quot;java.lang.Long -&gt; java.time.Instant : org.springframework.format.datetime.standard.DateTimeConverters$LongToInstantConverter@684a7cd9&quot;</span><br><span class=\"line\">     91 = &#123;LinkedHashMap$Entry@6688&#125; &quot;java.time.Instant -&gt; java.lang.Long&quot; -&gt; &quot;java.time.Instant -&gt; java.lang.Long : org.springframework.format.datetime.standard.DateTimeConverters$InstantToLongConverter@17f47c52&quot;</span><br><span class=\"line\">     92 = &#123;LinkedHashMap$Entry@6689&#125; &quot;java.time.LocalDate -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalDate -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDate -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@4ec42ea0&quot;</span><br><span class=\"line\">     93 = &#123;LinkedHashMap$Entry@6690&#125; &quot;java.lang.String -&gt; java.time.LocalDate&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalDate: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalDate: org.springframework.format.datetime.standard.TemporalAccessorParser@75d32f15&quot;</span><br><span class=\"line\">     94 = &#123;LinkedHashMap$Entry@6691&#125; &quot;java.time.LocalTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41f1db11&quot;</span><br><span class=\"line\">     95 = &#123;LinkedHashMap$Entry@6692&#125; &quot;java.lang.String -&gt; java.time.LocalTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2ea20f2c&quot;</span><br><span class=\"line\">     96 = &#123;LinkedHashMap$Entry@6693&#125; &quot;java.time.LocalDateTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.LocalDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@41fc9576&quot;</span><br><span class=\"line\">     97 = &#123;LinkedHashMap$Entry@6694&#125; &quot;java.lang.String -&gt; java.time.LocalDateTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.LocalDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@2dbba1db&quot;</span><br><span class=\"line\">     98 = &#123;LinkedHashMap$Entry@6695&#125; &quot;java.time.ZonedDateTime -&gt; java.lang.String&quot; -&gt; &quot;@org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime -&gt; java.lang.String: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.time.ZonedDateTime -&gt; java.lang.String : org.springframework.format.datetime.standard.TemporalAccessorPrinter@625dde2e&quot;</span><br><span class=\"line\">     99 = &#123;LinkedHashMap$Entry@6696&#125; &quot;java.lang.String -&gt; java.time.ZonedDateTime&quot; -&gt; &quot;java.lang.String -&gt; @org.springframework.format.annotation.DateTimeFormat java.time.ZonedDateTime: org.springframework.format.datetime.standard.Jsr310DateTimeFormatAnnotationFormatterFactory@30fbf8e3,java.lang.String -&gt; java.time.ZonedDateTime: org.springframework.format.datetime.standard.TemporalAccessorParser@5cb87626&quot;</span><br><span class=\"line\">   converterCache = &#123;ConcurrentReferenceHashMap@6591&#125;  size = 1</span><br><span class=\"line\">    0 = &#123;ConcurrentReferenceHashMap$Entry@7099&#125; &quot;ConverterCacheKey [sourceType = java.lang.String, targetType = @org.springframework.web.bind.annotation.RequestParam java.lang.String]&quot; -&gt; &quot;NO_OP&quot;</span><br><span class=\"line\">  propertyEditorRegistrars = null</span><br></pre></td></tr></table></figure>\n<h3 id=\"parameterNameDiscoverer\"><a href=\"#parameterNameDiscoverer\" class=\"headerlink\" title=\"parameterNameDiscoverer\"></a>parameterNameDiscoverer</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.parameterNameDiscoverer = &#123;DefaultParameterNameDiscoverer@4866&#125; </span><br><span class=\"line\"> parameterNameDiscoverers = &#123;LinkedList@7309&#125;  size = 2</span><br><span class=\"line\">  0 = &#123;StandardReflectionParameterNameDiscoverer@7311&#125; </span><br><span class=\"line\">  1 = &#123;LocalVariableTableParameterNameDiscoverer@7312&#125;</span><br></pre></td></tr></table></figure>\n<p>容器的启动过程以及一次请求的详细处理过程: <a href=\"springmvc.log\">启动日志</a></p>\n"},{"title":"Spring Mvc源码剖析(一)","toc":true,"abbrlink":"96837423","date":"2016-10-02T14:14:25.000Z","_content":"\n## 架构\n{%  asset_img   arch.jpg  %}\n\n\n\n\nSpringMVC的核心是 `DispatcherServlet`\n\n## 本质\n\n我们通过在`web.xml`中配置如下的语句，引入SpringMVC\n\n``` xml\n<servlet>\n    <servlet-name>mvc-dispatcher</servlet-name>\n    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>\n    <init-param>\n        <param-name>contextConfigLocation</param-name>\n        <param-value>classpath:/spring/mvc/mvc-dispatcher-servlet.xml</param-value>\n    </init-param>\n    <load-on-startup>1</load-on-startup>\n</servlet>\n```\n\n上述代码段指定了servlet的class是spring的`DispatcherServlet`，初始化配置文件是`mvc-dispatcher-servlet.xml`,以及servlet的加载顺序。\n\n既然`DispatcherServlet`也是一个`Servlet`，那他肯定也遵从servlet的规范。\n我们知道Servlet定义了如下的接口：\n{%  asset_img   servlet-interface.jpg  %}\n\n\n\n其中比较重要的是`init`和`service`接口\n`init`方法在servlet的一生中只初始化一次，`service`接口是Servlet对外提供服务的接口\nServlet的生命周期如下:\n{%  asset_img   Servlet_LifeCycle.jpg  %}\n\n\n\n\n我们来看下`DispatcherServlet`的继承结构：\n\n{%  asset_img   hierachy.jpg  %}\n\n\n\n\n### init方法\n\n直接去看`DispatcherServlet`的源码是没有发现`init`方法的， 它的`init`方法继承自`HttpServletBean`，源码如下：\n```java\n    /**\n\t\t * Map config parameters onto bean properties of this servlet, and\n\t\t * invoke subclass initialization.\n\t\t * @throws ServletException if bean properties are invalid (or required\n\t\t * properties are missing), or if subclass initialization fails.\n\t\t */\n\t\t@Override\n\t\tpublic final void init() throws ServletException {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Initializing servlet '\" + getServletName() + \"'\");\n\t\t\t}\n\n\t\t\t// Set bean properties from init parameters.\n\t\t\ttry {\n\t\t\t\tPropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);\n\t\t\t\tBeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);\n\t\t\t\tResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());\n\t\t\t\tbw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));\n\t\t\t\tinitBeanWrapper(bw);\n\t\t\t\tbw.setPropertyValues(pvs, true);\n\t\t\t}\n\t\t\tcatch (BeansException ex) {\n\t\t\t\tlogger.error(\"Failed to set bean properties on servlet '\" + getServletName() + \"'\", ex);\n\t\t\t\tthrow ex;\n\t\t\t}\n\n\t\t\t// Let subclasses do whatever initialization they like.\n\t\t\tinitServletBean();\n\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Servlet '\" + getServletName() + \"' configured successfully\");\n\t\t\t}\n\t\t}\n```\n\n在这个方法中，主要完成了bean属性的配置，并且给子类留下了相应的hook\n\n``` java\n// Let subclasses do whatever initialization they like.\ninitServletBean();\n```\n\n这个方法在FrameworkServlet中有具体的实现，现在看下FrameworkServlet中的实现。\n\n``` java\n/**\n\t * Overridden method of {@link HttpServletBean}, invoked after any bean properties\n\t * have been set. Creates this servlet's WebApplicationContext.\n\t */\n\t@Override\n\tprotected final void initServletBean() throws ServletException {\n\t\tgetServletContext().log(\"Initializing Spring FrameworkServlet '\" + getServletName() + \"'\");\n\t\tif (this.logger.isInfoEnabled()) {\n\t\t\tthis.logger.info(\"FrameworkServlet '\" + getServletName() + \"': initialization started\");\n\t\t}\n\t\tlong startTime = System.currentTimeMillis();\n\n\t\ttry {\n\t\t\tthis.webApplicationContext = initWebApplicationContext();\n\t\t\tinitFrameworkServlet();\n\t\t}\n\t\tcatch (ServletException ex) {\n\t\t\tthis.logger.error(\"Context initialization failed\", ex);\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (RuntimeException ex) {\n\t\t\tthis.logger.error(\"Context initialization failed\", ex);\n\t\t\tthrow ex;\n\t\t}\n\n\t\tif (this.logger.isInfoEnabled()) {\n\t\t\tlong elapsedTime = System.currentTimeMillis() - startTime;\n\t\t\tthis.logger.info(\"FrameworkServlet '\" + getServletName() + \"': initialization completed in \" +\n\t\t\t\t\telapsedTime + \" ms\");\n\t\t}\n\t}\n```\n`webApplicationContext`在此进行初始化，并且给子类留下了一个hook\n``` java\nthis.webApplicationContext = initWebApplicationContext();\ninitFrameworkServlet();\n```\n`initFrameworkServlet`在本类中并没有实现，用于子类控制\n\n```java\n/**\n* This method will be invoked after any bean properties have been set and\n* the WebApplicationContext has been loaded. The default implementation is empty;\n* subclasses may override this method to perform any initialization they require.\n* @throws ServletException in case of an initialization exception\n*/\nprotected void initFrameworkServlet() throws ServletException {\n}\n```\n\n在initWebApplicationContext方法中，有一个空实现的方法onRefresh()\n```java\n/**\n* Template method which can be overridden to add servlet-specific refresh work.\n* Called after successful context refresh.\n* <p>This implementation is empty.\n* @param context the current WebApplicationContext\n* @see #refresh()\n*/\nprotected void onRefresh(ApplicationContext context) {\n// For subclasses: do nothing by default.\n}\n```\n\n这个方法也是钩子方法，DispatcherServlet正是实现了这个方法。\n\n```java\n\n/**\n\t* This implementation calls {@link #initStrategies}.\n\t*/\n\t@Override\n\tprotected void onRefresh(ApplicationContext context) {\n\t\tinitStrategies(context);\n\t}\n\n\n\t/**\n\t\t * Initialize the strategy objects that this servlet uses.\n\t\t * <p>May be overridden in subclasses in order to initialize further strategy objects.\n\t\t */\n\t\tprotected void initStrategies(ApplicationContext context) {\n\t\t\tinitMultipartResolver(context);\n\t\t\tinitLocaleResolver(context);\n\t\t\tinitThemeResolver(context);\n\t\t\tinitHandlerMappings(context);\n\t\t\tinitHandlerAdapters(context);\n\t\t\tinitHandlerExceptionResolvers(context);\n\t\t\tinitRequestToViewNameTranslator(context);\n\t\t\tinitViewResolvers(context);\n\t\t\tinitFlashMapManager(context);\n\t\t}\n```\n\nonRefresh方法中又调用了initStrategies方法，在这个方法中进行了大量的初始化工作。\n\n视图解析器和HandlerMappings都是在这个方法中初始化的。\n\n重点看一下initHandlerMappings方法，这个方法是初始化url映射的\n\n```java\n/**\n\t * Initialize the HandlerMappings used by this class.\n\t * <p>If no HandlerMapping beans are defined in the BeanFactory for this namespace,\n\t * we default to BeanNameUrlHandlerMapping.\n\t */\n\tprivate void initHandlerMappings(ApplicationContext context) {\n\t\tthis.handlerMappings = null;\n\n\t\tif (this.detectAllHandlerMappings) {\n\t\t\t// Find all HandlerMappings in the ApplicationContext, including ancestor contexts.\n\t\t\tMap<String, HandlerMapping> matchingBeans =\n\t\t\t\t\tBeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, true, false);\n\t\t\tif (!matchingBeans.isEmpty()) {\n\t\t\t\tthis.handlerMappings = new ArrayList<HandlerMapping>(matchingBeans.values());\n\t\t\t\t// We keep HandlerMappings in sorted order.\n\t\t\t\tAnnotationAwareOrderComparator.sort(this.handlerMappings);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\ttry {\n\t\t\t\tHandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping.class);\n\t\t\t\tthis.handlerMappings = Collections.singletonList(hm);\n\t\t\t}\n\t\t\tcatch (NoSuchBeanDefinitionException ex) {\n\t\t\t\t// Ignore, we'll add a default HandlerMapping later.\n\t\t\t}\n\t\t}\n\n\t\t// Ensure we have at least one HandlerMapping, by registering\n\t\t// a default HandlerMapping if no other mappings are found.\n\t\tif (this.handlerMappings == null) {\n\t\t\tthis.handlerMappings = getDefaultStrategies(context, HandlerMapping.class);\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"No HandlerMappings found in servlet '\" + getServletName() + \"': using default\");\n\t\t\t}\n\t\t}\n\t}\n  ```\n  其根据 this.detectAllHandlerMappings 的值来确定是否扫描祖先定义的handlermappings，如果用户没有配置的话，就会使用默认的HandlerMapping\n```java\n/** Detect all HandlerMappings or just expect \"handlerMapping\" bean? */\nprivate boolean detectAllHandlerMappings = true;\n```\n\n### service方法\n\nservlet接口中另外一个重要的方法叫做`service`\n\n`service`方法最早是在`HttpServlet`类中实现的，代码如下：\n```java\n/**\n     * Dispatches client requests to the protected\n     * <code>service</code> method. There's no need to\n     * override this method.\n     *\n     * @param req   the {@link HttpServletRequest} object that\n     *                  contains the request the client made of\n     *                  the servlet\n     *\n     * @param res   the {@link HttpServletResponse} object that\n     *                  contains the response the servlet returns\n     *                  to the client                                \n     *\n     * @exception IOException   if an input or output error occurs\n     *                              while the servlet is handling the\n     *                              HTTP request\n     *\n     * @exception ServletException  if the HTTP request cannot\n     *                                  be handled\n     *\n     * @see javax.servlet.Servlet#service\n     */\n    public void service(ServletRequest req, ServletResponse res)\n        throws ServletException, IOException\n    {\n        HttpServletRequest  request;\n        HttpServletResponse response;\n\n        if (!(req instanceof HttpServletRequest &&\n                res instanceof HttpServletResponse)) {\n            throw new ServletException(\"non-HTTP request or response\");\n        }\n\n        request = (HttpServletRequest) req;\n        response = (HttpServletResponse) res;\n\n        service(request, response);\n    }\n}\n\n```\n它又调用自身的一个`service`方法:\n```java\n/**\n    * Receives standard HTTP requests from the public\n    * <code>service</code> method and dispatches\n    * them to the <code>do</code><i>XXX</i> methods defined in\n    * this class. This method is an HTTP-specific version of the\n    * {@link javax.servlet.Servlet#service} method. There's no\n    * need to override this method.\n    *\n    * @param req   the {@link HttpServletRequest} object that\n    *                  contains the request the client made of\n    *                  the servlet\n    *\n    * @param resp  the {@link HttpServletResponse} object that\n    *                  contains the response the servlet returns\n    *                  to the client                                \n    *\n    * @exception IOException   if an input or output error occurs\n    *                              while the servlet is handling the\n    *                              HTTP request\n    *\n    * @exception ServletException  if the HTTP request\n    *                                  cannot be handled\n    *\n    * @see javax.servlet.Servlet#service\n    */\n   protected void service(HttpServletRequest req, HttpServletResponse resp)\n       throws ServletException, IOException\n   {\n       String method = req.getMethod();\n\n       if (method.equals(METHOD_GET)) {\n           long lastModified = getLastModified(req);\n           if (lastModified == -1) {\n               // servlet doesn't support if-modified-since, no reason\n               // to go through further expensive logic\n               doGet(req, resp);\n           } else {\n               long ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);\n               if (ifModifiedSince < lastModified) {\n                   // If the servlet mod time is later, call doGet()\n                   // Round down to the nearest second for a proper compare\n                   // A ifModifiedSince of -1 will always be less\n                   maybeSetLastModified(resp, lastModified);\n                   doGet(req, resp);\n               } else {\n                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);\n               }\n           }\n\n       } else if (method.equals(METHOD_HEAD)) {\n           long lastModified = getLastModified(req);\n           maybeSetLastModified(resp, lastModified);\n           doHead(req, resp);\n\n       } else if (method.equals(METHOD_POST)) {\n           doPost(req, resp);\n\n       } else if (method.equals(METHOD_PUT)) {\n           doPut(req, resp);\n\n       } else if (method.equals(METHOD_DELETE)) {\n           doDelete(req, resp);\n\n       } else if (method.equals(METHOD_OPTIONS)) {\n           doOptions(req,resp);\n\n       } else if (method.equals(METHOD_TRACE)) {\n           doTrace(req,resp);\n\n       } else {\n           //\n           // Note that this means NO servlet supports whatever\n           // method was requested, anywhere on this server.\n           //\n\n           String errMsg = lStrings.getString(\"http.method_not_implemented\");\n           Object[] errArgs = new Object[1];\n           errArgs[0] = method;\n           errMsg = MessageFormat.format(errMsg, errArgs);\n\n           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);\n       }\n   }\n```\n\n这段代码就是根据请求的类型调用相应的处理方法\n\n这个方法又在`FrameWorkServlet`中被重写，如下：\n\n```java\n/**\n * Override the parent class implementation in order to intercept PATCH requests.\n */\n@Override\nprotected void service(HttpServletRequest request, HttpServletResponse response)\n    throws ServletException, IOException {\n\n  if (HttpMethod.PATCH.matches(request.getMethod())) {\n    processRequest(request, response);\n  }\n  else {\n    super.service(request, response);\n  }\n}\n```\n\n又增加了一个处理PATCH请求的方法，其他的还是调用`HttpServlet`的实现。\n\n同时，`FrameWorkServlet`又将`HttpServlet`中对应的各种HTTP请求的方法都进行了重写，如下：\n```java\n/**\n\t * Delegate GET requests to processRequest/doService.\n\t * <p>Will also be invoked by HttpServlet's default implementation of {@code doHead},\n\t * with a {@code NoBodyResponse} that just captures the content length.\n\t * @see #doService\n\t * @see #doHead\n\t */\n\t@Override\n\tprotected final void doGet(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException {\n\n\t\tprocessRequest(request, response);\n\t}\n```\n\n所有的请求都被委托给了`processRequest`这个方法，它的实现如下：\n\n```java\n/**\n\t * Process this request, publishing an event regardless of the outcome.\n\t * <p>The actual event handling is performed by the abstract\n\t * {@link #doService} template method.\n\t */\n\tprotected final void processRequest(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException {\n\n\t\tlong startTime = System.currentTimeMillis();\n\t\tThrowable failureCause = null;\n\n\t\tLocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();\n\t\tLocaleContext localeContext = buildLocaleContext(request);\n\n\t\tRequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();\n\t\tServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);\n\n\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\t\tasyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), new RequestBindingInterceptor());\n\n\t\tinitContextHolders(request, localeContext, requestAttributes);\n\n\t\ttry {\n\t\t\tdoService(request, response);\n\t\t}\n\t\tcatch (ServletException ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (IOException ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (Throwable ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow new NestedServletException(\"Request processing failed\", ex);\n\t\t}\n\n\t\tfinally {\n\t\t\tresetContextHolders(request, previousLocaleContext, previousAttributes);\n\t\t\tif (requestAttributes != null) {\n\t\t\t\trequestAttributes.requestCompleted();\n\t\t\t}\n\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tif (failureCause != null) {\n\t\t\t\t\tthis.logger.debug(\"Could not complete request\", failureCause);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t\t\tlogger.debug(\"Leaving response open for concurrent processing\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis.logger.debug(\"Successfully completed request\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tpublishRequestHandledEvent(request, response, startTime, failureCause);\n\t\t}\n\t}\n\n```\n\n上述代码的异常处理很值得借鉴，上述代码中`doService(request, response)`是核心。\n\n它是`FrameWorkServlet`中定义的一个接口，它在`DispatcherServlet`中被实现。\n```java\n/**\n * Subclasses must implement this method to do the work of request handling,\n * receiving a centralized callback for GET, POST, PUT and DELETE.\n * <p>The contract is essentially the same as that for the commonly overridden\n * {@code doGet} or {@code doPost} methods of HttpServlet.\n * <p>This class intercepts calls to ensure that exception handling and\n * event publication takes place.\n * @param request current HTTP request\n * @param response current HTTP response\n * @throws Exception in case of any kind of processing failure\n * @see javax.servlet.http.HttpServlet#doGet\n * @see javax.servlet.http.HttpServlet#doPost\n */\nprotected abstract void doService(HttpServletRequest request, HttpServletResponse response)\n    throws Exception;\n```\n\n`DispatcherServlet`中的`doService`接口代码如下：\n```java\n/**\n\t * Exposes the DispatcherServlet-specific request attributes and delegates to {@link #doDispatch}\n\t * for the actual dispatching.\n\t */\n\t@Override\n\tprotected void doService(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tif (logger.isDebugEnabled()) {\n\t\t\tString resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? \" resumed\" : \"\";\n\t\t\tlogger.debug(\"DispatcherServlet with name '\" + getServletName() + \"'\" + resumed +\n\t\t\t\t\t\" processing \" + request.getMethod() + \" request for [\" + getRequestUri(request) + \"]\");\n\t\t}\n\n\t\t// Keep a snapshot of the request attributes in case of an include,\n\t\t// to be able to restore the original attributes after the include.\n\t\tMap<String, Object> attributesSnapshot = null;\n\t\tif (WebUtils.isIncludeRequest(request)) {\n\t\t\tattributesSnapshot = new HashMap<String, Object>();\n\t\t\tEnumeration<?> attrNames = request.getAttributeNames();\n\t\t\twhile (attrNames.hasMoreElements()) {\n\t\t\t\tString attrName = (String) attrNames.nextElement();\n\t\t\t\tif (this.cleanupAfterInclude || attrName.startsWith(\"org.springframework.web.servlet\")) {\n\t\t\t\t\tattributesSnapshot.put(attrName, request.getAttribute(attrName));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Make framework objects available to handlers and view objects.\n\t\trequest.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());\n\t\trequest.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);\n\t\trequest.setAttribute(THEME_RESOLVER_ATTRIBUTE, this.themeResolver);\n\t\trequest.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());\n\n\t\tFlashMap inputFlashMap = this.flashMapManager.retrieveAndUpdate(request, response);\n\t\tif (inputFlashMap != null) {\n\t\t\trequest.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));\n\t\t}\n\t\trequest.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, new FlashMap());\n\t\trequest.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, this.flashMapManager);\n\n\t\ttry {\n\t\t\tdoDispatch(request, response);\n\t\t}\n\t\tfinally {\n\t\t\tif (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n\t\t\t\t// Restore the original attribute snapshot, in case of an include.\n\t\t\t\tif (attributesSnapshot != null) {\n\t\t\t\t\trestoreAttributesAfterInclude(request, attributesSnapshot);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n```\n\n每次请求过来都会将系统的一些属性塞到request的attribute中，以便后面的handlers和view能够访问到。\n\n其中比较重要的是 `doDispatch(request, response)`，正是这个方法使得请求被真正的转发。\n\n```java\n/**\n\t * Process the actual dispatching to the handler.\n\t * <p>The handler will be obtained by applying the servlet's HandlerMappings in order.\n\t * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters\n\t * to find the first that supports the handler class.\n\t * <p>All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers\n\t * themselves to decide which methods are acceptable.\n\t * @param request current HTTP request\n\t * @param response current HTTP response\n\t * @throws Exception in case of any kind of processing failure\n\t */\n\tprotected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tHttpServletRequest processedRequest = request;\n\t\tHandlerExecutionChain mappedHandler = null;\n\t\tboolean multipartRequestParsed = false;\n\n\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n\t\ttry {\n\t\t\tModelAndView mv = null;\n\t\t\tException dispatchException = null;\n\n\t\t\ttry {\n\t\t\t\tprocessedRequest = checkMultipart(request);\n\t\t\t\tmultipartRequestParsed = (processedRequest != request);\n\n\t\t\t\t// Determine handler for the current request.\n\t\t\t\tmappedHandler = getHandler(processedRequest);\n\t\t\t\tif (mappedHandler == null || mappedHandler.getHandler() == null) {\n\t\t\t\t\tnoHandlerFound(processedRequest, response);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Determine handler adapter for the current request.\n\t\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n\t\t\t\t// Process last-modified header, if supported by the handler.\n\t\t\t\tString method = request.getMethod();\n\t\t\t\tboolean isGet = \"GET\".equals(method);\n\t\t\t\tif (isGet || \"HEAD\".equals(method)) {\n\t\t\t\t\tlong lastModified = ha.getLastModified(request, mappedHandler.getHandler());\n\t\t\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\t\t\tlogger.debug(\"Last-Modified value for [\" + getRequestUri(request) + \"] is: \" + lastModified);\n\t\t\t\t\t}\n\t\t\t\t\tif (new ServletWebRequest(request, response).checkNotModified(lastModified) && isGet) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!mappedHandler.applyPreHandle(processedRequest, response)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Actually invoke the handler.\n\t\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n\t\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tapplyDefaultViewName(processedRequest, mv);\n\t\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tdispatchException = ex;\n\t\t\t}\n\t\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n\t\t}\n\t\tcatch (Error err) {\n\t\t\ttriggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);\n\t\t}\n\t\tfinally {\n\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t// Instead of postHandle and afterCompletion\n\t\t\t\tif (mappedHandler != null) {\n\t\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Clean up any resources used by a multipart request.\n\t\t\t\tif (multipartRequestParsed) {\n\t\t\t\t\tcleanupMultipart(processedRequest);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n```\n\nhandler 获取的顺序是从DispatcherServlet的HandlerMapping中按顺序取出的\n\nHandler对应的HandlerAdapter会从安装的HandlerAdapter找，将返回第一个合适的Adapter\n\n```java\n  HandlerExecutionChain mappedHandler = null;\n\n  // Determine handler for the current request.\n  mappedHandler = getHandler(processedRequest);\n              ...\n  // Determine handler adapter for the current request.\n  HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n              ...\n\n  if (!mappedHandler.applyPreHandle(processedRequest, response)) {\n          return;\n  }\n  // Actually invoke the handler.\n  mv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n  mappedHandler.applyPostHandle(processedRequest, response, mv);\n\n  processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n```\n在applyPreHandle中也是检查拦截器的操作，并根据拦截器返回的布尔类型，判断是否进一步处理\n\n其中在applyPostHandle中又检查是否有各种拦截器,调用拦截器的postHandle方法\n\n处理完毕后，调用processDispatchResult方法将处理后的请求和mv进行分发\n\n```java\n//HandlerExecutionChain.java\n\n\t\t/**\n\t * Apply preHandle methods of registered interceptors.\n\t * @return {@code true} if the execution chain should proceed with the\n\t * next interceptor or the handler itself. Else, DispatcherServlet assumes\n\t * that this interceptor has already dealt with the response itself.\n\t */\n\tboolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tHandlerInterceptor[] interceptors = getInterceptors();\n\t\tif (!ObjectUtils.isEmpty(interceptors)) {\n\t\t\tfor (int i = 0; i < interceptors.length; i++) {\n\t\t\t\tHandlerInterceptor interceptor = interceptors[i];\n\t\t\t\tif (!interceptor.preHandle(request, response, this.handler)) {\n\t\t\t\t\ttriggerAfterCompletion(request, response, null);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tthis.interceptorIndex = i;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t* Apply postHandle methods of registered interceptors.\n\t*/\n\tvoid applyPostHandle(HttpServletRequest request, HttpServletResponse response, ModelAndView mv) throws Exception {\n\tHandlerInterceptor[] interceptors = getInterceptors();\n\tif (!ObjectUtils.isEmpty(interceptors)) {\n\t\tfor (int i = interceptors.length - 1; i >= 0; i--) {\n\t\t\tHandlerInterceptor interceptor = interceptors[i];\n\t\t\tinterceptor.postHandle(request, response, this.handler, mv);\n\t\t}\n\t}\n```\n\nhandler处理后的结果是通过processDispatchResult传出去的\n\n```java\n//DispatcherServlet.java\n\n\t/**\n\t * Handle the result of handler selection and handler invocation, which is\n\t * either a ModelAndView or an Exception to be resolved to a ModelAndView.\n\t */\n\tprivate void processDispatchResult(HttpServletRequest request, HttpServletResponse response,\n\t\t\tHandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception) throws Exception {\n\n\t\tboolean errorView = false;\n\n\t\tif (exception != null) {\n\t\t\tif (exception instanceof ModelAndViewDefiningException) {\n\t\t\t\tlogger.debug(\"ModelAndViewDefiningException encountered\", exception);\n\t\t\t\tmv = ((ModelAndViewDefiningException) exception).getModelAndView();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tObject handler = (mappedHandler != null ? mappedHandler.getHandler() : null);\n\t\t\t\tmv = processHandlerException(request, response, handler, exception);\n\t\t\t\terrorView = (mv != null);\n\t\t\t}\n\t\t}\n\n\t\t// Did the handler return a view to render?\n\t\tif (mv != null && !mv.wasCleared()) {\n\t\t\trender(mv, request, response);\n\t\t\tif (errorView) {\n\t\t\t\tWebUtils.clearErrorRequestAttributes(request);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Null ModelAndView returned to DispatcherServlet with name '\" + getServletName() +\n\t\t\t\t\t\t\"': assuming HandlerAdapter completed request handling\");\n\t\t\t}\n\t\t}\n\n\t\tif (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n\t\t\t// Concurrent handling started during a forward\n\t\t\treturn;\n\t\t}\n\n\t\tif (mappedHandler != null) {\n\t\t\tmappedHandler.triggerAfterCompletion(request, response, null);\n\t\t}\n\t}\n```\n\n去各种判断，核心的方法就在`render(mv, request, response)`;\n\n它负责渲染返回的`ModelAndView`\n\n```java\n//DispatcherServlet.java\n\n\t/**\n\t* Render the given ModelAndView.\n\t* <p>This is the last stage in handling a request. It may involve resolving the view by name.\n\t* @param mv the ModelAndView to render\n\t* @param request current HTTP servlet request\n\t* @param response current HTTP servlet response\n\t* @throws ServletException if view is missing or cannot be resolved\n\t* @throws Exception if there's a problem rendering the view\n\t*/\n\tprotected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\t// Determine locale for request and apply it to the response.\n\t\tLocale locale = this.localeResolver.resolveLocale(request);\n\t\tresponse.setLocale(locale);\n\n\t\tView view;\n\t\tif (mv.isReference()) {\n\t\t\t// We need to resolve the view name.\n\t\t\tview = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);\n\t\t\tif (view == null) {\n\t\t\t\tthrow new ServletException(\"Could not resolve view with name '\" + mv.getViewName() +\n\t\t\t\t\t\t\"' in servlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// No need to lookup: the ModelAndView object contains the actual View object.\n\t\t\tview = mv.getView();\n\t\t\tif (view == null) {\n\t\t\t\tthrow new ServletException(\"ModelAndView [\" + mv + \"] neither contains a view name nor a \" +\n\t\t\t\t\t\t\"View object in servlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t}\n\n\t\t// Delegate to the View object for rendering.\n\t\tif (logger.isDebugEnabled()) {\n\t\t\tlogger.debug(\"Rendering view [\" + view + \"] in DispatcherServlet with name '\" + getServletName() + \"'\");\n\t\t}\n\t\ttry {\n\t\t\tview.render(mv.getModelInternal(), request, response);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Error rendering view [\" + view + \"] in DispatcherServlet with name '\" +\n\t\t\t\t\t\tgetServletName() + \"'\", ex);\n\t\t\t}\n\t\t\tthrow ex;\n\t\t}\n\t}\n```\n\n这个函数解析mv对象，如果是一个引用名就查找对应的view，最终返回一个View对象，\n\n然后将渲染的工作委托给这个view对象，`view.render(mv.getModelInternal(), request, response);`\n\n其中`resolveViewName`方法遍历 `DispatcherServlet`中注册的`viewResolver`，返回第一个非空的结果\n\n查找视图名称的方法如下:\n```java\n\n/** List of ViewResolvers used by this servlet */\nprivate List<ViewResolver> viewResolvers;\n\n\n/**\n\t* Resolve the given view name into a View object (to be rendered).\n\t* <p>The default implementations asks all ViewResolvers of this dispatcher.\n\t* Can be overridden for custom resolution strategies, potentially based on\n\t* specific model attributes or request parameters.\n\t* @param viewName the name of the view to resolve\n\t* @param model the model to be passed to the view\n\t* @param locale the current locale\n\t* @param request current HTTP servlet request\n\t* @return the View object, or {@code null} if none found\n\t* @throws Exception if the view cannot be resolved\n\t* (typically in case of problems creating an actual View object)\n\t* @see ViewResolver#resolveViewName\n\t*/\n\tprotected View resolveViewName(String viewName, Map<String, Object> model, Locale locale,\n\t\tHttpServletRequest request) throws Exception {\n\n\t\t\tfor (ViewResolver viewResolver : this.viewResolvers) {\n\t\t\t\tView view = viewResolver.resolveViewName(viewName, locale);\n\t\t\t\tif (view != null) {\n\t\t\t\t\treturn view;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t}\n```\n\n最终视图的渲染是View中定义的`render`方法进行的，它是一个抽象的接口\n\n```java\n/**\n\t * Render the view given the specified model.\n\t * <p>The first step will be preparing the request: In the JSP case,\n\t * this would mean setting model objects as request attributes.\n\t * The second step will be the actual rendering of the view,\n\t * for example including the JSP via a RequestDispatcher.\n\t * @param model Map with name Strings as keys and corresponding model\n\t * objects as values (Map can also be {@code null} in case of empty model)\n\t * @param request current HTTP request\n\t * @param response HTTP response we are building\n\t * @throws Exception if rendering failed\n\t */\n\tvoid render(Map<String, ?> model, HttpServletRequest request, HttpServletResponse response) throws Exception;\n```\n","source":"_posts/spring-mvc.md","raw":"---\ntitle: Spring Mvc源码剖析(一)\ntags: spring mvc\ncategory: spring\ntoc: true\nabbrlink: '96837423'\ndate: 2016-10-02 22:14:25\n---\n\n## 架构\n{%  asset_img   arch.jpg  %}\n\n\n\n\nSpringMVC的核心是 `DispatcherServlet`\n\n## 本质\n\n我们通过在`web.xml`中配置如下的语句，引入SpringMVC\n\n``` xml\n<servlet>\n    <servlet-name>mvc-dispatcher</servlet-name>\n    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>\n    <init-param>\n        <param-name>contextConfigLocation</param-name>\n        <param-value>classpath:/spring/mvc/mvc-dispatcher-servlet.xml</param-value>\n    </init-param>\n    <load-on-startup>1</load-on-startup>\n</servlet>\n```\n\n上述代码段指定了servlet的class是spring的`DispatcherServlet`，初始化配置文件是`mvc-dispatcher-servlet.xml`,以及servlet的加载顺序。\n\n既然`DispatcherServlet`也是一个`Servlet`，那他肯定也遵从servlet的规范。\n我们知道Servlet定义了如下的接口：\n{%  asset_img   servlet-interface.jpg  %}\n\n\n\n其中比较重要的是`init`和`service`接口\n`init`方法在servlet的一生中只初始化一次，`service`接口是Servlet对外提供服务的接口\nServlet的生命周期如下:\n{%  asset_img   Servlet_LifeCycle.jpg  %}\n\n\n\n\n我们来看下`DispatcherServlet`的继承结构：\n\n{%  asset_img   hierachy.jpg  %}\n\n\n\n\n### init方法\n\n直接去看`DispatcherServlet`的源码是没有发现`init`方法的， 它的`init`方法继承自`HttpServletBean`，源码如下：\n```java\n    /**\n\t\t * Map config parameters onto bean properties of this servlet, and\n\t\t * invoke subclass initialization.\n\t\t * @throws ServletException if bean properties are invalid (or required\n\t\t * properties are missing), or if subclass initialization fails.\n\t\t */\n\t\t@Override\n\t\tpublic final void init() throws ServletException {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Initializing servlet '\" + getServletName() + \"'\");\n\t\t\t}\n\n\t\t\t// Set bean properties from init parameters.\n\t\t\ttry {\n\t\t\t\tPropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);\n\t\t\t\tBeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);\n\t\t\t\tResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());\n\t\t\t\tbw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));\n\t\t\t\tinitBeanWrapper(bw);\n\t\t\t\tbw.setPropertyValues(pvs, true);\n\t\t\t}\n\t\t\tcatch (BeansException ex) {\n\t\t\t\tlogger.error(\"Failed to set bean properties on servlet '\" + getServletName() + \"'\", ex);\n\t\t\t\tthrow ex;\n\t\t\t}\n\n\t\t\t// Let subclasses do whatever initialization they like.\n\t\t\tinitServletBean();\n\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Servlet '\" + getServletName() + \"' configured successfully\");\n\t\t\t}\n\t\t}\n```\n\n在这个方法中，主要完成了bean属性的配置，并且给子类留下了相应的hook\n\n``` java\n// Let subclasses do whatever initialization they like.\ninitServletBean();\n```\n\n这个方法在FrameworkServlet中有具体的实现，现在看下FrameworkServlet中的实现。\n\n``` java\n/**\n\t * Overridden method of {@link HttpServletBean}, invoked after any bean properties\n\t * have been set. Creates this servlet's WebApplicationContext.\n\t */\n\t@Override\n\tprotected final void initServletBean() throws ServletException {\n\t\tgetServletContext().log(\"Initializing Spring FrameworkServlet '\" + getServletName() + \"'\");\n\t\tif (this.logger.isInfoEnabled()) {\n\t\t\tthis.logger.info(\"FrameworkServlet '\" + getServletName() + \"': initialization started\");\n\t\t}\n\t\tlong startTime = System.currentTimeMillis();\n\n\t\ttry {\n\t\t\tthis.webApplicationContext = initWebApplicationContext();\n\t\t\tinitFrameworkServlet();\n\t\t}\n\t\tcatch (ServletException ex) {\n\t\t\tthis.logger.error(\"Context initialization failed\", ex);\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (RuntimeException ex) {\n\t\t\tthis.logger.error(\"Context initialization failed\", ex);\n\t\t\tthrow ex;\n\t\t}\n\n\t\tif (this.logger.isInfoEnabled()) {\n\t\t\tlong elapsedTime = System.currentTimeMillis() - startTime;\n\t\t\tthis.logger.info(\"FrameworkServlet '\" + getServletName() + \"': initialization completed in \" +\n\t\t\t\t\telapsedTime + \" ms\");\n\t\t}\n\t}\n```\n`webApplicationContext`在此进行初始化，并且给子类留下了一个hook\n``` java\nthis.webApplicationContext = initWebApplicationContext();\ninitFrameworkServlet();\n```\n`initFrameworkServlet`在本类中并没有实现，用于子类控制\n\n```java\n/**\n* This method will be invoked after any bean properties have been set and\n* the WebApplicationContext has been loaded. The default implementation is empty;\n* subclasses may override this method to perform any initialization they require.\n* @throws ServletException in case of an initialization exception\n*/\nprotected void initFrameworkServlet() throws ServletException {\n}\n```\n\n在initWebApplicationContext方法中，有一个空实现的方法onRefresh()\n```java\n/**\n* Template method which can be overridden to add servlet-specific refresh work.\n* Called after successful context refresh.\n* <p>This implementation is empty.\n* @param context the current WebApplicationContext\n* @see #refresh()\n*/\nprotected void onRefresh(ApplicationContext context) {\n// For subclasses: do nothing by default.\n}\n```\n\n这个方法也是钩子方法，DispatcherServlet正是实现了这个方法。\n\n```java\n\n/**\n\t* This implementation calls {@link #initStrategies}.\n\t*/\n\t@Override\n\tprotected void onRefresh(ApplicationContext context) {\n\t\tinitStrategies(context);\n\t}\n\n\n\t/**\n\t\t * Initialize the strategy objects that this servlet uses.\n\t\t * <p>May be overridden in subclasses in order to initialize further strategy objects.\n\t\t */\n\t\tprotected void initStrategies(ApplicationContext context) {\n\t\t\tinitMultipartResolver(context);\n\t\t\tinitLocaleResolver(context);\n\t\t\tinitThemeResolver(context);\n\t\t\tinitHandlerMappings(context);\n\t\t\tinitHandlerAdapters(context);\n\t\t\tinitHandlerExceptionResolvers(context);\n\t\t\tinitRequestToViewNameTranslator(context);\n\t\t\tinitViewResolvers(context);\n\t\t\tinitFlashMapManager(context);\n\t\t}\n```\n\nonRefresh方法中又调用了initStrategies方法，在这个方法中进行了大量的初始化工作。\n\n视图解析器和HandlerMappings都是在这个方法中初始化的。\n\n重点看一下initHandlerMappings方法，这个方法是初始化url映射的\n\n```java\n/**\n\t * Initialize the HandlerMappings used by this class.\n\t * <p>If no HandlerMapping beans are defined in the BeanFactory for this namespace,\n\t * we default to BeanNameUrlHandlerMapping.\n\t */\n\tprivate void initHandlerMappings(ApplicationContext context) {\n\t\tthis.handlerMappings = null;\n\n\t\tif (this.detectAllHandlerMappings) {\n\t\t\t// Find all HandlerMappings in the ApplicationContext, including ancestor contexts.\n\t\t\tMap<String, HandlerMapping> matchingBeans =\n\t\t\t\t\tBeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, true, false);\n\t\t\tif (!matchingBeans.isEmpty()) {\n\t\t\t\tthis.handlerMappings = new ArrayList<HandlerMapping>(matchingBeans.values());\n\t\t\t\t// We keep HandlerMappings in sorted order.\n\t\t\t\tAnnotationAwareOrderComparator.sort(this.handlerMappings);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\ttry {\n\t\t\t\tHandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping.class);\n\t\t\t\tthis.handlerMappings = Collections.singletonList(hm);\n\t\t\t}\n\t\t\tcatch (NoSuchBeanDefinitionException ex) {\n\t\t\t\t// Ignore, we'll add a default HandlerMapping later.\n\t\t\t}\n\t\t}\n\n\t\t// Ensure we have at least one HandlerMapping, by registering\n\t\t// a default HandlerMapping if no other mappings are found.\n\t\tif (this.handlerMappings == null) {\n\t\t\tthis.handlerMappings = getDefaultStrategies(context, HandlerMapping.class);\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"No HandlerMappings found in servlet '\" + getServletName() + \"': using default\");\n\t\t\t}\n\t\t}\n\t}\n  ```\n  其根据 this.detectAllHandlerMappings 的值来确定是否扫描祖先定义的handlermappings，如果用户没有配置的话，就会使用默认的HandlerMapping\n```java\n/** Detect all HandlerMappings or just expect \"handlerMapping\" bean? */\nprivate boolean detectAllHandlerMappings = true;\n```\n\n### service方法\n\nservlet接口中另外一个重要的方法叫做`service`\n\n`service`方法最早是在`HttpServlet`类中实现的，代码如下：\n```java\n/**\n     * Dispatches client requests to the protected\n     * <code>service</code> method. There's no need to\n     * override this method.\n     *\n     * @param req   the {@link HttpServletRequest} object that\n     *                  contains the request the client made of\n     *                  the servlet\n     *\n     * @param res   the {@link HttpServletResponse} object that\n     *                  contains the response the servlet returns\n     *                  to the client                                \n     *\n     * @exception IOException   if an input or output error occurs\n     *                              while the servlet is handling the\n     *                              HTTP request\n     *\n     * @exception ServletException  if the HTTP request cannot\n     *                                  be handled\n     *\n     * @see javax.servlet.Servlet#service\n     */\n    public void service(ServletRequest req, ServletResponse res)\n        throws ServletException, IOException\n    {\n        HttpServletRequest  request;\n        HttpServletResponse response;\n\n        if (!(req instanceof HttpServletRequest &&\n                res instanceof HttpServletResponse)) {\n            throw new ServletException(\"non-HTTP request or response\");\n        }\n\n        request = (HttpServletRequest) req;\n        response = (HttpServletResponse) res;\n\n        service(request, response);\n    }\n}\n\n```\n它又调用自身的一个`service`方法:\n```java\n/**\n    * Receives standard HTTP requests from the public\n    * <code>service</code> method and dispatches\n    * them to the <code>do</code><i>XXX</i> methods defined in\n    * this class. This method is an HTTP-specific version of the\n    * {@link javax.servlet.Servlet#service} method. There's no\n    * need to override this method.\n    *\n    * @param req   the {@link HttpServletRequest} object that\n    *                  contains the request the client made of\n    *                  the servlet\n    *\n    * @param resp  the {@link HttpServletResponse} object that\n    *                  contains the response the servlet returns\n    *                  to the client                                \n    *\n    * @exception IOException   if an input or output error occurs\n    *                              while the servlet is handling the\n    *                              HTTP request\n    *\n    * @exception ServletException  if the HTTP request\n    *                                  cannot be handled\n    *\n    * @see javax.servlet.Servlet#service\n    */\n   protected void service(HttpServletRequest req, HttpServletResponse resp)\n       throws ServletException, IOException\n   {\n       String method = req.getMethod();\n\n       if (method.equals(METHOD_GET)) {\n           long lastModified = getLastModified(req);\n           if (lastModified == -1) {\n               // servlet doesn't support if-modified-since, no reason\n               // to go through further expensive logic\n               doGet(req, resp);\n           } else {\n               long ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);\n               if (ifModifiedSince < lastModified) {\n                   // If the servlet mod time is later, call doGet()\n                   // Round down to the nearest second for a proper compare\n                   // A ifModifiedSince of -1 will always be less\n                   maybeSetLastModified(resp, lastModified);\n                   doGet(req, resp);\n               } else {\n                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);\n               }\n           }\n\n       } else if (method.equals(METHOD_HEAD)) {\n           long lastModified = getLastModified(req);\n           maybeSetLastModified(resp, lastModified);\n           doHead(req, resp);\n\n       } else if (method.equals(METHOD_POST)) {\n           doPost(req, resp);\n\n       } else if (method.equals(METHOD_PUT)) {\n           doPut(req, resp);\n\n       } else if (method.equals(METHOD_DELETE)) {\n           doDelete(req, resp);\n\n       } else if (method.equals(METHOD_OPTIONS)) {\n           doOptions(req,resp);\n\n       } else if (method.equals(METHOD_TRACE)) {\n           doTrace(req,resp);\n\n       } else {\n           //\n           // Note that this means NO servlet supports whatever\n           // method was requested, anywhere on this server.\n           //\n\n           String errMsg = lStrings.getString(\"http.method_not_implemented\");\n           Object[] errArgs = new Object[1];\n           errArgs[0] = method;\n           errMsg = MessageFormat.format(errMsg, errArgs);\n\n           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);\n       }\n   }\n```\n\n这段代码就是根据请求的类型调用相应的处理方法\n\n这个方法又在`FrameWorkServlet`中被重写，如下：\n\n```java\n/**\n * Override the parent class implementation in order to intercept PATCH requests.\n */\n@Override\nprotected void service(HttpServletRequest request, HttpServletResponse response)\n    throws ServletException, IOException {\n\n  if (HttpMethod.PATCH.matches(request.getMethod())) {\n    processRequest(request, response);\n  }\n  else {\n    super.service(request, response);\n  }\n}\n```\n\n又增加了一个处理PATCH请求的方法，其他的还是调用`HttpServlet`的实现。\n\n同时，`FrameWorkServlet`又将`HttpServlet`中对应的各种HTTP请求的方法都进行了重写，如下：\n```java\n/**\n\t * Delegate GET requests to processRequest/doService.\n\t * <p>Will also be invoked by HttpServlet's default implementation of {@code doHead},\n\t * with a {@code NoBodyResponse} that just captures the content length.\n\t * @see #doService\n\t * @see #doHead\n\t */\n\t@Override\n\tprotected final void doGet(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException {\n\n\t\tprocessRequest(request, response);\n\t}\n```\n\n所有的请求都被委托给了`processRequest`这个方法，它的实现如下：\n\n```java\n/**\n\t * Process this request, publishing an event regardless of the outcome.\n\t * <p>The actual event handling is performed by the abstract\n\t * {@link #doService} template method.\n\t */\n\tprotected final void processRequest(HttpServletRequest request, HttpServletResponse response)\n\t\t\tthrows ServletException, IOException {\n\n\t\tlong startTime = System.currentTimeMillis();\n\t\tThrowable failureCause = null;\n\n\t\tLocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();\n\t\tLocaleContext localeContext = buildLocaleContext(request);\n\n\t\tRequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();\n\t\tServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);\n\n\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\t\tasyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), new RequestBindingInterceptor());\n\n\t\tinitContextHolders(request, localeContext, requestAttributes);\n\n\t\ttry {\n\t\t\tdoService(request, response);\n\t\t}\n\t\tcatch (ServletException ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (IOException ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow ex;\n\t\t}\n\t\tcatch (Throwable ex) {\n\t\t\tfailureCause = ex;\n\t\t\tthrow new NestedServletException(\"Request processing failed\", ex);\n\t\t}\n\n\t\tfinally {\n\t\t\tresetContextHolders(request, previousLocaleContext, previousAttributes);\n\t\t\tif (requestAttributes != null) {\n\t\t\t\trequestAttributes.requestCompleted();\n\t\t\t}\n\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tif (failureCause != null) {\n\t\t\t\t\tthis.logger.debug(\"Could not complete request\", failureCause);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t\t\tlogger.debug(\"Leaving response open for concurrent processing\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis.logger.debug(\"Successfully completed request\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tpublishRequestHandledEvent(request, response, startTime, failureCause);\n\t\t}\n\t}\n\n```\n\n上述代码的异常处理很值得借鉴，上述代码中`doService(request, response)`是核心。\n\n它是`FrameWorkServlet`中定义的一个接口，它在`DispatcherServlet`中被实现。\n```java\n/**\n * Subclasses must implement this method to do the work of request handling,\n * receiving a centralized callback for GET, POST, PUT and DELETE.\n * <p>The contract is essentially the same as that for the commonly overridden\n * {@code doGet} or {@code doPost} methods of HttpServlet.\n * <p>This class intercepts calls to ensure that exception handling and\n * event publication takes place.\n * @param request current HTTP request\n * @param response current HTTP response\n * @throws Exception in case of any kind of processing failure\n * @see javax.servlet.http.HttpServlet#doGet\n * @see javax.servlet.http.HttpServlet#doPost\n */\nprotected abstract void doService(HttpServletRequest request, HttpServletResponse response)\n    throws Exception;\n```\n\n`DispatcherServlet`中的`doService`接口代码如下：\n```java\n/**\n\t * Exposes the DispatcherServlet-specific request attributes and delegates to {@link #doDispatch}\n\t * for the actual dispatching.\n\t */\n\t@Override\n\tprotected void doService(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tif (logger.isDebugEnabled()) {\n\t\t\tString resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? \" resumed\" : \"\";\n\t\t\tlogger.debug(\"DispatcherServlet with name '\" + getServletName() + \"'\" + resumed +\n\t\t\t\t\t\" processing \" + request.getMethod() + \" request for [\" + getRequestUri(request) + \"]\");\n\t\t}\n\n\t\t// Keep a snapshot of the request attributes in case of an include,\n\t\t// to be able to restore the original attributes after the include.\n\t\tMap<String, Object> attributesSnapshot = null;\n\t\tif (WebUtils.isIncludeRequest(request)) {\n\t\t\tattributesSnapshot = new HashMap<String, Object>();\n\t\t\tEnumeration<?> attrNames = request.getAttributeNames();\n\t\t\twhile (attrNames.hasMoreElements()) {\n\t\t\t\tString attrName = (String) attrNames.nextElement();\n\t\t\t\tif (this.cleanupAfterInclude || attrName.startsWith(\"org.springframework.web.servlet\")) {\n\t\t\t\t\tattributesSnapshot.put(attrName, request.getAttribute(attrName));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Make framework objects available to handlers and view objects.\n\t\trequest.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());\n\t\trequest.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);\n\t\trequest.setAttribute(THEME_RESOLVER_ATTRIBUTE, this.themeResolver);\n\t\trequest.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());\n\n\t\tFlashMap inputFlashMap = this.flashMapManager.retrieveAndUpdate(request, response);\n\t\tif (inputFlashMap != null) {\n\t\t\trequest.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));\n\t\t}\n\t\trequest.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, new FlashMap());\n\t\trequest.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, this.flashMapManager);\n\n\t\ttry {\n\t\t\tdoDispatch(request, response);\n\t\t}\n\t\tfinally {\n\t\t\tif (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n\t\t\t\t// Restore the original attribute snapshot, in case of an include.\n\t\t\t\tif (attributesSnapshot != null) {\n\t\t\t\t\trestoreAttributesAfterInclude(request, attributesSnapshot);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n```\n\n每次请求过来都会将系统的一些属性塞到request的attribute中，以便后面的handlers和view能够访问到。\n\n其中比较重要的是 `doDispatch(request, response)`，正是这个方法使得请求被真正的转发。\n\n```java\n/**\n\t * Process the actual dispatching to the handler.\n\t * <p>The handler will be obtained by applying the servlet's HandlerMappings in order.\n\t * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters\n\t * to find the first that supports the handler class.\n\t * <p>All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers\n\t * themselves to decide which methods are acceptable.\n\t * @param request current HTTP request\n\t * @param response current HTTP response\n\t * @throws Exception in case of any kind of processing failure\n\t */\n\tprotected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tHttpServletRequest processedRequest = request;\n\t\tHandlerExecutionChain mappedHandler = null;\n\t\tboolean multipartRequestParsed = false;\n\n\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n\n\t\ttry {\n\t\t\tModelAndView mv = null;\n\t\t\tException dispatchException = null;\n\n\t\t\ttry {\n\t\t\t\tprocessedRequest = checkMultipart(request);\n\t\t\t\tmultipartRequestParsed = (processedRequest != request);\n\n\t\t\t\t// Determine handler for the current request.\n\t\t\t\tmappedHandler = getHandler(processedRequest);\n\t\t\t\tif (mappedHandler == null || mappedHandler.getHandler() == null) {\n\t\t\t\t\tnoHandlerFound(processedRequest, response);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Determine handler adapter for the current request.\n\t\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n\n\t\t\t\t// Process last-modified header, if supported by the handler.\n\t\t\t\tString method = request.getMethod();\n\t\t\t\tboolean isGet = \"GET\".equals(method);\n\t\t\t\tif (isGet || \"HEAD\".equals(method)) {\n\t\t\t\t\tlong lastModified = ha.getLastModified(request, mappedHandler.getHandler());\n\t\t\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\t\t\tlogger.debug(\"Last-Modified value for [\" + getRequestUri(request) + \"] is: \" + lastModified);\n\t\t\t\t\t}\n\t\t\t\t\tif (new ServletWebRequest(request, response).checkNotModified(lastModified) && isGet) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!mappedHandler.applyPreHandle(processedRequest, response)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Actually invoke the handler.\n\t\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n\t\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tapplyDefaultViewName(processedRequest, mv);\n\t\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tdispatchException = ex;\n\t\t\t}\n\t\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);\n\t\t}\n\t\tcatch (Error err) {\n\t\t\ttriggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);\n\t\t}\n\t\tfinally {\n\t\t\tif (asyncManager.isConcurrentHandlingStarted()) {\n\t\t\t\t// Instead of postHandle and afterCompletion\n\t\t\t\tif (mappedHandler != null) {\n\t\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Clean up any resources used by a multipart request.\n\t\t\t\tif (multipartRequestParsed) {\n\t\t\t\t\tcleanupMultipart(processedRequest);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n```\n\nhandler 获取的顺序是从DispatcherServlet的HandlerMapping中按顺序取出的\n\nHandler对应的HandlerAdapter会从安装的HandlerAdapter找，将返回第一个合适的Adapter\n\n```java\n  HandlerExecutionChain mappedHandler = null;\n\n  // Determine handler for the current request.\n  mappedHandler = getHandler(processedRequest);\n              ...\n  // Determine handler adapter for the current request.\n  HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());\n              ...\n\n  if (!mappedHandler.applyPreHandle(processedRequest, response)) {\n          return;\n  }\n  // Actually invoke the handler.\n  mv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n\n  mappedHandler.applyPostHandle(processedRequest, response, mv);\n\n  processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n```\n在applyPreHandle中也是检查拦截器的操作，并根据拦截器返回的布尔类型，判断是否进一步处理\n\n其中在applyPostHandle中又检查是否有各种拦截器,调用拦截器的postHandle方法\n\n处理完毕后，调用processDispatchResult方法将处理后的请求和mv进行分发\n\n```java\n//HandlerExecutionChain.java\n\n\t\t/**\n\t * Apply preHandle methods of registered interceptors.\n\t * @return {@code true} if the execution chain should proceed with the\n\t * next interceptor or the handler itself. Else, DispatcherServlet assumes\n\t * that this interceptor has already dealt with the response itself.\n\t */\n\tboolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\tHandlerInterceptor[] interceptors = getInterceptors();\n\t\tif (!ObjectUtils.isEmpty(interceptors)) {\n\t\t\tfor (int i = 0; i < interceptors.length; i++) {\n\t\t\t\tHandlerInterceptor interceptor = interceptors[i];\n\t\t\t\tif (!interceptor.preHandle(request, response, this.handler)) {\n\t\t\t\t\ttriggerAfterCompletion(request, response, null);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tthis.interceptorIndex = i;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t* Apply postHandle methods of registered interceptors.\n\t*/\n\tvoid applyPostHandle(HttpServletRequest request, HttpServletResponse response, ModelAndView mv) throws Exception {\n\tHandlerInterceptor[] interceptors = getInterceptors();\n\tif (!ObjectUtils.isEmpty(interceptors)) {\n\t\tfor (int i = interceptors.length - 1; i >= 0; i--) {\n\t\t\tHandlerInterceptor interceptor = interceptors[i];\n\t\t\tinterceptor.postHandle(request, response, this.handler, mv);\n\t\t}\n\t}\n```\n\nhandler处理后的结果是通过processDispatchResult传出去的\n\n```java\n//DispatcherServlet.java\n\n\t/**\n\t * Handle the result of handler selection and handler invocation, which is\n\t * either a ModelAndView or an Exception to be resolved to a ModelAndView.\n\t */\n\tprivate void processDispatchResult(HttpServletRequest request, HttpServletResponse response,\n\t\t\tHandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception) throws Exception {\n\n\t\tboolean errorView = false;\n\n\t\tif (exception != null) {\n\t\t\tif (exception instanceof ModelAndViewDefiningException) {\n\t\t\t\tlogger.debug(\"ModelAndViewDefiningException encountered\", exception);\n\t\t\t\tmv = ((ModelAndViewDefiningException) exception).getModelAndView();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tObject handler = (mappedHandler != null ? mappedHandler.getHandler() : null);\n\t\t\t\tmv = processHandlerException(request, response, handler, exception);\n\t\t\t\terrorView = (mv != null);\n\t\t\t}\n\t\t}\n\n\t\t// Did the handler return a view to render?\n\t\tif (mv != null && !mv.wasCleared()) {\n\t\t\trender(mv, request, response);\n\t\t\tif (errorView) {\n\t\t\t\tWebUtils.clearErrorRequestAttributes(request);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Null ModelAndView returned to DispatcherServlet with name '\" + getServletName() +\n\t\t\t\t\t\t\"': assuming HandlerAdapter completed request handling\");\n\t\t\t}\n\t\t}\n\n\t\tif (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {\n\t\t\t// Concurrent handling started during a forward\n\t\t\treturn;\n\t\t}\n\n\t\tif (mappedHandler != null) {\n\t\t\tmappedHandler.triggerAfterCompletion(request, response, null);\n\t\t}\n\t}\n```\n\n去各种判断，核心的方法就在`render(mv, request, response)`;\n\n它负责渲染返回的`ModelAndView`\n\n```java\n//DispatcherServlet.java\n\n\t/**\n\t* Render the given ModelAndView.\n\t* <p>This is the last stage in handling a request. It may involve resolving the view by name.\n\t* @param mv the ModelAndView to render\n\t* @param request current HTTP servlet request\n\t* @param response current HTTP servlet response\n\t* @throws ServletException if view is missing or cannot be resolved\n\t* @throws Exception if there's a problem rendering the view\n\t*/\n\tprotected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception {\n\t\t// Determine locale for request and apply it to the response.\n\t\tLocale locale = this.localeResolver.resolveLocale(request);\n\t\tresponse.setLocale(locale);\n\n\t\tView view;\n\t\tif (mv.isReference()) {\n\t\t\t// We need to resolve the view name.\n\t\t\tview = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);\n\t\t\tif (view == null) {\n\t\t\t\tthrow new ServletException(\"Could not resolve view with name '\" + mv.getViewName() +\n\t\t\t\t\t\t\"' in servlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t// No need to lookup: the ModelAndView object contains the actual View object.\n\t\t\tview = mv.getView();\n\t\t\tif (view == null) {\n\t\t\t\tthrow new ServletException(\"ModelAndView [\" + mv + \"] neither contains a view name nor a \" +\n\t\t\t\t\t\t\"View object in servlet with name '\" + getServletName() + \"'\");\n\t\t\t}\n\t\t}\n\n\t\t// Delegate to the View object for rendering.\n\t\tif (logger.isDebugEnabled()) {\n\t\t\tlogger.debug(\"Rendering view [\" + view + \"] in DispatcherServlet with name '\" + getServletName() + \"'\");\n\t\t}\n\t\ttry {\n\t\t\tview.render(mv.getModelInternal(), request, response);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug(\"Error rendering view [\" + view + \"] in DispatcherServlet with name '\" +\n\t\t\t\t\t\tgetServletName() + \"'\", ex);\n\t\t\t}\n\t\t\tthrow ex;\n\t\t}\n\t}\n```\n\n这个函数解析mv对象，如果是一个引用名就查找对应的view，最终返回一个View对象，\n\n然后将渲染的工作委托给这个view对象，`view.render(mv.getModelInternal(), request, response);`\n\n其中`resolveViewName`方法遍历 `DispatcherServlet`中注册的`viewResolver`，返回第一个非空的结果\n\n查找视图名称的方法如下:\n```java\n\n/** List of ViewResolvers used by this servlet */\nprivate List<ViewResolver> viewResolvers;\n\n\n/**\n\t* Resolve the given view name into a View object (to be rendered).\n\t* <p>The default implementations asks all ViewResolvers of this dispatcher.\n\t* Can be overridden for custom resolution strategies, potentially based on\n\t* specific model attributes or request parameters.\n\t* @param viewName the name of the view to resolve\n\t* @param model the model to be passed to the view\n\t* @param locale the current locale\n\t* @param request current HTTP servlet request\n\t* @return the View object, or {@code null} if none found\n\t* @throws Exception if the view cannot be resolved\n\t* (typically in case of problems creating an actual View object)\n\t* @see ViewResolver#resolveViewName\n\t*/\n\tprotected View resolveViewName(String viewName, Map<String, Object> model, Locale locale,\n\t\tHttpServletRequest request) throws Exception {\n\n\t\t\tfor (ViewResolver viewResolver : this.viewResolvers) {\n\t\t\t\tView view = viewResolver.resolveViewName(viewName, locale);\n\t\t\t\tif (view != null) {\n\t\t\t\t\treturn view;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t}\n```\n\n最终视图的渲染是View中定义的`render`方法进行的，它是一个抽象的接口\n\n```java\n/**\n\t * Render the view given the specified model.\n\t * <p>The first step will be preparing the request: In the JSP case,\n\t * this would mean setting model objects as request attributes.\n\t * The second step will be the actual rendering of the view,\n\t * for example including the JSP via a RequestDispatcher.\n\t * @param model Map with name Strings as keys and corresponding model\n\t * objects as values (Map can also be {@code null} in case of empty model)\n\t * @param request current HTTP request\n\t * @param response HTTP response we are building\n\t * @throws Exception if rendering failed\n\t */\n\tvoid render(Map<String, ?> model, HttpServletRequest request, HttpServletResponse response) throws Exception;\n```\n","slug":"spring-mvc","published":1,"updated":"2018-05-05T03:22:08.108Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdan009jjh4ktpeh5rc1","content":"<h2 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h2><img src=\"/2016/10/02/spring-mvc/arch.jpg\">\n<p>SpringMVC的核心是 <code>DispatcherServlet</code></p>\n<h2 id=\"本质\"><a href=\"#本质\" class=\"headerlink\" title=\"本质\"></a>本质</h2><p>我们通过在<code>web.xml</code>中配置如下的语句，引入SpringMVC</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>mvc-dispatcher<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>classpath:/spring/mvc/mvc-dispatcher-servlet.xml<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>上述代码段指定了servlet的class是spring的<code>DispatcherServlet</code>，初始化配置文件是<code>mvc-dispatcher-servlet.xml</code>,以及servlet的加载顺序。</p>\n<p>既然<code>DispatcherServlet</code>也是一个<code>Servlet</code>，那他肯定也遵从servlet的规范。<br>我们知道Servlet定义了如下的接口：<br><img src=\"/2016/10/02/spring-mvc/servlet-interface.jpg\"></p>\n<p>其中比较重要的是<code>init</code>和<code>service</code>接口<br><code>init</code>方法在servlet的一生中只初始化一次，<code>service</code>接口是Servlet对外提供服务的接口<br>Servlet的生命周期如下:<br><img src=\"/2016/10/02/spring-mvc/Servlet_LifeCycle.jpg\"></p>\n<p>我们来看下<code>DispatcherServlet</code>的继承结构：</p>\n<img src=\"/2016/10/02/spring-mvc/hierachy.jpg\">\n<h3 id=\"init方法\"><a href=\"#init方法\" class=\"headerlink\" title=\"init方法\"></a>init方法</h3><p>直接去看<code>DispatcherServlet</code>的源码是没有发现<code>init</code>方法的， 它的<code>init</code>方法继承自<code>HttpServletBean</code>，源码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Map config parameters onto bean properties of this servlet, and</span></span><br><span class=\"line\"><span class=\"comment\"> * invoke subclass initialization.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> ServletException if bean properties are invalid (or required</span></span><br><span class=\"line\"><span class=\"comment\"> * properties are missing), or if subclass initialization fails.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\tlogger.debug(<span class=\"string\">\"Initializing servlet '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Set bean properties from init parameters.</span></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\tPropertyValues pvs = <span class=\"keyword\">new</span> ServletConfigPropertyValues(getServletConfig(), <span class=\"keyword\">this</span>.requiredProperties);</span><br><span class=\"line\">\t\tBeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t\tResourceLoader resourceLoader = <span class=\"keyword\">new</span> ServletContextResourceLoader(getServletContext());</span><br><span class=\"line\">\t\tbw.registerCustomEditor(Resource.class, <span class=\"keyword\">new</span> ResourceEditor(resourceLoader, getEnvironment()));</span><br><span class=\"line\">\t\tinitBeanWrapper(bw);</span><br><span class=\"line\">\t\tbw.setPropertyValues(pvs, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">catch</span> (BeansException ex) &#123;</span><br><span class=\"line\">\t\tlogger.error(<span class=\"string\">\"Failed to set bean properties on servlet '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>, ex);</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Let subclasses do whatever initialization they like.</span></span><br><span class=\"line\">\tinitServletBean();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\tlogger.debug(<span class=\"string\">\"Servlet '\"</span> + getServletName() + <span class=\"string\">\"' configured successfully\"</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在这个方法中，主要完成了bean属性的配置，并且给子类留下了相应的hook</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Let subclasses do whatever initialization they like.</span></span><br><span class=\"line\">initServletBean();</span><br></pre></td></tr></table></figure>\n<p>这个方法在FrameworkServlet中有具体的实现，现在看下FrameworkServlet中的实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Overridden method of &#123;<span class=\"doctag\">@link</span> HttpServletBean&#125;, invoked after any bean properties</span></span><br><span class=\"line\"><span class=\"comment\">\t * have been set. Creates this servlet's WebApplicationContext.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">initServletBean</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">\t\tgetServletContext().log(<span class=\"string\">\"Initializing Spring FrameworkServlet '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.info(<span class=\"string\">\"FrameworkServlet '\"</span> + getServletName() + <span class=\"string\">\"': initialization started\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">long</span> startTime = System.currentTimeMillis();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class=\"line\">\t\t\tinitFrameworkServlet();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (ServletException ex) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.error(<span class=\"string\">\"Context initialization failed\"</span>, ex);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (RuntimeException ex) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.error(<span class=\"string\">\"Context initialization failed\"</span>, ex);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">long</span> elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.info(<span class=\"string\">\"FrameworkServlet '\"</span> + getServletName() + <span class=\"string\">\"': initialization completed in \"</span> +</span><br><span class=\"line\">\t\t\t\t\telapsedTime + <span class=\"string\">\" ms\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p><code>webApplicationContext</code>在此进行初始化，并且给子类留下了一个hook<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class=\"line\">initFrameworkServlet();</span><br></pre></td></tr></table></figure></p>\n<p><code>initFrameworkServlet</code>在本类中并没有实现，用于子类控制</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* This method will be invoked after any bean properties have been set and</span></span><br><span class=\"line\"><span class=\"comment\">* the WebApplicationContext has been loaded. The default implementation is empty;</span></span><br><span class=\"line\"><span class=\"comment\">* subclasses may override this method to perform any initialization they require.</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@throws</span> ServletException in case of an initialization exception</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">initFrameworkServlet</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在initWebApplicationContext方法中，有一个空实现的方法onRefresh()<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Template method which can be overridden to add servlet-specific refresh work.</span></span><br><span class=\"line\"><span class=\"comment\">* Called after successful context refresh.</span></span><br><span class=\"line\"><span class=\"comment\">* &lt;p&gt;This implementation is empty.</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> context the current WebApplicationContext</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@see</span> #refresh()</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\"><span class=\"comment\">// For subclasses: do nothing by default.</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这个方法也是钩子方法，DispatcherServlet正是实现了这个方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* This implementation calls &#123;<span class=\"doctag\">@link</span> #initStrategies&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\">\t\tinitStrategies(context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * Initialize the strategy objects that this servlet uses.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">initStrategies</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\">\t\t\tinitMultipartResolver(context);</span><br><span class=\"line\">\t\t\tinitLocaleResolver(context);</span><br><span class=\"line\">\t\t\tinitThemeResolver(context);</span><br><span class=\"line\">\t\t\tinitHandlerMappings(context);</span><br><span class=\"line\">\t\t\tinitHandlerAdapters(context);</span><br><span class=\"line\">\t\t\tinitHandlerExceptionResolvers(context);</span><br><span class=\"line\">\t\t\tinitRequestToViewNameTranslator(context);</span><br><span class=\"line\">\t\t\tinitViewResolvers(context);</span><br><span class=\"line\">\t\t\tinitFlashMapManager(context);</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<p>onRefresh方法中又调用了initStrategies方法，在这个方法中进行了大量的初始化工作。</p>\n<p>视图解析器和HandlerMappings都是在这个方法中初始化的。</p>\n<p>重点看一下initHandlerMappings方法，这个方法是初始化url映射的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Initialize the HandlerMappings used by this class.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;If no HandlerMapping beans are defined in the BeanFactory for this namespace,</span></span><br><span class=\"line\"><span class=\"comment\">\t * we default to BeanNameUrlHandlerMapping.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initHandlerMappings</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.handlerMappings = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.detectAllHandlerMappings) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Find all HandlerMappings in the ApplicationContext, including ancestor contexts.</span></span><br><span class=\"line\">\t\t\tMap&lt;String, HandlerMapping&gt; matchingBeans =</span><br><span class=\"line\">\t\t\t\t\tBeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!matchingBeans.isEmpty()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.handlerMappings = <span class=\"keyword\">new</span> ArrayList&lt;HandlerMapping&gt;(matchingBeans.values());</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// We keep HandlerMappings in sorted order.</span></span><br><span class=\"line\">\t\t\t\tAnnotationAwareOrderComparator.sort(<span class=\"keyword\">this</span>.handlerMappings);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tHandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping.class);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.handlerMappings = Collections.singletonList(hm);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Ignore, we'll add a default HandlerMapping later.</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Ensure we have at least one HandlerMapping, by registering</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// a default HandlerMapping if no other mappings are found.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.handlerMappings == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.handlerMappings = getDefaultStrategies(context, HandlerMapping.class);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"No HandlerMappings found in servlet '\"</span> + getServletName() + <span class=\"string\">\"': using default\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>  其根据 this.detectAllHandlerMappings 的值来确定是否扫描祖先定义的handlermappings，如果用户没有配置的话，就会使用默认的HandlerMapping<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/** Detect all HandlerMappings or just expect \"handlerMapping\" bean? */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> detectAllHandlerMappings = <span class=\"keyword\">true</span>;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service方法\"><a href=\"#service方法\" class=\"headerlink\" title=\"service方法\"></a>service方法</h3><p>servlet接口中另外一个重要的方法叫做<code>service</code></p>\n<p><code>service</code>方法最早是在<code>HttpServlet</code>类中实现的，代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Dispatches client requests to the protected</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;code&gt;service&lt;/code&gt; method. There's no need to</span></span><br><span class=\"line\"><span class=\"comment\">     * override this method.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> req   the &#123;<span class=\"doctag\">@link</span> HttpServletRequest&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">     *                  contains the request the client made of</span></span><br><span class=\"line\"><span class=\"comment\">     *                  the servlet</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> res   the &#123;<span class=\"doctag\">@link</span> HttpServletResponse&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">     *                  contains the response the servlet returns</span></span><br><span class=\"line\"><span class=\"comment\">     *                  to the client                                </span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@exception</span> IOException   if an input or output error occurs</span></span><br><span class=\"line\"><span class=\"comment\">     *                              while the servlet is handling the</span></span><br><span class=\"line\"><span class=\"comment\">     *                              HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@exception</span> ServletException  if the HTTP request cannot</span></span><br><span class=\"line\"><span class=\"comment\">     *                                  be handled</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span> javax.servlet.Servlet#service</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(ServletRequest req, ServletResponse res)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> ServletException, IOException</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        HttpServletRequest  request;</span><br><span class=\"line\">        HttpServletResponse response;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(req <span class=\"keyword\">instanceof</span> HttpServletRequest &amp;&amp;</span><br><span class=\"line\">                res <span class=\"keyword\">instanceof</span> HttpServletResponse)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"non-HTTP request or response\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        request = (HttpServletRequest) req;</span><br><span class=\"line\">        response = (HttpServletResponse) res;</span><br><span class=\"line\"></span><br><span class=\"line\">        service(request, response);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>它又调用自身的一个<code>service</code>方法:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Receives standard HTTP requests from the public</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;code&gt;service&lt;/code&gt; method and dispatches</span></span><br><span class=\"line\"><span class=\"comment\">    * them to the &lt;code&gt;do&lt;/code&gt;&lt;i&gt;XXX&lt;/i&gt; methods defined in</span></span><br><span class=\"line\"><span class=\"comment\">    * this class. This method is an HTTP-specific version of the</span></span><br><span class=\"line\"><span class=\"comment\">    * &#123;<span class=\"doctag\">@link</span> javax.servlet.Servlet#service&#125; method. There's no</span></span><br><span class=\"line\"><span class=\"comment\">    * need to override this method.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> req   the &#123;<span class=\"doctag\">@link</span> HttpServletRequest&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">    *                  contains the request the client made of</span></span><br><span class=\"line\"><span class=\"comment\">    *                  the servlet</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> resp  the &#123;<span class=\"doctag\">@link</span> HttpServletResponse&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">    *                  contains the response the servlet returns</span></span><br><span class=\"line\"><span class=\"comment\">    *                  to the client                                </span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@exception</span> IOException   if an input or output error occurs</span></span><br><span class=\"line\"><span class=\"comment\">    *                              while the servlet is handling the</span></span><br><span class=\"line\"><span class=\"comment\">    *                              HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@exception</span> ServletException  if the HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">    *                                  cannot be handled</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@see</span> javax.servlet.Servlet#service</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class=\"line\"><span class=\"function\">       <span class=\"keyword\">throws</span> ServletException, IOException</span></span><br><span class=\"line\"><span class=\"function\">   </span>&#123;</span><br><span class=\"line\">       String method = req.getMethod();</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">long</span> lastModified = getLastModified(req);</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (lastModified == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">               <span class=\"comment\">// servlet doesn't support if-modified-since, no reason</span></span><br><span class=\"line\">               <span class=\"comment\">// to go through further expensive logic</span></span><br><span class=\"line\">               doGet(req, resp);</span><br><span class=\"line\">           &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">               <span class=\"keyword\">long</span> ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</span><br><span class=\"line\">               <span class=\"keyword\">if</span> (ifModifiedSince &lt; lastModified) &#123;</span><br><span class=\"line\">                   <span class=\"comment\">// If the servlet mod time is later, call doGet()</span></span><br><span class=\"line\">                   <span class=\"comment\">// Round down to the nearest second for a proper compare</span></span><br><span class=\"line\">                   <span class=\"comment\">// A ifModifiedSince of -1 will always be less</span></span><br><span class=\"line\">                   maybeSetLastModified(resp, lastModified);</span><br><span class=\"line\">                   doGet(req, resp);</span><br><span class=\"line\">               &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">long</span> lastModified = getLastModified(req);</span><br><span class=\"line\">           maybeSetLastModified(resp, lastModified);</span><br><span class=\"line\">           doHead(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class=\"line\">           doPost(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class=\"line\">           doPut(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class=\"line\">           doDelete(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class=\"line\">           doOptions(req,resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class=\"line\">           doTrace(req,resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"comment\">//</span></span><br><span class=\"line\">           <span class=\"comment\">// Note that this means NO servlet supports whatever</span></span><br><span class=\"line\">           <span class=\"comment\">// method was requested, anywhere on this server.</span></span><br><span class=\"line\">           <span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">           String errMsg = lStrings.getString(<span class=\"string\">\"http.method_not_implemented\"</span>);</span><br><span class=\"line\">           Object[] errArgs = <span class=\"keyword\">new</span> Object[<span class=\"number\">1</span>];</span><br><span class=\"line\">           errArgs[<span class=\"number\">0</span>] = method;</span><br><span class=\"line\">           errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class=\"line\"></span><br><span class=\"line\">           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure></p>\n<p>这段代码就是根据请求的类型调用相应的处理方法</p>\n<p>这个方法又在<code>FrameWorkServlet</code>中被重写，如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Override the parent class implementation in order to intercept PATCH requests.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (HttpMethod.PATCH.matches(request.getMethod())) &#123;</span><br><span class=\"line\">    processRequest(request, response);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.service(request, response);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>又增加了一个处理PATCH请求的方法，其他的还是调用<code>HttpServlet</code>的实现。</p>\n<p>同时，<code>FrameWorkServlet</code>又将<code>HttpServlet</code>中对应的各种HTTP请求的方法都进行了重写，如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Delegate GET requests to processRequest/doService.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Will also be invoked by HttpServlet's default implementation of &#123;<span class=\"doctag\">@code</span> doHead&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">\t * with a &#123;<span class=\"doctag\">@code</span> NoBodyResponse&#125; that just captures the content length.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #doService</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #doHead</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">doGet</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">\t\t\t<span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tprocessRequest(request, response);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>所有的请求都被委托给了<code>processRequest</code>这个方法，它的实现如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Process this request, publishing an event regardless of the outcome.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;The actual event handling is performed by the abstract</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@link</span> #doService&#125; template method.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">processRequest</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">\t\t\t<span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">long</span> startTime = System.currentTimeMillis();</span><br><span class=\"line\">\t\tThrowable failureCause = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tLocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();</span><br><span class=\"line\">\t\tLocaleContext localeContext = buildLocaleContext(request);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tRequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class=\"line\">\t\tServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\">\t\tasyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), <span class=\"keyword\">new</span> RequestBindingInterceptor());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tinitContextHolders(request, localeContext, requestAttributes);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tdoService(request, response);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (ServletException ex) &#123;</span><br><span class=\"line\">\t\t\tfailureCause = ex;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">\t\t\tfailureCause = ex;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">\t\t\tfailureCause = ex;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NestedServletException(<span class=\"string\">\"Request processing failed\"</span>, ex);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\tresetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (requestAttributes != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\trequestAttributes.requestCompleted();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (failureCause != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">this</span>.logger.debug(<span class=\"string\">\"Could not complete request\"</span>, failureCause);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogger.debug(<span class=\"string\">\"Leaving response open for concurrent processing\"</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">this</span>.logger.debug(<span class=\"string\">\"Successfully completed request\"</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tpublishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码的异常处理很值得借鉴，上述代码中<code>doService(request, response)</code>是核心。</p>\n<p>它是<code>FrameWorkServlet</code>中定义的一个接口，它在<code>DispatcherServlet</code>中被实现。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Subclasses must implement this method to do the work of request handling,</span></span><br><span class=\"line\"><span class=\"comment\"> * receiving a centralized callback for GET, POST, PUT and DELETE.</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;The contract is essentially the same as that for the commonly overridden</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;<span class=\"doctag\">@code</span> doGet&#125; or &#123;<span class=\"doctag\">@code</span> doPost&#125; methods of HttpServlet.</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;This class intercepts calls to ensure that exception handling and</span></span><br><span class=\"line\"><span class=\"comment\"> * event publication takes place.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> response current HTTP response</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> javax.servlet.http.HttpServlet#doGet</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> javax.servlet.http.HttpServlet#doPost</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">doService</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure></p>\n<p><code>DispatcherServlet</code>中的<code>doService</code>接口代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class=\"doctag\">@link</span> #doDispatch&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * for the actual dispatching.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doService</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\tString resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? <span class=\"string\">\" resumed\"</span> : <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">\t\t\tlogger.debug(<span class=\"string\">\"DispatcherServlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span> + resumed +</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">\" processing \"</span> + request.getMethod() + <span class=\"string\">\" request for [\"</span> + getRequestUri(request) + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// to be able to restore the original attributes after the include.</span></span><br><span class=\"line\">\t\tMap&lt;String, Object&gt; attributesSnapshot = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class=\"line\">\t\t\tattributesSnapshot = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">\t\t\tEnumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class=\"line\">\t\t\t\tString attrName = (String) attrNames.nextElement();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.cleanupAfterInclude || attrName.startsWith(<span class=\"string\">\"org.springframework.web.servlet\"</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\tattributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Make framework objects available to handlers and view objects.</span></span><br><span class=\"line\">\t\trequest.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class=\"line\">\t\trequest.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class=\"keyword\">this</span>.localeResolver);</span><br><span class=\"line\">\t\trequest.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class=\"keyword\">this</span>.themeResolver);</span><br><span class=\"line\">\t\trequest.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tFlashMap inputFlashMap = <span class=\"keyword\">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (inputFlashMap != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\trequest.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\trequest.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class=\"keyword\">new</span> FlashMap());</span><br><span class=\"line\">\t\trequest.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class=\"keyword\">this</span>.flashMapManager);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tdoDispatch(request, response);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (attributesSnapshot != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\trestoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>每次请求过来都会将系统的一些属性塞到request的attribute中，以便后面的handlers和view能够访问到。</p>\n<p>其中比较重要的是 <code>doDispatch(request, response)</code>，正是这个方法使得请求被真正的转发。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Process the actual dispatching to the handler.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;The handler will be obtained by applying the servlet's HandlerMappings in order.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters</span></span><br><span class=\"line\"><span class=\"comment\">\t * to find the first that supports the handler class.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers</span></span><br><span class=\"line\"><span class=\"comment\">\t * themselves to decide which methods are acceptable.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> response current HTTP response</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\tHttpServletRequest processedRequest = request;</span><br><span class=\"line\">\t\tHandlerExecutionChain mappedHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">boolean</span> multipartRequestParsed = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tModelAndView mv = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t\tException dispatchException = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tprocessedRequest = checkMultipart(request);</span><br><span class=\"line\">\t\t\t\tmultipartRequestParsed = (processedRequest != request);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Determine handler for the current request.</span></span><br><span class=\"line\">\t\t\t\tmappedHandler = getHandler(processedRequest);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (mappedHandler == <span class=\"keyword\">null</span> || mappedHandler.getHandler() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\tnoHandlerFound(processedRequest, response);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Determine handler adapter for the current request.</span></span><br><span class=\"line\">\t\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Process last-modified header, if supported by the handler.</span></span><br><span class=\"line\">\t\t\t\tString method = request.getMethod();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">boolean</span> isGet = <span class=\"string\">\"GET\"</span>.equals(method);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (isGet || <span class=\"string\">\"HEAD\"</span>.equals(method)) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogger.debug(<span class=\"string\">\"Last-Modified value for [\"</span> + getRequestUri(request) + <span class=\"string\">\"] is: \"</span> + lastModified);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Actually invoke the handler.</span></span><br><span class=\"line\">\t\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tapplyDefaultViewName(processedRequest, mv);</span><br><span class=\"line\">\t\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\t\tdispatchException = ex;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Error err) &#123;</span><br><span class=\"line\">\t\t\ttriggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Instead of postHandle and afterCompletion</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (mappedHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Clean up any resources used by a multipart request.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (multipartRequestParsed) &#123;</span><br><span class=\"line\">\t\t\t\t\tcleanupMultipart(processedRequest);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>handler 获取的顺序是从DispatcherServlet的HandlerMapping中按顺序取出的</p>\n<p>Handler对应的HandlerAdapter会从安装的HandlerAdapter找，将返回第一个合适的Adapter</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HandlerExecutionChain mappedHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Determine handler for the current request.</span></span><br><span class=\"line\">mappedHandler = getHandler(processedRequest);</span><br><span class=\"line\">            ...</span><br><span class=\"line\"><span class=\"comment\">// Determine handler adapter for the current request.</span></span><br><span class=\"line\">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class=\"line\">            ...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Actually invoke the handler.</span></span><br><span class=\"line\">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class=\"line\"></span><br><span class=\"line\">mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class=\"line\"></span><br><span class=\"line\">processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br></pre></td></tr></table></figure>\n<p>在applyPreHandle中也是检查拦截器的操作，并根据拦截器返回的布尔类型，判断是否进一步处理</p>\n<p>其中在applyPostHandle中又检查是否有各种拦截器,调用拦截器的postHandle方法</p>\n<p>处理完毕后，调用processDispatchResult方法将处理后的请求和mv进行分发</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//HandlerExecutionChain.java</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Apply preHandle methods of registered interceptors.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> &#123;<span class=\"doctag\">@code</span> true&#125; if the execution chain should proceed with the</span></span><br><span class=\"line\"><span class=\"comment\">\t * next interceptor or the handler itself. Else, DispatcherServlet assumes</span></span><br><span class=\"line\"><span class=\"comment\">\t * that this interceptor has already dealt with the response itself.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">applyPreHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\tHandlerInterceptor[] interceptors = getInterceptors();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; interceptors.length; i++) &#123;</span><br><span class=\"line\">\t\t\t\tHandlerInterceptor interceptor = interceptors[i];</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!interceptor.preHandle(request, response, <span class=\"keyword\">this</span>.handler)) &#123;</span><br><span class=\"line\">\t\t\t\t\ttriggerAfterCompletion(request, response, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.interceptorIndex = i;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* Apply postHandle methods of registered interceptors.</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">applyPostHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, ModelAndView mv)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\tHandlerInterceptor[] interceptors = getInterceptors();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = interceptors.length - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">\t\t\tHandlerInterceptor interceptor = interceptors[i];</span><br><span class=\"line\">\t\t\tinterceptor.postHandle(request, response, <span class=\"keyword\">this</span>.handler, mv);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>handler处理后的结果是通过processDispatchResult传出去的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//DispatcherServlet.java</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Handle the result of handler selection and handler invocation, which is</span></span><br><span class=\"line\"><span class=\"comment\">\t * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processDispatchResult</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tHandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">boolean</span> errorView = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"ModelAndViewDefiningException encountered\"</span>, exception);</span><br><span class=\"line\">\t\t\t\tmv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tObject handler = (mappedHandler != <span class=\"keyword\">null</span> ? mappedHandler.getHandler() : <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t\t\tmv = processHandlerException(request, response, handler, exception);</span><br><span class=\"line\">\t\t\t\terrorView = (mv != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Did the handler return a view to render?</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (mv != <span class=\"keyword\">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class=\"line\">\t\t\trender(mv, request, response);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (errorView) &#123;</span><br><span class=\"line\">\t\t\t\tWebUtils.clearErrorRequestAttributes(request);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"Null ModelAndView returned to DispatcherServlet with name '\"</span> + getServletName() +</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"': assuming HandlerAdapter completed request handling\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Concurrent handling started during a forward</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (mappedHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\tmappedHandler.triggerAfterCompletion(request, response, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>去各种判断，核心的方法就在<code>render(mv, request, response)</code>;</p>\n<p>它负责渲染返回的<code>ModelAndView</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//DispatcherServlet.java</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* Render the given ModelAndView.</span></span><br><span class=\"line\"><span class=\"comment\">\t* &lt;p&gt;This is the last stage in handling a request. It may involve resolving the view by name.</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> mv the ModelAndView to render</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> request current HTTP servlet request</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> response current HTTP servlet response</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@throws</span> ServletException if view is missing or cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@throws</span> Exception if there's a problem rendering the view</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">render</span><span class=\"params\">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Determine locale for request and apply it to the response.</span></span><br><span class=\"line\">\t\tLocale locale = <span class=\"keyword\">this</span>.localeResolver.resolveLocale(request);</span><br><span class=\"line\">\t\tresponse.setLocale(locale);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tView view;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (mv.isReference()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// We need to resolve the view name.</span></span><br><span class=\"line\">\t\t\tview = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (view == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"Could not resolve view with name '\"</span> + mv.getViewName() +</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"' in servlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// No need to lookup: the ModelAndView object contains the actual View object.</span></span><br><span class=\"line\">\t\t\tview = mv.getView();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (view == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"ModelAndView [\"</span> + mv + <span class=\"string\">\"] neither contains a view name nor a \"</span> +</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"View object in servlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Delegate to the View object for rendering.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\tlogger.debug(<span class=\"string\">\"Rendering view [\"</span> + view + <span class=\"string\">\"] in DispatcherServlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tview.render(mv.getModelInternal(), request, response);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"Error rendering view [\"</span> + view + <span class=\"string\">\"] in DispatcherServlet with name '\"</span> +</span><br><span class=\"line\">\t\t\t\t\t\tgetServletName() + <span class=\"string\">\"'\"</span>, ex);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>这个函数解析mv对象，如果是一个引用名就查找对应的view，最终返回一个View对象，</p>\n<p>然后将渲染的工作委托给这个view对象，<code>view.render(mv.getModelInternal(), request, response);</code></p>\n<p>其中<code>resolveViewName</code>方法遍历 <code>DispatcherServlet</code>中注册的<code>viewResolver</code>，返回第一个非空的结果</p>\n<p>查找视图名称的方法如下:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** List of ViewResolvers used by this servlet */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* Resolve the given view name into a View object (to be rendered).</span></span><br><span class=\"line\"><span class=\"comment\">\t* &lt;p&gt;The default implementations asks all ViewResolvers of this dispatcher.</span></span><br><span class=\"line\"><span class=\"comment\">\t* Can be overridden for custom resolution strategies, potentially based on</span></span><br><span class=\"line\"><span class=\"comment\">\t* specific model attributes or request parameters.</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> viewName the name of the view to resolve</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> model the model to be passed to the view</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> locale the current locale</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> request current HTTP servlet request</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@return</span> the View object, or &#123;<span class=\"doctag\">@code</span> null&#125; if none found</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@throws</span> Exception if the view cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t* (typically in case of problems creating an actual View object)</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@see</span> ViewResolver#resolveViewName</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> View <span class=\"title\">resolveViewName</span><span class=\"params\">(String viewName, Map&lt;String, Object&gt; model, Locale locale,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\tHttpServletRequest request)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (ViewResolver viewResolver : <span class=\"keyword\">this</span>.viewResolvers) &#123;</span><br><span class=\"line\">\t\t\t\tView view = viewResolver.resolveViewName(viewName, locale);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (view != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> view;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>最终视图的渲染是View中定义的<code>render</code>方法进行的，它是一个抽象的接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Render the view given the specified model.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;The first step will be preparing the request: In the JSP case,</span></span><br><span class=\"line\"><span class=\"comment\">\t * this would mean setting model objects as request attributes.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The second step will be the actual rendering of the view,</span></span><br><span class=\"line\"><span class=\"comment\">\t * for example including the JSP via a RequestDispatcher.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> model Map with name Strings as keys and corresponding model</span></span><br><span class=\"line\"><span class=\"comment\">\t * objects as values (Map can also be &#123;<span class=\"doctag\">@code</span> null&#125; in case of empty model)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> response HTTP response we are building</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> Exception if rendering failed</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">render</span><span class=\"params\">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h2><img src=\"/2016/10/02/spring-mvc/arch.jpg\">\n<p>SpringMVC的核心是 <code>DispatcherServlet</code></p>\n<h2 id=\"本质\"><a href=\"#本质\" class=\"headerlink\" title=\"本质\"></a>本质</h2><p>我们通过在<code>web.xml</code>中配置如下的语句，引入SpringMVC</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>mvc-dispatcher<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>classpath:/spring/mvc/mvc-dispatcher-servlet.xml<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>上述代码段指定了servlet的class是spring的<code>DispatcherServlet</code>，初始化配置文件是<code>mvc-dispatcher-servlet.xml</code>,以及servlet的加载顺序。</p>\n<p>既然<code>DispatcherServlet</code>也是一个<code>Servlet</code>，那他肯定也遵从servlet的规范。<br>我们知道Servlet定义了如下的接口：<br><img src=\"/2016/10/02/spring-mvc/servlet-interface.jpg\"></p>\n<p>其中比较重要的是<code>init</code>和<code>service</code>接口<br><code>init</code>方法在servlet的一生中只初始化一次，<code>service</code>接口是Servlet对外提供服务的接口<br>Servlet的生命周期如下:<br><img src=\"/2016/10/02/spring-mvc/Servlet_LifeCycle.jpg\"></p>\n<p>我们来看下<code>DispatcherServlet</code>的继承结构：</p>\n<img src=\"/2016/10/02/spring-mvc/hierachy.jpg\">\n<h3 id=\"init方法\"><a href=\"#init方法\" class=\"headerlink\" title=\"init方法\"></a>init方法</h3><p>直接去看<code>DispatcherServlet</code>的源码是没有发现<code>init</code>方法的， 它的<code>init</code>方法继承自<code>HttpServletBean</code>，源码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Map config parameters onto bean properties of this servlet, and</span></span><br><span class=\"line\"><span class=\"comment\"> * invoke subclass initialization.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> ServletException if bean properties are invalid (or required</span></span><br><span class=\"line\"><span class=\"comment\"> * properties are missing), or if subclass initialization fails.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\tlogger.debug(<span class=\"string\">\"Initializing servlet '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Set bean properties from init parameters.</span></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\tPropertyValues pvs = <span class=\"keyword\">new</span> ServletConfigPropertyValues(getServletConfig(), <span class=\"keyword\">this</span>.requiredProperties);</span><br><span class=\"line\">\t\tBeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t\tResourceLoader resourceLoader = <span class=\"keyword\">new</span> ServletContextResourceLoader(getServletContext());</span><br><span class=\"line\">\t\tbw.registerCustomEditor(Resource.class, <span class=\"keyword\">new</span> ResourceEditor(resourceLoader, getEnvironment()));</span><br><span class=\"line\">\t\tinitBeanWrapper(bw);</span><br><span class=\"line\">\t\tbw.setPropertyValues(pvs, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">catch</span> (BeansException ex) &#123;</span><br><span class=\"line\">\t\tlogger.error(<span class=\"string\">\"Failed to set bean properties on servlet '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>, ex);</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Let subclasses do whatever initialization they like.</span></span><br><span class=\"line\">\tinitServletBean();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\tlogger.debug(<span class=\"string\">\"Servlet '\"</span> + getServletName() + <span class=\"string\">\"' configured successfully\"</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在这个方法中，主要完成了bean属性的配置，并且给子类留下了相应的hook</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Let subclasses do whatever initialization they like.</span></span><br><span class=\"line\">initServletBean();</span><br></pre></td></tr></table></figure>\n<p>这个方法在FrameworkServlet中有具体的实现，现在看下FrameworkServlet中的实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Overridden method of &#123;<span class=\"doctag\">@link</span> HttpServletBean&#125;, invoked after any bean properties</span></span><br><span class=\"line\"><span class=\"comment\">\t * have been set. Creates this servlet's WebApplicationContext.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">initServletBean</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">\t\tgetServletContext().log(<span class=\"string\">\"Initializing Spring FrameworkServlet '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.info(<span class=\"string\">\"FrameworkServlet '\"</span> + getServletName() + <span class=\"string\">\"': initialization started\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">long</span> startTime = System.currentTimeMillis();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class=\"line\">\t\t\tinitFrameworkServlet();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (ServletException ex) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.error(<span class=\"string\">\"Context initialization failed\"</span>, ex);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (RuntimeException ex) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.error(<span class=\"string\">\"Context initialization failed\"</span>, ex);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">long</span> elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.logger.info(<span class=\"string\">\"FrameworkServlet '\"</span> + getServletName() + <span class=\"string\">\"': initialization completed in \"</span> +</span><br><span class=\"line\">\t\t\t\t\telapsedTime + <span class=\"string\">\" ms\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p><code>webApplicationContext</code>在此进行初始化，并且给子类留下了一个hook<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">this</span>.webApplicationContext = initWebApplicationContext();</span><br><span class=\"line\">initFrameworkServlet();</span><br></pre></td></tr></table></figure></p>\n<p><code>initFrameworkServlet</code>在本类中并没有实现，用于子类控制</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* This method will be invoked after any bean properties have been set and</span></span><br><span class=\"line\"><span class=\"comment\">* the WebApplicationContext has been loaded. The default implementation is empty;</span></span><br><span class=\"line\"><span class=\"comment\">* subclasses may override this method to perform any initialization they require.</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@throws</span> ServletException in case of an initialization exception</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">initFrameworkServlet</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在initWebApplicationContext方法中，有一个空实现的方法onRefresh()<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Template method which can be overridden to add servlet-specific refresh work.</span></span><br><span class=\"line\"><span class=\"comment\">* Called after successful context refresh.</span></span><br><span class=\"line\"><span class=\"comment\">* &lt;p&gt;This implementation is empty.</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> context the current WebApplicationContext</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@see</span> #refresh()</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\"><span class=\"comment\">// For subclasses: do nothing by default.</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这个方法也是钩子方法，DispatcherServlet正是实现了这个方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* This implementation calls &#123;<span class=\"doctag\">@link</span> #initStrategies&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\">\t\tinitStrategies(context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * Initialize the strategy objects that this servlet uses.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">initStrategies</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\">\t\t\tinitMultipartResolver(context);</span><br><span class=\"line\">\t\t\tinitLocaleResolver(context);</span><br><span class=\"line\">\t\t\tinitThemeResolver(context);</span><br><span class=\"line\">\t\t\tinitHandlerMappings(context);</span><br><span class=\"line\">\t\t\tinitHandlerAdapters(context);</span><br><span class=\"line\">\t\t\tinitHandlerExceptionResolvers(context);</span><br><span class=\"line\">\t\t\tinitRequestToViewNameTranslator(context);</span><br><span class=\"line\">\t\t\tinitViewResolvers(context);</span><br><span class=\"line\">\t\t\tinitFlashMapManager(context);</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<p>onRefresh方法中又调用了initStrategies方法，在这个方法中进行了大量的初始化工作。</p>\n<p>视图解析器和HandlerMappings都是在这个方法中初始化的。</p>\n<p>重点看一下initHandlerMappings方法，这个方法是初始化url映射的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Initialize the HandlerMappings used by this class.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;If no HandlerMapping beans are defined in the BeanFactory for this namespace,</span></span><br><span class=\"line\"><span class=\"comment\">\t * we default to BeanNameUrlHandlerMapping.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initHandlerMappings</span><span class=\"params\">(ApplicationContext context)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.handlerMappings = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.detectAllHandlerMappings) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Find all HandlerMappings in the ApplicationContext, including ancestor contexts.</span></span><br><span class=\"line\">\t\t\tMap&lt;String, HandlerMapping&gt; matchingBeans =</span><br><span class=\"line\">\t\t\t\t\tBeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!matchingBeans.isEmpty()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.handlerMappings = <span class=\"keyword\">new</span> ArrayList&lt;HandlerMapping&gt;(matchingBeans.values());</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// We keep HandlerMappings in sorted order.</span></span><br><span class=\"line\">\t\t\t\tAnnotationAwareOrderComparator.sort(<span class=\"keyword\">this</span>.handlerMappings);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tHandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping.class);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.handlerMappings = Collections.singletonList(hm);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Ignore, we'll add a default HandlerMapping later.</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Ensure we have at least one HandlerMapping, by registering</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// a default HandlerMapping if no other mappings are found.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.handlerMappings == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>.handlerMappings = getDefaultStrategies(context, HandlerMapping.class);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"No HandlerMappings found in servlet '\"</span> + getServletName() + <span class=\"string\">\"': using default\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>  其根据 this.detectAllHandlerMappings 的值来确定是否扫描祖先定义的handlermappings，如果用户没有配置的话，就会使用默认的HandlerMapping<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/** Detect all HandlerMappings or just expect \"handlerMapping\" bean? */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> detectAllHandlerMappings = <span class=\"keyword\">true</span>;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"service方法\"><a href=\"#service方法\" class=\"headerlink\" title=\"service方法\"></a>service方法</h3><p>servlet接口中另外一个重要的方法叫做<code>service</code></p>\n<p><code>service</code>方法最早是在<code>HttpServlet</code>类中实现的，代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Dispatches client requests to the protected</span></span><br><span class=\"line\"><span class=\"comment\">     * &lt;code&gt;service&lt;/code&gt; method. There's no need to</span></span><br><span class=\"line\"><span class=\"comment\">     * override this method.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> req   the &#123;<span class=\"doctag\">@link</span> HttpServletRequest&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">     *                  contains the request the client made of</span></span><br><span class=\"line\"><span class=\"comment\">     *                  the servlet</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> res   the &#123;<span class=\"doctag\">@link</span> HttpServletResponse&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">     *                  contains the response the servlet returns</span></span><br><span class=\"line\"><span class=\"comment\">     *                  to the client                                </span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@exception</span> IOException   if an input or output error occurs</span></span><br><span class=\"line\"><span class=\"comment\">     *                              while the servlet is handling the</span></span><br><span class=\"line\"><span class=\"comment\">     *                              HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@exception</span> ServletException  if the HTTP request cannot</span></span><br><span class=\"line\"><span class=\"comment\">     *                                  be handled</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@see</span> javax.servlet.Servlet#service</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(ServletRequest req, ServletResponse res)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> ServletException, IOException</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        HttpServletRequest  request;</span><br><span class=\"line\">        HttpServletResponse response;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(req <span class=\"keyword\">instanceof</span> HttpServletRequest &amp;&amp;</span><br><span class=\"line\">                res <span class=\"keyword\">instanceof</span> HttpServletResponse)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"non-HTTP request or response\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        request = (HttpServletRequest) req;</span><br><span class=\"line\">        response = (HttpServletResponse) res;</span><br><span class=\"line\"></span><br><span class=\"line\">        service(request, response);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>它又调用自身的一个<code>service</code>方法:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Receives standard HTTP requests from the public</span></span><br><span class=\"line\"><span class=\"comment\">    * &lt;code&gt;service&lt;/code&gt; method and dispatches</span></span><br><span class=\"line\"><span class=\"comment\">    * them to the &lt;code&gt;do&lt;/code&gt;&lt;i&gt;XXX&lt;/i&gt; methods defined in</span></span><br><span class=\"line\"><span class=\"comment\">    * this class. This method is an HTTP-specific version of the</span></span><br><span class=\"line\"><span class=\"comment\">    * &#123;<span class=\"doctag\">@link</span> javax.servlet.Servlet#service&#125; method. There's no</span></span><br><span class=\"line\"><span class=\"comment\">    * need to override this method.</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> req   the &#123;<span class=\"doctag\">@link</span> HttpServletRequest&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">    *                  contains the request the client made of</span></span><br><span class=\"line\"><span class=\"comment\">    *                  the servlet</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> resp  the &#123;<span class=\"doctag\">@link</span> HttpServletResponse&#125; object that</span></span><br><span class=\"line\"><span class=\"comment\">    *                  contains the response the servlet returns</span></span><br><span class=\"line\"><span class=\"comment\">    *                  to the client                                </span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@exception</span> IOException   if an input or output error occurs</span></span><br><span class=\"line\"><span class=\"comment\">    *                              while the servlet is handling the</span></span><br><span class=\"line\"><span class=\"comment\">    *                              HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@exception</span> ServletException  if the HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">    *                                  cannot be handled</span></span><br><span class=\"line\"><span class=\"comment\">    *</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@see</span> javax.servlet.Servlet#service</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class=\"line\"><span class=\"function\">       <span class=\"keyword\">throws</span> ServletException, IOException</span></span><br><span class=\"line\"><span class=\"function\">   </span>&#123;</span><br><span class=\"line\">       String method = req.getMethod();</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">long</span> lastModified = getLastModified(req);</span><br><span class=\"line\">           <span class=\"keyword\">if</span> (lastModified == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">               <span class=\"comment\">// servlet doesn't support if-modified-since, no reason</span></span><br><span class=\"line\">               <span class=\"comment\">// to go through further expensive logic</span></span><br><span class=\"line\">               doGet(req, resp);</span><br><span class=\"line\">           &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">               <span class=\"keyword\">long</span> ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</span><br><span class=\"line\">               <span class=\"keyword\">if</span> (ifModifiedSince &lt; lastModified) &#123;</span><br><span class=\"line\">                   <span class=\"comment\">// If the servlet mod time is later, call doGet()</span></span><br><span class=\"line\">                   <span class=\"comment\">// Round down to the nearest second for a proper compare</span></span><br><span class=\"line\">                   <span class=\"comment\">// A ifModifiedSince of -1 will always be less</span></span><br><span class=\"line\">                   maybeSetLastModified(resp, lastModified);</span><br><span class=\"line\">                   doGet(req, resp);</span><br><span class=\"line\">               &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">long</span> lastModified = getLastModified(req);</span><br><span class=\"line\">           maybeSetLastModified(resp, lastModified);</span><br><span class=\"line\">           doHead(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class=\"line\">           doPost(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class=\"line\">           doPut(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class=\"line\">           doDelete(req, resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class=\"line\">           doOptions(req,resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class=\"line\">           doTrace(req,resp);</span><br><span class=\"line\"></span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           <span class=\"comment\">//</span></span><br><span class=\"line\">           <span class=\"comment\">// Note that this means NO servlet supports whatever</span></span><br><span class=\"line\">           <span class=\"comment\">// method was requested, anywhere on this server.</span></span><br><span class=\"line\">           <span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">           String errMsg = lStrings.getString(<span class=\"string\">\"http.method_not_implemented\"</span>);</span><br><span class=\"line\">           Object[] errArgs = <span class=\"keyword\">new</span> Object[<span class=\"number\">1</span>];</span><br><span class=\"line\">           errArgs[<span class=\"number\">0</span>] = method;</span><br><span class=\"line\">           errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class=\"line\"></span><br><span class=\"line\">           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure></p>\n<p>这段代码就是根据请求的类型调用相应的处理方法</p>\n<p>这个方法又在<code>FrameWorkServlet</code>中被重写，如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Override the parent class implementation in order to intercept PATCH requests.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (HttpMethod.PATCH.matches(request.getMethod())) &#123;</span><br><span class=\"line\">    processRequest(request, response);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.service(request, response);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>又增加了一个处理PATCH请求的方法，其他的还是调用<code>HttpServlet</code>的实现。</p>\n<p>同时，<code>FrameWorkServlet</code>又将<code>HttpServlet</code>中对应的各种HTTP请求的方法都进行了重写，如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Delegate GET requests to processRequest/doService.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Will also be invoked by HttpServlet's default implementation of &#123;<span class=\"doctag\">@code</span> doHead&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">\t * with a &#123;<span class=\"doctag\">@code</span> NoBodyResponse&#125; that just captures the content length.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #doService</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #doHead</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">doGet</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">\t\t\t<span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tprocessRequest(request, response);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>所有的请求都被委托给了<code>processRequest</code>这个方法，它的实现如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Process this request, publishing an event regardless of the outcome.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;The actual event handling is performed by the abstract</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@link</span> #doService&#125; template method.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">processRequest</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">\t\t\t<span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">long</span> startTime = System.currentTimeMillis();</span><br><span class=\"line\">\t\tThrowable failureCause = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tLocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();</span><br><span class=\"line\">\t\tLocaleContext localeContext = buildLocaleContext(request);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tRequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class=\"line\">\t\tServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\">\t\tasyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), <span class=\"keyword\">new</span> RequestBindingInterceptor());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tinitContextHolders(request, localeContext, requestAttributes);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tdoService(request, response);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (ServletException ex) &#123;</span><br><span class=\"line\">\t\t\tfailureCause = ex;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">\t\t\tfailureCause = ex;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">\t\t\tfailureCause = ex;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NestedServletException(<span class=\"string\">\"Request processing failed\"</span>, ex);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\tresetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (requestAttributes != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\trequestAttributes.requestCompleted();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (failureCause != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">this</span>.logger.debug(<span class=\"string\">\"Could not complete request\"</span>, failureCause);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogger.debug(<span class=\"string\">\"Leaving response open for concurrent processing\"</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">this</span>.logger.debug(<span class=\"string\">\"Successfully completed request\"</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tpublishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码的异常处理很值得借鉴，上述代码中<code>doService(request, response)</code>是核心。</p>\n<p>它是<code>FrameWorkServlet</code>中定义的一个接口，它在<code>DispatcherServlet</code>中被实现。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Subclasses must implement this method to do the work of request handling,</span></span><br><span class=\"line\"><span class=\"comment\"> * receiving a centralized callback for GET, POST, PUT and DELETE.</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;The contract is essentially the same as that for the commonly overridden</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;<span class=\"doctag\">@code</span> doGet&#125; or &#123;<span class=\"doctag\">@code</span> doPost&#125; methods of HttpServlet.</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;p&gt;This class intercepts calls to ensure that exception handling and</span></span><br><span class=\"line\"><span class=\"comment\"> * event publication takes place.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> response current HTTP response</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> javax.servlet.http.HttpServlet#doGet</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> javax.servlet.http.HttpServlet#doPost</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">doService</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure></p>\n<p><code>DispatcherServlet</code>中的<code>doService</code>接口代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class=\"doctag\">@link</span> #doDispatch&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t * for the actual dispatching.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doService</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\tString resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? <span class=\"string\">\" resumed\"</span> : <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">\t\t\tlogger.debug(<span class=\"string\">\"DispatcherServlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span> + resumed +</span><br><span class=\"line\">\t\t\t\t\t<span class=\"string\">\" processing \"</span> + request.getMethod() + <span class=\"string\">\" request for [\"</span> + getRequestUri(request) + <span class=\"string\">\"]\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// to be able to restore the original attributes after the include.</span></span><br><span class=\"line\">\t\tMap&lt;String, Object&gt; attributesSnapshot = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class=\"line\">\t\t\tattributesSnapshot = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">\t\t\tEnumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class=\"line\">\t\t\t\tString attrName = (String) attrNames.nextElement();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.cleanupAfterInclude || attrName.startsWith(<span class=\"string\">\"org.springframework.web.servlet\"</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\tattributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Make framework objects available to handlers and view objects.</span></span><br><span class=\"line\">\t\trequest.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class=\"line\">\t\trequest.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class=\"keyword\">this</span>.localeResolver);</span><br><span class=\"line\">\t\trequest.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class=\"keyword\">this</span>.themeResolver);</span><br><span class=\"line\">\t\trequest.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tFlashMap inputFlashMap = <span class=\"keyword\">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (inputFlashMap != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\trequest.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\trequest.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class=\"keyword\">new</span> FlashMap());</span><br><span class=\"line\">\t\trequest.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class=\"keyword\">this</span>.flashMapManager);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tdoDispatch(request, response);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (attributesSnapshot != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\trestoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>每次请求过来都会将系统的一些属性塞到request的attribute中，以便后面的handlers和view能够访问到。</p>\n<p>其中比较重要的是 <code>doDispatch(request, response)</code>，正是这个方法使得请求被真正的转发。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Process the actual dispatching to the handler.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;The handler will be obtained by applying the servlet's HandlerMappings in order.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters</span></span><br><span class=\"line\"><span class=\"comment\">\t * to find the first that supports the handler class.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers</span></span><br><span class=\"line\"><span class=\"comment\">\t * themselves to decide which methods are acceptable.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> response current HTTP response</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doDispatch</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\tHttpServletRequest processedRequest = request;</span><br><span class=\"line\">\t\tHandlerExecutionChain mappedHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">boolean</span> multipartRequestParsed = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tWebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tModelAndView mv = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t\t\tException dispatchException = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tprocessedRequest = checkMultipart(request);</span><br><span class=\"line\">\t\t\t\tmultipartRequestParsed = (processedRequest != request);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Determine handler for the current request.</span></span><br><span class=\"line\">\t\t\t\tmappedHandler = getHandler(processedRequest);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (mappedHandler == <span class=\"keyword\">null</span> || mappedHandler.getHandler() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\tnoHandlerFound(processedRequest, response);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Determine handler adapter for the current request.</span></span><br><span class=\"line\">\t\t\t\tHandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Process last-modified header, if supported by the handler.</span></span><br><span class=\"line\">\t\t\t\tString method = request.getMethod();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">boolean</span> isGet = <span class=\"string\">\"GET\"</span>.equals(method);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (isGet || <span class=\"string\">\"HEAD\"</span>.equals(method)) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogger.debug(<span class=\"string\">\"Last-Modified value for [\"</span> + getRequestUri(request) + <span class=\"string\">\"] is: \"</span> + lastModified);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Actually invoke the handler.</span></span><br><span class=\"line\">\t\t\t\tmv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tapplyDefaultViewName(processedRequest, mv);</span><br><span class=\"line\">\t\t\t\tmappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\t\tdispatchException = ex;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tprocessDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\ttriggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Error err) &#123;</span><br><span class=\"line\">\t\t\ttriggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Instead of postHandle and afterCompletion</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (mappedHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\tmappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Clean up any resources used by a multipart request.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (multipartRequestParsed) &#123;</span><br><span class=\"line\">\t\t\t\t\tcleanupMultipart(processedRequest);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>handler 获取的顺序是从DispatcherServlet的HandlerMapping中按顺序取出的</p>\n<p>Handler对应的HandlerAdapter会从安装的HandlerAdapter找，将返回第一个合适的Adapter</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HandlerExecutionChain mappedHandler = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Determine handler for the current request.</span></span><br><span class=\"line\">mappedHandler = getHandler(processedRequest);</span><br><span class=\"line\">            ...</span><br><span class=\"line\"><span class=\"comment\">// Determine handler adapter for the current request.</span></span><br><span class=\"line\">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class=\"line\">            ...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Actually invoke the handler.</span></span><br><span class=\"line\">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class=\"line\"></span><br><span class=\"line\">mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class=\"line\"></span><br><span class=\"line\">processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br></pre></td></tr></table></figure>\n<p>在applyPreHandle中也是检查拦截器的操作，并根据拦截器返回的布尔类型，判断是否进一步处理</p>\n<p>其中在applyPostHandle中又检查是否有各种拦截器,调用拦截器的postHandle方法</p>\n<p>处理完毕后，调用processDispatchResult方法将处理后的请求和mv进行分发</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//HandlerExecutionChain.java</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Apply preHandle methods of registered interceptors.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> &#123;<span class=\"doctag\">@code</span> true&#125; if the execution chain should proceed with the</span></span><br><span class=\"line\"><span class=\"comment\">\t * next interceptor or the handler itself. Else, DispatcherServlet assumes</span></span><br><span class=\"line\"><span class=\"comment\">\t * that this interceptor has already dealt with the response itself.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">applyPreHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\tHandlerInterceptor[] interceptors = getInterceptors();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; interceptors.length; i++) &#123;</span><br><span class=\"line\">\t\t\t\tHandlerInterceptor interceptor = interceptors[i];</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!interceptor.preHandle(request, response, <span class=\"keyword\">this</span>.handler)) &#123;</span><br><span class=\"line\">\t\t\t\t\ttriggerAfterCompletion(request, response, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">this</span>.interceptorIndex = i;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* Apply postHandle methods of registered interceptors.</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">applyPostHandle</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response, ModelAndView mv)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\tHandlerInterceptor[] interceptors = getInterceptors();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = interceptors.length - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">\t\t\tHandlerInterceptor interceptor = interceptors[i];</span><br><span class=\"line\">\t\t\tinterceptor.postHandle(request, response, <span class=\"keyword\">this</span>.handler, mv);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>handler处理后的结果是通过processDispatchResult传出去的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//DispatcherServlet.java</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Handle the result of handler selection and handler invocation, which is</span></span><br><span class=\"line\"><span class=\"comment\">\t * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processDispatchResult</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tHandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">boolean</span> errorView = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (exception <span class=\"keyword\">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"ModelAndViewDefiningException encountered\"</span>, exception);</span><br><span class=\"line\">\t\t\t\tmv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tObject handler = (mappedHandler != <span class=\"keyword\">null</span> ? mappedHandler.getHandler() : <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t\t\tmv = processHandlerException(request, response, handler, exception);</span><br><span class=\"line\">\t\t\t\terrorView = (mv != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Did the handler return a view to render?</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (mv != <span class=\"keyword\">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class=\"line\">\t\t\trender(mv, request, response);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (errorView) &#123;</span><br><span class=\"line\">\t\t\t\tWebUtils.clearErrorRequestAttributes(request);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"Null ModelAndView returned to DispatcherServlet with name '\"</span> + getServletName() +</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"': assuming HandlerAdapter completed request handling\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Concurrent handling started during a forward</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (mappedHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\tmappedHandler.triggerAfterCompletion(request, response, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>去各种判断，核心的方法就在<code>render(mv, request, response)</code>;</p>\n<p>它负责渲染返回的<code>ModelAndView</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//DispatcherServlet.java</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* Render the given ModelAndView.</span></span><br><span class=\"line\"><span class=\"comment\">\t* &lt;p&gt;This is the last stage in handling a request. It may involve resolving the view by name.</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> mv the ModelAndView to render</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> request current HTTP servlet request</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> response current HTTP servlet response</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@throws</span> ServletException if view is missing or cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@throws</span> Exception if there's a problem rendering the view</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">render</span><span class=\"params\">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Determine locale for request and apply it to the response.</span></span><br><span class=\"line\">\t\tLocale locale = <span class=\"keyword\">this</span>.localeResolver.resolveLocale(request);</span><br><span class=\"line\">\t\tresponse.setLocale(locale);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tView view;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (mv.isReference()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// We need to resolve the view name.</span></span><br><span class=\"line\">\t\t\tview = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (view == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"Could not resolve view with name '\"</span> + mv.getViewName() +</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"' in servlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// No need to lookup: the ModelAndView object contains the actual View object.</span></span><br><span class=\"line\">\t\t\tview = mv.getView();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (view == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ServletException(<span class=\"string\">\"ModelAndView [\"</span> + mv + <span class=\"string\">\"] neither contains a view name nor a \"</span> +</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"string\">\"View object in servlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Delegate to the View object for rendering.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\tlogger.debug(<span class=\"string\">\"Rendering view [\"</span> + view + <span class=\"string\">\"] in DispatcherServlet with name '\"</span> + getServletName() + <span class=\"string\">\"'\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tview.render(mv.getModelInternal(), request, response);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class=\"line\">\t\t\t\tlogger.debug(<span class=\"string\">\"Error rendering view [\"</span> + view + <span class=\"string\">\"] in DispatcherServlet with name '\"</span> +</span><br><span class=\"line\">\t\t\t\t\t\tgetServletName() + <span class=\"string\">\"'\"</span>, ex);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>这个函数解析mv对象，如果是一个引用名就查找对应的view，最终返回一个View对象，</p>\n<p>然后将渲染的工作委托给这个view对象，<code>view.render(mv.getModelInternal(), request, response);</code></p>\n<p>其中<code>resolveViewName</code>方法遍历 <code>DispatcherServlet</code>中注册的<code>viewResolver</code>，返回第一个非空的结果</p>\n<p>查找视图名称的方法如下:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** List of ViewResolvers used by this servlet */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t* Resolve the given view name into a View object (to be rendered).</span></span><br><span class=\"line\"><span class=\"comment\">\t* &lt;p&gt;The default implementations asks all ViewResolvers of this dispatcher.</span></span><br><span class=\"line\"><span class=\"comment\">\t* Can be overridden for custom resolution strategies, potentially based on</span></span><br><span class=\"line\"><span class=\"comment\">\t* specific model attributes or request parameters.</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> viewName the name of the view to resolve</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> model the model to be passed to the view</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> locale the current locale</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@param</span> request current HTTP servlet request</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@return</span> the View object, or &#123;<span class=\"doctag\">@code</span> null&#125; if none found</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@throws</span> Exception if the view cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t* (typically in case of problems creating an actual View object)</span></span><br><span class=\"line\"><span class=\"comment\">\t* <span class=\"doctag\">@see</span> ViewResolver#resolveViewName</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> View <span class=\"title\">resolveViewName</span><span class=\"params\">(String viewName, Map&lt;String, Object&gt; model, Locale locale,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\tHttpServletRequest request)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (ViewResolver viewResolver : <span class=\"keyword\">this</span>.viewResolvers) &#123;</span><br><span class=\"line\">\t\t\t\tView view = viewResolver.resolveViewName(viewName, locale);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (view != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> view;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>最终视图的渲染是View中定义的<code>render</code>方法进行的，它是一个抽象的接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Render the view given the specified model.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;The first step will be preparing the request: In the JSP case,</span></span><br><span class=\"line\"><span class=\"comment\">\t * this would mean setting model objects as request attributes.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The second step will be the actual rendering of the view,</span></span><br><span class=\"line\"><span class=\"comment\">\t * for example including the JSP via a RequestDispatcher.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> model Map with name Strings as keys and corresponding model</span></span><br><span class=\"line\"><span class=\"comment\">\t * objects as values (Map can also be &#123;<span class=\"doctag\">@code</span> null&#125; in case of empty model)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> request current HTTP request</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> response HTTP response we are building</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> Exception if rendering failed</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">render</span><span class=\"params\">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>\n"},{"title":"spring-resource源码剖析","toc":true,"abbrlink":27459,"date":"2016-11-20T12:12:14.000Z","_content":"\n\n# Spring Resource\n\n## Why not Java URL类\n\n原因： 对底层资源的支持不足。\n\n1. there is no standardized URL implementation that may be used to access a resource that needs to be obtained from the classpath,or relative to a ServletContext.\n\n2. 不自定义URL handler的原因：\n\n  a. 过于复杂\n  b. lack some desirable functionality（如对URL所指资源是否存在的判断）\n\n\n## Resource 接口\n\n```java\n\npublic interface InputStreamSource {\n\n\t/**\n\t * Return an {@link InputStream}.\n\t * <p>It is expected that each call creates a <i>fresh</i> stream.\n\t * <p>This requirement is particularly important when you consider an API such\n\t * as JavaMail, which needs to be able to read the stream multiple times when\n\t * creating mail attachments. For such a use case, it is <i>required</i>\n\t * that each {@code getInputStream()} call returns a fresh stream.\n\t * @return the input stream for the underlying resource (must not be {@code null})\n\t * @throws IOException if the stream could not be opened\n\t * @see org.springframework.mail.javamail.MimeMessageHelper#addAttachment(String, InputStreamSource)\n\t */\n\tInputStream getInputStream() throws IOException;\n\n}\n\n\n\npublic interface Resource extends InputStreamSource {\n\n\t/**\n\t * Return whether this resource actually exists in physical form.\n\t * <p>This method performs a definitive existence check, whereas the\n\t * existence of a {@code Resource} handle only guarantees a\n\t * valid descriptor handle.\n\t */\n\tboolean exists();\n\n\t/**\n\t * Return whether the contents of this resource can be read,\n\t * e.g. via {@link #getInputStream()} or {@link #getFile()}.\n\t * <p>Will be {@code true} for typical resource descriptors;\n\t * note that actual content reading may still fail when attempted.\n\t * However, a value of {@code false} is a definitive indication\n\t * that the resource content cannot be read.\n\t * @see #getInputStream()\n\t */\n\tboolean isReadable();\n\n\t/**\n\t * Return whether this resource represents a handle with an open\n\t * stream. If true, the InputStream cannot be read multiple times,\n\t * and must be read and closed to avoid resource leaks.\n\t * <p>Will be {@code false} for typical resource descriptors.\n\t */\n\tboolean isOpen();\n\n\t/**\n\t * Return a URL handle for this resource.\n\t * @throws IOException if the resource cannot be resolved as URL,\n\t * i.e. if the resource is not available as descriptor\n\t */\n\tURL getURL() throws IOException;\n\n\t/**\n\t * Return a URI handle for this resource.\n\t * @throws IOException if the resource cannot be resolved as URI,\n\t * i.e. if the resource is not available as descriptor\n\t */\n\tURI getURI() throws IOException;\n\n\t/**\n\t * Return a File handle for this resource.\n\t * @throws IOException if the resource cannot be resolved as absolute\n\t * file path, i.e. if the resource is not available in a file system\n\t */\n\tFile getFile() throws IOException;\n\n\t/**\n\t * Determine the content length for this resource.\n\t * @throws IOException if the resource cannot be resolved\n\t * (in the file system or as some other known physical resource type)\n\t */\n\tlong contentLength() throws IOException;\n\n\t/**\n\t * Determine the last-modified timestamp for this resource.\n\t * @throws IOException if the resource cannot be resolved\n\t * (in the file system or as some other known physical resource type)\n\t */\n\tlong lastModified() throws IOException;\n\n\t/**\n\t * Create a resource relative to this resource.\n\t * @param relativePath the relative path (relative to this resource)\n\t * @return the resource handle for the relative resource\n\t * @throws IOException if the relative resource cannot be determined\n\t */\n\tResource createRelative(String relativePath) throws IOException;\n\n\t/**\n\t * Determine a filename for this resource, i.e. typically the last\n\t * part of the path: for example, \"myfile.txt\".\n\t * <p>Returns {@code null} if this type of resource does not\n\t * have a filename.\n\t */\n\tString getFilename();\n\n\t/**\n\t * Return a description for this resource,\n\t * to be used for error output when working with the resource.\n\t * <p>Implementations are also encouraged to return this value\n\t * from their {@code toString} method.\n\t * @see Object#toString()\n\t */\n\tString getDescription();\n\n}\n```\n### 继承体系\n\n{%  asset_img   resource.jpg  %}\n\n\n\n\n## ResourceLoader\n\n```java\npublic interface ResourceLoader {\n\n\t/** Pseudo URL prefix for loading from the class path: \"classpath:\" */\n\tString CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;\n\n\n\t/**\n\t * Return a Resource handle for the specified resource.\n\t * The handle should always be a reusable resource descriptor,\n\t * allowing for multiple {@link Resource#getInputStream()} calls.\n\t * <p><ul>\n\t * <li>Must support fully qualified URLs, e.g. \"file:C:/test.dat\".\n\t * <li>Must support classpath pseudo-URLs, e.g. \"classpath:test.dat\".\n\t * <li>Should support relative file paths, e.g. \"WEB-INF/test.dat\".\n\t * (This will be implementation-specific, typically provided by an\n\t * ApplicationContext implementation.)\n\t * </ul>\n\t * <p>Note that a Resource handle does not imply an existing resource;\n\t * you need to invoke {@link Resource#exists} to check for existence.\n\t * @param location the resource location\n\t * @return a corresponding Resource handle\n\t * @see #CLASSPATH_URL_PREFIX\n\t * @see org.springframework.core.io.Resource#exists\n\t * @see org.springframework.core.io.Resource#getInputStream\n\t */\n\tResource getResource(String location);\n\n\t/**\n\t * Expose the ClassLoader used by this ResourceLoader.\n\t * <p>Clients which need to access the ClassLoader directly can do so\n\t * in a uniform manner with the ResourceLoader, rather than relying\n\t * on the thread context ClassLoader.\n\t * @return the ClassLoader (only {@code null} if even the system\n\t * ClassLoader isn't accessible)\n\t * @see org.springframework.util.ClassUtils#getDefaultClassLoader()\n\t */\n\tClassLoader getClassLoader();\n\n}\n\n```\n\nResourceLoader　负责加载Resource, 所有的application context都实现了这个接口。\n\n```java\nResource template = ctx.getResource(\"some/resource/path/myTemplate.txt\");\n```\n\n如果上述的ctx的类型是 ClassPathXmlApplicationContext，那么返回的Resource的具体类型就是\n\nClassPathResource； 如果ctx的类型是FileSystemXmlApplicationContext, 返回的类型就变成了\n\nFileSystemResource。\n\n### 指定返回的Resource类型\n```java\nResource template = ctx.getResource(\"classpath:some/resource/path/myTemplate.txt\");\n```\n\n通过显式的指定classpath前缀，返回的Resource的实际类型就是 ClassPathResource\n\n对应的关系见表格：\n\n|Prefix|Example|Explanation|\n|-|-|-|\n|classpath:|classpath:com/myapp/config.xml|Loaded from the classpath|\n|file: | file:///data/config.xml | Loaded as a URL, from the system|\n|http: | http://myserver/logo.png | Loaded as a URL |\n|（none） | /data/config.xml | Depends on the underlying ApplicationContext |\n\n#### classpath*\n\nclasspath*:conf/appContext.xml\n\n这个特殊的前缀会使spring在所有的ClassPath中查找和指定的名字相同的资源，他们会合并形成最终的\n\n上下文。\n\n>This special prefix specifies that all classpath resources that match the given name must be obtained\n(internally, this essentially happens via a ClassLoader.getResources(…) call), and then merged\nto form the final application context definition.\n\n### ResourceLoaderAware\n\n```java\npublic interface ResourceLoaderAware extends Aware {\n\n\t/**\n\t * Set the ResourceLoader that this object runs in.\n\t * <p>This might be a ResourcePatternResolver, which can be checked\n\t * through {@code instanceof ResourcePatternResolver}. See also the\n\t * {@code ResourcePatternUtils.getResourcePatternResolver} method.\n\t * <p>Invoked after population of normal bean properties but before an init callback\n\t * like InitializingBean's {@code afterPropertiesSet} or a custom init-method.\n\t * Invoked before ApplicationContextAware's {@code setApplicationContext}.\n\t * @param resourceLoader ResourceLoader object to be used by this object\n\t * @see org.springframework.core.io.support.ResourcePatternResolver\n\t * @see org.springframework.core.io.support.ResourcePatternUtils#getResourcePatternResolver\n\t */\n\tvoid setResourceLoader(ResourceLoader resourceLoader);\n\n}\n```\n\n实现这个接口的类，可以获得所在容器的ResourceLoader实例，一般来说就是相应的Application Context。也可以当做\n\nApplicationContextAware的替代。\n\n>   Interface to be implemented by any object that wishes to be notified of\n  the <b>ResourceLoader</b> (typically the ApplicationContext) that it runs in.\n  This is an alternative to a full ApplicationContext dependency via the\n  ApplicationContextAware interface.\n\n\n除了实现上述接口，还可以使用基于类型的注入，将ResourceLoader注入到需要的地方。\n","source":"_posts/spring-resource.md","raw":"---\ntitle: spring-resource源码剖析\ntags: resource\ncategory: spring\ntoc: true\nabbrlink: 27459\ndate: 2016-11-20 20:12:14\n---\n\n\n# Spring Resource\n\n## Why not Java URL类\n\n原因： 对底层资源的支持不足。\n\n1. there is no standardized URL implementation that may be used to access a resource that needs to be obtained from the classpath,or relative to a ServletContext.\n\n2. 不自定义URL handler的原因：\n\n  a. 过于复杂\n  b. lack some desirable functionality（如对URL所指资源是否存在的判断）\n\n\n## Resource 接口\n\n```java\n\npublic interface InputStreamSource {\n\n\t/**\n\t * Return an {@link InputStream}.\n\t * <p>It is expected that each call creates a <i>fresh</i> stream.\n\t * <p>This requirement is particularly important when you consider an API such\n\t * as JavaMail, which needs to be able to read the stream multiple times when\n\t * creating mail attachments. For such a use case, it is <i>required</i>\n\t * that each {@code getInputStream()} call returns a fresh stream.\n\t * @return the input stream for the underlying resource (must not be {@code null})\n\t * @throws IOException if the stream could not be opened\n\t * @see org.springframework.mail.javamail.MimeMessageHelper#addAttachment(String, InputStreamSource)\n\t */\n\tInputStream getInputStream() throws IOException;\n\n}\n\n\n\npublic interface Resource extends InputStreamSource {\n\n\t/**\n\t * Return whether this resource actually exists in physical form.\n\t * <p>This method performs a definitive existence check, whereas the\n\t * existence of a {@code Resource} handle only guarantees a\n\t * valid descriptor handle.\n\t */\n\tboolean exists();\n\n\t/**\n\t * Return whether the contents of this resource can be read,\n\t * e.g. via {@link #getInputStream()} or {@link #getFile()}.\n\t * <p>Will be {@code true} for typical resource descriptors;\n\t * note that actual content reading may still fail when attempted.\n\t * However, a value of {@code false} is a definitive indication\n\t * that the resource content cannot be read.\n\t * @see #getInputStream()\n\t */\n\tboolean isReadable();\n\n\t/**\n\t * Return whether this resource represents a handle with an open\n\t * stream. If true, the InputStream cannot be read multiple times,\n\t * and must be read and closed to avoid resource leaks.\n\t * <p>Will be {@code false} for typical resource descriptors.\n\t */\n\tboolean isOpen();\n\n\t/**\n\t * Return a URL handle for this resource.\n\t * @throws IOException if the resource cannot be resolved as URL,\n\t * i.e. if the resource is not available as descriptor\n\t */\n\tURL getURL() throws IOException;\n\n\t/**\n\t * Return a URI handle for this resource.\n\t * @throws IOException if the resource cannot be resolved as URI,\n\t * i.e. if the resource is not available as descriptor\n\t */\n\tURI getURI() throws IOException;\n\n\t/**\n\t * Return a File handle for this resource.\n\t * @throws IOException if the resource cannot be resolved as absolute\n\t * file path, i.e. if the resource is not available in a file system\n\t */\n\tFile getFile() throws IOException;\n\n\t/**\n\t * Determine the content length for this resource.\n\t * @throws IOException if the resource cannot be resolved\n\t * (in the file system or as some other known physical resource type)\n\t */\n\tlong contentLength() throws IOException;\n\n\t/**\n\t * Determine the last-modified timestamp for this resource.\n\t * @throws IOException if the resource cannot be resolved\n\t * (in the file system or as some other known physical resource type)\n\t */\n\tlong lastModified() throws IOException;\n\n\t/**\n\t * Create a resource relative to this resource.\n\t * @param relativePath the relative path (relative to this resource)\n\t * @return the resource handle for the relative resource\n\t * @throws IOException if the relative resource cannot be determined\n\t */\n\tResource createRelative(String relativePath) throws IOException;\n\n\t/**\n\t * Determine a filename for this resource, i.e. typically the last\n\t * part of the path: for example, \"myfile.txt\".\n\t * <p>Returns {@code null} if this type of resource does not\n\t * have a filename.\n\t */\n\tString getFilename();\n\n\t/**\n\t * Return a description for this resource,\n\t * to be used for error output when working with the resource.\n\t * <p>Implementations are also encouraged to return this value\n\t * from their {@code toString} method.\n\t * @see Object#toString()\n\t */\n\tString getDescription();\n\n}\n```\n### 继承体系\n\n{%  asset_img   resource.jpg  %}\n\n\n\n\n## ResourceLoader\n\n```java\npublic interface ResourceLoader {\n\n\t/** Pseudo URL prefix for loading from the class path: \"classpath:\" */\n\tString CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;\n\n\n\t/**\n\t * Return a Resource handle for the specified resource.\n\t * The handle should always be a reusable resource descriptor,\n\t * allowing for multiple {@link Resource#getInputStream()} calls.\n\t * <p><ul>\n\t * <li>Must support fully qualified URLs, e.g. \"file:C:/test.dat\".\n\t * <li>Must support classpath pseudo-URLs, e.g. \"classpath:test.dat\".\n\t * <li>Should support relative file paths, e.g. \"WEB-INF/test.dat\".\n\t * (This will be implementation-specific, typically provided by an\n\t * ApplicationContext implementation.)\n\t * </ul>\n\t * <p>Note that a Resource handle does not imply an existing resource;\n\t * you need to invoke {@link Resource#exists} to check for existence.\n\t * @param location the resource location\n\t * @return a corresponding Resource handle\n\t * @see #CLASSPATH_URL_PREFIX\n\t * @see org.springframework.core.io.Resource#exists\n\t * @see org.springframework.core.io.Resource#getInputStream\n\t */\n\tResource getResource(String location);\n\n\t/**\n\t * Expose the ClassLoader used by this ResourceLoader.\n\t * <p>Clients which need to access the ClassLoader directly can do so\n\t * in a uniform manner with the ResourceLoader, rather than relying\n\t * on the thread context ClassLoader.\n\t * @return the ClassLoader (only {@code null} if even the system\n\t * ClassLoader isn't accessible)\n\t * @see org.springframework.util.ClassUtils#getDefaultClassLoader()\n\t */\n\tClassLoader getClassLoader();\n\n}\n\n```\n\nResourceLoader　负责加载Resource, 所有的application context都实现了这个接口。\n\n```java\nResource template = ctx.getResource(\"some/resource/path/myTemplate.txt\");\n```\n\n如果上述的ctx的类型是 ClassPathXmlApplicationContext，那么返回的Resource的具体类型就是\n\nClassPathResource； 如果ctx的类型是FileSystemXmlApplicationContext, 返回的类型就变成了\n\nFileSystemResource。\n\n### 指定返回的Resource类型\n```java\nResource template = ctx.getResource(\"classpath:some/resource/path/myTemplate.txt\");\n```\n\n通过显式的指定classpath前缀，返回的Resource的实际类型就是 ClassPathResource\n\n对应的关系见表格：\n\n|Prefix|Example|Explanation|\n|-|-|-|\n|classpath:|classpath:com/myapp/config.xml|Loaded from the classpath|\n|file: | file:///data/config.xml | Loaded as a URL, from the system|\n|http: | http://myserver/logo.png | Loaded as a URL |\n|（none） | /data/config.xml | Depends on the underlying ApplicationContext |\n\n#### classpath*\n\nclasspath*:conf/appContext.xml\n\n这个特殊的前缀会使spring在所有的ClassPath中查找和指定的名字相同的资源，他们会合并形成最终的\n\n上下文。\n\n>This special prefix specifies that all classpath resources that match the given name must be obtained\n(internally, this essentially happens via a ClassLoader.getResources(…) call), and then merged\nto form the final application context definition.\n\n### ResourceLoaderAware\n\n```java\npublic interface ResourceLoaderAware extends Aware {\n\n\t/**\n\t * Set the ResourceLoader that this object runs in.\n\t * <p>This might be a ResourcePatternResolver, which can be checked\n\t * through {@code instanceof ResourcePatternResolver}. See also the\n\t * {@code ResourcePatternUtils.getResourcePatternResolver} method.\n\t * <p>Invoked after population of normal bean properties but before an init callback\n\t * like InitializingBean's {@code afterPropertiesSet} or a custom init-method.\n\t * Invoked before ApplicationContextAware's {@code setApplicationContext}.\n\t * @param resourceLoader ResourceLoader object to be used by this object\n\t * @see org.springframework.core.io.support.ResourcePatternResolver\n\t * @see org.springframework.core.io.support.ResourcePatternUtils#getResourcePatternResolver\n\t */\n\tvoid setResourceLoader(ResourceLoader resourceLoader);\n\n}\n```\n\n实现这个接口的类，可以获得所在容器的ResourceLoader实例，一般来说就是相应的Application Context。也可以当做\n\nApplicationContextAware的替代。\n\n>   Interface to be implemented by any object that wishes to be notified of\n  the <b>ResourceLoader</b> (typically the ApplicationContext) that it runs in.\n  This is an alternative to a full ApplicationContext dependency via the\n  ApplicationContextAware interface.\n\n\n除了实现上述接口，还可以使用基于类型的注入，将ResourceLoader注入到需要的地方。\n","slug":"spring-resource","published":1,"updated":"2017-04-16T12:03:23.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdao009mjh4kjrj8c043","content":"<h1 id=\"Spring-Resource\"><a href=\"#Spring-Resource\" class=\"headerlink\" title=\"Spring Resource\"></a>Spring Resource</h1><h2 id=\"Why-not-Java-URL类\"><a href=\"#Why-not-Java-URL类\" class=\"headerlink\" title=\"Why not Java URL类\"></a>Why not Java URL类</h2><p>原因： 对底层资源的支持不足。</p>\n<ol>\n<li><p>there is no standardized URL implementation that may be used to access a resource that needs to be obtained from the classpath,or relative to a ServletContext.</p>\n</li>\n<li><p>不自定义URL handler的原因：</p>\n<p>a. 过于复杂<br>b. lack some desirable functionality（如对URL所指资源是否存在的判断）</p>\n</li>\n</ol>\n<h2 id=\"Resource-接口\"><a href=\"#Resource-接口\" class=\"headerlink\" title=\"Resource 接口\"></a>Resource 接口</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">InputStreamSource</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return an &#123;<span class=\"doctag\">@link</span> InputStream&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;It is expected that each call creates a &lt;i&gt;fresh&lt;/i&gt; stream.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;This requirement is particularly important when you consider an API such</span></span><br><span class=\"line\"><span class=\"comment\">\t * as JavaMail, which needs to be able to read the stream multiple times when</span></span><br><span class=\"line\"><span class=\"comment\">\t * creating mail attachments. For such a use case, it is &lt;i&gt;required&lt;/i&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * that each &#123;<span class=\"doctag\">@code</span> getInputStream()&#125; call returns a fresh stream.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the input stream for the underlying resource (must not be &#123;<span class=\"doctag\">@code</span> null&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the stream could not be opened</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.mail.javamail.MimeMessageHelper#addAttachment(String, InputStreamSource)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">InputStream <span class=\"title\">getInputStream</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Resource</span> <span class=\"keyword\">extends</span> <span class=\"title\">InputStreamSource</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return whether this resource actually exists in physical form.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;This method performs a definitive existence check, whereas the</span></span><br><span class=\"line\"><span class=\"comment\">\t * existence of a &#123;<span class=\"doctag\">@code</span> Resource&#125; handle only guarantees a</span></span><br><span class=\"line\"><span class=\"comment\">\t * valid descriptor handle.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">exists</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return whether the contents of this resource can be read,</span></span><br><span class=\"line\"><span class=\"comment\">\t * e.g. via &#123;<span class=\"doctag\">@link</span> #getInputStream()&#125; or &#123;<span class=\"doctag\">@link</span> #getFile()&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Will be &#123;<span class=\"doctag\">@code</span> true&#125; for typical resource descriptors;</span></span><br><span class=\"line\"><span class=\"comment\">\t * note that actual content reading may still fail when attempted.</span></span><br><span class=\"line\"><span class=\"comment\">\t * However, a value of &#123;<span class=\"doctag\">@code</span> false&#125; is a definitive indication</span></span><br><span class=\"line\"><span class=\"comment\">\t * that the resource content cannot be read.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #getInputStream()</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isReadable</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return whether this resource represents a handle with an open</span></span><br><span class=\"line\"><span class=\"comment\">\t * stream. If true, the InputStream cannot be read multiple times,</span></span><br><span class=\"line\"><span class=\"comment\">\t * and must be read and closed to avoid resource leaks.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Will be &#123;<span class=\"doctag\">@code</span> false&#125; for typical resource descriptors.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isOpen</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a URL handle for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved as URL,</span></span><br><span class=\"line\"><span class=\"comment\">\t * i.e. if the resource is not available as descriptor</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">URL <span class=\"title\">getURL</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a URI handle for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved as URI,</span></span><br><span class=\"line\"><span class=\"comment\">\t * i.e. if the resource is not available as descriptor</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">URI <span class=\"title\">getURI</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a File handle for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved as absolute</span></span><br><span class=\"line\"><span class=\"comment\">\t * file path, i.e. if the resource is not available in a file system</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">File <span class=\"title\">getFile</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Determine the content length for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t * (in the file system or as some other known physical resource type)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">contentLength</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Determine the last-modified timestamp for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t * (in the file system or as some other known physical resource type)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">lastModified</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Create a resource relative to this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> relativePath the relative path (relative to this resource)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the resource handle for the relative resource</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the relative resource cannot be determined</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">Resource <span class=\"title\">createRelative</span><span class=\"params\">(String relativePath)</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Determine a filename for this resource, i.e. typically the last</span></span><br><span class=\"line\"><span class=\"comment\">\t * part of the path: for example, \"myfile.txt\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Returns &#123;<span class=\"doctag\">@code</span> null&#125; if this type of resource does not</span></span><br><span class=\"line\"><span class=\"comment\">\t * have a filename.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">String <span class=\"title\">getFilename</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a description for this resource,</span></span><br><span class=\"line\"><span class=\"comment\">\t * to be used for error output when working with the resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Implementations are also encouraged to return this value</span></span><br><span class=\"line\"><span class=\"comment\">\t * from their &#123;<span class=\"doctag\">@code</span> toString&#125; method.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> Object#toString()</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">String <span class=\"title\">getDescription</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"继承体系\"><a href=\"#继承体系\" class=\"headerlink\" title=\"继承体系\"></a>继承体系</h3><img src=\"/2016/11/20/spring-resource/resource.jpg\">\n<h2 id=\"ResourceLoader\"><a href=\"#ResourceLoader\" class=\"headerlink\" title=\"ResourceLoader\"></a>ResourceLoader</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ResourceLoader</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/** Pseudo URL prefix for loading from the class path: \"classpath:\" */</span></span><br><span class=\"line\">\tString CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a Resource handle for the specified resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The handle should always be a reusable resource descriptor,</span></span><br><span class=\"line\"><span class=\"comment\">\t * allowing for multiple &#123;<span class=\"doctag\">@link</span> Resource#getInputStream()&#125; calls.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;&lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;Must support fully qualified URLs, e.g. \"file:C:/test.dat\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;Must support classpath pseudo-URLs, e.g. \"classpath:test.dat\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;Should support relative file paths, e.g. \"WEB-INF/test.dat\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * (This will be implementation-specific, typically provided by an</span></span><br><span class=\"line\"><span class=\"comment\">\t * ApplicationContext implementation.)</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;/ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Note that a Resource handle does not imply an existing resource;</span></span><br><span class=\"line\"><span class=\"comment\">\t * you need to invoke &#123;<span class=\"doctag\">@link</span> Resource#exists&#125; to check for existence.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> location the resource location</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> a corresponding Resource handle</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #CLASSPATH_URL_PREFIX</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.Resource#exists</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.Resource#getInputStream</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">Resource <span class=\"title\">getResource</span><span class=\"params\">(String location)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Expose the ClassLoader used by this ResourceLoader.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Clients which need to access the ClassLoader directly can do so</span></span><br><span class=\"line\"><span class=\"comment\">\t * in a uniform manner with the ResourceLoader, rather than relying</span></span><br><span class=\"line\"><span class=\"comment\">\t * on the thread context ClassLoader.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the ClassLoader (only &#123;<span class=\"doctag\">@code</span> null&#125; if even the system</span></span><br><span class=\"line\"><span class=\"comment\">\t * ClassLoader isn't accessible)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.util.ClassUtils#getDefaultClassLoader()</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">ClassLoader <span class=\"title\">getClassLoader</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ResourceLoader　负责加载Resource, 所有的application context都实现了这个接口。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Resource template = ctx.getResource(<span class=\"string\">\"some/resource/path/myTemplate.txt\"</span>);</span><br></pre></td></tr></table></figure>\n<p>如果上述的ctx的类型是 ClassPathXmlApplicationContext，那么返回的Resource的具体类型就是</p>\n<p>ClassPathResource； 如果ctx的类型是FileSystemXmlApplicationContext, 返回的类型就变成了</p>\n<p>FileSystemResource。</p>\n<h3 id=\"指定返回的Resource类型\"><a href=\"#指定返回的Resource类型\" class=\"headerlink\" title=\"指定返回的Resource类型\"></a>指定返回的Resource类型</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Resource template = ctx.getResource(<span class=\"string\">\"classpath:some/resource/path/myTemplate.txt\"</span>);</span><br></pre></td></tr></table></figure>\n<p>通过显式的指定classpath前缀，返回的Resource的实际类型就是 ClassPathResource</p>\n<p>对应的关系见表格：</p>\n<table>\n<thead>\n<tr>\n<th>Prefix</th>\n<th>Example</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>classpath:</td>\n<td>classpath:com/myapp/config.xml</td>\n<td>Loaded from the classpath</td>\n</tr>\n<tr>\n<td>file:</td>\n<td>file:///data/config.xml</td>\n<td>Loaded as a URL, from the system</td>\n</tr>\n<tr>\n<td>http:</td>\n<td><a href=\"http://myserver/logo.png\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://myserver/logo.png</a></td>\n<td>Loaded as a URL</td>\n</tr>\n<tr>\n<td>（none）</td>\n<td>/data/config.xml</td>\n<td>Depends on the underlying ApplicationContext</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"classpath\"><a href=\"#classpath\" class=\"headerlink\" title=\"classpath*\"></a>classpath*</h4><p>classpath*:conf/appContext.xml</p>\n<p>这个特殊的前缀会使spring在所有的ClassPath中查找和指定的名字相同的资源，他们会合并形成最终的</p>\n<p>上下文。</p>\n<blockquote>\n<p>This special prefix specifies that all classpath resources that match the given name must be obtained<br>(internally, this essentially happens via a ClassLoader.getResources(…) call), and then merged<br>to form the final application context definition.</p>\n</blockquote>\n<h3 id=\"ResourceLoaderAware\"><a href=\"#ResourceLoaderAware\" class=\"headerlink\" title=\"ResourceLoaderAware\"></a>ResourceLoaderAware</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ResourceLoaderAware</span> <span class=\"keyword\">extends</span> <span class=\"title\">Aware</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Set the ResourceLoader that this object runs in.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;This might be a ResourcePatternResolver, which can be checked</span></span><br><span class=\"line\"><span class=\"comment\">\t * through &#123;<span class=\"doctag\">@code</span> instanceof ResourcePatternResolver&#125;. See also the</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@code</span> ResourcePatternUtils.getResourcePatternResolver&#125; method.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Invoked after population of normal bean properties but before an init callback</span></span><br><span class=\"line\"><span class=\"comment\">\t * like InitializingBean's &#123;<span class=\"doctag\">@code</span> afterPropertiesSet&#125; or a custom init-method.</span></span><br><span class=\"line\"><span class=\"comment\">\t * Invoked before ApplicationContextAware's &#123;<span class=\"doctag\">@code</span> setApplicationContext&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> resourceLoader ResourceLoader object to be used by this object</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.support.ResourcePatternResolver</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.support.ResourcePatternUtils#getResourcePatternResolver</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setResourceLoader</span><span class=\"params\">(ResourceLoader resourceLoader)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>实现这个接口的类，可以获得所在容器的ResourceLoader实例，一般来说就是相应的Application Context。也可以当做</p>\n<p>ApplicationContextAware的替代。</p>\n<blockquote>\n<p>  Interface to be implemented by any object that wishes to be notified of<br>  the <b>ResourceLoader</b> (typically the ApplicationContext) that it runs in.<br>  This is an alternative to a full ApplicationContext dependency via the<br>  ApplicationContextAware interface.</p>\n</blockquote>\n<p>除了实现上述接口，还可以使用基于类型的注入，将ResourceLoader注入到需要的地方。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Spring-Resource\"><a href=\"#Spring-Resource\" class=\"headerlink\" title=\"Spring Resource\"></a>Spring Resource</h1><h2 id=\"Why-not-Java-URL类\"><a href=\"#Why-not-Java-URL类\" class=\"headerlink\" title=\"Why not Java URL类\"></a>Why not Java URL类</h2><p>原因： 对底层资源的支持不足。</p>\n<ol>\n<li><p>there is no standardized URL implementation that may be used to access a resource that needs to be obtained from the classpath,or relative to a ServletContext.</p>\n</li>\n<li><p>不自定义URL handler的原因：</p>\n<p>a. 过于复杂<br>b. lack some desirable functionality（如对URL所指资源是否存在的判断）</p>\n</li>\n</ol>\n<h2 id=\"Resource-接口\"><a href=\"#Resource-接口\" class=\"headerlink\" title=\"Resource 接口\"></a>Resource 接口</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">InputStreamSource</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return an &#123;<span class=\"doctag\">@link</span> InputStream&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;It is expected that each call creates a &lt;i&gt;fresh&lt;/i&gt; stream.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;This requirement is particularly important when you consider an API such</span></span><br><span class=\"line\"><span class=\"comment\">\t * as JavaMail, which needs to be able to read the stream multiple times when</span></span><br><span class=\"line\"><span class=\"comment\">\t * creating mail attachments. For such a use case, it is &lt;i&gt;required&lt;/i&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * that each &#123;<span class=\"doctag\">@code</span> getInputStream()&#125; call returns a fresh stream.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the input stream for the underlying resource (must not be &#123;<span class=\"doctag\">@code</span> null&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the stream could not be opened</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.mail.javamail.MimeMessageHelper#addAttachment(String, InputStreamSource)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">InputStream <span class=\"title\">getInputStream</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Resource</span> <span class=\"keyword\">extends</span> <span class=\"title\">InputStreamSource</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return whether this resource actually exists in physical form.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;This method performs a definitive existence check, whereas the</span></span><br><span class=\"line\"><span class=\"comment\">\t * existence of a &#123;<span class=\"doctag\">@code</span> Resource&#125; handle only guarantees a</span></span><br><span class=\"line\"><span class=\"comment\">\t * valid descriptor handle.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">exists</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return whether the contents of this resource can be read,</span></span><br><span class=\"line\"><span class=\"comment\">\t * e.g. via &#123;<span class=\"doctag\">@link</span> #getInputStream()&#125; or &#123;<span class=\"doctag\">@link</span> #getFile()&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Will be &#123;<span class=\"doctag\">@code</span> true&#125; for typical resource descriptors;</span></span><br><span class=\"line\"><span class=\"comment\">\t * note that actual content reading may still fail when attempted.</span></span><br><span class=\"line\"><span class=\"comment\">\t * However, a value of &#123;<span class=\"doctag\">@code</span> false&#125; is a definitive indication</span></span><br><span class=\"line\"><span class=\"comment\">\t * that the resource content cannot be read.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #getInputStream()</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isReadable</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return whether this resource represents a handle with an open</span></span><br><span class=\"line\"><span class=\"comment\">\t * stream. If true, the InputStream cannot be read multiple times,</span></span><br><span class=\"line\"><span class=\"comment\">\t * and must be read and closed to avoid resource leaks.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Will be &#123;<span class=\"doctag\">@code</span> false&#125; for typical resource descriptors.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isOpen</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a URL handle for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved as URL,</span></span><br><span class=\"line\"><span class=\"comment\">\t * i.e. if the resource is not available as descriptor</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">URL <span class=\"title\">getURL</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a URI handle for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved as URI,</span></span><br><span class=\"line\"><span class=\"comment\">\t * i.e. if the resource is not available as descriptor</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">URI <span class=\"title\">getURI</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a File handle for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved as absolute</span></span><br><span class=\"line\"><span class=\"comment\">\t * file path, i.e. if the resource is not available in a file system</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">File <span class=\"title\">getFile</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Determine the content length for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t * (in the file system or as some other known physical resource type)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">contentLength</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Determine the last-modified timestamp for this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the resource cannot be resolved</span></span><br><span class=\"line\"><span class=\"comment\">\t * (in the file system or as some other known physical resource type)</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">lastModified</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Create a resource relative to this resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> relativePath the relative path (relative to this resource)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the resource handle for the relative resource</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@throws</span> IOException if the relative resource cannot be determined</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">Resource <span class=\"title\">createRelative</span><span class=\"params\">(String relativePath)</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Determine a filename for this resource, i.e. typically the last</span></span><br><span class=\"line\"><span class=\"comment\">\t * part of the path: for example, \"myfile.txt\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Returns &#123;<span class=\"doctag\">@code</span> null&#125; if this type of resource does not</span></span><br><span class=\"line\"><span class=\"comment\">\t * have a filename.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">String <span class=\"title\">getFilename</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a description for this resource,</span></span><br><span class=\"line\"><span class=\"comment\">\t * to be used for error output when working with the resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Implementations are also encouraged to return this value</span></span><br><span class=\"line\"><span class=\"comment\">\t * from their &#123;<span class=\"doctag\">@code</span> toString&#125; method.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> Object#toString()</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">String <span class=\"title\">getDescription</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"继承体系\"><a href=\"#继承体系\" class=\"headerlink\" title=\"继承体系\"></a>继承体系</h3><img src=\"/2016/11/20/spring-resource/resource.jpg\">\n<h2 id=\"ResourceLoader\"><a href=\"#ResourceLoader\" class=\"headerlink\" title=\"ResourceLoader\"></a>ResourceLoader</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ResourceLoader</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/** Pseudo URL prefix for loading from the class path: \"classpath:\" */</span></span><br><span class=\"line\">\tString CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Return a Resource handle for the specified resource.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The handle should always be a reusable resource descriptor,</span></span><br><span class=\"line\"><span class=\"comment\">\t * allowing for multiple &#123;<span class=\"doctag\">@link</span> Resource#getInputStream()&#125; calls.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;&lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;Must support fully qualified URLs, e.g. \"file:C:/test.dat\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;Must support classpath pseudo-URLs, e.g. \"classpath:test.dat\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;li&gt;Should support relative file paths, e.g. \"WEB-INF/test.dat\".</span></span><br><span class=\"line\"><span class=\"comment\">\t * (This will be implementation-specific, typically provided by an</span></span><br><span class=\"line\"><span class=\"comment\">\t * ApplicationContext implementation.)</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;/ul&gt;</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Note that a Resource handle does not imply an existing resource;</span></span><br><span class=\"line\"><span class=\"comment\">\t * you need to invoke &#123;<span class=\"doctag\">@link</span> Resource#exists&#125; to check for existence.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> location the resource location</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> a corresponding Resource handle</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> #CLASSPATH_URL_PREFIX</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.Resource#exists</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.Resource#getInputStream</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">Resource <span class=\"title\">getResource</span><span class=\"params\">(String location)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Expose the ClassLoader used by this ResourceLoader.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Clients which need to access the ClassLoader directly can do so</span></span><br><span class=\"line\"><span class=\"comment\">\t * in a uniform manner with the ResourceLoader, rather than relying</span></span><br><span class=\"line\"><span class=\"comment\">\t * on the thread context ClassLoader.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@return</span> the ClassLoader (only &#123;<span class=\"doctag\">@code</span> null&#125; if even the system</span></span><br><span class=\"line\"><span class=\"comment\">\t * ClassLoader isn't accessible)</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.util.ClassUtils#getDefaultClassLoader()</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\">ClassLoader <span class=\"title\">getClassLoader</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ResourceLoader　负责加载Resource, 所有的application context都实现了这个接口。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Resource template = ctx.getResource(<span class=\"string\">\"some/resource/path/myTemplate.txt\"</span>);</span><br></pre></td></tr></table></figure>\n<p>如果上述的ctx的类型是 ClassPathXmlApplicationContext，那么返回的Resource的具体类型就是</p>\n<p>ClassPathResource； 如果ctx的类型是FileSystemXmlApplicationContext, 返回的类型就变成了</p>\n<p>FileSystemResource。</p>\n<h3 id=\"指定返回的Resource类型\"><a href=\"#指定返回的Resource类型\" class=\"headerlink\" title=\"指定返回的Resource类型\"></a>指定返回的Resource类型</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Resource template = ctx.getResource(<span class=\"string\">\"classpath:some/resource/path/myTemplate.txt\"</span>);</span><br></pre></td></tr></table></figure>\n<p>通过显式的指定classpath前缀，返回的Resource的实际类型就是 ClassPathResource</p>\n<p>对应的关系见表格：</p>\n<table>\n<thead>\n<tr>\n<th>Prefix</th>\n<th>Example</th>\n<th>Explanation</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>classpath:</td>\n<td>classpath:com/myapp/config.xml</td>\n<td>Loaded from the classpath</td>\n</tr>\n<tr>\n<td>file:</td>\n<td>file:///data/config.xml</td>\n<td>Loaded as a URL, from the system</td>\n</tr>\n<tr>\n<td>http:</td>\n<td><a href=\"http://myserver/logo.png\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">http://myserver/logo.png</a></td>\n<td>Loaded as a URL</td>\n</tr>\n<tr>\n<td>（none）</td>\n<td>/data/config.xml</td>\n<td>Depends on the underlying ApplicationContext</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"classpath\"><a href=\"#classpath\" class=\"headerlink\" title=\"classpath*\"></a>classpath*</h4><p>classpath*:conf/appContext.xml</p>\n<p>这个特殊的前缀会使spring在所有的ClassPath中查找和指定的名字相同的资源，他们会合并形成最终的</p>\n<p>上下文。</p>\n<blockquote>\n<p>This special prefix specifies that all classpath resources that match the given name must be obtained<br>(internally, this essentially happens via a ClassLoader.getResources(…) call), and then merged<br>to form the final application context definition.</p>\n</blockquote>\n<h3 id=\"ResourceLoaderAware\"><a href=\"#ResourceLoaderAware\" class=\"headerlink\" title=\"ResourceLoaderAware\"></a>ResourceLoaderAware</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ResourceLoaderAware</span> <span class=\"keyword\">extends</span> <span class=\"title\">Aware</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">\t * Set the ResourceLoader that this object runs in.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;This might be a ResourcePatternResolver, which can be checked</span></span><br><span class=\"line\"><span class=\"comment\">\t * through &#123;<span class=\"doctag\">@code</span> instanceof ResourcePatternResolver&#125;. See also the</span></span><br><span class=\"line\"><span class=\"comment\">\t * &#123;<span class=\"doctag\">@code</span> ResourcePatternUtils.getResourcePatternResolver&#125; method.</span></span><br><span class=\"line\"><span class=\"comment\">\t * &lt;p&gt;Invoked after population of normal bean properties but before an init callback</span></span><br><span class=\"line\"><span class=\"comment\">\t * like InitializingBean's &#123;<span class=\"doctag\">@code</span> afterPropertiesSet&#125; or a custom init-method.</span></span><br><span class=\"line\"><span class=\"comment\">\t * Invoked before ApplicationContextAware's &#123;<span class=\"doctag\">@code</span> setApplicationContext&#125;.</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@param</span> resourceLoader ResourceLoader object to be used by this object</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.support.ResourcePatternResolver</span></span><br><span class=\"line\"><span class=\"comment\">\t * <span class=\"doctag\">@see</span> org.springframework.core.io.support.ResourcePatternUtils#getResourcePatternResolver</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setResourceLoader</span><span class=\"params\">(ResourceLoader resourceLoader)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>实现这个接口的类，可以获得所在容器的ResourceLoader实例，一般来说就是相应的Application Context。也可以当做</p>\n<p>ApplicationContextAware的替代。</p>\n<blockquote>\n<p>  Interface to be implemented by any object that wishes to be notified of<br>  the <b>ResourceLoader</b> (typically the ApplicationContext) that it runs in.<br>  This is an alternative to a full ApplicationContext dependency via the<br>  ApplicationContextAware interface.</p>\n</blockquote>\n<p>除了实现上述接口，还可以使用基于类型的注入，将ResourceLoader注入到需要的地方。</p>\n"},{"title":"tomcat access log 格式设置","toc":true,"abbrlink":26054,"date":"2016-12-22T16:43:10.000Z","_content":"\n\n## Tomcat access log 日志格式\n\n\n文件位置: `conf/server.xml`\n\n默认配置\n\n```xml\n        <!-- Access log processes all example.\n             Documentation at: /docs/config/valve.html\n             Note: The pattern used is equivalent to using pattern=\"common\" -->\n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\"\n               prefix=\"localhost_access_log.\" suffix=\".txt\"\n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b\" />\n```\n\n|名称 | 含义|\n|-|-|\n|%a | Remote IP address|\n|%A | Local IP address|\n|%b | Bytes sent, excluding HTTP headers, or '-' if zero|\n|%B | Bytes sent, excluding HTTP headers|\n|%h | Remote host name (or IP address if enableLookups for the connector is false)|\n|%H | Request protocol|\n|%l | Remote logical username from identd (always returns '-')|\n|%m | Request method (GET, POST, etc.)|\n|%p | Local port on which this request was received|\n|%q | Query string (prepended with a '?' if it exists)|\n|%r | First line of the request (method and request URI)|\n|%s | HTTP status code of the response|\n|%S | User session ID|\n|%t | Date and time, in Common Log Format|\n|%u | Remote user that was authenticated (if any), else '-'|\n|%U | Requested URL path|\n|%v | Local server name|\n|%D | Time taken to process the request, in millis|\n|%T | Time taken to process the request, in seconds|\n|%F | Time taken to commit the response, in millis|\n|%I | Current request thread name (can compare later with stacktraces)|\n\n默认的配置打出来的access日志如下：\n\n||||||||\n| -| -| -|-|- |- | -|\n|127.0.0.1 |-| -| [07/Oct/2016:22:31:56 +0800]| \"GET /dubbo/ HTTP/1.1\" |404 |963|\n|远程IP |logical username| remote user|时间和日期| http请求的第一行| 状态码| 除去http头的发送大小| \n\n### header、cookie、session其他字段的支持\n\n> There is also support to write information incoming or outgoing headers, cookies, session or request attributes and special timestamp formats. It is modeled after the Apache HTTP Server log configuration syntax:\n\n|名称 | 含义|\n|-|-|\n|%{xxx}i |for incoming headers|\n|%{xxx}o |for outgoing response headers|\n|%{xxx}c |for a specific cookie|\n|%{xxx}r |xxx is an attribute in the ServletRequest|\n|%{xxx}s |xxx is an attribute in the HttpSession|\n|%{xxx}t |xxx is an enhanced SimpleDateFormat pattern|\n\n例如： `%{X-Forwarded-For}i`即可打印出实际访问的ip地址（考虑到ng的反向代理）\n\nHTTP头一般格式如下:\n\n`X-Forwarded-For: client1, proxy1, proxy2`\n>其中的值通过一个 逗号+空格 把多个IP地址区分开, 最左边（client1）是最原始客户端的IP地址, 代理服务器每成功收到一个请求，就把请求来源IP地址添加到右边。 在上面这个例子中，这个请求成功通过了三台代理服务器：proxy1, proxy2 及 proxy3。请求由client1发出，到达了proxy3（proxy3可能是请求的终点）。请求刚从client1中发出时，XFF是空的，请求被发往proxy1；通过proxy1的时候，client1被添加到XFF中，之后请求被发往proxy2;通过proxy2的时候，proxy1被添加到XFF中，之后请求被发往proxy3；通过proxy3时，proxy2被添加到XFF中，之后请求的的去向不明，如果proxy3不是请求终点，请求会被继续转发。\n\n>鉴于伪造这一字段非常容易，应该谨慎使用X-Forwarded-For字段。正常情况下XFF中最后一个IP地址是最后一个代理服务器的IP地址, 这通常是一个比较可靠的信息来源。\n\n\n## 参考\n\n1. [The Valve Component](http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html)\n\n2. [X-Forwarded-For](https://zh.wikipedia.org/wiki/X-Forwarded-For)","source":"_posts/tomcat-access-log.md","raw":"---\ntitle: tomcat access log 格式设置\ntags: access-log\ncategory: tomcat\ntoc: true\nabbrlink: 26054\ndate: 2016-12-23 00:43:10\n---\n\n\n## Tomcat access log 日志格式\n\n\n文件位置: `conf/server.xml`\n\n默认配置\n\n```xml\n        <!-- Access log processes all example.\n             Documentation at: /docs/config/valve.html\n             Note: The pattern used is equivalent to using pattern=\"common\" -->\n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\"\n               prefix=\"localhost_access_log.\" suffix=\".txt\"\n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b\" />\n```\n\n|名称 | 含义|\n|-|-|\n|%a | Remote IP address|\n|%A | Local IP address|\n|%b | Bytes sent, excluding HTTP headers, or '-' if zero|\n|%B | Bytes sent, excluding HTTP headers|\n|%h | Remote host name (or IP address if enableLookups for the connector is false)|\n|%H | Request protocol|\n|%l | Remote logical username from identd (always returns '-')|\n|%m | Request method (GET, POST, etc.)|\n|%p | Local port on which this request was received|\n|%q | Query string (prepended with a '?' if it exists)|\n|%r | First line of the request (method and request URI)|\n|%s | HTTP status code of the response|\n|%S | User session ID|\n|%t | Date and time, in Common Log Format|\n|%u | Remote user that was authenticated (if any), else '-'|\n|%U | Requested URL path|\n|%v | Local server name|\n|%D | Time taken to process the request, in millis|\n|%T | Time taken to process the request, in seconds|\n|%F | Time taken to commit the response, in millis|\n|%I | Current request thread name (can compare later with stacktraces)|\n\n默认的配置打出来的access日志如下：\n\n||||||||\n| -| -| -|-|- |- | -|\n|127.0.0.1 |-| -| [07/Oct/2016:22:31:56 +0800]| \"GET /dubbo/ HTTP/1.1\" |404 |963|\n|远程IP |logical username| remote user|时间和日期| http请求的第一行| 状态码| 除去http头的发送大小| \n\n### header、cookie、session其他字段的支持\n\n> There is also support to write information incoming or outgoing headers, cookies, session or request attributes and special timestamp formats. It is modeled after the Apache HTTP Server log configuration syntax:\n\n|名称 | 含义|\n|-|-|\n|%{xxx}i |for incoming headers|\n|%{xxx}o |for outgoing response headers|\n|%{xxx}c |for a specific cookie|\n|%{xxx}r |xxx is an attribute in the ServletRequest|\n|%{xxx}s |xxx is an attribute in the HttpSession|\n|%{xxx}t |xxx is an enhanced SimpleDateFormat pattern|\n\n例如： `%{X-Forwarded-For}i`即可打印出实际访问的ip地址（考虑到ng的反向代理）\n\nHTTP头一般格式如下:\n\n`X-Forwarded-For: client1, proxy1, proxy2`\n>其中的值通过一个 逗号+空格 把多个IP地址区分开, 最左边（client1）是最原始客户端的IP地址, 代理服务器每成功收到一个请求，就把请求来源IP地址添加到右边。 在上面这个例子中，这个请求成功通过了三台代理服务器：proxy1, proxy2 及 proxy3。请求由client1发出，到达了proxy3（proxy3可能是请求的终点）。请求刚从client1中发出时，XFF是空的，请求被发往proxy1；通过proxy1的时候，client1被添加到XFF中，之后请求被发往proxy2;通过proxy2的时候，proxy1被添加到XFF中，之后请求被发往proxy3；通过proxy3时，proxy2被添加到XFF中，之后请求的的去向不明，如果proxy3不是请求终点，请求会被继续转发。\n\n>鉴于伪造这一字段非常容易，应该谨慎使用X-Forwarded-For字段。正常情况下XFF中最后一个IP地址是最后一个代理服务器的IP地址, 这通常是一个比较可靠的信息来源。\n\n\n## 参考\n\n1. [The Valve Component](http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html)\n\n2. [X-Forwarded-For](https://zh.wikipedia.org/wiki/X-Forwarded-For)","slug":"tomcat-access-log","published":1,"updated":"2017-04-16T12:03:23.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdap009pjh4kngyoeao7","content":"<h2 id=\"Tomcat-access-log-日志格式\"><a href=\"#Tomcat-access-log-日志格式\" class=\"headerlink\" title=\"Tomcat access log 日志格式\"></a>Tomcat access log 日志格式</h2><p>文件位置: <code>conf/server.xml</code></p>\n<p>默认配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Access log processes all example.</span></span><br><span class=\"line\"><span class=\"comment\">     Documentation at: /docs/config/valve.html</span></span><br><span class=\"line\"><span class=\"comment\">     <span class=\"doctag\">Note:</span> The pattern used is equivalent to using pattern=\"common\" --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"attr\">directory</span>=<span class=\"string\">\"logs\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">prefix</span>=<span class=\"string\">\"localhost_access_log.\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".txt\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%a</td>\n<td>Remote IP address</td>\n</tr>\n<tr>\n<td>%A</td>\n<td>Local IP address</td>\n</tr>\n<tr>\n<td>%b</td>\n<td>Bytes sent, excluding HTTP headers, or ‘-‘ if zero</td>\n</tr>\n<tr>\n<td>%B</td>\n<td>Bytes sent, excluding HTTP headers</td>\n</tr>\n<tr>\n<td>%h</td>\n<td>Remote host name (or IP address if enableLookups for the connector is false)</td>\n</tr>\n<tr>\n<td>%H</td>\n<td>Request protocol</td>\n</tr>\n<tr>\n<td>%l</td>\n<td>Remote logical username from identd (always returns ‘-‘)</td>\n</tr>\n<tr>\n<td>%m</td>\n<td>Request method (GET, POST, etc.)</td>\n</tr>\n<tr>\n<td>%p</td>\n<td>Local port on which this request was received</td>\n</tr>\n<tr>\n<td>%q</td>\n<td>Query string (prepended with a ‘?’ if it exists)</td>\n</tr>\n<tr>\n<td>%r</td>\n<td>First line of the request (method and request URI)</td>\n</tr>\n<tr>\n<td>%s</td>\n<td>HTTP status code of the response</td>\n</tr>\n<tr>\n<td>%S</td>\n<td>User session ID</td>\n</tr>\n<tr>\n<td>%t</td>\n<td>Date and time, in Common Log Format</td>\n</tr>\n<tr>\n<td>%u</td>\n<td>Remote user that was authenticated (if any), else ‘-‘</td>\n</tr>\n<tr>\n<td>%U</td>\n<td>Requested URL path</td>\n</tr>\n<tr>\n<td>%v</td>\n<td>Local server name</td>\n</tr>\n<tr>\n<td>%D</td>\n<td>Time taken to process the request, in millis</td>\n</tr>\n<tr>\n<td>%T</td>\n<td>Time taken to process the request, in seconds</td>\n</tr>\n<tr>\n<td>%F</td>\n<td>Time taken to commit the response, in millis</td>\n</tr>\n<tr>\n<td>%I</td>\n<td>Current request thread name (can compare later with stacktraces)</td>\n</tr>\n</tbody>\n</table>\n<p>默认的配置打出来的access日志如下：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>127.0.0.1</td>\n<td>-</td>\n<td>-</td>\n<td>[07/Oct/2016:22:31:56 +0800]</td>\n<td>“GET /dubbo/ HTTP/1.1”</td>\n<td>404</td>\n<td>963</td>\n</tr>\n<tr>\n<td>远程IP</td>\n<td>logical username</td>\n<td>remote user</td>\n<td>时间和日期</td>\n<td>http请求的第一行</td>\n<td>状态码</td>\n<td>除去http头的发送大小</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"header、cookie、session其他字段的支持\"><a href=\"#header、cookie、session其他字段的支持\" class=\"headerlink\" title=\"header、cookie、session其他字段的支持\"></a>header、cookie、session其他字段的支持</h3><blockquote>\n<p>There is also support to write information incoming or outgoing headers, cookies, session or request attributes and special timestamp formats. It is modeled after the Apache HTTP Server log configuration syntax:</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%{xxx}i</td>\n<td>for incoming headers</td>\n</tr>\n<tr>\n<td>%{xxx}o</td>\n<td>for outgoing response headers</td>\n</tr>\n<tr>\n<td>%{xxx}c</td>\n<td>for a specific cookie</td>\n</tr>\n<tr>\n<td>%{xxx}r</td>\n<td>xxx is an attribute in the ServletRequest</td>\n</tr>\n<tr>\n<td>%{xxx}s</td>\n<td>xxx is an attribute in the HttpSession</td>\n</tr>\n<tr>\n<td>%{xxx}t</td>\n<td>xxx is an enhanced SimpleDateFormat pattern</td>\n</tr>\n</tbody>\n</table>\n<p>例如： <code>%{X-Forwarded-For}i</code>即可打印出实际访问的ip地址（考虑到ng的反向代理）</p>\n<p>HTTP头一般格式如下:</p>\n<p><code>X-Forwarded-For: client1, proxy1, proxy2</code></p>\n<blockquote>\n<p>其中的值通过一个 逗号+空格 把多个IP地址区分开, 最左边（client1）是最原始客户端的IP地址, 代理服务器每成功收到一个请求，就把请求来源IP地址添加到右边。 在上面这个例子中，这个请求成功通过了三台代理服务器：proxy1, proxy2 及 proxy3。请求由client1发出，到达了proxy3（proxy3可能是请求的终点）。请求刚从client1中发出时，XFF是空的，请求被发往proxy1；通过proxy1的时候，client1被添加到XFF中，之后请求被发往proxy2;通过proxy2的时候，proxy1被添加到XFF中，之后请求被发往proxy3；通过proxy3时，proxy2被添加到XFF中，之后请求的的去向不明，如果proxy3不是请求终点，请求会被继续转发。</p>\n<p>鉴于伪造这一字段非常容易，应该谨慎使用X-Forwarded-For字段。正常情况下XFF中最后一个IP地址是最后一个代理服务器的IP地址, 这通常是一个比较可靠的信息来源。</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The Valve Component</a></p>\n</li>\n<li><p><a href=\"https://zh.wikipedia.org/wiki/X-Forwarded-For\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">X-Forwarded-For</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Tomcat-access-log-日志格式\"><a href=\"#Tomcat-access-log-日志格式\" class=\"headerlink\" title=\"Tomcat access log 日志格式\"></a>Tomcat access log 日志格式</h2><p>文件位置: <code>conf/server.xml</code></p>\n<p>默认配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Access log processes all example.</span></span><br><span class=\"line\"><span class=\"comment\">     Documentation at: /docs/config/valve.html</span></span><br><span class=\"line\"><span class=\"comment\">     <span class=\"doctag\">Note:</span> The pattern used is equivalent to using pattern=\"common\" --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"attr\">directory</span>=<span class=\"string\">\"logs\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">prefix</span>=<span class=\"string\">\"localhost_access_log.\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".txt\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%a</td>\n<td>Remote IP address</td>\n</tr>\n<tr>\n<td>%A</td>\n<td>Local IP address</td>\n</tr>\n<tr>\n<td>%b</td>\n<td>Bytes sent, excluding HTTP headers, or ‘-‘ if zero</td>\n</tr>\n<tr>\n<td>%B</td>\n<td>Bytes sent, excluding HTTP headers</td>\n</tr>\n<tr>\n<td>%h</td>\n<td>Remote host name (or IP address if enableLookups for the connector is false)</td>\n</tr>\n<tr>\n<td>%H</td>\n<td>Request protocol</td>\n</tr>\n<tr>\n<td>%l</td>\n<td>Remote logical username from identd (always returns ‘-‘)</td>\n</tr>\n<tr>\n<td>%m</td>\n<td>Request method (GET, POST, etc.)</td>\n</tr>\n<tr>\n<td>%p</td>\n<td>Local port on which this request was received</td>\n</tr>\n<tr>\n<td>%q</td>\n<td>Query string (prepended with a ‘?’ if it exists)</td>\n</tr>\n<tr>\n<td>%r</td>\n<td>First line of the request (method and request URI)</td>\n</tr>\n<tr>\n<td>%s</td>\n<td>HTTP status code of the response</td>\n</tr>\n<tr>\n<td>%S</td>\n<td>User session ID</td>\n</tr>\n<tr>\n<td>%t</td>\n<td>Date and time, in Common Log Format</td>\n</tr>\n<tr>\n<td>%u</td>\n<td>Remote user that was authenticated (if any), else ‘-‘</td>\n</tr>\n<tr>\n<td>%U</td>\n<td>Requested URL path</td>\n</tr>\n<tr>\n<td>%v</td>\n<td>Local server name</td>\n</tr>\n<tr>\n<td>%D</td>\n<td>Time taken to process the request, in millis</td>\n</tr>\n<tr>\n<td>%T</td>\n<td>Time taken to process the request, in seconds</td>\n</tr>\n<tr>\n<td>%F</td>\n<td>Time taken to commit the response, in millis</td>\n</tr>\n<tr>\n<td>%I</td>\n<td>Current request thread name (can compare later with stacktraces)</td>\n</tr>\n</tbody>\n</table>\n<p>默认的配置打出来的access日志如下：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>127.0.0.1</td>\n<td>-</td>\n<td>-</td>\n<td>[07/Oct/2016:22:31:56 +0800]</td>\n<td>“GET /dubbo/ HTTP/1.1”</td>\n<td>404</td>\n<td>963</td>\n</tr>\n<tr>\n<td>远程IP</td>\n<td>logical username</td>\n<td>remote user</td>\n<td>时间和日期</td>\n<td>http请求的第一行</td>\n<td>状态码</td>\n<td>除去http头的发送大小</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"header、cookie、session其他字段的支持\"><a href=\"#header、cookie、session其他字段的支持\" class=\"headerlink\" title=\"header、cookie、session其他字段的支持\"></a>header、cookie、session其他字段的支持</h3><blockquote>\n<p>There is also support to write information incoming or outgoing headers, cookies, session or request attributes and special timestamp formats. It is modeled after the Apache HTTP Server log configuration syntax:</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%{xxx}i</td>\n<td>for incoming headers</td>\n</tr>\n<tr>\n<td>%{xxx}o</td>\n<td>for outgoing response headers</td>\n</tr>\n<tr>\n<td>%{xxx}c</td>\n<td>for a specific cookie</td>\n</tr>\n<tr>\n<td>%{xxx}r</td>\n<td>xxx is an attribute in the ServletRequest</td>\n</tr>\n<tr>\n<td>%{xxx}s</td>\n<td>xxx is an attribute in the HttpSession</td>\n</tr>\n<tr>\n<td>%{xxx}t</td>\n<td>xxx is an enhanced SimpleDateFormat pattern</td>\n</tr>\n</tbody>\n</table>\n<p>例如： <code>%{X-Forwarded-For}i</code>即可打印出实际访问的ip地址（考虑到ng的反向代理）</p>\n<p>HTTP头一般格式如下:</p>\n<p><code>X-Forwarded-For: client1, proxy1, proxy2</code></p>\n<blockquote>\n<p>其中的值通过一个 逗号+空格 把多个IP地址区分开, 最左边（client1）是最原始客户端的IP地址, 代理服务器每成功收到一个请求，就把请求来源IP地址添加到右边。 在上面这个例子中，这个请求成功通过了三台代理服务器：proxy1, proxy2 及 proxy3。请求由client1发出，到达了proxy3（proxy3可能是请求的终点）。请求刚从client1中发出时，XFF是空的，请求被发往proxy1；通过proxy1的时候，client1被添加到XFF中，之后请求被发往proxy2;通过proxy2的时候，proxy1被添加到XFF中，之后请求被发往proxy3；通过proxy3时，proxy2被添加到XFF中，之后请求的的去向不明，如果proxy3不是请求终点，请求会被继续转发。</p>\n<p>鉴于伪造这一字段非常容易，应该谨慎使用X-Forwarded-For字段。正常情况下XFF中最后一个IP地址是最后一个代理服务器的IP地址, 这通常是一个比较可靠的信息来源。</p>\n</blockquote>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The Valve Component</a></p>\n</li>\n<li><p><a href=\"https://zh.wikipedia.org/wiki/X-Forwarded-For\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">X-Forwarded-For</a></p>\n</li>\n</ol>\n"},{"title":"tomcat访问时发生AbstractMethodError","toc":true,"abbrlink":55498,"date":"2017-01-27T09:16:10.000Z","_content":"\n\n## 异常堆栈\n\n```\njavax.servlet.ServletException: Servlet execution threw an exception\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:313) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]\n        at qunar.ServletWatcher.doFilter(ServletWatcher.java:160) ~[common-core-8.3.5.jar:na]\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]\n        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127) [catalina.jar:6.0.29]\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102) [catalina.jar:6.0.29]\n        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109) [catalina.jar:6.0.29]\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298) [catalina.jar:6.0.29]\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857) [tomcat-coyote.jar:6.0.29]\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588) [tomcat-coyote.jar:6.0.29]\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489) [tomcat-coyote.jar:6.0.29]\n        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]\nCaused by: java.lang.AbstractMethodError: null\n        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]\n        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]\n        at org.springframework.web.servlet.FrameworkServlet.publishRequestHandledEvent(FrameworkServlet.java:1070) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1003) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:859) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at javax.servlet.http.HttpServlet.doHead(HttpServlet.java:244) ~[lib/:na]\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:644) ~[lib/:na]\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:844) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728) ~[lib/:na]\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290) [catalina.jar:6.0.29]\n        ... 19 common frames omitted\n```\n\n### AbstractMethodError异常\n\n```java\n/**\n * Thrown when an application tries to call an abstract method.\n * Normally, this error is caught by the compiler; this error can\n * only occur at run time if the definition of some class has\n * incompatibly changed since the currently executing method was last\n * compiled.\n *\n * @author  unascribed\n * @since   JDK1.0\n */\npublic\nclass AbstractMethodError extends IncompatibleClassChangeError {...}\n```\n\n就是调用了一个没有实现的抽象方法时会抛出这个异常。\n\n## 原因\n\n### 环境被搞乱\n\n有人把`servlet-api 3.0`的jar包拷贝到了`tomcat6`的lib目录下，替换了原来的jar包，造成spring以为他支持Servlet3.0 但是tomcat却没有实现这个方法。\n\n## Spring 版本\n\nSpring的版本是4.2.5，增加了一些`Servlet 3.0` 的特性支持, 但是使用之前Spring会根据使用的\n\n`Servlet-api`来检测是否支持`Servlet 3.0`\n\n使用的3.0的api\n\n```java\n    /**\n     * Gets the current status code of this response.\n     *\n     * @return the current status code of this response\n     *\n     * @since Servlet 3.0\n     */\n    public int getStatus();\n\n```\n\n在`FrameworkServlet`中会进行相应的检测和使用：\n\n```java\n    /** Checking for Servlet 3.0+ HttpServletResponse.getStatus() */\n    private static final boolean responseGetStatusAvailable =\n            ClassUtils.hasMethod(HttpServletResponse.class, \"getStatus\");\n\n\nprivate void publishRequestHandledEvent(\nHttpServletRequest request, HttpServletResponse response, long startTime, Throwable failureCause) {\n\n    if (this.publishEvents) {\n        // Whether or not we succeeded, publish an event.\n        long processingTime = System.currentTimeMillis() - startTime;\n        int statusCode = (responseGetStatusAvailable ? response.getStatus() : -1);\n        this.webApplicationContext.publishEvent(\n            new ServletRequestHandledEvent(this,\n                    request.getRequestURI(), request.getRemoteAddr(),\n                    request.getMethod(), getServletConfig().getServletName(),\n                    WebUtils.getSessionId(request), getUsernameForRequest(request),\n                    processingTime, failureCause, statusCode));\n    }\n}\n```\n\n### 为什么编译时没有报错\n\n>当前的JVM规范中，与方法调用相关的指令有4个：invokevirtual、invokeinterface、invokestatic与invokespecial。其中调用接口方法时使用的JVM指令是invokeinterface。这个指令与另外3个方法调用指令有一个显著的差异：它不要求JVM的校验器（verifier）检查被调用对象（receiver）的类型；另外3个方法调用指令都要求校验被调用对象。也就是说，使用invokeinterface时如果被调用对象没有实现指定的接口，则应该在运行时而不是链接时抛出异常；而另外3个方法调用指令都要求在链接时抛出异常。 \n\n这也是为啥类的载入是成功的，但是tomcat里面没有实现那个方法。\n\n## servlet和tomcat的对应关系\n\n{% asset_img tomcat-servlet.jpg  tomcat和Servlet的版本对应关系 %}\n\n## 参考\n\n1. [JVM在校验阶段不检查接口的实现状况 - Script Ahead, Code Behind - ITeye技术网站](http://rednaxelafx.iteye.com/blog/400362)\n\n2. [Apache Tomcat® - Which Version Do I Want?](http://tomcat.apache.org/whichversion.html)","source":"_posts/tomcat-AbstractMethodError.md","raw":"---\ntitle: tomcat访问时发生AbstractMethodError\ncategory: tomcat\ntoc: true\nabbrlink: 55498\ndate: 2017-01-27 17:16:10\ntags:\n---\n\n\n## 异常堆栈\n\n```\njavax.servlet.ServletException: Servlet execution threw an exception\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:313) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]\n        at qunar.ServletWatcher.doFilter(ServletWatcher.java:160) ~[common-core-8.3.5.jar:na]\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]\n        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127) [catalina.jar:6.0.29]\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102) [catalina.jar:6.0.29]\n        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555) [catalina.jar:6.0.29]\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109) [catalina.jar:6.0.29]\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298) [catalina.jar:6.0.29]\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857) [tomcat-coyote.jar:6.0.29]\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588) [tomcat-coyote.jar:6.0.29]\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489) [tomcat-coyote.jar:6.0.29]\n        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]\nCaused by: java.lang.AbstractMethodError: null\n        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]\n        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]\n        at org.springframework.web.servlet.FrameworkServlet.publishRequestHandledEvent(FrameworkServlet.java:1070) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1003) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:859) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at javax.servlet.http.HttpServlet.doHead(HttpServlet.java:244) ~[lib/:na]\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:644) ~[lib/:na]\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:844) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728) ~[lib/:na]\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290) [catalina.jar:6.0.29]\n        ... 19 common frames omitted\n```\n\n### AbstractMethodError异常\n\n```java\n/**\n * Thrown when an application tries to call an abstract method.\n * Normally, this error is caught by the compiler; this error can\n * only occur at run time if the definition of some class has\n * incompatibly changed since the currently executing method was last\n * compiled.\n *\n * @author  unascribed\n * @since   JDK1.0\n */\npublic\nclass AbstractMethodError extends IncompatibleClassChangeError {...}\n```\n\n就是调用了一个没有实现的抽象方法时会抛出这个异常。\n\n## 原因\n\n### 环境被搞乱\n\n有人把`servlet-api 3.0`的jar包拷贝到了`tomcat6`的lib目录下，替换了原来的jar包，造成spring以为他支持Servlet3.0 但是tomcat却没有实现这个方法。\n\n## Spring 版本\n\nSpring的版本是4.2.5，增加了一些`Servlet 3.0` 的特性支持, 但是使用之前Spring会根据使用的\n\n`Servlet-api`来检测是否支持`Servlet 3.0`\n\n使用的3.0的api\n\n```java\n    /**\n     * Gets the current status code of this response.\n     *\n     * @return the current status code of this response\n     *\n     * @since Servlet 3.0\n     */\n    public int getStatus();\n\n```\n\n在`FrameworkServlet`中会进行相应的检测和使用：\n\n```java\n    /** Checking for Servlet 3.0+ HttpServletResponse.getStatus() */\n    private static final boolean responseGetStatusAvailable =\n            ClassUtils.hasMethod(HttpServletResponse.class, \"getStatus\");\n\n\nprivate void publishRequestHandledEvent(\nHttpServletRequest request, HttpServletResponse response, long startTime, Throwable failureCause) {\n\n    if (this.publishEvents) {\n        // Whether or not we succeeded, publish an event.\n        long processingTime = System.currentTimeMillis() - startTime;\n        int statusCode = (responseGetStatusAvailable ? response.getStatus() : -1);\n        this.webApplicationContext.publishEvent(\n            new ServletRequestHandledEvent(this,\n                    request.getRequestURI(), request.getRemoteAddr(),\n                    request.getMethod(), getServletConfig().getServletName(),\n                    WebUtils.getSessionId(request), getUsernameForRequest(request),\n                    processingTime, failureCause, statusCode));\n    }\n}\n```\n\n### 为什么编译时没有报错\n\n>当前的JVM规范中，与方法调用相关的指令有4个：invokevirtual、invokeinterface、invokestatic与invokespecial。其中调用接口方法时使用的JVM指令是invokeinterface。这个指令与另外3个方法调用指令有一个显著的差异：它不要求JVM的校验器（verifier）检查被调用对象（receiver）的类型；另外3个方法调用指令都要求校验被调用对象。也就是说，使用invokeinterface时如果被调用对象没有实现指定的接口，则应该在运行时而不是链接时抛出异常；而另外3个方法调用指令都要求在链接时抛出异常。 \n\n这也是为啥类的载入是成功的，但是tomcat里面没有实现那个方法。\n\n## servlet和tomcat的对应关系\n\n{% asset_img tomcat-servlet.jpg  tomcat和Servlet的版本对应关系 %}\n\n## 参考\n\n1. [JVM在校验阶段不检查接口的实现状况 - Script Ahead, Code Behind - ITeye技术网站](http://rednaxelafx.iteye.com/blog/400362)\n\n2. [Apache Tomcat® - Which Version Do I Want?](http://tomcat.apache.org/whichversion.html)","slug":"tomcat-AbstractMethodError","published":1,"updated":"2017-04-16T12:04:30.014Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdar009sjh4kdyenzppa","content":"<h2 id=\"异常堆栈\"><a href=\"#异常堆栈\" class=\"headerlink\" title=\"异常堆栈\"></a>异常堆栈</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javax.servlet.ServletException: Servlet execution threw an exception</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:313) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at qunar.ServletWatcher.doFilter(ServletWatcher.java:160) ~[common-core-8.3.5.jar:na]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857) [tomcat-coyote.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588) [tomcat-coyote.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489) [tomcat-coyote.jar:6.0.29]</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]</span><br><span class=\"line\">Caused by: java.lang.AbstractMethodError: null</span><br><span class=\"line\">        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]</span><br><span class=\"line\">        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.publishRequestHandledEvent(FrameworkServlet.java:1070) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1003) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:859) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at javax.servlet.http.HttpServlet.doHead(HttpServlet.java:244) ~[lib/:na]</span><br><span class=\"line\">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:644) ~[lib/:na]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:844) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728) ~[lib/:na]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290) [catalina.jar:6.0.29]</span><br><span class=\"line\">        ... 19 common frames omitted</span><br></pre></td></tr></table></figure>\n<h3 id=\"AbstractMethodError异常\"><a href=\"#AbstractMethodError异常\" class=\"headerlink\" title=\"AbstractMethodError异常\"></a>AbstractMethodError异常</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Thrown when an application tries to call an abstract method.</span></span><br><span class=\"line\"><span class=\"comment\"> * Normally, this error is caught by the compiler; this error can</span></span><br><span class=\"line\"><span class=\"comment\"> * only occur at run time if the definition of some class has</span></span><br><span class=\"line\"><span class=\"comment\"> * incompatibly changed since the currently executing method was last</span></span><br><span class=\"line\"><span class=\"comment\"> * compiled.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span>  unascribed</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span>   JDK1.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractMethodError</span> <span class=\"keyword\">extends</span> <span class=\"title\">IncompatibleClassChangeError</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<p>就是调用了一个没有实现的抽象方法时会抛出这个异常。</p>\n<h2 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h2><h3 id=\"环境被搞乱\"><a href=\"#环境被搞乱\" class=\"headerlink\" title=\"环境被搞乱\"></a>环境被搞乱</h3><p>有人把<code>servlet-api 3.0</code>的jar包拷贝到了<code>tomcat6</code>的lib目录下，替换了原来的jar包，造成spring以为他支持Servlet3.0 但是tomcat却没有实现这个方法。</p>\n<h2 id=\"Spring-版本\"><a href=\"#Spring-版本\" class=\"headerlink\" title=\"Spring 版本\"></a>Spring 版本</h2><p>Spring的版本是4.2.5，增加了一些<code>Servlet 3.0</code> 的特性支持, 但是使用之前Spring会根据使用的</p>\n<p><code>Servlet-api</code>来检测是否支持<code>Servlet 3.0</code></p>\n<p>使用的3.0的api</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Gets the current status code of this response.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the current status code of this response</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> Servlet 3.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getStatus</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n<p>在<code>FrameworkServlet</code>中会进行相应的检测和使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">/** Checking for Servlet 3.0+ HttpServletResponse.getStatus() */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> responseGetStatusAvailable =</span><br><span class=\"line\">            ClassUtils.hasMethod(HttpServletResponse.class, <span class=\"string\">\"getStatus\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">publishRequestHandledEvent</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">HttpServletRequest request, HttpServletResponse response, <span class=\"keyword\">long</span> startTime, Throwable failureCause)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.publishEvents) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Whether or not we succeeded, publish an event.</span></span><br><span class=\"line\">        <span class=\"keyword\">long</span> processingTime = System.currentTimeMillis() - startTime;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> statusCode = (responseGetStatusAvailable ? response.getStatus() : -<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.webApplicationContext.publishEvent(</span><br><span class=\"line\">            <span class=\"keyword\">new</span> ServletRequestHandledEvent(<span class=\"keyword\">this</span>,</span><br><span class=\"line\">                    request.getRequestURI(), request.getRemoteAddr(),</span><br><span class=\"line\">                    request.getMethod(), getServletConfig().getServletName(),</span><br><span class=\"line\">                    WebUtils.getSessionId(request), getUsernameForRequest(request),</span><br><span class=\"line\">                    processingTime, failureCause, statusCode));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"为什么编译时没有报错\"><a href=\"#为什么编译时没有报错\" class=\"headerlink\" title=\"为什么编译时没有报错\"></a>为什么编译时没有报错</h3><blockquote>\n<p>当前的JVM规范中，与方法调用相关的指令有4个：invokevirtual、invokeinterface、invokestatic与invokespecial。其中调用接口方法时使用的JVM指令是invokeinterface。这个指令与另外3个方法调用指令有一个显著的差异：它不要求JVM的校验器（verifier）检查被调用对象（receiver）的类型；另外3个方法调用指令都要求校验被调用对象。也就是说，使用invokeinterface时如果被调用对象没有实现指定的接口，则应该在运行时而不是链接时抛出异常；而另外3个方法调用指令都要求在链接时抛出异常。 </p>\n</blockquote>\n<p>这也是为啥类的载入是成功的，但是tomcat里面没有实现那个方法。</p>\n<h2 id=\"servlet和tomcat的对应关系\"><a href=\"#servlet和tomcat的对应关系\" class=\"headerlink\" title=\"servlet和tomcat的对应关系\"></a>servlet和tomcat的对应关系</h2>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://rednaxelafx.iteye.com/blog/400362\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM在校验阶段不检查接口的实现状况 - Script Ahead, Code Behind - ITeye技术网站</a></p>\n</li>\n<li><p><a href=\"http://tomcat.apache.org/whichversion.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Apache Tomcat® - Which Version Do I Want?</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"异常堆栈\"><a href=\"#异常堆栈\" class=\"headerlink\" title=\"异常堆栈\"></a>异常堆栈</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">javax.servlet.ServletException: Servlet execution threw an exception</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:313) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at qunar.ServletWatcher.doFilter(ServletWatcher.java:160) ~[common-core-8.3.5.jar:na]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) [spring-web-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:555) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298) [catalina.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857) [tomcat-coyote.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588) [tomcat-coyote.jar:6.0.29]</span><br><span class=\"line\">        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489) [tomcat-coyote.jar:6.0.29]</span><br><span class=\"line\">        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]</span><br><span class=\"line\">Caused by: java.lang.AbstractMethodError: null</span><br><span class=\"line\">        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]</span><br><span class=\"line\">        at javax.servlet.http.HttpServletResponseWrapper.getStatus(HttpServletResponseWrapper.java:228) ~[lib/:na]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.publishRequestHandledEvent(FrameworkServlet.java:1070) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1003) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:859) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at javax.servlet.http.HttpServlet.doHead(HttpServlet.java:244) ~[lib/:na]</span><br><span class=\"line\">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:644) ~[lib/:na]</span><br><span class=\"line\">        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:844) ~[spring-webmvc-4.2.5.RELEASE.jar:4.2.5.RELEASE]</span><br><span class=\"line\">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728) ~[lib/:na]</span><br><span class=\"line\">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290) [catalina.jar:6.0.29]</span><br><span class=\"line\">        ... 19 common frames omitted</span><br></pre></td></tr></table></figure>\n<h3 id=\"AbstractMethodError异常\"><a href=\"#AbstractMethodError异常\" class=\"headerlink\" title=\"AbstractMethodError异常\"></a>AbstractMethodError异常</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Thrown when an application tries to call an abstract method.</span></span><br><span class=\"line\"><span class=\"comment\"> * Normally, this error is caught by the compiler; this error can</span></span><br><span class=\"line\"><span class=\"comment\"> * only occur at run time if the definition of some class has</span></span><br><span class=\"line\"><span class=\"comment\"> * incompatibly changed since the currently executing method was last</span></span><br><span class=\"line\"><span class=\"comment\"> * compiled.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span>  unascribed</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span>   JDK1.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractMethodError</span> <span class=\"keyword\">extends</span> <span class=\"title\">IncompatibleClassChangeError</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<p>就是调用了一个没有实现的抽象方法时会抛出这个异常。</p>\n<h2 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h2><h3 id=\"环境被搞乱\"><a href=\"#环境被搞乱\" class=\"headerlink\" title=\"环境被搞乱\"></a>环境被搞乱</h3><p>有人把<code>servlet-api 3.0</code>的jar包拷贝到了<code>tomcat6</code>的lib目录下，替换了原来的jar包，造成spring以为他支持Servlet3.0 但是tomcat却没有实现这个方法。</p>\n<h2 id=\"Spring-版本\"><a href=\"#Spring-版本\" class=\"headerlink\" title=\"Spring 版本\"></a>Spring 版本</h2><p>Spring的版本是4.2.5，增加了一些<code>Servlet 3.0</code> 的特性支持, 但是使用之前Spring会根据使用的</p>\n<p><code>Servlet-api</code>来检测是否支持<code>Servlet 3.0</code></p>\n<p>使用的3.0的api</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Gets the current status code of this response.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the current status code of this response</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> Servlet 3.0</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getStatus</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n<p>在<code>FrameworkServlet</code>中会进行相应的检测和使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">/** Checking for Servlet 3.0+ HttpServletResponse.getStatus() */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> responseGetStatusAvailable =</span><br><span class=\"line\">            ClassUtils.hasMethod(HttpServletResponse.class, <span class=\"string\">\"getStatus\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">publishRequestHandledEvent</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">HttpServletRequest request, HttpServletResponse response, <span class=\"keyword\">long</span> startTime, Throwable failureCause)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.publishEvents) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Whether or not we succeeded, publish an event.</span></span><br><span class=\"line\">        <span class=\"keyword\">long</span> processingTime = System.currentTimeMillis() - startTime;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> statusCode = (responseGetStatusAvailable ? response.getStatus() : -<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.webApplicationContext.publishEvent(</span><br><span class=\"line\">            <span class=\"keyword\">new</span> ServletRequestHandledEvent(<span class=\"keyword\">this</span>,</span><br><span class=\"line\">                    request.getRequestURI(), request.getRemoteAddr(),</span><br><span class=\"line\">                    request.getMethod(), getServletConfig().getServletName(),</span><br><span class=\"line\">                    WebUtils.getSessionId(request), getUsernameForRequest(request),</span><br><span class=\"line\">                    processingTime, failureCause, statusCode));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"为什么编译时没有报错\"><a href=\"#为什么编译时没有报错\" class=\"headerlink\" title=\"为什么编译时没有报错\"></a>为什么编译时没有报错</h3><blockquote>\n<p>当前的JVM规范中，与方法调用相关的指令有4个：invokevirtual、invokeinterface、invokestatic与invokespecial。其中调用接口方法时使用的JVM指令是invokeinterface。这个指令与另外3个方法调用指令有一个显著的差异：它不要求JVM的校验器（verifier）检查被调用对象（receiver）的类型；另外3个方法调用指令都要求校验被调用对象。也就是说，使用invokeinterface时如果被调用对象没有实现指定的接口，则应该在运行时而不是链接时抛出异常；而另外3个方法调用指令都要求在链接时抛出异常。 </p>\n</blockquote>\n<p>这也是为啥类的载入是成功的，但是tomcat里面没有实现那个方法。</p>\n<h2 id=\"servlet和tomcat的对应关系\"><a href=\"#servlet和tomcat的对应关系\" class=\"headerlink\" title=\"servlet和tomcat的对应关系\"></a>servlet和tomcat的对应关系</h2>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://rednaxelafx.iteye.com/blog/400362\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">JVM在校验阶段不检查接口的实现状况 - Script Ahead, Code Behind - ITeye技术网站</a></p>\n</li>\n<li><p><a href=\"http://tomcat.apache.org/whichversion.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Apache Tomcat® - Which Version Do I Want?</a></p>\n</li>\n</ol>\n"},{"title":"tomcat中文编码设置","toc":true,"abbrlink":53678,"date":"2016-12-22T16:43:20.000Z","_content":"\n\n## tomcat中文乱码\n\ntomcat 默认的编`ISO-8859-1`编码，部分中文会出现乱码\n\n> *URIEncoding*   \nThis specifies the character encoding used to decode the URI bytes, after %xx decoding the URL. If not specified, ISO-8859-1 will be used.\n\n\n## 编码设置\n\n`conf/server.xml`\n\n修改前：\n\n```xml\n<Connector port=\"8080\" redirectPort=\"8443\" connectionTimeout=\"20000\" protocol=\"HTTP/1.1\"/>\n```\n\n修改后：\n\n```xml\n    <Connector port=\"8080\" redirectPort=\"8443\" connectionTimeout=\"20000\" \n    protocol=\"HTTP/1.1\"               \n    URIEncoding=\"UTF-8\"/>\n```\n\n## 参考\n\n1. [The HTTP Connector](https://tomcat.apache.org/tomcat-7.0-doc/config/http.html)\n\n","source":"_posts/tomcat-encoding.md","raw":"---\ntitle: tomcat中文编码设置\ntags: encoding\ncategory: tomcat\ntoc: true\nabbrlink: 53678\ndate: 2016-12-23 00:43:20\n---\n\n\n## tomcat中文乱码\n\ntomcat 默认的编`ISO-8859-1`编码，部分中文会出现乱码\n\n> *URIEncoding*   \nThis specifies the character encoding used to decode the URI bytes, after %xx decoding the URL. If not specified, ISO-8859-1 will be used.\n\n\n## 编码设置\n\n`conf/server.xml`\n\n修改前：\n\n```xml\n<Connector port=\"8080\" redirectPort=\"8443\" connectionTimeout=\"20000\" protocol=\"HTTP/1.1\"/>\n```\n\n修改后：\n\n```xml\n    <Connector port=\"8080\" redirectPort=\"8443\" connectionTimeout=\"20000\" \n    protocol=\"HTTP/1.1\"               \n    URIEncoding=\"UTF-8\"/>\n```\n\n## 参考\n\n1. [The HTTP Connector](https://tomcat.apache.org/tomcat-7.0-doc/config/http.html)\n\n","slug":"tomcat-encoding","published":1,"updated":"2017-04-16T12:03:23.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdas009vjh4kmt1hbifd","content":"<h2 id=\"tomcat中文乱码\"><a href=\"#tomcat中文乱码\" class=\"headerlink\" title=\"tomcat中文乱码\"></a>tomcat中文乱码</h2><p>tomcat 默认的编<code>ISO-8859-1</code>编码，部分中文会出现乱码</p>\n<blockquote>\n<p><em>URIEncoding</em><br>This specifies the character encoding used to decode the URI bytes, after %xx decoding the URL. If not specified, ISO-8859-1 will be used.</p>\n</blockquote>\n<h2 id=\"编码设置\"><a href=\"#编码设置\" class=\"headerlink\" title=\"编码设置\"></a>编码设置</h2><p><code>conf/server.xml</code></p>\n<p>修改前：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span> <span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>修改后：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span> </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span>               </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">URIEncoding</span>=<span class=\"string\">\"UTF-8\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://tomcat.apache.org/tomcat-7.0-doc/config/http.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The HTTP Connector</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"tomcat中文乱码\"><a href=\"#tomcat中文乱码\" class=\"headerlink\" title=\"tomcat中文乱码\"></a>tomcat中文乱码</h2><p>tomcat 默认的编<code>ISO-8859-1</code>编码，部分中文会出现乱码</p>\n<blockquote>\n<p><em>URIEncoding</em><br>This specifies the character encoding used to decode the URI bytes, after %xx decoding the URL. If not specified, ISO-8859-1 will be used.</p>\n</blockquote>\n<h2 id=\"编码设置\"><a href=\"#编码设置\" class=\"headerlink\" title=\"编码设置\"></a>编码设置</h2><p><code>conf/server.xml</code></p>\n<p>修改前：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span> <span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<p>修改后：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span> <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span> </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span>               </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">URIEncoding</span>=<span class=\"string\">\"UTF-8\"</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><a href=\"https://tomcat.apache.org/tomcat-7.0-doc/config/http.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">The HTTP Connector</a></li>\n</ol>\n"},{"title":"tomcat连接数相关的配置","toc":true,"abbrlink":44911,"date":"2017-04-04T17:22:17.000Z","_content":"\n\n*以下是tomcat7的一些配置说明*\n\n# tomcat交互图\n\n{%  asset_img   tomcat-interaction.jpg  图片取自参考1 %}\n\n## maxConnections\n\ntomcat接受的最大连接的个数，超过这个连接个数，acceptor就会阻塞。\n\n> The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. This additional connection be blocked until the number of connections being processed falls below maxConnections at which point the server will start accepting and processing new connections again. Note that once the limit has been reached, the operating system may still accept connections based on the acceptCount setting. The default value varies by connector type. For BIO the default is the value of maxThreads unless an Executor is used in which case the default will be the value of maxThreads from the executor. For NIO the default is 10000. For APR/native, the default is 8192.\n\n需要注意的是，在BIO模式下，`maxConnections`的值默认等于`maxThreads`的值!!!\n\n达到maxConnections之后，acceptor线程就会阻塞，用jstack查看堆栈会发现Acceptor线程阻塞在下面的代码\n\n```bash\nsudo -u tomcat jstack  `pgrep -f 'tomcat'` | less\n```\n\ntomcat  7的源码中相应的代码\n\n```java\n                    //if we have reached max connections, wait\n                    countUpOrAwaitConnection();\n```\n\n函数的具体实现\n\n```java\n    protected void countUpOrAwaitConnection() throws InterruptedException {\n        if (maxConnections==-1) return;\n        LimitLatch latch = connectionLimitLatch;\n        if (latch!=null) latch.countUpOrAwait();\n    }\n```\n\n其中`LimitLatch`是tomcat自己实现的一个类似`CountDownLatch`的东西。\n\n```java\n/**\n * Shared latch that allows the latch to be acquired a limited number of times\n * after which all subsequent requests to acquire the latch will be placed in a\n * FIFO queue until one of the shares is returned.\n */\npublic class LimitLatch {...}\n```\n\n它的初始化过程：\n\n```java\n    protected LimitLatch initializeConnectionLatch() {\n        if (maxConnections==-1) return null;\n        if (connectionLimitLatch==null) {\n            connectionLimitLatch = new LimitLatch(getMaxConnections());\n        }\n        return connectionLimitLatch;\n    }\n```\n\n## maxThreads\n\ntomcat的连接线程最大个数。\n\n\n> The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled. If not specified, this attribute is set to 200. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.\n\n>maxThreads、minSpareThreads是tomcat工作线程池的配置参数，maxThreads就相当于jdk线程池的maxPoolSize，而minSpareThreads就相当于jdk线程池的corePoolSize。\n\n相应的代码如下：\n\n```java\n    public void createExecutor() {\n        internalExecutor = true;\n        TaskQueue taskqueue = new TaskQueue();\n        TaskThreadFactory tf = new TaskThreadFactory(getName() + \"-exec-\", daemon, getThreadPriority());\n        executor = new ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), 60, TimeUnit.SECONDS,taskqueue, tf);\n        taskqueue.setParent( (ThreadPoolExecutor) executor);\n    }\n```\n\n## acceptCount\n\n系统积压队列的大小。\n\n>The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.\n\ntomcat7的源码中有这么一段，大概就是别名的替换。`acceptCount`被替换成了`backlog`，`backlog`的意思是积压的东西。\n\n```java\n     static {\n         replacements.put(\"acceptCount\", \"backlog\");\n         replacements.put(\"connectionLinger\", \"soLinger\");\n         replacements.put(\"connectionTimeout\", \"soTimeout\");\n         replacements.put(\"rootFile\", \"rootfile\");\n     }\n```\n\n`acceptCount`是在初始`bind`的时候传给jdk的`bind`函数的，最终会传递到系统层。\n以`NioEndpoint`为例，大概如下：\n\n```java\n /**\n     * Initialize the endpoint.\n     */\n    @Override\n    public void bind() throws Exception {\n\n        serverSock = ServerSocketChannel.open();\n        socketProperties.setProperties(serverSock.socket());\n        InetSocketAddress addr = (getAddress()!=null?new InetSocketAddress(getAddress(),getPort()):new InetSocketAddress(getPort()));\n        serverSock.socket().bind(addr,getBacklog());\n        serverSock.configureBlocking(true); //mimic APR behavior\n        serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());\n\n        // Initialize thread count defaults for acceptor, poller\n        if (acceptorThreadCount == 0) {\n            // FIXME: Doesn't seem to work that well with multiple accept threads\n            acceptorThreadCount = 1;\n        }\n        if (pollerThreadCount <= 0) {\n            //minimum one poller thread\n            pollerThreadCount = 1;\n        }\n        stopLatch = new CountDownLatch(pollerThreadCount);\n\n        // Initialize SSL if needed\n        if (isSSLEnabled()) {\n           //ssl stuff\n           //...\n           //...\n        }\n\n        if (oomParachute>0) reclaimParachute(true);\n        selectorPool.open();\n    }\n```\n\n看下`getBackLog`的实现(`AbstractEndpoint`)：\n\n```java\n    /**\n     * Allows the server developer to specify the backlog that\n     * should be used for server sockets. By default, this value\n     * is 100.\n     */\n    private int backlog = 100;\n    public void setBacklog(int backlog) { if (backlog > 0) this.backlog = backlog; }\n    public int getBacklog() { return backlog; }\n```\n\n默认值大小是`100`。\n\n# 总结\n\ntomcat的`Acceptor`线程会不停的从系统的全连接队列里去拿对应的socket连接，直到达到了`maxConnections`的值。\n之后`Acceptor`会阻塞在那里，直到处理的连接小于`maxConnections`的值。如果一直阻塞的话，就会在系统的tcp\n连接队列中阻塞，这个队列的长度是`acceptCount`控制的，默认是`100`。如果仍然处理不过来，系统可能就会丢掉\n一些建立的连接了。\n\n所以，大致可以估计下最多能处理的连接数：\n\n`最大处理连接数 = acceptCount + maxConnection`\n\n#参考\n\n1. [tomcat的acceptCount与maxConnections - xixicat - SegmentFault](https://segmentfault.com/a/1190000008064162)\n\n2. [Apache Tomcat 7 Configuration Reference (7.0.77) - The HTTP Connector](https://tomcat.apache.org/tomcat-7.0-doc/config/http.html)\n\n","source":"_posts/tomcat-connection.md","raw":"---\ntitle: tomcat连接数相关的配置\ntags: connections\ncategory: tomcat\ntoc: true\nabbrlink: 44911\ndate: 2017-04-05 01:22:17\n---\n\n\n*以下是tomcat7的一些配置说明*\n\n# tomcat交互图\n\n{%  asset_img   tomcat-interaction.jpg  图片取自参考1 %}\n\n## maxConnections\n\ntomcat接受的最大连接的个数，超过这个连接个数，acceptor就会阻塞。\n\n> The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. This additional connection be blocked until the number of connections being processed falls below maxConnections at which point the server will start accepting and processing new connections again. Note that once the limit has been reached, the operating system may still accept connections based on the acceptCount setting. The default value varies by connector type. For BIO the default is the value of maxThreads unless an Executor is used in which case the default will be the value of maxThreads from the executor. For NIO the default is 10000. For APR/native, the default is 8192.\n\n需要注意的是，在BIO模式下，`maxConnections`的值默认等于`maxThreads`的值!!!\n\n达到maxConnections之后，acceptor线程就会阻塞，用jstack查看堆栈会发现Acceptor线程阻塞在下面的代码\n\n```bash\nsudo -u tomcat jstack  `pgrep -f 'tomcat'` | less\n```\n\ntomcat  7的源码中相应的代码\n\n```java\n                    //if we have reached max connections, wait\n                    countUpOrAwaitConnection();\n```\n\n函数的具体实现\n\n```java\n    protected void countUpOrAwaitConnection() throws InterruptedException {\n        if (maxConnections==-1) return;\n        LimitLatch latch = connectionLimitLatch;\n        if (latch!=null) latch.countUpOrAwait();\n    }\n```\n\n其中`LimitLatch`是tomcat自己实现的一个类似`CountDownLatch`的东西。\n\n```java\n/**\n * Shared latch that allows the latch to be acquired a limited number of times\n * after which all subsequent requests to acquire the latch will be placed in a\n * FIFO queue until one of the shares is returned.\n */\npublic class LimitLatch {...}\n```\n\n它的初始化过程：\n\n```java\n    protected LimitLatch initializeConnectionLatch() {\n        if (maxConnections==-1) return null;\n        if (connectionLimitLatch==null) {\n            connectionLimitLatch = new LimitLatch(getMaxConnections());\n        }\n        return connectionLimitLatch;\n    }\n```\n\n## maxThreads\n\ntomcat的连接线程最大个数。\n\n\n> The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled. If not specified, this attribute is set to 200. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.\n\n>maxThreads、minSpareThreads是tomcat工作线程池的配置参数，maxThreads就相当于jdk线程池的maxPoolSize，而minSpareThreads就相当于jdk线程池的corePoolSize。\n\n相应的代码如下：\n\n```java\n    public void createExecutor() {\n        internalExecutor = true;\n        TaskQueue taskqueue = new TaskQueue();\n        TaskThreadFactory tf = new TaskThreadFactory(getName() + \"-exec-\", daemon, getThreadPriority());\n        executor = new ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), 60, TimeUnit.SECONDS,taskqueue, tf);\n        taskqueue.setParent( (ThreadPoolExecutor) executor);\n    }\n```\n\n## acceptCount\n\n系统积压队列的大小。\n\n>The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.\n\ntomcat7的源码中有这么一段，大概就是别名的替换。`acceptCount`被替换成了`backlog`，`backlog`的意思是积压的东西。\n\n```java\n     static {\n         replacements.put(\"acceptCount\", \"backlog\");\n         replacements.put(\"connectionLinger\", \"soLinger\");\n         replacements.put(\"connectionTimeout\", \"soTimeout\");\n         replacements.put(\"rootFile\", \"rootfile\");\n     }\n```\n\n`acceptCount`是在初始`bind`的时候传给jdk的`bind`函数的，最终会传递到系统层。\n以`NioEndpoint`为例，大概如下：\n\n```java\n /**\n     * Initialize the endpoint.\n     */\n    @Override\n    public void bind() throws Exception {\n\n        serverSock = ServerSocketChannel.open();\n        socketProperties.setProperties(serverSock.socket());\n        InetSocketAddress addr = (getAddress()!=null?new InetSocketAddress(getAddress(),getPort()):new InetSocketAddress(getPort()));\n        serverSock.socket().bind(addr,getBacklog());\n        serverSock.configureBlocking(true); //mimic APR behavior\n        serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());\n\n        // Initialize thread count defaults for acceptor, poller\n        if (acceptorThreadCount == 0) {\n            // FIXME: Doesn't seem to work that well with multiple accept threads\n            acceptorThreadCount = 1;\n        }\n        if (pollerThreadCount <= 0) {\n            //minimum one poller thread\n            pollerThreadCount = 1;\n        }\n        stopLatch = new CountDownLatch(pollerThreadCount);\n\n        // Initialize SSL if needed\n        if (isSSLEnabled()) {\n           //ssl stuff\n           //...\n           //...\n        }\n\n        if (oomParachute>0) reclaimParachute(true);\n        selectorPool.open();\n    }\n```\n\n看下`getBackLog`的实现(`AbstractEndpoint`)：\n\n```java\n    /**\n     * Allows the server developer to specify the backlog that\n     * should be used for server sockets. By default, this value\n     * is 100.\n     */\n    private int backlog = 100;\n    public void setBacklog(int backlog) { if (backlog > 0) this.backlog = backlog; }\n    public int getBacklog() { return backlog; }\n```\n\n默认值大小是`100`。\n\n# 总结\n\ntomcat的`Acceptor`线程会不停的从系统的全连接队列里去拿对应的socket连接，直到达到了`maxConnections`的值。\n之后`Acceptor`会阻塞在那里，直到处理的连接小于`maxConnections`的值。如果一直阻塞的话，就会在系统的tcp\n连接队列中阻塞，这个队列的长度是`acceptCount`控制的，默认是`100`。如果仍然处理不过来，系统可能就会丢掉\n一些建立的连接了。\n\n所以，大致可以估计下最多能处理的连接数：\n\n`最大处理连接数 = acceptCount + maxConnection`\n\n#参考\n\n1. [tomcat的acceptCount与maxConnections - xixicat - SegmentFault](https://segmentfault.com/a/1190000008064162)\n\n2. [Apache Tomcat 7 Configuration Reference (7.0.77) - The HTTP Connector](https://tomcat.apache.org/tomcat-7.0-doc/config/http.html)\n\n","slug":"tomcat-connection","published":1,"updated":"2017-04-16T12:03:23.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdat009yjh4kmxf0orpa","content":"<p><em>以下是tomcat7的一些配置说明</em></p>\n<h1 id=\"tomcat交互图\"><a href=\"#tomcat交互图\" class=\"headerlink\" title=\"tomcat交互图\"></a>tomcat交互图</h1><img src=\"/2017/04/05/tomcat-connection/tomcat-interaction.jpg\" title=\"图片取自参考1\">\n<h2 id=\"maxConnections\"><a href=\"#maxConnections\" class=\"headerlink\" title=\"maxConnections\"></a>maxConnections</h2><p>tomcat接受的最大连接的个数，超过这个连接个数，acceptor就会阻塞。</p>\n<blockquote>\n<p>The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. This additional connection be blocked until the number of connections being processed falls below maxConnections at which point the server will start accepting and processing new connections again. Note that once the limit has been reached, the operating system may still accept connections based on the acceptCount setting. The default value varies by connector type. For BIO the default is the value of maxThreads unless an Executor is used in which case the default will be the value of maxThreads from the executor. For NIO the default is 10000. For APR/native, the default is 8192.</p>\n</blockquote>\n<p>需要注意的是，在BIO模式下，<code>maxConnections</code>的值默认等于<code>maxThreads</code>的值!!!</p>\n<p>达到maxConnections之后，acceptor线程就会阻塞，用jstack查看堆栈会发现Acceptor线程阻塞在下面的代码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat jstack  `pgrep -f <span class=\"string\">'tomcat'</span>` | less</span><br></pre></td></tr></table></figure>\n<p>tomcat  7的源码中相应的代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//if we have reached max connections, wait</span></span><br><span class=\"line\">countUpOrAwaitConnection();</span><br></pre></td></tr></table></figure>\n<p>函数的具体实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">countUpOrAwaitConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnections==-<span class=\"number\">1</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    LimitLatch latch = connectionLimitLatch;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (latch!=<span class=\"keyword\">null</span>) latch.countUpOrAwait();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>LimitLatch</code>是tomcat自己实现的一个类似<code>CountDownLatch</code>的东西。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Shared latch that allows the latch to be acquired a limited number of times</span></span><br><span class=\"line\"><span class=\"comment\"> * after which all subsequent requests to acquire the latch will be placed in a</span></span><br><span class=\"line\"><span class=\"comment\"> * FIFO queue until one of the shares is returned.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LimitLatch</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<p>它的初始化过程：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> LimitLatch <span class=\"title\">initializeConnectionLatch</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnections==-<span class=\"number\">1</span>) <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (connectionLimitLatch==<span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        connectionLimitLatch = <span class=\"keyword\">new</span> LimitLatch(getMaxConnections());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> connectionLimitLatch;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"maxThreads\"><a href=\"#maxThreads\" class=\"headerlink\" title=\"maxThreads\"></a>maxThreads</h2><p>tomcat的连接线程最大个数。</p>\n<blockquote>\n<p>The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled. If not specified, this attribute is set to 200. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.</p>\n<p>maxThreads、minSpareThreads是tomcat工作线程池的配置参数，maxThreads就相当于jdk线程池的maxPoolSize，而minSpareThreads就相当于jdk线程池的corePoolSize。</p>\n</blockquote>\n<p>相应的代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">createExecutor</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    internalExecutor = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    TaskQueue taskqueue = <span class=\"keyword\">new</span> TaskQueue();</span><br><span class=\"line\">    TaskThreadFactory tf = <span class=\"keyword\">new</span> TaskThreadFactory(getName() + <span class=\"string\">\"-exec-\"</span>, daemon, getThreadPriority());</span><br><span class=\"line\">    executor = <span class=\"keyword\">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class=\"number\">60</span>, TimeUnit.SECONDS,taskqueue, tf);</span><br><span class=\"line\">    taskqueue.setParent( (ThreadPoolExecutor) executor);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"acceptCount\"><a href=\"#acceptCount\" class=\"headerlink\" title=\"acceptCount\"></a>acceptCount</h2><p>系统积压队列的大小。</p>\n<blockquote>\n<p>The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.</p>\n</blockquote>\n<p>tomcat7的源码中有这么一段，大概就是别名的替换。<code>acceptCount</code>被替换成了<code>backlog</code>，<code>backlog</code>的意思是积压的东西。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"acceptCount\"</span>, <span class=\"string\">\"backlog\"</span>);</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"connectionLinger\"</span>, <span class=\"string\">\"soLinger\"</span>);</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"connectionTimeout\"</span>, <span class=\"string\">\"soTimeout\"</span>);</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"rootFile\"</span>, <span class=\"string\">\"rootfile\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>acceptCount</code>是在初始<code>bind</code>的时候传给jdk的<code>bind</code>函数的，最终会传递到系统层。<br>以<code>NioEndpoint</code>为例，大概如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Initialize the endpoint.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">bind</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       serverSock = ServerSocketChannel.open();</span><br><span class=\"line\">       socketProperties.setProperties(serverSock.socket());</span><br><span class=\"line\">       InetSocketAddress addr = (getAddress()!=<span class=\"keyword\">null</span>?<span class=\"keyword\">new</span> InetSocketAddress(getAddress(),getPort()):<span class=\"keyword\">new</span> InetSocketAddress(getPort()));</span><br><span class=\"line\">       serverSock.socket().bind(addr,getBacklog());</span><br><span class=\"line\">       serverSock.configureBlocking(<span class=\"keyword\">true</span>); <span class=\"comment\">//mimic APR behavior</span></span><br><span class=\"line\">       serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// Initialize thread count defaults for acceptor, poller</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (acceptorThreadCount == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> Doesn't seem to work that well with multiple accept threads</span></span><br><span class=\"line\">           acceptorThreadCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (pollerThreadCount &lt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">           <span class=\"comment\">//minimum one poller thread</span></span><br><span class=\"line\">           pollerThreadCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       stopLatch = <span class=\"keyword\">new</span> CountDownLatch(pollerThreadCount);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// Initialize SSL if needed</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isSSLEnabled()) &#123;</span><br><span class=\"line\">          <span class=\"comment\">//ssl stuff</span></span><br><span class=\"line\">          <span class=\"comment\">//...</span></span><br><span class=\"line\">          <span class=\"comment\">//...</span></span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (oomParachute&gt;<span class=\"number\">0</span>) reclaimParachute(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">       selectorPool.open();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>看下<code>getBackLog</code>的实现(<code>AbstractEndpoint</code>)：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Allows the server developer to specify the backlog that</span></span><br><span class=\"line\"><span class=\"comment\"> * should be used for server sockets. By default, this value</span></span><br><span class=\"line\"><span class=\"comment\"> * is 100.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> backlog = <span class=\"number\">100</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setBacklog</span><span class=\"params\">(<span class=\"keyword\">int</span> backlog)</span> </span>&#123; <span class=\"keyword\">if</span> (backlog &gt; <span class=\"number\">0</span>) <span class=\"keyword\">this</span>.backlog = backlog; &#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getBacklog</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> backlog; &#125;</span><br></pre></td></tr></table></figure>\n<p>默认值大小是<code>100</code>。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>tomcat的<code>Acceptor</code>线程会不停的从系统的全连接队列里去拿对应的socket连接，直到达到了<code>maxConnections</code>的值。<br>之后<code>Acceptor</code>会阻塞在那里，直到处理的连接小于<code>maxConnections</code>的值。如果一直阻塞的话，就会在系统的tcp<br>连接队列中阻塞，这个队列的长度是<code>acceptCount</code>控制的，默认是<code>100</code>。如果仍然处理不过来，系统可能就会丢掉<br>一些建立的连接了。</p>\n<p>所以，大致可以估计下最多能处理的连接数：</p>\n<p><code>最大处理连接数 = acceptCount + maxConnection</code></p>\n<p>#参考</p>\n<ol>\n<li><p><a href=\"https://segmentfault.com/a/1190000008064162\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">tomcat的acceptCount与maxConnections - xixicat - SegmentFault</a></p>\n</li>\n<li><p><a href=\"https://tomcat.apache.org/tomcat-7.0-doc/config/http.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Apache Tomcat 7 Configuration Reference (7.0.77) - The HTTP Connector</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p><em>以下是tomcat7的一些配置说明</em></p>\n<h1 id=\"tomcat交互图\"><a href=\"#tomcat交互图\" class=\"headerlink\" title=\"tomcat交互图\"></a>tomcat交互图</h1><img src=\"/2017/04/05/tomcat-connection/tomcat-interaction.jpg\" title=\"图片取自参考1\">\n<h2 id=\"maxConnections\"><a href=\"#maxConnections\" class=\"headerlink\" title=\"maxConnections\"></a>maxConnections</h2><p>tomcat接受的最大连接的个数，超过这个连接个数，acceptor就会阻塞。</p>\n<blockquote>\n<p>The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. This additional connection be blocked until the number of connections being processed falls below maxConnections at which point the server will start accepting and processing new connections again. Note that once the limit has been reached, the operating system may still accept connections based on the acceptCount setting. The default value varies by connector type. For BIO the default is the value of maxThreads unless an Executor is used in which case the default will be the value of maxThreads from the executor. For NIO the default is 10000. For APR/native, the default is 8192.</p>\n</blockquote>\n<p>需要注意的是，在BIO模式下，<code>maxConnections</code>的值默认等于<code>maxThreads</code>的值!!!</p>\n<p>达到maxConnections之后，acceptor线程就会阻塞，用jstack查看堆栈会发现Acceptor线程阻塞在下面的代码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo -u tomcat jstack  `pgrep -f <span class=\"string\">'tomcat'</span>` | less</span><br></pre></td></tr></table></figure>\n<p>tomcat  7的源码中相应的代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//if we have reached max connections, wait</span></span><br><span class=\"line\">countUpOrAwaitConnection();</span><br></pre></td></tr></table></figure>\n<p>函数的具体实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">countUpOrAwaitConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnections==-<span class=\"number\">1</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    LimitLatch latch = connectionLimitLatch;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (latch!=<span class=\"keyword\">null</span>) latch.countUpOrAwait();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>LimitLatch</code>是tomcat自己实现的一个类似<code>CountDownLatch</code>的东西。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Shared latch that allows the latch to be acquired a limited number of times</span></span><br><span class=\"line\"><span class=\"comment\"> * after which all subsequent requests to acquire the latch will be placed in a</span></span><br><span class=\"line\"><span class=\"comment\"> * FIFO queue until one of the shares is returned.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LimitLatch</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<p>它的初始化过程：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> LimitLatch <span class=\"title\">initializeConnectionLatch</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (maxConnections==-<span class=\"number\">1</span>) <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (connectionLimitLatch==<span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        connectionLimitLatch = <span class=\"keyword\">new</span> LimitLatch(getMaxConnections());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> connectionLimitLatch;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"maxThreads\"><a href=\"#maxThreads\" class=\"headerlink\" title=\"maxThreads\"></a>maxThreads</h2><p>tomcat的连接线程最大个数。</p>\n<blockquote>\n<p>The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled. If not specified, this attribute is set to 200. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.</p>\n<p>maxThreads、minSpareThreads是tomcat工作线程池的配置参数，maxThreads就相当于jdk线程池的maxPoolSize，而minSpareThreads就相当于jdk线程池的corePoolSize。</p>\n</blockquote>\n<p>相应的代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">createExecutor</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    internalExecutor = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    TaskQueue taskqueue = <span class=\"keyword\">new</span> TaskQueue();</span><br><span class=\"line\">    TaskThreadFactory tf = <span class=\"keyword\">new</span> TaskThreadFactory(getName() + <span class=\"string\">\"-exec-\"</span>, daemon, getThreadPriority());</span><br><span class=\"line\">    executor = <span class=\"keyword\">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class=\"number\">60</span>, TimeUnit.SECONDS,taskqueue, tf);</span><br><span class=\"line\">    taskqueue.setParent( (ThreadPoolExecutor) executor);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"acceptCount\"><a href=\"#acceptCount\" class=\"headerlink\" title=\"acceptCount\"></a>acceptCount</h2><p>系统积压队列的大小。</p>\n<blockquote>\n<p>The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.</p>\n</blockquote>\n<p>tomcat7的源码中有这么一段，大概就是别名的替换。<code>acceptCount</code>被替换成了<code>backlog</code>，<code>backlog</code>的意思是积压的东西。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"acceptCount\"</span>, <span class=\"string\">\"backlog\"</span>);</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"connectionLinger\"</span>, <span class=\"string\">\"soLinger\"</span>);</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"connectionTimeout\"</span>, <span class=\"string\">\"soTimeout\"</span>);</span><br><span class=\"line\">    replacements.put(<span class=\"string\">\"rootFile\"</span>, <span class=\"string\">\"rootfile\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>acceptCount</code>是在初始<code>bind</code>的时候传给jdk的<code>bind</code>函数的，最终会传递到系统层。<br>以<code>NioEndpoint</code>为例，大概如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Initialize the endpoint.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">bind</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       serverSock = ServerSocketChannel.open();</span><br><span class=\"line\">       socketProperties.setProperties(serverSock.socket());</span><br><span class=\"line\">       InetSocketAddress addr = (getAddress()!=<span class=\"keyword\">null</span>?<span class=\"keyword\">new</span> InetSocketAddress(getAddress(),getPort()):<span class=\"keyword\">new</span> InetSocketAddress(getPort()));</span><br><span class=\"line\">       serverSock.socket().bind(addr,getBacklog());</span><br><span class=\"line\">       serverSock.configureBlocking(<span class=\"keyword\">true</span>); <span class=\"comment\">//mimic APR behavior</span></span><br><span class=\"line\">       serverSock.socket().setSoTimeout(getSocketProperties().getSoTimeout());</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// Initialize thread count defaults for acceptor, poller</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (acceptorThreadCount == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">           <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> Doesn't seem to work that well with multiple accept threads</span></span><br><span class=\"line\">           acceptorThreadCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (pollerThreadCount &lt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">           <span class=\"comment\">//minimum one poller thread</span></span><br><span class=\"line\">           pollerThreadCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       stopLatch = <span class=\"keyword\">new</span> CountDownLatch(pollerThreadCount);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// Initialize SSL if needed</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (isSSLEnabled()) &#123;</span><br><span class=\"line\">          <span class=\"comment\">//ssl stuff</span></span><br><span class=\"line\">          <span class=\"comment\">//...</span></span><br><span class=\"line\">          <span class=\"comment\">//...</span></span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">if</span> (oomParachute&gt;<span class=\"number\">0</span>) reclaimParachute(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">       selectorPool.open();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>看下<code>getBackLog</code>的实现(<code>AbstractEndpoint</code>)：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Allows the server developer to specify the backlog that</span></span><br><span class=\"line\"><span class=\"comment\"> * should be used for server sockets. By default, this value</span></span><br><span class=\"line\"><span class=\"comment\"> * is 100.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> backlog = <span class=\"number\">100</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setBacklog</span><span class=\"params\">(<span class=\"keyword\">int</span> backlog)</span> </span>&#123; <span class=\"keyword\">if</span> (backlog &gt; <span class=\"number\">0</span>) <span class=\"keyword\">this</span>.backlog = backlog; &#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getBacklog</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> backlog; &#125;</span><br></pre></td></tr></table></figure>\n<p>默认值大小是<code>100</code>。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>tomcat的<code>Acceptor</code>线程会不停的从系统的全连接队列里去拿对应的socket连接，直到达到了<code>maxConnections</code>的值。<br>之后<code>Acceptor</code>会阻塞在那里，直到处理的连接小于<code>maxConnections</code>的值。如果一直阻塞的话，就会在系统的tcp<br>连接队列中阻塞，这个队列的长度是<code>acceptCount</code>控制的，默认是<code>100</code>。如果仍然处理不过来，系统可能就会丢掉<br>一些建立的连接了。</p>\n<p>所以，大致可以估计下最多能处理的连接数：</p>\n<p><code>最大处理连接数 = acceptCount + maxConnection</code></p>\n<p>#参考</p>\n<ol>\n<li><p><a href=\"https://segmentfault.com/a/1190000008064162\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">tomcat的acceptCount与maxConnections - xixicat - SegmentFault</a></p>\n</li>\n<li><p><a href=\"https://tomcat.apache.org/tomcat-7.0-doc/config/http.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Apache Tomcat 7 Configuration Reference (7.0.77) - The HTTP Connector</a></p>\n</li>\n</ol>\n"},{"title":"tomcat中的StringManager","toc":true,"abbrlink":27008,"date":"2017-02-05T16:45:02.000Z","_content":"\n\ntomcat中使用StringManager来管理错误提示信息，错误信息存储在`LocalStrings.properties`文件中，支持包级别的文件配置。\n\n\n## StringManager\n\n构造函数私有，通过静态方法`getManager`获取对应package的实例\n\n```java\n\n    private static final Hashtable<String, StringManager> managers =\n            new Hashtable<>();\n\n    /**\n     * Get the StringManager for a particular package. If a manager for\n     * a package already exists, it will be reused, else a new\n     * StringManager will be created and returned.\n     *\n     * @param packageName The package name\n     */\n    public static final synchronized StringManager getManager(String packageName) {\n        StringManager mgr = managers.get(packageName);\n        if (mgr == null) {\n            mgr = new StringManager(packageName);\n            managers.put(packageName, mgr);\n        }\n        return mgr;\n    }\n```\n\n## LocalStrings\n\n本身支持国际化(i18n), LocalStrings.properties（英文）、LocalStrings_es.properties（西班牙语）、LocalStrings_ja.properties（日语）\n\n文件示例：\n\n```\ncontextBindings.unknownContext=Unknown context name : {0}\ncontextBindings.noContextBoundToThread=No naming context bound to this thread\ncontextBindings.noContextBoundToCL=No naming context bound to this class loader\nselectorContext.noJavaUrl=This context must be accessed through a java: URL\nselectorContext.methodUsingName=Call to method ''{0}'' with a Name of ''{1}''\n```\n\n## 参考\n\n1. 《How tomcat works》","source":"_posts/tomcat-stringmanager.md","raw":"---\ntitle: tomcat中的StringManager\ntags: string-manager\ncategory: tomcat\ntoc: true\nabbrlink: 27008\ndate: 2017-02-06 00:45:02\n---\n\n\ntomcat中使用StringManager来管理错误提示信息，错误信息存储在`LocalStrings.properties`文件中，支持包级别的文件配置。\n\n\n## StringManager\n\n构造函数私有，通过静态方法`getManager`获取对应package的实例\n\n```java\n\n    private static final Hashtable<String, StringManager> managers =\n            new Hashtable<>();\n\n    /**\n     * Get the StringManager for a particular package. If a manager for\n     * a package already exists, it will be reused, else a new\n     * StringManager will be created and returned.\n     *\n     * @param packageName The package name\n     */\n    public static final synchronized StringManager getManager(String packageName) {\n        StringManager mgr = managers.get(packageName);\n        if (mgr == null) {\n            mgr = new StringManager(packageName);\n            managers.put(packageName, mgr);\n        }\n        return mgr;\n    }\n```\n\n## LocalStrings\n\n本身支持国际化(i18n), LocalStrings.properties（英文）、LocalStrings_es.properties（西班牙语）、LocalStrings_ja.properties（日语）\n\n文件示例：\n\n```\ncontextBindings.unknownContext=Unknown context name : {0}\ncontextBindings.noContextBoundToThread=No naming context bound to this thread\ncontextBindings.noContextBoundToCL=No naming context bound to this class loader\nselectorContext.noJavaUrl=This context must be accessed through a java: URL\nselectorContext.methodUsingName=Call to method ''{0}'' with a Name of ''{1}''\n```\n\n## 参考\n\n1. 《How tomcat works》","slug":"tomcat-stringmanager","published":1,"updated":"2017-04-16T12:04:30.014Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdau00a1jh4kv04ex9re","content":"<p>tomcat中使用StringManager来管理错误提示信息，错误信息存储在<code>LocalStrings.properties</code>文件中，支持包级别的文件配置。</p>\n<h2 id=\"StringManager\"><a href=\"#StringManager\" class=\"headerlink\" title=\"StringManager\"></a>StringManager</h2><p>构造函数私有，通过静态方法<code>getManager</code>获取对应package的实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Hashtable&lt;String, StringManager&gt; managers =</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Hashtable&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Get the StringManager for a particular package. If a manager for</span></span><br><span class=\"line\"><span class=\"comment\"> * a package already exists, it will be reused, else a new</span></span><br><span class=\"line\"><span class=\"comment\"> * StringManager will be created and returned.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> packageName The package name</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">synchronized</span> StringManager <span class=\"title\">getManager</span><span class=\"params\">(String packageName)</span> </span>&#123;</span><br><span class=\"line\">    StringManager mgr = managers.get(packageName);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mgr == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        mgr = <span class=\"keyword\">new</span> StringManager(packageName);</span><br><span class=\"line\">        managers.put(packageName, mgr);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mgr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"LocalStrings\"><a href=\"#LocalStrings\" class=\"headerlink\" title=\"LocalStrings\"></a>LocalStrings</h2><p>本身支持国际化(i18n), LocalStrings.properties（英文）、LocalStrings_es.properties（西班牙语）、LocalStrings_ja.properties（日语）</p>\n<p>文件示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contextBindings.unknownContext=Unknown context name : &#123;0&#125;</span><br><span class=\"line\">contextBindings.noContextBoundToThread=No naming context bound to this thread</span><br><span class=\"line\">contextBindings.noContextBoundToCL=No naming context bound to this class loader</span><br><span class=\"line\">selectorContext.noJavaUrl=This context must be accessed through a java: URL</span><br><span class=\"line\">selectorContext.methodUsingName=Call to method &apos;&apos;&#123;0&#125;&apos;&apos; with a Name of &apos;&apos;&#123;1&#125;&apos;&apos;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li>《How tomcat works》</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>tomcat中使用StringManager来管理错误提示信息，错误信息存储在<code>LocalStrings.properties</code>文件中，支持包级别的文件配置。</p>\n<h2 id=\"StringManager\"><a href=\"#StringManager\" class=\"headerlink\" title=\"StringManager\"></a>StringManager</h2><p>构造函数私有，通过静态方法<code>getManager</code>获取对应package的实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Hashtable&lt;String, StringManager&gt; managers =</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Hashtable&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Get the StringManager for a particular package. If a manager for</span></span><br><span class=\"line\"><span class=\"comment\"> * a package already exists, it will be reused, else a new</span></span><br><span class=\"line\"><span class=\"comment\"> * StringManager will be created and returned.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> packageName The package name</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">synchronized</span> StringManager <span class=\"title\">getManager</span><span class=\"params\">(String packageName)</span> </span>&#123;</span><br><span class=\"line\">    StringManager mgr = managers.get(packageName);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mgr == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        mgr = <span class=\"keyword\">new</span> StringManager(packageName);</span><br><span class=\"line\">        managers.put(packageName, mgr);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mgr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"LocalStrings\"><a href=\"#LocalStrings\" class=\"headerlink\" title=\"LocalStrings\"></a>LocalStrings</h2><p>本身支持国际化(i18n), LocalStrings.properties（英文）、LocalStrings_es.properties（西班牙语）、LocalStrings_ja.properties（日语）</p>\n<p>文件示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contextBindings.unknownContext=Unknown context name : &#123;0&#125;</span><br><span class=\"line\">contextBindings.noContextBoundToThread=No naming context bound to this thread</span><br><span class=\"line\">contextBindings.noContextBoundToCL=No naming context bound to this class loader</span><br><span class=\"line\">selectorContext.noJavaUrl=This context must be accessed through a java: URL</span><br><span class=\"line\">selectorContext.methodUsingName=Call to method &apos;&apos;&#123;0&#125;&apos;&apos; with a Name of &apos;&apos;&#123;1&#125;&apos;&apos;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li>《How tomcat works》</li>\n</ol>\n"},{"title":"web.xml","toc":true,"abbrlink":46674,"_content":"\n## load-on-startup标签\n\n> Servlets are initialized either lazily at request processing time or eagerly during\ndeployment. In the latter case, they are initialized in the order indicated by\ntheir load-on-startup elements.\n\n在web容器启动的时候，可以采用`lazily`加载的方式和`eagerly`的方式。\n\n`load-on-startup`中的值决定了进行哪种方式。\n\n> If the value is a negative integer, or the element is not present, the\ncontainer is free to load the servlet whenever it chooses. If the value is a positive\ninteger or 0, the container must load and initialize the servlet as the application is\ndeployed.\n\n如果<load-on-startup>这个元素没有出现，或者出现了但是里面的值是负的，容器可以按照自己的需要选择加载Servlet的时机。\n\n如果里面的值是正数或者0，容器必须保证在容器启动的时候加载和初始化这个servlet\n\n>  The container must guarantee that servlets marked with lower integers\nare loaded before servlets marked with higher integers.\n\n这个值越小，优先级越高，容器优先加载。\n\n> The container may choose\nthe order of loading of servlets with the same load-on-startup value.\n\n如果里面的值是一样的，那么加载的顺序由容器来决定（不同实现可能不同）\n\n\n# 参考\n\n1. Java Servlet Specification 3.0\n","source":"_posts/web-xml.md","raw":"---\ntitle: web.xml\ntoc: true\ntags: servlet\ncategory: tomcat\nabbrlink: 46674\n---\n\n## load-on-startup标签\n\n> Servlets are initialized either lazily at request processing time or eagerly during\ndeployment. In the latter case, they are initialized in the order indicated by\ntheir load-on-startup elements.\n\n在web容器启动的时候，可以采用`lazily`加载的方式和`eagerly`的方式。\n\n`load-on-startup`中的值决定了进行哪种方式。\n\n> If the value is a negative integer, or the element is not present, the\ncontainer is free to load the servlet whenever it chooses. If the value is a positive\ninteger or 0, the container must load and initialize the servlet as the application is\ndeployed.\n\n如果<load-on-startup>这个元素没有出现，或者出现了但是里面的值是负的，容器可以按照自己的需要选择加载Servlet的时机。\n\n如果里面的值是正数或者0，容器必须保证在容器启动的时候加载和初始化这个servlet\n\n>  The container must guarantee that servlets marked with lower integers\nare loaded before servlets marked with higher integers.\n\n这个值越小，优先级越高，容器优先加载。\n\n> The container may choose\nthe order of loading of servlets with the same load-on-startup value.\n\n如果里面的值是一样的，那么加载的顺序由容器来决定（不同实现可能不同）\n\n\n# 参考\n\n1. Java Servlet Specification 3.0\n","slug":"web-xml","published":1,"date":"2018-03-15T00:42:03.233Z","updated":"2017-04-16T12:04:59.114Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdav00a3jh4k3hu16ebj","content":"<h2 id=\"load-on-startup标签\"><a href=\"#load-on-startup标签\" class=\"headerlink\" title=\"load-on-startup标签\"></a>load-on-startup标签</h2><blockquote>\n<p>Servlets are initialized either lazily at request processing time or eagerly during<br>deployment. In the latter case, they are initialized in the order indicated by<br>their load-on-startup elements.</p>\n</blockquote>\n<p>在web容器启动的时候，可以采用<code>lazily</code>加载的方式和<code>eagerly</code>的方式。</p>\n<p><code>load-on-startup</code>中的值决定了进行哪种方式。</p>\n<blockquote>\n<p>If the value is a negative integer, or the element is not present, the<br>container is free to load the servlet whenever it chooses. If the value is a positive<br>integer or 0, the container must load and initialize the servlet as the application is<br>deployed.</p>\n</blockquote>\n<p>如果<load-on-startup>这个元素没有出现，或者出现了但是里面的值是负的，容器可以按照自己的需要选择加载Servlet的时机。</load-on-startup></p>\n<p>如果里面的值是正数或者0，容器必须保证在容器启动的时候加载和初始化这个servlet</p>\n<blockquote>\n<p> The container must guarantee that servlets marked with lower integers<br>are loaded before servlets marked with higher integers.</p>\n</blockquote>\n<p>这个值越小，优先级越高，容器优先加载。</p>\n<blockquote>\n<p>The container may choose<br>the order of loading of servlets with the same load-on-startup value.</p>\n</blockquote>\n<p>如果里面的值是一样的，那么加载的顺序由容器来决定（不同实现可能不同）</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li>Java Servlet Specification 3.0</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"load-on-startup标签\"><a href=\"#load-on-startup标签\" class=\"headerlink\" title=\"load-on-startup标签\"></a>load-on-startup标签</h2><blockquote>\n<p>Servlets are initialized either lazily at request processing time or eagerly during<br>deployment. In the latter case, they are initialized in the order indicated by<br>their load-on-startup elements.</p>\n</blockquote>\n<p>在web容器启动的时候，可以采用<code>lazily</code>加载的方式和<code>eagerly</code>的方式。</p>\n<p><code>load-on-startup</code>中的值决定了进行哪种方式。</p>\n<blockquote>\n<p>If the value is a negative integer, or the element is not present, the<br>container is free to load the servlet whenever it chooses. If the value is a positive<br>integer or 0, the container must load and initialize the servlet as the application is<br>deployed.</p>\n</blockquote>\n<p>如果<load-on-startup>这个元素没有出现，或者出现了但是里面的值是负的，容器可以按照自己的需要选择加载Servlet的时机。</load-on-startup></p>\n<p>如果里面的值是正数或者0，容器必须保证在容器启动的时候加载和初始化这个servlet</p>\n<blockquote>\n<p> The container must guarantee that servlets marked with lower integers<br>are loaded before servlets marked with higher integers.</p>\n</blockquote>\n<p>这个值越小，优先级越高，容器优先加载。</p>\n<blockquote>\n<p>The container may choose<br>the order of loading of servlets with the same load-on-startup value.</p>\n</blockquote>\n<p>如果里面的值是一样的，那么加载的顺序由容器来决定（不同实现可能不同）</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li>Java Servlet Specification 3.0</li>\n</ol>\n"},{"title":"top用法","toc":true,"date":"2017-09-09T09:31:18.000Z","_content":"\n\n\n# 使用\n\n## 基本用法\n\ntop是了解系统状况最常用的命令，从top的输出我们可以很好的掌握系统的CPU, 内存，swap，进程的相关信息。\n\n下面说下top的基本用法：\n\n<BR><BR>\n\n``` bash\n[qisheng.li@xxx /home/www/xxx]$ sudo top\n\ntop - 15:19:54 up 200 days,  4:06,  1 user,  load average: 5.91, 6.14, 5.57\nTasks: 499 total,   1 running, 498 sleeping,   0 stopped,   0 zombie\nCpu(s): 20.1%us,  1.2%sy,  0.0%ni, 78.4%id,  0.0%wa,  0.0%hi,  0.4%si,  0.0%st\nMem:  65979844k total, 65004736k used,   975108k free,     8108k buffers\nSwap: 50331644k total,    29364k used, 50302280k free,  5530672k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            \n 8468 tomcat    20   0 71.2g  55g 6484 S 492.3 87.8  32033:12 java                                                                              \n 1256 tomcat    20   0 6055m 251m 2504 S 24.9  0.4  41886:22 java                                                                               \n 2446 root      20   0 15304 1568  928 R  0.7  0.0   0:00.11 top                                                                                \n30593 root      20   0  526m  31m 3208 S  0.3  0.0   0:15.41 salt-minion                                                                        \n    1 root      20   0 19232  632  384 S  0.0  0.0  11:49.23 init                                                                               \n    2 root      20   0     0    0    0 S  0.0  0.0   0:00.32 kthreadd                                                                           \n    3 root      RT   0     0    0    0 S  0.0  0.0   2:55.22 migration/0                                                                        \n    4 root      20   0     0    0    0 S  0.0  0.0   5:49.74 ksoftirqd/0                                                                        \n    5 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 stopper/0  \n```\n\n### 系统概况\n\n 从输出的第一行来看， 首先是系统的uptime信息(使用`uptime`也可以查看)， 可以看到系统已经运行了200天了，是在`15：19：54`这个时间点启动起来的， `4：06` 是当前的时间， 当前只有一个用户登录(使用`w`也可以查看当前的登录用户)。 还有就是系统的负载——load average，这个有三个值，分别是1分钟的平均负载， 5分钟的， 15分钟的（`uptime`的输出信息中也有这个）。\n\n 第二行包含了系统进程的一些统计信息，Tasks是运行队列中的任务个数（Linux run-queue）， 还有一些其他状态的进程的个数信息\n\n > - **running**:  CPU 上运行的和将要被调度运行的；\n\n> - **sleeping**: 通常是等待事件(比如 IO 操作)完成的任务，细分可以包括 interruptible 和 uninterruptible 的类型；\n\n> - **stopped**: 是一些被暂停的任务，通常发送 SIGSTOP 或者对一个前台任务操作 Ctrl-Z 可以将其暂停；\n\n> - **zombie**: 僵尸任务，虽然进程终止资源会被自动回收，但是含有退出任务的 task descriptor 需要父进程访问后才能释放，这种进程显示为 `defunct` 状态，无论是因为父进程提前退出还是未 wait 调用，出现这种进程都应该格外注意程序是否设计有误。\n\n### CPU\n\n 第三行是CPU的一些信息，各个部分的占用都很明确。\n\n> - (us) user：CPU 在低 nice 值(高优先级)用户态所占用的时间(nice<=0)。正常情况下只要服务器不是很闲，那么大部分的 CPU 时间应该都在此执行这类程序\n\n> - (sy) system：CPU 处于内核态所占用的时间，操作系统通过系统调用(system call)从用户态陷入内核态，以执行特定的服务；通常情况下该值会比较小，但是当服务器执行的 IO 比较密集的时候，该值会比较大\n\n> - (ni) nice：CPU 在高 nice 值(低优先级)用户态以低优先级运行占用的时间(nice>0)。默认新启动的进程 nice=0，是不会计入这里的，除非手动通过 renice 或者 setpriority() 的方式修改程序的nice值\n\n> - (id) idle：CPU 在空闲状态(执行 kernel idle handler )所占用的时间\n\n> - (wa) iowait：等待 IO 完成做占用的时间\n\n> - (hi) irq：系统处理硬件中断所消耗的时间\n\n> - (si) softirq：系统处理软中断所消耗的时间，记住软中断分为 softirqs、tasklets (其实是前者的特例)、work queues，不知道这里是统计的是哪些的时间，毕竟 work queues 的执行已经不是中断上下文了\n\n> - (st) steal：在虚拟机情况下才有意义，因为虚拟机下 CPU 也是共享物理 CPU 的，所以这段时间表明虚拟机等待 hypervisor 调度 CPU 的时间，也意味着这段时间 hypervisor 将 CPU 调度给别的 CPU 执行，这个时段的 CPU 资源被“stolen”了。这个值在我 KVM 的 VPS 机器上是不为 0 的，但也只有 0.1 这个数量级，是不是可以用来判断 VPS 超售的情况？\n\niowait所包含的信息其实是非常少的，具体的解释可以看**参考3**中的文章，讲的非常好.\n\n> %iowait 表示在一个采样周期内有百分之几的时间属于以下情况：CPU空闲、并且有仍未完成的I/O请求\n\n### 内存\n\n第四行主要是内存使用的相关信息， 系统的内存总共有`65979844k`， 已经使用` 65004736k`, `975108k`可用， `8108k`缓存, \n\n65979844k = 65004736k + 975108k\n\n可见缓存的也包含在可用的内存中。\n\n这些信息也可以通过`free -k` （还可以-m, -g 表示展示的单位），`free`的输出如下:\n\n```bash\n[qisheng.li@xxx /home/www/xxx]$ free -k\n             total       used       free     shared    buffers     cached\nMem:      65979844   64863960    1115884        112       8824    5331160\n-/+ buffers/cache:   59523976    6455868 \nSwap:     50331644      29364   50302280 \n```\n\n`vmstat` 也可以看到系统的内存状况：\n\n```bash\n[qisheng.li@xxx /home/www/xxx]$ vmstat 1 3 | column -t\nprocs  -----------memory----------  ---swap--  -----io----  --system--  -----cpu-----\nr      b                            swpd       free         buff        cache          si  so  bi   bo   in     cs     us  sy  id  wa  st\n5      1                            29364      2231704      8808        4214104        0   0   124  230  0      0      15  1   84  0   0\n6      0                            29364      2219016      8908        4225260        0   0   668  132  47040  68271  25  2   72  0   0\n5      0                            29364      2209552      8916        4234020        0   0   512  12   37178  52578  20  2   78  0   0\n\n```\n\n第五行和第四行类似，输出的是swap的使用情况。\n\n\n### 进程的详细信息\n\n> PID：进程的ID\n> USER：进程所有者\n> PR：进程的优先级别，越小越优先被执行\n> NI：nice值\n> VIRT：进程占用的虚拟内存\n> RES：进程占用的物理内存\n> SHR：进程使用的共享内存\n> S：进程的状态。S表示休眠，R表示正在运行，Z表示僵死状态，N表示该进程优先值为负数\n> %CPU：进程占用CPU的使用率\n> %MEM：进程使用的物理内存和总内存的百分比\n> TIME+：该进程启动后占用的总的CPU时间，即占用CPU使用时间的累加值。\n> COMMAND：进程启动命令名称\n\n## 高级用法\n\n### 交互命令\n\n- 按照CPU占用排序： 交互模式下输入： `P`\n\n- 按照内存排序： 交互模式下输入： `M`\n\n- 杀死进程： 交互模式下输入: `k`, 然后根据提示输入相应的`pid`\n\n- 更改刷新时间： 交互模式下输入: `d`或者`s`, 然后输入相应的刷新值\n\n- 显示CPU的每个核的使用情况： 交互模式下输入： 键盘上的`1`\n\ntop的显示界面会展开：\n\n{% asset_img  cpu.png %}\n\n- 高亮模式： 交互模式下输入: 'z'\n\n{% asset_img  highlight.png %}\n\n- 高亮当前的排序列(需要在z模式下)： 交互模式下输入: 'x'\n\n{% asset_img  highlight-sort.png %}\n\n- 改变排序列： 交互模式下按`shift` + `<`或`>`\n\n- 增加显示的Field： 交互模式下按`f`, 然后选择想要展示的列\n\n{% asset_img  fields.png %}\n\n- 显示到线程级别： 交互模式下按`H`\n\n- 显示完整的命令名称: 交互模式下按`c`\n\n- 分类显示各种系统资源高的进程： 交互模式下按`A`\n\n{% asset_img top-a.png %}\n\n### 命令行参数\n\n- 显示某个进程的线程信息\n\n`top -p <PID> -H`\n\n其中 `-H`是指显示线程的信息，可以看到每个线程的CPU占用情况\n\n{% asset_img top-thread.png %}\n\n- 显示完整的命令： `-c`\n\n\n# 参考\n\n1. [top实践小技巧 - OPS Notes By 枯木](http://kumu-linux.github.io/blog/2013/06/07/top-hacks/)\n\n2. [Linux服务器的那些性能参数指标](http://mp.weixin.qq.com/s?__biz=MzAxMzQ3NzQ3Nw==&mid=2654249787&idx=2&sn=7aa8e765fda84d5fa26580c210585c53&chksm=8061f031b716792776833370019a9fc4c79fa40ea7db5b4ccb165b90919056acaffd3d971d94&mpshare=1&scene=1&srcid=0801QspCI2Xo04BsZlP6pCVb##)\n\n3. [理解 %iowait (%wio) | Linux Performance](http://linuxperf.com/?p=33)\n\n4. [8. top linux下的任务管理器 — Linux Tools Quick Tutorial](http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/top.html)\n","source":"_posts/top.md","raw":"title: top用法\ntags: top\ncategory: linux\ntoc: true\ndate: 2017-09-09 17:31:18\n---\n\n\n\n# 使用\n\n## 基本用法\n\ntop是了解系统状况最常用的命令，从top的输出我们可以很好的掌握系统的CPU, 内存，swap，进程的相关信息。\n\n下面说下top的基本用法：\n\n<BR><BR>\n\n``` bash\n[qisheng.li@xxx /home/www/xxx]$ sudo top\n\ntop - 15:19:54 up 200 days,  4:06,  1 user,  load average: 5.91, 6.14, 5.57\nTasks: 499 total,   1 running, 498 sleeping,   0 stopped,   0 zombie\nCpu(s): 20.1%us,  1.2%sy,  0.0%ni, 78.4%id,  0.0%wa,  0.0%hi,  0.4%si,  0.0%st\nMem:  65979844k total, 65004736k used,   975108k free,     8108k buffers\nSwap: 50331644k total,    29364k used, 50302280k free,  5530672k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            \n 8468 tomcat    20   0 71.2g  55g 6484 S 492.3 87.8  32033:12 java                                                                              \n 1256 tomcat    20   0 6055m 251m 2504 S 24.9  0.4  41886:22 java                                                                               \n 2446 root      20   0 15304 1568  928 R  0.7  0.0   0:00.11 top                                                                                \n30593 root      20   0  526m  31m 3208 S  0.3  0.0   0:15.41 salt-minion                                                                        \n    1 root      20   0 19232  632  384 S  0.0  0.0  11:49.23 init                                                                               \n    2 root      20   0     0    0    0 S  0.0  0.0   0:00.32 kthreadd                                                                           \n    3 root      RT   0     0    0    0 S  0.0  0.0   2:55.22 migration/0                                                                        \n    4 root      20   0     0    0    0 S  0.0  0.0   5:49.74 ksoftirqd/0                                                                        \n    5 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 stopper/0  \n```\n\n### 系统概况\n\n 从输出的第一行来看， 首先是系统的uptime信息(使用`uptime`也可以查看)， 可以看到系统已经运行了200天了，是在`15：19：54`这个时间点启动起来的， `4：06` 是当前的时间， 当前只有一个用户登录(使用`w`也可以查看当前的登录用户)。 还有就是系统的负载——load average，这个有三个值，分别是1分钟的平均负载， 5分钟的， 15分钟的（`uptime`的输出信息中也有这个）。\n\n 第二行包含了系统进程的一些统计信息，Tasks是运行队列中的任务个数（Linux run-queue）， 还有一些其他状态的进程的个数信息\n\n > - **running**:  CPU 上运行的和将要被调度运行的；\n\n> - **sleeping**: 通常是等待事件(比如 IO 操作)完成的任务，细分可以包括 interruptible 和 uninterruptible 的类型；\n\n> - **stopped**: 是一些被暂停的任务，通常发送 SIGSTOP 或者对一个前台任务操作 Ctrl-Z 可以将其暂停；\n\n> - **zombie**: 僵尸任务，虽然进程终止资源会被自动回收，但是含有退出任务的 task descriptor 需要父进程访问后才能释放，这种进程显示为 `defunct` 状态，无论是因为父进程提前退出还是未 wait 调用，出现这种进程都应该格外注意程序是否设计有误。\n\n### CPU\n\n 第三行是CPU的一些信息，各个部分的占用都很明确。\n\n> - (us) user：CPU 在低 nice 值(高优先级)用户态所占用的时间(nice<=0)。正常情况下只要服务器不是很闲，那么大部分的 CPU 时间应该都在此执行这类程序\n\n> - (sy) system：CPU 处于内核态所占用的时间，操作系统通过系统调用(system call)从用户态陷入内核态，以执行特定的服务；通常情况下该值会比较小，但是当服务器执行的 IO 比较密集的时候，该值会比较大\n\n> - (ni) nice：CPU 在高 nice 值(低优先级)用户态以低优先级运行占用的时间(nice>0)。默认新启动的进程 nice=0，是不会计入这里的，除非手动通过 renice 或者 setpriority() 的方式修改程序的nice值\n\n> - (id) idle：CPU 在空闲状态(执行 kernel idle handler )所占用的时间\n\n> - (wa) iowait：等待 IO 完成做占用的时间\n\n> - (hi) irq：系统处理硬件中断所消耗的时间\n\n> - (si) softirq：系统处理软中断所消耗的时间，记住软中断分为 softirqs、tasklets (其实是前者的特例)、work queues，不知道这里是统计的是哪些的时间，毕竟 work queues 的执行已经不是中断上下文了\n\n> - (st) steal：在虚拟机情况下才有意义，因为虚拟机下 CPU 也是共享物理 CPU 的，所以这段时间表明虚拟机等待 hypervisor 调度 CPU 的时间，也意味着这段时间 hypervisor 将 CPU 调度给别的 CPU 执行，这个时段的 CPU 资源被“stolen”了。这个值在我 KVM 的 VPS 机器上是不为 0 的，但也只有 0.1 这个数量级，是不是可以用来判断 VPS 超售的情况？\n\niowait所包含的信息其实是非常少的，具体的解释可以看**参考3**中的文章，讲的非常好.\n\n> %iowait 表示在一个采样周期内有百分之几的时间属于以下情况：CPU空闲、并且有仍未完成的I/O请求\n\n### 内存\n\n第四行主要是内存使用的相关信息， 系统的内存总共有`65979844k`， 已经使用` 65004736k`, `975108k`可用， `8108k`缓存, \n\n65979844k = 65004736k + 975108k\n\n可见缓存的也包含在可用的内存中。\n\n这些信息也可以通过`free -k` （还可以-m, -g 表示展示的单位），`free`的输出如下:\n\n```bash\n[qisheng.li@xxx /home/www/xxx]$ free -k\n             total       used       free     shared    buffers     cached\nMem:      65979844   64863960    1115884        112       8824    5331160\n-/+ buffers/cache:   59523976    6455868 \nSwap:     50331644      29364   50302280 \n```\n\n`vmstat` 也可以看到系统的内存状况：\n\n```bash\n[qisheng.li@xxx /home/www/xxx]$ vmstat 1 3 | column -t\nprocs  -----------memory----------  ---swap--  -----io----  --system--  -----cpu-----\nr      b                            swpd       free         buff        cache          si  so  bi   bo   in     cs     us  sy  id  wa  st\n5      1                            29364      2231704      8808        4214104        0   0   124  230  0      0      15  1   84  0   0\n6      0                            29364      2219016      8908        4225260        0   0   668  132  47040  68271  25  2   72  0   0\n5      0                            29364      2209552      8916        4234020        0   0   512  12   37178  52578  20  2   78  0   0\n\n```\n\n第五行和第四行类似，输出的是swap的使用情况。\n\n\n### 进程的详细信息\n\n> PID：进程的ID\n> USER：进程所有者\n> PR：进程的优先级别，越小越优先被执行\n> NI：nice值\n> VIRT：进程占用的虚拟内存\n> RES：进程占用的物理内存\n> SHR：进程使用的共享内存\n> S：进程的状态。S表示休眠，R表示正在运行，Z表示僵死状态，N表示该进程优先值为负数\n> %CPU：进程占用CPU的使用率\n> %MEM：进程使用的物理内存和总内存的百分比\n> TIME+：该进程启动后占用的总的CPU时间，即占用CPU使用时间的累加值。\n> COMMAND：进程启动命令名称\n\n## 高级用法\n\n### 交互命令\n\n- 按照CPU占用排序： 交互模式下输入： `P`\n\n- 按照内存排序： 交互模式下输入： `M`\n\n- 杀死进程： 交互模式下输入: `k`, 然后根据提示输入相应的`pid`\n\n- 更改刷新时间： 交互模式下输入: `d`或者`s`, 然后输入相应的刷新值\n\n- 显示CPU的每个核的使用情况： 交互模式下输入： 键盘上的`1`\n\ntop的显示界面会展开：\n\n{% asset_img  cpu.png %}\n\n- 高亮模式： 交互模式下输入: 'z'\n\n{% asset_img  highlight.png %}\n\n- 高亮当前的排序列(需要在z模式下)： 交互模式下输入: 'x'\n\n{% asset_img  highlight-sort.png %}\n\n- 改变排序列： 交互模式下按`shift` + `<`或`>`\n\n- 增加显示的Field： 交互模式下按`f`, 然后选择想要展示的列\n\n{% asset_img  fields.png %}\n\n- 显示到线程级别： 交互模式下按`H`\n\n- 显示完整的命令名称: 交互模式下按`c`\n\n- 分类显示各种系统资源高的进程： 交互模式下按`A`\n\n{% asset_img top-a.png %}\n\n### 命令行参数\n\n- 显示某个进程的线程信息\n\n`top -p <PID> -H`\n\n其中 `-H`是指显示线程的信息，可以看到每个线程的CPU占用情况\n\n{% asset_img top-thread.png %}\n\n- 显示完整的命令： `-c`\n\n\n# 参考\n\n1. [top实践小技巧 - OPS Notes By 枯木](http://kumu-linux.github.io/blog/2013/06/07/top-hacks/)\n\n2. [Linux服务器的那些性能参数指标](http://mp.weixin.qq.com/s?__biz=MzAxMzQ3NzQ3Nw==&mid=2654249787&idx=2&sn=7aa8e765fda84d5fa26580c210585c53&chksm=8061f031b716792776833370019a9fc4c79fa40ea7db5b4ccb165b90919056acaffd3d971d94&mpshare=1&scene=1&srcid=0801QspCI2Xo04BsZlP6pCVb##)\n\n3. [理解 %iowait (%wio) | Linux Performance](http://linuxperf.com/?p=33)\n\n4. [8. top linux下的任务管理器 — Linux Tools Quick Tutorial](http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/top.html)\n","slug":"top","published":1,"updated":"2017-09-10T04:22:07.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdax00a7jh4k3iektjnq","content":"<h1 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h1><h2 id=\"基本用法\"><a href=\"#基本用法\" class=\"headerlink\" title=\"基本用法\"></a>基本用法</h2><p>top是了解系统状况最常用的命令，从top的输出我们可以很好的掌握系统的CPU, 内存，swap，进程的相关信息。</p>\n<p>下面说下top的基本用法：</p>\n<p><br><br></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx /home/www/xxx]$ sudo top</span><br><span class=\"line\"></span><br><span class=\"line\">top - 15:19:54 up 200 days,  4:06,  1 user,  load average: 5.91, 6.14, 5.57</span><br><span class=\"line\">Tasks: 499 total,   1 running, 498 sleeping,   0 stopped,   0 zombie</span><br><span class=\"line\">Cpu(s): 20.1%us,  1.2%sy,  0.0%ni, 78.4%id,  0.0%wa,  0.0%hi,  0.4%si,  0.0%st</span><br><span class=\"line\">Mem:  65979844k total, 65004736k used,   975108k free,     8108k buffers</span><br><span class=\"line\">Swap: 50331644k total,    29364k used, 50302280k free,  5530672k cached</span><br><span class=\"line\"></span><br><span class=\"line\">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            </span><br><span class=\"line\"> 8468 tomcat    20   0 71.2g  55g 6484 S 492.3 87.8  32033:12 java                                                                              </span><br><span class=\"line\"> 1256 tomcat    20   0 6055m 251m 2504 S 24.9  0.4  41886:22 java                                                                               </span><br><span class=\"line\"> 2446 root      20   0 15304 1568  928 R  0.7  0.0   0:00.11 top                                                                                </span><br><span class=\"line\">30593 root      20   0  526m  31m 3208 S  0.3  0.0   0:15.41 salt-minion                                                                        </span><br><span class=\"line\">    1 root      20   0 19232  632  384 S  0.0  0.0  11:49.23 init                                                                               </span><br><span class=\"line\">    2 root      20   0     0    0    0 S  0.0  0.0   0:00.32 kthreadd                                                                           </span><br><span class=\"line\">    3 root      RT   0     0    0    0 S  0.0  0.0   2:55.22 migration/0                                                                        </span><br><span class=\"line\">    4 root      20   0     0    0    0 S  0.0  0.0   5:49.74 ksoftirqd/0                                                                        </span><br><span class=\"line\">    5 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 stopper/0</span><br></pre></td></tr></table></figure>\n<h3 id=\"系统概况\"><a href=\"#系统概况\" class=\"headerlink\" title=\"系统概况\"></a>系统概况</h3><p> 从输出的第一行来看， 首先是系统的uptime信息(使用<code>uptime</code>也可以查看)， 可以看到系统已经运行了200天了，是在<code>15：19：54</code>这个时间点启动起来的， <code>4：06</code> 是当前的时间， 当前只有一个用户登录(使用<code>w</code>也可以查看当前的登录用户)。 还有就是系统的负载——load average，这个有三个值，分别是1分钟的平均负载， 5分钟的， 15分钟的（<code>uptime</code>的输出信息中也有这个）。</p>\n<p> 第二行包含了系统进程的一些统计信息，Tasks是运行队列中的任务个数（Linux run-queue）， 还有一些其他状态的进程的个数信息</p>\n<blockquote>\n<ul>\n<li><p><strong>running</strong>:  CPU 上运行的和将要被调度运行的；</p>\n</li>\n<li><p><strong>sleeping</strong>: 通常是等待事件(比如 IO 操作)完成的任务，细分可以包括 interruptible 和 uninterruptible 的类型；</p>\n</li>\n<li><p><strong>stopped</strong>: 是一些被暂停的任务，通常发送 SIGSTOP 或者对一个前台任务操作 Ctrl-Z 可以将其暂停；</p>\n</li>\n<li><p><strong>zombie</strong>: 僵尸任务，虽然进程终止资源会被自动回收，但是含有退出任务的 task descriptor 需要父进程访问后才能释放，这种进程显示为 <code>defunct</code> 状态，无论是因为父进程提前退出还是未 wait 调用，出现这种进程都应该格外注意程序是否设计有误。</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h3><p> 第三行是CPU的一些信息，各个部分的占用都很明确。</p>\n<blockquote>\n<ul>\n<li><p>(us) user：CPU 在低 nice 值(高优先级)用户态所占用的时间(nice&lt;=0)。正常情况下只要服务器不是很闲，那么大部分的 CPU 时间应该都在此执行这类程序</p>\n</li>\n<li><p>(sy) system：CPU 处于内核态所占用的时间，操作系统通过系统调用(system call)从用户态陷入内核态，以执行特定的服务；通常情况下该值会比较小，但是当服务器执行的 IO 比较密集的时候，该值会比较大</p>\n</li>\n<li><p>(ni) nice：CPU 在高 nice 值(低优先级)用户态以低优先级运行占用的时间(nice&gt;0)。默认新启动的进程 nice=0，是不会计入这里的，除非手动通过 renice 或者 setpriority() 的方式修改程序的nice值</p>\n</li>\n<li><p>(id) idle：CPU 在空闲状态(执行 kernel idle handler )所占用的时间</p>\n</li>\n<li><p>(wa) iowait：等待 IO 完成做占用的时间</p>\n</li>\n<li><p>(hi) irq：系统处理硬件中断所消耗的时间</p>\n</li>\n<li><p>(si) softirq：系统处理软中断所消耗的时间，记住软中断分为 softirqs、tasklets (其实是前者的特例)、work queues，不知道这里是统计的是哪些的时间，毕竟 work queues 的执行已经不是中断上下文了</p>\n</li>\n<li><p>(st) steal：在虚拟机情况下才有意义，因为虚拟机下 CPU 也是共享物理 CPU 的，所以这段时间表明虚拟机等待 hypervisor 调度 CPU 的时间，也意味着这段时间 hypervisor 将 CPU 调度给别的 CPU 执行，这个时段的 CPU 资源被“stolen”了。这个值在我 KVM 的 VPS 机器上是不为 0 的，但也只有 0.1 这个数量级，是不是可以用来判断 VPS 超售的情况？</p>\n</li>\n</ul>\n</blockquote>\n<p>iowait所包含的信息其实是非常少的，具体的解释可以看<strong>参考3</strong>中的文章，讲的非常好.</p>\n<blockquote>\n<p>%iowait 表示在一个采样周期内有百分之几的时间属于以下情况：CPU空闲、并且有仍未完成的I/O请求</p>\n</blockquote>\n<h3 id=\"内存\"><a href=\"#内存\" class=\"headerlink\" title=\"内存\"></a>内存</h3><p>第四行主要是内存使用的相关信息， 系统的内存总共有<code>65979844k</code>， 已经使用<code>65004736k</code>, <code>975108k</code>可用， <code>8108k</code>缓存, </p>\n<p>65979844k = 65004736k + 975108k</p>\n<p>可见缓存的也包含在可用的内存中。</p>\n<p>这些信息也可以通过<code>free -k</code> （还可以-m, -g 表示展示的单位），<code>free</code>的输出如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx /home/www/xxx]$ free -k</span><br><span class=\"line\">             total       used       free     shared    buffers     cached</span><br><span class=\"line\">Mem:      65979844   64863960    1115884        112       8824    5331160</span><br><span class=\"line\">-/+ buffers/cache:   59523976    6455868 </span><br><span class=\"line\">Swap:     50331644      29364   50302280</span><br></pre></td></tr></table></figure>\n<p><code>vmstat</code> 也可以看到系统的内存状况：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx /home/www/xxx]$ vmstat 1 3 | column -t</span><br><span class=\"line\">procs  -----------memory----------  ---swap--  -----io----  --system--  -----cpu-----</span><br><span class=\"line\">r      b                            swpd       free         buff        cache          si  so  bi   bo   <span class=\"keyword\">in</span>     cs     us  sy  id  wa  st</span><br><span class=\"line\">5      1                            29364      2231704      8808        4214104        0   0   124  230  0      0      15  1   84  0   0</span><br><span class=\"line\">6      0                            29364      2219016      8908        4225260        0   0   668  132  47040  68271  25  2   72  0   0</span><br><span class=\"line\">5      0                            29364      2209552      8916        4234020        0   0   512  12   37178  52578  20  2   78  0   0</span><br></pre></td></tr></table></figure>\n<p>第五行和第四行类似，输出的是swap的使用情况。</p>\n<h3 id=\"进程的详细信息\"><a href=\"#进程的详细信息\" class=\"headerlink\" title=\"进程的详细信息\"></a>进程的详细信息</h3><blockquote>\n<p>PID：进程的ID<br>USER：进程所有者<br>PR：进程的优先级别，越小越优先被执行<br>NI：nice值<br>VIRT：进程占用的虚拟内存<br>RES：进程占用的物理内存<br>SHR：进程使用的共享内存<br>S：进程的状态。S表示休眠，R表示正在运行，Z表示僵死状态，N表示该进程优先值为负数<br>%CPU：进程占用CPU的使用率<br>%MEM：进程使用的物理内存和总内存的百分比<br>TIME+：该进程启动后占用的总的CPU时间，即占用CPU使用时间的累加值。<br>COMMAND：进程启动命令名称</p>\n</blockquote>\n<h2 id=\"高级用法\"><a href=\"#高级用法\" class=\"headerlink\" title=\"高级用法\"></a>高级用法</h2><h3 id=\"交互命令\"><a href=\"#交互命令\" class=\"headerlink\" title=\"交互命令\"></a>交互命令</h3><ul>\n<li><p>按照CPU占用排序： 交互模式下输入： <code>P</code></p>\n</li>\n<li><p>按照内存排序： 交互模式下输入： <code>M</code></p>\n</li>\n<li><p>杀死进程： 交互模式下输入: <code>k</code>, 然后根据提示输入相应的<code>pid</code></p>\n</li>\n<li><p>更改刷新时间： 交互模式下输入: <code>d</code>或者<code>s</code>, 然后输入相应的刷新值</p>\n</li>\n<li><p>显示CPU的每个核的使用情况： 交互模式下输入： 键盘上的<code>1</code></p>\n</li>\n</ul>\n<p>top的显示界面会展开：</p>\n<img src=\"/2017/09/09/top/cpu.png\">\n<ul>\n<li>高亮模式： 交互模式下输入: ‘z’</li>\n</ul>\n<img src=\"/2017/09/09/top/highlight.png\">\n<ul>\n<li>高亮当前的排序列(需要在z模式下)： 交互模式下输入: ‘x’</li>\n</ul>\n<img src=\"/2017/09/09/top/highlight-sort.png\">\n<ul>\n<li><p>改变排序列： 交互模式下按<code>shift</code> + <code>&lt;</code>或<code>&gt;</code></p>\n</li>\n<li><p>增加显示的Field： 交互模式下按<code>f</code>, 然后选择想要展示的列</p>\n</li>\n</ul>\n<img src=\"/2017/09/09/top/fields.png\">\n<ul>\n<li><p>显示到线程级别： 交互模式下按<code>H</code></p>\n</li>\n<li><p>显示完整的命令名称: 交互模式下按<code>c</code></p>\n</li>\n<li><p>分类显示各种系统资源高的进程： 交互模式下按<code>A</code></p>\n</li>\n</ul>\n<img src=\"/2017/09/09/top/top-a.png\">\n<h3 id=\"命令行参数\"><a href=\"#命令行参数\" class=\"headerlink\" title=\"命令行参数\"></a>命令行参数</h3><ul>\n<li>显示某个进程的线程信息</li>\n</ul>\n<p><code>top -p &lt;PID&gt; -H</code></p>\n<p>其中 <code>-H</code>是指显示线程的信息，可以看到每个线程的CPU占用情况</p>\n\n<ul>\n<li>显示完整的命令： <code>-c</code></li>\n</ul>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"http://kumu-linux.github.io/blog/2013/06/07/top-hacks/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">top实践小技巧 - OPS Notes By 枯木</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzAxMzQ3NzQ3Nw==&amp;mid=2654249787&amp;idx=2&amp;sn=7aa8e765fda84d5fa26580c210585c53&amp;chksm=8061f031b716792776833370019a9fc4c79fa40ea7db5b4ccb165b90919056acaffd3d971d94&amp;mpshare=1&amp;scene=1&amp;srcid=0801QspCI2Xo04BsZlP6pCVb##\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux服务器的那些性能参数指标</a></p>\n</li>\n<li><p><a href=\"http://linuxperf.com/?p=33\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">理解 %iowait (%wio) | Linux Performance</a></p>\n</li>\n<li><p><a href=\"http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/top.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">8. top linux下的任务管理器 — Linux Tools Quick Tutorial</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h1><h2 id=\"基本用法\"><a href=\"#基本用法\" class=\"headerlink\" title=\"基本用法\"></a>基本用法</h2><p>top是了解系统状况最常用的命令，从top的输出我们可以很好的掌握系统的CPU, 内存，swap，进程的相关信息。</p>\n<p>下面说下top的基本用法：</p>\n<p><br><br></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx /home/www/xxx]$ sudo top</span><br><span class=\"line\"></span><br><span class=\"line\">top - 15:19:54 up 200 days,  4:06,  1 user,  load average: 5.91, 6.14, 5.57</span><br><span class=\"line\">Tasks: 499 total,   1 running, 498 sleeping,   0 stopped,   0 zombie</span><br><span class=\"line\">Cpu(s): 20.1%us,  1.2%sy,  0.0%ni, 78.4%id,  0.0%wa,  0.0%hi,  0.4%si,  0.0%st</span><br><span class=\"line\">Mem:  65979844k total, 65004736k used,   975108k free,     8108k buffers</span><br><span class=\"line\">Swap: 50331644k total,    29364k used, 50302280k free,  5530672k cached</span><br><span class=\"line\"></span><br><span class=\"line\">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                            </span><br><span class=\"line\"> 8468 tomcat    20   0 71.2g  55g 6484 S 492.3 87.8  32033:12 java                                                                              </span><br><span class=\"line\"> 1256 tomcat    20   0 6055m 251m 2504 S 24.9  0.4  41886:22 java                                                                               </span><br><span class=\"line\"> 2446 root      20   0 15304 1568  928 R  0.7  0.0   0:00.11 top                                                                                </span><br><span class=\"line\">30593 root      20   0  526m  31m 3208 S  0.3  0.0   0:15.41 salt-minion                                                                        </span><br><span class=\"line\">    1 root      20   0 19232  632  384 S  0.0  0.0  11:49.23 init                                                                               </span><br><span class=\"line\">    2 root      20   0     0    0    0 S  0.0  0.0   0:00.32 kthreadd                                                                           </span><br><span class=\"line\">    3 root      RT   0     0    0    0 S  0.0  0.0   2:55.22 migration/0                                                                        </span><br><span class=\"line\">    4 root      20   0     0    0    0 S  0.0  0.0   5:49.74 ksoftirqd/0                                                                        </span><br><span class=\"line\">    5 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 stopper/0</span><br></pre></td></tr></table></figure>\n<h3 id=\"系统概况\"><a href=\"#系统概况\" class=\"headerlink\" title=\"系统概况\"></a>系统概况</h3><p> 从输出的第一行来看， 首先是系统的uptime信息(使用<code>uptime</code>也可以查看)， 可以看到系统已经运行了200天了，是在<code>15：19：54</code>这个时间点启动起来的， <code>4：06</code> 是当前的时间， 当前只有一个用户登录(使用<code>w</code>也可以查看当前的登录用户)。 还有就是系统的负载——load average，这个有三个值，分别是1分钟的平均负载， 5分钟的， 15分钟的（<code>uptime</code>的输出信息中也有这个）。</p>\n<p> 第二行包含了系统进程的一些统计信息，Tasks是运行队列中的任务个数（Linux run-queue）， 还有一些其他状态的进程的个数信息</p>\n<blockquote>\n<ul>\n<li><p><strong>running</strong>:  CPU 上运行的和将要被调度运行的；</p>\n</li>\n<li><p><strong>sleeping</strong>: 通常是等待事件(比如 IO 操作)完成的任务，细分可以包括 interruptible 和 uninterruptible 的类型；</p>\n</li>\n<li><p><strong>stopped</strong>: 是一些被暂停的任务，通常发送 SIGSTOP 或者对一个前台任务操作 Ctrl-Z 可以将其暂停；</p>\n</li>\n<li><p><strong>zombie</strong>: 僵尸任务，虽然进程终止资源会被自动回收，但是含有退出任务的 task descriptor 需要父进程访问后才能释放，这种进程显示为 <code>defunct</code> 状态，无论是因为父进程提前退出还是未 wait 调用，出现这种进程都应该格外注意程序是否设计有误。</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h3><p> 第三行是CPU的一些信息，各个部分的占用都很明确。</p>\n<blockquote>\n<ul>\n<li><p>(us) user：CPU 在低 nice 值(高优先级)用户态所占用的时间(nice&lt;=0)。正常情况下只要服务器不是很闲，那么大部分的 CPU 时间应该都在此执行这类程序</p>\n</li>\n<li><p>(sy) system：CPU 处于内核态所占用的时间，操作系统通过系统调用(system call)从用户态陷入内核态，以执行特定的服务；通常情况下该值会比较小，但是当服务器执行的 IO 比较密集的时候，该值会比较大</p>\n</li>\n<li><p>(ni) nice：CPU 在高 nice 值(低优先级)用户态以低优先级运行占用的时间(nice&gt;0)。默认新启动的进程 nice=0，是不会计入这里的，除非手动通过 renice 或者 setpriority() 的方式修改程序的nice值</p>\n</li>\n<li><p>(id) idle：CPU 在空闲状态(执行 kernel idle handler )所占用的时间</p>\n</li>\n<li><p>(wa) iowait：等待 IO 完成做占用的时间</p>\n</li>\n<li><p>(hi) irq：系统处理硬件中断所消耗的时间</p>\n</li>\n<li><p>(si) softirq：系统处理软中断所消耗的时间，记住软中断分为 softirqs、tasklets (其实是前者的特例)、work queues，不知道这里是统计的是哪些的时间，毕竟 work queues 的执行已经不是中断上下文了</p>\n</li>\n<li><p>(st) steal：在虚拟机情况下才有意义，因为虚拟机下 CPU 也是共享物理 CPU 的，所以这段时间表明虚拟机等待 hypervisor 调度 CPU 的时间，也意味着这段时间 hypervisor 将 CPU 调度给别的 CPU 执行，这个时段的 CPU 资源被“stolen”了。这个值在我 KVM 的 VPS 机器上是不为 0 的，但也只有 0.1 这个数量级，是不是可以用来判断 VPS 超售的情况？</p>\n</li>\n</ul>\n</blockquote>\n<p>iowait所包含的信息其实是非常少的，具体的解释可以看<strong>参考3</strong>中的文章，讲的非常好.</p>\n<blockquote>\n<p>%iowait 表示在一个采样周期内有百分之几的时间属于以下情况：CPU空闲、并且有仍未完成的I/O请求</p>\n</blockquote>\n<h3 id=\"内存\"><a href=\"#内存\" class=\"headerlink\" title=\"内存\"></a>内存</h3><p>第四行主要是内存使用的相关信息， 系统的内存总共有<code>65979844k</code>， 已经使用<code>65004736k</code>, <code>975108k</code>可用， <code>8108k</code>缓存, </p>\n<p>65979844k = 65004736k + 975108k</p>\n<p>可见缓存的也包含在可用的内存中。</p>\n<p>这些信息也可以通过<code>free -k</code> （还可以-m, -g 表示展示的单位），<code>free</code>的输出如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx /home/www/xxx]$ free -k</span><br><span class=\"line\">             total       used       free     shared    buffers     cached</span><br><span class=\"line\">Mem:      65979844   64863960    1115884        112       8824    5331160</span><br><span class=\"line\">-/+ buffers/cache:   59523976    6455868 </span><br><span class=\"line\">Swap:     50331644      29364   50302280</span><br></pre></td></tr></table></figure>\n<p><code>vmstat</code> 也可以看到系统的内存状况：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[qisheng.li@xxx /home/www/xxx]$ vmstat 1 3 | column -t</span><br><span class=\"line\">procs  -----------memory----------  ---swap--  -----io----  --system--  -----cpu-----</span><br><span class=\"line\">r      b                            swpd       free         buff        cache          si  so  bi   bo   <span class=\"keyword\">in</span>     cs     us  sy  id  wa  st</span><br><span class=\"line\">5      1                            29364      2231704      8808        4214104        0   0   124  230  0      0      15  1   84  0   0</span><br><span class=\"line\">6      0                            29364      2219016      8908        4225260        0   0   668  132  47040  68271  25  2   72  0   0</span><br><span class=\"line\">5      0                            29364      2209552      8916        4234020        0   0   512  12   37178  52578  20  2   78  0   0</span><br></pre></td></tr></table></figure>\n<p>第五行和第四行类似，输出的是swap的使用情况。</p>\n<h3 id=\"进程的详细信息\"><a href=\"#进程的详细信息\" class=\"headerlink\" title=\"进程的详细信息\"></a>进程的详细信息</h3><blockquote>\n<p>PID：进程的ID<br>USER：进程所有者<br>PR：进程的优先级别，越小越优先被执行<br>NI：nice值<br>VIRT：进程占用的虚拟内存<br>RES：进程占用的物理内存<br>SHR：进程使用的共享内存<br>S：进程的状态。S表示休眠，R表示正在运行，Z表示僵死状态，N表示该进程优先值为负数<br>%CPU：进程占用CPU的使用率<br>%MEM：进程使用的物理内存和总内存的百分比<br>TIME+：该进程启动后占用的总的CPU时间，即占用CPU使用时间的累加值。<br>COMMAND：进程启动命令名称</p>\n</blockquote>\n<h2 id=\"高级用法\"><a href=\"#高级用法\" class=\"headerlink\" title=\"高级用法\"></a>高级用法</h2><h3 id=\"交互命令\"><a href=\"#交互命令\" class=\"headerlink\" title=\"交互命令\"></a>交互命令</h3><ul>\n<li><p>按照CPU占用排序： 交互模式下输入： <code>P</code></p>\n</li>\n<li><p>按照内存排序： 交互模式下输入： <code>M</code></p>\n</li>\n<li><p>杀死进程： 交互模式下输入: <code>k</code>, 然后根据提示输入相应的<code>pid</code></p>\n</li>\n<li><p>更改刷新时间： 交互模式下输入: <code>d</code>或者<code>s</code>, 然后输入相应的刷新值</p>\n</li>\n<li><p>显示CPU的每个核的使用情况： 交互模式下输入： 键盘上的<code>1</code></p>\n</li>\n</ul>\n<p>top的显示界面会展开：</p>\n<img src=\"/2017/09/09/top/cpu.png\">\n<ul>\n<li>高亮模式： 交互模式下输入: ‘z’</li>\n</ul>\n<img src=\"/2017/09/09/top/highlight.png\">\n<ul>\n<li>高亮当前的排序列(需要在z模式下)： 交互模式下输入: ‘x’</li>\n</ul>\n<img src=\"/2017/09/09/top/highlight-sort.png\">\n<ul>\n<li><p>改变排序列： 交互模式下按<code>shift</code> + <code>&lt;</code>或<code>&gt;</code></p>\n</li>\n<li><p>增加显示的Field： 交互模式下按<code>f</code>, 然后选择想要展示的列</p>\n</li>\n</ul>\n<img src=\"/2017/09/09/top/fields.png\">\n<ul>\n<li><p>显示到线程级别： 交互模式下按<code>H</code></p>\n</li>\n<li><p>显示完整的命令名称: 交互模式下按<code>c</code></p>\n</li>\n<li><p>分类显示各种系统资源高的进程： 交互模式下按<code>A</code></p>\n</li>\n</ul>\n<img src=\"/2017/09/09/top/top-a.png\">\n<h3 id=\"命令行参数\"><a href=\"#命令行参数\" class=\"headerlink\" title=\"命令行参数\"></a>命令行参数</h3><ul>\n<li>显示某个进程的线程信息</li>\n</ul>\n<p><code>top -p &lt;PID&gt; -H</code></p>\n<p>其中 <code>-H</code>是指显示线程的信息，可以看到每个线程的CPU占用情况</p>\n\n<ul>\n<li>显示完整的命令： <code>-c</code></li>\n</ul>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"http://kumu-linux.github.io/blog/2013/06/07/top-hacks/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">top实践小技巧 - OPS Notes By 枯木</a></p>\n</li>\n<li><p><a href=\"http://mp.weixin.qq.com/s?__biz=MzAxMzQ3NzQ3Nw==&amp;mid=2654249787&amp;idx=2&amp;sn=7aa8e765fda84d5fa26580c210585c53&amp;chksm=8061f031b716792776833370019a9fc4c79fa40ea7db5b4ccb165b90919056acaffd3d971d94&amp;mpshare=1&amp;scene=1&amp;srcid=0801QspCI2Xo04BsZlP6pCVb##\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Linux服务器的那些性能参数指标</a></p>\n</li>\n<li><p><a href=\"http://linuxperf.com/?p=33\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">理解 %iowait (%wio) | Linux Performance</a></p>\n</li>\n<li><p><a href=\"http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/top.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">8. top linux下的任务管理器 — Linux Tools Quick Tutorial</a></p>\n</li>\n</ol>\n"},{"title":"xstream教程","toc":true,"abbrlink":29870,"date":"2016-12-27T15:26:55.000Z","_content":"\n# 使用\n\n![](http://x-stream.github.io/logo.gif)\n\n## pom依赖\n\n```xml\n<!-- https://mvnrepository.com/artifact/com.thoughtworks.xstream/xstream -->\n<dependency>\n    <groupId>com.thoughtworks.xstream</groupId>\n    <artifactId>xstream</artifactId>\n    <version>1.3.1</version>\n</dependency>\n```\n\n## 输出xml\n\n### 手动配置\n\nAuthor 类\n\n```java\npublic class Author {\n\n    private String name;\n\n    public Author(String name) {\n        this.name = name;\n    }\n\n    public String getName() {\n        return name;\n    }\n}\n```\n\nEntry 类\n\n```java\npublic class Entry {\n\n    private String title, description;\n\n    public Entry(String title, String description) {\n        this.title = title;\n        this.description = description;\n    }\n}\n```\n\nBlog 类\n\n```java\npublic class Blog {\n\n    private Author writer;\n\n    private List entries = new ArrayList();\n\n    public Blog(Author writer) {\n        this.writer = writer;\n    }\n\n    public void add(Entry entry) {\n        entries.add(entry);\n    }\n\n    public List getContent() {\n        return entries;\n    }\n\n    public static void main(String[] args) {\n        Blog teamBlog = new Blog(new Author(\"qisheng.li\"));\n        teamBlog.add(new Entry(\"first\", \"first blog entry\"));\n        teamBlog.add(new Entry(\"second\", \"second blog entry\"));\n\n        XStream xStream = new XStream();\n        System.out.println(xStream.toXML(teamBlog));        \n    }\n}\n```\n\n输出的内容为:\n\n```xml\n<com.air.xml.xstream.alias.Blog>\n  <writer>\n    <name>qisheng.li</name>\n  </writer>\n  <entries>\n    <com.air.xml.xstream.alias.Entry>\n      <title>first</title>\n      <description>first blog entry</description>\n    </com.air.xml.xstream.alias.Entry>\n    <com.air.xml.xstream.alias.Entry>\n      <title>second</title>\n      <description>second blog entry</description>\n    </com.air.xml.xstream.alias.Entry>\n  </entries>\n</com.air.xml.xstream.alias.Blog>\n```\n- *默认输出的类，是fully qualified name，可以手动设置别名*\n\n```java\n//alias\n        xStream.alias(\"blog\", Blog.class);\n        xStream.alias(\"entry\", Entry.class);\n```\n\n输出:\n\n```xml\n<blog>\n  <writer>\n    <name>qisheng.li</name>\n  </writer>\n  <entries>\n    <entry>\n      <title>first</title>\n      <description>first blog entry</description>\n    </entry>\n    <entry>\n      <title>second</title>\n      <description>second blog entry</description>\n    </entry>\n  </entries>\n</blog>\n```\n\n- *也可以设置属性级别的别名*\n\n```java\nxStream.aliasField(\"author\", Blog.class, \"writter\");\n```\n\n输出：\n\n```xml\n<blog>\n  <author>\n    <name>qisheng.li</name>\n  </author>\n  <entries>\n    <entry>\n      <title>first</title>\n      <description>first blog entry</description>\n    </entry>\n    <entry>\n      <title>second</title>\n      <description>second blog entry</description>\n    </entry>\n  </entries>\n</blog>\n```\n\n- *包级别的别名*\n\n```java\n        xStream.aliasPackage(\"aliased.pachage.name\", \"com.air.xml.xstream.alias\");\n```\n\n输出的xml:\n\n```xml\n<aliased.pachage.name.Blog author=\"qisheng.li\">\n  <entry>\n    <title>first</title>\n    <description>first blog entry</description>\n  </entry>\n  <entry>\n    <title>second</title>\n    <description>second blog entry</description>\n  </entry>\n</aliased.pachage.name.Blog>\n```\n\n#### Implicit Collections\n\n> implicit collection: whenever you have a collection which doesn't need to display it's root tag, you can map it as an implicit collection.\n\n如果不想展示一个集合的root节点，比如上述的`entries`，可以将其当做一个`implicit collection`\n\n```java\n    //implicit collection\n    xStream.addImplicitCollection(Blog.class, \"entries\");\n```\n\n输出:\n\n```xml\n<blog>\n  <author>\n    <name>qisheng.li</name>\n  </author>\n  <entry>\n    <title>first</title>\n    <description>first blog entry</description>\n  </entry>\n  <entry>\n    <title>second</title>\n    <description>second blog entry</description>\n  </entry>\n</blog>\n```\n\n可以看到`entries`这个节点已经没有了\n\n#### field输出为属性值\n\n接着上面的例子，我们现在想让Blog的writer输出为Blog标签的属性值。\n\n实现步骤：\n\n1.创建一个转换器\n\n```java\npublic class AuthorConverter  implements SingleValueConverter {\n\n    @Override\n    public String toString(Object obj) {\n        return ((Author) obj).getName();\n    }\n\n    @Override\n    public Object fromString(String str) {\n        return new Author(str);\n    }\n\n    @Override\n    public boolean canConvert(Class type) {\n        return type.equals(Author.class);\n    }\n}\n```\n\n2.注册这个转换器\n\n```java\nxStream.registerConverter(new AuthorConverter());\n```\n\n3.告诉XStream\n\n```java\n//attribute aliasing\nxStream.useAttributeFor(Blog.class, \"writer\");\nxStream.registerConverter(new AuthorConverter());\n//field alias\nxStream.aliasField(\"author\", Blog.class, \"writer\");\n```\n\n输出的xml：\n\n```xml\n<blog author=\"qisheng.li\">\n  <entry>\n    <title>first</title>\n    <description>first blog entry</description>\n  </entry>\n  <entry>\n    <title>second</title>\n    <description>second blog entry</description>\n  </entry>\n</blog>\n```\n\n\n### 基于注解\n\n主要使用的是`XStreamAlias`注解来标记别名\n\n```java\n@XStreamAlias(\"message\")\npublic class RendezvousMessage {\n\n    @XStreamAlias(\"type\")\n    private int messageType;\n\n    public RendezvousMessage(int messageType) {\n        this.messageType = messageType;\n    }\n\n    public static void main(String[] args) {\n        XStream xStream = new XStream();\n        xStream.processAnnotations(RendezvousMessage.class);\n        RendezvousMessage rendezvousMessage = new RendezvousMessage(12);\n        System.out.println(xStream.toXML(rendezvousMessage));\n    }\n}\n\n```\n\nxml 输出\n\n```xml\n<message>\n  <type>12</type>\n</message>\n```\n\n- ImplicitCollection\n\n使用 `@XstreamImplicit(itemFieldName = \"xxx\")`来处理\n\n```java\n    @XStreamImplicit(itemFieldName = \"part\")\n    private List<String> content;\n```\n\n```xml\n<message>\n  <type>12</type>\n  <part>first content</part>\n  <part>second content</part>\n</message>\n```\n- converter\n\n添加一个属性字段并指明他使用的转换器, 和一个基本类型——boolean\n\n```java\n    @XStreamConverter(value=BooleanConverter.class)\n    private boolean important;\n\n    @XStreamConverter(SingleValueCalendarConverter.class)\n    private Calendar created = new GregorianCalendar();\n```\n\n转化器代码\n\n```java\npublic class SingleValueCalendarConverter implements Converter {\n    @Override\n    public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) {\n        Calendar calendar = (Calendar) source;\n        writer.setValue(String.valueOf(calendar.getTime().getTime()));\n    }\n\n    @Override\n    public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {\n        GregorianCalendar calendar = new GregorianCalendar();\n        calendar.setTime(new Date(Long.parseLong(reader.getValue())));\n        return calendar;\n    }\n\n    @Override\n    public boolean canConvert(Class type) {\n        return type.equals(GregorianCalendar.class);\n    }\n}\n```\n\n输出的xml结果：\n\n```xml\n<message>\n  <type>12</type>\n  <part>first content</part>\n  <part>second content</part>\n  <important>false</important>\n  <created>1482856467282</created>\n</message>\n```\n\n- 属性\n\n```java\n    @XStreamAlias(\"type\")\n    @XStreamAsAttribute\n    private int messageType;\n```\n\n输出结果\n\n```xml\n<message type=\"12\">\n  <part>first content</part>\n  <part>second content</part>\n  <important>false</important>\n  <created>1482856554517</created>\n</message>\n```\n\n- 忽略一些字段\n\n```xml\n<message type=\"12\">\n  <part>first content</part>\n  <part>second content</part>\n  <created>1482856661757</created>\n</message>\n```\n\n`important` 属性已经被隐藏\n\n\n#### 自动扫描注解\n\n```java\nxStream.autodetectAnnotations(true);\n```\n\n## xml转对象\n\n ```java\n        RendezvousMessage deserializedMessage = (RendezvousMessage) xStream.fromXML(\"<message type=\\\"12\\\">\\n\" +\n                \"  <part>first content</part>\\n\" +\n                \"  <part>second content</part>\\n\" +\n                \"  <created>1482859234272</created>\\n\" +\n                \"</message>\");\n ```\n \n# 参考\n\n1. [About XStream](http://x-stream.github.io/index.html)\n\n2. [Alias Tutorial](http://x-stream.github.io/alias-tutorial.html)\n\n3. [Annotations Tutorial](http://x-stream.github.io/annotations-tutorial.html)\n\n","source":"_posts/xstream.md","raw":"---\ntitle: xstream教程\ntoc: true\ntags: xml\ncategory: java\nabbrlink: 29870\ndate: 2016-12-27 23:26:55\n---\n\n# 使用\n\n![](http://x-stream.github.io/logo.gif)\n\n## pom依赖\n\n```xml\n<!-- https://mvnrepository.com/artifact/com.thoughtworks.xstream/xstream -->\n<dependency>\n    <groupId>com.thoughtworks.xstream</groupId>\n    <artifactId>xstream</artifactId>\n    <version>1.3.1</version>\n</dependency>\n```\n\n## 输出xml\n\n### 手动配置\n\nAuthor 类\n\n```java\npublic class Author {\n\n    private String name;\n\n    public Author(String name) {\n        this.name = name;\n    }\n\n    public String getName() {\n        return name;\n    }\n}\n```\n\nEntry 类\n\n```java\npublic class Entry {\n\n    private String title, description;\n\n    public Entry(String title, String description) {\n        this.title = title;\n        this.description = description;\n    }\n}\n```\n\nBlog 类\n\n```java\npublic class Blog {\n\n    private Author writer;\n\n    private List entries = new ArrayList();\n\n    public Blog(Author writer) {\n        this.writer = writer;\n    }\n\n    public void add(Entry entry) {\n        entries.add(entry);\n    }\n\n    public List getContent() {\n        return entries;\n    }\n\n    public static void main(String[] args) {\n        Blog teamBlog = new Blog(new Author(\"qisheng.li\"));\n        teamBlog.add(new Entry(\"first\", \"first blog entry\"));\n        teamBlog.add(new Entry(\"second\", \"second blog entry\"));\n\n        XStream xStream = new XStream();\n        System.out.println(xStream.toXML(teamBlog));        \n    }\n}\n```\n\n输出的内容为:\n\n```xml\n<com.air.xml.xstream.alias.Blog>\n  <writer>\n    <name>qisheng.li</name>\n  </writer>\n  <entries>\n    <com.air.xml.xstream.alias.Entry>\n      <title>first</title>\n      <description>first blog entry</description>\n    </com.air.xml.xstream.alias.Entry>\n    <com.air.xml.xstream.alias.Entry>\n      <title>second</title>\n      <description>second blog entry</description>\n    </com.air.xml.xstream.alias.Entry>\n  </entries>\n</com.air.xml.xstream.alias.Blog>\n```\n- *默认输出的类，是fully qualified name，可以手动设置别名*\n\n```java\n//alias\n        xStream.alias(\"blog\", Blog.class);\n        xStream.alias(\"entry\", Entry.class);\n```\n\n输出:\n\n```xml\n<blog>\n  <writer>\n    <name>qisheng.li</name>\n  </writer>\n  <entries>\n    <entry>\n      <title>first</title>\n      <description>first blog entry</description>\n    </entry>\n    <entry>\n      <title>second</title>\n      <description>second blog entry</description>\n    </entry>\n  </entries>\n</blog>\n```\n\n- *也可以设置属性级别的别名*\n\n```java\nxStream.aliasField(\"author\", Blog.class, \"writter\");\n```\n\n输出：\n\n```xml\n<blog>\n  <author>\n    <name>qisheng.li</name>\n  </author>\n  <entries>\n    <entry>\n      <title>first</title>\n      <description>first blog entry</description>\n    </entry>\n    <entry>\n      <title>second</title>\n      <description>second blog entry</description>\n    </entry>\n  </entries>\n</blog>\n```\n\n- *包级别的别名*\n\n```java\n        xStream.aliasPackage(\"aliased.pachage.name\", \"com.air.xml.xstream.alias\");\n```\n\n输出的xml:\n\n```xml\n<aliased.pachage.name.Blog author=\"qisheng.li\">\n  <entry>\n    <title>first</title>\n    <description>first blog entry</description>\n  </entry>\n  <entry>\n    <title>second</title>\n    <description>second blog entry</description>\n  </entry>\n</aliased.pachage.name.Blog>\n```\n\n#### Implicit Collections\n\n> implicit collection: whenever you have a collection which doesn't need to display it's root tag, you can map it as an implicit collection.\n\n如果不想展示一个集合的root节点，比如上述的`entries`，可以将其当做一个`implicit collection`\n\n```java\n    //implicit collection\n    xStream.addImplicitCollection(Blog.class, \"entries\");\n```\n\n输出:\n\n```xml\n<blog>\n  <author>\n    <name>qisheng.li</name>\n  </author>\n  <entry>\n    <title>first</title>\n    <description>first blog entry</description>\n  </entry>\n  <entry>\n    <title>second</title>\n    <description>second blog entry</description>\n  </entry>\n</blog>\n```\n\n可以看到`entries`这个节点已经没有了\n\n#### field输出为属性值\n\n接着上面的例子，我们现在想让Blog的writer输出为Blog标签的属性值。\n\n实现步骤：\n\n1.创建一个转换器\n\n```java\npublic class AuthorConverter  implements SingleValueConverter {\n\n    @Override\n    public String toString(Object obj) {\n        return ((Author) obj).getName();\n    }\n\n    @Override\n    public Object fromString(String str) {\n        return new Author(str);\n    }\n\n    @Override\n    public boolean canConvert(Class type) {\n        return type.equals(Author.class);\n    }\n}\n```\n\n2.注册这个转换器\n\n```java\nxStream.registerConverter(new AuthorConverter());\n```\n\n3.告诉XStream\n\n```java\n//attribute aliasing\nxStream.useAttributeFor(Blog.class, \"writer\");\nxStream.registerConverter(new AuthorConverter());\n//field alias\nxStream.aliasField(\"author\", Blog.class, \"writer\");\n```\n\n输出的xml：\n\n```xml\n<blog author=\"qisheng.li\">\n  <entry>\n    <title>first</title>\n    <description>first blog entry</description>\n  </entry>\n  <entry>\n    <title>second</title>\n    <description>second blog entry</description>\n  </entry>\n</blog>\n```\n\n\n### 基于注解\n\n主要使用的是`XStreamAlias`注解来标记别名\n\n```java\n@XStreamAlias(\"message\")\npublic class RendezvousMessage {\n\n    @XStreamAlias(\"type\")\n    private int messageType;\n\n    public RendezvousMessage(int messageType) {\n        this.messageType = messageType;\n    }\n\n    public static void main(String[] args) {\n        XStream xStream = new XStream();\n        xStream.processAnnotations(RendezvousMessage.class);\n        RendezvousMessage rendezvousMessage = new RendezvousMessage(12);\n        System.out.println(xStream.toXML(rendezvousMessage));\n    }\n}\n\n```\n\nxml 输出\n\n```xml\n<message>\n  <type>12</type>\n</message>\n```\n\n- ImplicitCollection\n\n使用 `@XstreamImplicit(itemFieldName = \"xxx\")`来处理\n\n```java\n    @XStreamImplicit(itemFieldName = \"part\")\n    private List<String> content;\n```\n\n```xml\n<message>\n  <type>12</type>\n  <part>first content</part>\n  <part>second content</part>\n</message>\n```\n- converter\n\n添加一个属性字段并指明他使用的转换器, 和一个基本类型——boolean\n\n```java\n    @XStreamConverter(value=BooleanConverter.class)\n    private boolean important;\n\n    @XStreamConverter(SingleValueCalendarConverter.class)\n    private Calendar created = new GregorianCalendar();\n```\n\n转化器代码\n\n```java\npublic class SingleValueCalendarConverter implements Converter {\n    @Override\n    public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) {\n        Calendar calendar = (Calendar) source;\n        writer.setValue(String.valueOf(calendar.getTime().getTime()));\n    }\n\n    @Override\n    public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {\n        GregorianCalendar calendar = new GregorianCalendar();\n        calendar.setTime(new Date(Long.parseLong(reader.getValue())));\n        return calendar;\n    }\n\n    @Override\n    public boolean canConvert(Class type) {\n        return type.equals(GregorianCalendar.class);\n    }\n}\n```\n\n输出的xml结果：\n\n```xml\n<message>\n  <type>12</type>\n  <part>first content</part>\n  <part>second content</part>\n  <important>false</important>\n  <created>1482856467282</created>\n</message>\n```\n\n- 属性\n\n```java\n    @XStreamAlias(\"type\")\n    @XStreamAsAttribute\n    private int messageType;\n```\n\n输出结果\n\n```xml\n<message type=\"12\">\n  <part>first content</part>\n  <part>second content</part>\n  <important>false</important>\n  <created>1482856554517</created>\n</message>\n```\n\n- 忽略一些字段\n\n```xml\n<message type=\"12\">\n  <part>first content</part>\n  <part>second content</part>\n  <created>1482856661757</created>\n</message>\n```\n\n`important` 属性已经被隐藏\n\n\n#### 自动扫描注解\n\n```java\nxStream.autodetectAnnotations(true);\n```\n\n## xml转对象\n\n ```java\n        RendezvousMessage deserializedMessage = (RendezvousMessage) xStream.fromXML(\"<message type=\\\"12\\\">\\n\" +\n                \"  <part>first content</part>\\n\" +\n                \"  <part>second content</part>\\n\" +\n                \"  <created>1482859234272</created>\\n\" +\n                \"</message>\");\n ```\n \n# 参考\n\n1. [About XStream](http://x-stream.github.io/index.html)\n\n2. [Alias Tutorial](http://x-stream.github.io/alias-tutorial.html)\n\n3. [Annotations Tutorial](http://x-stream.github.io/annotations-tutorial.html)\n\n","slug":"xstream","published":1,"updated":"2017-04-16T12:03:23.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdaz00a9jh4kyey7w7fp","content":"<h1 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h1><p><img src=\"http://x-stream.github.io/logo.gif\" alt=\"\"></p>\n<h2 id=\"pom依赖\"><a href=\"#pom依赖\" class=\"headerlink\" title=\"pom依赖\"></a>pom依赖</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- https://mvnrepository.com/artifact/com.thoughtworks.xstream/xstream --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.thoughtworks.xstream<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>xstream<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.3.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"输出xml\"><a href=\"#输出xml\" class=\"headerlink\" title=\"输出xml\"></a>输出xml</h2><h3 id=\"手动配置\"><a href=\"#手动配置\" class=\"headerlink\" title=\"手动配置\"></a>手动配置</h3><p>Author 类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Author</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Author</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Entry 类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Entry</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String title, description;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Entry</span><span class=\"params\">(String title, String description)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.title = title;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.description = description;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Blog 类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Blog</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Author writer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List entries = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Blog</span><span class=\"params\">(Author writer)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.writer = writer;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(Entry entry)</span> </span>&#123;</span><br><span class=\"line\">        entries.add(entry);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">getContent</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> entries;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Blog teamBlog = <span class=\"keyword\">new</span> Blog(<span class=\"keyword\">new</span> Author(<span class=\"string\">\"qisheng.li\"</span>));</span><br><span class=\"line\">        teamBlog.add(<span class=\"keyword\">new</span> Entry(<span class=\"string\">\"first\"</span>, <span class=\"string\">\"first blog entry\"</span>));</span><br><span class=\"line\">        teamBlog.add(<span class=\"keyword\">new</span> Entry(<span class=\"string\">\"second\"</span>, <span class=\"string\">\"second blog entry\"</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        XStream xStream = <span class=\"keyword\">new</span> XStream();</span><br><span class=\"line\">        System.out.println(xStream.toXML(teamBlog));        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出的内容为:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">com.air.xml.xstream.alias.Blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">com.air.xml.xstream.alias.Blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><em>默认输出的类，是fully qualified name，可以手动设置别名</em></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//alias</span></span><br><span class=\"line\">        xStream.alias(<span class=\"string\">\"blog\"</span>, Blog.class);</span><br><span class=\"line\">        xStream.alias(<span class=\"string\">\"entry\"</span>, Entry.class);</span><br></pre></td></tr></table></figure>\n<p>输出:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><em>也可以设置属性级别的别名</em></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.aliasField(<span class=\"string\">\"author\"</span>, Blog.class, <span class=\"string\">\"writter\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><em>包级别的别名</em></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.aliasPackage(<span class=\"string\">\"aliased.pachage.name\"</span>, <span class=\"string\">\"com.air.xml.xstream.alias\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出的xml:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aliased.pachage.name.Blog</span> <span class=\"attr\">author</span>=<span class=\"string\">\"qisheng.li\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aliased.pachage.name.Blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Implicit-Collections\"><a href=\"#Implicit-Collections\" class=\"headerlink\" title=\"Implicit Collections\"></a>Implicit Collections</h4><blockquote>\n<p>implicit collection: whenever you have a collection which doesn’t need to display it’s root tag, you can map it as an implicit collection.</p>\n</blockquote>\n<p>如果不想展示一个集合的root节点，比如上述的<code>entries</code>，可以将其当做一个<code>implicit collection</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//implicit collection</span></span><br><span class=\"line\">xStream.addImplicitCollection(Blog.class, <span class=\"string\">\"entries\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>可以看到<code>entries</code>这个节点已经没有了</p>\n<h4 id=\"field输出为属性值\"><a href=\"#field输出为属性值\" class=\"headerlink\" title=\"field输出为属性值\"></a>field输出为属性值</h4><p>接着上面的例子，我们现在想让Blog的writer输出为Blog标签的属性值。</p>\n<p>实现步骤：</p>\n<p>1.创建一个转换器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AuthorConverter</span>  <span class=\"keyword\">implements</span> <span class=\"title\">SingleValueConverter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ((Author) obj).getName();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">fromString</span><span class=\"params\">(String str)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Author(str);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canConvert</span><span class=\"params\">(Class type)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> type.equals(Author.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2.注册这个转换器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.registerConverter(<span class=\"keyword\">new</span> AuthorConverter());</span><br></pre></td></tr></table></figure>\n<p>3.告诉XStream</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//attribute aliasing</span></span><br><span class=\"line\">xStream.useAttributeFor(Blog.class, <span class=\"string\">\"writer\"</span>);</span><br><span class=\"line\">xStream.registerConverter(<span class=\"keyword\">new</span> AuthorConverter());</span><br><span class=\"line\"><span class=\"comment\">//field alias</span></span><br><span class=\"line\">xStream.aliasField(<span class=\"string\">\"author\"</span>, Blog.class, <span class=\"string\">\"writer\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出的xml：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span> <span class=\"attr\">author</span>=<span class=\"string\">\"qisheng.li\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于注解\"><a href=\"#基于注解\" class=\"headerlink\" title=\"基于注解\"></a>基于注解</h3><p>主要使用的是<code>XStreamAlias</code>注解来标记别名</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamAlias</span>(<span class=\"string\">\"message\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RendezvousMessage</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@XStreamAlias</span>(<span class=\"string\">\"type\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> messageType;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RendezvousMessage</span><span class=\"params\">(<span class=\"keyword\">int</span> messageType)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.messageType = messageType;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        XStream xStream = <span class=\"keyword\">new</span> XStream();</span><br><span class=\"line\">        xStream.processAnnotations(RendezvousMessage.class);</span><br><span class=\"line\">        RendezvousMessage rendezvousMessage = <span class=\"keyword\">new</span> RendezvousMessage(<span class=\"number\">12</span>);</span><br><span class=\"line\">        System.out.println(xStream.toXML(rendezvousMessage));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>xml 输出</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>12<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>ImplicitCollection</li>\n</ul>\n<p>使用 <code>@XstreamImplicit(itemFieldName = &quot;xxx&quot;)</code>来处理</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamImplicit</span>(itemFieldName = <span class=\"string\">\"part\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">private</span> List&lt;String&gt; content;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>12<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>converter</li>\n</ul>\n<p>添加一个属性字段并指明他使用的转换器, 和一个基本类型——boolean</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamConverter</span>(value=BooleanConverter.class)</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> important;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@XStreamConverter</span>(SingleValueCalendarConverter.class)</span><br><span class=\"line\"><span class=\"keyword\">private</span> Calendar created = <span class=\"keyword\">new</span> GregorianCalendar();</span><br></pre></td></tr></table></figure>\n<p>转化器代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SingleValueCalendarConverter</span> <span class=\"keyword\">implements</span> <span class=\"title\">Converter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">marshal</span><span class=\"params\">(Object source, HierarchicalStreamWriter writer, MarshallingContext context)</span> </span>&#123;</span><br><span class=\"line\">        Calendar calendar = (Calendar) source;</span><br><span class=\"line\">        writer.setValue(String.valueOf(calendar.getTime().getTime()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">unmarshal</span><span class=\"params\">(HierarchicalStreamReader reader, UnmarshallingContext context)</span> </span>&#123;</span><br><span class=\"line\">        GregorianCalendar calendar = <span class=\"keyword\">new</span> GregorianCalendar();</span><br><span class=\"line\">        calendar.setTime(<span class=\"keyword\">new</span> Date(Long.parseLong(reader.getValue())));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> calendar;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canConvert</span><span class=\"params\">(Class type)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> type.equals(GregorianCalendar.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出的xml结果：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>12<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">important</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">important</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">created</span>&gt;</span>1482856467282<span class=\"tag\">&lt;/<span class=\"name\">created</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>属性</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamAlias</span>(<span class=\"string\">\"type\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@XStreamAsAttribute</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> messageType;</span><br></pre></td></tr></table></figure>\n<p>输出结果</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">type</span>=<span class=\"string\">\"12\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">important</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">important</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">created</span>&gt;</span>1482856554517<span class=\"tag\">&lt;/<span class=\"name\">created</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>忽略一些字段</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">type</span>=<span class=\"string\">\"12\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">created</span>&gt;</span>1482856661757<span class=\"tag\">&lt;/<span class=\"name\">created</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p><code>important</code> 属性已经被隐藏</p>\n<h4 id=\"自动扫描注解\"><a href=\"#自动扫描注解\" class=\"headerlink\" title=\"自动扫描注解\"></a>自动扫描注解</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.autodetectAnnotations(<span class=\"keyword\">true</span>);</span><br></pre></td></tr></table></figure>\n<h2 id=\"xml转对象\"><a href=\"#xml转对象\" class=\"headerlink\" title=\"xml转对象\"></a>xml转对象</h2> <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RendezvousMessage deserializedMessage = (RendezvousMessage) xStream.fromXML(<span class=\"string\">\"&lt;message type=\\\"12\\\"&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"  &lt;part&gt;first content&lt;/part&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"  &lt;part&gt;second content&lt;/part&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"  &lt;created&gt;1482859234272&lt;/created&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"&lt;/message&gt;\"</span>);</span><br></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"http://x-stream.github.io/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">About XStream</a></p>\n</li>\n<li><p><a href=\"http://x-stream.github.io/alias-tutorial.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Alias Tutorial</a></p>\n</li>\n<li><p><a href=\"http://x-stream.github.io/annotations-tutorial.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Annotations Tutorial</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h1><p><img src=\"http://x-stream.github.io/logo.gif\" alt=\"\"></p>\n<h2 id=\"pom依赖\"><a href=\"#pom依赖\" class=\"headerlink\" title=\"pom依赖\"></a>pom依赖</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- https://mvnrepository.com/artifact/com.thoughtworks.xstream/xstream --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.thoughtworks.xstream<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>xstream<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.3.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"输出xml\"><a href=\"#输出xml\" class=\"headerlink\" title=\"输出xml\"></a>输出xml</h2><h3 id=\"手动配置\"><a href=\"#手动配置\" class=\"headerlink\" title=\"手动配置\"></a>手动配置</h3><p>Author 类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Author</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Author</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Entry 类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Entry</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String title, description;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Entry</span><span class=\"params\">(String title, String description)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.title = title;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.description = description;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Blog 类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Blog</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Author writer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List entries = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Blog</span><span class=\"params\">(Author writer)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.writer = writer;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(Entry entry)</span> </span>&#123;</span><br><span class=\"line\">        entries.add(entry);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">getContent</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> entries;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Blog teamBlog = <span class=\"keyword\">new</span> Blog(<span class=\"keyword\">new</span> Author(<span class=\"string\">\"qisheng.li\"</span>));</span><br><span class=\"line\">        teamBlog.add(<span class=\"keyword\">new</span> Entry(<span class=\"string\">\"first\"</span>, <span class=\"string\">\"first blog entry\"</span>));</span><br><span class=\"line\">        teamBlog.add(<span class=\"keyword\">new</span> Entry(<span class=\"string\">\"second\"</span>, <span class=\"string\">\"second blog entry\"</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        XStream xStream = <span class=\"keyword\">new</span> XStream();</span><br><span class=\"line\">        System.out.println(xStream.toXML(teamBlog));        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出的内容为:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">com.air.xml.xstream.alias.Blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">com.air.xml.xstream.alias.Entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">com.air.xml.xstream.alias.Blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><em>默认输出的类，是fully qualified name，可以手动设置别名</em></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//alias</span></span><br><span class=\"line\">        xStream.alias(<span class=\"string\">\"blog\"</span>, Blog.class);</span><br><span class=\"line\">        xStream.alias(<span class=\"string\">\"entry\"</span>, Entry.class);</span><br></pre></td></tr></table></figure>\n<p>输出:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">writer</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><em>也可以设置属性级别的别名</em></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.aliasField(<span class=\"string\">\"author\"</span>, Blog.class, <span class=\"string\">\"writter\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entries</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><em>包级别的别名</em></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.aliasPackage(<span class=\"string\">\"aliased.pachage.name\"</span>, <span class=\"string\">\"com.air.xml.xstream.alias\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出的xml:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aliased.pachage.name.Blog</span> <span class=\"attr\">author</span>=<span class=\"string\">\"qisheng.li\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aliased.pachage.name.Blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Implicit-Collections\"><a href=\"#Implicit-Collections\" class=\"headerlink\" title=\"Implicit Collections\"></a>Implicit Collections</h4><blockquote>\n<p>implicit collection: whenever you have a collection which doesn’t need to display it’s root tag, you can map it as an implicit collection.</p>\n</blockquote>\n<p>如果不想展示一个集合的root节点，比如上述的<code>entries</code>，可以将其当做一个<code>implicit collection</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//implicit collection</span></span><br><span class=\"line\">xStream.addImplicitCollection(Blog.class, <span class=\"string\">\"entries\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>qisheng.li<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">author</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>可以看到<code>entries</code>这个节点已经没有了</p>\n<h4 id=\"field输出为属性值\"><a href=\"#field输出为属性值\" class=\"headerlink\" title=\"field输出为属性值\"></a>field输出为属性值</h4><p>接着上面的例子，我们现在想让Blog的writer输出为Blog标签的属性值。</p>\n<p>实现步骤：</p>\n<p>1.创建一个转换器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AuthorConverter</span>  <span class=\"keyword\">implements</span> <span class=\"title\">SingleValueConverter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ((Author) obj).getName();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">fromString</span><span class=\"params\">(String str)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Author(str);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canConvert</span><span class=\"params\">(Class type)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> type.equals(Author.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2.注册这个转换器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.registerConverter(<span class=\"keyword\">new</span> AuthorConverter());</span><br></pre></td></tr></table></figure>\n<p>3.告诉XStream</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//attribute aliasing</span></span><br><span class=\"line\">xStream.useAttributeFor(Blog.class, <span class=\"string\">\"writer\"</span>);</span><br><span class=\"line\">xStream.registerConverter(<span class=\"keyword\">new</span> AuthorConverter());</span><br><span class=\"line\"><span class=\"comment\">//field alias</span></span><br><span class=\"line\">xStream.aliasField(<span class=\"string\">\"author\"</span>, Blog.class, <span class=\"string\">\"writer\"</span>);</span><br></pre></td></tr></table></figure>\n<p>输出的xml：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">blog</span> <span class=\"attr\">author</span>=<span class=\"string\">\"qisheng.li\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>first<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>first blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>second blog entry<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">entry</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">blog</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于注解\"><a href=\"#基于注解\" class=\"headerlink\" title=\"基于注解\"></a>基于注解</h3><p>主要使用的是<code>XStreamAlias</code>注解来标记别名</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamAlias</span>(<span class=\"string\">\"message\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RendezvousMessage</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@XStreamAlias</span>(<span class=\"string\">\"type\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> messageType;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RendezvousMessage</span><span class=\"params\">(<span class=\"keyword\">int</span> messageType)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.messageType = messageType;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        XStream xStream = <span class=\"keyword\">new</span> XStream();</span><br><span class=\"line\">        xStream.processAnnotations(RendezvousMessage.class);</span><br><span class=\"line\">        RendezvousMessage rendezvousMessage = <span class=\"keyword\">new</span> RendezvousMessage(<span class=\"number\">12</span>);</span><br><span class=\"line\">        System.out.println(xStream.toXML(rendezvousMessage));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>xml 输出</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>12<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>ImplicitCollection</li>\n</ul>\n<p>使用 <code>@XstreamImplicit(itemFieldName = &quot;xxx&quot;)</code>来处理</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamImplicit</span>(itemFieldName = <span class=\"string\">\"part\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">private</span> List&lt;String&gt; content;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>12<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>converter</li>\n</ul>\n<p>添加一个属性字段并指明他使用的转换器, 和一个基本类型——boolean</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamConverter</span>(value=BooleanConverter.class)</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> important;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@XStreamConverter</span>(SingleValueCalendarConverter.class)</span><br><span class=\"line\"><span class=\"keyword\">private</span> Calendar created = <span class=\"keyword\">new</span> GregorianCalendar();</span><br></pre></td></tr></table></figure>\n<p>转化器代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SingleValueCalendarConverter</span> <span class=\"keyword\">implements</span> <span class=\"title\">Converter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">marshal</span><span class=\"params\">(Object source, HierarchicalStreamWriter writer, MarshallingContext context)</span> </span>&#123;</span><br><span class=\"line\">        Calendar calendar = (Calendar) source;</span><br><span class=\"line\">        writer.setValue(String.valueOf(calendar.getTime().getTime()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">unmarshal</span><span class=\"params\">(HierarchicalStreamReader reader, UnmarshallingContext context)</span> </span>&#123;</span><br><span class=\"line\">        GregorianCalendar calendar = <span class=\"keyword\">new</span> GregorianCalendar();</span><br><span class=\"line\">        calendar.setTime(<span class=\"keyword\">new</span> Date(Long.parseLong(reader.getValue())));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> calendar;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canConvert</span><span class=\"params\">(Class type)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> type.equals(GregorianCalendar.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出的xml结果：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>12<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">important</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">important</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">created</span>&gt;</span>1482856467282<span class=\"tag\">&lt;/<span class=\"name\">created</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>属性</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@XStreamAlias</span>(<span class=\"string\">\"type\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@XStreamAsAttribute</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> messageType;</span><br></pre></td></tr></table></figure>\n<p>输出结果</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">type</span>=<span class=\"string\">\"12\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">important</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">important</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">created</span>&gt;</span>1482856554517<span class=\"tag\">&lt;/<span class=\"name\">created</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>忽略一些字段</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">type</span>=<span class=\"string\">\"12\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>first content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">part</span>&gt;</span>second content<span class=\"tag\">&lt;/<span class=\"name\">part</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">created</span>&gt;</span>1482856661757<span class=\"tag\">&lt;/<span class=\"name\">created</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p><code>important</code> 属性已经被隐藏</p>\n<h4 id=\"自动扫描注解\"><a href=\"#自动扫描注解\" class=\"headerlink\" title=\"自动扫描注解\"></a>自动扫描注解</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xStream.autodetectAnnotations(<span class=\"keyword\">true</span>);</span><br></pre></td></tr></table></figure>\n<h2 id=\"xml转对象\"><a href=\"#xml转对象\" class=\"headerlink\" title=\"xml转对象\"></a>xml转对象</h2> <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RendezvousMessage deserializedMessage = (RendezvousMessage) xStream.fromXML(<span class=\"string\">\"&lt;message type=\\\"12\\\"&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"  &lt;part&gt;first content&lt;/part&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"  &lt;part&gt;second content&lt;/part&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"  &lt;created&gt;1482859234272&lt;/created&gt;\\n\"</span> +</span><br><span class=\"line\">        <span class=\"string\">\"&lt;/message&gt;\"</span>);</span><br></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><p><a href=\"http://x-stream.github.io/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">About XStream</a></p>\n</li>\n<li><p><a href=\"http://x-stream.github.io/alias-tutorial.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Alias Tutorial</a></p>\n</li>\n<li><p><a href=\"http://x-stream.github.io/annotations-tutorial.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Annotations Tutorial</a></p>\n</li>\n</ol>\n"},{"title":"plantuml——用编码的方式画UML","toc":true,"abbrlink":52670,"date":"2016-10-15T16:56:07.000Z","_content":"## 是什么？\n\n>PlantUML is a component that allows to quickly write :\n\n> * Sequence diagram,\n\n> * Usecase diagram,\n\n> * Class diagram,\n\n> * Activity diagram, (here is the new syntax),\n\n> * Component diagram,\n\n> * State diagram,\n\n> * Deployment diagram,\n\n> * Object diagram.\n\n> * wireframe graphical interface\n\n> Diagrams are defined using a simple and intuitive  language. ( see PlantUML Language Reference Guide).\n\n## 例子\n\n```\n{% plantuml %}\nskinparam backgroundColor #EEEBDC\nskinparam handwritten true\n\nskinparam sequence {\n\tArrowColor DeepSkyBlue\n\tActorBorderColor DeepSkyBlue\n\tLifeLineBorderColor blue\n\tLifeLineBackgroundColor #A9DCDF\n\n\tParticipantBorderColor DeepSkyBlue\n\tParticipantBackgroundColor DodgerBlue\n\tParticipantFontName Impact\n\tParticipantFontSize 17\n\tParticipantFontColor #A9DCDF\n\n\tActorBackgroundColor aqua\n\tActorFontColor DeepSkyBlue\n\tActorFontSize 17\n\tActorFontName Aapex\n}\n\nactor User\nparticipant \"First Class\" as A\nparticipant \"Second Class\" as B\nparticipant \"Last Class\" as C\n\nUser -> A: DoWork\nactivate A\n\nA -> B: Create Request\nactivate B\n\nB -> C: DoWork\nactivate C\nC --> B: WorkDone\ndestroy C\n\nB --> A: Request Created\ndeactivate B\n\nA --> User: Done\ndeactivate A\n\n{% endplantuml %}\n```\n\n上述代码的效果如下：\n\n{% plantuml %}\n\nskinparam backgroundColor #EEEBDC\nskinparam handwritten true\n\nskinparam sequence {\n\tArrowColor DeepSkyBlue\n\tActorBorderColor DeepSkyBlue\n\tLifeLineBorderColor blue\n\tLifeLineBackgroundColor #A9DCDF\n\n\tParticipantBorderColor DeepSkyBlue\n\tParticipantBackgroundColor DodgerBlue\n\tParticipantFontName Impact\n\tParticipantFontSize 17\n\tParticipantFontColor #A9DCDF\n\n\tActorBackgroundColor aqua\n\tActorFontColor DeepSkyBlue\n\tActorFontSize 17\n\tActorFontName Aapex\n}\n\nactor User\nparticipant \"First Class\" as A\nparticipant \"Second Class\" as B\nparticipant \"Last Class\" as C\n\nUser -> A: DoWork\nactivate A\n\nA -> B: Create Request\nactivate B\n\nB -> C: DoWork\nactivate C\nC --> B: WorkDone\ndestroy C\n\nB --> A: Request Created\ndeactivate B\n\nA --> User: Done\ndeactivate A\n\n{% endplantuml %}\n\n## 平台\n\n可以在chromeapp中找到： [链接](https://chrome.google.com/webstore/detail/uml-diagram-editor/hoepdgfgogmeofkgkpapbdpdjkplcode?utm_source=chrome-ntp-icon), 开箱即用\n\n另可以和idea和eclipse、atom等编辑器集成，hexo中也有相应的插件，具体可看下面的教程\n\n## 参考\n\n1. [(记录)plantuml安装配置](http://skyao.github.io/2014/12/05/plantuml-installation/index.html)\n\n2. [Hexo博客中的绘图](http://keyun.ml/2016/07/25/2016-07-25-hexo-uml.html)\n\n3. [官网](http://plantuml.com/)\n","source":"_posts/plantuml.md","raw":"---\ntitle: plantuml——用编码的方式画UML\ntags: uml\ncategory: hexo\ntoc: true\nabbrlink: 52670\ndate: 2016-10-16 00:56:07\n---\n## 是什么？\n\n>PlantUML is a component that allows to quickly write :\n\n> * Sequence diagram,\n\n> * Usecase diagram,\n\n> * Class diagram,\n\n> * Activity diagram, (here is the new syntax),\n\n> * Component diagram,\n\n> * State diagram,\n\n> * Deployment diagram,\n\n> * Object diagram.\n\n> * wireframe graphical interface\n\n> Diagrams are defined using a simple and intuitive  language. ( see PlantUML Language Reference Guide).\n\n## 例子\n\n```\n{% plantuml %}\nskinparam backgroundColor #EEEBDC\nskinparam handwritten true\n\nskinparam sequence {\n\tArrowColor DeepSkyBlue\n\tActorBorderColor DeepSkyBlue\n\tLifeLineBorderColor blue\n\tLifeLineBackgroundColor #A9DCDF\n\n\tParticipantBorderColor DeepSkyBlue\n\tParticipantBackgroundColor DodgerBlue\n\tParticipantFontName Impact\n\tParticipantFontSize 17\n\tParticipantFontColor #A9DCDF\n\n\tActorBackgroundColor aqua\n\tActorFontColor DeepSkyBlue\n\tActorFontSize 17\n\tActorFontName Aapex\n}\n\nactor User\nparticipant \"First Class\" as A\nparticipant \"Second Class\" as B\nparticipant \"Last Class\" as C\n\nUser -> A: DoWork\nactivate A\n\nA -> B: Create Request\nactivate B\n\nB -> C: DoWork\nactivate C\nC --> B: WorkDone\ndestroy C\n\nB --> A: Request Created\ndeactivate B\n\nA --> User: Done\ndeactivate A\n\n{% endplantuml %}\n```\n\n上述代码的效果如下：\n\n{% plantuml %}\n\nskinparam backgroundColor #EEEBDC\nskinparam handwritten true\n\nskinparam sequence {\n\tArrowColor DeepSkyBlue\n\tActorBorderColor DeepSkyBlue\n\tLifeLineBorderColor blue\n\tLifeLineBackgroundColor #A9DCDF\n\n\tParticipantBorderColor DeepSkyBlue\n\tParticipantBackgroundColor DodgerBlue\n\tParticipantFontName Impact\n\tParticipantFontSize 17\n\tParticipantFontColor #A9DCDF\n\n\tActorBackgroundColor aqua\n\tActorFontColor DeepSkyBlue\n\tActorFontSize 17\n\tActorFontName Aapex\n}\n\nactor User\nparticipant \"First Class\" as A\nparticipant \"Second Class\" as B\nparticipant \"Last Class\" as C\n\nUser -> A: DoWork\nactivate A\n\nA -> B: Create Request\nactivate B\n\nB -> C: DoWork\nactivate C\nC --> B: WorkDone\ndestroy C\n\nB --> A: Request Created\ndeactivate B\n\nA --> User: Done\ndeactivate A\n\n{% endplantuml %}\n\n## 平台\n\n可以在chromeapp中找到： [链接](https://chrome.google.com/webstore/detail/uml-diagram-editor/hoepdgfgogmeofkgkpapbdpdjkplcode?utm_source=chrome-ntp-icon), 开箱即用\n\n另可以和idea和eclipse、atom等编辑器集成，hexo中也有相应的插件，具体可看下面的教程\n\n## 参考\n\n1. [(记录)plantuml安装配置](http://skyao.github.io/2014/12/05/plantuml-installation/index.html)\n\n2. [Hexo博客中的绘图](http://keyun.ml/2016/07/25/2016-07-25-hexo-uml.html)\n\n3. [官网](http://plantuml.com/)\n","slug":"plantuml","published":1,"updated":"2017-04-16T12:04:30.010Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjgulsdw700c8jh4kxt2buogr","content":"<h2 id=\"是什么？\"><a href=\"#是什么？\" class=\"headerlink\" title=\"是什么？\"></a>是什么？</h2><blockquote>\n<p>PlantUML is a component that allows to quickly write :</p>\n<ul>\n<li><p>Sequence diagram,</p>\n</li>\n<li><p>Usecase diagram,</p>\n</li>\n<li><p>Class diagram,</p>\n</li>\n<li><p>Activity diagram, (here is the new syntax),</p>\n</li>\n<li><p>Component diagram,</p>\n</li>\n<li><p>State diagram,</p>\n</li>\n<li><p>Deployment diagram,</p>\n</li>\n<li><p>Object diagram.</p>\n</li>\n<li><p>wireframe graphical interface</p>\n</li>\n</ul>\n<p>Diagrams are defined using a simple and intuitive  language. ( see PlantUML Language Reference Guide).</p>\n</blockquote>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% plantuml %&#125;</span><br><span class=\"line\">skinparam backgroundColor #EEEBDC</span><br><span class=\"line\">skinparam handwritten true</span><br><span class=\"line\"></span><br><span class=\"line\">skinparam sequence &#123;</span><br><span class=\"line\">\tArrowColor DeepSkyBlue</span><br><span class=\"line\">\tActorBorderColor DeepSkyBlue</span><br><span class=\"line\">\tLifeLineBorderColor blue</span><br><span class=\"line\">\tLifeLineBackgroundColor #A9DCDF</span><br><span class=\"line\"></span><br><span class=\"line\">\tParticipantBorderColor DeepSkyBlue</span><br><span class=\"line\">\tParticipantBackgroundColor DodgerBlue</span><br><span class=\"line\">\tParticipantFontName Impact</span><br><span class=\"line\">\tParticipantFontSize 17</span><br><span class=\"line\">\tParticipantFontColor #A9DCDF</span><br><span class=\"line\"></span><br><span class=\"line\">\tActorBackgroundColor aqua</span><br><span class=\"line\">\tActorFontColor DeepSkyBlue</span><br><span class=\"line\">\tActorFontSize 17</span><br><span class=\"line\">\tActorFontName Aapex</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">actor User</span><br><span class=\"line\">participant &quot;First Class&quot; as A</span><br><span class=\"line\">participant &quot;Second Class&quot; as B</span><br><span class=\"line\">participant &quot;Last Class&quot; as C</span><br><span class=\"line\"></span><br><span class=\"line\">User -&gt; A: DoWork</span><br><span class=\"line\">activate A</span><br><span class=\"line\"></span><br><span class=\"line\">A -&gt; B: Create Request</span><br><span class=\"line\">activate B</span><br><span class=\"line\"></span><br><span class=\"line\">B -&gt; C: DoWork</span><br><span class=\"line\">activate C</span><br><span class=\"line\">C --&gt; B: WorkDone</span><br><span class=\"line\">destroy C</span><br><span class=\"line\"></span><br><span class=\"line\">B --&gt; A: Request Created</span><br><span class=\"line\">deactivate B</span><br><span class=\"line\"></span><br><span class=\"line\">A --&gt; User: Done</span><br><span class=\"line\">deactivate A</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;% endplantuml %&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码的效果如下：</p>\n<img src=\"http://www.plantuml.com/plantuml/svg/TP8zJyCm48Rdtg-mojo12T41oNPQ2Qb2Y0enN-EZM6djzEnG2kA_4wSL-OBrdlShLY0KrfN8k1SRp8ij-yePxNUUnTLYiL2PXbRnXiuSsSP8JaIk23eiqA4YbvFuWebaziTpI4PKhekJsjNgYSoZP-NP4Fz1L_QLLjPHLx3fa-52UPlfR0amUKIEDhSbklXlVbSp2CgysHAFP4lluWFkITplIypZYAtj9udhcz5zkExytODEF5HuGQrd_5ozdjzBiqfYIH_m3O3fB9u3CPJj4Z5TMWvHw1s6C1KOXEpZDUNUcGvNVRx2dbi3f0enknDoNZ_PY-SYLTjtZFKO09cGcWlDb2vFwOy8iPKe09KaUkpMeCNix4uWyux0r6RsfzIh6bYtNZ8l5QRMTDDb8qiZKqCJqTdt0m00\">\n<h2 id=\"平台\"><a href=\"#平台\" class=\"headerlink\" title=\"平台\"></a>平台</h2><p>可以在chromeapp中找到： <a href=\"https://chrome.google.com/webstore/detail/uml-diagram-editor/hoepdgfgogmeofkgkpapbdpdjkplcode?utm_source=chrome-ntp-icon\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">链接</a>, 开箱即用</p>\n<p>另可以和idea和eclipse、atom等编辑器集成，hexo中也有相应的插件，具体可看下面的教程</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://skyao.github.io/2014/12/05/plantuml-installation/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">(记录)plantuml安装配置</a></p>\n</li>\n<li><p><a href=\"http://keyun.ml/2016/07/25/2016-07-25-hexo-uml.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo博客中的绘图</a></p>\n</li>\n<li><p><a href=\"http://plantuml.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">官网</a></p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"是什么？\"><a href=\"#是什么？\" class=\"headerlink\" title=\"是什么？\"></a>是什么？</h2><blockquote>\n<p>PlantUML is a component that allows to quickly write :</p>\n<ul>\n<li><p>Sequence diagram,</p>\n</li>\n<li><p>Usecase diagram,</p>\n</li>\n<li><p>Class diagram,</p>\n</li>\n<li><p>Activity diagram, (here is the new syntax),</p>\n</li>\n<li><p>Component diagram,</p>\n</li>\n<li><p>State diagram,</p>\n</li>\n<li><p>Deployment diagram,</p>\n</li>\n<li><p>Object diagram.</p>\n</li>\n<li><p>wireframe graphical interface</p>\n</li>\n</ul>\n<p>Diagrams are defined using a simple and intuitive  language. ( see PlantUML Language Reference Guide).</p>\n</blockquote>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% plantuml %&#125;</span><br><span class=\"line\">skinparam backgroundColor #EEEBDC</span><br><span class=\"line\">skinparam handwritten true</span><br><span class=\"line\"></span><br><span class=\"line\">skinparam sequence &#123;</span><br><span class=\"line\">\tArrowColor DeepSkyBlue</span><br><span class=\"line\">\tActorBorderColor DeepSkyBlue</span><br><span class=\"line\">\tLifeLineBorderColor blue</span><br><span class=\"line\">\tLifeLineBackgroundColor #A9DCDF</span><br><span class=\"line\"></span><br><span class=\"line\">\tParticipantBorderColor DeepSkyBlue</span><br><span class=\"line\">\tParticipantBackgroundColor DodgerBlue</span><br><span class=\"line\">\tParticipantFontName Impact</span><br><span class=\"line\">\tParticipantFontSize 17</span><br><span class=\"line\">\tParticipantFontColor #A9DCDF</span><br><span class=\"line\"></span><br><span class=\"line\">\tActorBackgroundColor aqua</span><br><span class=\"line\">\tActorFontColor DeepSkyBlue</span><br><span class=\"line\">\tActorFontSize 17</span><br><span class=\"line\">\tActorFontName Aapex</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">actor User</span><br><span class=\"line\">participant &quot;First Class&quot; as A</span><br><span class=\"line\">participant &quot;Second Class&quot; as B</span><br><span class=\"line\">participant &quot;Last Class&quot; as C</span><br><span class=\"line\"></span><br><span class=\"line\">User -&gt; A: DoWork</span><br><span class=\"line\">activate A</span><br><span class=\"line\"></span><br><span class=\"line\">A -&gt; B: Create Request</span><br><span class=\"line\">activate B</span><br><span class=\"line\"></span><br><span class=\"line\">B -&gt; C: DoWork</span><br><span class=\"line\">activate C</span><br><span class=\"line\">C --&gt; B: WorkDone</span><br><span class=\"line\">destroy C</span><br><span class=\"line\"></span><br><span class=\"line\">B --&gt; A: Request Created</span><br><span class=\"line\">deactivate B</span><br><span class=\"line\"></span><br><span class=\"line\">A --&gt; User: Done</span><br><span class=\"line\">deactivate A</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;% endplantuml %&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码的效果如下：</p>\n<img src=\"http://www.plantuml.com/plantuml/svg/TP8zJyCm48Rdtg-mojo12T41oNPQ2Qb2Y0enN-EZM6djzEnG2kA_4wSL-OBrdlShLY0KrfN8k1SRp8ij-yePxNUUnTLYiL2PXbRnXiuSsSP8JaIk23eiqA4YbvFuWebaziTpI4PKhekJsjNgYSoZP-NP4Fz1L_QLLjPHLx3fa-52UPlfR0amUKIEDhSbklXlVbSp2CgysHAFP4lluWFkITplIypZYAtj9udhcz5zkExytODEF5HuGQrd_5ozdjzBiqfYIH_m3O3fB9u3CPJj4Z5TMWvHw1s6C1KOXEpZDUNUcGvNVRx2dbi3f0enknDoNZ_PY-SYLTjtZFKO09cGcWlDb2vFwOy8iPKe09KaUkpMeCNix4uWyux0r6RsfzIh6bYtNZ8l5QRMTDDb8qiZKqCJqTdt0m00\">\n<h2 id=\"平台\"><a href=\"#平台\" class=\"headerlink\" title=\"平台\"></a>平台</h2><p>可以在chromeapp中找到： <a href=\"https://chrome.google.com/webstore/detail/uml-diagram-editor/hoepdgfgogmeofkgkpapbdpdjkplcode?utm_source=chrome-ntp-icon\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">链接</a>, 开箱即用</p>\n<p>另可以和idea和eclipse、atom等编辑器集成，hexo中也有相应的插件，具体可看下面的教程</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ol>\n<li><p><a href=\"http://skyao.github.io/2014/12/05/plantuml-installation/index.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">(记录)plantuml安装配置</a></p>\n</li>\n<li><p><a href=\"http://keyun.ml/2016/07/25/2016-07-25-hexo-uml.html\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">Hexo博客中的绘图</a></p>\n</li>\n<li><p><a href=\"http://plantuml.com/\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\">官网</a></p>\n</li>\n</ol>\n"}],"PostAsset":[{"_id":"source/_posts/cache-system-time/time-cache.jpg","slug":"time-cache.jpg","post":"cjgulsd8q004ujh4k4c0ykylk","modified":1,"renderable":0},{"_id":"source/_posts/git-branch-log/idea.png","slug":"idea.png","post":"cjgulsd90005gjh4kdu5mxkht","modified":1,"renderable":0},{"_id":"source/_posts/top/fields.png","slug":"fields.png","post":"cjgulsdax00a7jh4k3iektjnq","modified":1,"renderable":0},{"_id":"source/_posts/top/highlight-sort.png","slug":"highlight-sort.png","post":"cjgulsdax00a7jh4k3iektjnq","modified":1,"renderable":0},{"_id":"source/_posts/top/top-thread","slug":"top-thread","post":"cjgulsdax00a7jh4k3iektjnq","modified":1,"renderable":0},{"_id":"source/_drafts/gc-cms/cms.jpg","slug":"cms.jpg","post":"cjgulsd6w001bjh4ki85d9tlm","modified":1,"renderable":0},{"_id":"source/_posts/git-branch-log/idea-sorted.png","slug":"idea-sorted.png","post":"cjgulsd90005gjh4kdu5mxkht","modified":1,"renderable":0},{"_id":"source/_posts/markdown-mindmap/relations.png","slug":"relations.png","post":"cjgulsda0007zjh4kuxf1fqwp","modified":1,"renderable":0},{"_id":"source/_posts/pagination/PPC2009_mysql_pagination.pdf","slug":"PPC2009_mysql_pagination.pdf","post":"cjgulsda4008ajh4k1sffayxq","modified":1,"renderable":0},{"_id":"source/_posts/top/cpu.png","slug":"cpu.png","post":"cjgulsdax00a7jh4k3iektjnq","modified":1,"renderable":0},{"_id":"source/_posts/top/top-a.png","slug":"top-a.png","post":"cjgulsdax00a7jh4k3iektjnq","modified":1,"renderable":0},{"_id":"source/_posts/dubbo-generic-invoke/generic.png","post":"cjgulsd91005jjh4kz9viz7g2","slug":"generic.png","modified":1,"renderable":1},{"_id":"source/_posts/go-figure/go-tour.png","post":"cjgulsd92005mjh4kqt4pipbr","slug":"go-tour.png","modified":1,"renderable":1},{"_id":"source/_posts/greys-start/attach.jpg","post":"cjgulsd980062jh4khkvqckho","slug":"attach.jpg","modified":1,"renderable":1},{"_id":"source/_posts/idea-template/profiles.jpg","post":"cjgulsd9g006mjh4khprju80m","slug":"profiles.jpg","modified":1,"renderable":1},{"_id":"source/_posts/jackson-guava/jar.png","post":"cjgulsd9i006pjh4k80qcy1dp","slug":"jar.png","modified":1,"renderable":1},{"_id":"source/_posts/jinfo/jinfo.png","post":"cjgulsd9s007djh4kjd2ntuhp","slug":"jinfo.png","modified":1,"renderable":1},{"_id":"source/_posts/spi/usage.jpg","post":"cjgulsdai0097jh4k3jm4qk8v","slug":"usage.jpg","modified":1,"renderable":1},{"_id":"source/_posts/spring-resource/resource.jpg","post":"cjgulsdao009mjh4kjrj8c043","slug":"resource.jpg","modified":1,"renderable":1},{"_id":"source/_posts/tomcat-connection/tomcat-interaction.jpg","post":"cjgulsdat009yjh4kmxf0orpa","slug":"tomcat-interaction.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/gc-basic/g1.jpg","post":"cjgulsd6s0011jh4kctlxjynw","slug":"g1.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/gc-basic/gc.jpg","post":"cjgulsd6s0011jh4kctlxjynw","slug":"gc.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/http/10-21-http-request.png","post":"cjgulsd6x001fjh4k026vn6wj","slug":"10-21-http-request.png","modified":1,"renderable":1},{"_id":"source/_drafts/http/http_request_message.png","post":"cjgulsd6x001fjh4k026vn6wj","slug":"http_request_message.png","modified":1,"renderable":1},{"_id":"source/_posts/base64/encoding.jpg","post":"cjgulsd8p004rjh4kbyspxyno","slug":"encoding.jpg","modified":1,"renderable":1},{"_id":"source/_posts/base64/encoding2.jpg","post":"cjgulsd8p004rjh4kbyspxyno","slug":"encoding2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/grep/color.jpg","post":"cjgulsd96005xjh4kdgcj1f7x","slug":"color.jpg","modified":1,"renderable":1},{"_id":"source/_posts/grep/egrep.jpg","post":"cjgulsd96005xjh4kdgcj1f7x","slug":"egrep.jpg","modified":1,"renderable":1},{"_id":"source/_posts/jsonp/cors.png","post":"cjgulsd9t007gjh4kf94awg4u","slug":"cors.png","modified":1,"renderable":1},{"_id":"source/_posts/jsonp/sample.png","post":"cjgulsd9t007gjh4kf94awg4u","slug":"sample.png","modified":1,"renderable":1},{"_id":"source/_posts/markdown-here/additional.jpg","post":"cjgulsd9w007qjh4kx4xj7f5h","slug":"additional.jpg","modified":1,"renderable":1},{"_id":"source/_posts/markdown-here/mail.jpg","post":"cjgulsd9w007qjh4kx4xj7f5h","slug":"mail.jpg","modified":1,"renderable":1},{"_id":"source/_posts/markdown-mindmap/sample.jpg","post":"cjgulsda0007zjh4kuxf1fqwp","slug":"sample.jpg","modified":1,"renderable":1},{"_id":"source/_posts/postgre/arch.jpg","post":"cjgulsda9008ljh4kaa5sl0hv","slug":"arch.jpg","modified":1,"renderable":1},{"_id":"source/_posts/postgre/history.jpg","post":"cjgulsda9008ljh4kaa5sl0hv","slug":"history.jpg","modified":1,"renderable":1},{"_id":"source/_posts/spring-mvc-2/spring-mvc.png","post":"cjgulsdal009gjh4k2iqew9zl","slug":"spring-mvc.png","modified":1,"renderable":1},{"_id":"source/_posts/spring-mvc-2/springmvc.log","slug":"springmvc.log","post":"cjgulsdal009gjh4k2iqew9zl","modified":1,"renderable":0},{"_id":"source/_drafts/jackson-custom/BeanSerializer.jpg","post":"cjgulsd77001vjh4kngxpnq8l","slug":"BeanSerializer.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/jackson-custom/BeanSerializerBase.jpg","post":"cjgulsd77001vjh4kngxpnq8l","slug":"BeanSerializerBase.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/jackson-custom/DefaultSerializerProvider.jpg","post":"cjgulsd77001vjh4kngxpnq8l","slug":"DefaultSerializerProvider.jpg","modified":1,"renderable":1},{"_id":"source/_posts/character-encoding/Unicode_logo.jpg","post":"cjgulsd8t0050jh4ky7bsu2mx","slug":"Unicode_logo.jpg","modified":1,"renderable":1},{"_id":"source/_posts/character-encoding/emoji.jpg","post":"cjgulsd8t0050jh4ky7bsu2mx","slug":"emoji.jpg","modified":1,"renderable":1},{"_id":"source/_posts/character-encoding/unicode-layout.jpg","post":"cjgulsd8t0050jh4ky7bsu2mx","slug":"unicode-layout.jpg","modified":1,"renderable":1},{"_id":"source/_posts/google-perf-tools/2017年 09月 05日 星期二 01:34:24 CST.png","post":"cjgulsd97005zjh4kbe0xku6a","slug":"2017年 09月 05日 星期二 01:34:24 CST.png","modified":1,"renderable":1},{"_id":"source/_posts/google-perf-tools/memory-mapping.jpg","post":"cjgulsd97005zjh4kbe0xku6a","slug":"memory-mapping.jpg","modified":1,"renderable":1},{"_id":"source/_posts/google-perf-tools/result.pdf","post":"cjgulsd97005zjh4kbe0xku6a","slug":"result.pdf","modified":1,"renderable":1},{"_id":"source/_posts/property-placeholder/hierarchy.jpg","post":"cjgulsdag0093jh4kys41esyj","slug":"hierarchy.jpg","modified":1,"renderable":1},{"_id":"source/_posts/property-placeholder/location.jpg","post":"cjgulsdag0093jh4kys41esyj","slug":"location.jpg","modified":1,"renderable":1},{"_id":"source/_posts/property-placeholder/post-processors.jpg","post":"cjgulsdag0093jh4kys41esyj","slug":"post-processors.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/inode/example.jpg","post":"cjgulsd73001mjh4kdqagk4c5","slug":"example.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/inode/high-level.jpg","post":"cjgulsd73001mjh4kdqagk4c5","slug":"high-level.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/inode/low-level.jpg","post":"cjgulsd73001mjh4kdqagk4c5","slug":"low-level.jpg","modified":1,"renderable":1},{"_id":"source/_drafts/inode/unix-file-structure.jpg","post":"cjgulsd73001mjh4kdqagk4c5","slug":"unix-file-structure.jpg","modified":1,"renderable":1},{"_id":"source/_posts/HttpMessageConverter/DispatcherServlet-properties.jpg","post":"cjgulsd8k004ejh4ks64jy9ky","slug":"DispatcherServlet-properties.jpg","modified":1,"renderable":1},{"_id":"source/_posts/HttpMessageConverter/arch.jpg","post":"cjgulsd8k004ejh4ks64jy9ky","slug":"arch.jpg","modified":1,"renderable":1},{"_id":"source/_posts/HttpMessageConverter/http-message-converter.jpg","post":"cjgulsd8k004ejh4ks64jy9ky","slug":"http-message-converter.jpg","modified":1,"renderable":1},{"_id":"source/_posts/HttpMessageConverter/inherit.jpg","post":"cjgulsd8k004ejh4ks64jy9ky","slug":"inherit.jpg","modified":1,"renderable":1},{"_id":"source/_posts/electron/electron.jpg","post":"cjgulsd8w0056jh4kpka0nrwi","slug":"electron.jpg","modified":1,"renderable":1},{"_id":"source/_posts/electron/item.png","post":"cjgulsd8w0056jh4kpka0nrwi","slug":"item.png","modified":1,"renderable":1},{"_id":"source/_posts/electron/mojibar.gif","slug":"mojibar.gif","post":"cjgulsd8w0056jh4kpka0nrwi","modified":1,"renderable":0},{"_id":"source/_posts/electron/select.png","post":"cjgulsd8w0056jh4kpka0nrwi","slug":"select.png","modified":1,"renderable":1},{"_id":"source/_posts/git-branch-log/glgg.png","post":"cjgulsd90005gjh4kdu5mxkht","slug":"glgg.png","modified":1,"renderable":1},{"_id":"source/_posts/git-branch-log/glgga.png","post":"cjgulsd90005gjh4kdu5mxkht","slug":"glgga.png","modified":1,"renderable":1},{"_id":"source/_posts/spring-mvc/Servlet_LifeCycle.jpg","post":"cjgulsdan009jjh4ktpeh5rc1","slug":"Servlet_LifeCycle.jpg","modified":1,"renderable":1},{"_id":"source/_posts/spring-mvc/arch.jpg","post":"cjgulsdan009jjh4ktpeh5rc1","slug":"arch.jpg","modified":1,"renderable":1},{"_id":"source/_posts/spring-mvc/hierachy.jpg","post":"cjgulsdan009jjh4ktpeh5rc1","slug":"hierachy.jpg","modified":1,"renderable":1},{"_id":"source/_posts/spring-mvc/servlet-interface.jpg","post":"cjgulsdan009jjh4ktpeh5rc1","slug":"servlet-interface.jpg","modified":1,"renderable":1},{"_id":"source/_posts/idea-scratches/keymap.jpg","post":"cjgulsd9d006gjh4kp06lr90k","slug":"keymap.jpg","modified":1,"renderable":1},{"_id":"source/_posts/idea-scratches/menu.jpg","post":"cjgulsd9d006gjh4kp06lr90k","slug":"menu.jpg","modified":1,"renderable":1},{"_id":"source/_posts/idea-scratches/new.jpg","post":"cjgulsd9d006gjh4kp06lr90k","slug":"new.jpg","modified":1,"renderable":1},{"_id":"source/_posts/idea-scratches/scratches.jpg","post":"cjgulsd9d006gjh4kp06lr90k","slug":"scratches.jpg","modified":1,"renderable":1},{"_id":"source/_posts/idea-scratches/search.jpg","post":"cjgulsd9d006gjh4kp06lr90k","slug":"search.jpg","modified":1,"renderable":1},{"_id":"source/_posts/how-to-delete-file-correctly/after.png","post":"cjgulsd9e006ijh4khkpj1kc5","slug":"after.png","modified":1,"renderable":1},{"_id":"source/_posts/how-to-delete-file-correctly/before.png","post":"cjgulsd9e006ijh4khkpj1kc5","slug":"before.png","modified":1,"renderable":1},{"_id":"source/_posts/how-to-delete-file-correctly/deleted.png","post":"cjgulsd9e006ijh4khkpj1kc5","slug":"deleted.png","modified":1,"renderable":1},{"_id":"source/_posts/how-to-delete-file-correctly/inode.png","post":"cjgulsd9e006ijh4khkpj1kc5","slug":"inode.png","modified":1,"renderable":1},{"_id":"source/_posts/how-to-delete-file-correctly/links.png","post":"cjgulsd9e006ijh4khkpj1kc5","slug":"links.png","modified":1,"renderable":1},{"_id":"source/_posts/top/highlight.png","post":"cjgulsdax00a7jh4k3iektjnq","slug":"highlight.png","modified":1,"renderable":1}],"PostCategory":[{"post_id":"cjgulsd640008jh4k0we8kl2a","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsd6m000kjh4kvdd05ob7"},{"post_id":"cjgulsd6d000djh4kkvxrnmqe","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd6p000rjh4kkpwjrj2b"},{"post_id":"cjgulsd6n000ljh4kubtjqkt7","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd6r000vjh4k7y975l7h"},{"post_id":"cjgulsd6g000ejh4knycpt1b3","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd6s000yjh4ksrbtv57z"},{"post_id":"cjgulsd6k000ijh4kbidoc2aq","category_id":"cjgulsd6q000sjh4kls6njims","_id":"cjgulsd6u0014jh4kte1unlx7"},{"post_id":"cjgulsd6m000jjh4kdukv1alg","category_id":"cjgulsd6s000zjh4k1srp0gvp","_id":"cjgulsd6w001ajh4kn1z8eo15"},{"post_id":"cjgulsd6r000xjh4kq3pyje3m","category_id":"cjgulsd6u0015jh4kncwym8mv","_id":"cjgulsd6z001hjh4kuev6zaou"},{"post_id":"cjgulsd6s0011jh4kctlxjynw","category_id":"cjgulsd6x001cjh4k1ivoxd6n","_id":"cjgulsd74001ojh4kovzdpsy1"},{"post_id":"cjgulsd6t0013jh4keayul0vo","category_id":"cjgulsd6x001cjh4k1ivoxd6n","_id":"cjgulsd77001ujh4k1mw1taeg"},{"post_id":"cjgulsd73001mjh4kdqagk4c5","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsd78001wjh4k6lhb9fl8"},{"post_id":"cjgulsd6u0017jh4kivoze819","category_id":"cjgulsd6x001cjh4k1ivoxd6n","_id":"cjgulsd79001yjh4kra2wwck9"},{"post_id":"cjgulsd76001rjh4k62pfxrl0","category_id":"cjgulsd6x001cjh4k1ivoxd6n","_id":"cjgulsd7b0023jh4kcag1j4x3"},{"post_id":"cjgulsd6v0019jh4k3b7v9ieg","category_id":"cjgulsd77001tjh4ky1kt2fzs","_id":"cjgulsd7c0026jh4kuw6uuu5r"},{"post_id":"cjgulsd7a0022jh4k9rwvri96","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd7e002bjh4kvfaar771"},{"post_id":"cjgulsd6w001bjh4ki85d9tlm","category_id":"cjgulsd6x001cjh4k1ivoxd6n","_id":"cjgulsd7f002ejh4ki36ss5kn"},{"post_id":"cjgulsd7c0027jh4k8w7pa6sk","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd7h002hjh4knrqgmfhn"},{"post_id":"cjgulsd6x001fjh4k026vn6wj","category_id":"cjgulsd7c0025jh4kbjp067yx","_id":"cjgulsd7i002kjh4kvumdrr63"},{"post_id":"cjgulsd77001vjh4kngxpnq8l","category_id":"cjgulsd7f002cjh4kwwbfta02","_id":"cjgulsd7k002qjh4kw2wwd5x0"},{"post_id":"cjgulsd7i002njh4krwtxaa25","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd7m002wjh4k7y4i8v6k"},{"post_id":"cjgulsd7b0024jh4kz5g26gyp","category_id":"cjgulsd7i002ljh4k5bwq52ro","_id":"cjgulsd7r002zjh4kjrkflfms"},{"post_id":"cjgulsd7j002pjh4kq5hl5gxi","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd7t0033jh4k7furomjn"},{"post_id":"cjgulsd7f002djh4kdeekpsaq","category_id":"cjgulsd7k002rjh4kw0e79599","_id":"cjgulsd7w0035jh4k4friwfs3"},{"post_id":"cjgulsd7k002tjh4k15ilvmla","category_id":"cjgulsd7n002xjh4kx4qxv4p4","_id":"cjgulsd7z003ajh4k03cbexqr"},{"post_id":"cjgulsd83003hjh4k9ykv3ije","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd89003ojh4k8q4z1lcc"},{"post_id":"cjgulsd84003jjh4kbpux5znp","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsd8a003qjh4kaapbxa42"},{"post_id":"cjgulsd80003cjh4kj8mmpoms","category_id":"cjgulsd82003fjh4kzg9dlm39","_id":"cjgulsd8c003ujh4k6mzvd4tr"},{"post_id":"cjgulsd87003njh4kea21mwyp","category_id":"cjgulsd8b003sjh4kmuimxmsp","_id":"cjgulsd8g0044jh4ktknhvygu"},{"post_id":"cjgulsd8b003tjh4khwc642mx","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsd8i004bjh4kkknjh9a0"},{"post_id":"cjgulsd8c003wjh4kg48xv1xl","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsd8l004gjh4kuezpvozf"},{"post_id":"cjgulsd8h0048jh4k1o2dp6os","category_id":"cjgulsd6q000sjh4kls6njims","_id":"cjgulsd8m004kjh4kr510vvvj"},{"post_id":"cjgulsd8j004djh4kr4qfo9fn","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd8o004mjh4kism4pgy7"},{"post_id":"cjgulsd8d003yjh4k5kbtz1ne","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsd8p004pjh4kfj4w8b3b"},{"post_id":"cjgulsd8k004ejh4ks64jy9ky","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd8q004sjh4knqny2oxk"},{"post_id":"cjgulsd8l004ijh4k0kzwo7u1","category_id":"cjgulsd6q000sjh4kls6njims","_id":"cjgulsd8r004vjh4ketlhpu9o"},{"post_id":"cjgulsd8e0041jh4ktpcr1r3m","category_id":"cjgulsd8l004fjh4kfz58rn7w","_id":"cjgulsd8s004zjh4k677l2ccz"},{"post_id":"cjgulsd8n004ljh4kjj4jhicu","category_id":"cjgulsd82003fjh4kzg9dlm39","_id":"cjgulsd8v0052jh4kbthnvxt6"},{"post_id":"cjgulsd8o004ojh4kii72i3l0","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd8w0055jh4khlj8sukl"},{"post_id":"cjgulsd8q004ujh4k4c0ykylk","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd8x0057jh4kwbw3avs5"},{"post_id":"cjgulsd8s004yjh4k3vdc1zkb","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd8y005bjh4knlf9k30t"},{"post_id":"cjgulsd8t0050jh4ky7bsu2mx","category_id":"cjgulsd8r004xjh4k1go01zw6","_id":"cjgulsd8z005djh4ky12o478p"},{"post_id":"cjgulsd8p004rjh4kbyspxyno","category_id":"cjgulsd8r004xjh4k1go01zw6","_id":"cjgulsd91005hjh4kt7yj47g3"},{"post_id":"cjgulsd8v0054jh4kiexi9b1d","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsd92005kjh4kbxn412sj"},{"post_id":"cjgulsd8w0056jh4kpka0nrwi","category_id":"cjgulsd7i002ljh4k5bwq52ro","_id":"cjgulsd93005ojh4ks4g84e5p"},{"post_id":"cjgulsd8z005cjh4khyn8021a","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd94005rjh4kqiu3brjn"},{"post_id":"cjgulsd91005jjh4kz9viz7g2","category_id":"cjgulsd6u0015jh4kncwym8mv","_id":"cjgulsd96005vjh4k87ghc8gt"},{"post_id":"cjgulsd8x0059jh4kjg8c9lpv","category_id":"cjgulsd90005fjh4k49h3se18","_id":"cjgulsd97005yjh4kks1hh79e"},{"post_id":"cjgulsd94005qjh4kdomkakm6","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd980060jh4k0iophgmg"},{"post_id":"cjgulsd90005gjh4kdu5mxkht","category_id":"cjgulsd93005njh4kpsxispk2","_id":"cjgulsd990064jh4kzsrj1vsi"},{"post_id":"cjgulsd95005sjh4k0aqkyoee","category_id":"cjgulsd93005njh4kpsxispk2","_id":"cjgulsd9a0067jh4kvugkb0hz"},{"post_id":"cjgulsd96005xjh4kdgcj1f7x","category_id":"cjgulsd6q000sjh4kls6njims","_id":"cjgulsd9c006bjh4ksof0kus2"},{"post_id":"cjgulsd92005mjh4kqt4pipbr","category_id":"cjgulsd95005ujh4kbua7w75g","_id":"cjgulsd9d006ejh4k1oo8tgid"},{"post_id":"cjgulsd9b0069jh4ktlumckdh","category_id":"cjgulsd82003fjh4kzg9dlm39","_id":"cjgulsd9f006jjh4kifj6rzjh"},{"post_id":"cjgulsd97005zjh4kbe0xku6a","category_id":"cjgulsd990065jh4ky2y0qvyg","_id":"cjgulsd9h006njh4kuyk99sj2"},{"post_id":"cjgulsd980062jh4khkvqckho","category_id":"cjgulsd990065jh4ky2y0qvyg","_id":"cjgulsd9j006qjh4k3vn8gfdl"},{"post_id":"cjgulsd9e006ijh4khkpj1kc5","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsd9k006tjh4kdnvhn3h5"},{"post_id":"cjgulsd990066jh4k7sn5zdzz","category_id":"cjgulsd9f006kjh4kxuv86ku3","_id":"cjgulsd9m006yjh4kwu7zd5vm"},{"post_id":"cjgulsd9i006pjh4k80qcy1dp","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsd9o0071jh4kchd59ucn"},{"post_id":"cjgulsd9j006sjh4k5tau9uuq","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd9p0075jh4kol8lnn9w"},{"post_id":"cjgulsd9c006cjh4kblicnzzp","category_id":"cjgulsd9f006kjh4kxuv86ku3","_id":"cjgulsd9q0079jh4k4gm5g6n4"},{"post_id":"cjgulsd9l006wjh4kbohgi00j","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd9s007cjh4k5xuu83wi"},{"post_id":"cjgulsd9n0070jh4k8c2026ew","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd9t007ejh4kg9du2vrn"},{"post_id":"cjgulsd9d006gjh4kp06lr90k","category_id":"cjgulsd9m006xjh4k5456bhnv","_id":"cjgulsd9u007hjh4ke7j7scpy"},{"post_id":"cjgulsd9o0074jh4k6ry2a5yy","category_id":"cjgulsd9m006xjh4k5456bhnv","_id":"cjgulsd9v007kjh4koxyffq43"},{"post_id":"cjgulsd9q0078jh4kgx9fzxv7","category_id":"cjgulsd990065jh4ky2y0qvyg","_id":"cjgulsd9w007ojh4ke9qz1o8c"},{"post_id":"cjgulsd9g006mjh4khprju80m","category_id":"cjgulsd9m006xjh4k5456bhnv","_id":"cjgulsd9x007rjh4k4t39m7hg"},{"post_id":"cjgulsd9r007bjh4knlhzxfcn","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsd9y007tjh4komukfj52"},{"post_id":"cjgulsd9s007djh4kjd2ntuhp","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsda0007yjh4kmc0kuy06"},{"post_id":"cjgulsd9t007gjh4kf94awg4u","category_id":"cjgulsd7i002ljh4k5bwq52ro","_id":"cjgulsda10080jh4kjzt6odd6"},{"post_id":"cjgulsd9u007jjh4kwbu3k4vw","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsda20084jh4k36892cmn"},{"post_id":"cjgulsd9v007mjh4k29gmqa6i","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsda30087jh4k81lcgayi"},{"post_id":"cjgulsd9x007sjh4kr5olxoq0","category_id":"cjgulsd8r004xjh4k1go01zw6","_id":"cjgulsda5008bjh4khzf9mm9q"},{"post_id":"cjgulsda0007zjh4kuxf1fqwp","category_id":"cjgulsd9f006kjh4kxuv86ku3","_id":"cjgulsda6008ejh4kdq05lp28"},{"post_id":"cjgulsd9w007qjh4kx4xj7f5h","category_id":"cjgulsd9z007vjh4kixagd4w3","_id":"cjgulsda8008hjh4krplifqdo"},{"post_id":"cjgulsda10082jh4kraxes900","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsda9008kjh4kly96uix3"},{"post_id":"cjgulsda20086jh4k0a3ayv9p","category_id":"cjgulsd6q000sjh4kls6njims","_id":"cjgulsdaa008njh4kfcf8r2n5"},{"post_id":"cjgulsd9z007wjh4kdosu2qyo","category_id":"cjgulsda20083jh4kmetx6o8m","_id":"cjgulsdab008qjh4k5ckq4tg1"},{"post_id":"cjgulsda4008ajh4k1sffayxq","category_id":"cjgulsd8r004xjh4k1go01zw6","_id":"cjgulsdac008sjh4k8p7uta5e"},{"post_id":"cjgulsda5008djh4kchvuvjqh","category_id":"cjgulsd90005fjh4k49h3se18","_id":"cjgulsdae008wjh4koj18audd"},{"post_id":"cjgulsda6008gjh4kz4farbe9","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsdaf008yjh4kf8i18icf"},{"post_id":"cjgulsda8008jjh4k998dnkm4","category_id":"cjgulsd90005fjh4k49h3se18","_id":"cjgulsdag0091jh4kjn57whp8"},{"post_id":"cjgulsda9008ljh4kaa5sl0hv","category_id":"cjgulsd8r004xjh4k1go01zw6","_id":"cjgulsdah0094jh4kuni14hua"},{"post_id":"cjgulsdaa008pjh4kii3gusr5","category_id":"cjgulsd8r004xjh4k1go01zw6","_id":"cjgulsdaj0098jh4kb0ppaxjf"},{"post_id":"cjgulsdab008rjh4kzn676omy","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsdak009bjh4kthae33rd"},{"post_id":"cjgulsdad008ujh4k4xijr4rx","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsdal009ejh4krgdfsm6d"},{"post_id":"cjgulsdae008xjh4kb7zysbhs","category_id":"cjgulsd6q000sjh4kls6njims","_id":"cjgulsdam009hjh4k9285w0sr"},{"post_id":"cjgulsdaf0090jh4ksujtbip8","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsdan009kjh4krae2qqrh"},{"post_id":"cjgulsdag0093jh4kys41esyj","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsdap009ojh4kxjzj795t"},{"post_id":"cjgulsdai0097jh4k3jm4qk8v","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsdaq009qjh4khl8k3ngr"},{"post_id":"cjgulsdaj009ajh4kv39oznl5","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsdas009tjh4kkxmnyamm"},{"post_id":"cjgulsdak009cjh4kxvhd09ha","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsdat009wjh4kn6f2wfk9"},{"post_id":"cjgulsdal009gjh4k2iqew9zl","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsdau009zjh4kk1vknguh"},{"post_id":"cjgulsdan009jjh4ktpeh5rc1","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsdav00a2jh4kj6t9ou8k"},{"post_id":"cjgulsdao009mjh4kjrj8c043","category_id":"cjgulsd6n000mjh4k5ayc8ywq","_id":"cjgulsdaw00a5jh4khyt57f3q"},{"post_id":"cjgulsdap009pjh4kngyoeao7","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsday00a8jh4ku3t8usj6"},{"post_id":"cjgulsdar009sjh4kdyenzppa","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsdb000abjh4k9op9rct9"},{"post_id":"cjgulsdas009vjh4kmt1hbifd","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsdb000adjh4k86ururyr"},{"post_id":"cjgulsdat009yjh4kmxf0orpa","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsdb100afjh4knco6ldgj"},{"post_id":"cjgulsdau00a1jh4kv04ex9re","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsdb100aijh4kaq45907b"},{"post_id":"cjgulsdav00a3jh4k3hu16ebj","category_id":"cjgulsd8e003zjh4kdnbpgjkp","_id":"cjgulsdb100ajjh4k0hwn2ivo"},{"post_id":"cjgulsdax00a7jh4k3iektjnq","category_id":"cjgulsd69000ajh4kgdblw6mq","_id":"cjgulsdb200aljh4keaa3tqfr"},{"post_id":"cjgulsdaz00a9jh4kyey7w7fp","category_id":"cjgulsd6k000fjh4kbpgqgwfg","_id":"cjgulsdb200anjh4k98ndu96y"},{"post_id":"cjgulsdw700c8jh4kxt2buogr","category_id":"cjgulsd9f006kjh4kxuv86ku3","_id":"cjgulsdwy00cajh4kwd0wt8az"}],"PostTag":[{"post_id":"cjgulsd640008jh4k0we8kl2a","tag_id":"cjgulsd6a000bjh4kd2k8j5ou","_id":"cjgulsd6k000hjh4k228ukchy"},{"post_id":"cjgulsd6d000djh4kkvxrnmqe","tag_id":"cjgulsd6k000gjh4k6796qmy8","_id":"cjgulsd6o000ojh4kwrzdnp3s"},{"post_id":"cjgulsd6g000ejh4knycpt1b3","tag_id":"cjgulsd6n000njh4kwetsliga","_id":"cjgulsd6r000wjh4k5r6pq9vk"},{"post_id":"cjgulsd6k000ijh4kbidoc2aq","tag_id":"cjgulsd6q000tjh4kteut3esk","_id":"cjgulsd6t0012jh4kdcjh56ip"},{"post_id":"cjgulsd6m000jjh4kdukv1alg","tag_id":"cjgulsd6s0010jh4kh2u3lufu","_id":"cjgulsd6v0018jh4kzrzk6em6"},{"post_id":"cjgulsd6n000ljh4kubtjqkt7","tag_id":"cjgulsd6u0016jh4kqhvw2jwx","_id":"cjgulsd6x001ejh4k6vft6x94"},{"post_id":"cjgulsd6v0019jh4k3b7v9ieg","tag_id":"cjgulsd6x001djh4kwpy2kzlg","_id":"cjgulsd72001ljh4kk0azgvll"},{"post_id":"cjgulsd6x001fjh4k026vn6wj","tag_id":"cjgulsd72001kjh4k9xry3aun","_id":"cjgulsd77001sjh4kz933hj23"},{"post_id":"cjgulsd73001mjh4kdqagk4c5","tag_id":"cjgulsd75001qjh4koseoq4ne","_id":"cjgulsd7a0021jh4k0oip5s0g"},{"post_id":"cjgulsd77001vjh4kngxpnq8l","tag_id":"cjgulsd7a0020jh4k8flrf6lw","_id":"cjgulsd7d0029jh4k3oar9wbh"},{"post_id":"cjgulsd7a0022jh4k9rwvri96","tag_id":"cjgulsd7d0028jh4kv8w6e9ch","_id":"cjgulsd7h002ijh4kgeavrduq"},{"post_id":"cjgulsd7b0024jh4kz5g26gyp","tag_id":"cjgulsd7g002fjh4kb6ueej1v","_id":"cjgulsd7j002ojh4k368jm8r6"},{"post_id":"cjgulsd7c0027jh4k8w7pa6sk","tag_id":"cjgulsd7i002mjh4kknxd1xnf","_id":"cjgulsd7l002ujh4kleq82xih"},{"post_id":"cjgulsd7f002djh4kdeekpsaq","tag_id":"cjgulsd7k002sjh4kyq72jihx","_id":"cjgulsd7r0031jh4k1f3k0t4u"},{"post_id":"cjgulsd7i002njh4krwtxaa25","tag_id":"cjgulsd7r0030jh4km3rny7sr","_id":"cjgulsd7y0038jh4km5whaouz"},{"post_id":"cjgulsd7j002pjh4kq5hl5gxi","tag_id":"cjgulsd7r0030jh4km3rny7sr","_id":"cjgulsd81003djh4kimtijwpo"},{"post_id":"cjgulsd7k002tjh4k15ilvmla","tag_id":"cjgulsd7z003bjh4kkgrpmlwr","_id":"cjgulsd84003ijh4k1r1dy1za"},{"post_id":"cjgulsd80003cjh4kj8mmpoms","tag_id":"cjgulsd82003gjh4kx2iakvta","_id":"cjgulsd87003mjh4kdyk59c3x"},{"post_id":"cjgulsd83003hjh4k9ykv3ije","tag_id":"cjgulsd87003ljh4k4dgjxjht","_id":"cjgulsd8c003vjh4kd46opjbj"},{"post_id":"cjgulsd84003jjh4kbpux5znp","tag_id":"cjgulsd8a003rjh4kb5xzubli","_id":"cjgulsd8e0040jh4kxxyvty8r"},{"post_id":"cjgulsd87003njh4kea21mwyp","tag_id":"cjgulsd8d003xjh4kbg859p2k","_id":"cjgulsd8g0046jh4kcefuqz4d"},{"post_id":"cjgulsd8d003yjh4k5kbtz1ne","tag_id":"cjgulsd8f0042jh4kl2utdwh2","_id":"cjgulsd8j004cjh4kspb1bjx9"},{"post_id":"cjgulsd8e0041jh4ktpcr1r3m","tag_id":"cjgulsd8i0049jh4km95r4t4r","_id":"cjgulsd8m004jjh4koj9ke2sk"},{"post_id":"cjgulsd8h0048jh4k1o2dp6os","tag_id":"cjgulsd8l004hjh4kuh3dbt3q","_id":"cjgulsd8p004qjh4kwezc8hvu"},{"post_id":"cjgulsd8j004djh4kr4qfo9fn","tag_id":"cjgulsd8o004njh4kkq14fx2c","_id":"cjgulsd8r004wjh4k6pd9q3br"},{"post_id":"cjgulsd8k004ejh4ks64jy9ky","tag_id":"cjgulsd8q004tjh4ka7l08bd5","_id":"cjgulsd8v0053jh4kuv30jzsv"},{"post_id":"cjgulsd8n004ljh4kjj4jhicu","tag_id":"cjgulsd8u0051jh4kbrw82au6","_id":"cjgulsd8y005ajh4kiu7tioku"},{"post_id":"cjgulsd8o004ojh4kii72i3l0","tag_id":"cjgulsd8x0058jh4kb3xwcdhg","_id":"cjgulsd91005ijh4k16uv3v73"},{"post_id":"cjgulsd8p004rjh4kbyspxyno","tag_id":"cjgulsd90005ejh4kzz15lrt2","_id":"cjgulsd93005pjh4ktc2pswrv"},{"post_id":"cjgulsd8q004ujh4k4c0ykylk","tag_id":"cjgulsd92005ljh4k7w7093rj","_id":"cjgulsd96005wjh4kx87tywhz"},{"post_id":"cjgulsd8s004yjh4k3vdc1zkb","tag_id":"cjgulsd95005tjh4kqmvmxrei","_id":"cjgulsd990063jh4kr68x6f46"},{"post_id":"cjgulsd8t0050jh4ky7bsu2mx","tag_id":"cjgulsd90005ejh4kzz15lrt2","_id":"cjgulsd9c006ajh4k7m2y41c4"},{"post_id":"cjgulsd8v0054jh4kiexi9b1d","tag_id":"cjgulsd9a0068jh4knwea619e","_id":"cjgulsd9e006hjh4km38jmyza"},{"post_id":"cjgulsd8w0056jh4kpka0nrwi","tag_id":"cjgulsd9d006fjh4kjjviuy9l","_id":"cjgulsd9i006ojh4kcxq4ae6h"},{"post_id":"cjgulsd9i006pjh4k80qcy1dp","tag_id":"cjgulsd7a0020jh4k8flrf6lw","_id":"cjgulsd9l006vjh4kmfoona9l"},{"post_id":"cjgulsd8x0059jh4kjg8c9lpv","tag_id":"cjgulsd9g006ljh4kxswxyxnj","_id":"cjgulsd9n006zjh4k5uchtfoa"},{"post_id":"cjgulsd9l006wjh4kbohgi00j","tag_id":"cjgulsd8x0058jh4kb3xwcdhg","_id":"cjgulsd9o0073jh4kfyox15g1"},{"post_id":"cjgulsd8z005cjh4khyn8021a","tag_id":"cjgulsd9l006ujh4k8ahzzs5i","_id":"cjgulsd9p0077jh4k9v5em80z"},{"post_id":"cjgulsd90005gjh4kdu5mxkht","tag_id":"cjgulsd9o0072jh4k7yejiz2z","_id":"cjgulsd9u007ijh4kvoxguivf"},{"post_id":"cjgulsd90005gjh4kdu5mxkht","tag_id":"cjgulsd9r007ajh4k50rirei9","_id":"cjgulsd9v007ljh4k84sgoscf"},{"post_id":"cjgulsd91005jjh4kz9viz7g2","tag_id":"cjgulsd9t007fjh4kjfprb0m7","_id":"cjgulsd9w007pjh4kdhu9w5fb"},{"post_id":"cjgulsd92005mjh4kqt4pipbr","tag_id":"cjgulsd9w007njh4kcfg0yrab","_id":"cjgulsd9z007xjh4kx4bgi7w7"},{"post_id":"cjgulsd94005qjh4kdomkakm6","tag_id":"cjgulsd9y007ujh4kl77r52o7","_id":"cjgulsda20085jh4kuvyt16k2"},{"post_id":"cjgulsda10082jh4kraxes900","tag_id":"cjgulsd7z003bjh4kkgrpmlwr","_id":"cjgulsda40089jh4kbabvwi8o"},{"post_id":"cjgulsd95005sjh4k0aqkyoee","tag_id":"cjgulsd9o0072jh4k7yejiz2z","_id":"cjgulsda5008cjh4k0eq64w2c"},{"post_id":"cjgulsd97005zjh4kbe0xku6a","tag_id":"cjgulsda40088jh4k23on32bv","_id":"cjgulsda8008ijh4kmj9l85zo"},{"post_id":"cjgulsd980062jh4khkvqckho","tag_id":"cjgulsda6008fjh4klyhtxmoo","_id":"cjgulsdaa008ojh4k7mdpoc1e"},{"post_id":"cjgulsd990066jh4k7sn5zdzz","tag_id":"cjgulsdaa008mjh4k5o7r5mun","_id":"cjgulsdae008vjh4kafp2ehry"},{"post_id":"cjgulsd9b0069jh4ktlumckdh","tag_id":"cjgulsdac008tjh4kb529x6e3","_id":"cjgulsdag0092jh4kv4ftuyg8"},{"post_id":"cjgulsdaf0090jh4ksujtbip8","tag_id":"cjgulsd7r0030jh4km3rny7sr","_id":"cjgulsdah0095jh4kwmys0fdf"},{"post_id":"cjgulsd9c006cjh4kblicnzzp","tag_id":"cjgulsdaf008zjh4kk66glli2","_id":"cjgulsdaj0099jh4kdaha9z97"},{"post_id":"cjgulsd9e006ijh4khkpj1kc5","tag_id":"cjgulsdai0096jh4kgp5xa28m","_id":"cjgulsdal009fjh4k6pgz2h5w"},{"post_id":"cjgulsdak009cjh4kxvhd09ha","tag_id":"cjgulsd8a003rjh4kb5xzubli","_id":"cjgulsdam009ijh4k8bzy4un7"},{"post_id":"cjgulsd9g006mjh4khprju80m","tag_id":"cjgulsdal009djh4khafx6qlc","_id":"cjgulsdap009njh4k547qj4f5"},{"post_id":"cjgulsd9j006sjh4k5tau9uuq","tag_id":"cjgulsdao009ljh4khfpfuor3","_id":"cjgulsdas009ujh4kf66zhjb8"},{"post_id":"cjgulsd9n0070jh4k8c2026ew","tag_id":"cjgulsdaq009rjh4kwuxuovml","_id":"cjgulsdau00a0jh4kok21v7d2"},{"post_id":"cjgulsd9o0074jh4k6ry2a5yy","tag_id":"cjgulsdat009xjh4kawnim3hz","_id":"cjgulsdax00a6jh4k94791ip0"},{"post_id":"cjgulsd9q0078jh4kgx9fzxv7","tag_id":"cjgulsda6008fjh4klyhtxmoo","_id":"cjgulsdb000acjh4k48t4wf87"},{"post_id":"cjgulsdaz00a9jh4kyey7w7fp","tag_id":"cjgulsd6u0016jh4kqhvw2jwx","_id":"cjgulsdb100aejh4ki1mg1ep5"},{"post_id":"cjgulsd9r007bjh4knlhzxfcn","tag_id":"cjgulsdb000aajh4k8zjxdi8x","_id":"cjgulsdb100ahjh4k8hj5cp22"},{"post_id":"cjgulsd9s007djh4kjd2ntuhp","tag_id":"cjgulsdb100agjh4kqze4cvv6","_id":"cjgulsdb200amjh4k7jatjv08"},{"post_id":"cjgulsd9t007gjh4kf94awg4u","tag_id":"cjgulsdb100akjh4k26c69pvw","_id":"cjgulsdb200apjh4k6d2x4lbx"},{"post_id":"cjgulsd9v007mjh4k29gmqa6i","tag_id":"cjgulsdb200aojh4k72lwkx7j","_id":"cjgulsdb200arjh4k73lygcnd"},{"post_id":"cjgulsd9w007qjh4kx4xj7f5h","tag_id":"cjgulsdb200aqjh4kuwgs8qqk","_id":"cjgulsdb300atjh4kf7bycf0c"},{"post_id":"cjgulsd9x007sjh4kr5olxoq0","tag_id":"cjgulsdb200asjh4ktb6yqtxl","_id":"cjgulsdb300avjh4k2u2jlakb"},{"post_id":"cjgulsd9z007wjh4kdosu2qyo","tag_id":"cjgulsdb300aujh4kjyrwciow","_id":"cjgulsdb600axjh4kbwe12v3y"},{"post_id":"cjgulsda0007zjh4kuxf1fqwp","tag_id":"cjgulsdb300awjh4k51hgc53b","_id":"cjgulsdb600azjh4kgn3l0fso"},{"post_id":"cjgulsda20086jh4k0a3ayv9p","tag_id":"cjgulsdb600ayjh4kevy8wy6x","_id":"cjgulsdb700b1jh4k1dmgfn27"},{"post_id":"cjgulsda4008ajh4k1sffayxq","tag_id":"cjgulsdb200asjh4ktb6yqtxl","_id":"cjgulsdb700b3jh4knrpompbd"},{"post_id":"cjgulsda5008djh4kchvuvjqh","tag_id":"cjgulsdb700b2jh4kok58zn1l","_id":"cjgulsdb800b5jh4k9h8d041e"},{"post_id":"cjgulsda6008gjh4kz4farbe9","tag_id":"cjgulsdb700b4jh4kpwkibl1w","_id":"cjgulsdb800b7jh4kt9ag93g9"},{"post_id":"cjgulsda8008jjh4k998dnkm4","tag_id":"cjgulsdb800b6jh4kac5pqnht","_id":"cjgulsdb800b9jh4kxz6h9vx2"},{"post_id":"cjgulsda9008ljh4kaa5sl0hv","tag_id":"cjgulsdb800b8jh4khibhatis","_id":"cjgulsdb800bbjh4kbd0udho2"},{"post_id":"cjgulsdaa008pjh4kii3gusr5","tag_id":"cjgulsdb800bajh4ktx0256c0","_id":"cjgulsdb900bdjh4kbk4v7vtl"},{"post_id":"cjgulsdab008rjh4kzn676omy","tag_id":"cjgulsdb800bcjh4ktteistor","_id":"cjgulsdb900bfjh4ktbcrjdm6"},{"post_id":"cjgulsdad008ujh4k4xijr4rx","tag_id":"cjgulsdb900bejh4kdl2gd3id","_id":"cjgulsdb900bhjh4ku0g5r0kd"},{"post_id":"cjgulsdae008xjh4kb7zysbhs","tag_id":"cjgulsdb900bgjh4ke6otnjqi","_id":"cjgulsdba00bjjh4kyjyod8ae"},{"post_id":"cjgulsdag0093jh4kys41esyj","tag_id":"cjgulsdb900bijh4k1ojr37dj","_id":"cjgulsdba00bljh4k4edi1olo"},{"post_id":"cjgulsdai0097jh4k3jm4qk8v","tag_id":"cjgulsdba00bkjh4ko3mkgise","_id":"cjgulsdba00bnjh4k211gnlxp"},{"post_id":"cjgulsdaj009ajh4kv39oznl5","tag_id":"cjgulsdba00bmjh4kf58okbpr","_id":"cjgulsdbb00bpjh4kmxt3ed0o"},{"post_id":"cjgulsdal009gjh4k2iqew9zl","tag_id":"cjgulsdba00bmjh4kf58okbpr","_id":"cjgulsdbb00brjh4kaofg0xz1"},{"post_id":"cjgulsdan009jjh4ktpeh5rc1","tag_id":"cjgulsdba00bmjh4kf58okbpr","_id":"cjgulsdbc00btjh4k78xw0pwa"},{"post_id":"cjgulsdao009mjh4kjrj8c043","tag_id":"cjgulsdbb00bsjh4kwkwtwxui","_id":"cjgulsdbc00bvjh4k7v1ic4i4"},{"post_id":"cjgulsdap009pjh4kngyoeao7","tag_id":"cjgulsdbc00bujh4ku4nj04gw","_id":"cjgulsdbc00bxjh4kky7210fl"},{"post_id":"cjgulsdas009vjh4kmt1hbifd","tag_id":"cjgulsdbc00bwjh4kjz3j0fen","_id":"cjgulsdbc00bzjh4ko0cbq2iu"},{"post_id":"cjgulsdat009yjh4kmxf0orpa","tag_id":"cjgulsdbc00byjh4kycevzeyj","_id":"cjgulsdbd00c1jh4kncdkji5q"},{"post_id":"cjgulsdau00a1jh4kv04ex9re","tag_id":"cjgulsdbc00c0jh4k393bgfl4","_id":"cjgulsdbd00c3jh4km3yfytdz"},{"post_id":"cjgulsdav00a3jh4k3hu16ebj","tag_id":"cjgulsdb800bcjh4ktteistor","_id":"cjgulsdbd00c5jh4k47fjn7o9"},{"post_id":"cjgulsdax00a7jh4k3iektjnq","tag_id":"cjgulsdbd00c4jh4kqafx6uow","_id":"cjgulsdbe00c6jh4k9bf4e2us"},{"post_id":"cjgulsdw700c8jh4kxt2buogr","tag_id":"cjgulsdwa00c9jh4k1drwufwv","_id":"cjgulsdxu00cbjh4kgg53jm3j"}],"Tag":[{"name":"ab","_id":"cjgulsd6a000bjh4kd2k8j5ou"},{"name":"classloader","_id":"cjgulsd6k000gjh4k6796qmy8"},{"name":"PropertyEditor","_id":"cjgulsd6n000njh4kwetsliga"},{"name":"curl","_id":"cjgulsd6q000tjh4kteut3esk"},{"name":"test","_id":"cjgulsd6s0010jh4kh2u3lufu"},{"name":"xml","_id":"cjgulsd6u0016jh4kqhvw2jwx"},{"name":"beginner","_id":"cjgulsd6x001djh4kwpy2kzlg"},{"name":"http","_id":"cjgulsd72001kjh4k9xry3aun"},{"name":"inode","_id":"cjgulsd75001qjh4koseoq4ne"},{"name":"jackson","_id":"cjgulsd7a0020jh4k8flrf6lw"},{"name":"proxy","_id":"cjgulsd7d0028jh4kv8w6e9ch"},{"name":"json","_id":"cjgulsd7g002fjh4kb6ueej1v"},{"name":"jstack","_id":"cjgulsd7i002mjh4kknxd1xnf"},{"name":"shutdown-hook","_id":"cjgulsd7k002sjh4kyq72jihx"},{"name":"logback","_id":"cjgulsd7r0030jh4km3rny7sr"},{"name":"maven","_id":"cjgulsd7z003bjh4kkgrpmlwr"},{"name":"rate-limiter","_id":"cjgulsd82003gjh4kx2iakvta"},{"name":"view-resolver","_id":"cjgulsd87003ljh4k4dgjxjht"},{"name":"ssh","_id":"cjgulsd8a003rjh4kb5xzubli"},{"name":"threadpool","_id":"cjgulsd8d003xjh4kbg859p2k"},{"name":"sci","_id":"cjgulsd8f0042jh4kl2utdwh2"},{"name":"union-find","_id":"cjgulsd8i0049jh4km95r4t4r"},{"name":"剪贴板","_id":"cjgulsd8l004hjh4kuh3dbt3q"},{"name":"mat","_id":"cjgulsd8o004njh4kkq14fx2c"},{"name":"messageConverter","_id":"cjgulsd8q004tjh4ka7l08bd5"},{"name":"concurrent","_id":"cjgulsd8u0051jh4kbrw82au6"},{"name":"exception","_id":"cjgulsd8x0058jh4kb3xwcdhg"},{"name":"编码","_id":"cjgulsd90005ejh4kzz15lrt2"},{"name":"cache","_id":"cjgulsd92005ljh4k7w7093rj"},{"name":"自定义标签","_id":"cjgulsd95005tjh4kqmvmxrei"},{"name":"cygwin","_id":"cjgulsd9a0068jh4knwea619e"},{"name":"electron","_id":"cjgulsd9d006fjh4kjjviuy9l"},{"name":"fabric","_id":"cjgulsd9g006ljh4kxswxyxnj"},{"name":"executor","_id":"cjgulsd9l006ujh4k8ahzzs5i"},{"name":"git","_id":"cjgulsd9o0072jh4k7yejiz2z"},{"name":"idea","_id":"cjgulsd9r007ajh4k50rirei9"},{"name":"generic","_id":"cjgulsd9t007fjh4kjfprb0m7"},{"name":"go学习资料","_id":"cjgulsd9w007njh4kcfg0yrab"},{"name":"beanfactory","_id":"cjgulsd9y007ujh4kl77r52o7"},{"name":"google-perf","_id":"cjgulsda40088jh4k23on32bv"},{"name":"greys","_id":"cjgulsda6008fjh4klyhtxmoo"},{"name":"hexo","_id":"cjgulsdaa008mjh4k5o7r5mun"},{"name":"event-bus","_id":"cjgulsdac008tjh4kb529x6e3"},{"name":"hexo install","_id":"cjgulsdaf008zjh4kk66glli2"},{"name":"lsof","_id":"cjgulsdai0096jh4kgp5xa28m"},{"name":"template","_id":"cjgulsdal009djh4khafx6qlc"},{"name":"jar","_id":"cjgulsdao009ljh4khfpfuor3"},{"name":"访问权限","_id":"cjgulsdaq009rjh4kwuxuovml"},{"name":"Javadoc","_id":"cjgulsdat009xjh4kawnim3hz"},{"name":"java","_id":"cjgulsdb000aajh4k8zjxdi8x"},{"name":"jinfo","_id":"cjgulsdb100agjh4kqze4cvv6"},{"name":"ajax","_id":"cjgulsdb100akjh4k26c69pvw"},{"name":"tomcat","_id":"cjgulsdb200aojh4k72lwkx7j"},{"name":"markdown-here","_id":"cjgulsdb200aqjh4kuwgs8qqk"},{"name":"mysql","_id":"cjgulsdb200asjh4ktb6yqtxl"},{"name":"机器学习","_id":"cjgulsdb300aujh4kjyrwciow"},{"name":"mindmap","_id":"cjgulsdb300awjh4k51hgc53b"},{"name":"netcat","_id":"cjgulsdb600ayjh4kevy8wy6x"},{"name":"pip","_id":"cjgulsdb700b2jh4kok58zn1l"},{"name":"tuning","_id":"cjgulsdb700b4jh4kpwkibl1w"},{"name":"python-util","_id":"cjgulsdb800b6jh4kac5pqnht"},{"name":"postgresql","_id":"cjgulsdb800b8jh4khibhatis"},{"name":"re","_id":"cjgulsdb800bajh4ktx0256c0"},{"name":"servlet","_id":"cjgulsdb800bcjh4ktteistor"},{"name":"shadowsocks","_id":"cjgulsdb900bejh4kdl2gd3id"},{"name":"limit","_id":"cjgulsdb900bgjh4ke6otnjqi"},{"name":"placeholder","_id":"cjgulsdb900bijh4k1ojr37dj"},{"name":"spi","_id":"cjgulsdba00bkjh4ko3mkgise"},{"name":"spring mvc","_id":"cjgulsdba00bmjh4kf58okbpr"},{"name":"resource","_id":"cjgulsdbb00bsjh4kwkwtwxui"},{"name":"access-log","_id":"cjgulsdbc00bujh4ku4nj04gw"},{"name":"encoding","_id":"cjgulsdbc00bwjh4kjz3j0fen"},{"name":"connections","_id":"cjgulsdbc00byjh4kycevzeyj"},{"name":"string-manager","_id":"cjgulsdbc00c0jh4k393bgfl4"},{"name":"top","_id":"cjgulsdbd00c4jh4kqafx6uow"},{"name":"uml","_id":"cjgulsdwa00c9jh4k1drwufwv"}]}}