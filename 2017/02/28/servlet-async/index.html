<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>异步Servlet及Spring对其的支持 | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">异步Servlet及Spring对其的支持</h1><a id="logo" href="/.">KL's blog</a><p class="description">世事洞明皆学问，人情练达即文章</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">异步Servlet及Spring对其的支持</h1><div class="post-meta">Feb 28, 2017<span> | </span><span class="category"><a href="/categories/spring/">spring</a></span><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/02/28/servlet-async/" href="/2017/02/28/servlet-async/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">1.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#async-ab测试"><span class="toc-number">1.1.</span> <span class="toc-text">async ab测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sync-ab测试"><span class="toc-number">1.2.</span> <span class="toc-text">sync ab测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结论"><span class="toc-number">1.3.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用"><span class="toc-number">2.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Async-Servlet使用"><span class="toc-number">2.1.</span> <span class="toc-text">Async Servlet使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-对异步Servlet的支持"><span class="toc-number">2.2.</span> <span class="toc-text">Spring 对异步Servlet的支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Callable-方式"><span class="toc-number">2.2.1.</span> <span class="toc-text">Callable 方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DeferredResult-方式"><span class="toc-number">2.2.2.</span> <span class="toc-text">DeferredResult 方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现细节"><span class="toc-number">3.</span> <span class="toc-text">实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Async-Servlet"><span class="toc-number">3.1.</span> <span class="toc-text">Async Servlet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring的封装"><span class="toc-number">3.2.</span> <span class="toc-text">Spring的封装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Callable-的处理"><span class="toc-number">3.2.1.</span> <span class="toc-text">Callable 的处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DeferredResult-的处理"><span class="toc-number">3.2.2.</span> <span class="toc-text">DeferredResult 的处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>限定 tomcat的连接池个数为50，并发为200（&gt;&gt; 线程池大小），时异步具有很大的优势。</p>
<p>如果并发量小于线程池大小，异步的反倒比同步的时间长了很久。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">maxThreads</span>=<span class="string">"50"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>完整的测试代码地址： <a href="https://github.com/qsLI/Java_Tutorial/blob/master/web/src/main/java/com/air/async/AsyncRequestProcessor.java" rel="external nofollow noopener noreferrer" target="_blank"></a></p>
<h3 id="async-ab测试"><a href="#async-ab测试" class="headerlink" title="async ab测试"></a>async ab测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 10000 -c 200 http://localhost:8080/async</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache-Coyote/1.1</span><br><span class="line">Server Hostname:        localhost</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /async</span><br><span class="line">Document Length:        40 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      200</span><br><span class="line">Time taken for tests:   1000.284 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        47</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 47, Exceptions: 0)</span><br><span class="line">Write errors:           0</span><br><span class="line">Non-2xx responses:      47</span><br><span class="line">Total transferred:      1530740 bytes</span><br><span class="line">HTML transferred:       506980 bytes</span><br><span class="line">Requests per second:    10.00 [#/sec] (mean)</span><br><span class="line">Time per request:       20005.686 [ms] (mean)</span><br><span class="line">Time per request:       100.028 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1.49 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   5.0      0     501</span><br><span class="line">Processing:     2 19810 1683.3  20001   20560</span><br><span class="line">Waiting:        1 19810 1683.4  20000   20558</span><br><span class="line">Total:          2 19811 1683.0  20001   20560</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  20001</span><br><span class="line">  66%  20001</span><br><span class="line">  75%  20002</span><br><span class="line">  80%  20002</span><br><span class="line">  90%  20004</span><br><span class="line">  95%  20009</span><br><span class="line">  98%  20020</span><br><span class="line">  99%  20035</span><br><span class="line"> 100%  20560 (longest request)</span><br></pre></td></tr></table></figure>
<p>测试过程中出的异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">一月 21, 2017 1:05:32 上午 org.apache.catalina.core.StandardWrapperValve invoke</span><br><span class="line">严重: Servlet.service() for servlet [com.air.async.AsyncServlet] in context with path [] threw exception</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task com.air.async.AsyncRequestProcessor@3caec762 rejected from java.util.concurrent.ThreadPoolExecutor@64db0f23[Running, pool size = 100, active threads = 100, queued tasks = 100, completed tasks = 9726]</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)</span><br><span class="line">  at com.air.async.AsyncServlet.doGet(AsyncServlet.java:25)</span><br><span class="line">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:621)</span><br><span class="line">  at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class="line">  at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)</span><br><span class="line">  at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)</span><br><span class="line">  at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)</span><br><span class="line">  at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)</span><br><span class="line">  at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)</span><br><span class="line">  at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)</span><br><span class="line">  at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)</span><br><span class="line">  at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)</span><br><span class="line">  at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)</span><br><span class="line">  at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)</span><br><span class="line">  at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)</span><br><span class="line">  at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)</span><br><span class="line">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2430)</span><br><span class="line">  at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2419)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>
<p>有47个失败的case，是队列满了，然后丢掉了请求。</p>
<h3 id="sync-ab测试"><a href="#sync-ab测试" class="headerlink" title="sync ab测试"></a>sync ab测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 10000 -c 200 http://localhost:8080/hello</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache-Coyote/1.1</span><br><span class="line">Server Hostname:        localhost</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /hello</span><br><span class="line">Document Length:        12 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      200</span><br><span class="line">Time taken for tests:   2002.151 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      1340000 bytes</span><br><span class="line">HTML transferred:       120000 bytes</span><br><span class="line">Requests per second:    4.99 [#/sec] (mean)</span><br><span class="line">Time per request:       40043.028 [ms] (mean)</span><br><span class="line">Time per request:       200.215 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          0.65 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.4      0       8</span><br><span class="line">Processing: 10002 39740 2686.3  40005   50319</span><br><span class="line">Waiting:    10002 39740 2686.4  40004   50319</span><br><span class="line">Total:      10002 39741 2686.3  40005   50319</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  40005</span><br><span class="line">  66%  40009</span><br><span class="line">  75%  40014</span><br><span class="line">  80%  40022</span><br><span class="line">  90%  40122</span><br><span class="line">  95%  40316</span><br><span class="line">  98%  40449</span><br><span class="line">  99%  40483</span><br><span class="line"> 100%  50319 (longest request)</span><br></pre></td></tr></table></figure>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>异步的servle在高并发的情况下可以使用较少的连接线程实现较大的吞吐。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="Async-Servlet使用"><a href="#Async-Servlet使用" class="headerlink" title="Async Servlet使用"></a>Async Servlet使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.air.async;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.air.SampleServlet;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.AsyncContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> qisheng.li</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/1/15 9:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/async"</span>, asyncSupported = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AsyncServlet<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        LOGGER.error(<span class="string">"before start async thread is "</span> + Thread.currentThread().getName());</span><br><span class="line">        AsyncContext asyncContext = req.startAsync();</span><br><span class="line">        asyncContext.addListener(<span class="keyword">new</span> AppAsyncListener());</span><br><span class="line">        <span class="comment">// 这个超时没有生效，因为tomcat的扫描间隔是1s  org.apache.coyote.AbstractProtocol.AsyncTimeout</span></span><br><span class="line">        asyncContext.setTimeout(<span class="number">500</span>);</span><br><span class="line">        LOGGER.error(<span class="string">"after start async thread is "</span> + Thread.currentThread().getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         使用自定义的线程池</span></span><br><span class="line"><span class="comment">          10:52:19.057 [http-nio-8080-exec-4] ERROR com.air.async.AsyncServlet - before start async thread is http-nio-8080-exec-4</span></span><br><span class="line"><span class="comment">          10:52:19.065 [http-nio-8080-exec-4] ERROR com.air.async.AsyncServlet - after start async thread is http-nio-8080-exec-4</span></span><br><span class="line"><span class="comment">          10:52:19.066 [pool-2-thread-1] ERROR com.air.async.AsyncRequestProcessor - in threadpool thread is pool-2-thread-1</span></span><br><span class="line"><span class="comment">          10:52:20.358 [http-nio-8080-exec-5] ERROR com.air.async.AppAsyncListener - async event on Timeout</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">          1s 292之后才超时</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        ThreadPoolExecutor executor = (ThreadPoolExecutor) req.getServletContext().getAttribute("executor");</span></span><br><span class="line"><span class="comment">//        executor.execute(new AsyncRequestProcessor(asyncContext, 10000));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           使用tomcat的工作线程池</span></span><br><span class="line"><span class="comment">            15:34:59.535 [http-nio-8080-exec-4] ERROR com.air.async.AsyncServlet - before start async thread is http-nio-8080-exec-4</span></span><br><span class="line"><span class="comment">            15:34:59.545 [http-nio-8080-exec-4] ERROR com.air.async.AsyncServlet - after start async thread is http-nio-8080-exec-4</span></span><br><span class="line"><span class="comment">            15:34:59.547 [http-nio-8080-exec-5] ERROR com.air.async.AsyncRequestProcessor - in threadpool thread is http-nio-8080-exec-5</span></span><br><span class="line"><span class="comment">            15:35:00.254 [http-nio-8080-exec-6] ERROR com.air.async.AppAsyncListener - async event on Timeout</span></span><br><span class="line"><span class="comment">          可以看到线程名称从http-nio-8080-exec-4 变为了 http-nio-8080-exec-5，都是tomcat的工作线程</span></span><br><span class="line"><span class="comment">          timeout的回调在http-nio-8080-exec-6线程中处理</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        asyncContext.start(<span class="keyword">new</span> AsyncRequestProcessor(asyncContext, <span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> qisheng.li</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/1/15 9:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncRequestProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AsyncRequestProcessor<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AsyncContext asyncContext;</span><br><span class="line">    <span class="comment">//sleeping time in millionsecs</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> secs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncRequestProcessor</span><span class="params">(AsyncContext asyncContext, <span class="keyword">int</span> secs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.asyncContext = asyncContext;</span><br><span class="line">        <span class="keyword">this</span>.secs = secs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        System.out.println("Async Supported? " + asyncContext.getRequest().isAsyncSupported());</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"in threadpool thread is "</span> + Thread.currentThread().getName());</span><br><span class="line">            Thread.sleep(secs);</span><br><span class="line">            PrintWriter writer = asyncContext.getResponse().getWriter();</span><br><span class="line">            writer.write(<span class="string">"Processing done for "</span> + secs + <span class="string">" milliseconds!!"</span>);</span><br><span class="line">            <span class="comment">//异步调用完成，如果异步调用完成后不调用complete()方法的话，异步调用的结果需要等到设置的超时</span></span><br><span class="line">            <span class="comment">//时间过了之后才能返回到客户端。</span></span><br><span class="line">            asyncContext.complete();</span><br><span class="line">            <span class="comment">// 可以跳转其他url, 类似 dispatcher.forward(req, resp);</span></span><br><span class="line"><span class="comment">//            asyncContext.dispatch();</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Boolean aFalse = Boolean.valueOf(<span class="string">"false"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!aFalse) &#123;</span><br><span class="line">            System.out.println(<span class="string">"false"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Spring-对异步Servlet的支持"><a href="#Spring-对异步Servlet的支持" class="headerlink" title="Spring 对异步Servlet的支持"></a>Spring 对异步Servlet的支持</h3><p>web.xml中需要的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring encoding filter--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--servlet--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">            classpath:spring/mvc/mvc-app.xml</span><br><span class="line">        <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果有filter的话也必须配置上异步的支持</p>
<h4 id="Callable-方式"><a href="#Callable-方式" class="headerlink" title="Callable 方式"></a>Callable 方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/async"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">asyncProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方式返回一个<code>Callable</code>，Spring在线程池中执行<code>Callable</code>并获取到结果然后进行后续的处理。</p>
<p>TaskExecutor 自定义线程池：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ================================== --&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- 0. Set up task executor for async  --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================== --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:async-support</span> <span class="attr">default-timeout</span>=<span class="string">"30000"</span> <span class="attr">task-executor</span>=<span class="string">"taskExecutor"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- modify the parameters of thread pool --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"taskExecutor"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"corePoolSize"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"50"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"queueCapacity"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"keepAliveSeconds"</span> <span class="attr">value</span>=<span class="string">"120"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="DeferredResult-方式"><a href="#DeferredResult-方式" class="headerlink" title="DeferredResult 方式"></a>DeferredResult 方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/asyncV2"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">aysncProcess2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> DeferredResult&lt;String&gt; stringDeferredResult = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">       MoreExecutors.directExecutor().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">                   stringDeferredResult.setResult(<span class="string">"index"</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   stringDeferredResult.setErrorResult(<span class="string">"error"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">return</span> stringDeferredResult;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这种方式返回的是<code>DeferredResult</code>，计算的逻辑可以在业务线程池中计算，当计算完成后，</p>
<p>直接向<code>DeferredResult</code>中set数据即可，会触发后续的处理，并返回给客户端。</p>
<p><code>DeferredResult</code>也可以设置超时和超时时的默认值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResponseEntity&lt;Map&lt;String, String&gt;&gt; NOT_MODIFIED_RESPONSE_LIST = <span class="keyword">new</span> ResponseEntity&lt;&gt;(HttpStatus.NOT_MODIFIED);</span><br><span class="line"><span class="keyword">final</span> DeferredResult&lt;ResponseEntity&lt;Map&lt;String, String&gt;&gt;&gt; deferredResult = <span class="keyword">new</span> DeferredResult&lt;&gt;(<span class="number">90000L</span>, NOT_MODIFIED_RESPONSE_LIST);</span><br></pre></td></tr></table></figure>
<p>90s后会自动超时掉。</p>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><h3 id="Async-Servlet"><a href="#Async-Servlet" class="headerlink" title="Async Servlet"></a>Async Servlet</h3><p>async servlet是servlet规范的一部分，规范中定义好接口，具体的实现就看具体的容器了（比如tomcat， jetty等）。</p>
<img src="/2017/02/28/servlet-async/image-20210225163740510.png">
<h3 id="Spring的封装"><a href="#Spring的封装" class="headerlink" title="Spring的封装"></a>Spring的封装</h3><p><code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Invoke the &#123;<span class="doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="doctag">@link</span> ModelAndView&#125;</span></span><br><span class="line"><span class="comment">   * if view resolution is required.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see</span> #createInvocableHandlerMethod(HandlerMethod)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">invokeHandlerMethod</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request, response);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class="line"></span><br><span class="line">      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">      invocableMethod.setHandlerMethodArgumentResolvers(<span class="keyword">this</span>.argumentResolvers);</span><br><span class="line">      invocableMethod.setHandlerMethodReturnValueHandlers(<span class="keyword">this</span>.returnValueHandlers);</span><br><span class="line">      invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class="line">      invocableMethod.setParameterNameDiscoverer(<span class="keyword">this</span>.parameterNameDiscoverer);</span><br><span class="line"></span><br><span class="line">      ModelAndViewContainer mavContainer = <span class="keyword">new</span> ModelAndViewContainer();</span><br><span class="line">      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">      modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class="line">      mavContainer.setIgnoreDefaultModelOnRedirect(<span class="keyword">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建异步请求，这个AsyncWebRequest是spring抽象出来的</span></span><br><span class="line">      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">      <span class="comment">//① 异步请求的超时</span></span><br><span class="line">      asyncWebRequest.setTimeout(<span class="keyword">this</span>.asyncRequestTimeout);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//下面的代码设置了Callable执行的线程池，以及拦截器还有DeferredResult的拦截器</span></span><br><span class="line">      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">      <span class="comment">//② 异步的线程池</span></span><br><span class="line">      asyncManager.setTaskExecutor(<span class="keyword">this</span>.taskExecutor);</span><br><span class="line">      asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">      asyncManager.registerCallableInterceptors(<span class="keyword">this</span>.callableInterceptors);</span><br><span class="line">      asyncManager.registerDeferredResultInterceptors(<span class="keyword">this</span>.deferredResultInterceptors);</span><br><span class="line">			</span><br><span class="line">      <span class="comment">// 异步处理有结果之后，就会有concurrentResult,调用的是asyncContext.dispatch()方法，会重新进到这个类中</span></span><br><span class="line">      <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">        Object result = asyncManager.getConcurrentResult();</span><br><span class="line">        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">        asyncManager.clearConcurrentResult();</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Found concurrent result value ["</span> + result + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//③ 这里替换了对应的处理方法, 会跳过实际的执行; 重新走一遍的原因，是因为要对实际的返回值做处理（转json或者xml等）</span></span><br><span class="line">        invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class="line">      &#125;</span><br><span class="line">			<span class="comment">// 调用对应的方法，处理http请求</span></span><br><span class="line">      invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">      <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      webRequest.requestCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>③处的实现细节，直接返回了异步的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.ConcurrentResultHandlerMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentResultHandlerMethod</span><span class="params">(<span class="keyword">final</span> Object result, ConcurrentResultMethodParameter returnType)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">super</span>(<span class="keyword">new</span> Callable&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (Exception) result;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NestedServletException(<span class="string">"Async processing failed"</span>, (Throwable) result);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, CALLABLE_METHOD);</span><br><span class="line"></span><br><span class="line">  setHandlerMethodReturnValueHandlers(ServletInvocableHandlerMethod.<span class="keyword">this</span>.returnValueHandlers);</span><br><span class="line">  <span class="keyword">this</span>.returnType = returnType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Callable-的处理"><a href="#Callable-的处理" class="headerlink" title="Callable 的处理"></a>Callable 的处理</h4><p><code>Callable</code>的处理是在<code>CallableMethodReturnValueHandler</code>中的，这个接口最终继承了<code>HandlerMethodReturnValueHandler</code>, 也就是对Controller方法返回值的后处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableMethodReturnValueHandler</span> <span class="keyword">implements</span> <span class="title">AsyncHandlerMethodReturnValueHandler</span> </span>&#123;</span><br><span class="line">  <span class="comment">//省略...</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">      ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">      mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Callable&lt;?&gt; callable = (Callable&lt;?&gt;) returnValue;</span><br><span class="line">    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终是调用了<code>WebAsyncManager</code>的<code>startCallableProcessing</code>进行处理</p>
<p><code>WebAsyncManager</code>中的关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(Callable&lt;?&gt; callable, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Assert.notNull(callable, <span class="string">"Callable must not be null"</span>);</span><br><span class="line">    startCallableProcessing(<span class="keyword">new</span> WebAsyncTask(callable), processingContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(<span class="keyword">final</span> WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Assert.notNull(webAsyncTask, <span class="string">"WebAsyncTask must not be null"</span>);</span><br><span class="line">    Assert.state(<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//超时</span></span><br><span class="line">    Long timeout = webAsyncTask.getTimeout();</span><br><span class="line">    <span class="keyword">if</span> (timeout != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//线程池</span></span><br><span class="line">    AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class="line">    <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.taskExecutor = executor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//拦截器</span></span><br><span class="line">    List&lt;CallableProcessingInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class="line">    interceptors.add(webAsyncTask.getInterceptor());</span><br><span class="line">    interceptors.addAll(<span class="keyword">this</span>.callableInterceptors.values());</span><br><span class="line">    interceptors.add(timeoutCallableInterceptor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class="line">    <span class="keyword">final</span> CallableInterceptorChain interceptorChain = <span class="keyword">new</span> CallableInterceptorChain(interceptors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//超时处理</span></span><br><span class="line">    <span class="keyword">this</span>.asyncWebRequest.addTimeoutHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"Processing timeout"</span>);</span><br><span class="line">        Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class="line">        <span class="keyword">if</span> (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class="line">          setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功的回调，会触发拦截器的拦截</span></span><br><span class="line">    <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截</span></span><br><span class="line">    interceptorChain.applyBeforeConcurrentHandling(<span class="keyword">this</span>.asyncWebRequest, callable);</span><br><span class="line">    startAsyncProcessing(processingContext);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.taskExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          Object result = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//拦截before</span></span><br><span class="line">            interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class="line">            result = callable.call();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            result = ex;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//拦截after</span></span><br><span class="line">            result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 触发结果的返回</span></span><br><span class="line">          setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class="line">      Object result = interceptorChain.applyPostProcess(<span class="keyword">this</span>.asyncWebRequest, callable, ex);</span><br><span class="line">      setConcurrentResultAndDispatch(result);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>setConcurrentResultAndDispatch</code> 调用<code>asyncContext</code>的<code>dispatch</code>方法触发结果的回写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setConcurrentResultAndDispatch</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (WebAsyncManager.<span class="keyword">this</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (hasConcurrentResult()) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.concurrentResult = result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.asyncWebRequest.isAsyncComplete()) &#123;</span><br><span class="line">		logger.error(<span class="string">"Could not complete async processing due to timeout or network error"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Concurrent result value ["</span> + <span class="keyword">this</span>.concurrentResult +</span><br><span class="line">				<span class="string">"] - dispatching request to resume processing"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.asyncWebRequest.dispatch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里之所以调用的是<code>dispatch()</code>而不是<code>complete()</code>，是因为请求需要再走一遍spring的流程，处理真正的返回值等。</p>
<h4 id="DeferredResult-的处理"><a href="#DeferredResult-的处理" class="headerlink" title="DeferredResult 的处理"></a>DeferredResult 的处理</h4><p>DeferredResult类似guava中的SettableFuture，主要属性有：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object timeoutResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Runnable timeoutCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Runnable completionCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DeferredResultHandler resultHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Object result = RESULT_NONE;</span><br></pre></td></tr></table></figure>
<p>当给DeferredResult set结果的时候，触发后续的流程（类似onSuccess）。</p>
<img src="/2017/02/28/servlet-async/image-20210225163812285.png">
<p>DeferredResult的返回时机就是有数据的时候，顺藤摸瓜:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setResult</span><span class="params">(T result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setResultInternal(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setResultInternal</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Immediate expiration check outside of the result lock</span></span><br><span class="line">    <span class="keyword">if</span> (isSetOrExpired()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DeferredResultHandler resultHandlerToUse;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="comment">// Got the lock in the meantime: double-check expiration status</span></span><br><span class="line">      <span class="keyword">if</span> (isSetOrExpired()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// At this point, we got a new result to process</span></span><br><span class="line">      <span class="keyword">this</span>.result = result;</span><br><span class="line">      resultHandlerToUse = <span class="keyword">this</span>.resultHandler;</span><br><span class="line">      <span class="keyword">if</span> (resultHandlerToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No result handler set yet -&gt; let the setResultHandler implementation</span></span><br><span class="line">        <span class="comment">// pick up the result object and invoke the result handler for it.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Result handler available -&gt; let's clear the stored reference since</span></span><br><span class="line">      <span class="comment">// we don't need it anymore.</span></span><br><span class="line">      <span class="keyword">this</span>.resultHandler = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If we get here, we need to process an existing result object immediately.</span></span><br><span class="line">    <span class="comment">// The decision is made within the result lock; just the handle call outside</span></span><br><span class="line">    <span class="comment">// of it, avoiding any deadlock potential with Servlet container locks.</span></span><br><span class="line">    resultHandlerToUse.handleResult(result);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>DeferredResultHandler</code>是什么鬼？我们new的时候没有设置啊？？其实这个也是由<code>HandlerMethodReturnValueHandler</code>来实现的，有个对应的<code>DeferredResultMethodReturnValueHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">    ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">    mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DeferredResultAdapter adapter = getAdapterFor(returnValue.getClass());</span><br><span class="line">  Assert.notNull(adapter);</span><br><span class="line">  DeferredResult&lt;?&gt; result = adapter.adaptToDeferredResult(returnValue);</span><br><span class="line">  WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终还是到了<code>WebAsyncManager</code>的处理方法中，和<code>Callable</code>的处理类似，不一一深入。</p>
<p>值得一提的是，正是在这个<code>startDeferredResultProcessing</code>中塞入了一个<code>DeferredResultHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">      interceptorChain.applyPreProcess(<span class="keyword">this</span>.asyncWebRequest, deferredResult);</span><br><span class="line">      deferredResult.setResultHandler(<span class="keyword">new</span> DeferredResultHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResult</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">          result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);</span><br><span class="line">          setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      setConcurrentResultAndDispatch(ex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>因为我们是异步执行的，所以虽然handler的注入在后面，其实影响也不大，而且<code>setResult</code>中也做了判断。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><p><a href="http://www.journaldev.com/2008/async-servlet-feature-of-servlet-3" rel="external nofollow noopener noreferrer" target="_blank">Async Servlet Feature of Servlet 3 - JournalDev</a></p>
</li>
<li><p><a href="https://docs.oracle.com/javaee/7/tutorial/servlets012.htm" rel="external nofollow noopener noreferrer" target="_blank">17.12 Asynchronous Processing - Java Platform, Enterprise Edition: The Java EE Tutorial (Release 7)</a></p>
</li>
<li><p><a href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="external nofollow noopener noreferrer" target="_blank">ab - Apache HTTP server benchmarking tool - Apache HTTP Server Version 2.4</a></p>
</li>
<li><p><a href="http://www.ha97.com/5095.html" rel="external nofollow noopener noreferrer" target="_blank">系统吞吐量（TPS）、用户并发量、性能测试概念和公式</a></p>
</li>
<li><p><a href="https://lanjingling.github.io/2016/01/20/servlet3-new-furture/" rel="external nofollow noopener noreferrer" target="_blank">servlet3新特性——异步请求处理 | 晓的技术博客</a></p>
</li>
<li><p><a href="http://blog.csdn.net/wzy_1988/article/details/38922449" rel="external nofollow noopener noreferrer" target="_blank">解决java.util.concurrent.RejectedExecutionException - 小一的专栏 - 博客频道 - CSDN.NET</a></p>
</li>
<li><p><a href="http://www.lai18.com/content/2483896.html" rel="external nofollow noopener noreferrer" target="_blank">Springmvc异步支持报错- - Lai18.com IT技术文章收藏夹</a></p>
</li>
<li><p><a href="http://shengwangi.blogspot.hk/2015/09/asynchronous-spring-mvc-hello-world.html" rel="external nofollow noopener noreferrer" target="_blank">Asynchronous Spring MVC – Hello World Example | Code Breeze !</a></p>
</li>
</ol>
</div><footer class="post-footer"><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者: </strong>代故</li><li class="post-copyright-link"><strong>本文链接: </strong>    <a href="/2017/02/28/servlet-async/" target="_blank">http://qsli.github.io/2017/02/28/servlet-async/index.html</a></li>  <li class="post-copyright-license"><strong>版权声明: </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 3.0 CN</a></li></ul></div></footer><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2017/02/28/servlet-async/" data-id="ckw7q22vz00gi4v6n7qt0kti8" class="article-share-link">分享到</a><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? 整杯冰阔乐!<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://qsli.github.io/about/praise.jpg" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="tags"><a href="/tags/servlet/">servlet</a></div><div class="post-nav"><a href="/2017/04/05/tomcat-connection/" class="pre">tomcat连接数相关的配置</a><a href="/2017/02/20/cygwin-360/" class="next">cygwin执行命令非常慢</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2017/02/28/servlet-async/';
var disqus_title = '异步Servlet及Spring对其的支持';
var disqus_url = 'http://qsli.github.io/2017/02/28/servlet-async/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/druid/">druid</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/feign/">feign</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mediawiki/">mediawiki</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/logback/" style="font-size: 15px;">logback</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/cglib/" style="font-size: 15px;">cglib</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/pitfall-mysql-connector-java-8-x/" style="font-size: 15px;">pitfall mysql-connector-java 8.x</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/spring-cloud/" style="font-size: 15px;">spring-cloud</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/go学习资料/" style="font-size: 15px;">go学习资料</a> <a href="/tags/git-commit-id/" style="font-size: 15px;">git-commit-id</a> <a href="/tags/grafana/" style="font-size: 15px;">grafana</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/tranfer-encoding/" style="font-size: 15px;">tranfer-encoding</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/java-connector/" style="font-size: 15px;">java-connector</a> <a href="/tags/jinfo/" style="font-size: 15px;">jinfo</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/自增主键/" style="font-size: 15px;">自增主键</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/plantuml/" style="font-size: 15px;">plantuml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/sqlserver-killer/" style="font-size: 15px;">sqlserver-killer</a> <a href="/tags/sudo-log/" style="font-size: 15px;">sudo-log</a> <a href="/tags/swap/" style="font-size: 15px;">swap</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/busy-thread/" style="font-size: 15px;">busy-thread</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/feign/" style="font-size: 15px;">feign</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/format/" style="font-size: 15px;">format</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/generic/" style="font-size: 15px;">generic</a> <a href="/tags/executor/" style="font-size: 15px;">executor</a> <a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/executeBatch/" style="font-size: 15px;">executeBatch</a> <a href="/tags/HttpURLConnection/" style="font-size: 15px;">HttpURLConnection</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/reference/" style="font-size: 15px;">reference</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/sudo/" style="font-size: 15px;">sudo</a> <a href="/tags/top/" style="font-size: 15px;">top</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/google-perf/" style="font-size: 15px;">google-perf</a> <a href="/tags/jdwp/" style="font-size: 15px;">jdwp</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/spring-bean/" style="font-size: 15px;">spring-bean</a> <a href="/tags/cache-prep-stmts/" style="font-size: 15px;">cache-prep-stmts</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a> <a href="/tags/transaction/" style="font-size: 15px;">transaction</a> <a href="/tags/spring-validator/" style="font-size: 15px;">spring-validator</a> <a href="/tags/spring-aop/" style="font-size: 15px;">spring-aop</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/10/16/web-xml/">web.xml</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/16/hexo-ubuntu/">hexo迁移到ubuntu</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/08/git-commit-id/">git-commit-id执行耗时过长</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/29/keepalive/">keepalive</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/23/spring-tx/">spring-transaction</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/23/mybatis-detail-03/">mybatis源码解析（三）—— Spring集成</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/19/mybatis-detail-02/">mybatis源码解析（二）—— 代理类生成分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/18/mybatis-detail-01/">mybatis源码解析（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/10/spring-aop/">spring-aop</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/05/spring-validator/">spring-validator源码分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://iip.whu.edu.cn/" title="武汉大学智能信息处理实验室" target="_blank" rel="external nofollow noopener noreferrer">武汉大学智能信息处理实验室</a><ul></ul><a href="http://calvin1978.blogcn.com/" title="江南白衣" target="_blank" rel="external nofollow noopener noreferrer">江南白衣</a><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2021.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>