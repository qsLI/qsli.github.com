<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>java8 Stream使用不当，导致文件没有关闭 | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">java8 Stream使用不当，导致文件没有关闭</h1><a id="logo" href="/.">KL's blog</a><p class="description">越积极，越幸运</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">java8 Stream使用不当，导致文件没有关闭</h1><div class="post-meta">Nov 4, 2017<span> | </span><span class="category"><a href="/categories/java8/">java8</a></span><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/11/04/java8-file-stream/" href="/2017/11/04/java8-file-stream/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复现"><span class="toc-number">2.</span> <span class="toc-text">复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原因"><span class="toc-number">3.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案"><span class="toc-number">4.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>线上巡查的时候，检查了线上机器的<code>tomcat</code>打开的文件列表，发现了一些问题。<br>一般来说，tomcat打开的文件就是一些<code>jar</code>包，日志文件, 动态库，socket等。因此用下面的命令查看下tomcat打开的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsof -p <span class="variable">$pid</span> | grep / | grep -v <span class="string">".jar"</span> | grep -v <span class="string">".so"</span></div></pre></td></tr></table></figure>
<p>结果如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF      NODE NAME</div><div class="line"></div><div class="line">java    25516 tomcat  cwd    DIR              252,2      4096    136416 /tmp/hsperfdata_tomcat</div><div class="line"></div><div class="line">java    25516 tomcat  rtd    DIR              252,2      4096         2 /</div><div class="line"></div><div class="line">java    25516 tomcat  mem    REG              252,2  99158576     19559 /usr/lib/locale/locale-archive</div><div class="line"></div><div class="line">java    25516 tomcat  mem    REG              252,2     32768    131740 /tmp/hsperfdata_tomcat/25516</div><div class="line"></div><div class="line">java    25516 tomcat    0r   CHR                1,3       0t0      3674 /dev/null</div><div class="line"></div><div class="line">java    25516 tomcat    1w   REG              252,7  16965016   1836324 /logs/catalina.out</div><div class="line"></div><div class="line">java    25516 tomcat    2w   REG              252,7  16965016   1836324 /logs/catalina.out</div><div class="line"></div><div class="line">java    25516 tomcat    3w   REG              252,7   7839644   1836499 /logs/gc-201710181632.log</div><div class="line"></div><div class="line">java    25516 tomcat   10w   REG              252,7   2741011   1835201 /logs/catalina.2017-10-18.log (deleted)</div><div class="line"></div><div class="line">java    25516 tomcat   11w   REG              252,7      1494   1835054 /logs/localhost.2017-10-18.log (deleted)</div><div class="line"></div><div class="line">java    25516 tomcat   40r   CHR                1,8       0t0      3678 /dev/random</div><div class="line"></div><div class="line">java    25516 tomcat   41r   CHR                1,9       0t0      3679 /dev/urandom</div><div class="line"></div><div class="line">java    25516 tomcat   42r   CHR                1,8       0t0      3678 /dev/random</div><div class="line"></div><div class="line">java    25516 tomcat   43r   CHR                1,8       0t0      3678 /dev/random</div><div class="line"></div><div class="line">java    25516 tomcat   44r   CHR                1,9       0t0      3679 /dev/urandom</div><div class="line"></div><div class="line">java    25516 tomcat   45r   CHR                1,9       0t0      3679 /dev/urandom</div><div class="line"></div><div class="line">java    25516 tomcat   52w   REG              252,7   7409504   1836890 /logs/access.2017-10-19.log</div><div class="line"></div><div class="line">java    25516 tomcat   65r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</div><div class="line"></div><div class="line">java    25516 tomcat   68r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</div><div class="line"></div><div class="line">java    25516 tomcat   72r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</div><div class="line"></div><div class="line">java    25516 tomcat   82r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</div><div class="line"></div><div class="line">java    25516 tomcat  180r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</div><div class="line"></div><div class="line">java    25516 tomcat  193r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</div><div class="line"></div><div class="line">java    25516 tomcat  197r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</div><div class="line"></div><div class="line">java    25516 tomcat  200r   REG              252,7  44315261   1836448 /logs/dubbo-access-provider.2017-10-19-13.log</div><div class="line"></div><div class="line">java    25516 tomcat  204r   REG              252,7 181402005   1836417 /logs/dubbo-access-consumer.2017-10-19-13.log</div><div class="line"></div><div class="line">java    25516 tomcat  224r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</div><div class="line"></div><div class="line">java    25516 tomcat  363r   REG              252,7  67531699   1835818 /cache/file_cache/fileB</div><div class="line"></div><div class="line">java    25516 tomcat  365r   REG              252,7   5665798   1836099 /cache/file_cache/fileA</div><div class="line"></div><div class="line">java    25516 tomcat  573r   CHR                1,8       0t0      3678 /dev/random</div></pre></td></tr></table></figure>
<p>从文件列表中可以看出日志文件是一直打开的，这个是正常的，因为需要写入日志。<br>但是还有一些其他的文件，不需要写入，也一直打开，而且有的打开了好几次，这个就看起来有问题了。</p>
<p>翻代码， 发现这个文件是定时拉取的逻辑，每次从数据源拉一份文件到本地， 然后用java8的<code>Files.lines</code>和lambda进行处理。<br>下面大概复现了相关的逻辑。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.air.collection.java8.stream.file;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</div><div class="line"><span class="keyword">import</span> com.google.common.io.Resources;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.URISyntaxException;</div><div class="line"><span class="keyword">import</span> java.nio.file.Files;</div><div class="line"><span class="keyword">import</span> java.nio.file.Paths;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> qisheng.li</div><div class="line"> * <span class="doctag">@email</span> qisheng.li@qunar.com</div><div class="line"> * <span class="doctag">@date</span> 17-11-4 下午5:07</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilesTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, URISyntaxException, InterruptedException </span>&#123;</div><div class="line">        executor.scheduleAtFixedRate(FilesTest::reloadFile, <span class="number">100</span>, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reloadFile</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"reload file"</span>);</div><div class="line">        List&lt;Integer&gt; collect = Lists.newArrayList();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            collect = Files.lines(Paths.get(Resources.getResource(<span class="string">"test.json"</span>).toURI()))</div><div class="line">                    .map(String::length)</div><div class="line">                    .collect(toList());</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">            System.out.println(collect.get(<span class="number">0</span>));</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查看进程打开的文件，可以发现有一堆的<code>test.json</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">java    23757 qishengli 8822r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8823r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8824r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8825r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8826r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8827r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8828r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8829r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8830r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8831r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8832r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8833r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8834r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div><div class="line">java    23757 qishengli 8835r   REG                8,6   257120 2229528 /Java_Tutorial/java-tutorial/src/main/target/classes/test.json</div></pre></td></tr></table></figure>
<p>完美复现！</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><blockquote>
<p>Streams have a BaseStream.close() method and implement AutoCloseable, but nearly all stream instances do not actually need to be closed after use. </p>
</blockquote>
<p>一般来说，并不需要手动调用<code>Stream</code>的<code>close</code>方法， 只有背后是I/O相关的流才需要手动关闭。</p>
<blockquote>
<p>Generally, only streams whose source is an IO channel (such as those returned by Files.lines(Path, Charset)) will require closing. Most streams are backed by collections, arrays, or generating functions, which require no special resource management. (If a stream does require closing, it can be declared as a resource in a try-with-resources statement.)</p>
</blockquote>
<p>查找到打开相应文件的代码，发现使用的正是java8的<code>Files.lines</code>方法，这个方法并不会自动的将文件关闭，所以就会看到，tomcat进程多次打开了同一个文件。</p>
<p><code>Files.lines</code>方法的函数说明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Read all lines from a file as a &#123;<span class="doctag">@code</span> Stream&#125;. Unlike &#123;<span class="doctag">@link</span></div><div class="line">     * #readAllLines(Path, Charset) readAllLines&#125;, this method does not read</div><div class="line">     * all lines into a &#123;<span class="doctag">@code</span> List&#125;, but instead populates lazily as the stream</div><div class="line">     * is consumed.</div><div class="line">     *</div><div class="line">     * &lt;p&gt; Bytes from the file are decoded into characters using the specified</div><div class="line">     * charset and the same line terminators as specified by &#123;<span class="doctag">@code</span></div><div class="line">     * readAllLines&#125; are supported.</div><div class="line">     *</div><div class="line">     * &lt;p&gt; After this method returns, then any subsequent I/O exception that</div><div class="line">     * occurs while reading from the file or when a malformed or unmappable byte</div><div class="line">     * sequence is read, is wrapped in an &#123;<span class="doctag">@link</span> UncheckedIOException&#125; that will</div><div class="line">     * be thrown from the</div><div class="line">     * &#123;<span class="doctag">@link</span> java.util.stream.Stream&#125; method that caused the read to take</div><div class="line">     * place. In case an &#123;<span class="doctag">@code</span> IOException&#125; is thrown when closing the file,</div><div class="line">     * it is also wrapped as an &#123;<span class="doctag">@code</span> UncheckedIOException&#125;.</div><div class="line">     *</div><div class="line">     * &lt;p&gt; The returned stream encapsulates a &#123;<span class="doctag">@link</span> Reader&#125;.  If timely</div><div class="line">     * disposal of file system resources is required, the try-with-resources</div><div class="line">     * construct should be used to ensure that the stream's</div><div class="line">     * &#123;<span class="doctag">@link</span> Stream#close close&#125; method is invoked after the stream operations</div><div class="line">     * are completed.</div><div class="line">     *</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span>   path</div><div class="line">     *          the path to the file</div><div class="line">     * <span class="doctag">@param</span>   cs</div><div class="line">     *          the charset to use for decoding</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span>  the lines from the file as a &#123;<span class="doctag">@code</span> Stream&#125;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span>  IOException</div><div class="line">     *          if an I/O error occurs opening the file</div><div class="line">     * <span class="doctag">@throws</span>  SecurityException</div><div class="line">     *          In the case of the default provider, and a security manager is</div><div class="line">     *          installed, the &#123;<span class="doctag">@link</span> SecurityManager#checkRead(String) checkRead&#125;</div><div class="line">     *          method is invoked to check read access to the file.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span>     #readAllLines(Path, Charset)</div><div class="line">     * <span class="doctag">@see</span>     #newBufferedReader(Path, Charset)</div><div class="line">     * <span class="doctag">@see</span>     java.io.BufferedReader#lines()</div><div class="line">     * <span class="doctag">@since</span>   1.8</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Stream&lt;String&gt; <span class="title">lines</span><span class="params">(Path path, Charset cs)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        BufferedReader br = Files.newBufferedReader(path, cs);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> br.lines().onClose(asUncheckedRunnable(br));</div><div class="line">        &#125; <span class="keyword">catch</span> (Error|RuntimeException e) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                br.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    e.addSuppressed(ex);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;&#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>重点看这几句， </p>
<blockquote>
<p>The returned stream encapsulates a Reader.  If timely disposal of file system resources is required, the try-with-resources construct should be used to ensure that the stream’s <code>Stream#close</code> method is invoked  after the stream operations are completed.</p>
</blockquote>
<p>如果需要及时地清理系统的资源， 可以使用java7中引入的<code>try-with-resources</code>, 来确保<code>Stream</code>的<code>close</code>方法在使用完后被调用。</p>
<p><code>Files.lines</code>是惰性的， 当你使用的时候才去读取， 所以需要手动的关闭流， <code>Files.readAllLines</code>这个方法则是一次把文件<br>中的所有行读取到内存中去，并且会自动的关闭文件。</p>
<p><code>Files.readAllLines</code>的函数说明中就保证了底层的文件一定会被关闭。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Read all lines from a file. This method ensures that the file is</div><div class="line">    * closed when all bytes have been read or an I/O error, or other runtime</div><div class="line">    * exception, is thrown. Bytes from the file are decoded into characters</div><div class="line">    * using the specified charset.</div><div class="line">    **/</div></pre></td></tr></table></figure>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>使用java7中引入的<code>try-with-resoucres</code>, 实现了<code>AutoCloseable</code>接口的都会被自动的关闭</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> ( Stream&lt;String&gt; stream = Files.lines(path, charset) ) &#123;</div><div class="line">    <span class="comment">// do something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><p><a href="https://stackoverflow.com/questions/38698182/close-java-8-stream" rel="external nofollow noopener noreferrer" target="_blank">Close Java 8 Stream - Stack Overflow</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/37659872/do-i-have-to-close-terminated-streamed-query-results-in-a-try-with-resources-bl" rel="external nofollow noopener noreferrer" target="_blank">java - Do I have to close terminated, streamed query results in a try-with-resources-block? - Stack Overflow</a></p>
</li>
<li><p><a href="http://calvin1978.blogcn.com/articles/latency2.html" rel="external nofollow noopener noreferrer" target="_blank">在你的代码之外，服务时延过长的三个追查方向(下) | 江南白衣</a></p>
</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2017/11/04/java8-file-stream/" data-id="cja54bycl005uhv4kbepbo5ju" class="article-share-link">分享到</a><div class="tags"><a href="/tags/java/">java</a></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? Buy me a coffee<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://oj3xkjbu4.bkt.clouddn.com/mm_facetoface_collect_qrcode_1483284143051.png" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="post-nav"><a href="/2017/09/12/git-checkout/" class="pre">git-checkout 常用命令</a><a href="/2017/11/12/greys/" class="next">使用greys来排查线上问题</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2017/11/04/java8-file-stream/';
var disqus_title = 'java8 Stream使用不当，导致文件没有关闭';
var disqus_url = 'http://qsli.github.io/2017/11/04/java8-file-stream/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java8/">java8</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/concurrent/" style="font-size: 15px;">concurrent</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/top/" style="font-size: 15px;">top</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/18/ThreadFactoryBuilder/">Guava中的ThreadFactoryBuilder</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/12/MAT-Ubuntu/">MAT-Ubuntu无法打开Report</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/12/greys/">使用greys来排查线上问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/04/java8-file-stream/">java8 Stream使用不当，导致文件没有关闭</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/git-checkout/">git-checkout 常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/git-branch-log/">git查看已合并分支的fork点</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/10/electron/">用electron开发自己的工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/10/how-to-delete-file-correctly/">Linux下删除文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/09/top/">top用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/03/jvm-flag/">jvm-flag</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2017.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync=""></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync=""></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>