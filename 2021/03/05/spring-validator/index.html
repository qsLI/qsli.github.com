<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>spring-validator源码分析 | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">spring-validator源码分析</h1><a id="logo" href="/.">KL's blog</a><p class="description">世事洞明皆学问，人情练达即文章</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">spring-validator源码分析</h1><div class="post-meta">Mar 5, 2021<span> | </span><span class="category"><a href="/categories/spring/">spring</a></span><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2021/03/05/spring-validator/" href="/2021/03/05/spring-validator/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#JSR-303和JSR-349"><span class="toc-number">1.</span> <span class="toc-text">JSR-303和JSR-349</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#jsr-303：——Bean-Validation-1-0"><span class="toc-number">1.1.</span> <span class="toc-text">jsr-303：——Bean Validation 1.0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jsr-349——Bean-Validation-1-1："><span class="toc-number">1.2.</span> <span class="toc-text">jsr-349——Bean Validation 1.1：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API"><span class="toc-number">2.</span> <span class="toc-text">API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置"><span class="toc-number">2.1.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一种启动方式（Xml-Config-or-Default）："><span class="toc-number">2.1.1.</span> <span class="toc-text">第一种启动方式（Xml Config or Default）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二种启动方式（Java-Config）："><span class="toc-number">2.1.2.</span> <span class="toc-text">第二种启动方式（Java Config）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三种启动方式"><span class="toc-number">2.1.3.</span> <span class="toc-text">第三种启动方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用"><span class="toc-number">2.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">2.3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ValidationProviderResolver"><span class="toc-number">2.3.1.</span> <span class="toc-text">ValidationProviderResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultValidationProviderResolver"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">DefaultValidationProviderResolver</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hibernate-Validator"><span class="toc-number">3.</span> <span class="toc-text">Hibernate-Validator</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Validate过程："><span class="toc-number">3.1.</span> <span class="toc-text">Validate过程：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#validate"><span class="toc-number">3.1.1.</span> <span class="toc-text">validate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#嵌套类型"><span class="toc-number">3.1.2.</span> <span class="toc-text">嵌套类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方法级别的验证"><span class="toc-number">3.2.</span> <span class="toc-text">方法级别的验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConstraintValidator"><span class="toc-number">3.3.</span> <span class="toc-text">ConstraintValidator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#版本升级的坑"><span class="toc-number">3.4.</span> <span class="toc-text">版本升级的坑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring集成"><span class="toc-number">4.</span> <span class="toc-text">Spring集成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-mvc"><span class="toc-number">4.1.</span> <span class="toc-text">Spring mvc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xml配置"><span class="toc-number">4.1.1.</span> <span class="toc-text">xml配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java配置"><span class="toc-number">4.1.2.</span> <span class="toc-text">Java配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求处理"><span class="toc-number">4.1.3.</span> <span class="toc-text">请求处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方法级别的校验"><span class="toc-number">4.2.</span> <span class="toc-text">方法级别的校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码分析"><span class="toc-number">4.2.1.</span> <span class="toc-text">源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring管理的bean的校验"><span class="toc-number">4.3.</span> <span class="toc-text">Spring管理的bean的校验</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><h1 id="JSR-303和JSR-349"><a href="#JSR-303和JSR-349" class="headerlink" title="JSR-303和JSR-349"></a>JSR-303和JSR-349</h1><h2 id="jsr-303：——Bean-Validation-1-0"><a href="#jsr-303：——Bean-Validation-1-0" class="headerlink" title="jsr-303：——Bean Validation 1.0"></a><code>jsr-303</code>：——Bean Validation 1.0</h2><blockquote>
<p>This document is the specification of the Java API for JavaBean validation in Java EE and Java SE. The technical objective of this work is to <strong>provide a class level constraint declaration and validation facility</strong> for the Java application developer, as well as a <strong>constraint metadata</strong> repository and query API.</p>
</blockquote>
<p>目标：</p>
<blockquote>
<p>Validating data is a common task that occurs throughout an application, <strong>from the presentation layer to the persistence layer.</strong> Often the same validation logic is implemented in each layer, proving to be time consuming and error-prone. To avoid duplication of these validations in each layer, developers often bundle validation logic directly into the <strong>domain model</strong>, cluttering domain classes with validation code that is, <strong>in fact, metadata about the class itself.</strong></p>
<p>This JSR <strong>defines a metadata model and API for JavaBean validation</strong>. The default metadata source is annotations, with the ability to override and extend the meta-data through the use of XML validation descriptors.</p>
<p>The validation API developed by this JSR is not intended for use in any one tier or programming model. It is specifically not tied to either the web tier or the persistence tier, and is <strong>available for both server-side application programming, as well as rich client Swing application developers.</strong> This API is seen as a <strong>general extension to the JavaBeans object model,</strong> and as such is expected to be used as a core component in other specifications. Ease of use and flexibility have influenced the design of this specification.</p>
</blockquote>
<p>如果同样的校验逻辑会在每个层都存在，就会很容易出bug，而且写起来也很耗时；一般的做法是将校验逻辑带入领域层，但是这些校验逻辑只是对应类的一种元数据；JSR-303就是一种描述这种元数据的方式。用他们的口号来说，就是：</p>
<blockquote>
<p> Constrain once, validate everywhere</p>
</blockquote>
<h2 id="jsr-349——Bean-Validation-1-1："><a href="#jsr-349——Bean-Validation-1-1：" class="headerlink" title="jsr-349——Bean Validation 1.1："></a><code>jsr-349</code>——Bean Validation 1.1：</h2><blockquote>
<p>Bean Validation 1.1 focused on the following topics:</p>
</blockquote>
<ul>
<li>openness of the specification and its process</li>
<li>method-level validation (validation of parameters or return values)</li>
<li>dependency injection for Bean Validation components</li>
<li>integration with Context and Dependency Injection (CDI)</li>
<li>group conversion</li>
<li>error message interpolation using EL expressions</li>
</ul>
<p>1.1支持了方法级别的校验。</p>
<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><img src="/2021/03/05/spring-validator/image-20210303162356732.png">
<h3 id="第一种启动方式（Xml-Config-or-Default）："><a href="#第一种启动方式（Xml-Config-or-Default）：" class="headerlink" title="第一种启动方式（Xml Config or Default）："></a>第一种启动方式（Xml Config or Default）：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br></pre></td></tr></table></figure>
<p>这种情况下， validator的提供是通过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* The chosen provider is defined as followed:</span><br><span class="line">*     &lt;ul&gt;</span><br><span class="line">*         &lt;li&gt;if the XML configuration defines a provider, this provider is used&lt;/li&gt;</span><br><span class="line">*         &lt;li&gt;if the XML configuration does not define a provider or if no XML</span><br><span class="line">*         configuration is present the first provider returned by the</span><br><span class="line">*         &#123;@link ValidationProviderResolver&#125; instance is used.&lt;/li&gt;</span><br><span class="line">*     &lt;/ul&gt;</span><br><span class="line">**/</span><br></pre></td></tr></table></figure>
<ul>
<li>优先使用xml的配置：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//javax.validation.Configuration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> * By default, the configuration information is retrieved from</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> META-INF/validation.xml&#125;.</span></span><br><span class="line"><span class="comment"> * It is possible to override the configuration retrieved from the XML file</span></span><br><span class="line"><span class="comment"> * by using one or more of the &#123;<span class="doctag">@code</span> Configuration&#125; methods.</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> **/</span></span><br></pre></td></tr></table></figure>
<p><code>validation.xml</code>配置示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">validation-config</span> <span class="attr">xmlns</span>=<span class="string">"http://jboss.org/xml/ns/javax/validation/configuration"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://jboss.org/xml/ns/javax/validation/configuration"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default-provider</span>&gt;</span>org.hibernate.validator.HibernateValidator<span class="tag">&lt;/<span class="name">default-provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">message-interpolator</span>&gt;</span>org.hibernate.validator.engine.ResourceBundleMessageInterpolator<span class="tag">&lt;/<span class="name">message-interpolator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">traversable-resolver</span>&gt;</span>org.hibernate.validator.engine.resolver.DefaultTraversableResolver<span class="tag">&lt;/<span class="name">traversable-resolver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constraint-validator-factory</span>&gt;</span>org.hibernate.validator.engine.ConstraintValidatorFactoryImpl<span class="tag">&lt;/<span class="name">constraint-validator-factory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constraint-mapping</span>&gt;</span>/constraints-car.xml<span class="tag">&lt;/<span class="name">constraint-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prop1"</span>&gt;</span>value1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prop2"</span>&gt;</span>value2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">validation-config</span>&gt;</span></span><br></pre></td></tr></table></figure>
  <img src="/2021/03/05/spring-validator/image-20210303181653486.png">
<ul>
<li>如果没有，就取SPI加载的第一个provider的配置：</li>
</ul>
<blockquote>
<p>Bean Validation providers are identified by the presence of<br>{@code META-INF/services/javax.validation.spi.ValidationProvider}</p>
</blockquote>
<img src="/2021/03/05/spring-validator/image-20210303181422423.png">
<p>一般都是用的这种方式</p>
<h3 id="第二种启动方式（Java-Config）："><a href="#第二种启动方式（Java-Config）：" class="headerlink" title="第二种启动方式（Java Config）："></a>第二种启动方式（Java Config）：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Configuration&lt;?&gt; configuration = Validation</span><br><span class="line">                                .byDefaultProvider()</span><br><span class="line">                                .providerResolver( <span class="keyword">new</span> MyResolverStrategy() )</span><br><span class="line">                                .configure();</span><br><span class="line">ValidatorFactory factory = configuration.buildValidatorFactory();</span><br></pre></td></tr></table></figure>
<p>可以配置一个自定义的<code>provider resolver</code>，来决定使用哪个validator。</p>
<p>xml的配置，可以通过编程的方式调用<code>javax.validation.Configuration</code>来实现. 另外, 你可以通过<br>API的方式来重写xml中的配置信息, 也可以通过调用 <code>Configuration.ignoreXmlConfiguration()</code>来完全的忽略掉xml的配置信息. </p>
<h3 id="第三种启动方式"><a href="#第三种启动方式" class="headerlink" title="第三种启动方式"></a>第三种启动方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ACMEConfiguration configuration = Validation</span><br><span class="line">   .byProvider(ACMEProvider<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">   .<span class="title">providerResolver</span>( <span class="title">new</span> <span class="title">MyResolverStrategy</span>() )  // <span class="title">optionally</span> <span class="title">set</span> <span class="title">the</span> <span class="title">provider</span> <span class="title">resolver</span></span></span><br><span class="line"><span class="class">   .<span class="title">configure</span>()</span>;</span><br><span class="line">ValidatorFactory factory = configuration.buildValidatorFactory();</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>定义好Constraint：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.air.validation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.air.validation.custom.CaseMode;</span><br><span class="line"><span class="keyword">import</span> com.air.validation.custom.CheckCase;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Max;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Min;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 代故</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/3 11:31 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String manufacturer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size</span>(min = <span class="number">2</span>, max = <span class="number">14</span>)</span><br><span class="line">    <span class="meta">@CheckCase</span>(CaseMode.UPPER)</span><br><span class="line">    <span class="keyword">private</span> String licensePlate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Min</span>(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> seatCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 嵌套校验</span></span><br><span class="line"><span class="comment">     * 如果标注了<span class="doctag">@Valid</span>, 那么当主对象被校验的时候,这些集合对象中的元素都会被校验.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> Person driver;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">(String manufacturer, String licensePlate, <span class="keyword">int</span> seatCount, Person driver)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.manufacturer = manufacturer;</span><br><span class="line">        <span class="keyword">this</span>.licensePlate = licensePlate;</span><br><span class="line">        <span class="keyword">this</span>.seatCount = seatCount;</span><br><span class="line">        <span class="keyword">this</span>.driver = driver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">(String manufacturer, String licensePlate, <span class="keyword">int</span> seatCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.manufacturer = manufacturer;</span><br><span class="line">        <span class="keyword">this</span>.licensePlate = licensePlate;</span><br><span class="line">        <span class="keyword">this</span>.seatCount = seatCount;</span><br><span class="line">        <span class="keyword">this</span>.driver = <span class="keyword">new</span> Person(<span class="string">"default-driver"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">(@Max(<span class="number">75</span>)</span> <span class="keyword">int</span> speedInMph) </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"driving car at speed "</span> + speedInMph);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.air.validation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hibernate.validator.HibernateValidator;</span><br><span class="line"><span class="keyword">import</span> org.junit.BeforeClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.internal.runners.JUnit4ClassRunner;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.ConstraintViolation;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Validation;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Validator;</span><br><span class="line"><span class="keyword">import</span> javax.validation.ValidatorFactory;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Max;</span><br><span class="line"><span class="keyword">import</span> javax.validation.executable.ExecutableValidator;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.assertEquals;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.assertNotNull;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 代故</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/3 11:33 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(JUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">CarTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Validator validator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutableValidator executableValidator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span></span><br><span class="line">        <span class="keyword">final</span> ValidatorFactory factory = Validation.byProvider(HibernateValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">configure</span>()</span></span><br><span class="line"><span class="class">            .<span class="title">failFast</span>(<span class="title">false</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">buildValidatorFactory</span>()</span>;</span><br><span class="line">        validator = factory.getValidator();</span><br><span class="line">        executableValidator = validator.forExecutables();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">manufacturerIsNull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car(<span class="keyword">null</span>, <span class="string">"DD-AB-123"</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Car&gt;&gt; constraintViolations = validator.validate(car);</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="number">1</span>, constraintViolations.size());</span><br><span class="line">        assertEquals(<span class="string">"may not be null"</span>, constraintViolations.iterator()</span><br><span class="line">            .next()</span><br><span class="line">            .getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">licensePlateTooShort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car(<span class="string">"Morris"</span>, <span class="string">"D"</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Car&gt;&gt; constraintViolations = validator.validate(car);</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="number">1</span>, constraintViolations.size());</span><br><span class="line">        assertEquals(<span class="string">"size must be between 2 and 14"</span>, constraintViolations.iterator()</span><br><span class="line">            .next()</span><br><span class="line">            .getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">seatCountTooLow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car(<span class="string">"Morris"</span>, <span class="string">"DD-AB-123"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Car&gt;&gt; constraintViolations = validator.validate(car);</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="number">1</span>, constraintViolations.size());</span><br><span class="line">        assertEquals(<span class="string">"must be greater than or equal to 2"</span>, constraintViolations.iterator()</span><br><span class="line">            .next()</span><br><span class="line">            .getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">carIsValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car(<span class="string">"Morris"</span>, <span class="string">"DD-AB-123"</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Car&gt;&gt; constraintViolations = validator.validate(car);</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="number">0</span>, constraintViolations.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testValidatePerson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Car car = <span class="keyword">new</span> Car(<span class="string">"Morris"</span>, <span class="string">"豫D-AAAAA"</span>, <span class="number">2</span>, <span class="keyword">new</span> Person(<span class="keyword">null</span>));</span><br><span class="line">        <span class="keyword">final</span> Set&lt;ConstraintViolation&lt;Car&gt;&gt; violations = validator.validate(car);</span><br><span class="line">        <span class="keyword">for</span> (ConstraintViolation&lt;Car&gt; violation: violations) &#123;</span><br><span class="line">            System.out.println(violation.getPropertyPath() + <span class="string">" -&gt; "</span> + violation.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        assertNotNull(violations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * validateProperty() 和 validateValue() 会忽略被验证属性上定义的<span class="doctag">@Valid</span>.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testValidateValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        final Set&lt;ConstraintViolation&lt;Car&gt;&gt; violations = validator.validateValue(Car.class, "driver", new Person(null));</span><br><span class="line">        <span class="keyword">for</span> (ConstraintViolation&lt;Car&gt; violation: violations) &#123;</span><br><span class="line">            System.out.println(violation.getLeafBean().getClass().getSimpleName() + <span class="string">" -&gt; "</span> + violation.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        assertEquals(<span class="number">0</span>, violations.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLicensePlateNotUpperCase</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Car car = <span class="keyword">new</span> Car(<span class="string">"Morris"</span>, <span class="string">"dd-ab-123"</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Car&gt;&gt; constraintViolations =</span><br><span class="line">            validator.validate(car);</span><br><span class="line">        assertEquals(<span class="number">1</span>, constraintViolations.size());</span><br><span class="line">        assertEquals(</span><br><span class="line">            <span class="string">"Case mode must be UPPER."</span>,</span><br><span class="line">            constraintViolations.iterator().next().getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDrivingCar</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">        Car object = <span class="keyword">new</span> Car( <span class="string">"Morris"</span> ,<span class="string">"dd-ab-123"</span>, <span class="number">4</span>);</span><br><span class="line">        Method method = Car.class.getMethod( "drive", int.class );</span><br><span class="line">        Object[] parameterValues = &#123; <span class="number">80</span> &#125;;</span><br><span class="line">      	<span class="comment">// 并没有触发实际的调用</span></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Car&gt;&gt; violations = executableValidator.validateParameters(</span><br><span class="line">            object,</span><br><span class="line">            method,</span><br><span class="line">            parameterValues</span><br><span class="line">        );</span><br><span class="line">        assertEquals( <span class="number">1</span>, violations.size() );</span><br><span class="line">        Class&lt;? extends Annotation&gt; constraintType = violations.iterator() .next() .getConstraintDescriptor() .getAnnotation() .annotationType();</span><br><span class="line">        assertEquals( Max<span class="class">.<span class="keyword">class</span>, <span class="title">constraintType</span> )</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>获取Validator过程：</p>
<img src="/2021/03/05/spring-validator/image-20210304162919206.png">
<h3 id="ValidationProviderResolver"><a href="#ValidationProviderResolver" class="headerlink" title="ValidationProviderResolver"></a>ValidationProviderResolver</h3><h4 id="DefaultValidationProviderResolver"><a href="#DefaultValidationProviderResolver" class="headerlink" title="DefaultValidationProviderResolver"></a>DefaultValidationProviderResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds &#123;<span class="doctag">@link</span> ValidationProvider&#125; according to the default &#123;<span class="doctag">@link</span> ValidationProviderResolver&#125; defined in the</span></span><br><span class="line"><span class="comment"> * Bean Validation specification. This implementation first uses thread's context classloader to locate providers.</span></span><br><span class="line"><span class="comment"> * If no suitable provider is found using the aforementioned class loader, it uses current class loader.</span></span><br><span class="line"><span class="comment"> * If it still does not find any suitable provider, it tries to locate the built-in provider using the current</span></span><br><span class="line"><span class="comment"> * class loader.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Emmanuel Bernard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Hardy Ferentschik</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultValidationProviderResolver</span> <span class="keyword">implements</span> <span class="title">ValidationProviderResolver</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> List&lt;ValidationProvider&lt;?&gt;&gt; getValidationProviders() &#123;</span><br><span class="line">		<span class="comment">// class loading and ServiceLoader methods should happen in a PrivilegedAction</span></span><br><span class="line">		<span class="keyword">return</span> GetValidationProviderListAction.getValidationProviderList();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的策略是：</p>
<ul>
<li><p>先从thread’s context class loader 中加载<code>SPI</code>接口<code>ValidationProvider</code>对应的实现，</p>
</li>
<li><p>如果没有加载到，就从<code>DefaultValidationProviderResolver</code>对应的classloader中加载。</p>
</li>
</ul>
<blockquote>
<p>if we cannot find any service files with the context class loader use the current class loader</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javax.validation.Validation.GetValidationProviderListAction</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ValidationProvider&lt;?&gt;&gt; run() &#123;</span><br><span class="line">   <span class="comment">// Option #1: try first context class loader</span></span><br><span class="line">   <span class="comment">//从contextClassLoader中加载</span></span><br><span class="line">   ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">   List&lt;ValidationProvider&lt;?&gt;&gt; cachedContextClassLoaderProviderList = getCachedValidationProviders( classloader );</span><br><span class="line">   <span class="keyword">if</span> ( cachedContextClassLoaderProviderList != <span class="keyword">null</span> ) &#123;</span><br><span class="line">      <span class="comment">// if already processed return the cached provider list</span></span><br><span class="line">      <span class="keyword">return</span> cachedContextClassLoaderProviderList;</span><br><span class="line">   &#125;</span><br><span class="line">   List&lt;ValidationProvider&lt;?&gt;&gt; validationProviderList = loadProviders( classloader );</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Option #2: if we cannot find any service files with the context class loader use the current class loader</span></span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> ( validationProviderList.isEmpty() ) &#123;</span><br><span class="line">      <span class="comment">// 从当前class的加载器加载</span></span><br><span class="line">      classloader = DefaultValidationProviderResolver<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">      List&lt;ValidationProvider&lt;?&gt;&gt; cachedCurrentClassLoaderProviderList = getCachedValidationProviders(</span><br><span class="line">            classloader</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> ( cachedCurrentClassLoaderProviderList != <span class="keyword">null</span> ) &#123;</span><br><span class="line">         <span class="comment">// if already processed return the cached provider list</span></span><br><span class="line">         <span class="keyword">return</span> cachedCurrentClassLoaderProviderList;</span><br><span class="line">      &#125;</span><br><span class="line">      validationProviderList = loadProviders( classloader );</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// cache the detected providers against the classloader in which they were found</span></span><br><span class="line">   cacheValidationProviders( classloader, validationProviderList );</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> validationProviderList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于<code>loadProviders</code>就是加载<code>SPI</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;ValidationProvider&lt;?&gt;&gt; loadProviders(ClassLoader classloader) &#123;</span><br><span class="line">    ServiceLoader&lt;ValidationProvider&gt; loader = ServiceLoader.load( ValidationProvider<span class="class">.<span class="keyword">class</span>, <span class="title">classloader</span> )</span>;</span><br><span class="line">    Iterator&lt;ValidationProvider&gt; providerIterator = loader.iterator();</span><br><span class="line">    List&lt;ValidationProvider&lt;?&gt;&gt; validationProviderList = <span class="keyword">new</span> ArrayList&lt;ValidationProvider&lt;?&gt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> ( providerIterator.hasNext() ) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            validationProviderList.add( providerIterator.next() );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ServiceConfigurationError e ) &#123;</span><br><span class="line">            <span class="comment">// ignore, because it can happen when multiple</span></span><br><span class="line">            <span class="comment">// providers are present and some of them are not class loader</span></span><br><span class="line">            <span class="comment">// compatible with our API.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> validationProviderList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Hibernate-Validator"><a href="#Hibernate-Validator" class="headerlink" title="Hibernate-Validator"></a>Hibernate-Validator</h1><p><code>javax.validation</code>只是定义好了api，具体的实现一般用hibernate提供的validator。</p>
<p>获取元数据过程：</p>
<img src="/2021/03/05/spring-validator/image-20210304162952525.png">
<p>具体实现类的选取，走的是<code>SPI</code>加载机制，所以先从<code>SPI</code>入手，找到 jar包下的<code>META-INF/services/javax.validation.spi.ValidationProvider</code>声明具体的实现类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.hibernate.validator.HibernateValidator</span><br></pre></td></tr></table></figure>
<h2 id="Validate过程："><a href="#Validate过程：" class="headerlink" title="Validate过程："></a>Validate过程：</h2><h3 id="validate"><a href="#validate" class="headerlink" title="validate"></a>validate</h3><img src="/2021/03/05/spring-validator/image-20210304163057740.png">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.hibernate.validator.internal.engine.ValidatorImpl#validate</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validate(T object, Class&lt;?&gt;... groups) &#123;</span><br><span class="line">		Contracts.assertNotNull( object, MESSAGES.validatedObjectMustNotBeNull() );</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 没有注解信息或者xml中没有配置校验，直接返回空集合</span></span><br><span class="line">		<span class="keyword">if</span> ( !beanMetaDataManager.isConstrained( object.getClass() ) ) &#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">		ValidationOrder validationOrder = determineGroupValidationOrder( groups );</span><br><span class="line">		ValidationContext&lt;T&gt; validationContext = getValidationContext().forValidate( object );</span><br><span class="line">		<span class="comment">// valueContext会不停的切换，路径也会更新，跟具体validate的属性有关</span></span><br><span class="line">		ValueContext&lt;?, Object&gt; valueContext = ValueContext.getLocalExecutionContext(</span><br><span class="line">				object,</span><br><span class="line">				beanMetaDataManager.getBeanMetaData( object.getClass() ),</span><br><span class="line">				PathImpl.createRootPath()</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> validateInContext( valueContext, validationContext, validationOrder );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.hibernate.validator.internal.engine.ValidatorImpl#validateInContext</span></span><br><span class="line"><span class="keyword">private</span> &lt;T, U&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateInContext(ValueContext&lt;U, Object&gt; valueContext, ValidationContext&lt;T&gt; context, ValidationOrder validationOrder) &#123;</span><br><span class="line">  <span class="keyword">if</span> ( valueContext.getCurrentBean() == <span class="keyword">null</span> ) &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对应类的元数据</span></span><br><span class="line">  BeanMetaData&lt;U&gt; beanMetaData = beanMetaDataManager.getBeanMetaData( valueContext.getCurrentBeanType() );</span><br><span class="line">  <span class="keyword">if</span> ( beanMetaData.defaultGroupSequenceIsRedefined() ) &#123;</span><br><span class="line">    validationOrder.assertDefaultGroupSequenceIsExpandable( beanMetaData.getDefaultGroupSequence( valueContext.getCurrentBean() ) );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// process first single groups. For these we can optimise object traversal by first running all validations on the current bean</span></span><br><span class="line">  <span class="comment">// before traversing the object.</span></span><br><span class="line">  <span class="comment">// 单个组的</span></span><br><span class="line">  Iterator&lt;Group&gt; groupIterator = validationOrder.getGroupIterator();</span><br><span class="line">  <span class="keyword">while</span> ( groupIterator.hasNext() ) &#123;</span><br><span class="line">    Group group = groupIterator.next();</span><br><span class="line">    valueContext.setCurrentGroup( group.getDefiningClass() );</span><br><span class="line">    validateConstraintsForCurrentGroup( context, valueContext );</span><br><span class="line">    <span class="keyword">if</span> ( shouldFailFast( context ) ) &#123;</span><br><span class="line">      <span class="keyword">return</span> context.getFailingConstraints();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  groupIterator = validationOrder.getGroupIterator();</span><br><span class="line">  <span class="keyword">while</span> ( groupIterator.hasNext() ) &#123;</span><br><span class="line">    Group group = groupIterator.next();</span><br><span class="line">    valueContext.setCurrentGroup( group.getDefiningClass() );</span><br><span class="line">   	<span class="comment">// 校验级联的</span></span><br><span class="line">    validateCascadedConstraints( context, valueContext );</span><br><span class="line">    <span class="keyword">if</span> ( shouldFailFast( context ) ) &#123;</span><br><span class="line">      <span class="keyword">return</span> context.getFailingConstraints();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now we process sequences. For sequences I have to traverse the object graph since I have to stop processing when an error occurs.</span></span><br><span class="line">  <span class="comment">// 多个组的 @GroupSequence(&#123;RentalCar.class, CarChecks.class, DriverChecks.class&#125;)</span></span><br><span class="line">  Iterator&lt;Sequence&gt; sequenceIterator = validationOrder.getSequenceIterator();</span><br><span class="line">  <span class="keyword">while</span> ( sequenceIterator.hasNext() ) &#123;</span><br><span class="line">    Sequence sequence = sequenceIterator.next();</span><br><span class="line">    <span class="keyword">for</span> ( Group group : sequence.getComposingGroups() ) &#123;</span><br><span class="line">      <span class="keyword">int</span> numberOfViolations = context.getFailingConstraints().size();</span><br><span class="line">      valueContext.setCurrentGroup( group.getDefiningClass() );</span><br><span class="line"></span><br><span class="line">      validateConstraintsForCurrentGroup( context, valueContext );</span><br><span class="line">      <span class="keyword">if</span> ( shouldFailFast( context ) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> context.getFailingConstraints();</span><br><span class="line">      &#125;</span><br><span class="line">			<span class="comment">// 级联的</span></span><br><span class="line">      validateCascadedConstraints( context, valueContext );</span><br><span class="line">      <span class="keyword">if</span> ( shouldFailFast( context ) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> context.getFailingConstraints();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( context.getFailingConstraints().size() &gt; numberOfViolations ) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> context.getFailingConstraints();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="嵌套类型"><a href="#嵌套类型" class="headerlink" title="嵌套类型"></a>嵌套类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.hibernate.validator.internal.metadata.provider.AnnotationMetaDataProvider#findPropertyMetaData</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ConstrainedField <span class="title">findPropertyMetaData</span><span class="params">(Field field)</span> </span>&#123;</span><br><span class="line">		Set&lt;MetaConstraint&lt;?&gt;&gt; constraints = convertToMetaConstraints(</span><br><span class="line">				findConstraints( field, ElementType.FIELD ),</span><br><span class="line">				field</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		Map&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; groupConversions = getGroupConversions(</span><br><span class="line">				field.getAnnotation( ConvertGroup<span class="class">.<span class="keyword">class</span> ),</span></span><br><span class="line"><span class="class">				<span class="title">field</span>.<span class="title">getAnnotation</span>( <span class="title">ConvertGroup</span>.<span class="title">List</span>.<span class="title">class</span> )</span></span><br><span class="line"><span class="class">		)</span>;</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// 被@Valid修饰的就认为是嵌套的</span></span><br><span class="line">		<span class="keyword">boolean</span> isCascading = field.isAnnotationPresent( Valid<span class="class">.<span class="keyword">class</span> )</span>;</span><br><span class="line">		<span class="keyword">boolean</span> requiresUnwrapping = field.isAnnotationPresent( UnwrapValidatedValue<span class="class">.<span class="keyword">class</span> )</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ConstrainedField(</span><br><span class="line">				ConfigurationSource.ANNOTATION,</span><br><span class="line">				ConstraintLocation.forProperty( field ),</span><br><span class="line">				constraints,</span><br><span class="line">				groupConversions,</span><br><span class="line">				isCascading,</span><br><span class="line">				requiresUnwrapping</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="方法级别的验证"><a href="#方法级别的验证" class="headerlink" title="方法级别的验证"></a>方法级别的验证</h2><p>方法级别的验证是通过<code>ExecutableValidator</code>中的相关接口来实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateParameters(T object,</span><br><span class="line">													   Method method,</span><br><span class="line">													   Object[] parameterValues,</span><br><span class="line">													   Class&lt;?&gt;... groups);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateReturnValue(T object,</span><br><span class="line">														Method method,</span><br><span class="line">														Object returnValue,</span><br><span class="line">														Class&lt;?&gt;... groups);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateConstructorParameters(Constructor&lt;? extends T&gt; constructor,</span><br><span class="line">																  Object[] parameterValues,</span><br><span class="line">																  Class&lt;?&gt;... groups);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateConstructorReturnValue(Constructor&lt;? extends T&gt; constructor,</span><br><span class="line">																   T createdObject,</span><br><span class="line">																   Class&lt;?&gt;... groups);</span><br></pre></td></tr></table></figure>
<p>hibernate中对应的实现还在<code>ValidatorImpl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.hibernate.validator.internal.engine.ValidatorImpl#validateParameters(T, java.lang.reflect.Executable, java.lang.Object[], java.lang.Class&lt;?&gt;...)</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validateParameters(T object, Executable executable, Object[] parameterValues, Class&lt;?&gt;... groups) &#123;</span><br><span class="line">		sanityCheckGroups( groups );</span><br><span class="line"></span><br><span class="line">		ValidationContext&lt;T&gt; validationContext = getValidationContextBuilder().forValidateParameters(</span><br><span class="line">				validatorScopedContext.getParameterNameProvider(),</span><br><span class="line">				object,</span><br><span class="line">				executable,</span><br><span class="line">				parameterValues</span><br><span class="line">		);</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// 没有注解约束的直接返回</span></span><br><span class="line">		<span class="keyword">if</span> (!validationContext.getRootBeanMetaData().hasConstraints() ) &#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 决定校验组</span></span><br><span class="line">		ValidationOrder validationOrder = determineGroupValidationOrder( groups );</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// 校验逻辑</span></span><br><span class="line">		validateParametersInContext( validationContext, parameterValues, validationOrder );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> validationContext.getFailingConstraints();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>元数据的获取方式扩展了下，后续的校验流程和bean属性的validate类似：</p>
<img src="/2021/03/05/spring-validator/image-20210305112537440.png">
<h2 id="ConstraintValidator"><a href="#ConstraintValidator" class="headerlink" title="ConstraintValidator"></a>ConstraintValidator</h2><p>约束逻辑应该实现的接口</p>
<ul>
<li><p>对应的工厂类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javax.validation.ConstraintValidatorFactory</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintValidatorFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&lt;T extends ConstraintValidator&lt;?, ?&gt;&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">releaseInstance</span><span class="params">(ConstraintValidator&lt;?, ?&gt; instance)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口定义：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">A</span> <span class="keyword">extends</span> <span class="title">Annotation</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(A constraintAnnotation)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(T value, ConstraintValidatorContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个接口定义了具体的校验逻辑的实现，可以实现这个接口，添加自己的校验逻辑。</p>
<p><code>NotBlankValidator</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotBlankValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">NotBlank</span>, <span class="title">CharSequence</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Checks that the character sequence is not &#123;<span class="doctag">@code</span> null&#125; nor empty after removing any leading or trailing</span></span><br><span class="line"><span class="comment">	 * whitespace.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> charSequence the character sequence to validate</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> constraintValidatorContext context in which the constraint is evaluated</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> returns &#123;<span class="doctag">@code</span> true&#125; if the string is not &#123;<span class="doctag">@code</span> null&#125; and the length of the trimmed</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> charSequence&#125; is strictly superior to 0, &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(CharSequence charSequence, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( charSequence == <span class="keyword">null</span> ) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> charSequence.toString().trim().length() &gt; <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注解和实现的映射关系</li>
</ul>
<p>注解和具体的实现类的映射维护在<code>org.hibernate.validator.internal.metadata.core.ConstraintHelper</code>:</p>
<img src="/2021/03/05/spring-validator/image-20210304114621014.png">
<p>这个映射关系，在<code>MetaDataProvider</code>处理的时候，就已经映射好，放在了<code>ConstraintDescriptor</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.hibernate.validator.internal.metadata.descriptor.ConstraintDescriptorImpl#ConstraintDescriptorImpl(org.hibernate.validator.internal.metadata.core.ConstraintHelper, java.lang.reflect.Member, org.hibernate.validator.internal.util.annotation.ConstraintAnnotationDescriptor&lt;T&gt;, java.lang.annotation.ElementType, java.lang.Class&lt;?&gt;, org.hibernate.validator.internal.metadata.core.ConstraintOrigin, org.hibernate.validator.internal.metadata.descriptor.ConstraintDescriptorImpl.ConstraintType)</span></span><br><span class="line">		<span class="keyword">this</span>.constraintValidatorClasses = constraintHelper.getAllValidatorDescriptors( annotationDescriptor.getType() )</span><br><span class="line">				.stream()</span><br><span class="line">				.map( ConstraintValidatorDescriptor::getValidatorClass )</span><br><span class="line">				.collect( Collectors.collectingAndThen( Collectors.toList(), CollectionHelper::toImmutableList ) );</span><br></pre></td></tr></table></figure>
<p>后面再根据，具体的值的类型来筛选，具体的<code>ConstraintValidator</code></p>
<p>annotation –&gt; ConstraintValidator  + 值的实际类型 –&gt; ConstraintValidator的具体实现;</p>
<p>也可以直接在注解中指定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;METHOD, FIELD, ANNOTATION_TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="comment">// 指定具体的ConstraintValidator</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = CheckCaseValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Documented</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">CheckCase</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "</span>&#123;com.mycompany.constraints.checkcase&#125;<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CaseMode value();</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="版本升级的坑"><a href="#版本升级的坑" class="headerlink" title="版本升级的坑"></a>版本升级的坑</h2><ul>
<li><p>maven坐标变了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">version=6.0.10.Final</span><br><span class="line">groupId=org.hibernate.validator</span><br><span class="line">artifactId=hibernate-validator</span><br><span class="line"></span><br><span class="line">version=5.1.3.Final</span><br><span class="line">groupId=org.hibernate</span><br><span class="line">artifactId=hibernate-validator</span><br></pre></td></tr></table></figure>
<p>俩groupId不一样，有的时候会造成一些冲突。</p>
</li>
</ul>
<h1 id="Spring集成"><a href="#Spring集成" class="headerlink" title="Spring集成"></a>Spring集成</h1><h2 id="Spring-mvc"><a href="#Spring-mvc" class="headerlink" title="Spring mvc"></a>Spring mvc</h2><blockquote>
<p> By default use of <code>@EnableWebMvc</code> or <code>&lt;mvc:annotation-driven&gt;</code> automatically registers Bean Validation support in Spring MVC through the <code>LocalValidatorFactoryBean</code> when a Bean Validation provider such as Hibernate Validator is detected on the classpath.</p>
</blockquote>
<h3 id="xml配置"><a href="#xml配置" class="headerlink" title="xml配置"></a>xml配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> <span class="attr">validator</span>=<span class="string">"globalValidator"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>初始化路径：</p>
<img src="/2021/03/05/spring-validator/image-20210304225708264.png">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		registerBeanDefinitionParser(<span class="string">"annotation-driven"</span>, <span class="keyword">new</span> AnnotationDrivenBeanDefinitionParser());</span><br><span class="line">    <span class="comment">// 省略。。。</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>AnnotationDrivenBeanDefinitionParser</code>这个类中会注册许多默认的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.config.AnnotationDrivenBeanDefinitionParser#parse</span></span><br><span class="line"><span class="comment">// 这里引入了validator</span></span><br><span class="line">RuntimeBeanReference validator = getValidator(element, source, parserContext);</span><br><span class="line"><span class="comment">// WebBindingInitializer，用来初始化webDataBinder</span></span><br><span class="line">RootBeanDefinition bindingDef = <span class="keyword">new</span> RootBeanDefinition(ConfigurableWebBindingInitializer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		bindingDef.setSource(source);</span><br><span class="line">		bindingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">		bindingDef.getPropertyValues().add(<span class="string">"conversionService"</span>, conversionService);</span><br><span class="line">		bindingDef.getPropertyValues().add(<span class="string">"validator"</span>, validator);</span><br><span class="line">		bindingDef.getPropertyValues().add(<span class="string">"messageCodesResolver"</span>, messageCodesResolver);</span><br><span class="line"></span><br><span class="line"><span class="comment">// RequestMappingHandlerAdapter负责请求的处理，可以看前面的mvc源码解析</span></span><br><span class="line">RootBeanDefinition handlerAdapterDef = <span class="keyword">new</span> RootBeanDefinition(RequestMappingHandlerAdapter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">// initializer 传递给了 RequestMappingHandlerAdapter</span></span><br><span class="line">handlerAdapterDef.getPropertyValues().add(<span class="string">"webBindingInitializer"</span>, bindingDef);</span><br></pre></td></tr></table></figure>
<p><code>getValidator</code>生成了validator的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.config.AnnotationDrivenBeanDefinitionParser#getValidator</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> javaxValidationPresent =</span><br><span class="line">			ClassUtils.isPresent(<span class="string">"javax.validation.Validator"</span>, AnnotationDrivenBeanDefinitionParser<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> RuntimeBeanReference <span class="title">getValidator</span><span class="params">(Element element, Object source, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// xml配置里可以指定一个validator作为全局的，如果指定了，这里就返回指定的	</span></span><br><span class="line">  <span class="keyword">if</span> (element.hasAttribute(<span class="string">"validator"</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> RuntimeBeanReference(element.getAttribute(<span class="string">"validator"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (javaxValidationPresent) &#123;</span><br><span class="line">    RootBeanDefinition validatorDef = <span class="keyword">new</span> RootBeanDefinition(</span><br><span class="line">      <span class="string">"org.springframework.validation.beanvalidation.OptionalValidatorFactoryBean"</span>);</span><br><span class="line">    validatorDef.setSource(source);</span><br><span class="line">    validatorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    String validatorName = parserContext.getReaderContext().registerWithGeneratedName(validatorDef);</span><br><span class="line">    parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(validatorDef, validatorName));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RuntimeBeanReference(validatorName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到默认注入的是<code>OptionalValidatorFactoryBean</code>它是<code>LocalValidatorFactoryBean</code>的子类，跟jsr-303的validator对接的代码都在<code>LocalValidatorFactoryBean</code>中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.validation.beanvalidation.LocalValidatorFactoryBean#afterPropertiesSet</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Validator <span class="title">getValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Assert.notNull(<span class="keyword">this</span>.validatorFactory, <span class="string">"No target ValidatorFactory set"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.validatorFactory.getValidator();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>初始化完成之后，就可以拿到validator了，底层可能就是hibernate实现的validator。</p>
<h3 id="Java配置"><a href="#Java配置" class="headerlink" title="Java配置"></a>Java配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Validator <span class="title">getValidator</span><span class="params">()</span></span>; &#123;</span><br><span class="line">        <span class="comment">// return "global" validator</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java的配置和xml的作用差不多，只是java的配置是用java的代码写的，先看注解的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(DelegatingWebMvcConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableWebMvc</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>import了一个配置类<code>DelegatingWebMvcConfiguration</code>, 它继承自<code>WebMvcConfigurationSupport</code>, 这个配置类注册了许多默认的bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport</span></span><br><span class="line"><span class="comment">// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#requestMappingHandlerAdapter</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestMappingHandlerAdapter <span class="title">requestMappingHandlerAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		RequestMappingHandlerAdapter adapter = createRequestMappingHandlerAdapter();</span><br><span class="line">		<span class="comment">// WebBindingInitializer</span></span><br><span class="line">		adapter.setWebBindingInitializer(getConfigurableWebBindingInitializer());</span><br><span class="line">		<span class="comment">// 省略</span></span><br><span class="line">		<span class="keyword">return</span> adapter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#getConfigurableWebBindingInitializer</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the &#123;<span class="doctag">@link</span> ConfigurableWebBindingInitializer&#125; to use for</span></span><br><span class="line"><span class="comment">	 * initializing all &#123;<span class="doctag">@link</span> WebDataBinder&#125; instances.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ConfigurableWebBindingInitializer <span class="title">getConfigurableWebBindingInitializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ConfigurableWebBindingInitializer initializer = <span class="keyword">new</span> ConfigurableWebBindingInitializer();</span><br><span class="line">		initializer.setConversionService(mvcConversionService());</span><br><span class="line">    <span class="comment">// 这里关联了validator</span></span><br><span class="line">		initializer.setValidator(mvcValidator());</span><br><span class="line">		initializer.setMessageCodesResolver(getMessageCodesResolver());</span><br><span class="line">		<span class="keyword">return</span> initializer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#mvcValidator</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Validator <span class="title">mvcValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 子类可以覆写，</span></span><br><span class="line">		Validator validator = getValidator();</span><br><span class="line">		<span class="keyword">if</span> (validator == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (ClassUtils.isPresent(<span class="string">"javax.validation.Validator"</span>, getClass().getClassLoader())) &#123;</span><br><span class="line">				Class&lt;?&gt; clazz;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 默认的Validator实现类</span></span><br><span class="line">					String className = <span class="string">"org.springframework.validation.beanvalidation.OptionalValidatorFactoryBean"</span>;</span><br><span class="line">					clazz = ClassUtils.forName(className, WebMvcConfigurationSupport<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(<span class="string">"Could not find default validator class"</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (LinkageError ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(<span class="string">"Could not load default validator class"</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">				validator = (Validator) BeanUtils.instantiateClass(clazz);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				validator = <span class="keyword">new</span> NoOpValidator();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> validator;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="请求处理"><a href="#请求处理" class="headerlink" title="请求处理"></a>请求处理</h3><p>初始化完成之后，就是请求来时的处理了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod</span></span><br><span class="line"><span class="comment">// 前面配置的WebBindingInitializer，会在这一步传递给WebDataBinderFactory</span></span><br><span class="line">WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class="line"><span class="comment">// 省略</span></span><br><span class="line">invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod#invokeAndHandle</span></span><br><span class="line">Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line"><span class="comment">// org.springframework.web.method.support.InvocableHandlerMethod#invokeForRequest</span></span><br><span class="line">Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line"><span class="comment">// org.springframework.web.method.support.InvocableHandlerMethod#getMethodArgumentValues</span></span><br><span class="line"><span class="comment">// 这里就转交给了argumentResolvers （HandlerMethodArgumentResolver），来处理</span></span><br><span class="line">args[i] = <span class="keyword">this</span>.argumentResolvers.resolveArgument(</span><br><span class="line">  parameter, mavContainer, request, <span class="keyword">this</span>.dataBinderFactory);</span><br></pre></td></tr></table></figure>
<p>类型转换和校验是在<code>org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodArgumentResolver#validateIfApplicable</code>:</p>
<img src="/2021/03/05/spring-validator/image-20210304231222896.png">
<p>以处理json/xml的<code>RequestResponseBodyMethodProcessor</code>为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Throws MethodArgumentNotValidException if validation fails.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> HttpMessageNotReadableException if &#123;<span class="doctag">@link</span> RequestBody#required()&#125;</span></span><br><span class="line"><span class="comment">	 * is &#123;<span class="doctag">@code</span> true&#125; and there is no body content or if there is no suitable</span></span><br><span class="line"><span class="comment">	 * converter to read the content with.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">			NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		parameter = parameter.nestedIfOptional();</span><br><span class="line">		Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType());</span><br><span class="line">		String name = Conventions.getVariableNameForParameter(parameter);</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 根据之前绑定的WebDataBinderFactory，初始化WebDataBinder；Validator就传递给了WebDataBinder</span></span><br><span class="line">    <span class="comment">// 注意binder是每次都创建的，他是有状态的</span></span><br><span class="line">		WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line">		<span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 校验参数</span></span><br><span class="line">			validateIfApplicable(binder, parameter);</span><br><span class="line">      <span class="comment">// 处理校验的结果</span></span><br><span class="line">			<span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> adaptArgumentIfNecessary(arg, parameter);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="方法级别的校验"><a href="#方法级别的校验" class="headerlink" title="方法级别的校验"></a>方法级别的校验</h2><blockquote>
<p>The method validation feature supported by Bean Validation 1.1, and as a custom extension</p>
<p>also by Hibernate Validator 4.3, can be integrated into a Spring context through a</p>
<p>MethodValidationPostProcessor bean definition:</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"localValidatorFactoryBeanTest"</span> <span class="attr">class</span>=<span class="string">"org.springframework.validation.beanvalidation.LocalValidatorFactoryBean"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.validation.beanvalidation.MethodValidationPostProcessor"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validator"</span> <span class="attr">ref</span>=<span class="string">"localValidatorFactoryBeanTest"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In order to be eligible for Spring-driven method validation, all target classes need to be annotated</p>
<p>with Spring’s @Validated annotation, optionally declaring the validation groups to use. </p>
</blockquote>
<p>条件：</p>
<ul>
<li>类需要标注<code>@Validated</code></li>
<li>引入<code>MethodValidationPostProcessor</code>, validator也可以不指定，spring会创建默认的</li>
<li>方法得是protected或者public的（不然拦截不到）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/mvc"</span>)</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123; </span><br><span class="line">  </span><br><span class="line">		<span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">echo</span><span class="params">(@Min(<span class="number">100</span>)</span> @<span class="title">RequestParam</span><span class="params">(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        log.info(<span class="string">"id=&#123;&#125;"</span>, id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>从<code>MethodValidationPostProcessor</code>入手，它间接地实现了<code>BeanPostProcessor</code>， 在bean初始化完成之后，做了拦截：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">private</span> Class&lt;? extends Annotation&gt; validatedAnnotationType = Validated<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"><span class="comment">// org.springframework.validation.beanvalidation.MethodValidationPostProcessor#afterPropertiesSet</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建了一个切面，切入的条件是被@Validated标识的类</span></span><br><span class="line">  Pointcut pointcut = <span class="keyword">new</span> AnnotationMatchingPointcut(<span class="keyword">this</span>.validatedAnnotationType, <span class="keyword">true</span>);</span><br><span class="line">  <span class="comment">// 创建切面对应的advisor</span></span><br><span class="line">  <span class="keyword">this</span>.advisor = <span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, createMethodValidationAdvice(<span class="keyword">this</span>.validator));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Advice <span class="title">createMethodValidationAdvice</span><span class="params">(Validator validator)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 用传入的JSR-303的创建一个Method的拦截器，或者基于默认的</span></span><br><span class="line">  <span class="keyword">return</span> (validator != <span class="keyword">null</span> ? <span class="keyword">new</span> MethodValidationInterceptor(validator) : <span class="keyword">new</span> MethodValidationInterceptor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>MethodValidationInterceptor</code>就是对调用方法做了一层拦截，在这里实现了具体校验逻辑的接入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.validation.beanvalidation.MethodValidationInterceptor#invoke</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  Class&lt;?&gt;[] groups = determineValidationGroups(invocation);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 反射拿到的方法，主要是看底层的validator是否支持JSR-349</span></span><br><span class="line">  <span class="keyword">if</span> (forExecutablesMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Standard Bean Validation 1.1 API</span></span><br><span class="line">    Object execVal = ReflectionUtils.invokeMethod(forExecutablesMethod, <span class="keyword">this</span>.validator);</span><br><span class="line">    Method methodToValidate = invocation.getMethod();</span><br><span class="line">    Set&lt;ConstraintViolation&lt;?&gt;&gt; result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 反射调用validator的参数校验的方法</span></span><br><span class="line">      result = (Set&lt;ConstraintViolation&lt;?&gt;&gt;) ReflectionUtils.invokeMethod(validateParametersMethod,</span><br><span class="line">                                                                          execVal, invocation.getThis(), methodToValidate, invocation.getArguments(), groups);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">      <span class="comment">// Probably a generic type mismatch between interface and impl as reported in SPR-12237 / HV-1011</span></span><br><span class="line">      <span class="comment">// Let's try to find the bridged method on the implementation class...</span></span><br><span class="line">      methodToValidate = BridgeMethodResolver.findBridgedMethod(</span><br><span class="line">        ClassUtils.getMostSpecificMethod(invocation.getMethod(), invocation.getThis().getClass()));</span><br><span class="line">      result = (Set&lt;ConstraintViolation&lt;?&gt;&gt;) ReflectionUtils.invokeMethod(validateParametersMethod,</span><br><span class="line">                                                                          execVal, invocation.getThis(), methodToValidate, invocation.getArguments(), groups);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">   	<span class="comment">// 调用方法的实际处理逻辑</span></span><br><span class="line">    Object returnValue = invocation.proceed();</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 反射调用validator的返回值校验的方法</span></span><br><span class="line">    result = (Set&lt;ConstraintViolation&lt;?&gt;&gt;) ReflectionUtils.invokeMethod(validateReturnValueMethod,</span><br><span class="line">                                                                        execVal, invocation.getThis(), methodToValidate, returnValue, groups);</span><br><span class="line">    <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Hibernate Validator 4.3's native API</span></span><br><span class="line">    <span class="keyword">return</span> HibernateValidatorDelegate.invokeWithinValidation(invocation, <span class="keyword">this</span>.validator, groups);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Spring管理的bean的校验"><a href="#Spring管理的bean的校验" class="headerlink" title="Spring管理的bean的校验"></a>Spring管理的bean的校验</h2><p>spring提供了<code>**BeanValidationPostProcessor**</code>, 可以校验bean的属性是否正确注入了。这个process默认没有包含，如需用到，需要手动添加。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.validation.beanvalidation.BeanValidationPostProcessor</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Simple &#123;<span class="doctag">@link</span> BeanPostProcessor&#125; that checks JSR-303 constraint annotations</span></span><br><span class="line"><span class="comment"> * in Spring-managed beans, throwing an initialization exception in case of</span></span><br><span class="line"><span class="comment"> * constraint violations right before calling the bean's init method (if any).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanValidationPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.afterInitialization) &#123;</span><br><span class="line">        doValidate(bean);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.afterInitialization) &#123;</span><br><span class="line">        doValidate(bean);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Perform validation of the given bean.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> bean the bean instance to validate</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> javax.validation.Validator#validate</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doValidate</span><span class="params">(Object bean)</span> </span>&#123;</span><br><span class="line">  Set&lt;ConstraintViolation&lt;Object&gt;&gt; result = <span class="keyword">this</span>.validator.validate(bean);</span><br><span class="line">  <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"Bean state is invalid: "</span>);</span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;ConstraintViolation&lt;Object&gt;&gt; it = result.iterator(); it.hasNext();) &#123;</span><br><span class="line">      ConstraintViolation&lt;Object&gt; violation = it.next();</span><br><span class="line">      sb.append(violation.getPropertyPath()).append(<span class="string">" - "</span>).append(violation.getMessage());</span><br><span class="line">      <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">        sb.append(<span class="string">"; "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(sb.toString());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Caused by: org.springframework.beans.factory.BeanInitializationException: Bean state is invalid: age - 最小不能小于10; id - 不能为null</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>​        bean validation的标准有两个，一个JSR-303，主要针对bean属性的校验；JSR-349引入了方法入参和返回值的校验。hibernate-validator实现了bean validation的标准；spring则包装和扩展了一层，让我们用起来更加舒服。</p>
<p>​        <code>@Valid</code>注解是javax中的注解，也是标准的一部分，用来做嵌套的校验；<code>@Validated</code>是spring的注解，主要是为了做方法参数和返回值的校验，用来生成方法的拦截器。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://my.oschina.net/u/3211616/blog/821343" rel="external nofollow noopener noreferrer" target="_blank">详解Bean Validation - 阅读的伟哥的个人空间 - 开源中国</a></li>
<li><a href="https://my.oschina.net/zzuqiang/blog/761862" rel="external nofollow noopener noreferrer" target="_blank">JSR303、349 -Bean Validation 数据校验规范使用说明和验证流程源码分析 - zzuqiang的个人空间 - 开源中国</a></li>
<li><a href="http://docs.jboss.org/hibernate/validator/4.2/reference/zh-CN/html_single/" rel="external nofollow noopener noreferrer" target="_blank">Hibernate Validator</a></li>
<li><a href="https://stackoverflow.com/questions/7337046/tomcat-classloading-doesnt-seem-to-behave-as-documented" rel="external nofollow noopener noreferrer" target="_blank">java - Tomcat classloading doesn’t seem to behave as documented - Stack Overflow</a></li>
<li><a href="https://beanvalidation.org/1.0/spec/" rel="external nofollow noopener noreferrer" target="_blank">JSR 303: Bean Validation</a></li>
<li><a href="https://beanvalidation.org/1.1/" rel="external nofollow noopener noreferrer" target="_blank">Jakarta Bean Validation - Bean Validation 1.1 (JSR 349)</a></li>
<li><a href="https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/mvc.html#mvc-config-validation" rel="external nofollow noopener noreferrer" target="_blank">21. Web MVC framework</a></li>
<li><a href="https://blog.csdn.net/f641385712/article/details/97402946" rel="external nofollow noopener noreferrer" target="_blank">Spring方法级别数据校验：@Validated + MethodValidationPostProcessor优雅的完成数据校验动作【享学Spring】_YourBatman-CSDN博客</a></li>
<li><a href="https://docs.jboss.org/hibernate/validator/5.1/reference/zh-CN/html/" rel="external nofollow noopener noreferrer" target="_blank">Hibernate Validator</a></li>
<li><a href="https://fangjian0423.github.io/2017/06/24/spring-embedded-bean-post-processor/" rel="external nofollow noopener noreferrer" target="_blank">Spring内置的BeanPostProcessor总结 | Format’s Notes</a></li>
</ul>
</div><footer class="post-footer"><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者: </strong>代故</li><li class="post-copyright-link"><strong>本文链接: </strong>    <a href="/2021/03/05/spring-validator/" target="_blank">http://qsli.github.io/2021/03/05/spring-validator/index.html</a></li>  <li class="post-copyright-license"><strong>版权声明: </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 3.0 CN</a></li></ul></div></footer><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2021/03/05/spring-validator/" data-id="cl9frejla00i3av6n3lni3wux" class="article-share-link">分享到</a><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? 整杯冰阔乐!<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://qsli.github.io/about/praise.jpg" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="tags"><a href="/tags/spring-validator/">spring-validator</a></div><div class="post-nav"><a href="/2021/03/10/spring-aop/" class="pre">spring-aop</a><a href="/2020/08/04/druid-pitfall/" class="next">druid踩坑记录</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2021/03/05/spring-validator/';
var disqus_title = 'spring-validator源码分析';
var disqus_url = 'http://qsli.github.io/2021/03/05/spring-validator/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/druid/">druid</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/feign/">feign</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mediawiki/">mediawiki</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservice/">microservice</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/logback/" style="font-size: 15px;">logback</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/threadpool/" style="font-size: 15px;">threadpool</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/cglib/" style="font-size: 15px;">cglib</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/pitfall-mysql-connector-java-8-x/" style="font-size: 15px;">pitfall mysql-connector-java 8.x</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/spring-cloud/" style="font-size: 15px;">spring-cloud</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/git-commit-id/" style="font-size: 15px;">git-commit-id</a> <a href="/tags/go学习资料/" style="font-size: 15px;">go学习资料</a> <a href="/tags/grafana/" style="font-size: 15px;">grafana</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/tranfer-encoding/" style="font-size: 15px;">tranfer-encoding</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/java-connector/" style="font-size: 15px;">java-connector</a> <a href="/tags/jinfo/" style="font-size: 15px;">jinfo</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/plantuml/" style="font-size: 15px;">plantuml</a> <a href="/tags/自增主键/" style="font-size: 15px;">自增主键</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/sqlserver-killer/" style="font-size: 15px;">sqlserver-killer</a> <a href="/tags/sudo-log/" style="font-size: 15px;">sudo-log</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/busy-thread/" style="font-size: 15px;">busy-thread</a> <a href="/tags/swap/" style="font-size: 15px;">swap</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/feign/" style="font-size: 15px;">feign</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/format/" style="font-size: 15px;">format</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/generic/" style="font-size: 15px;">generic</a> <a href="/tags/executor/" style="font-size: 15px;">executor</a> <a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/executeBatch/" style="font-size: 15px;">executeBatch</a> <a href="/tags/HttpURLConnection/" style="font-size: 15px;">HttpURLConnection</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/tracing/" style="font-size: 15px;">tracing</a> <a href="/tags/reference/" style="font-size: 15px;">reference</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/sudo/" style="font-size: 15px;">sudo</a> <a href="/tags/top/" style="font-size: 15px;">top</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/google-perf/" style="font-size: 15px;">google-perf</a> <a href="/tags/jdwp/" style="font-size: 15px;">jdwp</a> <a href="/tags/keepalive/" style="font-size: 15px;">keepalive</a> <a href="/tags/spring-bean/" style="font-size: 15px;">spring-bean</a> <a href="/tags/tomcat-startup/" style="font-size: 15px;">tomcat-startup</a> <a href="/tags/cache-prep-stmts/" style="font-size: 15px;">cache-prep-stmts</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/transaction/" style="font-size: 15px;">transaction</a> <a href="/tags/spring-validator/" style="font-size: 15px;">spring-validator</a> <a href="/tags/spring-aop/" style="font-size: 15px;">spring-aop</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/10/19/tomcat-startup-3/">tomcat bind/listen/acceptor过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/18/tomcat-connectionTimeout/">tomcat配置connectionTimeout</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/06/tomcat-threadpool-timeout/">tomcat的线程池为什么不回落？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/05/tomcat-when-queue-is-full/">tomcat队列满了之后会发生什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/08/07/tomcat-stringcache/">tomcat-stringcache</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/08/07/reflection/">Java的反射慢吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/08/open-tracing/">open-tracing</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/05/tomcat-startup-2/">tomcat-startup-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/27/tomcat-component-lifecycle/">tomcat-component-lifecycle</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/20/tomcat-startup/">tomcat-startup</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://iip.whu.edu.cn/" title="武汉大学智能信息处理实验室" target="_blank" rel="external nofollow noopener noreferrer">武汉大学智能信息处理实验室</a><ul></ul><a href="http://calvin1978.blogcn.com/" title="江南白衣" target="_blank" rel="external nofollow noopener noreferrer">江南白衣</a><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2022.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>