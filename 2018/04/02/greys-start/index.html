<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>greys启动分析 | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">greys启动分析</h1><a id="logo" href="/.">KL's blog</a><p class="description">世事洞明皆学问，人情练达即文章</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">greys启动分析</h1><div class="post-meta">Apr 2, 2018<span> | </span><span class="category"><a href="/categories/perf/">perf</a></span><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/04/02/greys-start/" href="/2018/04/02/greys-start/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#greys-简介"><span class="toc-number">1.</span> <span class="toc-text">greys 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#greys-sh"><span class="toc-number">2.</span> <span class="toc-text">greys.sh</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#attach-jvm分析"><span class="toc-number">3.</span> <span class="toc-text">attach jvm分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#attach到jvm过程"><span class="toc-number">3.1.</span> <span class="toc-text">attach到jvm过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#attach原理"><span class="toc-number">3.1.1.</span> <span class="toc-text">attach原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GreysLauncher"><span class="toc-number">3.1.2.</span> <span class="toc-text">GreysLauncher</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#agent启动过程"><span class="toc-number">3.2.</span> <span class="toc-text">agent启动过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#随启动参数启动"><span class="toc-number">3.2.1.</span> <span class="toc-text">随启动参数启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态attach的方式启动"><span class="toc-number">3.2.2.</span> <span class="toc-text">动态attach的方式启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AgentLauncher"><span class="toc-number">3.2.3.</span> <span class="toc-text">AgentLauncher</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#active-console分析"><span class="toc-number">4.</span> <span class="toc-text">active console分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc"><span class="toc-number">5.</span> <span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用maven生成MainFest文件"><span class="toc-number">5.1.</span> <span class="toc-text">使用maven生成MainFest文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maven-jar-plugin"><span class="toc-number">5.1.1.</span> <span class="toc-text">maven-jar-plugin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven-assembly-plugin"><span class="toc-number">5.1.2.</span> <span class="toc-text">maven-assembly-plugin</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考链接"><span class="toc-number">6.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="post-content"><h1 id="greys-简介"><a href="#greys-简介" class="headerlink" title="greys 简介"></a>greys 简介</h1><p>greys的使用参见链接： <a href="/2017/11/12/greys/" title="使用greys来排查线上问题">使用greys来排查线上问题</a></p>
<h1 id="greys-sh"><a href="#greys-sh" class="headerlink" title="greys.sh"></a>greys.sh</h1><p>一般使用greys时，启动命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u tomcat -H ./greys.sh [pid]</span><br></pre></td></tr></table></figure>
<p><code>greys.sh</code>的最后一行<code>main &quot;${@}&quot;</code>将命令行的所有参数都传给了main函数， 看main函数的实现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">"PUJC"</span> ARG</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$&#123;ARG&#125;</span> <span class="keyword">in</span></span><br><span class="line">        P) OPTION_CHECK_PERMISSION=0;;</span><br><span class="line">        U) OPTION_UPDATE_IF_NECESSARY=0;;</span><br><span class="line">        J) OPTION_ATTACH_JVM=0;;</span><br><span class="line">        C) OPTION_ACTIVE_CONSOLE=0;;</span><br><span class="line">        ?) usage;<span class="built_in">exit</span> 1;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>首先脚本使用<code>getopts</code>来获取命令行的参数， 指定解析<code>-P</code>、<code>-U</code>、<code>-J</code>、<code>-C</code>这几个参数，设置一些flag。<br>注意下case语句中的<code>？</code>， 代表无法识别的命令行参数, 这时就打印出help，然后退出程序：</p>
<blockquote>
<p>The GNU getopt command uses the GNU getopt() library function to do the parsing of the arguments and options.</p>
</blockquote>
<blockquote>
<p>If getopt() does not recognize an option character, it prints an error message to stderr, stores the character in optopt, and returns ?. The calling program may prevent the error message by setting opterr to 0.</p>
</blockquote>
<p>然后greys.sh这个脚本会检查greys的版本是否有更新， 除了检查更新就是<code>attach jvm</code>和<code>active console</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;OPTION_ATTACH_JVM&#125;</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">    attach_jvm <span class="variable">$&#123;greys_local_version&#125;</span>\</span><br><span class="line">        || exit_on_err 1 <span class="string">"attach to target jvm(<span class="variable">$&#123;TARGET_PID&#125;</span>) failed."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;OPTION_ACTIVE_CONSOLE&#125;</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">    active_console <span class="variable">$&#123;greys_local_version&#125;</span>\</span><br><span class="line">        || exit_on_err 1 <span class="string">"active console failed."</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p><code>${OPTION_ATTACH_JVM}</code>和<code>${OPTION_ACTIVE_CONSOLE}</code>的默认值都是1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># the option to control greys.sh attach target jvm</span></span><br><span class="line">OPTION_ATTACH_JVM=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># the option to control greys.sh active greys-console</span></span><br><span class="line">OPTION_ACTIVE_CONSOLE=1</span><br></pre></td></tr></table></figure>
<h1 id="attach-jvm分析"><a href="#attach-jvm分析" class="headerlink" title="attach jvm分析"></a>attach jvm分析</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">attach_jvm()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">local</span> greys_lib_dir=<span class="variable">$&#123;GREYS_LIB_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>/greys</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if [ $&#123;TARGET_IP&#125; = $&#123;DEFAULT_TARGET_IP&#125; ]; then</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="variable">$&#123;TARGET_PID&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin/java \</span><br><span class="line">            <span class="variable">$&#123;BOOT_CLASSPATH&#125;</span> <span class="variable">$&#123;JVM_OPTS&#125;</span> \</span><br><span class="line">            -jar <span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \</span><br><span class="line">                -pid <span class="variable">$&#123;TARGET_PID&#125;</span> \</span><br><span class="line">                -target <span class="variable">$&#123;TARGET_IP&#125;</span><span class="string">":"</span><span class="variable">$&#123;TARGET_PORT&#125;</span> \</span><br><span class="line">                -core <span class="string">"<span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-core.jar"</span> \</span><br><span class="line">                -agent <span class="string">"<span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-agent.jar"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>attach jvm这个函数，就是调用 greys-core这个jar包，  jar包执行时会调用指定的<code>Main-Class</code>的的main方法。<br><code>Main-Class</code>在<code>META-INF</code>中指定， 查看文件的内容:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  greys  unzip -q -c greys-core.jar  META-INF/MANIFEST.MF</span><br><span class="line">Manifest-Version: 1.0</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line">Created-By: Apache Maven</span><br><span class="line">Built-By: vlinux</span><br><span class="line">Build-Jdk: 1.8.0_91</span><br><span class="line">Main-Class: com.github.ompc.greys.core.GreysLauncher</span><br></pre></td></tr></table></figure>
<p>因此执行这个jar包后，会调用<code>GreysLauncher</code>的main方法。</p>
<h2 id="attach到jvm过程"><a href="#attach到jvm过程" class="headerlink" title="attach到jvm过程"></a>attach到jvm过程</h2><p><code>GreysLauncher</code>在main函数中做了两件事情，一是解析命令行配置， 二是attach到具体的jvm上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> GreysLauncher(args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        System.err.println(<span class="string">"start greys failed, because : "</span> + getCauseMessage(t));</span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GreysLauncher</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析配置文件</span></span><br><span class="line">    Configure configure = analyzeConfigure(args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载agent</span></span><br><span class="line">    attachAgent(configure);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件就是脚本中指定的参数，主要有如下字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String targetIp;                <span class="comment">// 目标主机IP</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> targetPort;                 <span class="comment">// 目标进程号</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> javaPid;                    <span class="comment">// 对方java进程号</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> connectTimeout = <span class="number">6000</span>;      <span class="comment">// 连接超时时间(ms)</span></span><br><span class="line"><span class="keyword">private</span> String greysCore;               <span class="comment">// greys-core.jar的位置</span></span><br><span class="line"><span class="keyword">private</span> String greysAgent;              <span class="comment">// greys-agent.jar的位置</span></span><br></pre></td></tr></table></figure>
<h3 id="attach原理"><a href="#attach原理" class="headerlink" title="attach原理"></a>attach原理</h3><img src="/2018/04/02/greys-start/attach.jpg" title="jps实现原理">
<p>我们在用<code>jstack</code>命令查看jvm的线程dump的时候，经常看到这两个进程，一个是<code>&quot;Signal Dispatcher&quot;</code>, 另外一个是<code>&quot;Attach Listener&quot;</code>;<br>这两个线程就和attach功能密切相关。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f23b80d2800 nid=0xb82e runnable [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Attach Listener&quot; #28 daemon prio=9 os_prio=0 tid=0x00007f2328001000 nid=0x3bb5 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br></pre></td></tr></table></figure>
<p><code>Signal Dispatcher</code>负责响应<code>SIGQUIT</code>, 并创建 <code>Attach Listener</code>。<code>Attach Listener</code>负责建立通信，执行相应的命令。</p>
<p>attach jvm就是根据<code>com.sun.tools.attach.VirtualMachine</code>的接口提供的方法——<code>attach</code>和<code>loadAgent</code></p>
<h3 id="GreysLauncher"><a href="#GreysLauncher" class="headerlink" title="GreysLauncher"></a>GreysLauncher</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Object vmObj = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == attachVmdObj) &#123; <span class="comment">// 使用 attach(String pid) 这种方式</span></span><br><span class="line">              vmObj = vmClass.getMethod(<span class="string">"attach"</span>, String.class).invoke(<span class="keyword">null</span>, <span class="string">""</span> + configure.getJavaPid());</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              vmObj = vmClass.getMethod(<span class="string">"attach"</span>, vmdClass).invoke(<span class="keyword">null</span>, attachVmdObj);</span><br><span class="line">          &#125;</span><br><span class="line">          vmClass.getMethod(<span class="string">"loadAgent"</span>, String.class, String.class).invoke(vmObj, configure.getGreysAgent(), configure.getGreysCore() + <span class="string">";"</span> + configure.toString());</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> != vmObj) &#123;</span><br><span class="line">              vmClass.getMethod(<span class="string">"detach"</span>, (Class&lt;?&gt;[]) <span class="keyword">null</span>).invoke(vmObj, (Object[]) <span class="keyword">null</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码， <code>greys-core.jar</code>和<code>greys-agent.jar</code>这两个jar包就被引入到了jvm</p>
<blockquote>
<p>The loadAgent method is used to load agents that are written in the Java Language and deployed in a JAR file. (See java.lang.instrument for a detailed description on how these agents are loaded and started).</p>
</blockquote>
<p><code>loadAgent</code>会将<code>greys-core.jar</code>和<code>greys-agent.jar</code>两个jar包引入进来。jar包引入后会从<code>/META-INF/MANIFEST.MF</code>中读取配置的agent类。</p>
<h2 id="agent启动过程"><a href="#agent启动过程" class="headerlink" title="agent启动过程"></a>agent启动过程</h2><p>agent有两种启动方式，一种再jvm启动的时候一起启动， 一种是动态的attach到一个运行的jvm上。</p>
<h3 id="随启动参数启动"><a href="#随启动参数启动" class="headerlink" title="随启动参数启动"></a>随启动参数启动</h3><p>以agent形式启动需要在jvm启动参数添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:btrace-agent.jar</span><br></pre></td></tr></table></figure>
<p>这种加载方式需要实现下面两个接口中的一个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JVM先尝试调用这个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果上面的方法不存在，则尝试调用这个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>同时必须在<code>MANIFEST.MF</code>中包含<code>Premain-Class</code>指定对应的类。</p>
<h3 id="动态attach的方式启动"><a href="#动态attach的方式启动" class="headerlink" title="动态attach的方式启动"></a>动态attach的方式启动</h3><p>attach形式需要实现下面的两个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 首先尝试调用这个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上面的方法不存在，会尝试调用这个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>同时在Jar包中必须指定 <code>Agent-Class</code>, 因此当此jar包被加载时，jvm会从<code>/META-INF/MANIFEST.MF</code>中读取配置的<code>Premain-Class</code>和<code>Agent-Class</code>, <code>greys-agent</code>的信息显示如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line">Created-By: Apache Maven</span><br><span class="line">Built-By: vlinux</span><br><span class="line">Build-Jdk: 1.8.0_91</span><br><span class="line">Agent-Class: com.github.ompc.greys.agent.AgentLauncher</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Premain-Class: com.github.ompc.greys.agent.AgentLauncher</span><br></pre></td></tr></table></figure>
<p>因此入口定位在<code>AgentLauncher</code>。</p>
<h3 id="AgentLauncher"><a href="#AgentLauncher" class="headerlink" title="AgentLauncher"></a>AgentLauncher</h3><p><code>AgentLauncher</code>的主要完成了一下的功能：</p>
<pre><code>- 自定义类加载器，减少对现有工程的侵蚀
- 启动一个`GaServer`监听指定的端口
</code></pre><p><code>GaServer</code>读取用户的输入的命令， 将命令交给<code>CommandHandler</code>在新的线程中进行具体的处理。</p>
<h1 id="active-console分析"><a href="#active-console分析" class="headerlink" title="active console分析"></a>active console分析</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># active console</span></span><br><span class="line"><span class="comment"># $1 : greys_local_version</span></span><br><span class="line">active_console()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> greys_lib_dir=<span class="variable">$&#123;GREYS_LIB_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>/greys</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin/java 2&gt;&amp;1 &gt;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># use default console</span></span><br><span class="line">        <span class="variable">$&#123;JAVA_HOME&#125;</span>/bin/java \</span><br><span class="line">            -cp <span class="variable">$&#123;greys_lib_dir&#125;</span>/greys-core.jar \</span><br><span class="line">            com.github.ompc.greys.core.GreysConsole \</span><br><span class="line">                <span class="variable">$&#123;TARGET_IP&#125;</span> \</span><br><span class="line">                <span class="variable">$&#123;TARGET_PORT&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">type</span> telnet 2&gt;&amp;1 &gt;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># use telnet</span></span><br><span class="line">        telnet <span class="variable">$&#123;TARGET_IP&#125;</span> <span class="variable">$&#123;TARGET_PORT&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">type</span> nc 2&gt;&amp;1 &gt;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># use netcat</span></span><br><span class="line">        nc <span class="variable">$&#123;TARGET_IP&#125;</span> <span class="variable">$&#123;TARGET_PORT&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"'telnet' or 'nc' is required."</span> 1&gt;&amp;2</span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>active console</code>主要是启动一个客户端， 它对不同的方式做了判断; 以java方式启动的会执行<code>greys-core.jar</code>的<code>GreysConsole</code><br>的main方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> GreysConsole(<span class="keyword">new</span> InetSocketAddress(args[<span class="number">0</span>], Integer.valueOf(args[<span class="number">1</span>])));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>GreysConsole</code>的构造函数中连接到上面启动的<code>GaServer</code>， 将用户输入的命令发送到server端， 然后将server端的返回显示在交互式shell上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.github.ompc.greys.core.GreysConsole#activeConsoleReader</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送命令到服务端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">activeConsoleReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread socketThread = <span class="keyword">new</span> Thread(<span class="string">"ga-console-reader-daemon"</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> StringBuilder lineBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> String line = console.readLine();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果是\结尾，则说明还有下文，需要对换行做特殊处理</span></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.endsWith(line, <span class="string">"\\"</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 去掉结尾的\</span></span><br><span class="line">                        lineBuffer.append(line.substring(<span class="number">0</span>, line.length() - <span class="number">1</span>));</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        lineBuffer.append(line);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> String lineForWrite = lineBuffer.toString();</span><br><span class="line">                    lineBuffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// replace ! to \!</span></span><br><span class="line">                    <span class="comment">// history.add(StringUtils.replace(lineForWrite, "!", "\\!"));</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// flush if need</span></span><br><span class="line">                    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">                        ((Flushable) history).flush();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    console.setPrompt(EMPTY);</span><br><span class="line">                    <span class="keyword">if</span> (isNotBlank(lineForWrite)) &#123;</span><br><span class="line">                        socketWriter.write(lineForWrite + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        socketWriter.write(<span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    socketWriter.flush();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                err(<span class="string">"read fail : %s"</span>, e.getMessage());</span><br><span class="line">                shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    socketThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    socketThread.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.github.ompc.greys.core.GreysConsole#loopForWriter</span></span><br><span class="line"><span class="comment">// 将服务端返回输出到界面</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loopForWriter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> c = socketReader.read();</span><br><span class="line">            <span class="keyword">if</span> (c == EOF) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (c == EOT) &#123;</span><br><span class="line">                hackingForReDrawPrompt();</span><br><span class="line">                console.setPrompt(DEFAULT_PROMPT);</span><br><span class="line">                console.redrawLine();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                out.write(c);</span><br><span class="line">            &#125;</span><br><span class="line">            out.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        err(<span class="string">"write fail : %s"</span>, e.getMessage());</span><br><span class="line">        shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="使用maven生成MainFest文件"><a href="#使用maven生成MainFest文件" class="headerlink" title="使用maven生成MainFest文件"></a>使用maven生成MainFest文件</h2><h3 id="maven-jar-plugin"><a href="#maven-jar-plugin" class="headerlink" title="maven-jar-plugin"></a>maven-jar-plugin</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>qtracer-agent<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>qunar.tc.qtracer.instrument.AgentMain<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="maven-assembly-plugin"><a href="#maven-assembly-plugin" class="headerlink" title="maven-assembly-plugin"></a>maven-assembly-plugin</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>**.**.InstrumentTest<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>**.**..InstrumentTest<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a href="https://unix.stackexchange.com/questions/15740/how-to-specify-option-with-gnu-getopt" rel="external nofollow noopener noreferrer" target="_blank">bash - How to specify -? option with GNU getopt - Unix &amp; Linux Stack Exchange</a></li>
<li><a href="https://linux.die.net/man/3/getopt" rel="external nofollow noopener noreferrer" target="_blank">getopt(3): Parse options - Linux man page</a></li>
<li><a href="https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html" rel="external nofollow noopener noreferrer" target="_blank">VirtualMachine (Attach API )</a></li>
<li><a href="http://www.fanyilun.me/2017/07/18/%E8%B0%88%E8%B0%88Java%20Intrumentation%E5%92%8C%E7%9B%B8%E5%85%B3%E5%BA%94%E7%94%A8/" rel="external nofollow noopener noreferrer" target="_blank">谈谈Java Intrumentation和相关应用 | Yilun Fan’s Blog</a></li>
<li><a href="http://www.bijishequ.com/detail/435931?p=29-55" rel="external nofollow noopener noreferrer" target="_blank">Grays Anatomy源码浅析–ClassLoader,Java,Method,DES,null,方法,INVOKING</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html" rel="external nofollow noopener noreferrer" target="_blank">java.lang.instrument (Java Platform SE 8 )</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html" rel="external nofollow noopener noreferrer" target="_blank">Java SE 6 新特性: Instrumentation 新功能</a></li>
<li><a href="https://docs.oracle.com/javase/7/docs/platform/jvmti/jvmti.html#writingAgents" rel="external nofollow noopener noreferrer" target="_blank">JVM(TM) Tool Interface 1.2.1</a></li>
<li><a href="https://www.gitbook.com/book/sachin-handiekar/learning-jvmti/details" rel="external nofollow noopener noreferrer" target="_blank">Learning JVMTI · GitBook</a></li>
<li><a href="http://lovestblog.cn/blog/2014/06/18/jvm-attach/" rel="external nofollow noopener noreferrer" target="_blank">JVM Attach机制实现 - 你假笨</a></li>
<li><a href="https://www.slideshare.net/hongjiang/shelljava" rel="external nofollow noopener noreferrer" target="_blank">Shell,信号量以及java进程的退出</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse63/" rel="external nofollow noopener noreferrer" target="_blank">Java SE 6 新特性: JMX 与系统管理</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2018/04/02/greys-start/" data-id="cjkqzvbfw00bdh684d2s8mmtg" class="article-share-link">分享到</a><div class="tags"><a href="/tags/greys/">greys</a></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? Buy me a coffee<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://oj3xkjbu4.bkt.clouddn.com/mm_facetoface_collect_qrcode_1483284143051.png" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="post-nav"><a href="/2018/05/02/dubbo-generic-invoke/" class="pre">dubbo泛化调用原理</a><a href="/2018/01/20/go-figure/" class="next">Let's go!(Go语言学习)</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2018/04/02/greys-start/';
var disqus_title = 'greys启动分析';
var disqus_url = 'http://qsli.github.io/2018/04/02/greys-start/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/logback/" style="font-size: 15px;">logback</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/concurrent/" style="font-size: 15px;">concurrent</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/go学习资料/" style="font-size: 15px;">go学习资料</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/jinfo/" style="font-size: 15px;">jinfo</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/swap/" style="font-size: 15px;">swap</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/format/" style="font-size: 15px;">format</a> <a href="/tags/generic/" style="font-size: 15px;">generic</a> <a href="/tags/executor/" style="font-size: 15px;">executor</a> <a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/reference/" style="font-size: 15px;">reference</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/top/" style="font-size: 15px;">top</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/google-perf/" style="font-size: 15px;">google-perf</a> <a href="/tags/jdwp/" style="font-size: 15px;">jdwp</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/12/java-encoding/">java中encoding总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/12/jdwp/">jdwp远程调试与安全</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/11/web-xml/">web.xml</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/11/hexo-ubuntu/">hexo迁移到ubuntu</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/11/column-view/">linux终端对齐问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/08/volatile/">volatile</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/08/swap/">swappiness</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/08/reference/">java中的引用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/spring-mvc-2/">Spring Mvc源码剖析(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/05/slf4j-bridge/">将其他日志框架桥接到slf4j</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://iip.whu.edu.cn/" title="武汉大学智能信息处理实验室" target="_blank" rel="external nofollow noopener noreferrer">武汉大学智能信息处理实验室</a><ul></ul><a href="http://calvin1978.blogcn.com/" title="江南白衣" target="_blank" rel="external nofollow noopener noreferrer">江南白衣</a><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2018.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync=""></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync=""></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>