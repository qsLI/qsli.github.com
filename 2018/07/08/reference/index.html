<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="python | C++ | C plus plus | java"><title>java中的引用 | KL's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body> <div id="particles-js"></div><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">java中的引用</h1><a id="logo" href="/.">KL's blog</a><p class="description">世事洞明皆学问，人情练达即文章</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/recommendation/"><i class="fa fa-leaf"> 推荐</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">java中的引用</h1><div class="post-meta">Jul 8, 2018<span> | </span><span class="category"><a href="/categories/java/">java</a></span><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2018/07/08/reference/" href="/2018/07/08/reference/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#jvm中的Reference-Handler线程"><span class="toc-number">1.</span> <span class="toc-text">jvm中的Reference Handler线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#何时启动"><span class="toc-number">1.1.</span> <span class="toc-text">何时启动?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#这个线程做了什么"><span class="toc-number">1.2.</span> <span class="toc-text">这个线程做了什么?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">2.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引用的状态"><span class="toc-number">2.1.</span> <span class="toc-text">引用的状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引用链表"><span class="toc-number">2.2.</span> <span class="toc-text">引用链表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tryHandlePending"><span class="toc-number">2.3.</span> <span class="toc-text">tryHandlePending</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReferenceQueue"><span class="toc-number">3.</span> <span class="toc-text">ReferenceQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openjdk"><span class="toc-number">4.</span> <span class="toc-text">openjdk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC日志"><span class="toc-number">5.</span> <span class="toc-text">GC日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><h2 id="jvm中的Reference-Handler线程"><a href="#jvm中的Reference-Handler线程" class="headerlink" title="jvm中的Reference Handler线程"></a>jvm中的<code>Reference Handler</code>线程</h2><p>经常看<code>jstack</code>的输出就会发现一个常见的线程 – <code>Reference Handler</code>, 堆栈如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=0 tid=0x00007f873013e000 nid=0x18d7 in Object.wait() [0x00007f873443b000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	at java.lang.Object.wait(Object.java:502)</span><br><span class="line">	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)</span><br><span class="line">	- locked &lt;0x00000000e0e1e9b8&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)</span><br><span class="line"></span><br><span class="line">&quot;VM Thread&quot; os_prio=0 tid=0x00007f8730136800 nid=0x18d6 runnable</span><br></pre></td></tr></table></figure>
<p>看线程栈, 执行到<code>Reference</code>下的<code>tryHandlePending</code>方法就成了<code>WAIT</code>状态, 带着好奇心去翻翻源码.</p>
<h3 id="何时启动"><a href="#何时启动" class="headerlink" title="何时启动?"></a>何时启动?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Reference类中的静态代码块</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> &#123;</span><br><span class="line">        ThreadGroup tg = Thread.currentThread().getThreadGroup();</span><br><span class="line">        <span class="keyword">for</span> (ThreadGroup tgn = tg;</span><br><span class="line">             tgn != <span class="keyword">null</span>;</span><br><span class="line">             tg = tgn, tgn = tg.getParent());</span><br><span class="line">        <span class="comment">// 这里创建线程, 传入线程group和线程的名称, 堆栈中的名称就来自于此</span></span><br><span class="line">        Thread handler = <span class="keyword">new</span> ReferenceHandler(tg, <span class="string">"Reference Handler"</span>);</span><br><span class="line">        <span class="comment">/* If there were a special system-only priority greater than</span></span><br><span class="line"><span class="comment">         * MAX_PRIORITY, it would be used here</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        handler.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">        handler.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        handler.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// provide access in SharedSecrets</span></span><br><span class="line">        SharedSecrets.setJavaLangRefAccess(<span class="keyword">new</span> JavaLangRefAccess() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryHandlePendingReference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> tryHandlePending(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>Reference</code>在被加载的时候就会触发<code>static</code>里的代码执行, 就会创建<code>Reference Handler</code>线程并启动.<br>至于<code>SharedSecrets</code>, 这个类类似一个Holder, 保存了一些对象的引用, 并提供了一些get/set方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedSecrets</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaUtilJarAccess javaUtilJarAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaLangAccess javaLangAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaLangRefAccess javaLangRefAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaIOAccess javaIOAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaNetAccess javaNetAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaNetHttpCookieAccess javaNetHttpCookieAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaNioAccess javaNioAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaIOFileDescriptorAccess javaIOFileDescriptorAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaSecurityProtectionDomainAccess javaSecurityProtectionDomainAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaSecurityAccess javaSecurityAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaUtilZipFileAccess javaUtilZipFileAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaAWTAccess javaAWTAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaObjectInputStreamAccess javaObjectInputStreamAccess;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SharedSecrets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter和setter方法省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="这个线程做了什么"><a href="#这个线程做了什么" class="headerlink" title="这个线程做了什么?"></a>这个线程做了什么?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.lang.ref.Reference.ReferenceHandler</span></span><br><span class="line">  <span class="comment">/* High-priority thread to enqueue pending References</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceHandler</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 采用反射的方式触发类的加载</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ensureClassInitialized</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class.forName(clazz.getName(), <span class="keyword">true</span>, clazz.getClassLoader());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) <span class="keyword">new</span> NoClassDefFoundError(e.getMessage()).initCause(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="comment">// pre-load and initialize InterruptedException and Cleaner classes</span></span><br><span class="line">            <span class="comment">// so that we don't get into trouble later in the run loop if there's</span></span><br><span class="line">            <span class="comment">// memory shortage while loading/initializing them lazily.</span></span><br><span class="line">            ensureClassInitialized(InterruptedException<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="comment">// 和DirectMemory相关的Cleaner类</span></span><br><span class="line">            ensureClassInitialized(Cleaner<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReferenceHandler(ThreadGroup g, String name) &#123;</span><br><span class="line">            <span class="keyword">super</span>(g, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 调用Reference类的方法</span></span><br><span class="line">                tryHandlePending(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个线程其实只是在死循环中调用了<code>Reference</code>的<code>tryHandlePending</code>来清理无效的<code>Reference</code>.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>Java中有四种引用, <code>StrongReference</code>, <code>SoftReference</code>, <code>WeakReference</code>, <code>PhantomReference</code>, 除了<code>StrongReference</code>其他的三种都有对应的类:</p>
<img src="/2018/07/08/reference/reference.jpg" title="Reference">
<h3 id="引用的状态"><a href="#引用的状态" class="headerlink" title="引用的状态"></a>引用的状态</h3><ul>
<li><code>Active</code>: Newly-created instances are Active.</li>
<li><code>Pending</code>: An element of the pending-Reference list, waiting to be enqueued by the Reference-handler thread.  Unregistered instances are never in this state.(没有注册ReferenceQueue的不会有这个状态)</li>
<li><code>Enqueued</code>: An element of the queue with which the instance was registered when it was created.  When an instance is removed from its ReferenceQueue, it is made Inactive. Unregistered instances are never in this state.(没有注册ReferenceQueue的不会有这个状态)</li>
<li><code>Inactive</code>: Nothing more to do.  Once an instance becomes Inactive its state will never change again.(终态)</li>
</ul>
<h3 id="引用链表"><a href="#引用链表" class="headerlink" title="引用链表"></a>引用链表</h3><p><code>Reference</code>中有五个关键的变量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T referent;         <span class="comment">/* Treated specially by GC */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">volatile</span> ReferenceQueue&lt;? <span class="keyword">super</span> T&gt; queue;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* When active:   NULL</span></span><br><span class="line"><span class="comment">    *     pending:   this</span></span><br><span class="line"><span class="comment">    *    Enqueued:   next reference in queue (or this if last)</span></span><br><span class="line"><span class="comment">    *    Inactive:   this</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">   Reference next;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* When active:   next element in a discovered reference list maintained by GC (or this if last)</span></span><br><span class="line"><span class="comment">    *     pending:   next element in the pending list (or null if last)</span></span><br><span class="line"><span class="comment">    *   otherwise:   NULL</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">transient</span> <span class="keyword">private</span> Reference&lt;T&gt; discovered;  <span class="comment">/* used by VM */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* List of References waiting to be enqueued.  The collector adds</span></span><br><span class="line"><span class="comment">    * References to this list, while the Reference-handler thread removes</span></span><br><span class="line"><span class="comment">    * them.  This list is protected by the above lock object. The</span></span><br><span class="line"><span class="comment">    * list uses the discovered field to link its elements.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Reference&lt;Object&gt; pending = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>referent</code></p>
<p>代表当前持有的引用. </p>
</li>
<li><p><code>queue</code></p>
<p>是初始化的时候传入的, 可以为null, 如果传入了<code>ReferenceQueue</code>, 会有入队列和出队列的操作</p>
</li>
<li><p><code>next</code></p>
<p>代表<code>ReferenceQueue</code>中的下一个, <code>Active</code>状态下是null,<br><code>Pending</code>和<code>Inactive</code>状态下指向自己, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   +-------+</span><br><span class="line">   |       |</span><br><span class="line">   v       |</span><br><span class="line">           |</span><br><span class="line">+-----+    |</span><br><span class="line">|     |    |</span><br><span class="line">|  1  +----+</span><br><span class="line">|     |</span><br><span class="line">+-----+</span><br></pre></td></tr></table></figure>
<p><code>Enqueued</code>状态下指向<code>queue</code>中的下一个元素</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                         +-------+</span><br><span class="line">                         |       |</span><br><span class="line">                         v       |</span><br><span class="line">                                 |</span><br><span class="line">+-----+    +-----+    +-----+    |</span><br><span class="line">|     |    |     |    |     |    |</span><br><span class="line">|  1  +--&gt; |  2  +--&gt; |  3  +----+</span><br><span class="line">|     |    |     |    |     |</span><br><span class="line">+-----+    +-----+    +-----+</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>discovered</code></p>
<p><code>Active</code>状态下指向<code>discovered reference list</code>中的下一个元素,<br><code>Pending</code>状态下指向<code>pending list</code>中的下一个元素,<br>其他状态下是null, 相关的链表是JVM维护的</p>
</li>
<li><p><code>pending</code></p>
</li>
</ul>
<p><code>pending</code>指向的是<code>pending list</code>链表的head</p>
<h3 id="tryHandlePending"><a href="#tryHandlePending" class="headerlink" title="tryHandlePending"></a>tryHandlePending</h3><p>处理引用的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Try handle pending &#123;<span class="doctag">@link</span> Reference&#125; if there is one.&lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Return &#123;<span class="doctag">@code</span> true&#125; as a hint that there might be another</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Reference&#125; pending or &#123;<span class="doctag">@code</span> false&#125; when there are no more pending</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Reference&#125;s at the moment and the program can do some other</span></span><br><span class="line"><span class="comment">     * useful work instead of looping.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waitForNotify if &#123;<span class="doctag">@code</span> true&#125; and there was no pending</span></span><br><span class="line"><span class="comment">     *                      &#123;<span class="doctag">@link</span> Reference&#125;, wait until notified from VM</span></span><br><span class="line"><span class="comment">     *                      or interrupted; if &#123;<span class="doctag">@code</span> false&#125;, return immediately</span></span><br><span class="line"><span class="comment">     *                      when there is no pending &#123;<span class="doctag">@link</span> Reference&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if there was a &#123;<span class="doctag">@link</span> Reference&#125; pending and it</span></span><br><span class="line"><span class="comment">     *         was processed, or we waited for notification and either got it</span></span><br><span class="line"><span class="comment">     *         or thread was interrupted before being notified;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> false&#125; otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">tryHandlePending</span><span class="params">(<span class="keyword">boolean</span> waitForNotify)</span> </span>&#123;</span><br><span class="line">        Reference&lt;Object&gt; r;</span><br><span class="line">        Cleaner c;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="comment">// pending list不为null, 说明有需要处理的引用</span></span><br><span class="line">                <span class="keyword">if</span> (pending != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = pending;</span><br><span class="line">                    <span class="comment">// 'instanceof' might throw OutOfMemoryError sometimes</span></span><br><span class="line">                    <span class="comment">// so do this before un-linking 'r' from the 'pending' chain...</span></span><br><span class="line">                    c = r <span class="keyword">instanceof</span> Cleaner ? (Cleaner) r : <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">// unlink 'r' from 'pending' chain</span></span><br><span class="line">                    <span class="comment">// 从pending list中删除r</span></span><br><span class="line">                    pending = r.discovered;</span><br><span class="line">                    r.discovered = <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// The waiting on the lock may cause an OutOfMemoryError</span></span><br><span class="line">                    <span class="comment">// because it may try to allocate exception objects.</span></span><br><span class="line">                    <span class="keyword">if</span> (waitForNotify) &#123;</span><br><span class="line">                        <span class="comment">// 没有需要处理的引用, 就wait, 这个应该会被JVM给notify</span></span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// retry if waited</span></span><br><span class="line">                    <span class="keyword">return</span> waitForNotify;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">            <span class="comment">// Give other threads CPU time so they hopefully drop some live references</span></span><br><span class="line">            <span class="comment">// and GC reclaims some space.</span></span><br><span class="line">            <span class="comment">// Also prevent CPU intensive spinning in case 'r instanceof Cleaner' above</span></span><br><span class="line">            <span class="comment">// persistently throws OOME for some time...</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">            <span class="comment">// retry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">            <span class="comment">// retry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fast path for cleaners</span></span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">            c.clean();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReferenceQueue&lt;? <span class="keyword">super</span> Object&gt; q = r.queue;</span><br><span class="line">        <span class="comment">// 如果关联了ReferenceQueue, 就加入到ReferenceQueue中</span></span><br><span class="line">        <span class="keyword">if</span> (q != ReferenceQueue.NULL) q.enqueue(r);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ReferenceQueue"><a href="#ReferenceQueue" class="headerlink" title="ReferenceQueue"></a>ReferenceQueue</h2><p><code>ReferenceQueue</code>用一个链表来维护队列里的<code>Reference</code></p>
<p>入队列相关的操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueue</span><span class="params">(Reference&lt;? extends T&gt; r)</span> </span>&#123; <span class="comment">/* Called only by Reference class */</span></span><br><span class="line">       <span class="keyword">synchronized</span> (lock) &#123; <span class="comment">// 和队列相关的锁</span></span><br><span class="line">           <span class="comment">// Check that since getting the lock this reference hasn't already been</span></span><br><span class="line">           <span class="comment">// enqueued (and even then removed)</span></span><br><span class="line">           <span class="comment">// 校验下r带的队列是自己, 并且已经enqueue的不会重复enqueue</span></span><br><span class="line">           ReferenceQueue&lt;?&gt; queue = r.queue;</span><br><span class="line">           <span class="keyword">if</span> ((queue == NULL) || (queue == ENQUEUED)) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">assert</span> queue == <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 修改Reference的queue为ENQUEUED, 代表已经入队了</span></span><br><span class="line">           r.queue = ENQUEUED;</span><br><span class="line">           <span class="comment">// 链表的头插发, 将当前的引用入队, 并更新head的值和队列的长度</span></span><br><span class="line">           r.next = (head == <span class="keyword">null</span>) ? r : head;</span><br><span class="line">           head = r;</span><br><span class="line">           queueLength++;</span><br><span class="line">           <span class="keyword">if</span> (r <span class="keyword">instanceof</span> FinalReference) &#123;</span><br><span class="line">               sun.misc.VM.addFinalRefCount(<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           lock.notifyAll();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>出队列相关的操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="keyword">private</span> Reference&lt;? extends T&gt; reallyPoll() &#123;       <span class="comment">/* Must hold lock */</span></span><br><span class="line">       Reference&lt;? extends T&gt; r = head;</span><br><span class="line">       <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 因为这个队列的尾节点的next总是指向自己, 这里判断如果是尾节点出队列, head置为null</span></span><br><span class="line">           head = (r.next == r) ?</span><br><span class="line">               <span class="keyword">null</span> :</span><br><span class="line">               r.next; <span class="comment">// Unchecked due to the next field having a raw type in Reference</span></span><br><span class="line">           <span class="comment">// 修改对应queue的状态, 代表已经出队列</span></span><br><span class="line">           r.queue = NULL;</span><br><span class="line">           <span class="comment">// 对于出队列的引用, 他的next也是指向自己的</span></span><br><span class="line">           r.next = r;</span><br><span class="line">           queueLength--;</span><br><span class="line">           <span class="keyword">if</span> (r <span class="keyword">instanceof</span> FinalReference) &#123;</span><br><span class="line">               sun.misc.VM.addFinalRefCount(-<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> r;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="openjdk"><a href="#openjdk" class="headerlink" title="openjdk"></a>openjdk</h2><blockquote>
<p>上面两个变量对应在VM中的调用，可以参考openjdk中的hotspot源码，在hotspot/src/share/vm/memory/referenceProcessor.cpp 的ReferenceProcessor::discover_reference 方法。(根据此方法的注释由了解到虚拟机在对Reference的处理有ReferenceBasedDiscovery和RefeferentBasedDiscovery两种策略)</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReferenceProcessor::enqueue_discovered_reflist</span><span class="params">(DiscoveredList&amp; refs_list,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    HeapWord* pending_list_addr)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Given a list of refs linked through the "discovered" field</span></span><br><span class="line">  <span class="comment">// (java.lang.ref.Reference.discovered), self-loop their "next" field</span></span><br><span class="line">  <span class="comment">// thus distinguishing them from active References, then</span></span><br><span class="line">  <span class="comment">// prepend them to the pending list.</span></span><br><span class="line">  <span class="comment">// BKWRD COMPATIBILITY <span class="doctag">NOTE:</span> For older JDKs (prior to the fix for 4956777),</span></span><br><span class="line">  <span class="comment">// the "next" field is used to chain the pending list, not the discovered</span></span><br><span class="line">  <span class="comment">// field.</span></span><br><span class="line">  ...</span><br><span class="line">                                                    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="GC日志"><a href="#GC日志" class="headerlink" title="GC日志"></a>GC日志</h2><p>在jvm的启动参数中加入下面的flag, 可以打开处理引用用掉的时间:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGCDetails -XX:+PrintReferenceGC</span><br></pre></td></tr></table></figure>
<p>测试代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Object reference = <span class="keyword">new</span> Object();</span><br><span class="line">       <span class="keyword">final</span> WeakReference&lt;Object&gt; weakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(reference);</span><br><span class="line"></span><br><span class="line">       Assert.assertEquals(reference, weakReference.get());</span><br><span class="line"></span><br><span class="line">       reference = <span class="keyword">null</span>;</span><br><span class="line">       System.gc();</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 当所引用的对象在 JVM 内不再有强引用时, GC 后 weak reference 将会被自动回收</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       Assert.assertNull(weakReference.get());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>日志输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[GC (System.gc()) [SoftReference, 0 refs, 0.0000616 secs][WeakReference, 34 refs, 0.0000273 secs][FinalReference, 654 refs, 0.0003785 secs][PhantomReference, 0 refs, 0 refs, 0.0000060 secs][JNI Weak Reference, 0.0000023 secs][PSYoungGen: 10708K-&gt;1566K(56320K)] 10708K-&gt;1574K(184832K), 0.0083391 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (System.gc()) [SoftReference, 0 refs, 0.0000153 secs][WeakReference, 1 refs, 0.0000035 secs][FinalReference, 85 refs, 0.0000111 secs][PhantomReference, 0 refs, 0 refs, 0.0000037 secs][JNI Weak Reference, 0.0000020 secs][PSYoungGen: 1566K-&gt;0K(56320K)] [ParOldGen: 8K-&gt;1438K(128512K)] 1574K-&gt;1438K(184832K), [Metaspace: 4770K-&gt;4770K(1056768K)], 0.0319906 secs] [Times: user=0.03 sys=0.00, real=0.04 secs] </span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 56320K, used 972K [0x0000000781e00000, 0x0000000785c80000, 0x00000007c0000000)</span><br><span class="line">  eden space 48640K, 2% used [0x0000000781e00000,0x0000000781ef3358,0x0000000784d80000)</span><br><span class="line">  from space 7680K, 0% used [0x0000000784d80000,0x0000000784d80000,0x0000000785500000)</span><br><span class="line">  to   space 7680K, 0% used [0x0000000785500000,0x0000000785500000,0x0000000785c80000)</span><br><span class="line"> ParOldGen       total 128512K, used 1438K [0x0000000705a00000, 0x000000070d780000, 0x0000000781e00000)</span><br><span class="line">  object space 128512K, 1% used [0x0000000705a00000,0x0000000705b679e0,0x000000070d780000)</span><br><span class="line"> Metaspace       used 4784K, capacity 5158K, committed 5248K, reserved 1056768K</span><br><span class="line">  class space    used 564K, capacity 593K, committed 640K, reserved 1048576K</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="http://hongjiang.info/java-referencequeue/#comment-4504" rel="external nofollow noopener noreferrer" target="_blank">话说ReferenceQueue | 写点什么</a></li>
<li><a href="https://cordate.github.io/2018/03/06/java/SharedSecrets%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="external nofollow noopener noreferrer" target="_blank">SharedSecrets深入理解 | 柳絮纷飞</a></li>
<li><a href="http://www.iteye.com/topic/401478" rel="external nofollow noopener noreferrer" target="_blank">理解 Java 的 GC 与 幽灵引用 - Java - ITeye论坛</a></li>
</ol>
</div><footer class="post-footer"><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者: </strong>代故</li><li class="post-copyright-link"><strong>本文链接: </strong>    <a href="/2018/07/08/reference/" target="_blank">http://qsli.github.io/2018/07/08/reference/index.html</a></li>  <li class="post-copyright-license"><strong>版权声明: </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 3.0 CN</a></li></ul></div></footer><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://qsli.github.io/2018/07/08/reference/" data-id="ckmg30dia00e6hy09gkqb0z3o" class="article-share-link">分享到</a><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>此文有用? 整杯冰阔乐!<br></div></div><div id="donate_guide" class="donate_bar center hidden"><img src="http://qsli.github.io/about/praise.jpg" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="tags"><a href="/tags/reference/">reference</a></div><div class="post-nav"><a href="/2018/07/08/swap/" class="pre">swappiness</a><a href="/2018/05/06/spring-mvc-2/" class="next">Spring Mvc源码剖析(二)</a></div><div id="disqus_thread"><script>var disqus_shortname = 'blog-huytwsybye';
var disqus_identifier = '2018/07/08/reference/';
var disqus_title = 'java中的引用';
var disqus_url = 'http://qsli.github.io/2018/07/08/reference/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huytwsybye.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://qsli.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/base/">base</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/druid/">druid</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">fe</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/feign/">feign</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/guava/">guava</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdbc/">jdbc</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mediawiki/">mediawiki</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis/">mybatis</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/logback/" style="font-size: 15px;">logback</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/剪贴板/" style="font-size: 15px;">剪贴板</a> <a href="/tags/mat/" style="font-size: 15px;">mat</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/编码/" style="font-size: 15px;">编码</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/cglib/" style="font-size: 15px;">cglib</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/自定义标签/" style="font-size: 15px;">自定义标签</a> <a href="/tags/cygwin/" style="font-size: 15px;">cygwin</a> <a href="/tags/pitfall-mysql-connector-java-8-x/" style="font-size: 15px;">pitfall mysql-connector-java 8.x</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/beanfactory/" style="font-size: 15px;">beanfactory</a> <a href="/tags/spring-cloud/" style="font-size: 15px;">spring-cloud</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/go学习资料/" style="font-size: 15px;">go学习资料</a> <a href="/tags/grafana/" style="font-size: 15px;">grafana</a> <a href="/tags/hexo-install/" style="font-size: 15px;">hexo install</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/lsof/" style="font-size: 15px;">lsof</a> <a href="/tags/tranfer-encoding/" style="font-size: 15px;">tranfer-encoding</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/jar/" style="font-size: 15px;">jar</a> <a href="/tags/访问权限/" style="font-size: 15px;">访问权限</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/Javadoc/" style="font-size: 15px;">Javadoc</a> <a href="/tags/java-connector/" style="font-size: 15px;">java-connector</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/jinfo/" style="font-size: 15px;">jinfo</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/markdown-here/" style="font-size: 15px;">markdown-here</a> <a href="/tags/mindmap/" style="font-size: 15px;">mindmap</a> <a href="/tags/plantuml/" style="font-size: 15px;">plantuml</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/netcat/" style="font-size: 15px;">netcat</a> <a href="/tags/自增主键/" style="font-size: 15px;">自增主键</a> <a href="/tags/pip/" style="font-size: 15px;">pip</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/postgresql/" style="font-size: 15px;">postgresql</a> <a href="/tags/python-util/" style="font-size: 15px;">python-util</a> <a href="/tags/re/" style="font-size: 15px;">re</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/limit/" style="font-size: 15px;">limit</a> <a href="/tags/spring-mvc/" style="font-size: 15px;">spring mvc</a> <a href="/tags/spi/" style="font-size: 15px;">spi</a> <a href="/tags/sqlserver-killer/" style="font-size: 15px;">sqlserver-killer</a> <a href="/tags/sudo-log/" style="font-size: 15px;">sudo-log</a> <a href="/tags/swap/" style="font-size: 15px;">swap</a> <a href="/tags/access-log/" style="font-size: 15px;">access-log</a> <a href="/tags/busy-thread/" style="font-size: 15px;">busy-thread</a> <a href="/tags/encoding/" style="font-size: 15px;">encoding</a> <a href="/tags/connections/" style="font-size: 15px;">connections</a> <a href="/tags/string-manager/" style="font-size: 15px;">string-manager</a> <a href="/tags/feign/" style="font-size: 15px;">feign</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/format/" style="font-size: 15px;">format</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/generic/" style="font-size: 15px;">generic</a> <a href="/tags/executor/" style="font-size: 15px;">executor</a> <a href="/tags/event-bus/" style="font-size: 15px;">event-bus</a> <a href="/tags/greys/" style="font-size: 15px;">greys</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/HttpURLConnection/" style="font-size: 15px;">HttpURLConnection</a> <a href="/tags/executeBatch/" style="font-size: 15px;">executeBatch</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/reference/" style="font-size: 15px;">reference</a> <a href="/tags/resource/" style="font-size: 15px;">resource</a> <a href="/tags/sudo/" style="font-size: 15px;">sudo</a> <a href="/tags/top/" style="font-size: 15px;">top</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/messageConverter/" style="font-size: 15px;">messageConverter</a> <a href="/tags/google-perf/" style="font-size: 15px;">google-perf</a> <a href="/tags/jdwp/" style="font-size: 15px;">jdwp</a> <a href="/tags/spring-bean/" style="font-size: 15px;">spring-bean</a> <a href="/tags/cache-prep-stmts/" style="font-size: 15px;">cache-prep-stmts</a> <a href="/tags/placeholder/" style="font-size: 15px;">placeholder</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/spring-validator/" style="font-size: 15px;">spring-validator</a> <a href="/tags/spring-aop/" style="font-size: 15px;">spring-aop</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/03/19/mybatis-detail-02/">mybatis源码解析（二）—— 代理类生成分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/18/mybatis-detail-01/">mybatis源码解析（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/10/spring-aop/">spring-aop</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/05/spring-validator/">spring-validator源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/04/druid-pitfall/">druid踩坑记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/timeout/">网络连接的各种timeout</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/upgrade-feign-pitfall/">升级feign版本遇到的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/http-transfer-encoding/">http-transfer-encoding探秘</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/28/upgrade-grafana-7-0/">升级到grafana7.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/13/jdk-httpurlconnection-pit/">JDK的HttpURLConnection强制把GET请求转成了POST</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//blog-huytwsybye.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://iip.whu.edu.cn/" title="武汉大学智能信息处理实验室" target="_blank" rel="external nofollow noopener noreferrer">武汉大学智能信息处理实验室</a><ul></ul><a href="http://calvin1978.blogcn.com/" title="江南白衣" target="_blank" rel="external nofollow noopener noreferrer">江南白衣</a><ul></ul><a href="https://chenyuzuoo.github.io/" title="Chenyu's Script" target="_blank" rel="external nofollow noopener noreferrer">Chenyu's Script</a><ul></ul><a href="https://zhangpengdeshu.github.io/" title="前端小胖儿" target="_blank" rel="external nofollow noopener noreferrer">前端小胖儿</a><ul></ul><a href="http://huzongzhe.cn/" title="胡大腿" target="_blank" rel="external nofollow noopener noreferrer">胡大腿</a></div><div class="widget"><div class="widget-title"><i class="fa fa-eye"> 本站访问量</i></div><div><script type="text/javascript" src="/js/busuanzi.pure.mini.js?v=0.0.0" async="async"></script><p> 访问量:<span id="busuanzi_value_site_pv"> </span></p><p> 访客数:<span id="busuanzi_value_site_uv"></span></p></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><p><a href="/." rel="nofollow">KL's blog </a><span>© 2015 - 2021.</span></p><p> Powered by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="external nofollow noopener noreferrer" target="_blank" href="https://github.com/pagecho"> Cho.</a></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/kity.min.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/kityminder.core.js?v=0.0.0" sync></script><script type="text/javascript" src="/js/mindmap.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b86170f998d4ba7d7e834894b1f02595";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>